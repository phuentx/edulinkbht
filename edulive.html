<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLive - Realtime Learning</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f1014; /* Deep dark background */
            --surface-color: #1a1b1f;
            --primary-color: #3b82f6; /* Modern Blue */
            --accent-color: #ef4444; /* Red for leave/live */
            --text-color: #ffffff;
            --text-secondary: #9ca3af;
            --border-color: #2e3035;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 60px;
            background-color: var(--surface-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid var(--border-color);
            z-index: 10;
        }

        .brand {
            font-size: 1.25rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            background-color: var(--accent-color);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .room-meta {
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
            padding: 5px 12px;
            border-radius: 20px;
        }

        /* --- Main Layout --- */
        .main-container {
            display: flex;
            flex: 1;
            height: calc(100vh - 60px);
        }

        /* --- Video Grid (Left) --- */
        .stage {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            align-items: center;
            justify-content: center;
        }

        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 1200px;
        }

        .video-card {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* --- Sidebar (Right) --- */
        .sidebar {
            width: 360px;
            background-color: var(--surface-color);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            transition: 0.2s;
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .msg-user {
            font-weight: 700;
            color: var(--text-secondary);
            margin-right: 5px;
        }
        
        .msg-user.host { color: var(--primary-color); }
        .msg-text { color: var(--text-color); }

        .chat-input-wrapper {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex: 1;
            background: #25262b;
            border: 1px solid var(--border-color);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            outline: none;
        }

        /* --- Guest Request UI --- */
        .requests-panel {
            background: #25262b;
            margin: 10px;
            border-radius: 8px;
            padding: 10px;
            display: none; /* Hidden by default */
        }

        .req-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        
        .btn-danger { background: var(--accent-color); color: white; }
        .btn-icon { padding: 8px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #333; color: white;}
        .btn-sm { padding: 5px 12px; font-size: 0.8rem; }

        .controls-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(26, 27, 31, 0.9);
            padding: 10px 20px;
            border-radius: 50px;
            border: 1px solid var(--border-color);
            z-index: 20;
        }

        /* --- Landing Screen --- */
        #join-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .card {
            background: var(--surface-color);
            padding: 40px;
            border-radius: 16px;
            width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .input-group { margin: 20px 0; display: flex; flex-direction: column; gap: 15px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="join-overlay">
        <div class="card">
            <h1 style="margin:0; color:var(--primary-color);">EduLive</h1>
            <p style="color:var(--text-secondary);">Interactive Real-time Classroom</p>
            
            <div class="input-group">
                <input type="text" id="username" placeholder="Enter your name (e.g., Alex)" />
                <input type="text" id="room-id" placeholder="Room ID (Leave empty to create)" />
            </div>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="btn btn-primary" onclick="initApp('create')">Create Room</button>
                <button class="btn" style="background:#333; color:white;" onclick="initApp('join')">Join Room</button>
            </div>
        </div>
    </div>

    <header>
        <div class="brand">
            EduLive <span class="live-badge">LIVE</span>
        </div>
        <div class="room-meta">
            ID: <span id="display-room" style="color:white; font-weight:bold;">...</span>
        </div>
        <div>
            <button class="btn btn-danger btn-sm" onclick="location.reload()">Leave</button>
        </div>
    </header>

    <div class="main-container">
        <div class="stage">
            <div class="grid-layout" id="video-grid">
                </div>
        </div>

        <div class="sidebar">
            <div class="tabs">
                <div class="tab active">Chat</div>
                <div class="tab">People</div>
            </div>

            <div id="host-requests" class="requests-panel">
                <small style="color:#aaa; text-transform:uppercase; font-size:0.7rem;">Join Requests</small>
                <div id="requests-list"></div>
            </div>

            <div class="chat-container" id="chat-box">
                <div class="message"><span style="color:#666;">System: Welcome to the room!</span></div>
            </div>

            <div class="chat-input-wrapper">
                <input type="text" id="msg-input" placeholder="Say something..." onkeypress="handleChat(event)">
                <button class="btn btn-primary btn-sm" onclick="sendMsg()">Send</button>
            </div>
        </div>
    </div>

    <div class="controls-bar" id="controls">
        <button id="btn-hand" class="btn btn-primary" onclick="raiseHand()">âœ‹ Request to Join</button>
        
        <button id="btn-mic" class="btn-icon hidden" onclick="toggleMic()">ðŸŽ¤</button>
        <button id="btn-cam" class="btn-icon hidden" onclick="toggleCam()">ðŸ“·</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Global State ---
        let roomId = null;
        let username = null;
        let isHost = false;
        let localStream = null;
        let peerConnections = {}; // Map: userId -> RTCPeerConnection
        
        // STUN Servers (Google Public)
        const iceConfig = {
            iceServers: [ { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] } ]
        };

        // --- Initialization ---
        window.initApp = async (mode) => {
            username = document.getElementById('username').value || (mode === 'create' ? 'Host' : 'Viewer');
            const roomInput = document.getElementById('room-id').value;

            if (mode === 'create') {
                roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
                isHost = true;
                // Create Room in DB
                await setDoc(doc(db, "rooms", roomId), {
                    host: username,
                    createdAt: new Date()
                });
                setupHostUI();
            } else {
                if (!roomInput) return alert("Please enter a Room ID");
                roomId = roomInput.toUpperCase();
                
                // Check if room exists
                const roomSnap = await getDoc(doc(db, "rooms", roomId));
                if (!roomSnap.exists()) return alert("Room not found!");
                
                isHost = false;
            }

            // Hide Join Screen
            document.getElementById('join-overlay').classList.add('hidden');
            document.getElementById('display-room').innerText = roomId;

            // Start Logic
            if (isHost) {
                await startLocalStream();
                listenForSignals(); // Host listens for viewers connecting
                listenForRequests(); // Host listens for "Hand Raises"
            } else {
                // Viewer just joins signaling initially (no stream yet)
                joinSignaling();
                listenForGuestApproval(); // Listen if Host accepts me
            }
            
            listenChat();
        };

        // --- Media Handling ---
        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideoTile(localStream, username, true); // true = muted locally
                
                // Show controls
                document.getElementById('btn-mic').classList.remove('hidden');
                document.getElementById('btn-cam').classList.remove('hidden');
                document.getElementById('btn-hand').classList.add('hidden'); // Speakers don't need hand raise
            } catch (e) {
                console.error("Media Error:", e);
                alert("Could not access Camera/Mic");
            }
        }

        function addVideoTile(stream, name, isLocal = false) {
            const grid = document.getElementById('video-grid');
            const div = document.createElement('div');
            div.className = 'video-card';
            div.innerHTML = `
                <video autoplay playsinline ${isLocal ? 'muted' : ''}></video>
                <div class="user-label">${name} ${isLocal ? '(You)' : ''}</div>
            `;
            div.querySelector('video').srcObject = stream;
            grid.appendChild(div);
        }

        window.toggleMic = () => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btn-mic').style.background = track.enabled ? '#333' : '#ef4444';
        };

        window.toggleCam = () => {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btn-cam').style.background = track.enabled ? '#333' : '#ef4444';
        };

        // --- WebRTC & Signaling Logic ---
        
        // 1. Host Listens for Participants
        function listenForSignals() {
            // Listen for Offers (Guests/Viewers initiating)
            onSnapshot(collection(db, `rooms/${roomId}/offers`), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        await handleOffer(data, change.doc.id);
                    }
                });
            });

            // Listen for ICE Candidates
            onSnapshot(collection(db, `rooms/${roomId}/candidates`), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        if (data.recipient === username) {
                            const pc = peerConnections[data.sender];
                            if(pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    }
                });
            });
        }

        // 2. Viewer Joins Signaling
        async function joinSignaling() {
            // Viewer creates an Offer to the Host immediately to receive Host's stream?
            // Simplified: Viewer creates "Participant" entry. Host initiates?
            // Let's do: Viewer sends Offer to Host.
            // But Viewer has no stream yet. That's fine. Offer can be "recvonly".
            
            const pc = createPeerConnection('Host'); // Connect to Host
            
            // Allow receiving
            pc.addTransceiver('video', { direction: 'recvonly' });
            pc.addTransceiver('audio', { direction: 'recvonly' });

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Send Offer to Host
            await addDoc(collection(db, `rooms/${roomId}/offers`), {
                offer: { type: offer.type, sdp: offer.sdp },
                sender: username,
                recipient: 'Host'
            });

            // Listen for Answer
            onSnapshot(collection(db, `rooms/${roomId}/answers`), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const data = change.doc.data();
                        if(data.recipient === username) {
                             await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                        }
                    }
                });
            });

            // Listen for ICE
            onSnapshot(collection(db, `rooms/${roomId}/candidates`), snapshot => {
                snapshot.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const data = change.doc.data();
                        if(data.recipient === username) {
                            pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                        }
                    }
                });
            });
        }

        // Shared: Create PC
        function createPeerConnection(remoteUser) {
            const pc = new RTCPeerConnection(iceConfig);
            peerConnections[remoteUser] = pc;

            pc.onicecandidate = event => {
                if (event.candidate) {
                    addDoc(collection(db, `rooms/${roomId}/candidates`), {
                        candidate: event.candidate.toJSON(),
                        sender: username,
                        recipient: remoteUser
                    });
                }
            };

            pc.ontrack = event => {
                // Received a stream
                const stream = event.streams[0];
                // Check if video exists, if not add
                // Using simple ID check might fail with multiple streams, but ok for demo
                addVideoTile(stream, remoteUser); 
            };
            
            // If I have a stream (am Host or Guest), add tracks
            if(localStream) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            return pc;
        }

        async function handleOffer(data, docId) {
            if(data.recipient !== username) return; // Not for me

            const pc = createPeerConnection(data.sender);
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            await addDoc(collection(db, `rooms/${roomId}/answers`), {
                answer: { type: answer.type, sdp: answer.sdp },
                sender: username,
                recipient: data.sender
            });
        }

        // --- Guest Request Logic (TikTok Style) ---
        
        window.raiseHand = async () => {
            await addDoc(collection(db, `rooms/${roomId}/requests`), {
                username: username,
                status: 'pending'
            });
            document.getElementById('btn-hand').innerText = "â³ Request Sent...";
            document.getElementById('btn-hand').disabled = true;
        };

        function listenForRequests() {
            const panel = document.getElementById('host-requests');
            const list = document.getElementById('requests-list');
            
            onSnapshot(collection(db, `rooms/${roomId}/requests`), snapshot => {
                list.innerHTML = '';
                let hasPending = false;
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if(data.status === 'pending') {
                        hasPending = true;
                        const div = document.createElement('div');
                        div.className = 'req-item';
                        div.innerHTML = `
                            <span>${data.username}</span>
                            <button class="btn btn-primary btn-sm">Accept</button>
                        `;
                        // Accept logic
                        div.querySelector('button').onclick = async () => {
                            await updateDoc(doc(db, `rooms/${roomId}/requests`, docSnap.id), { status: 'accepted' });
                            div.remove();
                        };
                        list.appendChild(div);
                    }
                });
                
                panel.style.display = hasPending ? 'block' : 'none';
            });
        }

        function listenForGuestApproval() {
            onSnapshot(collection(db, `rooms/${roomId}/requests`), snapshot => {
                snapshot.forEach(async docSnap => {
                    const data = docSnap.data();
                    if(data.username === username && data.status === 'accepted') {
                        // I became a Guest!
                        document.getElementById('btn-hand').classList.add('hidden');
                        alert("Host accepted your request! You are now live.");
                        
                        await startLocalStream();
                        
                        // Re-negotiate to send video
                        // Close old PC and reconnect? Or addTrack.
                        // Simple way: Reload connection with video enabled.
                        // Creating new offer with video tracks to Host.
                        const pc = peerConnections['Host'];
                        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                        
                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        
                        await addDoc(collection(db, `rooms/${roomId}/offers`), {
                            offer: { type: offer.type, sdp: offer.sdp },
                            sender: username,
                            recipient: 'Host'
                        });
                    }
                });
            });
        }

        // --- Chat ---
        window.handleChat = (e) => { if(e.key === 'Enter') sendMsg(); };

        window.sendMsg = async () => {
            const input = document.getElementById('msg-input');
            const txt = input.value;
            if(!txt) return;
            
            await addDoc(collection(db, `rooms/${roomId}/messages`), {
                text: txt,
                user: username,
                isHost: isHost,
                time: Date.now()
            });
            input.value = '';
        };

        function listenChat() {
            const box = document.getElementById('chat-box');
            // Basic listener, ordering by time implicitly via add order for demo
            onSnapshot(collection(db, `rooms/${roomId}/messages`), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const data = change.doc.data();
                        const div = document.createElement('div');
                        div.className = 'message';
                        div.innerHTML = `<span class="msg-user ${data.isHost ? 'host' : ''}">${data.user}:</span> <span class="msg-text">${data.text}</span>`;
                        box.appendChild(div);
                        box.scrollTop = box.scrollHeight;
                    }
                });
            });
        }
    </script>
</body>
</html>
