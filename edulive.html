<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Meet - Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-color: #202124;
            --surface-color: #3c4043;
            --primary-blue: #8ab4f8;
            --danger-red: #ea4335;
            --text-primary: #e8eaed;
            --hand-yellow: #fdd835;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(32, 33, 36, 0.95);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            height: 60px;
        }

        .logo {
            font-size: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-display {
            font-family: 'Roboto', sans-serif;
            color: #bdc1c6;
            font-size: 16px;
        }

        /* --- Lobby --- */
        .lobby-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-top: 60px;
        }

        .lobby-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .meet-input {
            background: transparent;
            border: 1px solid #5f6368;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            outline: none;
        }
        .meet-input:focus { border-color: var(--primary-blue); border-width: 2px; padding: 11px; }

        .btn {
            border: none;
            padding: 12px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: var(--primary-blue); color: #202124; }
        .btn-primary:disabled { background: #3c4043; color: #777; cursor: not-allowed; }
        .btn-secondary { background: transparent; color: var(--primary-blue); border: 1px solid #5f6368; margin-top: 10px;}

        /* --- Meeting Screen --- */
        .meeting-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100dvh;
            padding-top: 60px;
            padding-bottom: 90px;
            background: #202124;
            position: relative;
        }

        .video-grid {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            flex-wrap: wrap;
            overflow-y: auto;
            align-content: center;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1;
            min-width: 300px; /* Adjusted for multi-user */
            max-width: 600px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        /* Responsive handling for 3+ users */
        @media (max-width: 600px) {
            .video-wrapper { min-width: 100%; min-height: 200px; }
        }

        video { width: 100%; height: 100%; object-fit: cover; }
        .mirrored { transform: scaleX(-1); }

        .user-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0,0,0,0.6);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 10;
        }

        /* Hand Raise Badge */
        .hand-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--surface-color);
            color: var(--hand-yellow);
            padding: 8px;
            border-radius: 50%;
            display: none; /* Hidden by default */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .hand-badge.active { display: flex; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        /* Room Info Badge */
        .room-info {
            position: absolute;
            bottom: 95px; /* Above footer */
            left: 20px;
            background: rgba(32, 33, 36, 0.8);
            padding: 8px 12px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            z-index: 90;
        }

        /* --- Footer --- */
        .controls-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: #202124;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding-bottom: env(safe-area-inset-bottom); 
            z-index: 200;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: #3c4043;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        
        .control-btn.off { background: var(--danger-red); }
        .control-btn.active-state { background: #8ab4f8; color: #202124; } /* For hand raise */
        
        .control-btn.hangup { 
            background: var(--danger-red); 
            width: 60px; 
            border-radius: 30px; 
        }

        /* Status Toast */
        .status-toast {
            position: fixed;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 500;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <i data-lucide="video" style="color:#00796b;"></i>
            <span>Edulinki</span>
        </div>
        <div class="time-display" id="clock">10:00</div>
    </header>

    <main class="lobby-container" id="lobbyScreen">
        <div class="lobby-card">
            <h2 style="font-weight: 400;">Join Meeting</h2>
            <input type="text" id="callInput" class="meet-input" placeholder="Enter room code" autocomplete="off">
            
            <button id="joinBtn" class="btn btn-primary" disabled>
                <i data-lucide="log-in" size="18"></i> Join
            </button>
            <div style="color: #5f6368; font-size: 14px;">or</div>
            <button id="createBtn" class="btn btn-secondary">
                <i data-lucide="plus" size="18"></i> Create New
            </button>
        </div>
    </main>

    <main class="meeting-container" id="meetingScreen">
        <div class="video-grid" id="videoGrid">
            <div class="video-wrapper" id="localWrapper">
                <video id="localVideo" autoplay playsinline muted class="mirrored"></video>
                <div class="user-label">You</div>
                <div class="hand-badge" id="localHand"><i data-lucide="hand" size="20"></i></div>
            </div>
            </div>

        <div class="room-info" id="roomInfo" onclick="copyRoomId()">
            <span id="roomNameDisplay">...</span>
            <i data-lucide="copy" size="14"></i>
        </div>

        <div class="status-toast" id="statusToast">Status...</div>
    </main>

    <footer class="controls-bar" id="controlsBar">
        <button id="micBtn" class="control-btn"><i data-lucide="mic"></i></button>
        <button id="camBtn" class="control-btn"><i data-lucide="camera"></i></button>
        
        <button id="handBtn" class="control-btn"><i data-lucide="hand"></i></button>
        
        <button id="screenBtn" class="control-btn"><i data-lucide="monitor-up"></i></button>
        
        <button id="hangupBtn" class="control-btn hangup"><i data-lucide="phone-off"></i></button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // Initialize Icons
        lucide.createIcons();

        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        // --- Globals ---
        const iceServers = {
            iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }]
        };

        let localStream = null;
        let screenStream = null;
        let roomId = null;
        let localId = Math.random().toString(36).substring(2, 9); // My unique ID
        const peerConnections = {}; // Store { remoteId: RTCPeerConnection }
        let isHandRaised = false;

        // --- UI Elements ---
        const videoGrid = document.getElementById('videoGrid');
        const localVideo = document.getElementById('localVideo');
        const micBtn = document.getElementById('micBtn');
        const camBtn = document.getElementById('camBtn');
        const handBtn = document.getElementById('handBtn');
        const screenBtn = document.getElementById('screenBtn');
        const roomNameDisplay = document.getElementById('roomNameDisplay');

        // --- Helper: UI Toast ---
        window.showStatus = (msg) => {
            const toast = document.getElementById('statusToast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        };

        // --- Helper: Copy Room ID ---
        window.copyRoomId = () => {
            navigator.clipboard.writeText(roomId);
            showStatus("Room ID copied!");
        };

        // --- 1. JOIN/CREATE FLOW ---
        async function startApp(isCreator) {
            const input = document.getElementById('callInput').value.trim();
            if(!isCreator && !input) return;

            roomId = isCreator ? Math.random().toString(36).substring(2, 7) : input;
            
            document.getElementById('lobbyScreen').style.display = 'none';
            document.getElementById('meetingScreen').style.display = 'flex';
            document.getElementById('controlsBar').style.display = 'flex';
            roomNameDisplay.innerText = roomId;

            await startMedia();
            await joinRoom();
        }

        async function startMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch(e) { 
                console.error(e);
                alert("Camera access needed!"); 
            }
        }

        // --- 2. MULTI-USER LOGIC (MESH) ---
        async function joinRoom() {
            showStatus(`Joined: ${roomId}`);

            // 1. Add myself to participants
            const myDoc = doc(collection(firestore, `rooms/${roomId}/participants`), localId);
            await setDoc(myDoc, { handRaised: false, timestamp: Date.now() });

            // 2. Listen for Hand Raises (State Changes)
            onSnapshot(collection(firestore, `rooms/${roomId}/participants`), (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const data = change.doc.data();
                    const userId = change.doc.id;
                    if(userId === localId) return;

                    if(change.type === 'modified' || change.type === 'added') {
                        updateRemoteHand(userId, data.handRaised);
                    }
                });
            });

            // 3. Listen for Signaling Messages (Offers/Answers/ICE)
            onSnapshot(collection(firestore, `rooms/${roomId}/messages`), (snapshot) => {
                snapshot.docChanges().forEach(async change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        if (msg.to === localId) {
                            handleSignalMessage(msg, change.doc.id);
                        }
                    }
                });
            });

            // 4. Discovery: Connect to existing users
            const participantsSnap = await query(collection(firestore, `rooms/${roomId}/participants`));
            onSnapshot(collection(firestore, `rooms/${roomId}/participants`), (snapshot) => {
                 snapshot.docChanges().forEach(async change => {
                    const userId = change.doc.id;
                    if (userId === localId) return;

                    if (change.type === 'added') {
                        // If I joined *after* them (simplified: or just create connection aggressively)
                        // In Mesh, usually "Newcomer" initiates offers to "Existing".
                        // Logic: check timestamp or just offer.
                        // Better: If I detect a new user, and I have a "lower" ID? No, let's have Newcomer Offer.
                        
                        // We will just create a PC for everyone. 
                        // To avoid double-offering, only OFFER if my ID > their ID? 
                        // Actually, easiest way: The person who just joined (me) initiates to everyone already there.
                        // But here we are inside a listener. 
                        // Let's rely on the snapshot: if data.timestamp < my timestamp, they were there first. I offer.
                    }
                });
            });
            
            // Simpler Discovery: Get list of existing users once, Offer to them.
            // Future joiners will find ME and Offer to ME.
            const currentUsers = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js").then(m => m.getDocs(collection(firestore, `rooms/${roomId}/participants`)));
            
            currentUsers.forEach(async doc => {
                const targetId = doc.id;
                if(targetId === localId) return;
                // They are existing. I am new. I initiate.
                createPeerConnection(targetId, true); 
            });
        }

        // --- 3. PEER CONNECTION HANDLERS ---
        async function createPeerConnection(targetId, isInitiator) {
            if(peerConnections[targetId]) return peerConnections[targetId];

            const pc = new RTCPeerConnection(iceServers);
            peerConnections[targetId] = pc;

            // Handle ICE
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    sendSignal(targetId, { type: 'candidate', candidate: event.candidate.toJSON() });
                }
            };

            // Handle Stream
            pc.ontrack = (event) => {
                let remoteVid = document.getElementById(`vid-${targetId}`);
                if(!remoteVid) {
                    // Create Video Wrapper
                    const wrapper = document.createElement('div');
                    wrapper.className = 'video-wrapper';
                    wrapper.id = `wrap-${targetId}`;
                    
                    const video = document.createElement('video');
                    video.id = `vid-${targetId}`;
                    video.autoplay = true;
                    video.playsInline = true;
                    
                    const label = document.createElement('div');
                    label.className = 'user-label';
                    label.innerText = 'User ' + targetId.substring(0,3);

                    // Hand Icon
                    const handBadge = document.createElement('div');
                    handBadge.className = 'hand-badge';
                    handBadge.id = `hand-${targetId}`;
                    handBadge.innerHTML = '<i data-lucide="hand" size="20"></i>';

                    wrapper.appendChild(video);
                    wrapper.appendChild(label);
                    wrapper.appendChild(handBadge);
                    videoGrid.appendChild(wrapper);
                    
                    // Re-scan icons
                    lucide.createIcons();
                    remoteVid = video;
                }
                remoteVid.srcObject = event.streams[0];
            };

            // Add Tracks
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            if(isInitiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal(targetId, { type: 'offer', sdp: offer.sdp });
            }

            return pc;
        }

        async function handleSignalMessage(msg, docId) {
            // Delete processed message to keep DB clean (optional but good)
            deleteDoc(doc(firestore, `rooms/${roomId}/messages`, docId));

            const { from, type, sdp, candidate } = msg;
            let pc = peerConnections[from];

            if(!pc) {
                pc = await createPeerConnection(from, false);
            }

            if(type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription({ type, sdp }));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal(from, { type: 'answer', sdp: answer.sdp });
            } else if (type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription({ type, sdp }));
            } else if (type === 'candidate') {
                await pc.addIceCandidate(new RTCIceCandidate(candidate));
            }
        }

        async function sendSignal(toId, data) {
            await addDoc(collection(firestore, `rooms/${roomId}/messages`), {
                to: toId,
                from: localId,
                ...data,
                timestamp: Date.now()
            });
        }

        // --- 4. FEATURE: RAISE HAND ---
        handBtn.onclick = async () => {
            isHandRaised = !isHandRaised;
            
            // Toggle Visuals
            const localBadge = document.getElementById('localHand');
            isHandRaised ? localBadge.classList.add('active') : localBadge.classList.remove('active');
            isHandRaised ? handBtn.classList.add('active-state') : handBtn.classList.remove('active-state');

            // Update DB
            const myDoc = doc(collection(firestore, `rooms/${roomId}/participants`), localId);
            await updateDoc(myDoc, { handRaised: isHandRaised });
        };

        function updateRemoteHand(userId, raised) {
            const badge = document.getElementById(`hand-${userId}`);
            if(badge) {
                raised ? badge.classList.add('active') : badge.classList.remove('active');
            }
        }

        // --- 5. CONTROLS (Mic/Cam/Screen) ---
        document.getElementById('micBtn').onclick = (e) => {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            e.currentTarget.classList.toggle('off');
            e.currentTarget.innerHTML = track.enabled ? '<i data-lucide="mic"></i>' : '<i data-lucide="mic-off"></i>';
            lucide.createIcons();
        };

        document.getElementById('camBtn').onclick = (e) => {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            e.currentTarget.classList.toggle('off');
            e.currentTarget.innerHTML = track.enabled ? '<i data-lucide="camera"></i>' : '<i data-lucide="camera-off"></i>';
            lucide.createIcons();
        };

        document.getElementById('screenBtn').onclick = async () => {
             if (!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];
                    
                    // Replace tracks for ALL peers
                    Object.values(peerConnections).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(screenTrack);
                    });

                    localVideo.srcObject = screenStream;
                    localVideo.classList.remove('mirrored');
                    screenBtn.style.color = '#8ab4f8';

                    screenTrack.onended = stopScreenShare;
                } catch(e) { console.error(e); }
            } else {
                stopScreenShare();
            }
        };

        function stopScreenShare() {
            const camTrack = localStream.getVideoTracks()[0];
            Object.values(peerConnections).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(camTrack);
            });
            localVideo.srcObject = localStream;
            localVideo.classList.add('mirrored');
            if(screenStream) screenStream.getTracks().forEach(t=>t.stop());
            screenStream = null;
            screenBtn.style.color = 'white';
        }

        document.getElementById('hangupBtn').onclick = () => window.location.reload();

        // --- INPUT LISTENERS ---
        document.getElementById('joinBtn').onclick = () => startApp(false);
        document.getElementById('createBtn').onclick = () => startApp(true);
        document.getElementById('callInput').oninput = (e) => {
            document.getElementById('joinBtn').disabled = !e.target.value.trim();
        };

    </script>
</body>
</html>
