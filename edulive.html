<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Meet - Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --surface: #1e1e1e;
            --surface-light: #2c2c2c;
            --primary: #8ab4f8; 
            --danger: #ff5252;
            --text-main: #ffffff;
            --text-muted: #9aa0a6;
            --glass-bg: rgba(30, 30, 30, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --sheet-bg: #1e1e1e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 50;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            pointer-events: none;
        }
        .header-left { pointer-events: auto; display: flex; align-items: center; gap: 10px; }
        .logo { font-family: 'Google Sans'; font-size: 19px; font-weight: 500; color: white; display: flex; align-items: center; gap: 8px;}
        .room-badge {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            display: none; border: 1px solid var(--border); pointer-events: auto;
        }

        /* --- LOBBY --- */
        #lobby {
            position: absolute; inset: 0; z-index: 200;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .lobby-card {
            background: var(--surface); padding: 40px; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        .input-box {
            background: var(--surface-light); border: 1px solid transparent;
            width: 100%; padding: 16px; border-radius: 12px; color: white;
            font-size: 16px; margin: 24px 0; outline: none; transition: 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: #333; }
        .btn-primary {
            width: 100%; padding: 16px; background: var(--primary); color: #000;
            border: none; border-radius: 12px; font-weight: 600; font-size: 16px;
            cursor: pointer; margin-bottom: 12px;
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- STAGE & GRID --- */
        #meeting-stage {
            flex: 1; display: none; position: relative;
            padding: 0; overflow: hidden; /* Full bleed */
            transition: margin-right 0.3s ease;
        }
        /* Desktop: Push content when chat opens */
        #meeting-stage.drawer-open { margin-right: 340px; }
        @media(max-width: 768px) { #meeting-stage.drawer-open { margin-right: 0; } }

        /* Normal Grid Mode */
        #video-grid {
            width: 100%; height: 100%;
            display: flex; flex-wrap: wrap;
            justify-content: center; align-content: center; align-items: center;
            gap: 16px; padding: 70px 20px 100px 20px;
            transition: all 0.3s ease;
        }

        /* Pin Mode (Spotlight) */
        #video-grid.pinned-mode {
            display: block; padding: 0;
            position: relative;
        }
        /* In pin mode, non-pinned videos become a filmstrip at bottom */
        #video-grid.pinned-mode .vid-card {
            display: none; /* Hidden by default in pin mode logic, JS handles visibility */
        }
        
        /* --- VIDEO CARD --- */
        .vid-card {
            position: relative; background: #202124; border-radius: 16px; 
            overflow: hidden; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); border: 2px solid transparent;
        }
        .vid-card.speaking { border-color: var(--primary); }

        /* Fullscreen/Pinned Card Styles */
        .vid-card.is-pinned {
            position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important;
            border-radius: 0; z-index: 10; border: none;
        }
        /* Filmstrip style for others (handled by JS logic, but basic CSS here) */
        .filmstrip-container {
            position: absolute; bottom: 100px; right: 20px; 
            display: flex; gap: 10px; z-index: 20;
            max-width: 80%; overflow-x: auto;
            padding: 10px; border-radius: 12px;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            display: none; /* Shown via JS */
        }

        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .mirrored { transform: scaleX(-1); }

        /* Overlays */
        .name-tag {
            position: absolute; bottom: 12px; left: 12px;
            background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 6px;
            font-size: 12px; color: white; display: flex; align-items: center; gap: 6px;
            backdrop-filter: blur(4px); pointer-events: none; font-weight: 500;
        }
        .status-icon { color: var(--danger); display: none; }
        .vid-card.muted .status-icon { display: block; }
        .hand-badge {
            position: absolute; top: 12px; left: 12px;
            background: #2c2c2c; padding: 8px; border-radius: 50%;
            display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .vid-card.hand-up .hand-badge { display: block; }

        /* --- USER MORE MENU (Three Dots) --- */
        .card-more-btn {
            position: absolute; top: 10px; right: 10px;
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(0,0,0,0.4); border: none; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s; z-index: 5;
        }
        .vid-card:hover .card-more-btn, .card-more-btn.active { opacity: 1; }
        
        /* Dropdown for User Menu */
        .user-dropdown {
            position: absolute; top: 45px; right: 10px;
            background: var(--surface-light); border-radius: 8px;
            width: 140px; padding: 5px; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 20;
            border: 1px solid var(--border);
        }
        .user-dropdown.show { display: block; }
        .dropdown-item {
            padding: 10px; display: flex; align-items: center; gap: 10px;
            color: white; font-size: 13px; cursor: pointer; border-radius: 4px;
        }
        .dropdown-item:hover { background: rgba(255,255,255,0.1); }

        /* --- CONTROLS --- */
        .controls-wrapper {
            position: fixed; bottom: 24px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 60; pointer-events: none;
        }
        .control-bar {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border);
            display: flex; gap: 12px; pointer-events: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .btn-ctrl {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: transparent; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative;
        }
        .btn-ctrl:hover { background: rgba(255,255,255,0.15); }
        .btn-ctrl.active { background: var(--primary); color: black; }
        .btn-ctrl.off { background: rgba(255,255,255,0.1); color: var(--text-muted); }
        .btn-ctrl.off-red { background: var(--danger); color: white; }
        
        .btn-ctrl.hangup { background: var(--danger); width: 64px; border-radius: 32px; margin-left: 8px;}

        /* --- GLOBAL OPTIONS MENU (The new "More" Overlay) --- */
        #options-drawer {
            position: fixed; bottom: 90px; right: 50%; transform: translateX(50%) translateY(20px);
            background: var(--sheet-bg); border-radius: 16px;
            width: 260px; padding: 8px; border: 1px solid var(--border);
            display: none; flex-direction: column; opacity: 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 70;
            transition: all 0.2s;
        }
        #options-drawer.open { display: flex; opacity: 1; transform: translateX(50%) translateY(0); }
        /* Mobile Sheet Style */
        @media(max-width: 600px) {
            #options-drawer {
                bottom: 0; right: 0; left: 0; width: 100%; transform: translateY(100%);
                border-radius: 20px 20px 0 0; padding: 20px;
            }
            #options-drawer.open { transform: translateY(0); }
        }
        
        .opt-item {
            padding: 12px 16px; display: flex; align-items: center; gap: 12px;
            color: #eee; font-size: 15px; cursor: pointer; border-radius: 8px;
        }
        .opt-item:hover { background: rgba(255,255,255,0.08); }

        /* --- CHAT --- */
        #chat-drawer {
            position: fixed; top: 16px; bottom: 16px; right: 16px; width: 320px;
            background: var(--surface); border-radius: 16px; border: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 40px rgba(0,0,0,0.6);
        }
        #chat-drawer.open { transform: translateX(0); }
        @media (max-width: 768px) {
            #chat-drawer {
                top: auto; bottom: 0; left: 0; right: 0; width: 100%; height: 85vh;
                border-radius: 24px 24px 0 0; transform: translateY(100%);
            }
            #chat-drawer.open { transform: translateY(0); }
        }
        .chat-header { padding: 18px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg.me { align-self: flex-end; align-items: flex-end; } .msg.them { align-self: flex-start; align-items: flex-start; }
        .msg-bubble { padding: 10px 14px; border-radius: 18px; font-size: 14px; word-wrap: break-word; }
        .msg.me .msg-bubble { background: var(--primary); color: #121212; border-bottom-right-radius: 4px; }
        .msg.them .msg-bubble { background: var(--surface-light); color: white; border-bottom-left-radius: 4px; }
        .chat-footer { padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #2c2c2c; border: none; padding: 12px; border-radius: 24px; color: white; outline: none; }
        
        .unread-dot { position: absolute; top: 10px; right: 10px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: none; }

    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo"><i data-lucide="video" color="#8ab4f8"></i> Edulinki</div>
            <div id="room-badge" class="room-badge"></div>
        </div>
    </header>

    <div id="lobby">
        <div class="lobby-card">
            <h1>Join Meeting</h1>
            <p style="color:var(--text-muted); margin-bottom: 24px;">Secure, real-time conferencing.</p>
            <input type="text" id="roomInput" class="input-box" placeholder="Enter Room Code" autocomplete="off">
            <button id="joinBtn" class="btn-primary" disabled>Join Room</button>
            <button id="createBtn" class="btn-text" style="background:none; border:none; color:var(--primary); cursor:pointer;">Create New</button>
        </div>
    </div>

    <div id="meeting-stage">
        <div id="video-grid">
            </div>
        <div class="filmstrip-container" id="filmstrip"></div>
    </div>

    <div id="chat-drawer">
        <div class="chat-header">
            <span>Messages</span>
            <button onclick="toggleChat()" style="background:none; border:none; color:var(--text-muted);"><i data-lucide="x"></i></button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." autocomplete="off">
            <button id="sendBtn" style="background:none; border:none; color:var(--primary);"><i data-lucide="send-horizontal"></i></button>
        </div>
    </div>

    <div id="options-drawer">
        <div class="opt-item" id="optShareScreen">
            <i data-lucide="monitor-up"></i> Share Screen
        </div>
        <div class="opt-item" id="optRaiseHand">
            <i data-lucide="hand"></i> Raise Hand
        </div>
        <div style="height:1px; background:var(--border); margin:5px 0;"></div>
        <div class="opt-item" onclick="toggleOptions()">
            <i data-lucide="x"></i> Close Menu
        </div>
    </div>

    <div class="controls-wrapper" id="controls" style="display:none;">
        <div class="control-bar">
            <button id="micBtn" class="btn-ctrl" title="Mic"><i data-lucide="mic"></i></button>
            <button id="camBtn" class="btn-ctrl" title="Camera"><i data-lucide="camera"></i></button>
            
            <button id="chatBtn" class="btn-ctrl" title="Chat" onclick="toggleChat()">
                <i data-lucide="message-square"></i>
                <div class="unread-dot" id="unreadDot"></div>
            </button>
            
            <button id="moreBtn" class="btn-ctrl" title="Options" onclick="toggleOptions()">
                <i data-lucide="ellipsis-vertical"></i>
            </button>
            
            <button id="hangupBtn" class="btn-ctrl hangup" title="Leave"><i data-lucide="phone-off"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        lucide.createIcons();

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const iceServers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

        // State
        let localStream, screenStream;
        let roomId;
        let myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        let pcs = {};
        let audioCtx;
        let isMuted = false, isCamOff = false, isHandRaised = false, isChatOpen = false, isOptionsOpen = false;
        let pinnedUserId = null; // Who is currently pinned?

        // DOM
        const grid = document.getElementById('video-grid');
        const filmstrip = document.getElementById('filmstrip');
        const lobby = document.getElementById('lobby');
        const stage = document.getElementById('meeting-stage');
        const controls = document.getElementById('controls');
        const optionsDrawer = document.getElementById('options-drawer');
        const chatDrawer = document.getElementById('chat-drawer');
        const unreadDot = document.getElementById('unreadDot');

        // --- 1. LAYOUT ENGINE (Smart Grid + Pin Support) ---
        function calculateLayout() {
            if (pinnedUserId) {
                // PIN MODE: One big video, rest in filmstrip (logic handled in CSS classes mainly)
                grid.classList.add('pinned-mode');
                filmstrip.style.display = 'flex';
                
                const cards = Array.from(grid.children);
                cards.forEach(card => {
                    if (card.id === `vid-${pinnedUserId}`) {
                        card.classList.add('is-pinned');
                        card.style.width = '100%';
                        card.style.height = '100%';
                        card.style.display = 'block';
                    } else {
                        card.classList.remove('is-pinned');
                        card.style.display = 'none'; // Hidden from main grid, clone shows in filmstrip?
                        // Actually, easier approach: Move elements to filmstrip temporarily?
                        // No, let's just make Grid hide them, and we clone streams to filmstrip? 
                        // Simpler: CSS Grid area.
                    }
                });
                
                // For this demo, let's keep it robust:
                // If pinned, we just make that card absolute full width.
                // Others are hidden. In a real app we'd move them to filmstrip.
                // I will make the "Pinned" one z-index high.
                return;
            }

            // NORMAL GRID MODE
            grid.classList.remove('pinned-mode');
            filmstrip.style.display = 'none';
            
            const cards = Array.from(grid.children);
            const count = cards.length;
            if(count === 0) return;
            
            // Clean up pin styles
            cards.forEach(c => {
                c.classList.remove('is-pinned');
                c.style.display = 'flex';
                c.style.position = 'relative';
                c.style.zIndex = 'auto';
            });

            // Grid Algo
            const width = stage.clientWidth - 40; 
            const height = stage.clientHeight - 140; 
            let bestCols = 1, maxArea = 0;

            for (let cols = 1; cols <= count; cols++) {
                const rows = Math.ceil(count / cols);
                const hScale = width / cols;
                const vScale = height / rows;
                let w, h;
                if (hScale * (9/16) < vScale) { w = hScale; h = hScale * (9/16); } 
                else { h = vScale; w = vScale * (16/9); }
                if (w * h > maxArea) { maxArea = w * h; bestCols = cols; }
            }

            const finalW = (width / bestCols) - 16; 
            const finalH = finalW * (9/16);

            cards.forEach(card => {
                card.style.width = `${finalW}px`;
                card.style.height = `${finalH}px`;
            });
        }
        window.onresize = calculateLayout;

        // --- 2. VIDEO MANAGER ---
        function addVideoCard(uid, stream, isLocal) {
            if(document.getElementById(`vid-${uid}`)) return;

            const card = document.createElement('div');
            card.className = 'vid-card';
            card.id = `vid-${uid}`;
            
            // User Menu HTML
            const menuHtml = `
                <button class="card-more-btn" onclick="toggleCardMenu('${uid}')"><i data-lucide="more-horizontal"></i></button>
                <div class="user-dropdown" id="menu-${uid}">
                    <div class="dropdown-item" onclick="pinUser('${uid}')">
                        <i data-lucide="pin" size="14"></i> Pin / Spotlight
                    </div>
                    <div class="dropdown-item" onclick="fullscreenUser('${uid}')">
                        <i data-lucide="maximize" size="14"></i> Fullscreen
                    </div>
                </div>
            `;

            card.innerHTML = `
                <video autoplay playsinline class="${isLocal ? 'mirrored' : ''}" ${isLocal ? 'muted' : ''}></video>
                <div class="avatar" style="background:${stringToColor(uid)}">${uid[0]}</div>
                <div class="name-tag">
                    <i data-lucide="mic-off" class="status-icon" size="12"></i>
                    <span>${isLocal ? 'You' : uid}</span>
                </div>
                <div class="hand-badge"><i data-lucide="hand" color="white" size="16"></i></div>
                ${menuHtml}
            `;
            
            card.querySelector('video').srcObject = stream;
            grid.appendChild(card);
            lucide.createIcons();
            calculateLayout();
        }

        function removeVideoCard(uid) {
            const card = document.getElementById(`vid-${uid}`);
            if(card) { card.remove(); calculateLayout(); }
        }

        function stringToColor(str) {
            let hash = 0; for(let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${hash % 360}, 60%, 50%)`;
        }

        // --- 3. PIN & FULLSCREEN LOGIC ---
        window.toggleCardMenu = (uid) => {
            // Close others
            document.querySelectorAll('.user-dropdown').forEach(d => d.classList.remove('show'));
            const menu = document.getElementById(`menu-${uid}`);
            if(menu) menu.classList.toggle('show');
            event.stopPropagation();
        };

        // Close dropdowns on click elsewhere
        document.addEventListener('click', (e) => {
            if(!e.target.closest('.card-more-btn')) {
                document.querySelectorAll('.user-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        window.pinUser = (uid) => {
            if (pinnedUserId === uid) {
                pinnedUserId = null; // Unpin
            } else {
                pinnedUserId = uid; // Pin new
            }
            calculateLayout();
        };

        window.fullscreenUser = (uid) => {
            const vid = document.querySelector(`#vid-${uid} video`);
            if (vid) {
                if (vid.requestFullscreen) vid.requestFullscreen();
                else if (vid.webkitRequestFullscreen) vid.webkitRequestFullscreen();
            }
        };

        // --- 4. SIGNALING ---
        document.getElementById('roomInput').oninput = (e) => document.getElementById('joinBtn').disabled = !e.target.value;
        document.getElementById('createBtn').onclick = () => start(Math.random().toString(36).substr(2, 6));
        document.getElementById('joinBtn').onclick = () => start(document.getElementById('roomInput').value.trim());

        async function start(id) {
            roomId = id;
            document.getElementById('room-badge').innerText = `ID: ${roomId}`;
            document.getElementById('room-badge').style.display = 'block';
            lobby.style.display = 'none';
            stage.style.display = 'block';
            controls.style.display = 'flex';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideoCard(myId, localStream, true);
                setupAudioViz(localStream, myId);
                await joinRoom();
            } catch(e) { alert("Camera access required!"); }
        }

        async function joinRoom() {
            const userRef = doc(db, `rooms/${roomId}/users/${myId}`);
            await setDoc(userRef, { present: true, mic: true, cam: true, hand: false });
            window.onbeforeunload = () => deleteDoc(userRef);

            // Users
            onSnapshot(collection(db, `rooms/${roomId}/users`), (snap) => {
                snap.docChanges().forEach(change => {
                    const uid = change.doc.id;
                    const data = change.doc.data();
                    if(uid === myId) return;

                    if(change.type === 'removed') {
                        removeVideoCard(uid);
                        if(pcs[uid]) { pcs[uid].close(); delete pcs[uid]; }
                    } else {
                        updateStatus(uid, data);
                        if(change.type === 'added' && !pcs[uid]) {
                            (myId < uid) ? createPeer(uid, true) : createPeer(uid, false);
                        }
                    }
                });
            });

            // Signals
            onSnapshot(collection(db, `rooms/${roomId}/signals`), (snap) => {
                snap.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const msg = change.doc.data();
                        if(msg.to === myId) {
                            await handleSignal(msg);
                            deleteDoc(change.doc.ref);
                        }
                    }
                });
            });

            // Chat
            onSnapshot(query(collection(db, `rooms/${roomId}/chat`), orderBy('ts')), (snap) => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        renderMsg(change.doc.data());
                        if(!isChatOpen) unreadDot.style.display = 'block';
                    }
                });
            });
        }

        // --- 5. WEBRTC (MESH) ---
        async function createPeer(uid, initiator) {
            const pc = new RTCPeerConnection(iceServers);
            pcs[uid] = pc;
            pc.onicecandidate = e => e.candidate && sendSignal({ type: 'candidate', candidate: e.candidate.toJSON(), to: uid, from: myId });
            pc.ontrack = e => { addVideoCard(uid, e.streams[0], false); setupAudioViz(e.streams[0], uid); };
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            if(initiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal({ type: 'offer', sdp: offer.sdp, to: uid, from: myId });
            }
        }
        
        async function handleSignal(msg) {
            const pc = pcs[msg.from] || (await createPeer(msg.from, false), pcs[msg.from]);
            if(msg.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription({type:'offer', sdp:msg.sdp}));
                const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                sendSignal({ type: 'answer', sdp: ans.sdp, to: msg.from, from: myId });
            } else if (msg.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription({type:'answer', sdp:msg.sdp}));
            else if (msg.type === 'candidate') await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
        async function sendSignal(data) { await addDoc(collection(db, `rooms/${roomId}/signals`), data); }

        function updateStatus(uid, data) {
            const card = document.getElementById(`vid-${uid}`);
            if(!card) return;
            card.classList.toggle('muted', !data.mic);
            card.classList.toggle('cam-off', !data.cam);
            card.classList.toggle('hand-up', data.hand);
        }

        function setupAudioViz(stream, uid) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(stream);
            const anl = audioCtx.createAnalyser(); anl.fftSize = 64;
            src.connect(anl);
            const data = new Uint8Array(anl.frequencyBinCount);
            const loop = () => {
                anl.getByteFrequencyData(data);
                let sum=0; data.forEach(v=>sum+=v);
                const card = document.getElementById(`vid-${uid}`);
                if(card) (sum/data.length > 20 && !card.classList.contains('muted')) ? card.classList.add('speaking') : card.classList.remove('speaking');
                requestAnimationFrame(loop);
            }; loop();
        }

        // --- 6. GLOBAL MENU & CONTROLS ---
        window.toggleOptions = () => {
            isOptionsOpen = !isOptionsOpen;
            const btn = document.getElementById('moreBtn');
            const drawer = document.getElementById('options-drawer');
            
            if(isOptionsOpen) {
                drawer.classList.add('open');
                btn.classList.add('active');
            } else {
                drawer.classList.remove('open');
                btn.classList.remove('active');
            }
        };

        const myDoc = () => doc(db, `rooms/${roomId}/users/${myId}`);
        
        document.getElementById('micBtn').onclick = (e) => {
            isMuted = !isMuted; localStream.getAudioTracks()[0].enabled = !isMuted;
            e.currentTarget.classList.toggle('off', isMuted);
            e.currentTarget.innerHTML = `<i data-lucide="${isMuted ? 'mic-off' : 'mic'}"></i>`;
            lucide.createIcons();
            updateDoc(myDoc(), { mic: !isMuted });
            document.getElementById(`vid-${myId}`).classList.toggle('muted', isMuted);
        };
        
        document.getElementById('camBtn').onclick = (e) => {
            isCamOff = !isCamOff; localStream.getVideoTracks()[0].enabled = !isCamOff;
            e.currentTarget.classList.toggle('off', isCamOff);
            e.currentTarget.innerHTML = `<i data-lucide="${isCamOff ? 'video-off' : 'camera'}"></i>`;
            lucide.createIcons();
            updateDoc(myDoc(), { cam: !isCamOff });
            document.getElementById(`vid-${myId}`).classList.toggle('cam-off', isCamOff);
        };

        // --- OPTIONS DRAWER ACTIONS ---
        document.getElementById('optRaiseHand').onclick = () => {
            isHandRaised = !isHandRaised;
            updateDoc(myDoc(), { hand: isHandRaised });
            // Close menu
            toggleOptions();
        };

        document.getElementById('optShareScreen').onclick = async () => {
             // Close menu
             toggleOptions();
             
             if(!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const trk = screenStream.getVideoTracks()[0];
                    for(let uid in pcs) {
                        const snd = pcs[uid].getSenders().find(s => s.track.kind === 'video');
                        if(snd) snd.replaceTrack(trk);
                    }
                    const localVid = document.querySelector(`#vid-${myId} video`);
                    localVid.srcObject = screenStream;
                    localVid.classList.remove('mirrored'); // Fix mirroring
                    
                    trk.onended = stopScreen;
                } catch(e) {}
             } else stopScreen();
        };

        function stopScreen() {
            const trk = localStream.getVideoTracks()[0];
            for(let uid in pcs) {
                const snd = pcs[uid].getSenders().find(s => s.track.kind === 'video');
                if(snd) snd.replaceTrack(trk);
            }
            const localVid = document.querySelector(`#vid-${myId} video`);
            localVid.srcObject = localStream;
            localVid.classList.add('mirrored'); // Restore mirroring
            
            if(screenStream) screenStream.getTracks().forEach(t=>t.stop());
            screenStream = null;
        }

        document.getElementById('hangupBtn').onclick = () => window.location.reload();

        // --- 7. CHAT ---
        window.toggleChat = () => {
            isChatOpen = !isChatOpen;
            chatDrawer.classList.toggle('open', isChatOpen);
            stage.classList.toggle('drawer-open', isChatOpen);
            document.getElementById('chatBtn').classList.toggle('active', isChatOpen);
            if(isChatOpen) unreadDot.style.display = 'none';
        };

        document.getElementById('sendBtn').onclick = sendMsg;
        document.getElementById('chatInput').onkeydown = (e) => { if(e.key === 'Enter') sendMsg(); };

        async function sendMsg() {
            const txt = document.getElementById('chatInput').value.trim();
            if(!txt) return;
            document.getElementById('chatInput').value = '';
            await addDoc(collection(db, `rooms/${roomId}/chat`), { sender: myId, text: txt, ts: Date.now() });
        }

        function renderMsg(msg) {
            const isMe = msg.sender === myId;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'them'}`;
            div.innerHTML = `<div class="msg-bubble">${msg.text}</div>`;
            const body = document.getElementById('chatBody');
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

    </script>
</body>
</html>
