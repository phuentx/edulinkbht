<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Live</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #FE2C55; /* TikTok Red */
            --blue: #25F4EE;    /* TikTok Blue */
            --dark: #121212;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: white;
            overflow: hidden; /* Prevent scroll */
            height: 100vh;
            width: 100vw;
        }

        /* VIDEO LAYER */
        .video-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #1a1a1a;
        }

        /* The Host (Remote) takes full screen */
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* The Guest (You) is PiP */
        .local-video-wrapper {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 100px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 2;
        }

        #localVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror self */
        }

        /* UI OVERLAY LAYER */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* Let clicks pass through to video unless on buttons */
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 20%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.8) 100%);
        }

        /* HEADER */
        .header {
            position: absolute;
            top: 20px;
            left: 15px;
            display: flex;
            align-items: center;
            pointer-events: auto;
        }

        .host-badge {
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(5px);
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #444;
            border: 1px solid var(--primary);
        }

        .host-info {
            display: flex;
            flex-direction: column;
            margin-right: 10px;
        }

        .host-name { font-weight: 700; font-size: 13px; }
        .host-stats { font-size: 10px; color: #ddd; }

        .follow-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
        }

        /* LIVE BADGE */
        .live-tag {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }

        /* CHAT AREA */
        .chat-area {
            position: absolute;
            bottom: 80px;
            left: 15px;
            width: 70%;
            height: 200px;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            mask-image: linear-gradient(to top, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 80%, transparent 100%);
        }

        .chat-msg {
            margin-bottom: 8px;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            opacity: 0;
            animation: slideIn 0.3s forwards;
        }

        .username { color: rgba(255,255,255,0.7); font-weight: 600; margin-right: 5px; }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* BOTTOM ACTIONS */
        .actions-bar {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 10px;
            pointer-events: auto;
        }

        .comment-input {
            flex-grow: 1;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-size: 14px;
            backdrop-filter: blur(5px);
        }
        .comment-input::placeholder { color: #ddd; }

        .action-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.8); }
        .like-btn { color: white; background: rgba(255,255,255,0.1); border-radius: 50%; }

        /* HEART ANIMATION */
        .floating-heart {
            position: absolute;
            bottom: 80px;
            right: 20px;
            font-size: 30px;
            pointer-events: none;
            animation: floatUp 2s ease-in-out forwards;
            z-index: 5;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-300px) scale(1.5) rotate(20deg); opacity: 0; }
        }

        /* LOBBY MODAL */
        .lobby-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        .lobby-content {
            background: #1c1c1c;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid #333;
        }

        .brand { color: var(--blue); font-weight: 800; font-size: 24px; margin-bottom: 20px; letter-spacing: -1px; }
        .brand span { color: var(--primary); }

        .lobby-input {
            width: 100%;
            background: #333;
            border: 1px solid #444;
            padding: 15px;
            color: white;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            outline: none;
        }
        .lobby-input:focus { border-color: var(--primary); }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        
        .primary-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-create { background: var(--primary); color: white; }
        .btn-join { background: var(--blue); color: black; }
        
        .status-text {
            color: #888;
            font-size: 12px;
            margin-top: 10px;
            min-height: 20px;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="video-container">
        <video id="remoteVideo" autoplay playsinline></video>
        
        <div class="local-video-wrapper">
            <video id="localVideo" autoplay playsinline muted></video>
        </div>
    </div>

    <div class="ui-layer">
        
        <div class="header">
            <div class="host-badge">
                <div class="avatar"></div>
                <div class="host-info">
                    <div class="host-name">Edulinki Host</div>
                    <div class="host-stats">84.2k likes</div>
                </div>
                <button class="follow-btn">Follow</button>
            </div>
        </div>

        <div class="live-tag">LIVE | <i class="fas fa-eye"></i> 1.2k</div>

        <div class="chat-area" id="chatArea">
            </div>

        <div class="actions-bar">
            <input type="text" class="comment-input" placeholder="Add comment...">
            <button class="action-btn"><i class="fas fa-share"></i></button>
            <button class="action-btn"><i class="fas fa-gift"></i></button>
            <button class="action-btn like-btn" id="sendLikeBtn"><i class="fas fa-heart"></i></button>
        </div>
    </div>

    <div class="lobby-modal" id="lobby">
        <div class="lobby-content">
            <div class="brand">Edulinki <span>Force</span></div>
            <p style="color: #aaa; margin-bottom: 20px;">Enter a Room Name to Start</p>
            
            <input type="text" id="callInput" class="lobby-input" placeholder="e.g. room123" value="demo1">
            
            <div class="btn-group">
                <button id="createBtn" class="primary-btn btn-create">Go Live (Host)</button>
                <button id="joinBtn" class="primary-btn btn-join">Join Stream</button>
            </div>
            
            <div class="status-text" id="statusLogs">Ready to connect...</div>
            <button id="hangupBtn" class="primary-btn" style="background: #333; margin-top:10px; width:100%" disabled>Reset / Hangup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        // --- WEBRTC CONFIG ---
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                { urls: ['stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302'] }
            ],
            iceCandidatePoolSize: 10,
        };

        let pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;

        // --- UI REFS ---
        const logDiv = document.getElementById('statusLogs');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const callInput = document.getElementById('callInput');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const lobbyModal = document.getElementById('lobby');

        // --- TIKTOK FX LOGIC ---
        // 1. Floating Hearts
        document.getElementById('sendLikeBtn').addEventListener('click', createHeart);
        
        function createHeart() {
            const heart = document.createElement('div');
            heart.classList.add('floating-heart');
            heart.innerHTML = '<i class="fas fa-heart"></i>';
            heart.style.color = `hsl(${Math.random() * 360}, 80%, 60%)`;
            heart.style.right = (20 + Math.random() * 50) + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 2000);
        }

        // 2. Fake Chat Generator
        const chatNames = ['Alex', 'Sarah', 'User882', 'EdulinkiFan', 'DevOps_Guru', 'CryptoKing'];
        const chatMsgs = ['This is ðŸ”¥', 'Cool layout!', 'How did you build this?', 'Hello from Brazil!', 'Can I join?', 'Nice vibes'];
        const chatArea = document.getElementById('chatArea');

        function addFakeComment() {
            const name = chatNames[Math.floor(Math.random() * chatNames.length)];
            const msg = chatMsgs[Math.floor(Math.random() * chatMsgs.length)];
            
            const div = document.createElement('div');
            div.className = 'chat-msg';
            div.innerHTML = `<span class="username">${name}:</span> ${msg}`;
            chatArea.appendChild(div);

            // Keep chat clean
            if(chatArea.children.length > 8) chatArea.removeChild(chatArea.firstChild);
        }

        // Start generating chat when connected
        let chatInterval;
        function startUI() {
            lobbyModal.style.opacity = '0';
            setTimeout(() => lobbyModal.classList.add('hidden'), 500);
            chatInterval = setInterval(addFakeComment, 1500);
            
            // Auto click likes occasionally
            setInterval(() => { if(Math.random() > 0.7) createHeart(); }, 800);
        }

        // --- WEBRTC LOGIC ---

        function log(msg) {
            console.log(msg);
            logDiv.innerText = msg;
        }

        async function startMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                
                remoteStream = new MediaStream();
                pc.ontrack = (event) => {
                    event.streams[0].getTracks().forEach((track) => remoteStream.addTrack(track));
                    remoteVideo.srcObject = remoteStream;
                };

                localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
                return true;
            } catch (e) {
                log("âŒ Camera Error. Allow Perms.");
                return false;
            }
        }

        // Candidate Queueing
        let candidateQueue = [];
        async function handleRemoteCandidate(candidateData) {
            if (!candidateData) return;
            const candidate = new RTCIceCandidate(candidateData);
            if (pc.remoteDescription && pc.remoteDescription.type) {
                await pc.addIceCandidate(candidate);
            } else {
                candidateQueue.push(candidate);
            }
        }
        async function processCandidateQueue() {
            for (const candidate of candidateQueue) {
                await pc.addIceCandidate(candidate);
            }
            candidateQueue = [];
        }

        // --- BUTTON ACTIONS ---

        createBtn.onclick = async () => {
            const callId = callInput.value.trim();
            if(!callId) return alert("Enter a room name");
            log("Starting Camera...");
            if(!await startMedia()) return;
            
            createBtn.disabled = true; joinBtn.disabled = true; hangupBtn.disabled = false;
            
            // DB Refs
            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(offerCandidates, event.candidate.toJSON());
            };

            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);
            
            const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
            await setDoc(callDoc, { offer });
            
            log(`ðŸ“¡ Live! Waiting for guest...`);
            startUI(); // Hide lobby

            onSnapshot(callDoc, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answerDescription);
                    processCandidateQueue();
                }
            });

            onSnapshot(answerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };

        joinBtn.onclick = async () => {
            const callId = callInput.value.trim();
            if(!callId) return alert("Enter a room name");
            log("Starting Camera...");
            if(!await startMedia()) return;

            createBtn.disabled = true; joinBtn.disabled = true; hangupBtn.disabled = false;

            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(answerCandidates, event.candidate.toJSON());
            };

            const snapshot = await getDoc(callDoc);
            const callData = snapshot.data();

            if (!callData) {
                alert("Room not found! Ask the host to create it first.");
                window.location.reload();
                return;
            }

            await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            
            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
            await updateDoc(callDoc, { answer });
            
            processCandidateQueue();
            startUI(); // Hide lobby

            onSnapshot(offerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };

        hangupBtn.onclick = () => window.location.reload();
    </script>
</body>
</html>
