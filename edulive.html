<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Meet - Ultimate</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-dark: #202124;
            --surface: #3c4043;
            --primary: #8ab4f8;
            --red: #ea4335;
            --text: #e8eaed;
            --glow: #8ab4f8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Google Sans', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Animations --- */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translateY(-20px) scale(1.2); }
            100% { transform: translateY(-100px) scale(1); opacity: 0; }
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(138, 180, 248, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(138, 180, 248, 0); }
            100% { box-shadow: 0 0 0 0 rgba(138, 180, 248, 0); }
        }

        /* --- Header --- */
        header {
            height: 60px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(32, 33, 36, 0.9);
            z-index: 100;
            position: fixed; width: 100%; top: 0;
        }
        .logo { display: flex; align-items: center; gap: 8px; font-size: 18px; font-weight: 500; }
        
        /* --- Video Grid Layouts --- */
        .main-stage {
            flex: 1;
            margin-top: 60px;
            margin-bottom: 80px;
            padding: 15px;
            display: grid;
            gap: 15px;
            width: 100%;
            height: calc(100% - 140px);
            overflow: hidden;
        }

        /* Dynamic Grid Classes */
        .grid-1 { grid-template-columns: 1fr; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1.5fr 1fr;
        }
        /* Special handling for 3: First item spans full width */
        .grid-3 > :first-child { grid-column: span 2; }
        
        .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
        .grid-many { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }

        @media(max-width: 600px) {
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; grid-template-rows: auto; overflow-y: auto; }
            .grid-3 > :first-child { grid-column: auto; }
        }

        /* Video Card */
        .vid-card {
            background: #000;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
        }
        
        /* Speaking Glow */
        .vid-card.speaking {
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px rgba(138, 180, 248, 0.3);
        }

        video { width: 100%; height: 100%; object-fit: cover; }
        .mirrored { transform: scaleX(-1); }

        /* Status Indicators on Video */
        .vid-info {
            position: absolute; bottom: 10px; left: 10px;
            display: flex; align-items: center; gap: 8px;
            z-index: 10;
        }
        .name-tag {
            background: rgba(0,0,0,0.6); color: white;
            padding: 4px 10px; border-radius: 4px; font-size: 12px;
        }
        .status-icon {
            background: #ea4335; color: white;
            padding: 4px; border-radius: 50%;
            display: none; /* Hidden unless active */
        }
        .status-icon.visible { display: flex; }

        /* Camera Off Placeholder */
        .cam-off-placeholder {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: #202124;
            display: none;
            flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 5;
        }
        .cam-off-placeholder.visible { display: flex; }
        .avatar {
            width: 80px; height: 80px; background: #5f6368;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white;
        }

        /* Floating Emojis */
        .emoji-float {
            position: absolute;
            bottom: 20px; left: 50%;
            font-size: 40px;
            animation: floatUp 2s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }
        .hand-raised-badge {
            position: absolute; top: 10px; left: 10px;
            font-size: 24px; background: rgba(0,0,0,0.5);
            padding: 5px; border-radius: 50%;
            display: none;
        }
        .hand-raised-badge.visible { display: block; }

        /* --- Footer Controls --- */
        .footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 80px; background: #202124;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 200;
        }

        .btn-ctrl {
            width: 50px; height: 50px; border-radius: 50%;
            background: #3c4043; border: none; color: white;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative;
        }
        .btn-ctrl:hover { background: #474a4f; }
        .btn-ctrl.off { background: var(--red); border: none; }
        .btn-ctrl.hangup { background: var(--red); width: 65px; border-radius: 30px; }

        /* --- Activities Overlay (More Menu) --- */
        .activities-panel {
            position: fixed; bottom: 90px; right: 20px;
            background: #303134; border-radius: 12px;
            padding: 15px;
            display: none; flex-direction: column; gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 300; width: 250px;
        }
        .activities-panel.open { display: flex; }
        
        .panel-row { display: flex; gap: 10px; justify-content: space-around; }
        .reaction-btn {
            background: transparent; border: none; font-size: 24px;
            cursor: pointer; transition: transform 0.2s;
        }
        .reaction-btn:hover { transform: scale(1.2); }
        
        .action-item {
            display: flex; align-items: center; gap: 10px;
            background: #3c4043; padding: 10px; border-radius: 8px;
            cursor: pointer; color: white; font-size: 14px;
        }
        .action-item:hover { background: #4b4d51; }

        /* Lobby */
        #lobby {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark); z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lobby-box { text-align: center; max-width: 400px; padding: 20px; }
        .input-code {
            background: transparent; border: 1px solid #5f6368;
            color: white; padding: 12px; border-radius: 4px;
            width: 100%; margin: 15px 0; font-size: 16px;
        }
        .btn-prime {
            background: var(--primary); color: #202124;
            padding: 12px 24px; border-radius: 25px;
            border: none; font-weight: 500; cursor: pointer; width: 100%;
        }

        /* Room ID Badge */
        .room-badge {
            position: fixed; bottom: 20px; left: 20px;
            color: #bdc1c6; font-size: 14px; display: flex; align-items: center; gap: 5px;
            cursor: pointer; z-index: 201;
        }
    </style>
</head>
<body>

    <div id="lobby">
        <div class="lobby-box">
            <h1>Ready to join?</h1>
            <p style="color:#bdc1c6; margin-top:10px;">Premium meetings, free for everyone.</p>
            <input type="text" id="roomInput" class="input-code" placeholder="Enter room code">
            <button id="joinBtn" class="btn-prime">Join Meeting</button>
            <button id="createBtn" style="background:transparent; color:var(--primary); margin-top:15px; border:none; cursor:pointer;">Create New Room</button>
        </div>
    </div>

    <header>
        <div class="logo">
            <i data-lucide="video" color="#8ab4f8"></i> Edulinki Meet
        </div>
        <div style="color:#bdc1c6; font-size:14px;" id="clock">12:00</div>
    </header>

    <main class="main-stage grid-1" id="gridContainer">
        <div class="vid-card" id="localCard">
            <div class="cam-off-placeholder" id="localPlaceholder">
                <div class="avatar">You</div>
                <div style="margin-top:10px; color:#bdc1c6;">Camera Off</div>
            </div>
            <video id="localVideo" autoplay playsinline muted class="mirrored"></video>
            <div class="hand-raised-badge" id="localHand">‚úã</div>
            
            <div class="vid-info">
                <div class="name-tag">You</div>
                <div class="status-icon" id="localMuteIcon"><i data-lucide="mic-off" size="12"></i></div>
            </div>
        </div>
    </main>

    <div class="room-badge" onclick="copyCode()">
        <span id="roomCodeDisplay">...</span> <i data-lucide="copy" size="14"></i>
    </div>

    <div class="activities-panel" id="activitiesPanel">
        <div style="font-size:12px; color:#bdc1c6; margin-bottom:5px;">REACTIONS</div>
        <div class="panel-row">
            <button class="reaction-btn" onclick="sendReaction('üíñ')">üíñ</button>
            <button class="reaction-btn" onclick="sendReaction('üëç')">üëç</button>
            <button class="reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
            <button class="reaction-btn" onclick="sendReaction('üéâ')">üéâ</button>
        </div>
        <div style="height:1px; background:#5f6368; margin: 5px 0;"></div>
        
        <div class="action-item" onclick="toggleHand()">
            <i data-lucide="hand" id="handIconMenu"></i> <span id="handText">Raise Hand</span>
        </div>
        <div class="action-item" onclick="toggleScreenShare()">
            <i data-lucide="monitor-up"></i> <span>Share Screen</span>
        </div>
    </div>

    <footer class="footer">
        <button class="btn-ctrl" id="micBtn"><i data-lucide="mic"></i></button>
        <button class="btn-ctrl" id="camBtn"><i data-lucide="camera"></i></button>
        
        <button class="btn-ctrl" id="moreBtn" onclick="toggleMenu()">
            <i data-lucide="layout-grid"></i> </button>
        
        <button class="btn-ctrl hangup" onclick="location.reload()">
            <i data-lucide="phone-off"></i>
        </button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        lucide.createIcons();
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 1000);

        // --- Firebase Setup ---
        const app = initializeApp({
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            projectId: "edulinki",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3"
        });
        const db = getFirestore(app);

        // --- State ---
        let localStream;
        let screenStream;
        let roomId;
        const myId = Math.random().toString(36).substr(2, 6);
        const pcs = {}; // Peer Connections
        let isMuted = false;
        let isCamOff = false;
        let isHandRaised = false;
        let audioContext, analyser, microphone; // For Audio Glow

        // --- UI Refs ---
        const grid = document.getElementById('gridContainer');
        const activitiesPanel = document.getElementById('activitiesPanel');

        // --- 1. Audio Glow Logic ---
        function setupAudioAnalysis(stream) {
            if(!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function checkVolume() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<bufferLength; i++) sum += dataArray[i];
                let average = sum / bufferLength;

                const card = document.getElementById('localCard');
                if(average > 10 && !isMuted) {
                     card.classList.add('speaking');
                } else {
                     card.classList.remove('speaking');
                }
                requestAnimationFrame(checkVolume);
            }
            checkVolume();
        }

        // --- 2. Main Logic ---
        async function init(create) {
            roomId = create ? Math.random().toString(36).substr(2, 6) : document.getElementById('roomInput').value.trim();
            if(!roomId) return alert("Enter code");
            
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('roomCodeDisplay').innerText = roomId;

            // Get Media
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            setupAudioAnalysis(localStream);

            // Join Room in DB
            const userRef = doc(db, `rooms/${roomId}/users/${myId}`);
            await setDoc(userRef, { 
                mic: true, cam: true, hand: false, 
                joined: serverTimestamp() 
            });

            // Handle Closing Tab -> Remove User
            window.addEventListener('beforeunload', () => deleteDoc(userRef));

            // Listen for other users
            onSnapshot(collection(db, `rooms/${roomId}/users`), (snap) => {
                updateGridClass(snap.size); // Resize grid
                
                snap.docChanges().forEach(async change => {
                    const uid = change.doc.id;
                    const data = change.doc.data();
                    if(uid === myId) return;

                    if(change.type === 'added') {
                        // New user joined, initiate call
                        createPC(uid, true); 
                    }
                    if(change.type === 'modified') {
                        // Update UI icons (Mute/Cam/Hand)
                        updatePeerUI(uid, data);
                    }
                    if(change.type === 'removed') {
                        // Remove video card
                        if(document.getElementById(`card-${uid}`)) {
                            document.getElementById(`card-${uid}`).remove();
                            if(pcs[uid]) pcs[uid].close();
                            delete pcs[uid];
                        }
                    }
                });
            });

            // Listen for signals
            onSnapshot(collection(db, `rooms/${roomId}/signals`), (snap) => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const msg = change.doc.data();
                        if(msg.to === myId) handleSignal(msg, change.doc.id);
                    }
                });
            });

            // Listen for Reactions
            onSnapshot(collection(db, `rooms/${roomId}/reactions`), (snap) => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        const data = change.doc.data();
                        // Show floating emoji if it's new (simple timestamp check logic omitted for brevity, just show)
                        if(Date.now() - data.ts < 2000) showFloatingEmoji(data.emoji, data.from);
                    }
                });
            });
        }

        // --- 3. WebRTC Core ---
        async function createPC(uid, initiator) {
            const pc = new RTCPeerConnection({ iceServers: [{urls:'stun:stun1.l.google.com:19302'}] });
            pcs[uid] = pc;

            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = e => {
                if(e.candidate) sendSignal({ type: 'ice', candidate: e.candidate.toJSON(), to: uid });
            };

            pc.ontrack = e => {
                // Check if card exists
                if(!document.getElementById(`card-${uid}`)) {
                    const card = document.createElement('div');
                    card.className = 'vid-card';
                    card.id = `card-${uid}`;
                    
                    card.innerHTML = `
                        <div class="cam-off-placeholder" id="ph-${uid}">
                            <div class="avatar">U</div>
                        </div>
                        <video id="vid-${uid}" autoplay playsinline></video>
                        <div class="hand-raised-badge" id="hand-${uid}">‚úã</div>
                        <div class="vid-info">
                            <div class="name-tag">User</div>
                            <div class="status-icon" id="mic-${uid}"><i data-lucide="mic-off" size="12"></i></div>
                        </div>
                    `;
                    grid.appendChild(card);
                    lucide.createIcons();
                }
                document.getElementById(`vid-${uid}`).srcObject = e.streams[0];
            };
            
            // Clean up on disconnect
            pc.onconnectionstatechange = () => {
                if(pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    document.getElementById(`card-${uid}`)?.remove();
                }
            };

            if(initiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal({ type: 'offer', sdp: offer.sdp, to: uid });
            }
        }

        async function handleSignal(msg, docId) {
            // Delete message immediately to clean DB
            deleteDoc(doc(db, `rooms/${roomId}/signals`, docId));
            
            let pc = pcs[msg.from];
            if(!pc) {
                await createPC(msg.from, false);
                pc = pcs[msg.from];
            }

            if(msg.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription({type:'offer', sdp:msg.sdp}));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                sendSignal({ type: 'answer', sdp: answer.sdp, to: msg.from });
            } else if(msg.type === 'answer') {
                await pc.setRemoteDescription(new RTCSessionDescription({type:'answer', sdp:msg.sdp}));
            } else if(msg.type === 'ice') {
                await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
            }
        }

        async function sendSignal(data) {
            data.from = myId;
            await addDoc(collection(db, `rooms/${roomId}/signals`), data);
        }

        // --- 4. UI Updates ---
        function updateGridClass(count) {
            grid.className = 'main-stage'; // Reset
            if(count <= 1) grid.classList.add('grid-1');
            else if(count === 2) grid.classList.add('grid-2');
            else if(count === 3) grid.classList.add('grid-3');
            else if(count === 4) grid.classList.add('grid-4');
            else grid.classList.add('grid-many');
        }

        function updatePeerUI(uid, data) {
            // Mic Status
            const micIcon = document.getElementById(`mic-${uid}`);
            if(micIcon) data.mic ? micIcon.classList.remove('visible') : micIcon.classList.add('visible');

            // Cam Status
            const ph = document.getElementById(`ph-${uid}`);
            if(ph) data.cam ? ph.classList.remove('visible') : ph.classList.add('visible');

            // Hand Status
            const hand = document.getElementById(`hand-${uid}`);
            if(hand) data.hand ? hand.classList.add('visible') : hand.classList.remove('visible');
        }

        // --- 5. Controls ---
        window.toggleMenu = () => {
            activitiesPanel.classList.toggle('open');
            document.getElementById('moreBtn').classList.toggle('active-state');
        };

        window.sendReaction = async (emoji) => {
            showFloatingEmoji(emoji, 'local'); // Show locally instantly
            await addDoc(collection(db, `rooms/${roomId}/reactions`), {
                emoji, from: myId, ts: Date.now()
            });
            toggleMenu(); // Close menu
        };

        function showFloatingEmoji(emoji, fromId) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.className = 'emoji-float';
            
            // If it's me, center. If remote, find their card.
            let targetCard = fromId === 'local' || fromId === myId 
                ? document.getElementById('localCard') 
                : document.getElementById(`card-${fromId}`);
                
            if(targetCard) {
                targetCard.appendChild(el);
                setTimeout(() => el.remove(), 2000);
            }
        }

        // Mute
        document.getElementById('micBtn').onclick = (e) => {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            e.currentTarget.classList.toggle('off');
            e.currentTarget.innerHTML = isMuted ? '<i data-lucide="mic-off"></i>' : '<i data-lucide="mic"></i>';
            document.getElementById('localMuteIcon').classList.toggle('visible');
            updateMyStatus();
            lucide.createIcons();
        };

        // Cam
        document.getElementById('camBtn').onclick = (e) => {
            isCamOff = !isCamOff;
            localStream.getVideoTracks()[0].enabled = !isCamOff;
            e.currentTarget.classList.toggle('off');
            e.currentTarget.innerHTML = isCamOff ? '<i data-lucide="camera-off"></i>' : '<i data-lucide="camera"></i>';
            document.getElementById('localPlaceholder').classList.toggle('visible');
            updateMyStatus();
            lucide.createIcons();
        };

        // Hand
        window.toggleHand = () => {
            isHandRaised = !isHandRaised;
            document.getElementById('localHand').classList.toggle('visible');
            document.getElementById('handText').innerText = isHandRaised ? "Lower Hand" : "Raise Hand";
            updateMyStatus();
            toggleMenu();
        };

        // Share Screen
        window.toggleScreenShare = async () => {
            if(!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
                    const track = screenStream.getVideoTracks()[0];
                    
                    // Replace tracks
                    Object.values(pcs).forEach(pc => {
                        const sender = pc.getSenders().find(s => s.track.kind === 'video');
                        if(sender) sender.replaceTrack(track);
                    });

                    document.getElementById('localVideo').srcObject = screenStream;
                    document.getElementById('localVideo').classList.remove('mirrored');
                    track.onended = stopShare;
                    toggleMenu();
                } catch(e) {}
            } else {
                stopShare();
                toggleMenu();
            }
        };

        function stopShare() {
            const track = localStream.getVideoTracks()[0];
            Object.values(pcs).forEach(pc => {
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(track);
            });
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('localVideo').classList.add('mirrored');
            screenStream.getTracks().forEach(t=>t.stop());
            screenStream = null;
        }

        async function updateMyStatus() {
            await updateDoc(doc(db, `rooms/${roomId}/users/${myId}`), {
                mic: !isMuted, cam: !isCamOff, hand: isHandRaised
            });
        }

        window.copyCode = () => {
            navigator.clipboard.writeText(roomId);
            alert("Code copied: " + roomId);
        }

        document.getElementById('joinBtn').onclick = () => init(false);
        document.getElementById('createBtn').onclick = () => init(true);

    </script>
</body>
</html>
