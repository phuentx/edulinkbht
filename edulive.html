<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLive | Realtime</title>
    <style>
        :root {
            --primary: #FE2C55; /* TikTok Red */
            --dark: #121212;
            --overlay: rgba(0, 0, 0, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--dark);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }

        /* --- UI Overlay --- */
        #app-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Video Layer --- */
        .video-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* TikTok style full screen */
            transform: scaleX(-1); /* Mirror effect for selfie feel */
        }

        /* Remote video is the main background */
        #remoteVideo {
            opacity: 0; /* Hidden until connected */
            transition: opacity 0.5s ease;
        }

        /* Local video (Picture in Picture style initially, or hidden if desired) */
        #localVideo {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            z-index: 2;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        /* --- Controls & Entry UI --- */
        #ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass through to video */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }

        /* Entry Screen (Room ID Input) */
        #entry-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            color: #fff;
            margin-bottom: 30px;
            letter-spacing: -1px;
        }
        .logo span { color: var(--primary); }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80%;
            max-width: 300px;
        }

        input {
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            background: #222;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }

        .btn-create {
            background: var(--primary);
            color: white;
        }
        .btn-join {
            background: #fff;
            color: #000;
        }

        /* --- Active Call Controls --- */
        #call-controls {
            padding: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-bottom: 40px;
            pointer-events: auto;
            opacity: 0; /* Hidden initially */
            transition: opacity 0.3s;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            cursor: pointer;
        }
        .btn-hangup { background: #ff3b30; }

        /* Status Toast */
        #status-msg {
            position: absolute;
            top: 50px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
            z-index: 5;
        }

    </style>
</head>
<body>

    <div id="app-container">
        
        <div class="video-wrapper">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted></video>
        </div>

        <div id="ui-layer">
            <div id="status-msg">Ready to connect</div>
            
            <div id="call-controls">
                <button class="control-btn" id="btn-toggle-cam">üì∑</button>
                <button class="control-btn" id="btn-toggle-mic">MIC</button>
                <button class="control-btn btn-hangup" id="btn-hangup">‚ùå</button>
            </div>
        </div>

        <div id="entry-screen">
            <div class="logo">Edu<span>Live</span></div>
            <div class="input-group">
                <input type="text" id="room-id-input" placeholder="Enter Room ID (e.g. 1234)">
                <div class="btn-row">
                    <button class="btn-create" id="btn-create">Create</button>
                    <button class="btn-join" id="btn-join">Join</button>
                </div>
            </div>
            <p style="color:#666; font-size: 0.8rem; margin-top:20px;">Use unique ID to find each other</p>
        </div>

    </div>

    <script type="module">
        // Using a stable version of Firebase (v10) to ensure compatibility if 12.7.0 is not yet available globally
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // WebRTC Config (STUN servers allow searching each other over internet)
        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302']
                }
            ],
            iceCandidatePoolSize: 10,
        };

        // Global State
        const pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;
        let roomId = null;

        // DOM Elements
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const entryScreen = document.getElementById('entry-screen');
        const roomIdInput = document.getElementById('room-id-input');
        const statusMsg = document.getElementById('status-msg');
        const callControls = document.getElementById('call-controls');

        // 1. Initialize Media (Camera/Mic)
        async function initMedia() {
            try {
                // Requesting high quality video
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720, facingMode: "user" }, // "nearby" focus (user face)
                    audio: true 
                });

                // Push tracks to WebRTC connection
                localStream.getTracks().forEach((track) => {
                    pc.addTrack(track, localStream);
                });

                // Show local video
                localVideo.srcObject = localStream;
            } catch (err) {
                console.error("Error accessing media:", err);
                statusMsg.innerText = "Error: Allow camera access!";
            }
        }

        // 2. Handle Remote Stream
        pc.ontrack = (event) => {
            event.streams[0].getTracks().forEach((track) => {
                remoteStream.addTrack(track);
            });
        };

        remoteStream = new MediaStream();
        remoteVideo.srcObject = remoteStream;

        // 3. Create Room Function
        document.getElementById('btn-create').onclick = async () => {
            roomId = roomIdInput.value.trim();
            if(!roomId) return alert("Please enter a Room ID");

            await initMedia();
            
            // Reference to Firestore
            const roomRef = doc(db, "rooms", roomId);
            const callerCandidatesCollection = collection(roomRef, 'callerCandidates');

            // Save ICE candidates to DB
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    addDoc(callerCandidatesCollection, event.candidate.toJSON());
                }
            };

            // Create Offer
            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);

            // Configure Room Data
            const roomWithOffer = {
                offer: {
                    type: offerDescription.type,
                    sdp: offerDescription.sdp,
                },
            };

            // Write to DB
            await setDoc(roomRef, roomWithOffer);
            
            // UI Update
            statusMsg.innerText = `Room ${roomId} created. Waiting for peer...`;
            entryScreen.style.display = 'none';
            callControls.style.opacity = '1';

            // Listen for Remote Answer
            onSnapshot(roomRef, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data && data.answer) {
                    const answer = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answer);
                    statusMsg.innerText = "Connected!";
                    remoteVideo.style.opacity = '1';
                }
            });

            // Listen for Remote ICE Candidates
            const calleeCandidatesCollection = collection(roomRef, 'calleeCandidates');
            onSnapshot(calleeCandidatesCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        pc.addIceCandidate(candidate);
                    }
                });
            });
        };

        // 4. Join Room Function
        document.getElementById('btn-join').onclick = async () => {
            roomId = roomIdInput.value.trim();
            if(!roomId) return alert("Please enter a Room ID");

            const roomRef = doc(db, "rooms", roomId);
            const roomSnapshot = await getDoc(roomRef);

            if (!roomSnapshot.exists()) {
                return alert("Room ID does not exist. Create it first?");
            }

            await initMedia();

            const calleeCandidatesCollection = collection(roomRef, 'calleeCandidates');
            
            // Save ICE candidates
            pc.onicecandidate = (event) => {
                if(event.candidate) {
                    addDoc(calleeCandidatesCollection, event.candidate.toJSON());
                }
            };

            // Get Offer from DB
            const offer = roomSnapshot.data().offer;
            await pc.setRemoteDescription(new RTCSessionDescription(offer));

            // Create Answer
            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const roomWithAnswer = {
                answer: {
                    type: answerDescription.type,
                    sdp: answerDescription.sdp,
                },
            };

            // Update DB with Answer
            await updateDoc(roomRef, roomWithAnswer);

            // UI Update
            statusMsg.innerText = `Joined ${roomId}. Connecting...`;
            entryScreen.style.display = 'none';
            callControls.style.opacity = '1';
            remoteVideo.style.opacity = '1';

            // Listen for Remote ICE Candidates (Caller's)
            const callerCandidatesCollection = collection(roomRef, 'callerCandidates');
            onSnapshot(callerCandidatesCollection, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const candidate = new RTCIceCandidate(change.doc.data());
                        pc.addIceCandidate(candidate);
                    }
                });
            });
        };

        // 5. Controls Logic
        document.getElementById('btn-hangup').onclick = () => {
            pc.close();
            location.reload();
        }

        document.getElementById('btn-toggle-cam').onclick = () => {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
        }

        document.getElementById('btn-toggle-mic').onclick = () => {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
        }

    </script>
</body>
</html>
