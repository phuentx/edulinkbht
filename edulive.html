<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Meet - Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root {
            --bg-dark: #121212;
            --surface: #1e1e1e;
            --surface-light: #2c2c2c;
            --primary: #8ab4f8; 
            --danger: #ff5252;
            --text-main: #ffffff;
            --text-muted: #9aa0a6;
            --glass-bg: rgba(30, 30, 30, 0.85);
            --border: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 50;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }
        .header-left { display: flex; align-items: center; gap: 12px; pointer-events: auto; }
        .logo { font-family: 'Google Sans'; font-size: 19px; font-weight: 500; color: white; display: flex; align-items: center; gap: 8px;}
        .room-badge {
            background: rgba(255,255,255,0.1); backdrop-filter: blur(8px);
            padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 500;
            display: none; pointer-events: auto; border: 1px solid var(--border);
        }

        /* --- LOBBY --- */
        #lobby {
            position: absolute; inset: 0; z-index: 100;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .lobby-card {
            background: var(--surface); padding: 40px; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        }
        .lobby-card h1 { font-family: 'Google Sans'; margin-bottom: 12px; font-weight: 400; font-size: 26px; }
        .input-box {
            background: var(--surface-light); border: 1px solid transparent;
            width: 100%; padding: 16px; border-radius: 12px; color: white;
            font-size: 16px; margin: 24px 0; outline: none; transition: 0.2s;
        }
        .input-box:focus { border-color: var(--primary); background: #333; }
        .btn-primary {
            width: 100%; padding: 16px; background: var(--primary); color: #000;
            border: none; border-radius: 12px; font-weight: 600; font-size: 16px;
            cursor: pointer; margin-bottom: 12px; transition: opacity 0.2s;
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-text { background: none; border: none; color: var(--primary); cursor: pointer; font-weight: 500; }

        /* --- STAGE (VIDEO GRID) --- */
        #meeting-stage {
            flex: 1; 
            display: none; 
            position: relative;
            padding: 80px 40px 100px 40px; 
            overflow-y: auto; 
            overflow-x: hidden;
            transition: margin-right 0.3s ease;
        }
        #meeting-stage.drawer-open { margin-right: 340px; } 

        @media(max-width: 800px) { 
            #meeting-stage { padding: 70px 10px 90px 10px; }
            #meeting-stage.drawer-open { margin-right: 0; } 
        }

        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            width: 100%;
            max-width: 1400px; 
            margin: 0 auto; 
            align-content: center;
            justify-content: center;
            min-height: 100%;
        }
        
        #video-grid.grid-1 { grid-template-columns: 1fr; max-width: 900px; }
        #video-grid.grid-2 { grid-template-columns: 1fr 1fr; }

        @media (max-width: 600px) {
            #video-grid { grid-template-columns: 1fr; align-content: flex-start; }
            #video-grid.grid-2 { grid-template-columns: 1fr; }
        }

        /* --- VIDEO CARD --- */
        .vid-card {
            position: relative; 
            background: #202124; 
            border-radius: 16px; 
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            border: 2px solid transparent;
            aspect-ratio: 16/9;
            width: 100%;
        }

        @media (max-width: 600px) {
            .vid-card { aspect-ratio: 4/3; max-height: 40vh; }
        }

        .vid-card.speaking { border-color: var(--primary); box-shadow: 0 0 15px rgba(138, 180, 248, 0.3); }

        video { width: 100%; height: 100%; object-fit: cover; background: #000; }
        .mirrored { transform: scaleX(-1); }
        .screen-share-mode video { object-fit: contain !important; transform: scaleX(1) !important; background: #111; }
        .rotated-fullscreen video { transform: rotate(90deg); width: 100vh !important; height: 100vw !important; object-fit: contain; }
        
        .name-tag {
            position: absolute; bottom: 12px; left: 12px;
            background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 6px;
            font-size: 12px; color: white; display: flex; align-items: center; gap: 6px;
            backdrop-filter: blur(4px); pointer-events: none; font-weight: 500; z-index: 2;
        }
        
        .status-icon { color: var(--danger); display: none; }
        .vid-card.muted .status-icon { display: block; }
        
        .avatar {
            position: absolute; inset: 0; background: #333;
            display: none; align-items: center; justify-content: center;
            font-size: 48px; color: white; font-weight: bold;
        }
        .vid-card.cam-off video { opacity: 0; }
        .vid-card.cam-off .avatar { display: flex; }

        .hand-badge {
            position: absolute; top: 12px; left: 12px;
            background: #2c2c2c; padding: 8px; border-radius: 50%;
            display: none; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 2;
        }
        .vid-card.hand-up .hand-badge { display: block; }
        @keyframes pop { from {transform: scale(0);} to {transform: scale(1);} }

        /* Card Menu */
        .card-menu-btn {
            position: absolute; top: 12px; right: 12px;
            background: rgba(0,0,0,0.4); border-radius: 50%; width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0; transition: 0.2s; color: white; border: none; z-index: 10;
        }
        .vid-card:hover .card-menu-btn, .card-menu-btn.active { opacity: 1; }
        .card-menu-btn:hover { background: rgba(0,0,0,0.7); }

        .card-dropdown {
            position: absolute; top: 50px; right: 12px;
            background: #2c2c2c; border: 1px solid var(--border);
            border-radius: 8px; padding: 4px; width: 170px; /* Wider for new options */
            display: none; flex-direction: column;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 20;
        }
        .card-dropdown.show { display: flex; }
        .dropdown-item {
            padding: 10px 12px; font-size: 13px; color: white; cursor: pointer;
            display: flex; align-items: center; gap: 8px; border-radius: 4px;
        }
        .dropdown-item:hover { background: rgba(255,255,255,0.1); }
        .dropdown-item.danger { color: #ff8a80; }
        .dropdown-item.active-spot { color: #ff5252; background: rgba(255, 82, 82, 0.1); }

        /* Pinned Mode Classes */
        .vid-card.pinned-view {
            z-index: 40;
            border-color: var(--primary);
            grid-column: 1 / -1; 
            grid-row: 1 / -1;
            aspect-ratio: auto; 
            height: 100%; width: 100%;
        }
        
        /* If pinned via Spotlight, give it a red border to indicate live */
        .vid-card.pinned-view.spotlight-active {
            border-color: var(--danger);
            box-shadow: 0 0 20px rgba(255, 82, 82, 0.4);
        }

        /* --- CONTROLS --- */
        .controls-wrapper {
            position: fixed; bottom: 24px; left: 0; width: 100%;
            display: flex; justify-content: center; z-index: 60; pointer-events: none;
        }
        .control-bar {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            padding: 10px 20px; border-radius: 50px; border: 1px solid var(--border);
            display: flex; gap: 12px; pointer-events: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        .btn-ctrl {
            width: 48px; height: 48px; border-radius: 50%; border: none;
            background: transparent; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s; position: relative;
        }
        .btn-ctrl:hover { background: rgba(255,255,255,0.15); }
        .btn-ctrl:active { transform: scale(0.95); }
        .btn-ctrl.active { background: var(--primary); color: black; }
        .btn-ctrl.off { background: rgba(255,255,255,0.1); color: var(--text-muted); }
        .btn-ctrl.off-red { background: var(--danger); color: white; }
        
        .btn-ctrl.hangup { background: var(--danger); width: 64px; border-radius: 32px; margin-left: 8px;}
        .btn-ctrl.hangup:hover { background: #d32f2f; }

        .unread-dot {
            position: absolute; top: 10px; right: 10px; width: 10px; height: 10px;
            background: var(--danger); border-radius: 50%; border: 2px solid #2e2e2e;
            display: none;
        }

        /* --- DRAWERS --- */
        .drawer {
            position: fixed; top: 16px; bottom: 16px; right: 16px; width: 320px;
            background: var(--surface); border-radius: 16px;
            border: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100;
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 40px rgba(0,0,0,0.6);
        }
        .drawer.open { transform: translateX(0); }

        @media (max-width: 768px) {
            .drawer {
                top: auto; bottom: 0; left: 0; right: 0; width: 100%; 
                border-radius: 24px 24px 0 0; transform: translateY(100%);
                border: none; box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            }
            .drawer.open { transform: translateY(0); }
            
            #chat-drawer { height: 85vh !important; }
            #options-drawer { height: auto !important; max-height: 50vh; }

            .msg { max-width: 85% !important; } 
            .msg-bubble { font-size: 15px !important; padding: 12px 16px !important; }
            
            .chat-footer { padding: 10px 14px !important; }
            .chat-input { padding: 12px 16px !important; font-size: 15px !important; }
            .chat-send { padding: 6px !important; }
        }

        /* Chat Specific */
        .chat-header {
            padding: 18px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 500; font-family: 'Google Sans'; font-size: 18px;
        }
        .chat-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg.me { align-self: flex-end; align-items: flex-end; }
        .msg.them { align-self: flex-start; align-items: flex-start; }
        
        .msg-name { font-size: 11px; color: var(--text-muted); margin-bottom: 4px; margin-left: 4px; }
        .msg-bubble { 
            padding: 12px 16px; border-radius: 20px; font-size: 14px; 
            line-height: 1.5; word-wrap: break-word; 
        }
        .msg.me .msg-bubble { background: var(--primary); color: #121212; border-bottom-right-radius: 4px; }
        .msg.them .msg-bubble { background: #333; color: white; border-bottom-left-radius: 4px; }

        .chat-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .chat-input {
            flex: 1; background: #2c2c2c; border: none; padding: 14px;
            border-radius: 24px; color: white; outline: none; font-family: 'Inter'; font-size: 15px;
        }
        .chat-send { background: none; border: none; color: var(--primary); cursor: pointer; padding: 8px; transition: transform 0.1s;}
        .chat-send:active { transform: scale(0.9); }

        /* Options */
        .options-grid {
            padding: 24px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }
        .opt-btn {
            background: var(--surface-light); border: 1px solid transparent;
            border-radius: 12px; padding: 20px; text-align: center;
            color: white; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .opt-btn:hover { background: #333; }
        .opt-btn.active { background: rgba(138, 180, 248, 0.15); border-color: var(--primary); color: var(--primary); }
        .opt-label { font-size: 13px; font-weight: 500; }

    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo"><i data-lucide="video" color="#8ab4f8"></i> Edulinki</div>
            <div id="room-badge" class="room-badge"></div>
        </div>
    </header>

    <div id="lobby">
        <div class="lobby-card">
            <h1>Join Meeting</h1>
            <p style="color:var(--text-muted); margin-bottom: 24px;">Premium video conferencing.</p>
            <input type="text" id="roomInput" class="input-box" placeholder="Enter Room Code" autocomplete="off">
            <button id="joinBtn" class="btn-primary" disabled>Join Room</button>
            <button id="createBtn" class="btn-text">Create New Meeting</button>
        </div>
    </div>

    <div id="meeting-stage">
        <div id="video-grid">
        </div>
    </div>

    <div id="chat-drawer" class="drawer">
        <div class="chat-header">
            <span>Messages</span>
            <button onclick="toggleChat()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div class="chat-body" id="chatBody">
            <div style="text-align:center; font-size:13px; color:#555; margin-top:20px;">
                Messages are deleted when everyone leaves.
            </div>
        </div>
        <div class="chat-footer">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." autocomplete="off">
            <button id="sendBtn" class="chat-send" disabled><i data-lucide="send-horizontal"></i></button>
        </div>
    </div>

    <div id="options-drawer" class="drawer">
        <div class="chat-header">
            <span>Controls</span>
            <button onclick="toggleOptions()" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div class="options-grid">
            <button id="optHand" class="opt-btn" onclick="toggleHand()">
                <i data-lucide="hand"></i>
                <span class="opt-label">Raise Hand</span>
            </button>
            <button id="optScreen" class="opt-btn" onclick="toggleScreen()">
                <i data-lucide="monitor-up"></i>
                <span class="opt-label">Share Screen</span>
            </button>
        </div>
    </div>

    <div class="controls-wrapper" id="controls" style="display:none;">
        <div class="control-bar">
            <button id="micBtn" class="btn-ctrl" title="Mic"><i data-lucide="mic"></i></button>
            <button id="camBtn" class="btn-ctrl" title="Camera"><i data-lucide="camera"></i></button>
            
            <button id="chatBtn" class="btn-ctrl" title="Chat" onclick="toggleChat()">
                <i data-lucide="message-square"></i>
                <div class="unread-dot" id="unreadDot"></div>
            </button>
            
            <button id="moreBtn" class="btn-ctrl" title="More Options" onclick="toggleOptions()">
                <i data-lucide="more-vertical"></i>
                <div class="unread-dot" id="optionsDot"></div>
            </button>
            
            <button id="hangupBtn" class="btn-ctrl hangup" title="Leave"><i data-lucide="phone-off"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, deleteDoc, query, orderBy, getDocs, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        lucide.createIcons();

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const iceServers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

        // State
        let localStream, screenStream;
        let roomId;
        let myId = Math.random().toString(36).substr(2, 5).toUpperCase();
        let pcs = {};
        let audioCtx;
        let isMuted = false, isCamOff = false, isHandRaised = false, isChatOpen = false, isOptionsOpen = false;
        
        // Pinned State
        let localPinnedId = null;  // For "Pin for me"
        let globalSpotlightId = null; // For "Spotlight" (Database)
        
        let userCount = 0;

        // DOM Elements
        const grid = document.getElementById('video-grid');
        const lobby = document.getElementById('lobby');
        const stage = document.getElementById('meeting-stage');
        const controls = document.getElementById('controls');
        const chatDrawer = document.getElementById('chat-drawer');
        const optionsDrawer = document.getElementById('options-drawer');
        const unreadDot = document.getElementById('unreadDot');
        
        // --- 1. LAYOUT LOGIC ---
        function calculateLayout() {
            const count = grid.children.length;
            grid.classList.remove('grid-1', 'grid-2');
            if(count === 1) grid.classList.add('grid-1');
            if(count === 2) grid.classList.add('grid-2');

            // Logic: Spotlight (Global) takes precedence, then Local Pin.
            const activePin = globalSpotlightId || localPinnedId;

            if (activePin) {
                const pinnedCard = document.getElementById(`vid-${activePin}`);
                
                if(pinnedCard) {
                    Array.from(grid.children).forEach(card => {
                        const id = card.id.replace('vid-', '');
                        if (id === activePin) {
                            card.style.display = 'block';
                            card.classList.add('pinned-view');
                            // Visual indication if it is a global spotlight
                            if(globalSpotlightId === id) {
                                card.classList.add('spotlight-active');
                            } else {
                                card.classList.remove('spotlight-active');
                            }
                        } else {
                            card.style.display = 'none'; 
                            card.classList.remove('pinned-view');
                            card.classList.remove('spotlight-active');
                        }
                    });
                    grid.style.display = 'block'; 
                    grid.style.height = '100%';
                    return;
                }
            }

            // Normal Grid
            grid.style.display = 'grid';
            grid.style.height = 'auto';
            Array.from(grid.children).forEach(c => {
                c.style.display = 'block';
                c.classList.remove('pinned-view');
                c.classList.remove('spotlight-active');
                c.style.width = '';
                c.style.height = '';
                c.style.flex = '';
            });
        }
        
        window.onresize = calculateLayout;

        // --- 2. VIDEO MANAGER ---
        function addVideoCard(uid, stream, isLocal) {
            if(document.getElementById(`vid-${uid}`)) return;

            const card = document.createElement('div');
            card.className = 'vid-card';
            card.id = `vid-${uid}`;
            
            const mirrorClass = isLocal ? 'mirrored' : '';

            card.innerHTML = `
                <video autoplay playsinline class="${mirrorClass}" ${isLocal ? 'muted' : ''}></video>
                <div class="avatar" style="background:${stringToColor(uid)}">${uid[0]}</div>
                <div class="name-tag">
                    <i data-lucide="mic-off" class="status-icon" size="12"></i>
                    <span>${isLocal ? 'You' : uid}</span>
                </div>
                <div class="hand-badge"><i data-lucide="hand" color="white" size="16"></i></div>
                
                <button class="card-menu-btn" onclick="toggleCardMenu(event, '${uid}')">
                    <i data-lucide="more-vertical" size="16"></i>
                </button>
                <div class="card-dropdown" id="menu-${uid}">
                    <div class="dropdown-item" onclick="pinLocal('${uid}')">
                        <i data-lucide="pin" size="14"></i> <span class="txt-pin">Pin for me</span>
                    </div>
                    <div class="dropdown-item" onclick="toggleSpotlight('${uid}')">
                        <i data-lucide="target" size="14"></i> <span class="txt-spot">Spotlight (All)</span>
                    </div>
                    <div class="dropdown-item" onclick="enterFullscreen('${uid}')">
                        <i data-lucide="maximize" size="14"></i> Fullscreen
                    </div>
                </div>
            `;
            card.querySelector('video').srcObject = stream;
            grid.appendChild(card);
            lucide.createIcons();
            
            calculateLayout();
        }

        function removeVideoCard(uid) {
            const card = document.getElementById(`vid-${uid}`);
            if(card) { card.remove(); calculateLayout(); }
            if(localPinnedId === uid) localPinnedId = null;
            calculateLayout();
        }

        // --- 3. MENU ACTIONS ---
        window.toggleCardMenu = (e, uid) => {
            e.stopPropagation();
            const menu = document.getElementById(`menu-${uid}`);
            
            // Update Text Dynamically
            const pinBtn = menu.children[0];
            pinBtn.innerHTML = `<i data-lucide="pin" size="14"></i> ${localPinnedId === uid ? 'Unpin (Me)' : 'Pin for me'}`;
            
            const spotBtn = menu.children[1];
            // Style changes based on state
            if(globalSpotlightId === uid) {
                spotBtn.innerHTML = `<i data-lucide="target" size="14"></i> Stop Spotlight`;
                spotBtn.classList.add('active-spot');
            } else {
                spotBtn.innerHTML = `<i data-lucide="target" size="14"></i> Spotlight (All)`;
                spotBtn.classList.remove('active-spot');
            }
            
            lucide.createIcons();
            document.querySelectorAll('.card-dropdown').forEach(d => d.classList.remove('show'));
            menu.classList.toggle('show');
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.card-dropdown').forEach(d => d.classList.remove('show'));
        });

        // LOCAL PIN
        window.pinLocal = (uid) => {
            localPinnedId = (localPinnedId === uid) ? null : uid;
            calculateLayout();
        }

        // GLOBAL SPOTLIGHT (DB Write - Fixed with setDoc merge)
        window.toggleSpotlight = async (uid) => {
            const roomRef = doc(db, `rooms/${roomId}`);
            if (globalSpotlightId === uid) {
                // Remove spotlight
                await updateDoc(roomRef, { spotlight: deleteField() });
            } else {
                // Set spotlight - Use setDoc with merge to ensure doc exists
                await setDoc(roomRef, { spotlight: uid }, { merge: true });
            }
        }

        window.enterFullscreen = (uid) => {
            const card = document.getElementById(`vid-${uid}`);
            const video = card.querySelector('video');
            if (video.requestFullscreen) {
                video.requestFullscreen().then(() => {
                    if (screen.orientation && screen.orientation.lock) {
                        screen.orientation.lock("landscape").catch(console.log);
                    }
                }).catch(console.error);
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            }
        }

        function stringToColor(str) {
            let hash = 0; for(let i=0; i<str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${hash % 360}, 60%, 50%)`;
        }

        // --- 4. SIGNALING & INIT ---
        document.getElementById('roomInput').oninput = (e) => document.getElementById('joinBtn').disabled = !e.target.value;
        document.getElementById('createBtn').onclick = () => start(Math.random().toString(36).substr(2, 6));
        document.getElementById('joinBtn').onclick = () => start(document.getElementById('roomInput').value.trim());

        async function start(id) {
            roomId = id;
            document.getElementById('room-badge').innerText = `ID: ${roomId}`;
            document.getElementById('room-badge').style.display = 'block';
            lobby.style.display = 'none';
            stage.style.display = 'block';
            controls.style.display = 'flex';
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addVideoCard(myId, localStream, true);
                setupAudioViz(localStream, myId);
                await joinRoom();
            } catch(e) { alert("Camera access required!"); }
        }

        async function joinRoom() {
            // Ensure Room Document Exists
            await setDoc(doc(db, `rooms/${roomId}`), { created: Date.now() }, { merge: true });

            const userRef = doc(db, `rooms/${roomId}/users/${myId}`);
            await setDoc(userRef, { present: true, mic: true, cam: true, hand: false });
            
            // CLEANUP ON LEAVE
            window.onbeforeunload = async () => {
                await deleteDoc(userRef);
                await cleanupRoomIfEmpty();
            };

            // 1. Listen to Room Doc (for Spotlight)
            onSnapshot(doc(db, `rooms/${roomId}`), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    globalSpotlightId = data.spotlight || null;
                    calculateLayout(); // Re-render grid when spotlight changes
                }
            });

            // 2. Listen to Users
            onSnapshot(collection(db, `rooms/${roomId}/users`), (snap) => {
                userCount = snap.size;
                snap.docChanges().forEach(change => {
                    const uid = change.doc.id;
                    const data = change.doc.data();
                    if(uid === myId) return;

                    if(change.type === 'removed') {
                        removeVideoCard(uid);
                        if(pcs[uid]) { pcs[uid].close(); delete pcs[uid]; }
                    } else {
                        updateStatus(uid, data);
                        if(change.type === 'added' && !pcs[uid]) {
                            (myId < uid) ? createPeer(uid, true) : createPeer(uid, false);
                        }
                    }
                });
            });

            // 3. Signals
            onSnapshot(collection(db, `rooms/${roomId}/signals`), (snap) => {
                snap.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const msg = change.doc.data();
                        if(msg.to === myId) {
                            await handleSignal(msg);
                            deleteDoc(change.doc.ref);
                        }
                    }
                });
            });

            // 4. Chat
            onSnapshot(query(collection(db, `rooms/${roomId}/chat`), orderBy('ts')), (snap) => {
                snap.docChanges().forEach(change => {
                    if(change.type === 'added') {
                        renderMsg(change.doc.data());
                        if(!isChatOpen) unreadDot.style.display = 'block';
                    }
                });
            });
        }

        async function cleanupRoomIfEmpty() {
            const userSnap = await getDocs(collection(db, `rooms/${roomId}/users`));
            if (userSnap.empty) {
                const chatSnap = await getDocs(collection(db, `rooms/${roomId}/chat`));
                const batch = writeBatch(db);
                chatSnap.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
            }
        }

        // --- 5. WEBRTC (MESH) ---
        async function createPeer(uid, initiator) {
            const pc = new RTCPeerConnection(iceServers);
            pcs[uid] = pc;
            pc.onicecandidate = e => e.candidate && sendSignal({ type: 'candidate', candidate: e.candidate.toJSON(), to: uid, from: myId });
            pc.ontrack = e => { addVideoCard(uid, e.streams[0], false); setupAudioViz(e.streams[0], uid); };
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            if(initiator) {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                sendSignal({ type: 'offer', sdp: offer.sdp, to: uid, from: myId });
            }
        }
        
        async function handleSignal(msg) {
            const pc = pcs[msg.from] || (await createPeer(msg.from, false), pcs[msg.from]);
            if(msg.type === 'offer') {
                await pc.setRemoteDescription(new RTCSessionDescription({type:'offer', sdp:msg.sdp}));
                const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                sendSignal({ type: 'answer', sdp: ans.sdp, to: msg.from, from: myId });
            } else if (msg.type === 'answer') await pc.setRemoteDescription(new RTCSessionDescription({type:'answer', sdp:msg.sdp}));
            else if (msg.type === 'candidate') await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
        async function sendSignal(data) { await addDoc(collection(db, `rooms/${roomId}/signals`), data); }

        function updateStatus(uid, data) {
            const card = document.getElementById(`vid-${uid}`);
            if(!card) return;
            card.classList.toggle('muted', !data.mic);
            card.classList.toggle('cam-off', !data.cam);
            card.classList.toggle('hand-up', data.hand);
        }

        // --- 6. AUDIO VISUALIZER ---
        function setupAudioViz(stream, uid) {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const src = audioCtx.createMediaStreamSource(stream);
            const anl = audioCtx.createAnalyser(); anl.fftSize = 64;
            src.connect(anl);
            const data = new Uint8Array(anl.frequencyBinCount);
            const loop = () => {
                anl.getByteFrequencyData(data);
                let sum=0; data.forEach(v=>sum+=v);
                const card = document.getElementById(`vid-${uid}`);
                if(card) (sum/data.length > 20 && !card.classList.contains('muted')) ? card.classList.add('speaking') : card.classList.remove('speaking');
                requestAnimationFrame(loop);
            }; loop();
        }

        // --- 7. CONTROLS ---
        const myDoc = () => doc(db, `rooms/${roomId}/users/${myId}`);
        
        document.getElementById('micBtn').onclick = (e) => {
            isMuted = !isMuted; localStream.getAudioTracks()[0].enabled = !isMuted;
            updateBtn(e.currentTarget, isMuted, 'mic', 'mic-off');
            updateDoc(myDoc(), { mic: !isMuted });
            document.getElementById(`vid-${myId}`).classList.toggle('muted', isMuted);
        };
        document.getElementById('camBtn').onclick = (e) => {
            isCamOff = !isCamOff; localStream.getVideoTracks()[0].enabled = !isCamOff;
            updateBtn(e.currentTarget, isCamOff, 'camera', 'camera-off');
            updateDoc(myDoc(), { cam: !isCamOff });
            document.getElementById(`vid-${myId}`).classList.toggle('cam-off', isCamOff);
        };

        window.toggleOptions = () => {
            if(isChatOpen) window.toggleChat(); 

            isOptionsOpen = !isOptionsOpen;
            optionsDrawer.classList.toggle('open', isOptionsOpen);
            stage.classList.toggle('drawer-open', isOptionsOpen);
            document.getElementById('moreBtn').classList.toggle('active', isOptionsOpen);
        };

        window.toggleHand = () => {
            isHandRaised = !isHandRaised;
            updateDoc(myDoc(), { hand: isHandRaised });
            document.getElementById('optHand').classList.toggle('active', isHandRaised);
        };

        window.toggleScreen = async () => {
            if(!screenStream) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const trk = screenStream.getVideoTracks()[0];
                    for(let uid in pcs) {
                        const snd = pcs[uid].getSenders().find(s => s.track.kind === 'video');
                        if(snd) snd.replaceTrack(trk);
                    }
                    const localCard = document.getElementById(`vid-${myId}`);
                    const localVid = localCard.querySelector('video');
                    localVid.srcObject = screenStream;
                    localCard.classList.add('screen-share-mode');
                    document.getElementById('optScreen').classList.add('active');
                    trk.onended = stopScreen;
                    window.toggleOptions(); 
                } catch(e) { console.error(e); }
            } else stopScreen();
        };

        function stopScreen() {
            const trk = localStream.getVideoTracks()[0];
            for(let uid in pcs) {
                const snd = pcs[uid].getSenders().find(s => s.track.kind === 'video');
                if(snd) snd.replaceTrack(trk);
            }
            const localCard = document.getElementById(`vid-${myId}`);
            const localVid = localCard.querySelector('video');
            localVid.srcObject = localStream;
            localCard.classList.remove('screen-share-mode');
            document.getElementById('optScreen').classList.remove('active');
            if(screenStream) screenStream.getTracks().forEach(t=>t.stop());
            screenStream = null;
        }

        // --- 8. CHAT LOGIC ---
        window.toggleChat = () => {
            if(isOptionsOpen) window.toggleOptions();

            isChatOpen = !isChatOpen;
            chatDrawer.classList.toggle('open', isChatOpen);
            stage.classList.toggle('drawer-open', isChatOpen);
            document.getElementById('chatBtn').classList.toggle('active', isChatOpen);
            
            if(isChatOpen) {
                unreadDot.style.display = 'none';
                setTimeout(() => { document.getElementById('chatInput').focus(); }, 300);
            }
        };

        document.getElementById('hangupBtn').onclick = async () => {
            await deleteDoc(myDoc()); 
            await cleanupRoomIfEmpty();
            window.location.reload();
        };

        function updateBtn(btn, off, iconOn, iconOff) {
            btn.classList.toggle('off-red', off);
            btn.innerHTML = `<i data-lucide="${off ? iconOff : iconOn}"></i>`;
            if(btn.id === 'moreBtn') btn.appendChild(document.getElementById('optionsDot'));
            if(btn.id === 'chatBtn') btn.appendChild(document.getElementById('unreadDot'));
            lucide.createIcons();
        }

        document.getElementById('chatInput').oninput = (e) => document.getElementById('sendBtn').disabled = !e.target.value.trim();
        document.getElementById('sendBtn').onclick = sendMsg;
        document.getElementById('chatInput').onkeydown = (e) => { if(e.key === 'Enter') sendMsg(); };

        async function sendMsg() {
            const txt = document.getElementById('chatInput').value.trim();
            if(!txt) return;
            document.getElementById('chatInput').value = '';
            await addDoc(collection(db, `rooms/${roomId}/chat`), { sender: myId, text: txt, ts: Date.now() });
        }

        function renderMsg(msg) {
            const isMe = msg.sender === myId;
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'me' : 'them'}`;
            div.innerHTML = `<div class="msg-name">${isMe ? 'You' : msg.sender}</div><div class="msg-bubble">${msg.text}</div>`;
            const body = document.getElementById('chatBody');
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }

    </script>
</body>
</html>
