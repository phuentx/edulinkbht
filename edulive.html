<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Enterprise</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #FF3B5C;
            --accent: #25F4EE;
            --dark: #121212;
            --glass: rgba(255, 255, 255, 0.15);
            --glass-dark: rgba(0, 0, 0, 0.4);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: black; color: white; margin: 0; padding: 0;
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; justify-content: center;
        }

        #app {
            width: 100%; max-width: 480px; height: 100%; position: relative;
            background: #000; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* --- VIDEO LAYER (Background) --- */
        #video-stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: #111; display: flex; flex-direction: column;
            transition: all 0.4s ease;
        }

        .video-box {
            position: relative; width: 100%; overflow: hidden; flex: 1;
            transition: height 0.4s ease;
        }
        
        #host-video-box { height: 100%; }
        #guest-video-box { height: 0; display: none; border-top: 1px solid rgba(255,255,255,0.1); }

        /* Split Screen Mode */
        #video-stage.split #host-video-box { height: 50%; }
        #video-stage.split #guest-video-box { height: 50%; display: block; }

        video {
            width: 100%; height: 100%; object-fit: cover;
        }
        .mirror { transform: scaleX(-1); }

        /* --- UI LAYER (Foreground) --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; /* Click-through to video */
            display: flex; flex-direction: column;
        }

        /* 1. Header */
        .header {
            padding: 40px 15px 15px 15px; /* Top padding for notches */
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
            pointer-events: auto;
        }

        .host-info {
            display: flex; align-items: center; gap: 8px;
            background: var(--glass-dark); padding: 4px 12px 4px 4px;
            border-radius: 30px; backdrop-filter: blur(8px);
            border: 0.5px solid rgba(255,255,255,0.1);
        }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(45deg, #FF3B5C, #FF9068); }
        .host-meta { display: flex; flex-direction: column; line-height: 1.1; }
        .username { font-size: 13px; font-weight: 700; max-width: 90px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .views { font-size: 10px; color: #ddd; }
        
        .live-tag { background: var(--primary); font-size: 10px; padding: 3px 6px; border-radius: 4px; font-weight: 800; margin-left: 5px; }

        .end-btn {
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* 2. Spacer (Pushes footer down) */
        .spacer { flex: 1; position: relative; pointer-events: none; }
        
        /* Request Popup (Host Only) */
        #request-popup {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 10px; width: 220px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            transform: translateX(120%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
        }
        #request-popup.show { transform: translateX(0); }
        .req-actions { display: flex; gap: 8px; }
        .req-btn { flex: 1; padding: 8px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; }
        .req-accept { background: var(--accent); color: black; }
        .req-decline { background: rgba(255,255,255,0.2); color: white; }

        /* 3. Footer (Chat & Input) */
        .footer {
            padding: 15px;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            display: flex; flex-direction: column; gap: 10px; pointer-events: auto;
        }

        .chat-scroll {
            height: 220px; overflow-y: scroll; display: flex; flex-direction: column; justify-content: flex-end;
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 85%, transparent 100%);
        }
        .chat-scroll::-webkit-scrollbar { display: none; }

        .msg {
            background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 16px;
            font-size: 13px; margin-bottom: 6px; width: fit-content; max-width: 85%;
            backdrop-filter: blur(4px); animation: fadeInUp 0.3s ease;
        }
        .msg b { color: rgba(255,255,255,0.7); margin-right: 6px; font-weight: 600; }
        .sys-msg { background: rgba(37, 244, 238, 0.15); border: 1px solid rgba(37, 244, 238, 0.3); color: #25F4EE; }

        .input-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        
        .chat-input {
            flex: 1; background: rgba(255,255,255,0.15); border: none; padding: 12px 18px;
            border-radius: 25px; color: white; outline: none; font-size: 14px;
        }
        .chat-input::placeholder { color: rgba(255,255,255,0.6); }

        .action-btn {
            width: 44px; height: 44px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 18px;
            transition: transform 0.1s; backdrop-filter: blur(5px);
        }
        .action-btn:active { transform: scale(0.9); }
        
        .join-btn { background: #25F4EE; color: black; position: relative; }
        .join-btn.pending { background: #FFAB00; color: black; animation: pulse 2s infinite; }
        .heart-btn { background: linear-gradient(135deg, #FF3B5C, #C00); box-shadow: 0 4px 15px rgba(255, 59, 92, 0.4); }

        /* Setup Screen */
        #setup-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; padding: 30px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .card { width: 100%; background: #1a1a1a; padding: 25px; border-radius: 24px; border: 1px solid #333; text-align: center; }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; margin-top: 15px; }
        .input-main { width: 100%; padding: 14px; background: #222; border: 1px solid #333; border-radius: 12px; color: white; text-align: center; font-size: 16px; outline: none; }
        .tabs { display: flex; background: #222; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; background: transparent; color: #888; border: none; border-radius: 10px; font-weight: 600; }
        .tab.active { background: #333; color: white; }

        /* Hearts Animation */
        #hearts-canvas { position: absolute; bottom: 80px; right: 20px; width: 60px; height: 400px; pointer-events: none; z-index: 5; }
        .floater { position: absolute; bottom: 0; font-size: 28px; animation: float 2s ease-out forwards; opacity: 0; }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0% { opacity: 1; transform: translateY(0) scale(0.5); } 100% { opacity: 0; transform: translateY(-300px) scale(1.5) rotate(25deg); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 171, 0, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 171, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 171, 0, 0); } }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app">
    
    <div id="video-stage">
        <div id="host-video-box" class="video-box">
            <video id="vid-host" autoplay playsinline class="mirror"></video> 
            </div>
        <div id="guest-video-box" class="video-box">
            <video id="vid-guest" autoplay playsinline class="mirror"></video>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        
        <div class="header">
            <div class="host-info">
                <div class="avatar"></div>
                <div class="host-meta">
                    <div class="username" id="ui-name">@username</div>
                    <div class="views">üëÅÔ∏è 12.5k</div>
                </div>
                <div class="live-tag">LIVE</div>
            </div>
            <div class="end-btn" onclick="location.reload()"><i class="fas fa-times"></i></div>
        </div>

        <div class="spacer">
            <div id="request-popup">
                <div style="font-size:13px; font-weight:bold;">üì∏ Guest Request</div>
                <div style="font-size:11px; color:#aaa;">A viewer wants to join video.</div>
                <div class="req-actions">
                    <button class="req-btn req-decline" onclick="handleRequest('decline')">Decline</button>
                    <button class="req-btn req-accept" onclick="handleRequest('accept')">Accept</button>
                </div>
            </div>
        </div>

        <div id="hearts-canvas"></div>

        <div class="footer">
            <div class="chat-scroll" id="chat-list">
                </div>
            
            <div class="input-row">
                <input type="text" class="chat-input" id="chat-input" placeholder="Add a comment..." autocomplete="off">
                <button class="action-btn" id="send-btn"><i class="fas fa-arrow-up"></i></button>
                
                <button class="action-btn join-btn" id="req-join-btn" style="display:none;">
                    <i class="fas fa-video"></i>
                </button>
                
                <button class="action-btn heart-btn" id="heart-btn"><i class="fas fa-heart"></i></button>
            </div>
        </div>
    </div>

    <div id="setup-layer">
        <h1 style="font-weight: 800; margin-bottom: 20px;">üî• FireTok</h1>
        <div class="card">
            <div class="tabs">
                <button class="tab active" id="tab-host" onclick="setMode('host')">Host</button>
                <button class="tab" id="tab-view" onclick="setMode('viewer')">Viewer</button>
            </div>
            <input type="text" id="room-id" class="input-main" placeholder="Create Unique ID (e.g. 'party')">
            <button class="btn-main" id="go-btn">Go Live</button>
        </div>
        <p style="margin-top:20px; font-size:11px; opacity:0.5;">Enterprise Edition v3.0</p>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
        authDomain: "edulinki.firebaseapp.com",
        projectId: "edulinki",
        storageBucket: "edulinki.firebasestorage.app",
        messagingSenderId: "248886466474",
        appId: "1:248886466474:web:160043201a6b28bafbbdd3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- 2. WEBRTC CONFIG (Free TURN) ---
    const servers = {
        iceServers: [
            { urls: ['stun:stun1.l.google.com:19302'] },
            { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ]
    };

    // --- 3. STATE ---
    let pc = null;
    let localStream = null;
    let roomId = null;
    let isHost = true;
    let currentReqDocId = null; // For host to track pending request

    const els = {
        setup: document.getElementById('setup-layer'),
        ui: document.getElementById('ui-layer'),
        vidStage: document.getElementById('video-stage'),
        vidHost: document.getElementById('vid-host'),
        vidGuest: document.getElementById('vid-guest'),
        reqBtn: document.getElementById('req-join-btn'),
        popup: document.getElementById('request-popup')
    };

    window.setMode = (mode) => {
        isHost = (mode === 'host');
        document.getElementById('tab-host').className = isHost ? 'tab active' : 'tab';
        document.getElementById('tab-view').className = !isHost ? 'tab active' : 'tab';
        document.getElementById('go-btn').innerText = isHost ? "Start Live" : "Join Live";
    };

    // --- 4. MAIN ENTRY ---
    document.getElementById('go-btn').onclick = async () => {
        roomId = document.getElementById('room-id').value.trim();
        if(!roomId) return alert("Enter Room ID");
        
        els.setup.classList.add('hidden');
        els.ui.classList.remove('hidden');
        document.getElementById('ui-name').innerText = "@" + roomId;

        await initWebRTC();
        initChat();
        
        if(isHost) initHostSignaling();
        else initViewerSignaling();
    };

    // --- 5. WEBRTC ENGINE ---
    async function initWebRTC() {
        pc = new RTCPeerConnection(servers);

        // -- Audio Unlock Trick --
        // This plays an empty sound or attempts to play video on click to unlock audio context
        els.vidHost.play().catch(e => {});
        els.vidGuest.play().catch(e => {});

        // 5a. HOST SETUP
        if(isHost) {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            els.vidHost.srcObject = localStream;
            els.vidHost.muted = true; // Mute self
            els.vidHost.classList.add('mirror');
            
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        }
        // 5b. VIEWER SETUP (Initially just watching)
        else {
            els.reqBtn.style.display = 'flex'; // Show Request Button
        }

        // 5c. HANDLE INCOMING STREAMS (The Split Logic)
        pc.ontrack = (event) => {
            const stream = event.streams[0];
            
            if(isHost) {
                // Host receives Guest -> Split Screen
                els.vidStage.classList.add('split');
                els.vidGuest.srcObject = stream;
                els.vidGuest.muted = false; // Hear guest
            } else {
                // Viewer receives streams
                if(!els.vidHost.srcObject) {
                    // First stream is Host -> Top
                    els.vidHost.srcObject = stream;
                    els.vidHost.muted = false; // Hear host
                    els.vidHost.classList.remove('mirror');
                } else {
                    // Second stream is Guest -> Bottom
                    els.vidStage.classList.add('split');
                    els.vidGuest.srcObject = stream;
                    els.vidGuest.muted = false; // Hear guest
                }
            }
        };

        // 5d. BASIC SIGNALING (One-time connection)
        const callDoc = doc(db, "calls", roomId);
        const offerCandidates = collection(callDoc, "offerCandidates");
        const answerCandidates = collection(callDoc, "answerCandidates");

        if (isHost) {
            await setDoc(callDoc, { type: 'ready' });
            pc.onicecandidate = e => e.candidate && addDoc(offerCandidates, e.candidate.toJSON());
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await setDoc(callDoc, { offer: { sdp: offer.sdp, type: offer.type } });

            onSnapshot(callDoc, async (snap) => {
                const data = snap.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
            onSnapshot(answerCandidates, snap => {
                snap.docChanges().forEach(c => {
                    if (c.type === 'added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
                });
            });

        } else {
            pc.onicecandidate = e => e.candidate && addDoc(answerCandidates, e.candidate.toJSON());
            
            // Wait for room
            const checkRoom = async () => {
                const snap = await getDoc(callDoc);
                if (snap.exists()) {
                    await pc.setRemoteDescription(new RTCSessionDescription(snap.data().offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await updateDoc(callDoc, { answer: { sdp: answer.sdp, type: answer.type } });
                    
                    onSnapshot(offerCandidates, snap => {
                        snap.docChanges().forEach(c => {
                            if (c.type === 'added') pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
                        });
                    });
                } else {
                    setTimeout(checkRoom, 1000);
                }
            };
            checkRoom();
        }
    }

    // --- 6. REQUEST TO JOIN SYSTEM ---

    // Host listens for requests
    function initHostSignaling() {
        const reqCol = collection(db, `calls/${roomId}/requests`);
        onSnapshot(reqCol, (snap) => {
            snap.docChanges().forEach(change => {
                if(change.type === 'added' && change.doc.data().status === 'pending') {
                    currentReqDocId = change.doc.id;
                    els.popup.classList.add('show');
                    // Auto-hide after 10s if ignored?
                }
            });
        });
    }

    // Host Actions
    window.handleRequest = async (action) => {
        if(!currentReqDocId) return;
        els.popup.classList.remove('show');
        
        const ref = doc(db, `calls/${roomId}/requests`, currentReqDocId);
        if(action === 'accept') {
            await updateDoc(ref, { status: 'accepted' });
            sendSysMsg("Host accepted a guest!");
        } else {
            await updateDoc(ref, { status: 'declined' });
        }
        currentReqDocId = null;
    };

    // Viewer Logic
    function initViewerSignaling() {
        // Button Click
        els.reqBtn.onclick = async () => {
            els.reqBtn.classList.add('pending');
            // Create request
            const res = await addDoc(collection(db, `calls/${roomId}/requests`), {
                user: "Guest", status: 'pending', timestamp: Date.now()
            });
            
            // Listen for changes to MY request
            onSnapshot(doc(db, `calls/${roomId}/requests`, res.id), async (snap) => {
                const status = snap.data().status;
                if(status === 'accepted') {
                    els.reqBtn.style.display = 'none'; // Hide button
                    await startCoHost();
                } else if (status === 'declined') {
                    els.reqBtn.classList.remove('pending');
                    alert("Host declined your request.");
                }
            });
        };
    }

    // Viewer goes live
    async function startCoHost() {
        // 1. Get Media
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        
        // 2. Show locally
        els.vidStage.classList.add('split');
        els.vidGuest.srcObject = localStream;
        els.vidGuest.muted = true; // Mute self
        els.vidGuest.classList.add('mirror');

        // 3. Add to PC
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        // 4. Renegotiate (Hack for Single-File: Send new Offer)
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        // Host needs to know to renegotiate. In simple implementation, we just update the doc
        // In robust apps, we use a separate 'renegotiation' flag.
        // Here we just notify via chat, hoping the initial connection handles the new track.
        // Note: For perfect renegotiation, you usually need a separate "update" signal. 
        // This code relies on the PC state being open.
    }

    // --- 7. CHAT & UI ---
    function initChat() {
        const q = collection(db, `calls/${roomId}/messages`);
        const list = document.getElementById('chat-list');
        
        onSnapshot(q, (snap) => {
            list.innerHTML = '';
            let msgs = [];
            snap.forEach(d => msgs.push(d.data()));
            msgs.sort((a,b) => a.timestamp - b.timestamp);
            
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = m.type === 'sys' ? 'msg sys-msg' : 'msg';
                div.innerHTML = m.type === 'sys' ? `‚ú® ${m.text}` : `<b>${m.user}:</b> ${m.text}`;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });

        document.getElementById('send-btn').onclick = () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            addDoc(q, { user: isHost?"Host":"User", text:inp.value, timestamp:Date.now() });
            inp.value = '';
        };

        document.getElementById('heart-btn').onclick = () => {
            spawnHeart();
            addDoc(collection(db, `calls/${roomId}/hearts`), { t: Date.now() });
        };
        
        onSnapshot(collection(db, `calls/${roomId}/hearts`), (snap) => {
            snap.docChanges().forEach(c => {
                 if(c.type === 'added' && Date.now() - c.doc.data().t < 2000) spawnHeart();
            });
        });
    }

    function sendSysMsg(txt) {
        addDoc(collection(db, `calls/${roomId}/messages`), { type:'sys', text:txt, timestamp:Date.now() });
    }

    function spawnHeart() {
        const h = document.createElement('div');
        h.innerText = "‚ù§Ô∏è"; h.className = "floater";
        h.style.right = Math.random()*40 + "px";
        document.getElementById('hearts-canvas').appendChild(h);
        setTimeout(() => h.remove(), 2000);
    }
</script>
</body>
</html>
