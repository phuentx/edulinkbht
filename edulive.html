<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FireTok Final</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #FF3B5C;
            --dark: #000000;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--dark);
            color: white;
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden; /* Prevent scrolling */
            display: flex; justify-content: center;
        }

        /* Main Phone Container */
        #app-container {
            width: 100%; max-width: 480px; height: 100%;
            position: relative; background: #111;
        }

        /* --- VIDEO LAYER (Background) --- */
        #video-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            display: flex; flex-direction: column;
        }

        .video-slot {
            flex: 1; position: relative; overflow: hidden; background: #000;
            transition: height 0.3s ease;
        }

        /* Default: Host takes full height. Guest is hidden (height 0) */
        #host-slot { height: 100%; }
        #guest-slot { height: 0; border-top: 1px solid #333; display: none; }

        /* Split Mode: Both take 50% */
        .split-mode #host-slot { height: 50% !important; }
        .split-mode #guest-slot { height: 50% !important; display: block !important; }

        video {
            width: 100%; height: 100%; object-fit: cover;
            /* transform: scaleX(-1); Mirror effect only for local */
        }
        
        /* Mirror local video, but keep remote normal */
        .mirror { transform: scaleX(-1); }

        /* --- UI LAYER (Foreground) --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; /* Let clicks pass to video */
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Gradient to make text readable */
        .bottom-gradient {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            pointer-events: none; z-index: 1;
        }

        /* Top Header */
        .header {
            padding: 40px 15px 10px 15px; /* Extra top padding for iPhone Notch */
            display: flex; align-items: center; pointer-events: auto; z-index: 20;
        }
        .profile-pill {
            background: rgba(0, 0, 0, 0.4); padding: 4px 12px 4px 4px; border-radius: 20px;
            display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1);
        }
        .avatar { width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #FF3B5C, #ff9068); }
        .username { font-size: 13px; font-weight: 700; max-width: 100px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .live-badge { background: #FF3B5C; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        .close-btn { margin-left: auto; width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(10px); }

        /* Bottom Section (Chat + Controls) */
        .bottom-ui {
            padding: 15px; z-index: 20; position: relative;
            display: flex; flex-direction: column; gap: 10px;
        }

        /* Chat Container - Fixed Height so it doesn't push controls */
        .chat-container {
            height: 200px; 
            overflow-y: scroll; 
            display: flex; flex-direction: column; justify-content: flex-end;
            mask-image: linear-gradient(to top, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 80%, transparent 100%);
            margin-bottom: 5px; pointer-events: auto;
        }
        /* Hide Scrollbar */
        .chat-container::-webkit-scrollbar { display: none; }

        .msg {
            background: rgba(255,255,255,0.15); padding: 6px 10px; border-radius: 10px;
            font-size: 13px; margin-bottom: 6px; width: fit-content; max-width: 85%;
            backdrop-filter: blur(4px); text-shadow: 0 1px 1px rgba(0,0,0,0.5);
            animation: slideIn 0.2s ease-out;
        }
        .msg b { color: rgba(255,255,255,0.8); margin-right: 5px; }

        /* Controls Bar */
        .controls-bar {
            display: flex; align-items: center; gap: 10px; pointer-events: auto;
        }

        .chat-input {
            flex: 1; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 15px; border-radius: 30px; color: white; outline: none; font-size: 14px;
        }
        .chat-input::placeholder { color: #aaa; }

        .icon-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 20px;
            backdrop-filter: blur(5px); transition: transform 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); }
        .heart-btn { background: linear-gradient(45deg, #ff3b5c, #ff0055); box-shadow: 0 4px 12px rgba(255, 59, 92, 0.4); }
        .join-btn { background: #00f2ea; color: black; box-shadow: 0 4px 12px rgba(0, 242, 234, 0.3); }

        /* Setup Screen */
        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px;
        }
        .panel { background: #1a1a1a; padding: 25px; border-radius: 20px; width: 100%; text-align: center; border: 1px solid #333; }
        .input-field { width: 100%; padding: 15px; background: #222; border: 1px solid #333; border-radius: 12px; color: white; margin: 15px 0; outline: none; text-align: center; font-size: 16px; }
        .big-btn { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 12px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; }
        .mode-switch { display: flex; background: #222; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .mode-btn { flex: 1; padding: 10px; border: none; background: transparent; color: #777; font-weight: 600; cursor: pointer; border-radius: 8px; }
        .mode-btn.active { background: #333; color: white; }

        /* Floating Hearts */
        .hearts-container { position: absolute; bottom: 100px; right: 20px; width: 50px; height: 300px; pointer-events: none; z-index: 5; }
        .float-heart { position: absolute; bottom: 0; font-size: 30px; animation: floatUp 2s ease-out forwards; opacity: 0; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-300px) scale(1.2) rotate(20deg); opacity: 0; } }
        @keyframes slideIn { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .hidden { display: none !important; }
        
        /* Sound unmute overlay */
        #unmute-overlay {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px;
            font-size: 12px; z-index: 50; cursor: pointer; display: none;
        }
    </style>
</head>
<body>

<div id="app-container">

    <div id="video-layer">
        <div id="host-slot" class="video-slot">
            <video id="vid-host" autoplay playsinline class="mirror"></video> 
            </div>
        <div id="guest-slot" class="video-slot">
            <video id="vid-guest" autoplay playsinline class="mirror"></video>
        </div>
    </div>

    <div id="ui-layer" class="hidden">
        <div class="bottom-gradient"></div>

        <div id="unmute-overlay" onclick="enableAudio()">ðŸ”‡ Tap to Unmute</div>

        <div class="header">
            <div class="profile-pill">
                <div class="avatar"></div>
                <div>
                    <div class="username" id="display-name">@user</div>
                    <div style="font-size: 9px; opacity: 0.8;">2.4k watching</div>
                </div>
                <div class="live-badge" style="margin-left: 8px;">LIVE</div>
            </div>
            <div class="close-btn" onclick="location.reload()"><i class="fas fa-times"></i></div>
        </div>

        <div class="bottom-ui">
            <div class="chat-container" id="chat-list"></div>
            
            <div class="hearts-container" id="hearts-area"></div>

            <div class="controls-bar">
                <input type="text" class="chat-input" id="chat-input" placeholder="Say something..." autocomplete="off">
                
                <button class="icon-btn" id="send-btn"><i class="fas fa-arrow-up"></i></button>
                
                <button class="icon-btn join-btn" id="join-host-btn" style="display:none;">
                    <i class="fas fa-video"></i>
                </button>

                <button class="icon-btn heart-btn" id="like-btn"><i class="fas fa-heart"></i></button>
            </div>
        </div>
    </div>

    <div id="setup-screen">
        <h1 style="margin-bottom: 20px; font-weight: 900;">ðŸ”¥ FireTok</h1>
        <div class="panel">
            <div class="mode-switch">
                <button class="mode-btn active" id="tab-host" onclick="setMode('host')">Host</button>
                <button class="mode-btn" id="tab-viewer" onclick="setMode('viewer')">Viewer</button>
            </div>
            <input type="text" id="room-id" class="input-field" placeholder="Enter Room Name">
            <button class="big-btn" id="go-btn">Start Live</button>
        </div>
        <p style="margin-top: 20px; color: #555; font-size: 12px;">Sound Enabled â€¢ Mobile Optimized</p>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
        authDomain: "edulinki.firebaseapp.com",
        projectId: "edulinki",
        storageBucket: "edulinki.firebasestorage.app",
        messagingSenderId: "248886466474",
        appId: "1:248886466474:web:160043201a6b28bafbbdd3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Using OpenRelay for NAT Traversal
    const servers = {
        iceServers: [
            { urls: ['stun:stun1.l.google.com:19302'] },
            { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
            { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
        ]
    };

    // --- STATE ---
    let pc = null;
    let localStream = null;
    let roomId = null;
    let isHost = true;
    let isGuest = false;

    // DOM Elements
    const dom = {
        setup: document.getElementById('setup-screen'),
        ui: document.getElementById('ui-layer'),
        vidHost: document.getElementById('vid-host'),
        vidGuest: document.getElementById('vid-guest'),
        vidLayer: document.getElementById('video-layer'),
        joinBtn: document.getElementById('join-host-btn'),
        unmuteBtn: document.getElementById('unmute-overlay')
    };

    // --- MODE SWITCHING ---
    window.setMode = (mode) => {
        isHost = (mode === 'host');
        document.getElementById('tab-host').className = isHost ? 'mode-btn active' : 'mode-btn';
        document.getElementById('tab-viewer').className = !isHost ? 'mode-btn active' : 'mode-btn';
        document.getElementById('go-btn').innerText = isHost ? "Start Live" : "Join Live";
    };

    // --- START LOGIC ---
    document.getElementById('go-btn').onclick = async () => {
        roomId = document.getElementById('room-id').value.trim();
        if(!roomId) return alert("Enter Room Name");

        dom.setup.classList.add('hidden');
        dom.ui.classList.remove('hidden');
        document.getElementById('display-name').innerText = "@" + roomId;

        await initWebRTC();
        setupChat();
    };

    // --- WEBRTC ENGINE ---
    async function initWebRTC() {
        pc = new RTCPeerConnection(servers);

        // 1. Host Logic
        if(isHost) {
            // Host gets audio/video immediately
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            
            // Host sees themselves in Top Slot
            dom.vidHost.srcObject = localStream;
            dom.vidHost.muted = true; // Mute self to avoid echo
            dom.vidHost.classList.add('mirror');

            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            
            dom.joinBtn.style.display = 'none'; // Host doesn't need join button
        } 
        // 2. Viewer Logic
        else {
            dom.joinBtn.style.display = 'flex'; // Viewer sees join button
            // Attempt to unmute remote video after interaction
            dom.unmuteBtn.style.display = 'block';
        }

        // 3. Handle Incoming Tracks (Audio/Video from other person)
        pc.ontrack = (event) => {
            const stream = event.streams[0];
            
            if(isHost) {
                // Host receiving Guest stream -> Put in Bottom Slot
                dom.vidLayer.classList.add('split-mode');
                dom.vidGuest.srcObject = stream;
                dom.vidGuest.muted = false; // Hear the guest!
            } else {
                // Viewer receiving Host stream
                if(!dom.vidHost.srcObject) {
                    // First stream is Host -> Top Slot
                    dom.vidHost.srcObject = stream;
                    dom.vidHost.muted = false; // IMPORTANT: Hear the host!
                    dom.vidHost.classList.remove('mirror'); // Don't mirror host
                } else {
                    // Second stream is Guest (or self loopback)
                    // If I am the guest, this is my loopback, mute it
                    if(isGuest) {
                        // Ignore echo
                    } else {
                        // I am a viewer watching a Host+Guest stream
                        dom.vidLayer.classList.add('split-mode');
                        dom.vidGuest.srcObject = stream;
                        dom.vidGuest.muted = false;
                    }
                }
            }
        };

        // 4. Firestore Signaling
        const callDoc = doc(db, "calls", roomId);
        const offerCandidates = collection(callDoc, "offerCandidates");
        const answerCandidates = collection(callDoc, "answerCandidates");

        if (isHost) {
            await setDoc(callDoc, { type: 'ready' }); // Reset
            pc.onicecandidate = e => e.candidate && addDoc(offerCandidates, e.candidate.toJSON());
            
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await setDoc(callDoc, { offer: { sdp: offer.sdp, type: offer.type } });

            onSnapshot(callDoc, async (snap) => {
                const data = snap.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
            });
            
            onSnapshot(answerCandidates, snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });

        } else {
            // Viewer Join
            pc.onicecandidate = e => e.candidate && addDoc(answerCandidates, e.candidate.toJSON());

            const snap = await getDoc(callDoc);
            if (!snap.exists()) return alert("Room not found");

            await pc.setRemoteDescription(new RTCSessionDescription(snap.data().offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await updateDoc(callDoc, { answer: { sdp: answer.sdp, type: answer.type } });

            onSnapshot(offerCandidates, snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                });
            });
        }
    }

    // --- CO-HOST (PULL) FEATURE ---
    dom.joinBtn.onclick = async () => {
        if(isHost) return;
        isGuest = true;
        dom.joinBtn.style.display = 'none';

        // 1. Get Camera
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        
        // 2. Show self in bottom slot immediately
        dom.vidLayer.classList.add('split-mode');
        dom.vidGuest.srcObject = localStream;
        dom.vidGuest.muted = true; // Mute self
        dom.vidGuest.classList.add('mirror');

        // 3. Add to PC
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

        // 4. Simple Renegotiate (Viewer sends new offer)
        // This is a hacky way to add tracks mid-call in a single file without perfect signaling state machine
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        // We notify via chat because full renegotiation requires watching "offer" on both sides bi-directionally
        addDoc(collection(db, `calls/${roomId}/messages`), { user: "System", text: "Guest Joining...", timestamp: Date.now() });
    };

    // --- AUDIO HELPER ---
    window.enableAudio = () => {
        dom.vidHost.muted = false;
        dom.vidGuest.muted = false;
        dom.unmuteBtn.style.display = 'none';
        // Play creates a promise, catch errors if autoplay blocked
        dom.vidHost.play().catch(e => console.log(e));
    };

    // --- CHAT & HEARTS ---
    function setupChat() {
        const q = collection(db, `calls/${roomId}/messages`);
        const chatList = document.getElementById('chat-list');
        
        onSnapshot(q, (snapshot) => {
            chatList.innerHTML = '';
            let msgs = [];
            snapshot.forEach(doc => msgs.push(doc.data()));
            msgs.sort((a,b) => a.timestamp - b.timestamp);
            msgs.forEach(msg => {
                const div = document.createElement('div');
                div.className = 'msg';
                div.innerHTML = `<b>${msg.user}:</b> ${msg.text}`;
                chatList.appendChild(div);
            });
            chatList.scrollTop = chatList.scrollHeight;
        });

        document.getElementById('send-btn').onclick = () => {
            const inp = document.getElementById('chat-input');
            if(!inp.value) return;
            addDoc(q, { user: isHost ? "Host" : "User", text: inp.value, timestamp: Date.now() });
            inp.value = '';
        };

        document.getElementById('like-btn').onclick = () => {
            addDoc(collection(db, `calls/${roomId}/hearts`), { t: Date.now() });
            spawnHeart();
        };

        onSnapshot(collection(db, `calls/${roomId}/hearts`), (snap) => {
            snap.docChanges().forEach(c => {
                if(c.type === 'added' && Date.now() - c.doc.data().t < 2000) spawnHeart();
            });
        });
    }

    function spawnHeart() {
        const h = document.createElement('div');
        h.innerText = "â¤ï¸"; h.className = "float-heart";
        h.style.right = Math.random() * 40 + "px";
        document.getElementById('hearts-area').appendChild(h);
        setTimeout(() => h.remove(), 2000);
    }

</script>
</body>
</html>
