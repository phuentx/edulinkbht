<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edulinki Meet</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #202124;
            --surface-color: #3c4043;
            --primary-blue: #8ab4f8;
            --primary-blue-hover: #aecbfa;
            --danger-red: #ea4335;
            --danger-red-hover: #f28b82;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --btn-green: #00796b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
        }

        .logo {
            font-size: 22px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo span { color: var(--text-secondary); font-size: 18px; }

        .time-display {
            font-family: 'Roboto', sans-serif;
            color: var(--text-secondary);
            font-size: 18px;
        }

        /* --- Lobby Screen (Entry) --- */
        .lobby-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            transition: opacity 0.3s ease;
        }

        .lobby-card {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .hero-text h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 400;
        }
        .hero-text p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.5;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .meet-input {
            background: transparent;
            border: 1px solid var(--text-secondary);
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 16px;
            outline: none;
            flex: 1;
            min-width: 200px;
            transition: border-color 0.2s;
        }

        .meet-input:focus {
            border-color: var(--primary-blue);
            border-width: 2px;
            padding: 11px 15px; /* adjust for border width */
        }

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: #202124;
        }
        .btn-primary:hover { background: var(--primary-blue-hover); }
        .btn-primary:disabled { background: #5f6368; cursor: not-allowed; color: #3c4043; }

        .btn-text {
            background: transparent;
            color: var(--primary-blue);
        }
        .btn-text:hover { background: rgba(138, 180, 248, 0.08); }

        /* --- Meeting Screen (Video Grid) --- */
        .meeting-container {
            display: none; /* Hidden by default */
            flex: 1;
            padding: 20px;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            position: relative;
        }

        .video-grid {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            height: 100%;
            width: 100%;
            flex-wrap: wrap;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            flex: 1;
            min-width: 300px;
            max-width: 900px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* When only one person (local), make it smaller or centered */
        .video-wrapper.waiting {
            max-width: 600px; 
            max-height: 400px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect for self */
        }
        
        #remoteVideo { transform: scaleX(1); /* Don't mirror remote */ }

        .user-label {
            position: absolute;
            bottom: 15px;
            left: 15px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            text-shadow: 0 1px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* --- Status Toast --- */
        .status-toast {
            position: absolute;
            bottom: 100px;
            left: 20px;
            background: #323232;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 500;
        }
        .status-toast.visible { opacity: 1; }

        /* --- Bottom Controls --- */
        .controls-bar {
            display: none; /* Hidden in lobby */
            height: 80px;
            background: #202124;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding-bottom: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid transparent;
            background: #3c4043;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .control-btn:hover { background: #474a4f; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .control-btn.active { background: #8ab4f8; color: #202124; }
        
        .control-btn.hangup { background: var(--danger-red); width: 60px; }
        .control-btn.hangup:hover { background: var(--danger-red-hover); }

        /* --- Responsive Tweaks --- */
        @media (max-width: 768px) {
            .lobby-card { padding: 0 20px; }
            .hero-text h1 { font-size: 1.8rem; }
            .video-grid { flex-direction: column; }
            .video-wrapper { width: 100%; aspect-ratio: 4/3; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <span class="material-icons-round" style="color:var(--btn-green); font-size: 28px;">video_camera_front</span>
            Edulinki Meet
        </div>
        <div class="time-display" id="clock">10:35 PM</div>
    </header>

    <main class="lobby-container" id="lobbyScreen">
        <div class="lobby-card">
            <div class="hero-text">
                <h1>Premium video meetings. Now free for everyone.</h1>
                <p>We re-engineered the service for secure, high-quality business meetings.</p>
            </div>
            
            <div class="input-group">
                <input type="text" id="callInput" class="meet-input" placeholder="Enter meeting code" autocomplete="off">
                <button id="createBtn" class="btn btn-text">New Meeting</button>
            </div>
            
            <div class="input-group">
                <button id="joinBtn" class="btn btn-primary" disabled>
                    <span class="material-icons-round">login</span> Join
                </button>
            </div>
        </div>
    </main>

    <main class="meeting-container" id="meetingScreen">
        <div class="video-grid" id="videoGrid">
            <div class="video-wrapper waiting" id="localWrapper">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="user-label">You</div>
            </div>
            <div class="video-wrapper" id="remoteWrapper" style="display:none;">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="user-label">Remote User</div>
            </div>
        </div>
        
        <div class="status-toast" id="statusToast">
            <span class="material-icons-round" style="font-size:18px;">info</span>
            <span id="statusText">Ready to connect...</span>
        </div>
    </main>

    <footer class="controls-bar" id="controlsBar">
        <button class="control-btn"><span class="material-icons-round">mic</span></button>
        <button class="control-btn"><span class="material-icons-round">videocam</span></button>
        
        <button id="hangupBtn" class="control-btn hangup">
            <span class="material-icons-round">call_end</span>
        </button>
        
        <button class="control-btn"><span class="material-icons-round">present_to_all</span></button>
        <button class="control-btn"><span class="material-icons-round">more_vert</span></button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- UI Updates: Clock ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- Firebase Config (YOURS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        // --- WebRTC Setup ---
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                { urls: ['stun:stun3.l.google.com:19302', 'stun:stun4.l.google.com:19302'] },
                { urls: ['stun:global.stun.twilio.com:3478'] } 
            ],
            iceCandidatePoolSize: 10,
        };

        let pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;
        let candidateQueue = [];

        // --- DOM Elements ---
        const lobbyScreen = document.getElementById('lobbyScreen');
        const meetingScreen = document.getElementById('meetingScreen');
        const controlsBar = document.getElementById('controlsBar');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const localWrapper = document.getElementById('localWrapper');
        const remoteWrapper = document.getElementById('remoteWrapper');
        const callInput = document.getElementById('callInput');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const statusToast = document.getElementById('statusToast');
        const statusText = document.getElementById('statusText');

        // Toggle Join Button based on input
        callInput.addEventListener('input', (e) => {
            if(e.target.value.trim().length > 0) {
                joinBtn.disabled = false;
                joinBtn.classList.replace('btn-text', 'btn-primary');
            } else {
                joinBtn.disabled = true;
            }
        });

        // Function to show Status Toast
        function showStatus(msg) {
            console.log(msg);
            statusText.innerText = msg;
            statusToast.classList.add('visible');
            setTimeout(() => statusToast.classList.remove('visible'), 3000);
        }

        // Function to switch to Meeting UI
        function switchToMeetingUI() {
            lobbyScreen.style.display = 'none';
            meetingScreen.style.display = 'flex';
            controlsBar.style.display = 'flex';
        }

        // 1. SETUP MEDIA
        async function startMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                
                remoteStream = new MediaStream();
                pc.ontrack = (event) => {
                    console.log("ðŸŽ¥ Video track received");
                    event.streams[0].getTracks().forEach((track) => remoteStream.addTrack(track));
                    remoteVideo.srcObject = remoteStream;
                    
                    // Show Remote Video Wrapper when stream arrives
                    remoteWrapper.style.display = 'flex';
                    // Adjust grid layout
                    localWrapper.classList.remove('waiting');
                };

                localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
                switchToMeetingUI(); // Move to video screen
                return true;
            } catch (e) {
                alert("Could not get Camera. Please allow permissions.");
                return false;
            }
        }

        // 2. MONITOR CONNECTION
        pc.onconnectionstatechange = () => {
            showStatus(`Status: ${pc.connectionState}`);
            if (pc.connectionState === 'failed') pc.restartIce();
        };

        // 3. ICE CANDIDATE QUEUE
        async function handleRemoteCandidate(candidateData) {
            if (!candidateData) return;
            const candidate = new RTCIceCandidate(candidateData);
            if (pc.remoteDescription && pc.remoteDescription.type) {
                try { await pc.addIceCandidate(candidate); } catch (e) { console.error(e); }
            } else {
                candidateQueue.push(candidate);
            }
        }

        async function processCandidateQueue() {
            for (const candidate of candidateQueue) {
                try { await pc.addIceCandidate(candidate); } catch (e) { console.error(e); }
            }
            candidateQueue = [];
        }

        // --- CREATE CALL ---
        createBtn.onclick = async () => {
            const callId = callInput.value.trim() || Math.random().toString(36).substring(2, 7); // Generate ID if empty
            callInput.value = callId; // Show ID to user
            
            if(!await startMedia()) return;
            
            showStatus(`Creating room: ${callId}...`);

            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(offerCandidates, event.candidate.toJSON());
            };

            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);
            
            const offer = { sdp: offerDescription.sdp, type: offerDescription.type };
            await setDoc(callDoc, { offer });
            
            showStatus(`Room created! Share code: ${callId}`);

            onSnapshot(callDoc, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    const answerDescription = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answerDescription);
                    processCandidateQueue();
                }
            });

            onSnapshot(answerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };

        // --- JOIN CALL ---
        joinBtn.onclick = async () => {
            const callId = callInput.value.trim();
            if(!callId) { alert("Please enter a room code"); return; }
            if(!await startMedia()) return;

            showStatus(`Joining room: ${callId}...`);

            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(answerCandidates, event.candidate.toJSON());
            };

            const snapshot = await getDoc(callDoc);
            const callData = snapshot.data();

            if (!callData) {
                alert("Room not found!");
                window.location.reload();
                return;
            }

            await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            
            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);

            const answer = { type: answerDescription.type, sdp: answerDescription.sdp };
            await updateDoc(callDoc, { answer });
            
            processCandidateQueue();

            onSnapshot(offerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };

        hangupBtn.onclick = () => window.location.reload();
    </script>
</body>
</html>
