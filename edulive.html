<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Meet</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #202124;
            --surface-color: #3c4043;
            --primary-blue: #8ab4f8;
            --danger-red: #ea4335;
            --text-primary: #e8eaed;
            --btn-active: #8ab4f8;
            --btn-active-text: #202124;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Google Sans', 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100dvh; /* Dynamic Height for Mobile */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(32, 33, 36, 0.9);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 100;
            height: 60px;
        }

        .logo {
            font-size: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-display {
            font-family: 'Roboto', sans-serif;
            color: #bdc1c6;
            font-size: 16px;
        }

        /* --- Lobby Screen --- */
        .lobby-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-top: 60px; /* Space for header */
        }

        .lobby-card {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .meet-input {
            background: transparent;
            border: 1px solid #5f6368;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            outline: none;
        }

        .meet-input:focus { border-color: var(--primary-blue); border-width: 2px; padding: 11px; }

        .btn {
            border: none;
            padding: 12px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }

        .btn-primary { background: var(--primary-blue); color: #202124; }
        .btn-primary:disabled { background: #3c4043; color: #777; cursor: not-allowed; }
        .btn-secondary { background: transparent; color: var(--primary-blue); border: 1px solid #5f6368; margin-top: 10px;}

        /* --- Meeting Screen --- */
        .meeting-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100dvh;
            padding-top: 60px; /* Header space */
            padding-bottom: 90px; /* Footer space */
            background: #202124;
        }

        .video-grid {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
            flex-wrap: wrap;
            overflow-y: auto;
        }

        .video-wrapper {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            flex: 1;
            min-width: 45%;
            max-width: 100%;
            aspect-ratio: 16/9; /* Maintain ratio */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        /* Mobile Portrait Optimization */
        @media (max-width: 600px) {
            .video-grid { flex-direction: column; }
            .video-wrapper { width: 100%; min-height: 200px; }
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Mirror local video unless sharing screen */
        #localVideo.mirrored { transform: scaleX(-1); }

        .user-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            background: rgba(0,0,0,0.5);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* --- Footer Controls --- */
        .controls-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: #202124;
            align-items: center;
            justify-content: center;
            gap: 15px;
            /* Safe area for iPhone home bar */
            padding-bottom: env(safe-area-inset-bottom); 
            z-index: 200;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: #3c4043;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .control-btn span { font-size: 24px; }
        
        /* State: Active/Off */
        .control-btn.off { background: var(--danger-red); }
        .control-btn.hangup { background: var(--danger-red); width: 65px; border-radius: 30px; }

        /* Status Toast */
        .status-toast {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #323232;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 500;
        }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <span class="material-icons-round" style="color:#00796b;">video_camera_front</span>
            <span>Meet</span>
        </div>
        <div class="time-display" id="clock">10:00</div>
    </header>

    <main class="lobby-container" id="lobbyScreen">
        <div class="lobby-card">
            <h2 style="font-weight: 400; margin-bottom: 10px;">Join a Meeting</h2>
            <input type="text" id="callInput" class="meet-input" placeholder="Enter code (e.g. abc-def)" autocomplete="off">
            
            <button id="joinBtn" class="btn btn-primary" disabled>Join</button>
            <div style="color: #5f6368; font-size: 14px;">or</div>
            <button id="createBtn" class="btn btn-secondary">Create New Meeting</button>
        </div>
    </main>

    <main class="meeting-container" id="meetingScreen">
        <div class="video-grid" id="videoGrid">
            <div class="video-wrapper">
                <video id="localVideo" autoplay playsinline muted class="mirrored"></video>
                <div class="user-label">You</div>
            </div>
            <div class="video-wrapper" id="remoteWrapper" style="display:none;">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="user-label">Them</div>
            </div>
        </div>
        <div class="status-toast" id="statusToast">Status message...</div>
    </main>

    <footer class="controls-bar" id="controlsBar">
        <button id="micBtn" class="control-btn"><span class="material-icons-round">mic</span></button>
        <button id="camBtn" class="control-btn"><span class="material-icons-round">videocam</span></button>
        <button id="screenBtn" class="control-btn"><span class="material-icons-round">present_to_all</span></button>
        <button id="hangupBtn" class="control-btn hangup"><span class="material-icons-round">call_end</span></button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Clock ---
        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);

        // --- WebRTC Globals ---
        const servers = {
            iceServers: [
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }
            ],
            iceCandidatePoolSize: 10,
        };

        let pc = new RTCPeerConnection(servers);
        let localStream = null;
        let remoteStream = null;
        let screenStream = null;
        let candidateQueue = [];

        // --- Elements ---
        const lobbyScreen = document.getElementById('lobbyScreen');
        const meetingScreen = document.getElementById('meetingScreen');
        const controlsBar = document.getElementById('controlsBar');
        
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const remoteWrapper = document.getElementById('remoteWrapper');
        
        const micBtn = document.getElementById('micBtn');
        const camBtn = document.getElementById('camBtn');
        const screenBtn = document.getElementById('screenBtn');
        const hangupBtn = document.getElementById('hangupBtn');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const callInput = document.getElementById('callInput');

        // --- UI Logic ---
        callInput.oninput = (e) => {
            joinBtn.disabled = e.target.value.trim().length === 0;
        };

        function showStatus(msg) {
            const toast = document.getElementById('statusToast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        function enterMeetingUI() {
            lobbyScreen.style.display = 'none';
            meetingScreen.style.display = 'flex';
            controlsBar.style.display = 'flex';
        }

        // --- Media Setup ---
        async function startMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                remoteStream = new MediaStream();
                pc.ontrack = (event) => {
                    event.streams[0].getTracks().forEach((track) => remoteStream.addTrack(track));
                    remoteVideo.srcObject = remoteStream;
                    remoteWrapper.style.display = 'flex';
                };

                localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));
                enterMeetingUI();
                return true;
            } catch (e) {
                alert("Please allow camera/mic access!");
                return false;
            }
        }

        // --- Controls Logic ---
        
        // MUTE AUDIO
        micBtn.onclick = () => {
            const audioTrack = localStream.getAudioTracks()[0];
            if(audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                micBtn.classList.toggle('off');
                micBtn.innerHTML = audioTrack.enabled 
                    ? '<span class="material-icons-round">mic</span>' 
                    : '<span class="material-icons-round">mic_off</span>';
            }
        };

        // DISABLE CAMERA
        camBtn.onclick = () => {
            const videoTrack = localStream.getVideoTracks()[0];
            if(videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                camBtn.classList.toggle('off');
                camBtn.innerHTML = videoTrack.enabled 
                    ? '<span class="material-icons-round">videocam</span>' 
                    : '<span class="material-icons-round">videocam_off</span>';
            }
        };

        // SCREEN SHARE
        screenBtn.onclick = async () => {
            if (!screenStream) {
                try {
                    // 1. Get Screen Stream
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const screenTrack = screenStream.getVideoTracks()[0];

                    // 2. Replace Video Track in Sender
                    const sender = pc.getSenders().find(s => s.track.kind === 'video');
                    if (sender) sender.replaceTrack(screenTrack);

                    // 3. Show Screen on Local Video (Remove Mirroring)
                    localVideo.srcObject = screenStream;
                    localVideo.classList.remove('mirrored');
                    screenBtn.style.color = '#8ab4f8'; // active color

                    // 4. Handle Stop Sharing (via browser UI)
                    screenTrack.onended = () => {
                        stopScreenShare(sender);
                    };

                } catch (e) { console.error("Screen share failed", e); }
            } else {
                // User clicked button to stop
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                stopScreenShare(sender);
            }
        };

        function stopScreenShare(sender) {
            // Revert to Camera
            const cameraTrack = localStream.getVideoTracks()[0];
            if (sender) sender.replaceTrack(cameraTrack);
            
            localVideo.srcObject = localStream;
            localVideo.classList.add('mirrored');
            
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            screenBtn.style.color = 'white';
        }

        hangupBtn.onclick = () => window.location.reload();

        // --- WebRTC Signaling (Existing Logic) ---
        // ICE Queue
        async function handleRemoteCandidate(candidateData) {
            if (!candidateData) return;
            const candidate = new RTCIceCandidate(candidateData);
            if (pc.remoteDescription) {
                await pc.addIceCandidate(candidate);
            } else {
                candidateQueue.push(candidate);
            }
        }
        async function processQueue() {
            candidateQueue.forEach(async c => await pc.addIceCandidate(c));
            candidateQueue = [];
        }

        // CREATE
        createBtn.onclick = async () => {
            const callId = Math.random().toString(36).substring(2, 7);
            callInput.value = callId;
            if(!await startMedia()) return;

            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(offerCandidates, event.candidate.toJSON());
            };

            const offerDescription = await pc.createOffer();
            await pc.setLocalDescription(offerDescription);
            await setDoc(callDoc, { offer: { sdp: offerDescription.sdp, type: offerDescription.type }});

            showStatus(`Room created: ${callId}`);

            onSnapshot(callDoc, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    processQueue();
                }
            });
            onSnapshot(answerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };

        // JOIN
        joinBtn.onclick = async () => {
            const callId = callInput.value.trim();
            if(!callId || !await startMedia()) return;

            const callDoc = doc(collection(firestore, 'calls'), callId);
            const offerCandidates = collection(callDoc, 'offerCandidates');
            const answerCandidates = collection(callDoc, 'answerCandidates');

            pc.onicecandidate = (event) => {
                event.candidate && addDoc(answerCandidates, event.candidate.toJSON());
            };

            const snapshot = await getDoc(callDoc);
            if (!snapshot.exists()) { alert("Room not found"); return; }
            
            await pc.setRemoteDescription(new RTCSessionDescription(snapshot.data().offer));
            const answerDescription = await pc.createAnswer();
            await pc.setLocalDescription(answerDescription);
            await updateDoc(callDoc, { answer: { type: answerDescription.type, sdp: answerDescription.sdp }});
            processQueue();

            onSnapshot(offerCandidates, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') handleRemoteCandidate(change.doc.data());
                });
            });
        };
    </script>
</body>
</html>
