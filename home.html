<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLink - Workspace</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              brand: { accent: '#2383E2', bg: '#F7F7F5', text: '#37352F', border: '#E0E0E0' }
            }
          }
        }
      }
    </script>
    <style>
        body { background-color: #F7F7F5; color: #37352F; height: 100vh; overflow: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass-panel { background: rgba(255,255,255,0.8); backdrop-filter: blur(12px); border: 1px solid #E5E7EB; }
    </style>
</head>
<body class="flex">

    <!-- Sidebar -->
    <div class="w-64 bg-brand-bg border-r border-brand-border flex flex-col h-full flex-shrink-0">
        <!-- User Profile -->
        <div class="p-4 border-b border-brand-border flex items-center gap-3">
            <img id="user-avatar" src="" class="w-8 h-8 rounded-md bg-gray-200 object-cover">
            <div class="flex-1 min-w-0">
                <div id="user-name" class="text-sm font-semibold truncate">Loading...</div>
                <button id="btn-logout" class="text-xs text-red-500 hover:underline">Sign Out</button>
            </div>
        </div>

        <!-- Projects List -->
        <div class="flex-1 overflow-y-auto p-2 scrollbar-hide">
            <div class="text-xs font-semibold text-gray-500 px-2 mb-2 uppercase tracking-wider">My Projects</div>
            <div id="project-list" class="flex flex-col gap-0.5">
                <!-- Projects injected here -->
            </div>
            
            <button id="btn-create-project" class="mt-4 w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded-md transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                New Project
            </button>
        </div>
    </div>

    <!-- Main Workspace -->
    <div class="flex-1 flex flex-col h-full bg-white relative">
        <!-- Empty State -->
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-10 bg-white">
            <img src="https://i.imghippo.com/files/vgr8207c.png" class="w-16 h-16 mb-4 opacity-50 grayscale">
            <h2 class="text-xl font-semibold text-gray-700">Select or Create a Project</h2>
            <p class="text-gray-500 mt-2">Collaborate with your team in real-time.</p>
        </div>

        <!-- Project Editor (Hidden initially) -->
        <div id="editor-container" class="flex flex-col h-full hidden">
            <!-- Header -->
            <div class="h-14 border-b border-brand-border flex items-center justify-between px-6 bg-white">
                <div class="flex items-center gap-2 flex-1">
                    <span class="text-xl">üìÑ</span>
                    <input id="doc-title" type="text" class="text-lg font-semibold outline-none bg-transparent hover:bg-gray-50 px-2 rounded w-full max-w-md" placeholder="Untitled Project">
                    <span id="save-status" class="text-xs text-gray-400 ml-2">Saved</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex -space-x-2 overflow-hidden" id="member-avatars">
                        <!-- Avatars -->
                    </div>
                    <button id="btn-share" class="px-3 py-1.5 bg-brand-accent text-white text-sm rounded-md font-medium hover:bg-blue-600 transition shadow-sm flex items-center gap-2">
                        Share <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14L21 3"/></svg>
                    </button>
                </div>
            </div>

            <div class="flex flex-1 overflow-hidden">
                <!-- Document Area -->
                <div class="flex-1 overflow-y-auto p-8 bg-white cursor-text" onclick="document.getElementById('doc-content').focus()">
                    <textarea id="doc-content" class="w-full h-full resize-none outline-none text-gray-800 leading-relaxed text-base font-sans" placeholder="Start typing your project content..."></textarea>
                </div>

                <!-- Chat Panel -->
                <div class="w-80 border-l border-brand-border flex flex-col bg-gray-50">
                    <div class="p-3 border-b border-brand-border text-xs font-semibold uppercase text-gray-500 bg-gray-50">Team Chat</div>
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3">
                        <!-- Messages -->
                    </div>
                    <form id="chat-form" class="p-3 border-t border-brand-border bg-white flex gap-2">
                        <input id="chat-input" type="text" class="flex-1 text-sm p-2 border border-gray-200 rounded-md outline-none focus:border-brand-accent" placeholder="Type a message...">
                        <button type="submit" class="p-2 bg-brand-text text-white rounded-md hover:bg-black">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-96 border border-gray-200 animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-lg font-bold mb-4">Share Project</h3>
            <p class="text-sm text-gray-500 mb-4">Add people to this project by email.</p>
            <input id="share-email" type="email" placeholder="colleague@example.com" class="w-full p-2 border border-gray-300 rounded-md mb-4 text-sm outline-none focus:border-brand-accent">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('share-modal').classList.add('hidden')" class="px-3 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md">Cancel</button>
                <button id="btn-confirm-share" class="px-3 py-2 text-sm bg-brand-accent text-white rounded-md hover:bg-blue-600">Invite</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, arrayUnion, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
        authDomain: "edulinki.firebaseapp.com",
        projectId: "edulinki",
        storageBucket: "edulinki.firebasestorage.app",
        messagingSenderId: "248886466474",
        appId: "1:248886466474:web:160043201a6b28bafbbdd3",
        measurementId: "G-MQBH12VL7N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentProjectId = null;
    let unsubscribeDoc = null;
    let unsubscribeChat = null;
    let isTyping = false; // Simple lock to prevent overwriting while typing

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = 'index.html';
        } else {
            currentUser = user;
            document.getElementById('user-name').textContent = user.displayName || user.email;
            document.getElementById('user-avatar').src = user.photoURL || `https://api.dicebear.com/9.x/initials/svg?seed=${user.email}`;
            loadProjects();
        }
    });

    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // --- SIDEBAR PROJECTS ---
    function loadProjects() {
        const q = query(collection(db, "projects"), where("members", "array-contains", currentUser.email));
        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const isActive = doc.id === currentProjectId;
                const div = document.createElement('div');
                div.className = `px-3 py-2 rounded-md cursor-pointer text-sm flex items-center gap-2 ${isActive ? 'bg-white shadow-sm font-medium text-black' : 'text-gray-600 hover:bg-gray-200'}`;
                div.innerHTML = `<span class="text-base">${isActive ? 'üìÇ' : 'üìÅ'}</span> ${data.title}`;
                div.onclick = () => selectProject(doc.id);
                list.appendChild(div);
            });
        });
    }

    document.getElementById('btn-create-project').addEventListener('click', async () => {
        const title = prompt("Enter project title:");
        if (!title) return;
        try {
            const docRef = await addDoc(collection(db, "projects"), {
                title: title,
                content: "",
                ownerId: currentUser.uid,
                members: [currentUser.email],
                createdAt: serverTimestamp()
            });
            selectProject(docRef.id);
        } catch(e) { alert("Error creating project: " + e.message); }
    });

    // --- PROJECT LOGIC ---
    function selectProject(projectId) {
        if (currentProjectId === projectId) return;
        currentProjectId = projectId;
        
        // UI Update
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('editor-container').classList.remove('hidden');
        loadProjects(); // Refresh active state in sidebar

        // Cleanup previous listeners
        if (unsubscribeDoc) unsubscribeDoc();
        if (unsubscribeChat) unsubscribeChat();

        const docRef = doc(db, "projects", projectId);
        
        // Listen to Document
        unsubscribeDoc = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Update Title
                document.getElementById('doc-title').value = data.title;
                
                // Update Content (only if not currently typing to avoid conflicts)
                // A better approach for real apps is Operational Transformation, but for this demo:
                // We update if the document element is not focused OR if the length difference is significant (remote paste)
                const docEl = document.getElementById('doc-content');
                if (document.activeElement !== docEl) {
                     docEl.value = data.content || "";
                }

                // Update Members
                const avatarContainer = document.getElementById('member-avatars');
                avatarContainer.innerHTML = '';
                data.members.forEach(email => {
                    const img = document.createElement('img');
                    img.src = `https://api.dicebear.com/9.x/initials/svg?seed=${email}`;
                    img.className = "w-6 h-6 rounded-full border border-white bg-gray-200";
                    img.title = email;
                    avatarContainer.appendChild(img);
                });
            }
        });

        // Listen to Chat
        const chatQ = query(collection(db, `projects/${projectId}/messages`), orderBy("timestamp", "asc"));
        unsubscribeChat = onSnapshot(chatQ, (snapshot) => {
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = '';
            snapshot.forEach(doc => {
                const msg = doc.data();
                const isMe = msg.senderId === currentUser.uid;
                const div = document.createElement('div');
                div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-2 mb-1">
                        ${!isMe ? `<span class="text-[10px] text-gray-500">${msg.senderName}</span>` : ''}
                    </div>
                    <div class="px-3 py-2 rounded-lg text-sm max-w-[90%] ${isMe ? 'bg-brand-text text-white rounded-br-none' : 'bg-white border border-gray-200 rounded-bl-none text-gray-700 shadow-sm'}">
                        ${msg.text}
                    </div>
                `;
                chatBox.appendChild(div);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    // --- EDITOR SYNC ---
    const titleInput = document.getElementById('doc-title');
    const contentInput = document.getElementById('doc-content');
    const saveStatus = document.getElementById('save-status');
    let debounceTimer;

    function saveChanges() {
        saveStatus.textContent = "Saving...";
        if (!currentProjectId) return;
        
        const docRef = doc(db, "projects", currentProjectId);
        updateDoc(docRef, {
            title: titleInput.value,
            content: contentInput.value,
            lastModified: serverTimestamp()
        }).then(() => {
            saveStatus.textContent = "Saved";
        });
    }

    // Debounce saves
    [titleInput, contentInput].forEach(el => {
        el.addEventListener('input', () => {
            saveStatus.textContent = "Unsaved changes...";
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(saveChanges, 1000);
        });
    });

    // --- CHAT SEND ---
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text || !currentProjectId) return;

        input.value = '';
        await addDoc(collection(db, `projects/${currentProjectId}/messages`), {
            text: text,
            senderId: currentUser.uid,
            senderName: currentUser.displayName || currentUser.email.split('@')[0],
            timestamp: serverTimestamp()
        });
    });

    // --- SHARE FEATURE ---
    const shareModal = document.getElementById('share-modal');
    document.getElementById('btn-share').addEventListener('click', () => shareModal.classList.remove('hidden'));
    
    document.getElementById('btn-confirm-share').addEventListener('click', async () => {
        const email = document.getElementById('share-email').value;
        if (!email || !currentProjectId) return;

        const docRef = doc(db, "projects", currentProjectId);
        try {
            await updateDoc(docRef, {
                members: arrayUnion(email)
            });
            alert(`Invited ${email}`);
            shareModal.classList.add('hidden');
        } catch (e) { alert("Error: " + e.message); }
    });

</script>
</body>
</html>
