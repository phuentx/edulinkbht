<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>EduLink</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
<script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

:root {
--surface: #ffffff;
--background: #f9fafb;
--on-surface: #1f1f1f;
--text-secondary: #667085;
--outline: #eaecf0;
--hover-bg: #f3f4f6;
--primary: #0b57d0;
}

body {
font-family: 'Inter', sans-serif;
background-color: var(--background);
color: var(--on-surface);
overflow: hidden;
}

h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }

/* No Scrollbars */
* { scrollbar-width: none; -ms-overflow-style: none; }
*::-webkit-scrollbar { width: 0px; background: transparent; display: none; }

/* Prevent icon squishing globally */
i[data-lucide], svg { flex-shrink: 0; }

.fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

/* --- UNIFIED PANEL STYLES --- */
.app-panel {
background: var(--surface);
border-radius: 20px;
border: 1px solid var(--outline);
height: 100%;
display: flex;
flex-direction: column;
overflow: hidden;
box-shadow: 0 1px 2px rgba(0,0,0,0.03);
transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
}

/* Mobile Adjustments */
@media (max-width: 768px) {
.app-panel {
border-radius: 0 !important;
border: none !important;
box-shadow: none !important;
}
body {
padding: 0 !important;
}
#workspace-layout {
gap: 0 !important;
}
}

/* --- SIDEBAR --- */
#main-sidebar {
width: 88px;
flex-shrink: 0;
padding: 24px 12px;
transition: width 0.3s cubic-bezier(0.2, 0, 0, 1), padding 0.3s ease;
}

@media (min-width: 1024px) {
#main-sidebar {
width: 260px;
padding: 24px 20px;
}
}

.nav-item {
display: flex; align-items: center; gap: 14px;
padding: 12px;
color: var(--text-secondary);
font-weight: 500;
font-size: 15px;
border-radius: 12px;
transition: all 0.2s ease;
cursor: pointer;
text-decoration: none;
margin-bottom: 4px;
justify-content: center;
position: relative;
}

.nav-item:hover {
color: var(--on-surface);
background-color: var(--hover-bg);
}

.nav-item.active {
color: var(--primary);
background-color: #eff4ff;
font-weight: 600;
}

/* Notification Dot Logic */
.nav-dot {
position: absolute;
top: 10px;
right: 28px; /* Mobile centered icon approx */
width: 9px;
height: 9px;
background-color: #ef4444;
border-radius: 50%;
border: 2px solid var(--surface);
display: none;
z-index: 10;
}

@media (min-width: 1024px) {
.nav-item {
justify-content: flex-start;
padding: 10px 16px;
}
.nav-dot {
top: 8px;
right: auto;
left: 28px; /* Position near the icon on desktop */
}
}

.sidebar-user {
display: flex; align-items: center; gap: 12px;
padding: 8px;
border-radius: 12px;
cursor: pointer;
transition: background-color 0.2s;
justify-content: center;
}
.sidebar-user:hover { background-color: var(--hover-bg); }

@media (min-width: 1024px) {
.sidebar-user { justify-content: flex-start; padding: 8px 12px; }
}

.create-btn {
display: flex;
align-items: center;
justify-content: flex-start;
gap: 12px;
background: #1f1f1f;
color: white;
padding: 12px 20px;
border-radius: 12px;
font-weight: 500;
font-size: 14px;
transition: all 0.2s ease;
width: 100%;
margin-bottom: 24px;
box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
line-height: 1;
min-width: 0;
white-space: nowrap;
}

.create-btn:hover {
background: #000;
transform: translateY(-1px);
box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
}

/* --- POST CARD DESIGN --- */
.post-card {
background: var(--surface);
border-bottom: 1px solid var(--outline);
border-radius: 0;
transition: background-color 0.2s ease;
margin-bottom: 0;
box-shadow: none;
overflow: visible;
}
.post-card:hover {
background-color: var(--hover-bg);
cursor: pointer;
transform: none;
}

.post-header {
display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;
}

.post-avatar-container {
position: relative;
}
.post-avatar {
width: 44px; height: 44px;
border-radius: 50%;
background-color: var(--hover-bg);
border: 1px solid var(--outline);
object-fit: cover;
}

.post-author-name {
font-weight: 700; font-size: 15px; color: var(--on-surface);
line-height: 1.2;
}
.post-author-name:hover { text-decoration: underline; color: var(--primary); }

.post-meta {
font-size: 12px; color: var(--text-secondary); margin-top: 3px; font-weight: 500;
}

.post-body {
font-size: 15px; line-height: 1.6; color: var(--on-surface);
margin-bottom: 16px;
}

.post-actions {
display: flex; align-items: center; justify-content: space-between;
padding-top: 14px; border-top: 1px solid var(--outline);
}

.action-btn {
display: flex; align-items: center; gap: 6px;
padding: 8px 12px; border-radius: 10px;
color: var(--text-secondary); font-size: 13px; font-weight: 600;
transition: all 0.2s;
background: transparent; border: none; cursor: pointer;
}
.action-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }
.action-btn.like:hover { background-color: #fef2f2; color: #ef4444; }
.action-btn.comment:hover { background-color: #eff6ff; color: #2563eb; }
.action-btn.bookmark:hover { background-color: #fefce8; color: #eab308; }
.action-btn.share-btn:hover { background-color: #f3f4f6; color: var(--on-surface); }

/* --- COMPOSE & CREATE MENUS --- */
#compose-modal, #create-menu-modal, #event-modal-box, #mentorship-modal-box, #edit-profile-modal, #user-list-modal, #settings-modal, #likes-overlay, #username-modal, #post-options-modal-box {
box-shadow: 0 20px 60px rgba(0,0,0,0.15);
border: 1px solid var(--outline);
}

.compose-header {
display: flex; align-items: center; justify-content: space-between;
padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--outline);
}
.compose-title { font-size: 18px; font-weight: 600; color: var(--on-surface); font-family: 'Google Sans', sans-serif; }

.compose-user-area {
display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
}

.compose-textarea {
width: 100%; min-height: 120px;
font-size: 17px; line-height: 1.6;
color: var(--on-surface); placeholder-color: var(--text-secondary);
border: none; outline: none; resize: none;
background: transparent;
}

.compose-tools {
display: flex; align-items: center; justify-content: space-between;
margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--outline);
}

.tool-group { display: flex; gap: 4px; }

.tool-btn {
width: 40px; height: 40px; border-radius: 50%;
display: flex; align-items: center; justify-content: center;
color: var(--text-secondary); transition: background 0.2s; cursor: pointer;
}
.tool-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }

/* Create Menu Specific */
.create-option-card {
display: flex; flex-direction: column; align-items: center; justify-content: center;
padding: 24px; border-radius: 16px; border: 1px solid var(--outline);
background: var(--surface); cursor: pointer; transition: all 0.2s;
gap: 12px;
}
.create-option-card:hover {
border-color: var(--primary); background: #eff4ff; transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(11, 87, 208, 0.1);
}

.create-icon-bg {
width: 56px; height: 56px; border-radius: 50%; background: var(--hover-bg);
display: flex; align-items: center; justify-content: center; color: var(--on-surface);
margin-bottom: 8px; transition: background 0.2s;
}
.create-option-card:hover .create-icon-bg { background: #d3e3fd; color: #0b57d0; }

/* Notion Style Event Form */
.notion-input-row {
display: flex; align-items: center; gap: 12px; padding: 8px 0;
color: var(--on-surface); font-size: 15px;
}
.notion-label {
width: 100px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; font-size: 14px;
}
.notion-input {
flex: 1; border: none; outline: none; background: transparent;
font-size: 15px; color: var(--on-surface);
}
.notion-input:focus { background: var(--hover-bg); border-radius: 4px; }

.media-preview-wrapper {
margin-top: 12px; position: relative;
width: 100%; background: var(--hover-bg); border-radius: 12px;
overflow: hidden; border: 1px solid var(--outline);
display: flex; justify-content: center; align-items: center;
}
.media-preview-content {
width: 100%; height: auto; max-height: 400px;
object-fit: contain; display: block;
}

/* --- OTHER --- */
.gemini-input-wrapper {
background-color: var(--hover-bg);
border-radius: 24px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
border: 1px solid transparent;
display: flex; flex-direction: column;
min-height: 52px;
}
.gemini-input-wrapper:focus-within {
background-color: var(--surface);
box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px var(--outline);
}

.gemini-code-container { border-radius: 12px; overflow: hidden; margin: 20px 0; border: 1px solid #444746; background: #1e1f20; }
.gemini-code-header { background: #2f3033; padding: 10px 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444746; font-size: 13px; color: #e3e3e3; font-family: 'Google Sans', sans-serif; font-weight: 500; }
.gemini-code-btn { display: flex; align-items: center; gap: 6px; color: #e3e3e3; cursor: pointer; padding: 6px 10px; border-radius: 6px; transition: background 0.2s; }
.gemini-code-btn:hover { background: rgba(255,255,255,0.1); }
pre { background: #1e1f20; padding: 20px; color: #e3e3e3; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 0.95rem; margin: 0; }
.code-keyword { color: #ffab91; } .code-function { color: #81c784; }

.feed-panel { flex: 1; min-width: 0; order: 1; }
.ai-panel { width: 100%; flex-shrink: 0; order: 2; }
@media (min-width: 1280px) { .ai-panel { width: 440px; } }

/* Focus Mode Logic */
#workspace-layout.swapped { justify-content: flex-start; padding-left: 0; gap: 20px; }
#workspace-layout.swapped #main-panel { display: none !important; }
.swapped .ai-panel {
flex: 1;
width: 100% !important;
max-width: none;
order: 1;
border: 2px solid #a8c7fa;
box-shadow: 0 12px 40px rgba(11, 87, 208, 0.1);
}

.plus-menu {
position: absolute; bottom: 140px; left: 20px; background: var(--surface); border: 1px solid var(--outline);
border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 200px; display: flex; flex-direction: column; padding: 6px;
z-index: 50; transform-origin: bottom left; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.plus-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

.model-menu {
position: absolute; top: 50px; right: 60px; background: var(--surface); border: 1px solid var(--outline);
border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 220px; display: flex; flex-direction: column; padding: 6px;
z-index: 100; transform-origin: top right; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.model-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

.menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--on-surface); font-size: 14px; font-weight: 500; transition: background 0.1s; }
.menu-item:hover { background: var(--hover-bg); }
.menu-item.active-item { background: #eff4ff; color: #0b57d0; }

.backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.backdrop.active { opacity: 1; pointer-events: auto; }

.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: #f2f2f2; padding: 14px 28px; border-radius: 48px; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; cursor: pointer; color: var(--text-secondary); }
.icon-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }

.hashtag { color: var(--primary); font-weight: 500; cursor: pointer; padding: 2px 6px; border-radius: 6px; }
.hashtag:hover { background: #eff4ff; }

/* --- POST OPTION MODAL STYLES --- */
#post-options-modal-container {
    transition: opacity 0.2s;
}
#post-options-modal-box {
    transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
    background: white;
    z-index: 100;
}
@media (max-width: 768px) {
    #post-options-modal-box {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        padding-bottom: env(safe-area-inset-bottom);
    }
    #post-options-modal-container.active #post-options-modal-box {
        transform: translateY(0);
    }
}
@media (min-width: 769px) {
    #post-options-modal-box {
        border-radius: 20px;
        transform: scale(0.95);
        max-width: 320px;
        width: 100%;
        position: relative;
    }
    #post-options-modal-container.active #post-options-modal-box {
        transform: scale(1);
    }
}

.option-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    font-size: 15px;
    font-weight: 500;
    color: var(--on-surface);
    cursor: pointer;
    border-bottom: 1px solid var(--outline);
    transition: background-color 0.2s;
}
.option-item:last-child {
    border-bottom: none;
}
.option-item:hover {
    background-color: var(--hover-bg);
}
.option-item.danger {
    color: #ef4444;
}

/* --- UPDATED TABS STYLE (Twitter/X Style) --- */
.tab-group {
display: flex;
width: 100%;
background: transparent;
padding: 0;
border: none;
border-bottom: 1px solid var(--outline);
border-radius: 0;
}
.tab-btn {
flex: 1;
padding: 14px 0;
font-size: 14px;
font-weight: 600;
color: var(--text-secondary);
border-radius: 0;
transition: all 0.2s ease;
cursor: pointer;
background: transparent;
text-align: center;
position: relative;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
}
.tab-btn:hover {
color: var(--on-surface);
background-color: var(--hover-bg);
}
.tab-btn.active {
color: var(--on-surface);
background: transparent;
box-shadow: none;
}
.tab-btn.active::after {
content: '';
position: absolute;
bottom: 0;
left: 50%;
transform: translateX(-50%);
width: 60px;
height: 4px;
background-color: var(--primary);
border-radius: 4px 4px 0 0;
}

/* --- GRID POST STYLE (Instagram Style) --- */
.grid-post-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2px;
}
@media (min-width: 768px) {
    .grid-post-container { gap: 16px; }
}
.grid-post-item {
    position: relative;
    aspect-ratio: 1 / 1;
    overflow: hidden;
    cursor: pointer;
    background-color: #f3f4f6;
}
.grid-post-item:hover .grid-post-overlay {
    opacity: 1;
}
.grid-post-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    color: white;
    font-weight: bold;
    gap: 16px;
}
.grid-post-text-preview {
    width: 100%;
    height: 100%;
    padding: 12px;
    font-size: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: #4b5563;
    background: #f9fafb;
    overflow: hidden;
}

.mobile-nav-item {
display: flex; flex-direction: column; align-items: center; justify-content: center;
height: 100%; flex: 1; gap: 4px; color: #98a2b3; transition: all 0.2s; cursor: pointer;
position: relative;
}
.mobile-nav-item.active { color: #000000; } 
.mobile-nav-item i { width: 24px; height: 24px; transition: transform 0.2s; }
.mobile-nav-item.active i { transform: scale(1.1); stroke-width: 2.5px; }

.scale-in { animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* LOADER OVERLAY */
#app-loader {
position: fixed; inset: 0; background: var(--surface); z-index: 9999;
display: flex; justify-content: center; align-items: center;
transition: opacity 0.5s ease;
}
.loader-spinner {
width: 40px; height: 40px; border: 4px solid var(--hover-bg);
border-top: 4px solid var(--primary); border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* Banner Styles */
.profile-banner-container {
height: 140px;
width: 100%;
background-color: #e5e7eb;
position: relative;
overflow: hidden;
cursor: default;
}
.profile-banner-img {
width: 100%;
height: 100%;
object-fit: cover;
pointer-events: none; /* Default state */
}

/* Edit Banner Draggable State */
.banner-edit-container {
height: 140px;
width: 100%;
background: #e5e7eb;
position: relative;
overflow: hidden;
cursor: grab;
border-radius: 12px;
}
.banner-edit-container:active {
cursor: grabbing;
}
.banner-edit-img {
width: 100%;
height: 100%;
object-fit: cover;
user-select: none;
-webkit-user-drag: none;
}

/* Settings Toggle */
.toggle-checkbox:checked {
right: 0;
border-color: #0b57d0;
}
.toggle-checkbox:checked + .toggle-label {
background-color: #0b57d0;
}
.toggle-switch {
position: relative;
width: 44px;
height: 24px;
background-color: #e5e7eb;
border-radius: 9999px;
transition: background-color 0.2s;
cursor: pointer;
}
.toggle-switch.active {
background-color: #0b57d0;
}
.toggle-dot {
position: absolute;
top: 2px;
left: 2px;
width: 20px;
height: 20px;
background-color: white;
border-radius: 50%;
transition: transform 0.2s;
}
.toggle-switch.active .toggle-dot {
transform: translateX(20px);
}

/* Header Transition */
#main-header {
    transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
}

.collab-chip {
    display: inline-flex;
    align-items: center;
    background-color: #f3f4f6;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 13px;
    margin-right: 6px;
    margin-bottom: 6px;
    color: #1f1f1f;
    border: 1px solid #e5e7eb;
}

/* Creator Like Badge */
.creator-badge {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid white;
}

/* Lightbox Overlay */
#lightbox-overlay-info {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
  padding: 40px 20px 40px 20px;
  color: white;
  pointer-events: none;
}
#lightbox-overlay-info * {
  pointer-events: auto;
}

</style>
</head>
<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]">
<!-- LOADING OVERLAY -->
<div id="app-loader"><div class="loader-spinner"></div></div>
<!-- CUSTOM ALERT MODAL -->
<div id="custom-alert" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
<div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-[90%] transform scale-95 transition-transform duration-200" id="custom-alert-box">
<h3 class="text-lg font-bold text-[#1f1f1f] mb-2" id="alert-title">Confirm</h3>
<p class="text-gray-600 mb-6 text-sm" id="alert-msg">Are you sure?</p>
<div class="flex justify-end gap-3">
<button class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg transition-colors" onclick="closeAlert(false)">Cancel</button>
<button class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700 transition-colors" id="alert-confirm-btn">Confirm</button>
</div>
</div>
</div>
<!-- USERNAME SETUP MODAL -->
<div id="username-modal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
<div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative flex flex-col items-center">
<h2 class="text-2xl font-bold text-[#1f1f1f] mb-2 google-font">Create Username</h2>
<p class="text-sm text-gray-500 mb-6 text-center">Choose a unique username to identify yourself on EduLink. No spaces allowed.</p>
<div class="w-full relative mb-4">
<span class="absolute left-4 top-3 text-gray-400 font-bold">@</span>
<input type="text" id="new-username-input" class="w-full bg-gray-100 rounded-xl py-3 pl-8 pr-4 outline-none focus:ring-2 focus:ring-blue-500 font-medium" placeholder="username">
</div>
<button onclick="saveUsername()" class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Start Exploring</button>
</div>
</div>

<!-- POST OPTIONS OVERLAY MODAL -->
<div id="post-options-modal-container" class="fixed inset-0 z-[75] flex items-center justify-center bg-black/40 backdrop-blur-sm opacity-0 pointer-events-none" onclick="hidePostMenu()">
    <div id="post-options-modal-box" class="flex flex-col overflow-hidden" onclick="event.stopPropagation()">
        <!-- Content injected via JS -->
    </div>
</div>

<!-- MOBILE NOTIFICATIONS HEADER -->
<div id="mobile-notifications-header" class="md:hidden fixed top-0 left-0 w-full bg-white z-30 flex-col hidden border-b border-gray-100 pb-0">
   <div class="h-14 flex items-center justify-between px-4 shrink-0 relative">
      <span class="font-bold text-lg text-[#1f1f1f]">Notifications</span>
      <div class="relative">
          <button onclick="toggleNotifMenu()" class="icon-btn"><i data-lucide="more-vertical" class="w-5 h-5"></i></button>
          <div id="notif-menu-dropdown" class="absolute right-0 top-10 bg-white border border-gray-100 shadow-xl rounded-xl z-50 w-48 hidden flex-col overflow-hidden">
              <button onclick="toggleNotifSelection()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium border-b border-gray-50 text-gray-700">Select</button>
              <button onclick="deleteSelectedNotifs()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium text-red-500">Delete Selected</button>
              <button onclick="clearAllNotifications()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium text-red-500">Delete All</button>
          </div>
      </div>
   </div>
   <div class="px-4 pb-2">
       <div class="relative">
           <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
           <input type="text" id="notif-search" placeholder="Search notifications..." oninput="handleNotifSearch(this.value)" class="w-full bg-gray-100 rounded-xl py-2 pl-9 pr-4 text-sm outline-none focus:ring-1 focus:ring-blue-500 transition-all">
       </div>
   </div>
   <div class="tab-group mb-0 mx-0 w-full">
        <button onclick="switchNotifTab('friends')" id="ntab-friends-mobile" class="tab-btn active"><i data-lucide="users" class="w-4 h-4"></i> Following</button>
        <button onclick="switchNotifTab('others')" id="ntab-others-mobile" class="tab-btn"><i data-lucide="bell" class="w-4 h-4"></i> Others</button>
        <button onclick="switchNotifTab('official')" id="ntab-official-mobile" class="tab-btn"><i data-lucide="megaphone" class="w-4 h-4"></i> Official</button>
    </div>
</div>

<!-- MOBILE EXPLORE HEADER -->
<div id="mobile-explore-header" class="md:hidden fixed top-0 left-0 w-full bg-white z-30 flex items-center gap-3 px-3 h-16 border-b border-gray-100 hidden">
    <div class="relative flex-1">
         <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
         <input type="text" id="mobile-explore-search" class="w-full bg-gray-100 rounded-xl py-2 pl-9 pr-4 text-sm outline-none focus:ring-2 focus:ring-blue-100 transition-all" placeholder="Search users, posts & tags..." oninput="handleSearch(this.value)">
    </div>
    <button onclick="switchView('feed')" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>

<!-- THREAD OVERLAY (Redesigned) -->
<div id="thread-overlay" class="fixed inset-0 z-[65] hidden flex justify-center items-end md:items-center">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeThread()"></div>
    <div class="bg-white w-full md:w-[600px] h-[95vh] md:h-[85vh] md:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
        <div class="h-14 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white z-10 sticky top-0">
            <button onclick="closeThread()" class="p-2 -ml-2 rounded-full hover:bg-gray-100"><i data-lucide="x" class="w-6 h-6 text-gray-600"></i></button>
            <span class="font-bold text-lg text-[#1f1f1f]">Thread</span>
            <div class="w-8"></div>
        </div>
        <div id="thread-content" class="flex-1 overflow-y-auto p-0 scroll-smooth bg-white"></div>
        <div class="border-t border-gray-100 p-3 bg-white shrink-0 sticky bottom-0 z-20">
             <div class="bg-gray-100 rounded-3xl p-1.5 flex gap-2 items-center focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                <img id="thread-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-200 object-cover ml-1 shrink-0">
                <input id="thread-input" placeholder="Reply to thread..." class="flex-1 bg-transparent outline-none text-sm px-2 h-10">
                <button onclick="submitThreadReply()" class="text-blue-600 font-bold px-4 py-2 text-sm hover:bg-blue-50 rounded-full transition-colors">Post</button>
            </div>
        </div>
    </div>
</div>

<!-- Post View Overlay (Redesigned for Mobile with Fixed Comment Box) -->
<div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-end md:items-center">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closePostView()"></div>
    <div class="bg-white w-full h-full md:w-[1100px] md:h-[90vh] md:rounded-r-2xl shadow-2xl relative flex flex-col md:flex-row transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
        
        <!-- Left Side: Media (Desktop) / Top (Mobile - Updated height logic) -->
        <div id="post-view-media-container" class="w-full md:w-[60%] bg-black flex items-center justify-center relative h-[40vh] md:h-full shrink-0">
             <!-- Media Injected Here or No Media Icon -->
        </div>

        <!-- Right Side: Content (Desktop) / Bottom (Mobile) -->
        <div class="flex-1 flex flex-col h-full bg-white relative w-full md:w-[40%] rounded-t-2xl md:rounded-none -mt-4 md:mt-0 z-10 min-h-0">
             <!-- Header -->
             <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white rounded-t-2xl md:rounded-none">
                  <div class="flex items-center gap-3">
                      <img id="post-view-avatar" class="w-8 h-8 rounded-full border border-gray-200 object-cover cursor-pointer">
                      <span id="post-view-username" class="font-bold text-sm text-gray-900 cursor-pointer hover:underline">Username</span>
                  </div>
                  <button onclick="closePostView()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-6 h-6"></i></button>
             </div>

             <!-- Scrollable Content -->
             <div id="post-view-scroll" class="flex-1 overflow-y-auto p-4 scroll-smooth min-h-0">
                  <!-- Caption / Text Only Content -->
                  <div id="post-view-caption-area" class="mb-4 pb-4 border-b border-gray-100">
                      <!-- Injected via JS -->
                  </div>
                  
                  <!-- Comments List -->
                  <div id="post-view-comments" class="space-y-4"></div>
             </div>

             <!-- Footer Actions (Fixed at bottom due to flex layout) -->
             <div class="border-t border-gray-100 p-3 bg-white shrink-0 z-20 pb-safe">
                  <div class="flex justify-between items-center mb-2 px-1">
                       <div class="flex gap-4">
                           <button id="post-view-like-btn" class="hover:opacity-60 transition-opacity"><i data-lucide="heart" class="w-6 h-6"></i></button>
                           <button class="hover:opacity-60 transition-opacity" onclick="document.getElementById('comment-input-desktop').focus()"><i data-lucide="message-circle" class="w-6 h-6"></i></button>
                           <button class="hover:opacity-60 transition-opacity"><i data-lucide="send" class="w-6 h-6"></i></button>
                       </div>
                       <button id="post-view-save-btn" class="hover:opacity-60 transition-opacity"><i data-lucide="bookmark" class="w-6 h-6"></i></button>
                  </div>
                  <div class="font-bold text-sm mb-2 px-1" id="post-view-likes-count">0 likes</div>
                  <div class="text-[10px] text-gray-400 uppercase mb-3 px-1" id="post-view-date">DATE</div>

                  <!-- Comment Input -->
                  <div class="flex items-center gap-2 border-t border-gray-100 pt-3">
                      <i data-lucide="smile" class="w-6 h-6 text-gray-400 cursor-pointer"></i>
                      <textarea id="comment-input-desktop" placeholder="Add a comment..." class="flex-1 max-h-20 bg-transparent outline-none text-sm resize-none h-5 py-1" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitCommentDesktop(); }"></textarea>
                      <button onclick="submitCommentDesktop()" class="text-blue-500 font-bold text-sm opacity-100 hover:text-blue-700">Post</button>
                  </div>
             </div>
        </div>
    </div>
</div>

<div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()">
<button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20 z-50"><i data-lucide="x" class="w-8 h-8"></i></button>
<div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-0 relative"></div>
</div>
<div id="toast" class="toast">
<i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span>
</div>
<!-- LIKES OVERLAY -->
<div id="likes-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeLikes()">
<div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()">
<div class="flex justify-between items-center p-4 border-b border-gray-100">
<h3 class="text-lg font-bold text-gray-900">Likes</h3>
<button onclick="closeLikes()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="likes-list-content" class="flex-1 overflow-y-auto p-2">
<!-- Items injected via JS -->
</div>
</div>
</div>
<!-- SETTINGS MODAL -->
<div id="settings-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeSettings()">
<div class="bg-white w-[90%] max-w-[450px] rounded-[24px] shadow-2xl p-6 relative transform transition-all scale-100 overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-bold text-[#1f1f1f] google-font">Settings</h2>
<button onclick="closeSettings()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="flex-1 overflow-y-auto space-y-6">
<!-- Account Privacy -->
<div>
<h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Privacy</h3>
<div class="flex items-center justify-between py-2">
<div>
<div class="font-medium text-gray-900">Private Account</div>
<div class="text-xs text-gray-500">Only followers can see your posts</div>
</div>
<div id="toggle-privacy" class="toggle-switch" onclick="togglePrivacy()">
<div class="toggle-dot"></div>
</div>
</div>
</div>
<!-- Links -->
        <div>
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">About</h3>
            <a href="pre.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="crown" class="w-4 h-4"></i></div>
                    <span class="font-medium text-gray-900">Premium</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i>
            </a>
            <a href="p.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i data-lucide="shield" class="w-4 h-4"></i></div>
                    <span class="font-medium text-gray-900">Privacy Policy</span>
                </div>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i>
            </a>
        </div>
    </div>
    <div class="mt-6 pt-4 border-t border-gray-100">
        <button onclick="doLogout()" class="w-full py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-colors">Log Out</button>
    </div>
</div>
</div>
<!-- USER LIST MODAL (REUSED FOR COLLAB) -->
<div id="user-list-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeUserList()">
<div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()">
<div class="flex justify-between items-center p-4 border-b border-gray-100">
<h3 class="text-lg font-bold text-gray-900" id="user-list-title">Users</h3>
<button onclick="closeUserList()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="user-list-content" class="flex-1 overflow-y-auto p-2">
<!-- User items injected here -->
</div>
</div>
</div>
<!-- CREATE SELECTION OVERLAY -->
<div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()">
<div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2>
<button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="create-option-card" onclick="openCompose()">
<div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Post</span>
</div>
<div class="create-option-card" onclick="openEventComposer()">
<div class="create-icon-bg"><i data-lucide="calendar-plus" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Event</span>
</div>
<div class="create-option-card" onclick="openMentorship()">
<div class="create-icon-bg"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Mentorship</span>
</div>
</div>
</div>
</div>
<!-- EDIT PROFILE OVERLAY -->
<div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeEditProfile()">
<div id="edit-profile-modal" class="bg-white w-[95%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-bold google-font">Edit Profile</h2>
<button onclick="closeEditProfile()" class="icon-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="flex flex-col gap-5">
<div class="flex flex-col items-center mb-2">
<div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()">
<img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-2 border-gray-100 object-cover">
<div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
<i data-lucide="camera" class="text-white w-6 h-6"></i>
</div>
</div>
<input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)">
<input type="file" id="edit-banner-input" class="hidden" accept="image/*" onchange="handleEditBannerSelect(event)">
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Banner Image</label>
<div id="banner-edit-area" class="banner-edit-container group mb-2 h-36" onclick="document.getElementById('edit-banner-input').click()">
<img id="edit-banner-preview" src="" class="banner-edit-img" style="object-position: center 50%">
<div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
<i data-lucide="upload" class="text-white w-6 h-6"></i>
</div>
</div>
<div class="text-[10px] text-gray-400 mb-1 flex justify-between"><span>Click banner to change, drag to reposition</span> <span id="banner-pos-hint">50%</span></div>
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase">Display Name</label>
<input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900">
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase">Email</label>
<input type="text" id="edit-email" class="w-full border-b border-gray-200 py-2 outline-none text-gray-500 bg-transparent select-text" disabled>
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase">Bio</label>
<textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="3"></textarea>
</div>
<button id="save-profile-btn" onclick="saveProfileChanges()" class="bg-[#0b57d0] text-white py-3 rounded-xl font-bold mt-2 hover:bg-blue-700 transition-all">Save Changes</button>
</div>
</div>
</div>
<!-- MENTORSHIP MODAL -->
<div id="mentorship-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
<div id="mentorship-modal-box" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative transform scale-95 transition-transform duration-200 flex flex-col items-center text-center">
<button onclick="closeMentorship()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Construction" class="w-24 h-24 mb-4">
<h3 class="text-xl font-bold text-[#1f1f1f] mb-2 google-font">Under Construction!</h3>
<p class="text-sm text-[#667085] leading-relaxed">The Mentorship module is currently being built with ❤️. Check back soon for exciting updates!</p>
<button onclick="closeMentorship()" class="mt-6 bg-[#0b57d0] text-white px-6 py-2.5 rounded-full font-bold text-sm hover:bg-[#0b57d0]/90 transition-all">Got it</button>
</div>
</div>
<!-- EVENT MODAL -->
<input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
<div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
<div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0">
<div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group">
<img id="event-cover-preview" class="w-full h-full object-cover">
<button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
<button onclick="document.getElementById('event-cover-input').click()" class="absolute bottom-2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20">
Change
</button>
</div>
<button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
<div class="p-8 pt-6">
<div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()">
<i data-lucide="image" class="w-4 h-4"></i> Add cover
</div>
<input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font">
<div class="flex flex-col gap-1 mb-6">
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div>
<input type="date" id="event-date" class="notion-input">
</div>
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div>
<input type="time" id="event-time" class="notion-input">
</div>
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div>
<input type="text" id="event-location" placeholder="Add location..." class="notion-input">
</div>
</div>
<textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea>
<div class="flex justify-end mt-6 pt-4 border-t border-gray-100">
<button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button>
</div>
</div>
</div>
</div>
<!-- POST COMPOSE OVERLAY -->
<div id="compose-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCompose()">
<div id="compose-modal" class="bg-white w-[95%] max-w-[620px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()">
<div class="compose-header">
<span class="compose-title" id="compose-title-text">Create Post</span>
<button onclick="closeCompose()" class="icon-btn hover:bg-[#f0f4f9] w-8 h-8"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="flex gap-3 mb-4 items-center">
<img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
<div>
<div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div>
</div>
</div>
<textarea id="compose-text" placeholder="What do you want to share today?" class="compose-textarea"></textarea>

<div id="media-preview-container" class="hidden media-preview-wrapper group">
    <img id="media-preview-img" src="" class="hidden media-preview-content">
    <video id="media-preview-video" src="" class="hidden media-preview-content" controls></video>
    <button onclick="removeMedia()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1.5 hover:bg-black/80 transition-colors shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
</div>

<div id="collab-chips-container" class="flex flex-wrap mb-2"></div>

<div class="compose-tools">
    <div class="tool-group">
        <button onclick="document.getElementById('media-input').click()" class="tool-btn" title="Upload Media"><i data-lucide="image" class="w-5 h-5"></i></button>
        <button onclick="promptForLink()" class="tool-btn" title="Add Link"><i data-lucide="link" class="w-5 h-5"></i></button>
        <button onclick="insertCodeBlock()" class="tool-btn" title="Add Code"><i data-lucide="code-2" class="w-5 h-5"></i></button>
        <button onclick="openCollabSelector()" class="tool-btn text-gray-600 bg-gray-50" title="Tag Collaborators"><i data-lucide="users" class="w-5 h-5"></i></button>
        <button class="tool-btn" title="More"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
    </div>
    <button id="btn-publish" onclick="publishPost()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-full font-bold text-[15px] hover:bg-[#0b57d0]/90 transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
</div>

<div class="border-t border-gray-100 pt-3 mt-2">
    <div class="flex items-center justify-between cursor-pointer p-1" onclick="toggleComposeSettings()">
        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Post Settings</span>
        <i data-lucide="chevron-down" id="compose-settings-arrow" class="w-4 h-4 text-gray-400 transition-transform"></i>
    </div>
    <div id="compose-settings-area" class="hidden mt-3 space-y-3 px-1">
        <!-- Privacy -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="lock" class="w-4 h-4"></i> Private (Followers Only)</div>
            <input type="checkbox" id="post-setting-privacy" class="accent-blue-600 w-4 h-4 cursor-pointer">
        </div>
        <!-- Show Likes -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="heart" class="w-4 h-4"></i> Show Like Count</div>
            <input type="checkbox" id="post-setting-likes" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
        </div>
        <!-- Show Comments -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-square" class="w-4 h-4"></i> Show Comment Count</div>
            <input type="checkbox" id="post-setting-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
        </div>
        <!-- Allow View Likes -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="users" class="w-4 h-4"></i> Allow viewers to see who liked</div>
            <input type="checkbox" id="post-setting-like-view" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
        </div>
        <!-- Allow Comments -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-circle" class="w-4 h-4"></i> Allow comments</div>
            <input type="checkbox" id="post-setting-allow-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
        </div>
    </div>
</div>
</div>
</div>
<!-- MAIN SIDEBAR -->
<aside id="main-sidebar" class="hidden md:flex app-panel">
<div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')">
<img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
<h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
</div>
<button onclick="openCreateMenu()" class="create-btn hidden lg:flex">
<i data-lucide="plus" class="w-5 h-5"></i><span>Create</span>
</button>
<nav class="flex-1 space-y-1" id="desktop-nav-items">
<a href="#" onclick="switchView('feed'); return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i> <span class="hidden lg:block">Home</span></a>
<a href="#" onclick="switchView('explore'); return false;" id="nav-explore" class="nav-item"><i data-lucide="compass" class="w-5 h-5"></i> <span class="hidden lg:block">Explore</span></a>
<a href="#" onclick="switchView('network'); return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i> <span class="hidden lg:block">Network</span></a>
<a href="#" onclick="switchView('notifications'); return false;" id="nav-notifications" class="nav-item relative">
    <i data-lucide="bell" class="w-5 h-5"></i> 
    <span class="hidden lg:block">Notifications</span>
    <span id="nav-notif-badge" class="nav-dot"></span>
</a>
<a href="workspace.html" class="nav-item"><i data-lucide="briefcase" class="w-5 h-5"></i> <span class="hidden lg:block">Workspace</span></a>
<a href="#" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null); return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i> <span class="hidden lg:block">Profile</span></a>
</nav>
<div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2">
<div class="sidebar-user group cursor-pointer" onclick="openSettings()">
<div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></div>
<div class="hidden lg:block">
<div class="text-sm font-bold text-[#1f1f1f]">Settings</div>
</div>
</div>
<div class="sidebar-user group" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)">
<img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
<div class="hidden lg:block">
<div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div>
<div class="text-xs text-[#667085]">View Profile</div>
</div>
</div>
</div>
</aside>
<div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
<main id="main-panel" class="flex-1 app-panel min-w-0 relative">
<header id="main-header" class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 absolute top-0 w-full bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0] transition-transform duration-300">
<div class="md:hidden flex items-center gap-3 cursor-pointer" onclick="switchView('feed')">
<img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
<h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
</div>
<div class="flex-1 max-w-[600px] relative group hidden md:block">
<i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i>
<input type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]">
</div>
<div class="flex items-center gap-3 pl-4">
<button onclick="openSettings()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="settings" class="w-6 h-6"></i></button>
<button class="icon-btn relative" onclick="toggleNotifications()">
<i data-lucide="bell" class="w-6 h-6"></i>
</button>
<img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)">
</div>
</header>
<!-- FEED VIEW -->
<div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white pt-16 md:pt-20">
<div id="feed-container"></div>
<div class="flex flex-col items-center justify-center py-10 opacity-60">
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-24 h-24 mb-4 opacity-80 grayscale hover:grayscale-0 transition-all duration-500">
<h3 class="text-lg font-bold text-gray-400 google-font">Grow and Share</h3>
<p class="text-sm text-gray-400 text-center max-w-xs mt-1">Your network starts here. Share your first idea!</p>
</div>
</div>
<!-- SAVED VIEW -->
<div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
    <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2>
    <div id="saved-container" class="space-y-4"></div>
</div>

<!-- NETWORK VIEW (New) -->
<div id="view-network" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
    <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">My Network</h2>
    <div class="tab-group mb-4 mx-0 md:mx-0">
        <button onclick="switchNetworkTab('people')" id="net-tab-people" class="tab-btn active">People</button>
        <button onclick="switchNetworkTab('posts')" id="net-tab-posts" class="tab-btn">Posts</button>
    </div>
    <div id="network-content"></div>
</div>

<!-- PROFILE VIEW -->
<div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>

<!-- NOTIFICATIONS VIEW (Now Main) -->
<div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-32 md:pt-6">
    <div class="flex justify-between items-center mb-4 px-4 md:px-0 hidden md:flex">
        <h2 class="text-2xl font-bold">Notifications</h2>
        <button onclick="clearAllNotifications()" class="text-xs text-red-500 font-bold hover:underline">Clear All</button>
    </div>
    <div class="tab-group mb-4 mx-0 md:mx-0 hidden md:flex">
        <button onclick="switchNotifTab('friends')" id="ntab-friends" class="tab-btn active"><i data-lucide="users" class="w-4 h-4"></i> Following</button>
        <button onclick="switchNotifTab('others')" id="ntab-others" class="tab-btn"><i data-lucide="bell" class="w-4 h-4"></i> Others</button>
        <button onclick="switchNotifTab('official')" id="ntab-official" class="tab-btn"><i data-lucide="megaphone" class="w-4 h-4"></i> Official</button>
    </div>
    <div id="notification-list" class="w-full"></div>
</div>

<!-- ANNOUNCEMENTS VIEW (Admin) -->
<div id="view-announcements" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-white pt-16 md:pt-6">
    <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Broadcast Announcement</h2>
    <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm max-w-2xl mb-8">
        <label class="block text-sm font-bold text-gray-700 mb-2">Message to All Users</label>
        <textarea id="announcement-text" class="w-full h-32 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 mb-4" placeholder="Type your official announcement here..."></textarea>
        <div class="flex items-center justify-between">
            <button id="send-announcement-btn" onclick="sendAnnouncement()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Send Broadcast</button>
        </div>
    </div>
</div>

<!-- EVENTS VIEW -->
<div id="view-events" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6">
    <div class="flex items-center justify-between mb-6 px-4 md:px-0">
        <h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2>
        <button onclick="openEventComposer()" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Event</button>
    </div>
    <div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0">
        <!-- Events populated by JS/Firestore -->
    </div>
</div>
 <!-- SEARCH / EXPLORE VIEW -->
<div id="view-explore" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-white">
    <h2 class="text-2xl font-bold mb-4 px-4 md:px-0 hidden md:block pt-6">Explore</h2>
    <div id="explore-results" class="px-0 md:px-0 space-y-0 pt-16 md:pt-0 pb-0 md:pb-0">
        <!-- Default State -->
        <div class="text-center py-20 text-gray-400">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Search & Discover</h3>
            <p class="text-gray-500 text-sm mb-6 flex items-center justify-center gap-2">Find new people and ideas <i data-lucide="search" class="w-4 h-4"></i></p>
        </div>
    </div>
</div>
</main>
<!-- AI PANEL (Newton) -->
<aside id="ai-panel" class="ai-panel hidden xl:flex app-panel mb-16 md:mb-0">
<div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20">
<div class="flex items-center gap-3">
<img id="ai-header-logo" src="https://i.imghippo.com/files/XEEq5247S.png" class="w-9 h-9 object-contain">
<span id="ai-header-name" class="text-[19px] font-medium text-[#1f1f1f] google-font">Newton</span>
</div>
<div class="flex items-center gap-2">
<button onclick="resetChat()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="New Chat">
<i data-lucide="plus" class="w-5 h-5 text-[#667085]"></i>
</button>
<div class="relative">
<button onclick="toggleModelMenu()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="More Options">
<i data-lucide="more-vertical" class="w-5 h-5 text-[#667085]"></i>
</button>
<div id="model-menu" class="model-menu">
<div class="px-2 py-2 text-xs font-bold text-[#667085] uppercase tracking-wider">Select Model</div>
<div onclick="switchModel('standard')" class="menu-item active-item" id="model-btn-standard">
<img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-5 h-5 object-contain"> Newton
</div>
<div onclick="switchModel('friendly')" class="menu-item" id="model-btn-friendly">
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-5 h-5 rounded-full bg-indigo-50"> Tutor Chase
</div>
<div onclick="switchModel('logical')" class="menu-item" id="model-btn-logical">
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Adrian" class="w-5 h-5 rounded-full bg-teal-50"> Tutor Adrian
</div>
<div onclick="switchModel('arun')" class="menu-item" id="model-btn-arun">
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Destiny" class="w-5 h-5 rounded-full bg-orange-50"> Arun
</div>
</div>
</div>
<button onclick="toggleNewtonExpand()" class="hidden md:flex icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="Swap & Expand View">
<i id="expand-icon" data-lucide="maximize-2" class="w-5 h-5 text-[#667085]"></i>
</button>
</div>
</div>
<div class="flex-1 overflow-hidden relative bg-white flex flex-col">
<div id="ai-context-chip" class="hidden mx-6 mt-4 bg-[#eff4ff] border border-[#c2e7ff] rounded-2xl p-3 flex items-center justify-between animate-fade-in slide-in-right">
<div class="flex items-center gap-3 overflow-hidden">
<div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 border border-[#c2e7ff] shadow-sm"><i data-lucide="paperclip" class="w-4 h-4 text-[#0b57d0]"></i></div>
<div class="flex flex-col min-w-0"><span class="text-[10px] text-[#444746] font-bold uppercase tracking-wider">Active Context</span><span class="text-[13px] text-[#1f1f1f] truncate font-bold" id="ai-context-text">Post Data</span></div>
</div>
<button onclick="clearContext()" class="icon-btn w-8 h-8"><i data-lucide="x" class="w-4 h-4"></i></button>
</div>
<div class="flex-1 overflow-y-auto p-6" id="chat-history">
<div class="chat-wrapper flex flex-col w-full mb-6 fade-in">
<div class="flex items-center gap-2 mb-2"><img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-6 h-6 object-contain"></div>
<div class="chat-msg-ai"><p>Hello! I'm Newton, your personal AI tutor. I'm here to help you learn, solve problems, and explore new ideas together. What are you working on today?</p></div>
</div>
</div>
<div class="p-6 bg-white relative">
         <div id="plus-menu" class="plus-menu">
            <div class="menu-item" onclick="document.getElementById('media-input').click(); togglePlusMenu()">
                <i data-lucide="image"></i> Upload Media
            </div>
            <div class="menu-item" onclick="insertCodeSnippetAI(); togglePlusMenu()">
                <i data-lucide="code-2"></i> Code Snippet
            </div>
        </div>

        <div id="search-container" class="gemini-input-wrapper relative z-20 flex flex-col group">
            <textarea id="ai-input" rows="1" placeholder="Ask anything..." 
                class="w-full bg-transparent text-[#1f1f1f] p-4 pl-6 pr-6 outline-none resize-none max-h-48 overflow-y-auto text-[16px] rounded-t-[28px] placeholder-[#98a2b3] border-none focus:ring-0" 
                oninput="handleInput(this)" 
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessageAction(); }"></textarea>
            
            <div class="flex items-center justify-between px-3 pb-2 pt-0">
                <div class="flex items-center gap-1">
                    <button onclick="togglePlusMenu()" class="icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Add Features"><i id="plus-icon" data-lucide="plus-circle" class="w-5 h-5 text-[#667085]"></i></button>
                    <button id="web-search-btn" onclick="toggleWebSearch()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Search the Web"><i data-lucide="globe" class="w-5 h-5 text-[#667085]"></i></button>
                    <button id="menu-idea-validator" onclick="toggleIdeaMode()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Idea Validator"><i data-lucide="lightbulb" class="w-5 h-5 text-[#667085]"></i></button>
                </div>
                <div class="flex items-center gap-2">
                    <button id="ai-send-btn" onclick="sendMessageAction()" class="bg-[#1e1e1e] text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#333] hover:scale-105 transition-all shadow-sm">
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-3 flex items-center justify-center gap-2"><span class="text-[10px] font-medium text-[#98a2b3] opacity-60">Newton may display inaccurate info, so double-check its responses.</span></div>
    </div>
</div>
</aside>
</div>
<!-- Bottom Nav for Mobile -->
<nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg transition-transform duration-300">
<div class="mobile-nav-item active" onclick="switchView('feed')">
<i data-lucide="home"></i>
</div>
<div class="mobile-nav-item" onclick="switchView('explore')">
<i data-lucide="compass"></i>
</div>
<div class="mobile-nav-item" onclick="openCreateMenu()">
<i data-lucide="plus-square"></i>
</div>
<div class="mobile-nav-item" onclick="switchView('notifications')">
<i data-lucide="bell"></i>
</div>
<div class="mobile-nav-item" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)">
<img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200">
</div>
</nav>
<input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
authDomain: "edulinki.firebaseapp.com",
projectId: "edulinki",
storageBucket: "edulinki.firebasestorage.app",
messagingSenderId: "248886466474",
appId: "1:248886466474:web:160043201a6b28bafbbdd3",
measurementId: "G-MQBH12VL7N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// Expose services globally
window.auth = auth;
window.db = db;

// State Variables
let currentUser = null;
let users = [];
let posts = [];
let notifications = [];
let savedPosts = [];
let activeNotifTab = 'friends';
let activeNetworkTab = 'people';
window.replyingToCommentId = null;
window.currentViewingProfileId = null;
window.activeExploreTab = 'people';
window.currentProfileTab = 'posts';

// Global Vars for App Logic
window.currentContext = "";
window.currentMedia = null;
window.currentMediaType = null;
let classifier;
window.mediaVisionLog = "";
window.isWebSearchActive = false;
window.isIdeaMode = false;
let stopGeneration = false;
let abortController = null;
window.isPlusMenuOpen = false;
window.isModelMenuOpen = false;
window.currentEventCover = null;
window.editingPostId = null;
window.threadParentCommentId = null; 
window.threadPostId = null; 

let currentEventCoverBlob = null;
let currentAvatarBlob = null;
let currentBannerBlob = null;

// NOTIFICATION STATE
window.notifSelectionMode = false;
window.selectedNotifs = new Set();
window.notifSearchTerm = '';
const notifAudio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

// Collab State
window.selectedCollaborators = [];

// Header Scroll Logic
let lastScrollTop = 0;
const feedView = document.getElementById('view-feed');
if(feedView) {
    feedView.addEventListener('scroll', () => {
        const currentScroll = feedView.scrollTop;
        const header = document.getElementById('main-header');
        if (currentScroll > lastScrollTop && currentScroll > 60) {
            // Scrolling down
            header.style.transform = 'translateY(-100%)';
        } else {
            // Scrolling up
            header.style.transform = 'translateY(0)';
        }
        lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
    }, {passive: true});
}

// Helper: Reliable Icon Refresh
function refreshIcons() {
if(window.lucide) {
window.lucide.createIcons();
}
}

// Helper: Date Formatter
function formatDate(timestamp) {
if (!timestamp) return '';
let date;
if (timestamp.toDate && typeof timestamp.toDate === 'function') {
date = timestamp.toDate();
} else if (typeof timestamp === 'number') {
date = new Date(timestamp);
} else if (timestamp instanceof Date) {
date = timestamp;
} else {
date = new Date(timestamp);
}
if (isNaN(date.getTime())) return '';
return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Auth Listener
onAuthStateChanged(auth, async (user) => {
const loader = document.getElementById('app-loader');
if (user) {
const userRef = doc(db, "users", user.uid);
const userSnap = await getDoc(userRef);
let isOfficial = false;
if(user.email === 'edulinkbht@gmail.com') { isOfficial = true; }

if (userSnap.exists()) {
currentUser = { id: user.uid, ...userSnap.data() };
if(isOfficial && !currentUser.isOfficial) {
await updateDoc(userRef, { isOfficial: true });
currentUser.isOfficial = true;
}
} else {
currentUser = {
id: user.uid,
name: user.displayName || user.email.split('@')[0],
email: user.email,
avatar: user.photoURL || `https://api.dicebear.com/9.x/lorelei/svg?seed=${user.uid}`,
bio: "New EduLink Member",
following: [],
followers: [],
friends: [],
saved: [],
isOfficial: isOfficial,
settings: { privateNetwork: false },
username: "" 
};
await setDoc(userRef, currentUser);
}

// Ensure defaults
currentUser.following = currentUser.following || [];
currentUser.followers = currentUser.followers || [];
currentUser.friends = currentUser.friends || [];
currentUser.saved = currentUser.saved || [];
currentUser.settings = currentUser.settings || { privateNetwork: false };

window.currentUser = currentUser;
savedPosts = currentUser.saved;

const params = new URLSearchParams(window.location.search);
const sharedPostId = params.get('postId');

// USERNAME CHECK
if(!currentUser.username) {
    document.getElementById('username-modal').classList.remove('hidden');
}

updateUserInterface();
initRealtimeListeners();
setupClassifier();
refreshIcons();
initBannerDrag();

if(loader) loader.style.opacity = '0';
setTimeout(() => { if(loader) loader.remove(); }, 500);

if(sharedPostId) {
setTimeout(() => {
openPostView(sharedPostId);
window.history.pushState({}, document.title, window.location.pathname);
}, 1000);
}

} else {
window.location.href = 'index.html';
}
});

window.saveUsername = async function() {
    const input = document.getElementById('new-username-input');
    const val = input.value.trim().toLowerCase();
    
    // Simple Validation
    if(val.length < 3) { showToast("Too short", true); return; }
    if(/\s/.test(val)) { showToast("No spaces allowed", true); return; }
    if(!/^[a-z0-9_.]+$/.test(val)) { showToast("Letters, numbers, underscores only", true); return; }

    // Check uniqueness (Client side scan for demo, backend rule better)
    const q = query(collection(db, "users"), where("username", "==", val));
    const snap = await getDocs(q);
    if(!snap.empty) { showToast("Username taken", true); return; }

    const userRef = doc(db, "users", currentUser.id);
    await updateDoc(userRef, { username: val });
    currentUser.username = val;
    document.getElementById('username-modal').classList.add('hidden');
    showToast("Username set!");
}

function initRealtimeListeners() {
onSnapshot(collection(db, "users"), (snapshot) => {
users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
const netView = document.getElementById('view-network');
if(netView && !netView.classList.contains('hidden')) renderNetwork();

const profileView = document.getElementById('view-profile');
if(profileView && !profileView.classList.contains('hidden') && window.currentViewingProfileId) {
showProfile(window.currentViewingProfileId, window.currentProfileTab);
}
refreshIcons();
});

const qPosts = query(collection(db, "posts"), orderBy("timestamp", "desc"));
onSnapshot(qPosts, { includeMetadataChanges: true }, (snapshot) => {
posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), timestamp: doc.data().timestamp }));

if (snapshot.metadata.hasPendingWrites) {
return;
}

const changes = snapshot.docChanges();
let shouldFullRender = false;

if (document.getElementById('feed-container').children.length === 0) {
shouldFullRender = true;
} else {
changes.forEach(change => {
if (change.type === "added" || change.type === "removed") {
shouldFullRender = true;
} else if (change.type === "modified") {
const p = change.doc.data();
const pid = change.doc.id;

const likeCountEl = document.getElementById(`like-count-${pid}`);
if(likeCountEl) {
likeCountEl.innerText = p.likes ? p.likes.length : 0;
}

const commentCountEl = document.getElementById(`comment-count-${pid}`);
if(commentCountEl) {
commentCountEl.innerText = p.comments ? p.comments.length : 0;
}
}
});
}

const activeFeed = document.querySelector('#view-feed:not(.hidden)');
if(activeFeed && shouldFullRender) {
renderFeed();
}

const activeSaved = document.querySelector('#view-saved:not(.hidden)');
if(activeSaved) renderSaved(); 

const activeProfile = document.querySelector('#view-profile:not(.hidden)');
if(activeProfile && window.currentViewingProfileId) showProfile(window.currentViewingProfileId, window.currentProfileTab);

const activeNetwork = document.querySelector('#view-network:not(.hidden)');
if(activeNetwork && activeNetworkTab === 'posts') renderNetwork();

const activeExplore = document.querySelector('#view-explore:not(.hidden)');
if(activeExplore) {
const searchVal = document.getElementById('global-search').value;
handleSearch(searchVal);
}

const activePostView = document.querySelector('#post-view-overlay:not(.hidden)');
if(activePostView && window.currentViewingPostId) renderCommentsInModal(window.currentViewingPostId);

const threadOverlay = document.getElementById('thread-overlay');
if (!threadOverlay.classList.contains('hidden') && window.threadPostId && window.threadParentCommentId) {
    renderThreadContent(window.threadPostId, window.threadParentCommentId);
}

setTimeout(refreshIcons, 50);
});

let isFirstNotifLoad = true;
const qNotifs = query(collection(db, "notifications"), where("receiverId", "==", currentUser.id));
onSnapshot(qNotifs, (snapshot) => {
notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), timestamp: doc.data().timestamp }));
notifications.sort((a,b) => (b.timestamp?.toDate ? b.timestamp.toDate() : 0) - (a.timestamp?.toDate ? a.timestamp.toDate() : 0));

const badge = document.getElementById('nav-notif-badge');
const unread = notifications.some(n => !n.read);
if(badge) {
if(unread) badge.style.display = 'block';
else badge.style.display = 'none';
}

// Notification Sound Logic
if(!isFirstNotifLoad) {
    snapshot.docChanges().forEach(change => {
        if(change.type === 'added') {
            const n = change.doc.data();
            if(!n.read && (Date.now() - (n.timestamp ? n.timestamp.toMillis() : Date.now())) < 5000) {
                notifAudio.play().catch(e => console.log('Audio error:', e));
            }
        }
    });
}
isFirstNotifLoad = false;

const activeNotif = document.querySelector('#view-notifications:not(.hidden)');
if(activeNotif) renderNotifications();
refreshIcons();
});

}

function updateUserInterface() {
if(!currentUser) return;
const nameEl = document.getElementById('sidebar-name'); if(nameEl) nameEl.innerText = currentUser.name;
const avEl = document.getElementById('sidebar-avatar'); if(avEl) avEl.src = currentUser.avatar;
const mobAv = document.getElementById('mobile-avatar'); if(mobAv) mobAv.src = currentUser.avatar;
const headAv = document.getElementById('header-avatar'); if(headAv) headAv.src = currentUser.avatar;
const compName = document.getElementById('compose-name'); if(compName) compName.innerText = currentUser.name;
const compAv = document.getElementById('compose-avatar'); if(compAv) compAv.src = currentUser.avatar;
const commAv = document.getElementById('comment-input-avatar'); if(commAv) commAv.src = currentUser.avatar;
const commAvMob = document.getElementById('comment-input-avatar-mobile'); if(commAvMob) commAvMob.src = currentUser.avatar;
const edName = document.getElementById('edit-name'); if(edName) edName.value = currentUser.name;
const edBio = document.getElementById('edit-bio'); if(edBio) edBio.value = currentUser.bio;
const edAv = document.getElementById('edit-avatar-preview'); if(edAv) edAv.src = currentUser.avatar;
const edBanner = document.getElementById('edit-banner-link'); if(edBanner) edBanner.value = currentUser.banner || '';
const threadAv = document.getElementById('thread-input-avatar'); if(threadAv) threadAv.src = currentUser.avatar;

const bannerPos = currentUser.bannerPos || 50;
const bannerUrl = currentUser.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
document.getElementById('edit-banner-preview').src = bannerUrl;
document.getElementById('edit-banner-preview').style.objectPosition = `center ${bannerPos}%`;
document.getElementById('banner-pos-hint').innerText = `${bannerPos}%`;

const togglePrivacy = document.getElementById('toggle-privacy');
if(togglePrivacy) {
if(currentUser.settings?.privateNetwork) togglePrivacy.classList.add('active');
else togglePrivacy.classList.remove('active');
}

if(currentUser.email === 'edulinkbht@gmail.com') {
const nav = document.querySelector('#desktop-nav-items');
if(!document.getElementById('nav-announcements')) {
const adminLink = document.createElement('a');
adminLink.href = "#";
adminLink.id = "nav-announcements";
adminLink.className = "nav-item text-blue-600";
adminLink.innerHTML = `<i data-lucide="megaphone" class="w-5 h-5"></i> <span class="hidden lg:block">Announcements</span>`;
adminLink.onclick = function() { switchView('announcements'); return false; };
nav.appendChild(adminLink);
}
}
refreshIcons();
}

let alertCallback = null;
window.showAlert = function(message, onConfirm) {
document.getElementById('alert-msg').innerText = message;
document.getElementById('custom-alert').classList.remove('hidden');
setTimeout(() => {
document.getElementById('custom-alert').classList.remove('opacity-0');
document.getElementById('custom-alert-box').classList.remove('scale-95');
}, 10);
alertCallback = onConfirm;
const confirmBtn = document.getElementById('alert-confirm-btn');
const newBtn = confirmBtn.cloneNode(true);
confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
newBtn.onclick = () => { if (alertCallback) alertCallback(); closeAlert(true); };
}

window.closeAlert = function(confirmed) {
document.getElementById('custom-alert').classList.add('opacity-0');
document.getElementById('custom-alert-box').classList.add('scale-95');
setTimeout(() => { document.getElementById('custom-alert').classList.add('hidden'); }, 200);
}

let isDraggingBanner = false;
let startY = 0;
let initialBannerPos = 50;
let currentBannerPos = 50;

function initBannerDrag() {
const container = document.getElementById('banner-edit-area');
container.addEventListener('mousedown', startDrag);
container.addEventListener('touchstart', startDrag, {passive: false});
window.addEventListener('mousemove', drag);
window.addEventListener('touchmove', drag, {passive: false});
window.addEventListener('mouseup', endDrag);
window.addEventListener('touchend', endDrag);
}

function startDrag(e) {
if(e.target.closest('#banner-edit-area')) {
isDraggingBanner = true;
startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
initialBannerPos = currentBannerPos;
}
}

function drag(e) {
if (!isDraggingBanner) return;
if(e.cancelable) e.preventDefault();
const y = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
const deltaY = startY - y;
const percentChange = (deltaY / 2);
let newPos = initialBannerPos + percentChange;
newPos = Math.max(0, Math.min(100, newPos));
currentBannerPos = Math.round(newPos);
document.getElementById('edit-banner-preview').style.objectPosition = `center ${currentBannerPos}%`;
document.getElementById('banner-pos-hint').innerText = `${currentBannerPos}%`;
}

function endDrag() { isDraggingBanner = false; }

window.openSettings = function() { document.getElementById('settings-overlay').classList.remove('hidden'); }
window.closeSettings = function() { document.getElementById('settings-overlay').classList.add('hidden'); }

window.togglePrivacy = async function() {
const toggle = document.getElementById('toggle-privacy');
const isPrivate = !toggle.classList.contains('active');
toggle.classList.toggle('active');
const settings = currentUser.settings || {};
settings.privateNetwork = isPrivate;
const userRef = doc(db, "users", currentUser.id);
await updateDoc(userRef, { settings: settings });
currentUser.settings = settings;
showToast(`Account is now ${isPrivate ? 'Private' : 'Public'}`);
}

window.switchView = function(viewName) {
const views = ['feed', 'events', 'saved', 'network', 'profile', 'explore', 'notifications', 'announcements'];
views.forEach(v => {
const el = document.getElementById(`view-${v}`);
if(el) el.classList.add('hidden');
});

const aiPanel = document.getElementById('ai-panel');
const mainPanel = document.getElementById('main-panel');
const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
const desktopNavItems = document.querySelectorAll('.nav-item');
const mainHeader = document.getElementById('main-header');
const mobileBottomNav = document.getElementById('mobile-bottom-nav');
const mobileNotifHeader = document.getElementById('mobile-notifications-header');
const mobileExploreHeader = document.getElementById('mobile-explore-header');

// Global Main Header Reset (Shows by default)
if(mainHeader) {
    mainHeader.classList.remove('hidden');
    mainHeader.style.transform = 'translateY(0)';
}
if(mobileBottomNav) mobileBottomNav.classList.remove('hidden');
if(mobileNotifHeader) mobileNotifHeader.classList.add('hidden', 'flex'); 
if(mobileExploreHeader) mobileExploreHeader.classList.add('hidden');

// HIDE MAIN HEADER ON PROFILE VIEW (Desktop & Mobile)
if (viewName === 'profile') {
    if(mainHeader) mainHeader.classList.add('hidden');
}

// Handle Mobile Specific Header/Footer Logic
if (window.innerWidth < 768) {
    if (viewName === 'notifications') {
        if(mainHeader) mainHeader.classList.add('hidden');
        // Footer (mobileBottomNav) is kept VISIBLE for notifications
        if(mobileNotifHeader) mobileNotifHeader.classList.remove('hidden');
        if(mobileNotifHeader) mobileNotifHeader.classList.add('flex');
    } else if (viewName === 'explore') {
        if(mainHeader) mainHeader.classList.add('hidden');
        if(mobileBottomNav) mobileBottomNav.classList.add('hidden');
        if(mobileExploreHeader) mobileExploreHeader.classList.remove('hidden');
    }
}

if (window.innerWidth < 768) {
if (viewName === 'ai') {
mainPanel.classList.add('hidden');
aiPanel.classList.remove('hidden');
aiPanel.classList.add('flex');
} else {
mainPanel.classList.remove('hidden');
aiPanel.classList.add('hidden');
aiPanel.classList.remove('flex');
}
}

if(viewName !== 'ai') {
const target = document.getElementById(`view-${viewName}`);
if(target) target.classList.remove('hidden');
}

if (window.innerWidth >= 1280 && viewName !== 'ai') {
aiPanel.classList.add('xl:flex');
aiPanel.classList.remove('hidden');
}

desktopNavItems.forEach(el => el.classList.remove('active'));
mobileNavItems.forEach(el => el.classList.remove('active'));

if(viewName === 'feed') {
const nav = document.getElementById('nav-feed'); if(nav) nav.classList.add('active');
if(mobileNavItems[0]) mobileNavItems[0].classList.add('active');
if(document.getElementById('feed-container').children.length === 0) renderFeed();
} else if (viewName === 'explore') {
const nav = document.getElementById('nav-explore'); if(nav) nav.classList.add('active');
if(mobileNavItems[1]) mobileNavItems[1].classList.add('active');
handleSearch(document.getElementById('mobile-explore-search').value);
} else if (viewName === 'network') {
const nav = document.getElementById('nav-network'); if(nav) nav.classList.add('active');
if(document.getElementById('network-content').children.length === 0) renderNetwork();
} else if (viewName === 'notifications') {
const nav = document.getElementById('nav-notifications'); if(nav) nav.classList.add('active');
if(mobileNavItems[3]) mobileNavItems[3].classList.add('active');
if(document.getElementById('notification-list').children.length === 0) renderNotifications();
const badge = document.getElementById('nav-notif-badge');
if(badge) badge.style.display = 'none';
} else if (viewName === 'saved') {
const nav = document.getElementById('nav-saved'); if(nav) nav.classList.add('active');
if(document.getElementById('saved-container').children.length === 0) renderSaved();
} else if (viewName === 'ai') {
// No mobile nav item for AI directly, usually accessed via button or gesture
} else if (viewName === 'announcements') {
const nav = document.getElementById('nav-announcements'); if(nav) nav.classList.add('active');
}
setTimeout(refreshIcons, 10);
}

window.switchNetworkTab = function(tab) {
activeNetworkTab = tab;
document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
const btn = document.getElementById(`net-tab-${tab}`);
if(btn) btn.classList.add('active');
renderNetwork();
}

window.renderNetwork = function() {
const container = document.getElementById('network-content');
container.innerHTML = "";

if (activeNetworkTab === 'people') {
const grid = document.createElement('div');
grid.className = "grid grid-cols-1 md:grid-cols-2 gap-4 px-4 md:px-0";

if (!currentUser || !currentUser.following) {
container.innerHTML += `<div class="flex flex-col items-center justify-center py-10 opacity-60"><p>Loading...</p></div>`;
return;
}

const followingUsers = users.filter(u => currentUser.following.includes(u.id));

if(followingUsers.length === 0) {
container.innerHTML += `<div class="flex flex-col items-center justify-center py-10 opacity-60"><p>You aren't following anyone yet.</p></div>`;
return;
}

followingUsers.forEach(user => {
const card = document.createElement('div');
card.className = "bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 hover:shadow-md transition-all cursor-pointer";
card.onclick = () => showProfile(user.id);
card.innerHTML = `
<img src="${user.avatar}" class="w-12 h-12 rounded-full border border-gray-100 bg-gray-50 object-cover">
<div>
<h4 class="font-bold text-gray-900">${user.name} ${user.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 inline text-blue-500"></i>' : ''}</h4>
<p class="text-xs text-gray-500 line-clamp-1">${user.bio}</p>
</div>
<button onclick="event.stopPropagation(); toggleFollow('${user.id}')" class="ml-auto text-xs border border-gray-200 px-3 py-1 rounded-full hover:bg-gray-50">Unfollow</button>
`;
grid.appendChild(card);
});
container.appendChild(grid);
} else {
const followingPosts = posts.filter(p => currentUser.following.includes(p.authorId));
const postsContainer = document.createElement('div');
postsContainer.className = "space-y-4 px-4 md:px-0";

if (followingPosts.length === 0) {
postsContainer.innerHTML = `<div class="text-center py-10 text-gray-400">No posts from your network yet.</div>`;
} else {
followingPosts.forEach(post => postsContainer.appendChild(createPostElement(post)));
}
container.appendChild(postsContainer);
}
refreshIcons();
}

window.renderFeed = function(filterTerm = "") {
const container = document.getElementById('feed-container');
container.innerHTML = "";
let displayPosts = [...posts];
if(filterTerm) {
const term = filterTerm.toLowerCase();
displayPosts = displayPosts.filter(p => p.content.toLowerCase().includes(term));
}

displayPosts = displayPosts.filter(p => {
const isAuthor = p.authorId === currentUser.id;
const author = users.find(u => u.id === p.authorId);
const isPublicPost = !p.settings || p.settings.privacy === 'public';
const isPrivateAccount = author?.settings?.privateNetwork;
const amFollowing = currentUser.following.includes(p.authorId);

if (isAuthor) return true;
if (isPrivateAccount) return amFollowing;
if (!isPublicPost) return amFollowing;

return true;
});

displayPosts.forEach(post => container.appendChild(createPostElement(post)));
refreshIcons();
}

function createPostElement(post) {
const author = users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '', isOfficial: false, id: post.authorId };
const isLiked = post.likes ? post.likes.includes(currentUser.id) : false;
const isSaved = savedPosts.includes(post.id);
const dateStr = formatDate(post.timestamp);
const settings = post.settings || { privacy: 'public', showLikes: true, showComments: true, allowLikeView: true, allowComments: true };
const div = document.createElement('article');
div.className = "post-card group overflow-hidden fade-in";
div.onclick = () => openPostView(post.id);

let mediaHTML = "";
if (post.media) {
const isVideo = post.media.startsWith('data:video') || post.media.includes('.mp4') || post.media.includes('.webm');
mediaHTML = isVideo
? `<div class="mt-3 rounded-xl overflow-hidden relative cursor-pointer group-video" onclick="event.stopPropagation(); openLightbox('${post.id}')">
    <video src="${post.media}" class="w-full max-h-[400px] object-cover"></video>
    <div class="absolute top-2 right-2 bg-black/60 p-1.5 rounded-full text-white pointer-events-none"><i data-lucide="maximize-2" class="w-4 h-4"></i></div>
    <div class="absolute inset-0 flex items-center justify-center pointer-events-none"><i data-lucide="play" class="w-12 h-12 text-white fill-white/20"></i></div>
   </div>`
: `<div class="mt-3 rounded-xl overflow-hidden cursor-pointer" onclick="event.stopPropagation(); openLightbox('${post.id}')">
<img src="${post.media}" class="w-full max-h-[400px] object-cover bg-gray-50">
</div>`;
}

// Updated Hashtag Parsing with Click Handler
let tagsHTML = marked.parse(post.content.replace(/#(\w+)/g, '<span class="hashtag" onclick="event.stopPropagation(); openHashtag(\'$1\')">#$1</span>'));
let officialBadge = author.isOfficial ? `<i data-lucide="badge-check" class="w-4 h-4 official-badge text-blue-500 ml-1"></i>` : '';
let lockIcon = settings.privacy === 'private' || author?.settings?.privateNetwork ? `<i data-lucide="lock" class="w-3 h-3 text-gray-400 ml-1"></i>` : '';

const canViewLikeList = settings.allowLikeView === undefined || settings.allowLikeView === true || author.id === currentUser.id || currentUser.email === 'edulinkbht@gmail.com';
const likeCountDisplay = settings.showLikes
? `<span id="like-count-${post.id}" class="text-xs font-medium px-1 hover:underline cursor-pointer" onclick="${canViewLikeList ? `event.stopPropagation(); openLikes('${post.id}')` : 'event.stopPropagation()'}">${post.likes ? post.likes.length : 0}</span>`
: '';
const commentCountDisplay = settings.showComments ? `<span id="comment-count-${post.id}" class="text-xs font-medium">${post.comments ? post.comments.length : 0}</span>` : '';

// Collab Display Logic - ONLY SHOW ACCEPTED COLLABORATORS
let acceptedCollabs = [];
if(post.collaborators) {
    acceptedCollabs = post.collaborators.filter(c => c.status === 'accepted');
}

let collabIcon = '';
if(acceptedCollabs.length > 0) {
    collabIcon = `<div class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-lg ml-2 cursor-pointer hover:bg-gray-200 transition-colors" onclick="event.stopPropagation(); openCollabList('${post.id}')">
    <i data-lucide="user" class="w-3 h-3 text-gray-600"></i>
    <span class="text-xs font-bold text-gray-600">${acceptedCollabs.length}</span>
    </div>`;
}

div.innerHTML = `
<div class="p-4 md:p-5">
<div class="post-header">
<div class="flex gap-3">
<div class="post-avatar-container">
<img src="${author.avatar}" class="post-avatar">
</div>
<div>
<div class="flex items-center">
<span class="post-author-name" onclick="event.stopPropagation(); showProfile('${author.id}')">${author.name}</span>
${officialBadge}
${lockIcon}
${collabIcon}
</div>
<div class="post-meta flex items-center">${dateStr}</div>
</div>
</div>
<button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event, '${post.id}', '${author.id}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
</div>
<div class="post-content">
<div class="post-body" data-raw-text="${post.content.replace(/"/g, '&quot;')}">${tagsHTML}</div>
${mediaHTML}
</div>
<div class="post-actions">
<div class="flex items-center gap-1">
<button id="like-btn-${post.id}" class="action-btn like" onclick="event.stopPropagation(); toggleLike('${post.id}')">
<i data-lucide="heart" class="w-5 h-5 ${isLiked ? 'fill-red-500 text-red-500' : ''}"></i>
</button>
${likeCountDisplay}
<button class="action-btn comment ml-2" onclick="event.stopPropagation(); openPostView('${post.id}')"><i data-lucide="message-square" class="w-5 h-5"></i> ${commentCountDisplay}</button>
</div>
<div class="flex items-center gap-1">
<button id="save-btn-${post.id}" class="action-btn bookmark" onclick="event.stopPropagation(); toggleSave('${post.id}')"><i data-lucide="bookmark" class="w-5 h-5 ${isSaved ? 'fill-yellow-500 text-yellow-500' : ''}"></i></button>
<button class="action-btn share-btn" onclick="event.stopPropagation(); sharePost('${post.id}')" title="Share Post"><i data-lucide="share-2" class="w-5 h-5"></i></button>
</div>
</div>
</div>
`;
return div;
}

window.openHashtag = function(tag) {
    if(!tag) return;
    const searchVal = `#${tag}`;
    switchView('explore');
    
    // Update inputs
    const headerInput = document.getElementById('global-search');
    const mobileInput = document.getElementById('mobile-explore-search');
    if(headerInput) headerInput.value = searchVal;
    if(mobileInput) mobileInput.value = searchVal;

    // Force Tags tab
    window.activeExploreTab = 'tags';
    handleSearch(searchVal);
}

window.openCollabSelector = function() {
    const overlay = document.getElementById('user-list-overlay');
    const title = document.getElementById('user-list-title');
    const content = document.getElementById('user-list-content');
    
    title.innerText = "Tag Collaborators";
    content.innerHTML = '';
    
    // Only show people user follows or searches for logic could be added here
    // For now, show friends/following
    const relevantUsers = users.filter(u => u.id !== currentUser.id && (currentUser.following.includes(u.id) || currentUser.followers.includes(u.id)));
    
    if(relevantUsers.length === 0) {
        content.innerHTML = `<div class="text-center text-gray-400 py-8">No contacts found to tag.</div>`;
    } else {
        relevantUsers.forEach(u => {
            const isSelected = window.selectedCollaborators.find(sc => sc.id === u.id);
            const div = document.createElement('div');
            div.className = `flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer ${isSelected ? 'bg-gray-100' : ''}`;
            div.onclick = () => toggleCollaborator(u);
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
                    <div>
                        <div class="font-bold text-sm text-gray-900">${u.name}</div>
                        <div class="text-xs text-gray-500">@${u.username || 'user'}</div>
                    </div>
                </div>
                ${isSelected ? '<i data-lucide="check" class="text-gray-600 w-5 h-5"></i>' : ''}
            `;
            content.appendChild(div);
        });
    }
    
    overlay.classList.remove('hidden');
    refreshIcons();
}

window.toggleCollaborator = function(user) {
    const idx = window.selectedCollaborators.findIndex(u => u.id === user.id);
    if(idx > -1) {
        window.selectedCollaborators.splice(idx, 1);
    } else {
        // Initialize as pending
        window.selectedCollaborators.push({ id: user.id, name: user.name, avatar: user.avatar, username: user.username, status: 'pending' });
    }
    closeUserList(); // Close list after selection or re-render list? Let's just update UI
    openCollabSelector(); // Re-render to show checkmark
    renderCollabChips();
}

window.renderCollabChips = function() {
    const container = document.getElementById('collab-chips-container');
    container.innerHTML = '';
    window.selectedCollaborators.forEach(u => {
        const chip = document.createElement('div');
        chip.className = 'collab-chip';
        chip.innerHTML = `
            <img src="${u.avatar}" class="w-4 h-4 rounded-full mr-2">
            <span>${u.name}</span>
            <i onclick="event.stopPropagation(); removeCollaborator('${u.id}')" data-lucide="x" class="w-3 h-3 ml-2 text-gray-500 hover:text-red-500 cursor-pointer"></i>
        `;
        container.appendChild(chip);
    });
    refreshIcons();
}

window.removeCollaborator = function(id) {
    window.selectedCollaborators = window.selectedCollaborators.filter(u => u.id !== id);
    renderCollabChips();
}

window.openCollabList = function(postId) {
    const post = posts.find(p => p.id === postId);
    if(!post || !post.collaborators) return;
    
    const overlay = document.getElementById('user-list-overlay');
    const title = document.getElementById('user-list-title');
    const content = document.getElementById('user-list-content');
    
    title.innerText = "Collaborators";
    content.innerHTML = '';
    
    const accepted = post.collaborators.filter(c => c.status === 'accepted');
    
    accepted.forEach(c => {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer";
        div.onclick = () => { closeUserList(); showProfile(c.id); };
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <img src="${c.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
                <div>
                    <div class="font-bold text-sm text-gray-900">${c.name}</div>
                    <div class="text-xs text-gray-500">@${c.username || 'user'}</div>
                </div>
            </div>
        `;
        content.appendChild(div);
    });
    
    overlay.classList.remove('hidden');
}

window.toggleLike = async function(postId) {
const btn = document.getElementById(`like-btn-${postId}`);
const countSpan = document.getElementById(`like-count-${postId}`);

if(btn) {
const icon = btn.querySelector('svg') || btn.querySelector('i');
let isLiked = false;

if (icon.tagName === 'svg') isLiked = icon.classList.contains('text-red-500');
else isLiked = icon.classList.contains('text-red-500');

if (isLiked) {
icon.classList.remove('fill-red-500', 'text-red-500');
if(countSpan) {
const current = parseInt(countSpan.innerText) || 0;
countSpan.innerText = Math.max(0, current - 1);
}
} else {
icon.classList.add('fill-red-500', 'text-red-500');
if(countSpan) {
const current = parseInt(countSpan.innerText) || 0;
countSpan.innerText = current + 1;
}
}
}

const postRef = doc(db, "posts", postId);
const post = posts.find(p => p.id === postId);
if(post.likes && post.likes.includes(currentUser.id)) {
await updateDoc(postRef, { likes: arrayRemove(currentUser.id) });
} else {
await updateDoc(postRef, { likes: arrayUnion(currentUser.id) });
if(post.authorId !== currentUser.id) {
sendNotification(post.authorId, 'like', 'liked your post', postId);
}
}
}

window.openLikes = function(postId) {
const post = posts.find(p => p.id === postId);
if(!post) return;

const overlay = document.getElementById('likes-overlay');
const content = document.getElementById('likes-list-content');
content.innerHTML = '';

const likeIds = post.likes || [];

if(likeIds.length === 0) {
content.innerHTML = `<div class="text-center text-gray-400 py-8">No likes yet.</div>`;
} else {
likeIds.forEach(uid => {
const user = users.find(u => u.id === uid);
if(user) {
const div = document.createElement('div');
div.className = "flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl cursor-pointer";
div.onclick = () => {
document.getElementById('likes-overlay').classList.add('hidden');
showProfile(user.id);
};
div.innerHTML = `
<img src="${user.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover">
<div>
<div class="font-bold text-sm text-gray-900">${user.name}</div>
<div class="text-xs text-gray-500 truncate w-32">${user.bio}</div>
</div>
`;
content.appendChild(div);
}
});
}
overlay.classList.remove('hidden');
}

window.closeLikes = function() {
document.getElementById('likes-overlay').classList.add('hidden');
}

window.toggleSave = async function(postId) {
const btn = document.getElementById(`save-btn-${postId}`);
if(btn) {
const icon = btn.querySelector('svg') || btn.querySelector('i');
let hasClass = false;
if(icon.tagName === 'svg') hasClass = icon.classList.contains('text-yellow-500');
else hasClass = icon.classList.contains('text-yellow-500');

if (hasClass) {
icon.classList.remove('fill-yellow-500', 'text-yellow-500');
showToast("Post removed");
} else {
icon.classList.add('fill-yellow-500', 'text-yellow-500');
showToast("Post saved");
}
}

const userRef = doc(db, "users", currentUser.id);
if(savedPosts.includes(postId)) {
await updateDoc(userRef, { saved: arrayRemove(postId) });
savedPosts = savedPosts.filter(id => id !== postId);
} else {
await updateDoc(userRef, { saved: arrayUnion(postId) });
savedPosts.push(postId);
}
}

window.sharePost = function(postId) {
const url = `${window.location.origin}${window.location.pathname}?postId=${postId}`;
navigator.clipboard.writeText(url).then(() => { showToast("Link copied to clipboard!"); });
}

window.renderSaved = function() {
const container = document.getElementById('saved-container');
container.innerHTML = "";
if(savedPosts.length === 0) {
container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60"><i data-lucide="bookmark" class="w-16 h-16 mb-2"></i><p>No saved posts yet</p></div>`;
} else {
const saved = posts.filter(p => savedPosts.includes(p.id));
saved.forEach(post => container.appendChild(createPostElement(post)));
}
refreshIcons();
}

async function sendNotification(receiverId, type, content, postId = null) {
await addDoc(collection(db, "notifications"), {
receiverId,
senderId: currentUser.id,
type,
content,
timestamp: serverTimestamp(),
read: false,
postId: postId
});
}

window.switchNotifTab = function(tab) {
activeNotifTab = tab;
document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
const mainBtn = document.getElementById(`ntab-${tab}`);
const mobileBtn = document.getElementById(`ntab-${tab}-mobile`);
if(mainBtn) mainBtn.classList.add('active');
if(mobileBtn) mobileBtn.classList.add('active');
renderNotifications();
}

// Notification Logic
window.toggleNotifMenu = function() {
    const menu = document.getElementById('notif-menu-dropdown');
    menu.classList.toggle('hidden');
    menu.classList.toggle('flex');
}

window.toggleNotifSelection = function() {
    window.notifSelectionMode = !window.notifSelectionMode;
    if(!window.notifSelectionMode) window.selectedNotifs.clear();
    toggleNotifMenu();
    renderNotifications();
}

window.handleNotifSearch = function(val) {
    window.notifSearchTerm = val.toLowerCase();
    renderNotifications();
}

window.deleteSelectedNotifs = async function() {
    if(window.selectedNotifs.size === 0) { showToast("No items selected"); return; }
    showAlert(`Delete ${window.selectedNotifs.size} notifications?`, async () => {
        const batch = writeBatch(db);
        window.selectedNotifs.forEach(id => {
            const ref = doc(db, "notifications", id);
            batch.delete(ref);
        });
        await batch.commit();
        window.notifSelectionMode = false;
        window.selectedNotifs.clear();
        toggleNotifMenu();
        showToast("Deleted");
    });
}

window.toggleNotifSelect = function(id) {
    if(window.selectedNotifs.has(id)) window.selectedNotifs.delete(id);
    else window.selectedNotifs.add(id);
    renderNotifications(); // Re-render to update checkboxes
}

window.renderNotifications = function() {
const container = document.getElementById('notification-list');
container.innerHTML = "";

let filtered = notifications.filter(n => {
    // Tab Filter
    let tabMatch = false;
    if (activeNotifTab === 'official') {
        tabMatch = n.type === 'official';
    } else if (activeNotifTab === 'friends') {
        tabMatch = currentUser.following.includes(n.senderId) || n.type === 'follow_request' || n.type === 'message_request' || n.type === 'collab_request';
    } else {
        tabMatch = n.type !== 'official' && !currentUser.following.includes(n.senderId) && n.type !== 'follow_request' && n.type !== 'message_request' && n.type !== 'collab_request';
    }
    
    // Search Filter
    if(window.notifSearchTerm) {
        const sender = users.find(u => u.id === n.senderId) || { name: 'Admin' };
        const contentMatch = n.content.toLowerCase().includes(window.notifSearchTerm);
        const nameMatch = sender.name.toLowerCase().includes(window.notifSearchTerm);
        return tabMatch && (contentMatch || nameMatch);
    }
    
    return tabMatch;
});

if (filtered.length === 0) {
container.innerHTML = `<div class="text-center text-xs text-gray-400 py-4">No notifications here</div>`;
return;
}

filtered.forEach(n => {
const sender = users.find(u => u.id === n.senderId) || { name: 'Admin', avatar: '' };
const div = document.createElement('div');
div.className = "w-full flex items-center gap-3 p-3 border-b border-gray-100 bg-white group relative transition-colors hover:bg-gray-50";
let icon = "";
if(n.type === 'like') icon = '<i data-lucide="heart" class="w-3 h-3 text-white"></i>';
if(n.type === 'comment') icon = '<i data-lucide="message-circle" class="w-3 h-3 text-white"></i>';
if(n.type === 'reply') icon = '<i data-lucide="corner-down-right" class="w-3 h-3 text-white"></i>';
if(n.type === 'follow') icon = '<i data-lucide="user-plus" class="w-3 h-3 text-white"></i>';
if(n.type === 'official') icon = '<i data-lucide="megaphone" class="w-3 h-3 text-white"></i>';
if(n.type === 'follow_request') icon = '<i data-lucide="lock" class="w-3 h-3 text-white"></i>';
if(n.type === 'message_request') icon = '<i data-lucide="mail" class="w-3 h-3 text-white"></i>';
if(n.type === 'collab_request') icon = '<i data-lucide="users" class="w-3 h-3 text-white"></i>';

let colorClass = n.type === 'like' ? 'bg-red-500' : (n.type === 'official' ? 'bg-blue-600' : 'bg-indigo-500');
if(n.type === 'reply') colorClass = 'bg-teal-500';
if(n.type === 'follow_request' || n.type === 'message_request' || n.type === 'collab_request') colorClass = 'bg-orange-500';

let clickAction = (n.type === 'like' || n.type === 'comment' || n.type === 'reply') && n.postId
? `onclick="if(!window.notifSelectionMode) openPostView('${n.postId}')"`
: `onclick="if(!window.notifSelectionMode) showProfile('${sender.id}')"`;

let actionButtons = '';
if(n.type === 'follow_request') {
actionButtons = `<div class="flex gap-2 ml-auto"><button onclick="acceptFollow('${n.id}', '${sender.id}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold">Accept</button><button onclick="deleteNotification('${n.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-bold">Delete</button></div>`;
clickAction = '';
}

if(n.type === 'collab_request') {
actionButtons = `<div class="flex gap-2 ml-auto"><button onclick="acceptCollab('${n.id}', '${n.postId}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold">Accept</button><button onclick="declineCollab('${n.id}', '${n.postId}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-full font-bold">Decline</button></div>`;
clickAction = '';
}

if(n.type === 'message_request') {
actionButtons = `<div class="flex gap-2 ml-auto"><button onclick="acceptMessage('${n.id}', '${sender.id}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-bold">Chat</button></div>`;
clickAction = '';
}

// Selection Checkbox
let checkboxHTML = '';
if(window.notifSelectionMode) {
    const isChecked = window.selectedNotifs.has(n.id) ? 'checked' : '';
    checkboxHTML = `<input type="checkbox" ${isChecked} onchange="toggleNotifSelect('${n.id}')" class="mr-2 w-5 h-5 accent-blue-600 cursor-pointer">`;
    clickAction = ''; // Disable navigation when selecting
}

div.innerHTML = `
${checkboxHTML}
<div class="relative cursor-pointer" onclick="if(!window.notifSelectionMode) showProfile('${sender.id}')">
<img src="${sender.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
<div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${colorClass} flex items-center justify-center border-2 border-white">${icon}</div>
</div>
<div class="flex-1 cursor-pointer" ${clickAction}>
<div class="text-sm">
<span class="font-bold text-gray-900">${sender.name}</span>
<span class="text-gray-600">${n.content}</span>
</div>
<div class="text-xs text-gray-400 mt-0.5">${formatDate(n.timestamp)}</div>
</div>
${!window.notifSelectionMode ? (actionButtons ? actionButtons : `<button onclick="deleteNotification('${n.id}')" class="p-2 text-gray-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>`) : ''}
`;
container.appendChild(div);
});
refreshIcons();
}

window.deleteNotification = async function(id) {
showAlert("Delete this notification?", async () => {
await deleteDoc(doc(db, "notifications", id));
});
}

window.acceptCollab = async function(notifId, postId) {
    const postRef = doc(db, "posts", postId);
    const postSnap = await getDoc(postRef);
    if(postSnap.exists()) {
        const post = postSnap.data();
        let collabs = post.collaborators || [];
        const idx = collabs.findIndex(c => c.id === currentUser.id);
        if(idx > -1) {
            collabs[idx].status = 'accepted';
            await updateDoc(postRef, { collaborators: collabs });
            showToast("Collaboration Accepted!");
        }
    }
    await deleteDoc(doc(db, "notifications", notifId));
}

window.declineCollab = async function(notifId, postId) {
    const postRef = doc(db, "posts", postId);
    const postSnap = await getDoc(postRef);
    if(postSnap.exists()) {
        const post = postSnap.data();
        let collabs = post.collaborators || [];
        collabs = collabs.filter(c => c.id !== currentUser.id); // Remove user from collab list
        await updateDoc(postRef, { collaborators: collabs });
        showToast("Collaboration Declined");
    }
    await deleteDoc(doc(db, "notifications", notifId));
}

window.acceptFollow = async function(notifId, senderId) {
const meRef = doc(db, "users", currentUser.id);
await updateDoc(meRef, { followers: arrayUnion(senderId) });
const senderRef = doc(db, "users", senderId);
await updateDoc(senderRef, { following: arrayUnion(currentUser.id) });
await deleteDoc(doc(db, "notifications", notifId));
await sendNotification(senderId, 'follow', 'accepted your follow request');
showToast("Follow request accepted");
}

window.acceptMessage = async function(notifId, senderId) {
await deleteDoc(doc(db, "notifications", notifId));
// Chat is removed, so we just acknowledge
showToast("Request accepted");
}

window.clearAllNotifications = async function() {
showAlert("Clear all notifications?", async () => {
const batch = writeBatch(db);
const q = query(collection(db, "notifications"), where("receiverId", "==", currentUser.id));
const snap = await getDocs(q);
snap.forEach(d => batch.delete(d.ref));
await batch.commit();
showToast("All notifications cleared");
});
}

window.toggleNotifications = function() {
switchView('notifications');
const badge = document.getElementById('nav-notif-badge');
if(badge) badge.style.display = 'none';
}

window.showProfile = function(userId, tab = 'posts') {
if(!userId) userId = currentUser.id;
const user = users.find(u => u.id === userId);
if(!user) return;

window.currentViewingProfileId = userId;
window.currentProfileTab = tab;
const container = document.getElementById('view-profile');

// Hide main header logic moved to switchView

const isMe = userId === currentUser.id;
const isFollowing = currentUser.following ? currentUser.following.includes(userId) : false;

let actionBtn = "";
if (isMe) {
actionBtn = `<button onclick="openEditProfile()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">Edit Profile</button>`;
} else {
const isPrivate = user.settings?.privateNetwork;
let btnText = isFollowing ? 'Following' : (isPrivate ? 'Request' : 'Follow');

const existingBtn = document.getElementById('profile-follow-btn');
if(existingBtn && existingBtn.innerText === 'Requested' && !isFollowing) {
btnText = 'Requested';
}

actionBtn = `
<div class="flex gap-2">
<button id="profile-follow-btn" onclick="toggleFollow('${userId}')" class="${isFollowing ? 'bg-gray-100 text-gray-700' : 'bg-[#0b57d0] text-white'} px-4 py-2 rounded-lg font-bold text-sm transition-colors">${btnText}</button>
</div>
`;
}

const bannerUrl = user.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
const bannerPos = user.bannerPos || 50;

let networkStatsHTML = '';
const isPrivate = user.settings?.privateNetwork;
if(isMe || !isPrivate || isFollowing) {
networkStatsHTML = `
<div class="flex gap-4 mt-3 text-sm text-gray-500">
<span class="cursor-pointer hover:underline" onclick="openUserList('following', '${userId}')"><strong class="text-gray-900">${user.following ? user.following.length : 0}</strong> Following</span>
<span class="cursor-pointer hover:underline" onclick="openUserList('followers', '${userId}')"><strong class="text-gray-900">${user.followers ? user.followers.length : 0}</strong> Followers</span>
</div>`;
} else {
networkStatsHTML = `<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="italic"><i data-lucide="lock" class="w-3 h-3 inline"></i> Private Account</span></div>`;
}

// TABS LOGIC - ICONS
let tabsHTML = `
<div class="tab-group mb-0">
    <button onclick="switchProfileTab('posts')" class="tab-btn ${tab==='posts'?'active':''}"><i data-lucide="grid" class="w-5 h-5"></i></button>
    ${isMe ? `<button onclick="switchProfileTab('saved')" class="tab-btn ${tab==='saved'?'active':''}"><i data-lucide="bookmark" class="w-5 h-5"></i></button>` : ''}
    <button onclick="switchProfileTab('liked')" class="tab-btn ${tab==='liked'?'active':''}"><i data-lucide="heart" class="w-5 h-5"></i></button>
    <button onclick="switchProfileTab('tagged')" class="tab-btn ${tab==='tagged'?'active':''}"><i data-lucide="user-check" class="w-5 h-5"></i></button>
</div>
`;

container.innerHTML = `
<div class="profile-banner-container"><img src="${bannerUrl}" class="profile-banner-img" style="object-position: center ${bannerPos}%"></div>
<div class="px-4 md:px-6 relative">
<div class="flex justify-between items-end -mt-10 mb-4"><img src="${user.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover">${actionBtn}</div>
<div class="mb-6"><h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">${user.name} ${user.isOfficial ? '<i data-lucide="badge-check" class="text-blue-600 w-6 h-6"></i>':''}</h1>
<div class="text-sm font-medium text-gray-500">@${user.username || 'user'}</div>
<p class="text-gray-600 mt-2">${user.bio}</p>${networkStatsHTML}</div>
${tabsHTML}
<div id="profile-content-area" class="pt-1 md:pt-4 pb-20 md:pb-0"></div>
</div>
`;

switchView('profile');
renderProfileContent(userId, tab);
refreshIcons();
}

window.switchProfileTab = function(tab) {
    const btns = document.querySelectorAll('#view-profile .tab-btn');
    btns.forEach(b => b.classList.remove('active'));
    // Find the button clicked - relies on onclick attr which is brittle but works here
    // Better: Query based on onclick content
    const targetBtn = Array.from(btns).find(b => b.getAttribute('onclick').includes(tab));
    if(targetBtn) targetBtn.classList.add('active');
    
    window.currentProfileTab = tab;
    renderProfileContent(window.currentViewingProfileId, tab);
}

window.renderProfileContent = function(userId, tab) {
    const contentArea = document.getElementById('profile-content-area');
    contentArea.innerHTML = "";
    
    let targetPosts = [];
    
    if (tab === 'posts') {
        targetPosts = posts.filter(p => p.authorId === userId);
    } else if (tab === 'saved') {
        targetPosts = posts.filter(p => savedPosts.includes(p.id));
    } else if (tab === 'liked') {
        targetPosts = posts.filter(p => p.likes && p.likes.includes(userId));
    } else if (tab === 'tagged') {
        targetPosts = posts.filter(p => p.collaborators && p.collaborators.some(c => c.id === userId && c.status === 'accepted'));
    }
    
    // Visibility Check for normal profile viewing (not me)
    if (userId !== currentUser.id && tab === 'posts') {
        const user = users.find(u => u.id === userId);
        const amFollowing = currentUser.following.includes(userId);
        const isPrivateAcc = user?.settings?.privateNetwork;
        
        targetPosts = targetPosts.filter(p => {
             const isPublic = !p.settings || p.settings.privacy === 'public';
             if (isPrivateAcc && !amFollowing) return false;
             return isPublic || amFollowing;
        });
    }

    if (targetPosts.length === 0) {
        contentArea.innerHTML = `<div class="text-center py-20 text-gray-400">No posts yet</div>`;
    } else {
        let gridHTML = `<div class="grid-post-container">`;
        targetPosts.forEach(p => {
            let content = '';
            if (p.media) {
                if (p.media.includes('video') || p.media.endsWith('.mp4')) {
                     content = `<video src="${p.media}" class="w-full h-full object-cover pointer-events-none"></video><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-8 h-8 text-white drop-shadow-md"></i></div>`;
                } else {
                     content = `<img src="${p.media}" class="w-full h-full object-cover">`;
                }
            } else {
                // Text placeholder for grid
                content = `<div class="grid-post-text-preview">${p.content.substring(0, 60)}${p.content.length>60?'...':''}</div>`;
            }
            
            gridHTML += `
            <div class="grid-post-item group" onclick="openPostView('${p.id}')">
                ${content}
                <div class="grid-post-overlay">
                    <div class="flex items-center gap-1"><i data-lucide="heart" class="w-5 h-5 fill-white"></i> ${p.likes ? p.likes.length : 0}</div>
                    <div class="flex items-center gap-1"><i data-lucide="message-circle" class="w-5 h-5 fill-white"></i> ${p.comments ? p.comments.length : 0}</div>
                </div>
            </div>`;
        });
        gridHTML += `</div>`;
        contentArea.innerHTML = gridHTML;
    }
    refreshIcons();
}

window.openEditProfile = function() {
const bannerUrl = currentUser.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
currentBannerPos = currentUser.bannerPos || 50;
initialBannerPos = currentBannerPos;
document.getElementById('edit-banner-preview').src = bannerUrl;
document.getElementById('edit-banner-preview').style.objectPosition = `center ${currentBannerPos}%`;
document.getElementById('banner-pos-hint').innerText = `${currentBannerPos}%`;
document.getElementById('edit-email').value = currentUser.email || "";
document.getElementById('edit-profile-overlay').classList.remove('pointer-events-none', 'opacity-0');
}
window.closeEditProfile = function() { document.getElementById('edit-profile-overlay').classList.add('pointer-events-none', 'opacity-0'); }

window.handleEditAvatarSelect = function(event) {
const file = event.target.files[0];
if (file) {
currentAvatarBlob = file;
const reader = new FileReader();
reader.onload = function(e) { document.getElementById('edit-avatar-preview').src = e.target.result; };
reader.readAsDataURL(file);
}
}

window.handleEditBannerSelect = function(event) {
const file = event.target.files[0];
if (file) {
currentBannerBlob = file;
const reader = new FileReader();
reader.onload = function(e) { document.getElementById('edit-banner-preview').src = e.target.result; };
reader.readAsDataURL(file);
}
}

window.saveProfileChanges = async function() {
const btn = document.getElementById('save-profile-btn');
const originalText = btn.innerText;
btn.innerText = "Saving...";
btn.disabled = true;

const name = document.getElementById('edit-name').value;
const bio = document.getElementById('edit-bio').value;
const bannerPos = currentBannerPos;

if(!name) { showToast("Name is required"); btn.innerText = originalText; btn.disabled = false; return; }

let avatarUrl = currentUser.avatar;
let bannerUrl = currentUser.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';

try {
if(currentAvatarBlob) { avatarUrl = await uploadToImgHippo(currentAvatarBlob); }
if(currentBannerBlob) { bannerUrl = await uploadToImgHippo(currentBannerBlob); }
} catch (e) {
console.error("Upload failed", e); showToast("Image upload failed"); btn.innerText = originalText; btn.disabled = false; return;
}

const userRef = doc(db, "users", currentUser.id);
await updateDoc(userRef, { name, bio, avatar: avatarUrl, banner: bannerUrl, bannerPos });

currentUser.name = name; currentUser.bio = bio; currentUser.avatar = avatarUrl; currentUser.banner = bannerUrl; currentUser.bannerPos = bannerPos;
currentAvatarBlob = null; currentBannerBlob = null;

updateUserInterface();
closeEditProfile();
showProfile(currentUser.id, window.currentProfileTab);
showToast("Profile Updated");
btn.innerText = originalText; btn.disabled = false;
}

window.doLogout = async function() { await signOut(auth); window.location.href = "index.html"; }

window.toggleFollow = async function(userId) {
const meRef = doc(db, "users", currentUser.id);
const targetRef = doc(db, "users", userId);

const targetUser = users.find(u => u.id === userId);
const isPrivate = targetUser?.settings?.privateNetwork;

if(currentUser.following.includes(userId)) {
currentUser.following = currentUser.following.filter(id => id !== userId);
showToast(`Unfollowed`);
await updateDoc(meRef, { following: arrayRemove(userId) });
await updateDoc(targetRef, { followers: arrayRemove(currentUser.id) });
const btn = document.getElementById('profile-follow-btn');
if(btn) btn.innerText = isPrivate ? 'Request' : 'Follow';
} else {
if(isPrivate) {
showToast("Follow request sent");
sendNotification(userId, 'follow_request', 'wants to follow you');
const btn = document.getElementById('profile-follow-btn');
if(btn) btn.innerText = "Requested";
} else {
currentUser.following.push(userId);
showToast(`Following`);
await updateDoc(meRef, { following: arrayUnion(userId) });
await updateDoc(targetRef, { followers: arrayUnion(currentUser.id) });
sendNotification(userId, 'follow', 'started following you');
const btn = document.getElementById('profile-follow-btn');
if(btn) btn.innerText = "Following";
}
}
const netView = document.getElementById('view-network');
if(netView && !netView.classList.contains('hidden')) renderNetwork();
refreshIcons();
}

window.openUserList = function(type, userId) {
const user = users.find(u => u.id === userId);
if(!user) return;

if(user.settings?.privateNetwork && user.id !== currentUser.id && !currentUser.following.includes(user.id)) return;

const overlay = document.getElementById('user-list-overlay');
const title = document.getElementById('user-list-title');
const content = document.getElementById('user-list-content');

title.innerText = type === 'following' ? 'Following' : 'Followers';
content.innerHTML = '';

const targetIds = type === 'following' ? user.following : user.followers;

if(!targetIds || targetIds.length === 0) {
content.innerHTML = `<div class="text-center text-gray-400 py-8">No users found.</div>`;
} else {
targetIds.forEach(tid => {
const targetUser = users.find(u => u.id === tid);
if(targetUser) {
const isMe = targetUser.id === currentUser.id;
const amFollowing = currentUser.following.includes(targetUser.id);
let btn = '';
if(!isMe) {
btn = `<button onclick="toggleFollow('${targetUser.id}')" class="text-xs px-3 py-1 rounded-full font-medium ${amFollowing ? 'bg-gray-100 text-gray-700' : 'bg-blue-600 text-white'}">${amFollowing ? 'Unfollow' : 'Follow'}</button>`;
}
const div = document.createElement('div');
div.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer";
div.onclick = (e) => {
if(e.target.tagName !== 'BUTTON') { closeUserList(); showProfile(targetUser.id); }
};
div.innerHTML = `<div class="flex items-center gap-3"><img src="${targetUser.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${targetUser.name}</div><div class="text-xs text-gray-500 truncate w-32">${targetUser.bio}</div></div></div>${btn}`;
content.appendChild(div);
}
});
}
overlay.classList.remove('hidden');
}

window.closeUserList = function() { document.getElementById('user-list-overlay').classList.add('hidden'); }

// Updated Switch Explore Tab Function
window.switchExploreTab = function(tabName) {
window.activeExploreTab = tabName;
const searchVal = document.getElementById('global-search').value || document.getElementById('mobile-explore-search').value;
handleSearch(searchVal); // Re-run search with new tab state
}

window.handleSearch = function(query) {
if(document.getElementById('view-explore').classList.contains('hidden')) {
switchView('explore');
}

const headerInput = document.getElementById('global-search');
const mobileInput = document.getElementById('mobile-explore-search');

if(headerInput && headerInput.value !== query) headerInput.value = query;
if(mobileInput && mobileInput.value !== query) mobileInput.value = query;

const view = document.getElementById('explore-results');

if(!query || query.trim() === '') {
// DEFAULT DISCOVERY STATE
view.innerHTML = `
    <div class="text-center py-20 text-gray-400">
        <h3 class="text-lg font-bold text-gray-800 mb-2">Search & Discover</h3>
        <p class="text-gray-500 text-sm mb-6 flex items-center justify-center gap-2">Find new people and ideas <i data-lucide="search" class="w-4 h-4"></i></p>
    </div>
`;
refreshIcons();
return;
}

const term = query.toLowerCase().trim();
// Support for direct hashtag search logic (remove # for matching text content generally, but keep for specific tag matching if needed)
const cleanTerm = term.replace('#', ''); 
const keywords = term.split(" ").filter(k => k.length > 0);

const foundUsers = users.filter(u => {
const name = (u.name || '').toLowerCase();
const bio = (u.bio || "").toLowerCase();
return keywords.some(k => name.includes(k) || bio.includes(k));
});

const foundPosts = posts.filter(p => {
const content = (p.content || '').toLowerCase();
// If tab is 'tags', look specifically for the hash
if (window.activeExploreTab === 'tags') {
    return content.includes('#' + cleanTerm) || content.includes(term);
}
return keywords.some(k => content.includes(k));
});

// Tab Interface
let html = `
<div class="tab-group mb-0 md:mb-4 bg-white sticky top-16 md:top-0 z-10 border-b border-gray-200">
<button onclick="switchExploreTab('people')" class="tab-btn ${window.activeExploreTab === 'people' ? 'active' : ''}"><i data-lucide="user" class="w-4 h-4"></i> People</button>
<button onclick="switchExploreTab('posts')" class="tab-btn ${window.activeExploreTab === 'posts' ? 'active' : ''}"><i data-lucide="grid-3x3" class="w-4 h-4"></i> Posts</button>
<button onclick="switchExploreTab('tags')" class="tab-btn ${window.activeExploreTab === 'tags' ? 'active' : ''}"><i data-lucide="hash" class="w-4 h-4"></i> Tags</button>
</div>
`;

// People Results
const hiddenPeople = window.activeExploreTab === 'people' ? '' : 'hidden';
html += `<div id="results-people" class="flex flex-col ${hiddenPeople}">`;
if(foundUsers.length) {
foundUsers.forEach(u => {
html += `
<div class="flex items-center gap-3 p-4 bg-white border-b border-gray-100 last:border-0 md:border md:rounded-xl md:mb-2 cursor-pointer hover:bg-gray-50 transition-colors" onclick="showProfile('${u.id}')">
<img src="${u.avatar}" class="w-10 h-10 rounded-full object-cover bg-gray-50 border border-gray-100">
<div>
<div class="font-bold text-sm text-gray-900">${u.name} ${u.isOfficial ? '<i data-lucide="badge-check" class="w-3 h-3 inline text-blue-500"></i>' : ''}</div>
<div class="text-xs text-gray-500 line-clamp-1">${u.bio || 'No bio'}</div>
</div>
</div>`;
});
} else {
html += `<div class="text-gray-400 text-sm p-4 text-center italic">No people found matching "${query}"</div>`;
}
html += `</div>`;

// Posts & Tags Results (Using Grid)
// Note: Both Posts tab and Tags tab use the same visual grid layout, just different filtering logic executed above
const hiddenPosts = (window.activeExploreTab === 'posts' || window.activeExploreTab === 'tags') ? '' : 'hidden';
html += `<div id="results-posts" class="${hiddenPosts}"></div>`;

view.innerHTML = html;

// Append posts elements manually as Grid Items
const postsDiv = document.getElementById('results-posts');

// Apply Grid Classes directly
postsDiv.className = `grid grid-cols-3 gap-0.5 md:gap-4 ${hiddenPosts}`;

if(foundPosts.length) {
foundPosts.forEach(p => {
// Create Grid Item
const div = document.createElement('div');
div.className = "relative aspect-square bg-gray-100 cursor-pointer overflow-hidden hover:opacity-95 transition-opacity";
div.onclick = () => openPostView(p.id);

let content = '';
if (p.media) {
    if (p.media.includes('video') || p.media.endsWith('.mp4') || p.media.startsWith('data:video')) {
            content = `<video src="${p.media}" class="w-full h-full object-cover pointer-events-none"></video><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-8 h-8 text-white drop-shadow-md"></i></div>`;
    } else {
            content = `<img src="${p.media}" class="w-full h-full object-cover">`;
    }
} else {
    // Text Tile
    content = `<div class="w-full h-full flex items-center justify-center p-2 text-[10px] text-center text-gray-500 bg-gray-50 overflow-hidden leading-tight">${p.content.substring(0,60)}...</div>`;
}

div.innerHTML = content;
postsDiv.appendChild(div);
});
} else {
postsDiv.className = `p-4 text-center ${hiddenPosts}`;
postsDiv.innerHTML = `<div class="text-gray-400 text-sm italic">No posts found matching "${query}"</div>`;
}

refreshIcons();
}

function linkify(text) {
var urlRegex =/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
return text.replace(urlRegex, function(url) {
return '<a href="' + url + '" target="_blank" class="text-blue-200 underline hover:text-white" onclick="event.stopPropagation()">' + url + '</a>';
});
}

window.deleteMessage = async function(msgId) {
showAlert("Unsend this message?", async () => { await deleteDoc(doc(db, "messages", msgId)); });
}

// Open Post View - Refactored for new UI
window.openPostView = function(postId) {
const post = posts.find(p => p.id === postId);
if(!post) return;
window.currentViewingPostId = postId;

const author = users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '', id: post.authorId };
const dateStr = formatDate(post.timestamp);

// Reset UI
const mediaContainer = document.getElementById('post-view-media-container');
const captionArea = document.getElementById('post-view-caption-area');
const overlay = document.getElementById('post-view-overlay');

document.getElementById('post-view-avatar').src = author.avatar;
document.getElementById('post-view-username').innerText = author.name;
document.getElementById('post-view-date').innerText = dateStr;
document.getElementById('post-view-likes-count').innerText = `${post.likes ? post.likes.length : 0} likes`;
document.getElementById('post-view-avatar').onclick = () => showProfile(author.id);
document.getElementById('post-view-username').onclick = () => showProfile(author.id);

// Media Logic
mediaContainer.classList.remove('hidden'); // Always show container
if (post.media) {
    if (post.media.includes('video') || post.media.endsWith('.mp4') || post.media.startsWith('data:video')) {
         mediaContainer.innerHTML = `<video src="${post.media}" class="w-full h-full object-contain" controls autoplay muted></video>`;
    } else {
         mediaContainer.innerHTML = `<img src="${post.media}" class="w-full h-full object-contain">`;
    }
} else {
    // No Media Placeholder
    mediaContainer.innerHTML = `
        <div class="flex flex-col items-center justify-center h-full text-gray-500">
            <i data-lucide="image-off" class="w-16 h-16 mb-2 opacity-50"></i>
            <span class="text-sm font-medium">No Media</span>
        </div>`;
}

// Caption
const tagsHTML = marked.parse(post.content.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>'));
captionArea.innerHTML = `
    <div class="flex gap-3">
        <img src="${author.avatar}" class="w-8 h-8 rounded-full border border-gray-100 object-cover shrink-0">
        <div>
             <span class="font-bold text-sm mr-1">${author.name}</span>
             <span class="text-sm text-gray-800">${tagsHTML}</span>
        </div>
    </div>
`;

// Comments
renderCommentsInModal(postId);

// Like Button State
const likeBtn = document.getElementById('post-view-like-btn');
const isLiked = post.likes && post.likes.includes(currentUser.id);
likeBtn.innerHTML = `<i data-lucide="heart" class="w-6 h-6 ${isLiked ? 'fill-red-500 text-red-500' : 'text-black'}"></i>`;
likeBtn.onclick = () => toggleLike(postId);

overlay.classList.remove('hidden');
refreshIcons();
}

window.closePostView = function() {
document.getElementById('post-view-overlay').classList.add('hidden');
window.currentViewingPostId = null;
window.replyingToCommentId = null;
const video = document.querySelector('#post-view-media-container video');
if(video) video.pause();
}

function renderCommentsInModal(postId) {
const post = posts.find(p => p.id === postId);
if(!post) return;
const container = document.getElementById('post-view-comments');
let html = '';

// Update Like Count dynamically if open
document.getElementById('post-view-likes-count').innerText = `${post.likes ? post.likes.length : 0} likes`;

if(post.comments) {
    const topLevel = post.comments.filter(c => !c.parentId);
    topLevel.forEach(c => { 
        html += createCommentHTML(c, post.comments, postId, true, post.authorId); 
    });
}
container.innerHTML = html;
refreshIcons();
}

// Updated createCommentHTML to handle reply threading & creator like badge
function createCommentHTML(c, allComments, postId, showRepliesLink = true, postAuthorId = null) {
const cAuthor = users.find(u => u.id === c.authorId) || { name: 'Unknown', avatar: '' };
const isLiked = c.likes && c.likes.includes(currentUser.id);
const likeCount = c.likes ? c.likes.length : 0;
const isMyComment = c.authorId === currentUser.id;
const isAdmin = currentUser.email === 'edulinkbht@gmail.com';
const canDelete = isMyComment || isAdmin;

// Check if Creator liked this comment
const creatorLiked = postAuthorId && c.likes && c.likes.includes(postAuthorId);
let creatorBadgeHTML = '';
if(creatorLiked) {
    const creator = users.find(u => u.id === postAuthorId);
    if(creator) {
        creatorBadgeHTML = `
        <div class="relative inline-block w-4 h-4 ml-1 top-1">
            <img src="${creator.avatar}" class="w-full h-full rounded-full border border-white" title="Liked by Author">
            <div class="absolute -bottom-1 -right-1 w-2 h-2 bg-red-500 rounded-full border border-white flex items-center justify-center">
               <i data-lucide="heart" class="w-1 h-1 text-white fill-white"></i>
            </div>
        </div>`;
    }
}

const replies = allComments.filter(r => r.parentId === c.id);

let html = `
<div class="flex gap-3 mb-2 group">
    <img src="${cAuthor.avatar}" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-100 shrink-0 object-cover cursor-pointer" onclick="showProfile('${c.authorId}')">
    <div class="flex-1">
        <div class="text-sm">
            <span class="font-bold mr-1 cursor-pointer" onclick="showProfile('${c.authorId}')">${cAuthor.name}</span>
            <span class="text-gray-900">${c.content}</span>
        </div>
        <div class="flex items-center gap-3 mt-1 text-xs text-gray-500 font-medium">
            <span>Now</span>
            ${likeCount > 0 ? `<span>${likeCount} like${likeCount > 1 ? 's' : ''}</span>` : ''}
            <button class="hover:text-gray-900" onclick="replyToComment('${c.id}', '${cAuthor.name}')">Reply</button>
            ${canDelete ? `<button onclick="deleteComment('${postId}', '${c.id}')" class="text-red-500 hover:text-red-700">Delete</button>` : ''}
        </div>
        
        ${showRepliesLink && replies.length > 0 ? 
            `<div class="mt-2 pl-2 border-l-2 border-gray-100">
                <button onclick="openThread('${postId}', '${c.id}')" class="text-xs font-semibold text-gray-500 hover:text-gray-800 flex items-center gap-2">
                    <div class="w-8 h-[1px] bg-gray-300"></div> View ${replies.length} replies
                </button>
             </div>` : ''
        }
    </div>
    <div class="flex flex-col items-center">
        <button onclick="toggleCommentLike('${postId}', '${c.id}')" class="pt-1">
            <i data-lucide="heart" class="w-3 h-3 ${isLiked ? 'fill-red-500 text-red-500' : 'text-gray-400'}"></i>
        </button>
        ${creatorBadgeHTML}
    </div>
</div>
`;
return html;
}

// Thread Functions
window.openThread = function(postId, commentId) {
    window.threadPostId = postId;
    window.threadParentCommentId = commentId;
    renderThreadContent(postId, commentId);
    document.getElementById('thread-overlay').classList.remove('hidden');
    document.getElementById('thread-input').focus();
}

window.closeThread = function() {
    document.getElementById('thread-overlay').classList.add('hidden');
    window.threadPostId = null;
    window.threadParentCommentId = null;
    window.replyingToCommentId = null; // Reset normal reply when closing thread
}

window.renderThreadContent = function(postId, commentId) {
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const parentComment = post.comments.find(c => c.id === commentId);
    if (!parentComment) return;

    const replies = post.comments.filter(c => c.parentId === commentId);
    const container = document.getElementById('thread-content');
    
    // Render Parent Comment (Full styling, no "View replies" button)
    let html = `<div class="p-4 border-b border-gray-100 bg-white">` + createCommentHTML(parentComment, post.comments, postId, false, post.authorId) + `</div>`;
    
    // Render Replies
    html += `<div class="p-4 pl-8 space-y-4">`;
    if (replies.length > 0) {
        replies.forEach(r => {
             html += createCommentHTML(r, post.comments, postId, false, post.authorId);
        });
    } else {
        html += `<div class="text-center text-gray-400 text-sm py-4">No replies yet.</div>`;
    }
    html += `</div>`;
    
    container.innerHTML = html;
    refreshIcons();
}

window.submitThreadReply = async function() {
    const txt = document.getElementById('thread-input').value.trim();
    if (!txt || !window.threadPostId || !window.threadParentCommentId) return;

    const postRef = doc(db, "posts", window.threadPostId);
    const commentId = "c-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
    
    // Parent ID is explicitly the thread parent
    const newComment = { 
        id: commentId, 
        authorId: currentUser.id, 
        content: txt, 
        timestamp: Date.now(), 
        likes: [], 
        parentId: window.threadParentCommentId 
    };

    await updateDoc(postRef, { comments: arrayUnion(newComment) });
    
    // Notification logic
    const post = posts.find(p => p.id === window.threadPostId);
    const parentComment = post.comments.find(c => c.id === window.threadParentCommentId);
    if (parentComment && parentComment.authorId !== currentUser.id) {
        sendNotification(parentComment.authorId, 'reply', 'replied to your comment', window.threadPostId);
    }

    document.getElementById('thread-input').value = "";
    // Re-render handled by realtime listener
}


window.deleteComment = async function(postId, commentId) {
showAlert("Delete this comment?", async () => {
const postRef = doc(db, "posts", postId);
const post = posts.find(p => p.id === postId);
const updatedComments = post.comments.filter(c => c.id !== commentId && c.parentId !== commentId);
await updateDoc(postRef, { comments: updatedComments });
showToast("Comment deleted");
});
}

window.toggleCommentLike = async function(postId, commentId) {
const post = posts.find(p => p.id === postId);
if(!post) return;
const comments = post.comments || [];
const commentIndex = comments.findIndex(c => c.id === commentId);
if(commentIndex === -1) return;
const comment = comments[commentIndex];
if(!comment.likes) comment.likes = [];
if(comment.likes.includes(currentUser.id)) { comment.likes = comment.likes.filter(id => id !== currentUser.id); }
else { comment.likes.push(currentUser.id); if(comment.authorId !== currentUser.id) sendNotification(comment.authorId, 'like', 'liked your comment', postId); }
comments[commentIndex] = comment;
const postRef = doc(db, "posts", postId);
await updateDoc(postRef, { comments: comments });
}

window.replyToComment = function(commentId, username) {
const input = document.getElementById('comment-input-desktop');
input.value = `@${username} `;
input.focus();
window.replyingToCommentId = commentId;
}

window.submitCommentDesktop = async function() {
const txt = document.getElementById('comment-input-desktop').value.trim();
if(!txt || !window.currentViewingPostId) return;
const postRef = doc(db, "posts", window.currentViewingPostId);
const commentId = "c-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
const newComment = { id: commentId, authorId: currentUser.id, content: txt, timestamp: Date.now(), likes: [], parentId: window.replyingToCommentId };
await updateDoc(postRef, { comments: arrayUnion(newComment) });
const post = posts.find(p => p.id === window.currentViewingPostId);
if (window.replyingToCommentId) {
const parentComment = post.comments.find(c => c.id === window.replyingToCommentId);
if (parentComment && parentComment.authorId !== currentUser.id) sendNotification(parentComment.authorId, 'reply', 'replied to your comment', window.currentViewingPostId);
} else if(post && post.authorId !== currentUser.id) { sendNotification(post.authorId, 'comment', 'commented on your post', window.currentViewingPostId); }
document.getElementById('comment-input-desktop').value = "";
window.replyingToCommentId = null;
}

window.promptForLink = function() {
const url = prompt("Enter URL (Image, Video, or Website):");
if(url && (url.startsWith('http') || url.startsWith('data:'))) {
    // Check if it's media
    const isImage = /\.(jpeg|jpg|gif|png|webp)$/i.test(url) || url.startsWith('data:image');
    const isVideo = /\.(mp4|webm|ogg|mov)$/i.test(url) || url.startsWith('data:video');
    
    if (isImage) {
        window.currentMedia = url;
        window.currentMediaType = 'image';
        showMediaPreview();
    } else if (isVideo) {
        window.currentMedia = url;
        window.currentMediaType = 'video';
        showMediaPreview();
    } else {
        // Generic Link - append to text
        const ta = document.getElementById('compose-text');
        ta.value += `\n[Link](${url})`;
        showToast("Link added to text");
    }
}
}

function showMediaPreview() {
    const container = document.getElementById('media-preview-container');
    container.classList.remove('hidden');
    const img = document.getElementById('media-preview-img');
    const vid = document.getElementById('media-preview-video');
    
    if(window.currentMediaType === 'video') {
        vid.src = window.currentMedia;
        vid.classList.remove('hidden');
        img.classList.add('hidden');
    } else {
        img.src = window.currentMedia;
        img.classList.remove('hidden');
        vid.classList.add('hidden');
    }
    showToast("Media Attached");
}

window.sendAnnouncement = async function() {
const text = document.getElementById('announcement-text').value.trim();
if(!text) return;

showAlert("Send this announcement to all users?", async () => {
let count = 0;
for(const u of users) {
if(u.id !== currentUser.id) {
await addDoc(collection(db, "notifications"), { receiverId: u.id, senderId: currentUser.id, type: 'official', content: text, timestamp: serverTimestamp(), read: false });
count++;
}
}
showToast(`Sent to ${count} users`);
document.getElementById('announcement-text').value = "";
});
}

// Menu Functions
window.openCreateMenu = function() { document.getElementById('create-menu-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('create-menu-modal').classList.remove('scale-95'); }
window.closeCreateMenu = function() { document.getElementById('create-menu-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('create-menu-modal').classList.add('scale-95'); }
window.openMentorship = function() { closeCreateMenu(); document.getElementById('mentorship-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('mentorship-modal-box').classList.remove('scale-95'); }
window.closeMentorship = function() { document.getElementById('mentorship-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('mentorship-modal-box').classList.add('scale-95'); }
window.openEventComposer = function() { closeCreateMenu(); removeEventCover(); document.getElementById('event-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.remove('scale-95'); }
window.closeEventComposer = function() { document.getElementById('event-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.add('scale-95'); }
window.handleEventCoverSelect = function(event) { const file = event.target.files[0]; if (file) { currentEventCoverBlob = file; const reader = new FileReader(); reader.onload = function(e) { window.currentEventCover = e.target.result; document.getElementById('event-cover-preview').src = window.currentEventCover; document.getElementById('event-cover-preview-container').classList.remove('hidden'); document.getElementById('add-cover-btn').classList.add('hidden'); }; reader.readAsDataURL(file); } }
window.removeEventCover = function() { window.currentEventCover = null; currentEventCoverBlob = null; document.getElementById('event-cover-preview').src = ""; document.getElementById('event-cover-preview-container').classList.add('hidden'); document.getElementById('add-cover-btn').classList.remove('hidden'); document.getElementById('event-cover-input').value = ""; }
window.publishEvent = function() { showToast("Events feature connected to backend soon!", false); closeEventComposer(); }

// Post Logic
window.showPostOptions = function(event, postId, authorId) {
    event.stopPropagation();
    const isAuthor = authorId === currentUser.id;
    const isAdmin = currentUser.email === 'edulinkbht@gmail.com';
    const canEdit = isAuthor;
    const canDelete = isAuthor || isAdmin;
    
    const container = document.getElementById('post-options-modal-container');
    const box = document.getElementById('post-options-modal-box');
    
    let menuContent = '';
    if(canEdit) { menuContent += `<div class="option-item" onclick="editPost('${postId}'); hidePostMenu()"><i data-lucide="edit-2" class="w-5 h-5"></i> Edit Post</div>`; }
    if(canDelete) { menuContent += `<div class="option-item danger" onclick="deletePost('${postId}'); hidePostMenu()"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Post</div>`; }
    if(!isAuthor) { 
        menuContent += `<div class="option-item" onclick="showToast('Post Saved'); hidePostMenu()"><i data-lucide="bookmark" class="w-5 h-5"></i> Save Post</div>`;
        menuContent += `<div class="option-item danger" onclick="showToast('Reported'); hidePostMenu()"><i data-lucide="flag" class="w-5 h-5"></i> Report Post</div>`; 
    }
    menuContent += `<div class="option-item" onclick="hidePostMenu()"><i data-lucide="x" class="w-5 h-5"></i> Cancel</div>`;
    
    box.innerHTML = menuContent;
    refreshIcons();
    container.classList.remove('opacity-0', 'pointer-events-none');
    setTimeout(() => container.classList.add('active'), 10);
}

window.hidePostMenu = function() { 
    const container = document.getElementById('post-options-modal-container');
    container.classList.remove('active');
    setTimeout(() => container.classList.add('opacity-0', 'pointer-events-none'), 200);
}

window.editPost = function(postId) { const post = posts.find(p => p.id === postId); if(!post) return; document.getElementById('compose-text').value = post.content; window.editingPostId = postId; document.getElementById('compose-title-text').innerText = "Edit Post"; document.getElementById('btn-publish').innerText = "Update"; openCompose(); }
window.deletePost = async function(postId) { showAlert("Delete this post?", async () => { await deleteDoc(doc(db, "posts", postId)); showToast("Post deleted"); }); }
window.openCompose = function() { 
    window.selectedCollaborators = [];
    renderCollabChips();
    closeCreateMenu(); 
    document.getElementById('compose-overlay').classList.remove('opacity-0', 'pointer-events-none'); 
    document.getElementById('compose-modal').classList.remove('scale-95'); 
}
window.closeCompose = function() { document.getElementById('compose-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('compose-modal').classList.add('scale-95'); setTimeout(() => { window.editingPostId = null; document.getElementById('compose-title-text').innerText = "Create Post"; document.getElementById('btn-publish').innerText = "Post"; document.getElementById('compose-text').value = ""; removeMedia(); }, 200); }

window.toggleComposeSettings = function() {
const area = document.getElementById('compose-settings-area');
const arrow = document.getElementById('compose-settings-arrow');
area.classList.toggle('hidden');
if(area.classList.contains('hidden')) arrow.style.transform = 'rotate(0deg)';
else arrow.style.transform = 'rotate(180deg)';
}

// AI Stuff
function setupClassifier() { if(typeof ml5 !== 'undefined') classifier = ml5.imageClassifier('MobileNet', () => console.log("MobileNet Ready")); }
window.toggleNewtonExpand = function() { document.body.classList.toggle('mode-focus'); const layout = document.getElementById('workspace-layout'); const icon = document.getElementById('expand-icon'); let isSwapped = layout.classList.contains('swapped'); if (!isSwapped) { layout.classList.add('swapped'); icon.setAttribute('data-lucide', 'minimize-2'); showToast("Focus Mode Active"); } else { layout.classList.remove('swapped'); icon.setAttribute('data-lucide', 'maximize-2'); } refreshIcons(); }
window.handleInput = function(textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; if(textarea.value === '') textarea.style.height = 'auto'; }
window.togglePlusMenu = function() { if(window.isModelMenuOpen) toggleModelMenu(); window.isPlusMenuOpen = !window.isPlusMenuOpen; const menu = document.getElementById('plus-menu'); const icon = document.getElementById('plus-icon'); if(window.isPlusMenuOpen) { menu.classList.add('active'); icon.style.transform = "rotate(45deg)"; } else { menu.classList.remove('active'); icon.style.transform = "rotate(0deg)"; } }
window.toggleModelMenu = function() { if(window.isPlusMenuOpen) togglePlusMenu(); window.isModelMenuOpen = !window.isModelMenuOpen; const menu = document.getElementById('model-menu'); if(window.isModelMenuOpen) menu.classList.add('active'); else menu.classList.remove('active'); }
window.handleFileSelect = function(event) { const file = event.target.files[0]; if (file) { window.currentMediaBlob = file; const reader = new FileReader(); reader.onload = function(e) { window.currentMedia = e.target.result; window.currentMediaType = file.type.startsWith('video') ? 'video' : 'image'; showMediaPreview(); }; reader.readAsDataURL(file); } }
window.removeMedia = function() { window.currentMedia = null; window.currentMediaType = null; window.mediaVisionLog = ""; window.currentMediaBlob = null; document.getElementById('media-preview-container').classList.add('hidden'); document.getElementById('media-input').value = ""; }

// ImgHippo Upload
async function uploadToImgHippo(file) {
const formData = new FormData();
formData.append('api_key', 'd28bf3c492ad07b53dc4e3f9ce99b072');
formData.append('file', file);

try {
const response = await fetch('https://api.imghippo.com/v1/upload', { method: 'POST', body: formData });
const data = await response.json();
if (data.success) { return data.data.url; }
else { console.error("ImgHippo error", data); throw new Error('Upload failed'); }
} catch (e) { throw e; }
}

window.publishPost = async function() {
const textRaw = document.getElementById('compose-text').value;
const btn = document.getElementById('btn-publish');

// Get Settings
const isPrivate = document.getElementById('post-setting-privacy').checked;
const showLikes = document.getElementById('post-setting-likes').checked;
const showComments = document.getElementById('post-setting-comments').checked;
const allowLikeView = document.getElementById('post-setting-like-view').checked;
const allowComments = document.getElementById('post-setting-allow-comments').checked;

if (!textRaw.trim() && !window.currentMedia) { showToast("Empty post!", true); return; }
const originalHtml = btn.innerHTML; btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Posting...`; btn.disabled = true; refreshIcons();
try {
let mediaUrl = window.currentMedia;
if(window.currentMediaBlob) {
try { mediaUrl = await uploadToImgHippo(window.currentMediaBlob); }
catch (err) {
console.error("ImgHippo failed, falling back to Firebase Storage", err);
const mediaRef = ref(storage, `posts/${currentUser.id}/${Date.now()}_${window.currentMediaBlob.name}`);
await uploadBytes(mediaRef, window.currentMediaBlob);
mediaUrl = await getDownloadURL(mediaRef);
}
}

// Send Collab Notifications
if(window.selectedCollaborators && window.selectedCollaborators.length > 0) {
    // Logic inside publish because we need post ID first? No, we need ID first.
    // So we add doc then notify.
}

const postData = {
authorId: currentUser.id,
content: textRaw,
media: mediaUrl,
timestamp: serverTimestamp(),
likes: [],
comments: [],
collaborators: window.selectedCollaborators || [],
settings: {
privacy: isPrivate ? 'private' : 'public',
showLikes: showLikes,
showComments: showComments,
allowLikeView: allowLikeView,
allowComments: allowComments
}
};

let postId = null;
if(window.editingPostId) { 
    await updateDoc(doc(db, "posts", window.editingPostId), { content: textRaw, settings: postData.settings }); 
    postId = window.editingPostId;
    showToast("Post Updated!"); 
} else { 
    const docRef = await addDoc(collection(db, "posts"), postData); 
    postId = docRef.id;
    showToast("Posted!"); 
    
    // Notify Collaborators
    if(window.selectedCollaborators && window.selectedCollaborators.length > 0) {
        window.selectedCollaborators.forEach(c => {
            sendNotification(c.id, 'collab_request', 'invited you to collaborate on a post', postId);
        });
    }
} 
closeCompose(); document.getElementById('compose-text').value = ""; removeMedia(); } catch (e) { console.error(e); showToast("Error posting", true); } finally { btn.innerHTML = originalHtml; btn.disabled = false; refreshIcons(); } }
window.showToast = function(message, isError = false) { const toast = document.getElementById('toast'); const toastMsg = document.getElementById('toast-msg'); const icon = document.getElementById('toast-icon'); toastMsg.innerText = message; if (isError) { toast.style.backgroundColor = '#d93025'; icon.setAttribute('data-lucide', 'alert-circle'); icon.classList.remove('text-[#c4eed0]'); icon.classList.add('text-white'); } else { toast.style.backgroundColor = '#303134'; icon.setAttribute('data-lucide', 'check-circle-2'); icon.classList.add('text-[#c4eed0]'); } refreshIcons(); toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000); }

// Updated Lightbox with Overlay Support
window.openLightbox = function(postId) { 
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const author = users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '' };
    const wrapper = document.getElementById('lightbox-wrapper');
    const lightbox = document.getElementById('lightbox'); 
    
    const isVideo = post.media.includes('.mp4') || post.media.includes('data:video') || post.media.includes('.webm');
    
    let content = '';
    if (isVideo) { 
        content = `<video src="${post.media}" controls autoplay class="w-full h-full object-contain"></video>`; 
    } else { 
        content = `<img src="${post.media}" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">`; 
    }
    
    // Overlay for Immersive Feel
    const overlayHTML = `
        <div id="lightbox-overlay-info">
            <div class="flex items-center gap-3 mb-2">
                <img src="${author.avatar}" class="w-10 h-10 rounded-full border border-white/20 object-cover cursor-pointer hover:scale-105 transition-transform" onclick="closeLightbox(); showProfile('${author.id}')">
                <span class="font-bold text-lg">${author.name}</span>
            </div>
            <p class="text-sm text-gray-200 line-clamp-3 md:line-clamp-none">${post.content}</p>
        </div>
    `;
    
    wrapper.innerHTML = content + overlayHTML; 
    lightbox.classList.add('active'); 
    lightbox.classList.remove('pointer-events-none'); 
    lightbox.classList.remove('opacity-0'); 
}

window.closeLightbox = function() { const lightbox = document.getElementById('lightbox'); lightbox.classList.remove('active'); lightbox.classList.add('pointer-events-none'); lightbox.classList.add('opacity-0'); const video = lightbox.querySelector('video'); if(video) video.pause(); }

// AI - Restored
let conversationHistory = [];
const models = { standard: { name: "Newton", avatar: "https://i.imghippo.com/files/XEEq5247S.png", system: "You are Newton, an AI tutor.", greeting: "Hello! I'm Newton. What are you working on?" }, friendly: { name: "Tutor Chase", avatar: "https://api.dicebear.com/9.x/lorelei/svg?seed=Chase", system: "You are Chase, friendly tutor.", greeting: "Hi there! I'm Chase!" } };
let activeModel = 'standard';
window.resetChat = function() { conversationHistory = []; window.clearContext(); const chatContainer = document.getElementById('chat-history'); const modelData = models[activeModel]; let cls = "w-6 h-6 object-contain"; if(activeModel !== 'standard') cls = "w-6 h-6 rounded-full bg-indigo-50 border border-indigo-100"; chatContainer.innerHTML = `<div class="chat-wrapper flex flex-col w-full mb-6 fade-in"><div class="flex items-center gap-2 mb-2"><img src="${modelData.avatar}" class="${cls}"></div><div class="chat-msg-ai"><p>${modelData.greeting}</p></div></div>`; }
window.switchModel = function(modelKey) { if(activeModel === modelKey) { window.toggleModelMenu(); return; } activeModel = modelKey; document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active-item')); document.getElementById(`model-btn-${modelKey}`).classList.add('active-item'); document.getElementById('ai-header-name').innerText = models[modelKey].name; const logo = document.getElementById('ai-header-logo'); logo.src = models[modelKey].avatar; window.toggleModelMenu(); window.resetChat(); showToast(`Switched to ${models[modelKey].name}`); }
window.sendMessageAction = async function() { const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return; addMessage(txt, true); inp.value = ""; window.handleInput(inp); stopGeneration = false; const thinkingId = 'thinking-' + Date.now(); const chatContainer = document.getElementById('chat-history'); const modelData = models[activeModel]; let cls = "w-6 h-6 object-contain"; if(activeModel !== 'standard') cls = "w-6 h-6 rounded-full bg-indigo-50 border border-indigo-100"; const thinkingHTML = `<div id="${thinkingId}" class="flex flex-col w-full mb-6 fade-in"><div class="flex items-center gap-4 mb-2"><img src="${modelData.avatar}" class="${cls} animate-pulse"><span class="text-sm text-[#444746] font-medium animate-pulse">Thinking...</span></div></div>`; chatContainer.insertAdjacentHTML('beforeend', thinkingHTML); chatContainer.scrollTop = chatContainer.scrollHeight; const historyStr = conversationHistory.slice(0, -1).map(msg => `${msg.role === 'user' ? 'User' : 'Newton'}: ${msg.content}`).join('\n'); let system = models[activeModel].system; let q = `${system} \n${window.currentContext ? "Current Context: " + window.currentContext : ""}\nConversation History:\n${historyStr}\nUser: ${txt}`; try { const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(q)}?model=openai`); const ans = await res.text(); if(document.getElementById(thinkingId)) document.getElementById(thinkingId).remove(); if(!stopGeneration) await addMessage(ans, false); } catch(e) { if(document.getElementById(thinkingId)) document.getElementById(thinkingId).remove(); addMessage("Connection error.", false); } }
async function addMessage(text, isUser) { const h = document.getElementById('chat-history'); const d = document.createElement('div'); d.className = isUser ? 'chat-wrapper flex justify-end fade-in mb-6' : 'chat-wrapper flex flex-col fade-in w-full mb-6'; if(isUser) { d.innerHTML = `<div class="chat-msg-user">${text}</div>`; h.appendChild(d); conversationHistory.push({ role: 'user', content: text }); } else { const modelData = models[activeModel]; let cls = "w-6 h-6 object-contain"; if(activeModel !== 'standard') cls = "w-6 h-6 rounded-full bg-indigo-50 border border-indigo-100"; d.innerHTML = `<div class="flex items-center gap-4 mb-2"><img src="${modelData.avatar}" class="${cls}"></div><div class="chat-msg-ai">${marked.parse(text)}</div>`; h.appendChild(d); conversationHistory.push({ role: 'assistant', content: text }); refreshIcons(); } h.scrollTop = h.scrollHeight; }
window.copyText = function(text, btn) { navigator.clipboard.writeText(decodeURIComponent(text)).then(() => { showToast("Copied to clipboard"); }); };
window.insertCodeSnippetAI = function() { const inp = document.getElementById('ai-input'); inp.value += " ```javascript\nconsole.log('Hello');\n``` "; inp.focus(); window.handleInput(inp); }
window.insertCodeBlock = function() { const ta = document.getElementById('compose-text'); ta.value += "\n```javascript\n// Code here\n```\n"; ta.focus(); };
window.toggleWebSearch = function() { showToast("Web search enabled (simulation)"); window.isWebSearchActive = !window.isWebSearchActive; };
window.toggleIdeaMode = function() { showToast("Idea mode enabled"); window.isIdeaMode = !window.isIdeaMode; };
window.pinPost = function(pid, author) { window.currentContext = `Context: Post by ${author}`; document.getElementById('ai-context-chip').classList.remove('hidden'); document.getElementById('ai-context-text').innerText = `Post by ${author}`; showToast("Added to Newton context"); };
window.clearContext = function() { window.currentContext = ""; document.getElementById('ai-context-chip').classList.add('hidden'); };

refreshIcons();
</script>
</body>
</html>
