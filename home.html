<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>EduLink</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
<script src="https://cdn.tailwindcss.com"></script><script src="https://unpkg.com/lucide@latest"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');
:root { --surface: #ffffff; --background: #f9fafb; --on-surface: #1f1f1f; --text-secondary: #667085; --outline: #eaecf0; --hover-bg: #f3f4f6; --primary: #0b57d0; }
body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--on-surface); overflow: hidden; }
h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }
* { scrollbar-width: none; -ms-overflow-style: none; } *::-webkit-scrollbar { width: 0; background: transparent; display: none; }
i[data-lucide], svg { flex-shrink: 0; }
.fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
.scale-in { animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.app-panel { background: var(--surface); border-radius: 20px; border: 1px solid var(--outline); height: 100%; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.03); transition: all 0.3s cubic-bezier(0.2, 0, 0, 1); }
@media (max-width: 768px) { .app-panel { border-radius: 0 !important; border: none !important; box-shadow: none !important; } body { padding: 0 !important; } #workspace-layout { gap: 0 !important; } }
#main-sidebar { width: 88px; flex-shrink: 0; padding: 24px 12px; transition: width 0.3s cubic-bezier(0.2, 0, 0, 1), padding 0.3s ease; }
@media (min-width: 1024px) { #main-sidebar { width: 260px; padding: 24px 20px; } }
.nav-item { display: flex; align-items: center; gap: 14px; padding: 12px; color: var(--text-secondary); font-weight: 500; font-size: 15px; border-radius: 12px; transition: all 0.2s ease; cursor: pointer; text-decoration: none; margin-bottom: 4px; justify-content: center; position: relative; }
.nav-item:hover { color: var(--on-surface); background-color: var(--hover-bg); } .nav-item.active { color: var(--primary); background-color: #eff4ff; font-weight: 600; }
.nav-badge, .mobile-footer-badge { position: absolute; background-color: #fe2c55; color: white; font-size: 10px; font-weight: 700; height: 16px; min-width: 16px; padding: 0 4px; border-radius: 10px; display: none; align-items: center; justify-content: center; border: 2px solid #fff; z-index: 10; }
.nav-badge { top: 10px; right: 12px; } .mobile-footer-badge { top: -4px; right: -4px; z-index: 20; }
@media (min-width: 1024px) { .nav-item { justify-content: flex-start; padding: 10px 16px; } .nav-badge { right: auto; left: 28px; top: 8px; } }
.sidebar-user { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 12px; cursor: pointer; transition: bg 0.2s; justify-content: center; } .sidebar-user:hover { background-color: var(--hover-bg); }
@media (min-width: 1024px) { .sidebar-user { justify-content: flex-start; padding: 8px 12px; } }
.create-btn { display: flex; align-items: center; justify-content: flex-start; gap: 12px; background: #1f1f1f; color: white; padding: 12px 20px; border-radius: 12px; font-weight: 500; font-size: 14px; transition: all 0.2s ease; width: 100%; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); line-height: 1; min-width: 0; white-space: nowrap; }
.create-btn:hover { background: #000; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
.post-card { background: var(--surface); border-bottom: 1px solid var(--outline); border-radius: 0; transition: bg 0.2s ease; margin-bottom: 0; box-shadow: none; overflow: visible; } .post-card:hover { background-color: var(--hover-bg); cursor: pointer; }
.post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
.post-avatar { width: 44px; height: 44px; border-radius: 50%; background-color: var(--hover-bg); border: 1px solid var(--outline); object-fit: cover; }
.post-author-name { font-weight: 700; font-size: 15px; color: var(--on-surface); line-height: 1.2; } .post-author-name:hover { text-decoration: underline; color: var(--primary); }
.post-meta { font-size: 12px; color: var(--text-secondary); margin-top: 3px; font-weight: 500; }
.post-body { font-size: 15px; line-height: 1.6; color: var(--on-surface); margin-bottom: 16px; white-space: pre-wrap; }
.post-actions { display: flex; align-items: center; justify-content: space-between; padding-top: 14px; border-top: 1px solid var(--outline); }
.action-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 10px; color: var(--text-secondary); font-size: 13px; font-weight: 600; transition: all 0.2s; background: transparent; border: none; cursor: pointer; }
.action-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); } .action-btn.like:hover { background: #fef2f2; color: #ef4444; } .action-btn.comment:hover { background: #eff6ff; color: #2563eb; } .action-btn.bookmark:hover { background: #fefce8; color: #eab308; }
.compose-header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--outline); }
.compose-textarea { width: 100%; min-height: 120px; font-size: 17px; line-height: 1.6; color: var(--on-surface); border: none; outline: none; resize: none; background: transparent; }
.compose-tools { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--outline); }
.tool-btn, .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); transition: bg 0.2s; cursor: pointer; }
.tool-btn:hover, .icon-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }
.create-option-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; border-radius: 16px; border: 1px solid var(--outline); background: var(--surface); cursor: pointer; transition: all 0.2s; gap: 12px; height: 140px; }
.create-option-card:hover { border-color: var(--primary); background: #eff4ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(11,87,208,0.1); }
.create-icon-bg { width: 56px; height: 56px; border-radius: 50%; background: var(--hover-bg); display: flex; align-items: center; justify-content: center; color: var(--on-surface); margin-bottom: 8px; transition: bg 0.2s; }
.create-option-card:hover .create-icon-bg { background: #d3e3fd; color: #0b57d0; }
.trending-panel { width: 100%; flex-shrink: 0; order: 2; border-left: 1px solid var(--outline); } @media (min-width: 1280px) { .trending-panel { width: 380px; } }
.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: #f2f2f2; padding: 14px 28px; border-radius: 48px; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); } .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.tab-group { display: flex; width: 100%; background: transparent; padding: 0; border-bottom: 1px solid var(--outline); }
.tab-btn { flex: 1; padding: 14px 0; font-size: 14px; font-weight: 600; color: var(--text-secondary); transition: all 0.2s ease; cursor: pointer; background: transparent; text-align: center; position: relative; display: flex; align-items: center; justify-content: center; gap: 8px; }
.tab-btn:hover { color: var(--on-surface); background-color: var(--hover-bg); } .tab-btn.active { color: var(--on-surface); } .tab-btn.active i { stroke-width: 3px; }
.tab-btn.active::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 60px; height: 4px; background-color: var(--primary); border-radius: 4px 4px 0 0; }
.grid-post-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; } @media (min-width: 768px) { .grid-post-container { gap: 16px; } }
.grid-post-item { position: relative; aspect-ratio: 1/1; overflow: hidden; cursor: pointer; background-color: #f3f4f6; } .grid-post-item:hover .grid-post-overlay { opacity: 1; }
.grid-post-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; color: white; font-weight: bold; gap: 16px; }
.mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; flex: 1; gap: 4px; color: #98a2b3; transition: all 0.2s; cursor: pointer; position: relative; }
.mobile-nav-item.active { color: #000000; } .mobile-nav-item.active i { transform: scale(1.1); stroke-width: 2.5px; }
#app-loader { position: fixed; inset: 0; background: var(--surface); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s ease; }
.loader-spinner { width: 40px; height: 40px; border: 4px solid var(--hover-bg); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.toggle-switch { position: relative; width: 44px; height: 24px; background-color: #e5e7eb; border-radius: 9999px; transition: background-color 0.2s; cursor: pointer; } .toggle-switch.active { background-color: #0b57d0; }
.toggle-dot { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background-color: white; border-radius: 50%; transition: transform 0.2s; } .toggle-switch.active .toggle-dot { transform: translateX(20px); }
.post-modal-layout { display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; gap: 0; }
body.reel-mode #mobile-bottom-nav { display: none !important; }
.mobile-reel-view .mobile-header, .mobile-reel-view .mobile-footer { display: none !important; }
.mobile-reel-view .reel-ui-layer { display: flex !important; }
.reel-ui-layer { display: none; flex-direction: column; justify-content: space-between; position: absolute; inset: 0; z-index: 40; padding: 16px 12px 30px; background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 30%, rgba(0,0,0,0) 80%, rgba(0,0,0,0.4) 100%); pointer-events: none; }
.reel-interact-btn { pointer-events: auto; display: flex; flex-direction: column; align-items: center; gap: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
.reel-audio-btn { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #1f1f1f; animation: spin 4s linear infinite; }
@media (min-width: 768px) { .post-modal-layout { flex-direction: row; width: 90vw; max-width: 1200px; height: 85vh; gap: 16px; align-items: center; background: transparent; }
.stage-panel { flex: 1; height: 100%; background: radial-gradient(circle at center, #2e2e2e 0%, #1a1a1a 100%); border-radius: 24px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.6); min-width: 0; }
.discussion-panel { width: 420px; height: 100%; background: #ffffff; border-radius: 24px; display: flex; flex-direction: column; box-shadow: 0 15px 40px -10px rgba(0,0,0,0.15); overflow: hidden; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1); } }
@media (max-width: 767px) { .post-modal-layout { background: #fff; width: 100vw; } .stage-panel { flex: 1; background: #000; width: 100%; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.discussion-panel { position: absolute; bottom: 0; left: 0; right: 0; height: 75vh; background: #fff; z-index: 50; border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); display: flex; flex-direction: column; } .discussion-panel.open { transform: translateY(0); } }
.discussion-scroll { flex: 1; overflow-y: auto; padding: 0; background: #fdfdfd; }
.comment-row { display: flex; gap: 12px; align-items: flex-start; } .comment-bubble { background: #f3f4f6; padding: 8px 12px; border-radius: 0 16px 16px 16px; font-size: 14px; line-height: 1.5; color: var(--on-surface); position: relative; }
.comment-row.me { flex-direction: row-reverse; } .comment-row.me .comment-bubble { background: #eff6ff; border-radius: 16px 0 16px 16px; color: #1e3a8a; }
.post-carousel { position: relative; width: 100%; overflow: hidden; background-color: #000; aspect-ratio: 4/5; }
.post-carousel-inner { display: flex; transition: transform 0.3s ease-out; height: 100%; width: 100%; }
.post-carousel-item { min-width: 100%; flex: 0 0 100%; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; }
.post-carousel-item img, .post-carousel-item video { width: 100%; height: 100%; object-fit: cover; }
.carousel-dots { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; justify-content: center; gap: 6px; z-index: 10; }
.carousel-dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(255,255,255,0.5); transition: bg 0.2s; } .carousel-dot.active { background: #fff; }
.carousel-nav-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; border: none; }
.carousel-nav-btn.prev { left: 8px; } .carousel-nav-btn.next { right: 8px; }
.play-pause-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.2s; } .play-pause-overlay.show { opacity: 1; }
</style>
</head>
<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]">
<div id="app-loader"><div class="loader-spinner"></div></div>
<div id="custom-alert" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
<div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-[90%] transform scale-95 transition-transform duration-200" id="custom-alert-box">
<h3 class="text-lg font-bold text-[#1f1f1f] mb-2" id="alert-title">Confirm</h3><p class="text-gray-600 mb-6 text-sm" id="alert-msg">Are you sure?</p>
<div class="flex justify-end gap-3"><button class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg transition-colors" onclick="closeAlert(false)">Cancel</button><button class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700 transition-colors" id="alert-confirm-btn">Confirm</button></div></div></div>
<div id="username-modal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
<div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative flex flex-col items-center">
<h2 class="text-2xl font-bold text-[#1f1f1f] mb-2 google-font">Create Username</h2><p class="text-sm text-gray-500 mb-6 text-center">Choose a unique username to identify yourself on EduLink.</p>
<div class="w-full relative mb-4"><span class="absolute left-4 top-3 text-gray-400 font-bold">@</span><input type="text" id="new-username-input" class="w-full bg-gray-100 rounded-xl py-3 pl-8 pr-4 outline-none focus:ring-2 focus:ring-blue-500 font-medium" placeholder="username"></div>
<button onclick="saveUsername()" class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Start Exploring</button></div></div>
<div id="add-link-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
<div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-2xl p-6 relative">
<h3 class="text-lg font-bold text-gray-900 mb-4">Add Link</h3>
<div class="space-y-4 mb-6"><div><label class="text-xs font-bold text-gray-500 uppercase">Title</label><input type="text" id="new-link-title" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div><div><label class="text-xs font-bold text-gray-500 uppercase">URL</label><input type="url" id="new-link-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div></div>
<div class="flex justify-end gap-3"><button onclick="document.getElementById('add-link-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button onclick="saveLink()" class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Add Link</button></div></div></div>
<div id="promo-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden">
<div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-2xl p-6 relative">
<h3 class="text-lg font-bold text-gray-900 mb-4">Edit Promo</h3>
<div class="space-y-4 mb-6"><div><label class="text-xs font-bold text-gray-500 uppercase">Image URL</label><div class="flex gap-2"><input type="text" id="promo-img-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"><button onclick="document.getElementById('promo-file-input').click()" class="icon-btn bg-gray-100 hover:bg-gray-200"><i data-lucide="upload" class="w-4 h-4"></i></button></div><input type="file" id="promo-file-input" class="hidden" accept="image/*" onchange="handlePromoFile(event)"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Target Link</label><input type="url" id="promo-target-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div></div>
<div class="flex justify-end gap-3"><button onclick="document.getElementById('promo-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button onclick="savePromo()" class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Save</button></div></div></div>
<div id="post-options-overlay" class="fixed inset-0 z-[75] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="hidePostMenu()">
<div id="post-options-modal" class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl p-4 transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
<div class="flex justify-center mb-4 md:hidden"><div class="w-12 h-1.5 bg-gray-300 rounded-full"></div></div><div id="post-options-content" class="flex flex-col gap-2"></div><button onclick="hidePostMenu()" class="w-full py-3 mt-2 font-bold text-gray-900 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors">Cancel</button></div></div>
<div id="upload-options-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden" onclick="document.getElementById('upload-options-modal').classList.add('hidden')">
<div class="bg-white w-[90%] max-w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform" onclick="event.stopPropagation()">
<h3 class="text-center font-bold text-gray-900 mb-4 text-lg">Select Upload Type</h3><div class="flex flex-col gap-3">
<button onclick="triggerUpload('single')" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors"><div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i data-lucide="image" class="w-5 h-5"></i></div><span class="font-bold text-gray-700">Single</span></button>
<button onclick="triggerUpload('multiple')" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors"><div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i data-lucide="layers" class="w-5 h-5"></i></div><span class="font-bold text-gray-700">Multiple (Carousel)</span></button></div></div></div>
<div id="mobile-notifications-header" class="md:hidden fixed top-0 left-0 w-full bg-white z-30 flex-col hidden border-b border-gray-100 pb-0">
<div class="h-14 flex items-center justify-between px-4 shrink-0 relative"><span class="font-bold text-lg text-[#1f1f1f]">Notifications</span><div class="flex items-center gap-3"><button onclick="toggleNotifSearchMobile()" class="icon-btn"><i data-lucide="search" class="w-5 h-5 text-[#1f1f1f]"></i></button><div class="relative"><button onclick="toggleNotifMenu()" class="icon-btn"><i data-lucide="more-vertical" class="w-5 h-5 text-[#1f1f1f]"></i></button><div id="notif-menu-dropdown" class="absolute right-0 top-10 bg-white border border-gray-100 shadow-xl rounded-xl z-50 w-48 hidden flex-col overflow-hidden"><button onclick="toggleNotifSelection()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium border-b border-gray-50 text-gray-700">Select</button><button onclick="deleteSelectedNotifs()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium text-red-500">Delete Selected</button><button onclick="clearAllNotifications()" class="px-4 py-3 text-left hover:bg-gray-50 text-sm font-medium text-red-500">Delete All</button></div></div></div></div>
<div id="mobile-notif-search-container" class="px-4 pb-2 hidden"><div class="relative"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i><input type="text" id="notif-search" placeholder="Search..." oninput="handleNotifSearch(this.value)" class="w-full bg-gray-100 rounded-xl py-2 pl-9 pr-4 text-sm outline-none focus:ring-1 focus:ring-blue-500 transition-all"></div></div>
<div class="tab-group mb-0 mx-0 w-full"><button onclick="switchNotifTab('friends')" id="ntab-friends-mobile" class="tab-btn active"><i data-lucide="users" class="w-5 h-5"></i></button><button onclick="switchNotifTab('others')" id="ntab-others-mobile" class="tab-btn"><i data-lucide="bell" class="w-5 h-5"></i></button><button onclick="switchNotifTab('official')" id="ntab-official-mobile" class="tab-btn"><i data-lucide="megaphone" class="w-5 h-5"></i></button></div></div>
<div id="thread-overlay" class="fixed inset-0 z-[65] hidden flex justify-center items-end md:items-center">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeThread()"></div>
<div class="bg-white w-full md:w-[500px] h-[90vh] md:h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative flex flex-col transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
<div class="discussion-header"><div class="flex items-center gap-3"><button onclick="closeThread()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down" class="w-6 h-6 text-gray-600"></i></button><span class="font-bold text-lg text-[#1f1f1f]">Thread</span></div><button onclick="closeThread()" class="icon-btn hover:bg-gray-100 hidden md:flex"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div>
<div id="thread-content" class="discussion-scroll bg-white"></div><div class="discussion-footer"><div class="chat-input-wrapper"><img id="thread-input-avatar" src="" class="w-7 h-7 rounded-full bg-gray-200 object-cover mr-2 shrink-0"><textarea id="thread-input" placeholder="Reply to thread..." class="flex-1 max-h-20 bg-transparent outline-none text-sm resize-none h-5 py-0.5 text-gray-800 placeholder-gray-400" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitThreadReply(); }"></textarea><button onclick="submitThreadReply()" class="text-[#0b57d0] font-bold text-sm px-3 py-1 hover:bg-blue-50 rounded-full transition-colors">Post</button></div></div></div></div>
<div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-center">
<div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closePostView()"></div>
<div class="post-modal-layout scale-in relative z-10">
<div class="mobile-header md:hidden"><div class="flex items-center gap-3 cursor-pointer" onclick="closePostView(); if(window.currentViewingProfileId) showProfile(window.currentViewingProfileId)"><img id="mobile-post-pfp" class="w-8 h-8 rounded-full border border-gray-200 object-cover bg-white"><span id="mobile-post-username" class="font-bold text-sm text-[#1f1f1f]">User</span></div><button onclick="closePostView()" class="icon-btn hover:bg-gray-100 w-9 h-9 border border-gray-200"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div>
<div id="mobile-reel-header" class="mobile-reel-header md:hidden"><button onclick="closePostView()" class="reel-back-btn"><i data-lucide="chevron-left" class="w-6 h-6"></i></button><span class="ml-4 text-white font-bold text-lg">Frame</span></div>
<div id="post-view-media-container" class="stage-panel group relative"><div id="video-play-overlay" class="play-pause-overlay"><i data-lucide="play" class="play-pause-icon"></i></div></div>
<div id="reel-ui-layer" class="reel-ui-layer md:hidden"><div class="mt-14 pointer-events-none"></div><div class="flex items-end justify-between w-full"><div class="flex flex-col gap-3 max-w-[80%] text-white drop-shadow-md pointer-events-auto pb-2"><div class="flex items-center gap-2 cursor-pointer" id="reel-user-info-area"><img id="reel-user-avatar" src="" class="w-8 h-8 rounded-full border border-white/50 object-cover"><span id="reel-username" class="font-bold text-sm">Username</span><button id="reel-follow-btn" class="bg-white/20 backdrop-blur text-xs px-2.5 py-1 rounded-md font-medium border border-white/30 hidden">Follow</button></div><div id="reel-caption" class="text-sm leading-snug opacity-90 break-words"></div></div><div class="flex flex-col gap-5 items-center pointer-events-auto pb-2 mr-1"><div class="reel-interact-btn cursor-pointer"><div onclick="if(window.currentViewingPostId) toggleLike(window.currentViewingPostId)"><i id="reel-like-icon" data-lucide="heart" class="reel-interact-icon"></i></div><span id="reel-like-count" class="reel-interact-text mt-1 p-1" onclick="if(window.currentViewingPostId) openLikes(window.currentViewingPostId)">0</span></div><div class="reel-interact-btn cursor-pointer" onclick="toggleMobileCommentDrawer()"><i data-lucide="message-circle" class="reel-interact-icon"></i><span id="reel-comment-count" class="reel-interact-text">0</span></div><div class="reel-interact-btn cursor-pointer" onclick="if(window.currentViewingPostId) sharePost(window.currentViewingPostId)"><i data-lucide="send" class="reel-interact-icon transform -rotate-12"></i></div><div class="reel-interact-btn cursor-pointer" onclick="if(window.currentViewingPostId) toggleSave(window.currentViewingPostId)"><i id="reel-save-icon" data-lucide="bookmark" class="reel-interact-icon"></i></div><div class="reel-interact-btn mt-2"><div class="reel-audio-btn"><i data-lucide="disc" class="w-5 h-5 text-white"></i></div></div></div></div></div>
<div class="mobile-footer md:hidden"><div class="mobile-actions-bar"><div class="mobile-action-group"><i id="mobile-action-like" data-lucide="heart" class="w-7 h-7 text-[#1f1f1f] cursor-pointer" onclick="if(window.currentViewingPostId) toggleLike(window.currentViewingPostId)"></i><i data-lucide="message-circle" class="w-7 h-7 text-[#1f1f1f] cursor-pointer" onclick="toggleMobileCommentDrawer()"></i><i data-lucide="send" class="w-7 h-7 text-[#1f1f1f] cursor-pointer" onclick="if(window.currentViewingPostId) sharePost(window.currentViewingPostId)"></i></div><i id="mobile-action-save" data-lucide="bookmark" class="w-7 h-7 text-[#1f1f1f] cursor-pointer" onclick="if(window.currentViewingPostId) toggleSave(window.currentViewingPostId)"></i></div><div id="mobile-like-count" class="text-sm font-bold text-[#1f1f1f] mb-1">0 likes</div><div id="mobile-post-caption" class="mobile-caption-text"></div></div>
<div class="discussion-panel"><div class="discussion-header"><div class="flex items-center gap-3"><div class="flex items-center gap-3 md:flex hidden"><img id="post-view-avatar" class="w-10 h-10 rounded-full border border-gray-100 object-cover cursor-pointer hover:ring-2 hover:ring-blue-100 transition-all"><div class="flex flex-col"><span id="post-view-username" class="font-bold text-sm text-gray-900 cursor-pointer hover:underline">Username</span><span class="text-[11px] text-gray-400 font-medium" id="post-view-date">Just now</span></div></div><span class="md:hidden font-bold text-lg">Comments</span></div><button onclick="closePostView()" class="icon-btn hover:bg-gray-100 hidden md:flex"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button><button onclick="toggleMobileCommentDrawer()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button></div>
<div id="post-view-scroll" class="discussion-scroll scroll-smooth"><div id="post-view-caption-area" class="caption-box"></div><div id="post-view-comments" class="comments-list"></div></div>
<div class="discussion-footer"><div class="flex justify-between items-center mb-3 px-1 hidden md:flex"><div class="flex gap-4"><i id="post-view-like-btn" data-lucide="heart" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform"></i><i data-lucide="message-circle" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform" onclick="document.getElementById('comment-input-desktop').focus()"></i><i data-lucide="send" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform" onclick="if(window.currentViewingPostId) sharePost(window.currentViewingPostId)"></i></div><div class="flex gap-4 items-center"><span class="font-bold text-sm text-gray-900" id="post-view-likes-count">0 likes</span><i id="post-view-save-btn" data-lucide="bookmark" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform"></i></div></div><div class="chat-input-wrapper"><textarea id="comment-input-desktop" placeholder="Add a comment..." class="flex-1 max-h-20 bg-transparent outline-none text-sm resize-none h-5 py-0.5 text-gray-800 placeholder-gray-400" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); submitCommentDesktop(); }"></textarea><button onclick="submitCommentDesktop()" class="text-[#0b57d0] font-bold text-sm px-3 py-1 hover:bg-blue-50 rounded-full transition-colors">Post</button></div></div></div></div></div>
<div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()"><button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i data-lucide="x" class="w-8 h-8"></i></button><div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div></div>
<div id="toast" class="toast"><i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span></div>
<div id="likes-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeLikes()"><div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()"><div class="flex justify-between items-center p-4 border-b border-gray-100"><h3 class="text-lg font-bold text-gray-900">Likes</h3><button onclick="closeLikes()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div></div></div>
<div id="settings-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeSettings()"><div class="bg-white w-[90%] max-w-[450px] rounded-[24px] shadow-2xl p-6 relative transform transition-all scale-100 overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-[#1f1f1f] google-font">Settings</h2><button onclick="closeSettings()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-y-auto space-y-6"><div><h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Privacy</h3><div class="flex items-center justify-between py-2"><div><div class="font-medium text-gray-900">Private Account</div><div class="text-xs text-gray-500">Only followers can see your posts</div></div><div id="toggle-privacy" class="toggle-switch" onclick="togglePrivacy()"><div class="toggle-dot"></div></div></div></div><div><h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">About</h3><a href="pre.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="crown" class="w-4 h-4"></i></div><span class="font-medium text-gray-900">Premium</span></div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i></a><a href="p.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i data-lucide="shield" class="w-4 h-4"></i></div><span class="font-medium text-gray-900">Privacy Policy</span></div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i></a></div></div><div class="mt-6 pt-4 border-t border-gray-100"><button onclick="doLogout()" class="w-full py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-colors">Log Out</button></div></div></div>
<div id="user-list-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeUserList()"><div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()"><div class="flex justify-between items-center p-4 border-b border-gray-100"><h3 class="text-lg font-bold text-gray-900" id="user-list-title">Users</h3><button onclick="closeUserList()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button></div><div id="user-list-content" class="flex-1 overflow-y-auto p-2"></div></div></div>
<div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()"><div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2><button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="grid grid-cols-1 gap-4"><div class="create-option-card" onclick="openCompose()"><div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div><span class="font-bold text-[#1f1f1f]">Post</span></div><div id="create-option-ad" class="create-option-card hidden" onclick="openPromoModal(event); closeCreateMenu()"><div class="create-icon-bg"><i data-lucide="megaphone" class="w-6 h-6"></i></div><span class="font-bold text-[#1f1f1f]">Ad</span></div></div></div></div>
<div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeEditProfile()"><div id="edit-profile-modal" class="bg-white w-full h-full md:w-[95%] md:max-w-[500px] md:h-auto md:max-h-[90vh] md:rounded-[24px] shadow-2xl relative transform scale-100 md:scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()"><div class="flex justify-between items-center p-4 border-b border-gray-100 shrink-0"><h2 class="text-xl font-bold google-font">Edit Profile</h2><button onclick="closeEditProfile()" class="icon-btn"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-y-auto p-6 pb-24 md:pb-6"><div class="flex flex-col gap-5"><div class="flex flex-col items-center mb-2"><div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()"><img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-2 border-gray-100 object-cover"><div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="text-white w-6 h-6"></i></div></div><input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)"><input type="file" id="edit-banner-input" class="hidden" accept="image/*" onchange="handleEditBannerSelect(event)"></div><div><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Banner Image</label><div id="banner-edit-area" class="banner-edit-container group mb-2 h-36" onclick="document.getElementById('edit-banner-input').click()"><img id="edit-banner-preview" src="" class="banner-edit-img" style="object-position: center 50%"><div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="upload" class="text-white w-6 h-6"></i></div></div><div class="text-[10px] text-gray-400 mb-1 flex justify-between"><span>Click banner to change, drag to reposition</span> <span id="banner-pos-hint">50%</span></div></div><div><label class="text-xs font-bold text-gray-500 uppercase">Display Name</label><input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input type="text" id="edit-email" class="w-full border-b border-gray-200 py-2 outline-none text-gray-500 bg-transparent select-text" disabled></div><div><label class="text-xs font-bold text-gray-500 uppercase">Bio</label><textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="3"></textarea></div><button id="save-profile-btn" onclick="saveProfileChanges()" class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all mt-4 mb-8 md:mb-0">Save Changes</button></div></div></div></div>
<input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
<div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"><div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0"><div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group"><img id="event-cover-preview" class="w-full h-full object-cover"><button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20"><i data-lucide="x" class="w-4 h-4"></i></button><button onclick="document.getElementById('event-cover-input').click()" class="absolute bottom-2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20">Change</button></div><button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button><div class="p-8 pt-6"><div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()"><i data-lucide="image" class="w-4 h-4"></i> Add cover</div><input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font"><div class="flex flex-col gap-1 mb-6"><div class="notion-input-row"><div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div><input type="date" id="event-date" class="notion-input"></div><div class="notion-input-row"><div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div><input type="time" id="event-time" class="notion-input"></div><div class="notion-input-row"><div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div><input type="text" id="event-location" placeholder="Add location..." class="notion-input"></div></div><textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea><div class="flex justify-end mt-6 pt-4 border-t border-gray-100"><button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button></div></div></div></div>
<div id="compose-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCompose()">
<div id="compose-modal" class="bg-white w-full h-full md:w-[95%] md:max-w-[620px] md:h-auto md:rounded-[24px] shadow-2xl p-6 relative transform scale-100 md:scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()">
<div class="compose-header"><div class="flex items-center gap-3"><button onclick="closeCompose()" class="icon-btn hover:bg-[#f0f4f9] w-8 h-8"><i data-lucide="x" class="w-5 h-5"></i></button><span class="compose-title" id="compose-title-text">Create Post</span></div><button onclick="publishPost()" class="md:hidden text-[#0b57d0] font-bold text-sm px-3 py-1 bg-blue-50 rounded-full">Post</button></div>
<div class="flex gap-3 mb-4 items-center"><img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover"><div><div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div></div></div>
<textarea id="compose-text" placeholder="What do you want to share today?" class="compose-textarea"></textarea>
<div id="media-preview-container" class="hidden media-preview-wrapper group"><div id="preview-inner" class="flex overflow-x-auto gap-2 p-2"></div><button onclick="removeMedia()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1.5 hover:bg-black/80 transition-colors shadow-sm z-10"><i data-lucide="x" class="w-4 h-4"></i></button></div>
<div id="collab-chips-container" class="flex flex-wrap mb-2"></div>
<div class="compose-tools"><div class="tool-group"><button onclick="openUploadOptions()" class="tool-btn" title="Upload Media"><i data-lucide="image" class="w-5 h-5"></i></button><button onclick="promptForImageLink()" class="tool-btn" title="Image Link"><i data-lucide="link" class="w-5 h-5"></i></button></div><button id="btn-publish" onclick="publishPost()" class="hidden md:block bg-[#0b57d0] text-white px-6 py-2 rounded-full font-bold text-[15px] hover:bg-[#0b57d0]/90 transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Post</button></div>
<div class="border-t border-gray-100 pt-3 mt-2"><div class="flex items-center justify-between cursor-pointer p-1" onclick="toggleComposeSettings()"><span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Post Settings</span><i data-lucide="chevron-down" id="compose-settings-arrow" class="w-4 h-4 text-gray-400 transition-transform"></i></div><div id="compose-settings-area" class="hidden mt-3 space-y-3 px-1"><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="lock" class="w-4 h-4"></i> Private</div><input type="checkbox" id="post-setting-privacy" class="accent-blue-600 w-4 h-4 cursor-pointer"></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="heart" class="w-4 h-4"></i> Show Likes</div><input type="checkbox" id="post-setting-likes" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-square" class="w-4 h-4"></i> Show Comments</div><input type="checkbox" id="post-setting-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="users" class="w-4 h-4"></i> View Likes</div><input type="checkbox" id="post-setting-like-view" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-circle" class="w-4 h-4"></i> Allow Comments</div><input type="checkbox" id="post-setting-allow-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div></div></div></div></div>
<aside id="main-sidebar" class="hidden md:flex app-panel">
<div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain"><h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1></div>
<button onclick="openCreateMenu()" class="create-btn hidden lg:flex"><i data-lucide="plus" class="w-5 h-5"></i><span>Create</span></button>
<nav class="flex-1 space-y-1" id="desktop-nav-items"><a href="#" onclick="switchView('feed');return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i><span class="hidden lg:block">Home</span></a><a href="#" onclick="switchView('explore');return false;" id="nav-explore" class="nav-item"><i data-lucide="compass" class="w-5 h-5"></i><span class="hidden lg:block">Explore</span></a><a href="#" onclick="switchView('network');return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i><span class="hidden lg:block">Network</span></a><a href="#" onclick="switchView('notifications');return false;" id="nav-notifications" class="nav-item relative"><i data-lucide="bell" class="w-5 h-5"></i><span class="hidden lg:block">Notifications</span><span id="nav-notif-badge" class="nav-badge">0</span></a><a href="#" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null);return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i><span class="hidden lg:block">Profile</span></a></nav>
<div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2"><div class="sidebar-user group cursor-pointer" onclick="openSettings()"><div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></div><div class="hidden lg:block"><div class="text-sm font-bold text-[#1f1f1f]">Settings</div></div></div><div class="sidebar-user group" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"><img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover"><div class="hidden lg:block"><div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div><div class="text-xs text-[#667085]">View Profile</div></div></div></div></aside>
<div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
<main id="main-panel" class="flex-1 app-panel min-w-0 relative">
<header id="main-header" class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 absolute top-0 w-full bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0] transition-transform duration-300"><div class="md:hidden flex items-center gap-3 cursor-pointer" onclick="switchView('feed')"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain"><h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1></div><div class="flex-1 max-w-[600px] relative group hidden md:block"><i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i><input type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]"></div><div class="flex items-center gap-3 pl-4"><button onclick="openSettings()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="settings" class="w-6 h-6"></i></button><button class="icon-btn relative" onclick="toggleNotifications()"><i data-lucide="bell" class="w-6 h-6"></i></button><img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"></div></header>
<div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white pt-16 md:pt-20"><div id="feed-container"></div><div class="flex flex-col items-center justify-center py-10 opacity-60"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-24 h-24 mb-4 opacity-80 grayscale hover:grayscale-0 transition-all duration-500"><h3 class="text-lg font-bold text-gray-400 google-font">Grow and Share</h3><p class="text-sm text-gray-400 text-center max-w-xs mt-1">Your network starts here.</p></div></div>
<div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2><div id="saved-container" class="space-y-4"></div></div>
<div id="view-network" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">My Network</h2><div class="tab-group mb-4 mx-0 md:mx-0"><button onclick="switchNetworkTab('people')" id="net-tab-people" class="tab-btn active">People</button><button onclick="switchNetworkTab('posts')" id="net-tab-posts" class="tab-btn">Posts</button></div><div id="network-content"></div></div>
<div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>
<div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-white pt-[106px] md:pt-6"><div class="flex justify-between items-center mb-6 px-4 md:px-0 hidden md:flex"><h2 class="text-2xl font-bold">Notifications</h2><button onclick="clearAllNotifications()" class="text-xs text-red-500 font-bold hover:underline">Clear All</button></div><div class="tab-group mb-4 mx-0 md:mx-0 hidden md:flex"><button onclick="switchNotifTab('friends')" id="ntab-friends" class="tab-btn active"><i data-lucide="users" class="w-4 h-4"></i> Following</button><button onclick="switchNotifTab('others')" id="ntab-others" class="tab-btn"><i data-lucide="bell" class="w-4 h-4"></i> Others</button><button onclick="switchNotifTab('official')" id="ntab-official" class="tab-btn"><i data-lucide="megaphone" class="w-4 h-4"></i> Official</button></div><div id="notification-list" class="flex flex-col w-full pb-24 md:pb-0"></div></div>
<div id="view-announcements" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-white pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Broadcast</h2><div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm max-w-2xl mb-8"><label class="block text-sm font-bold text-gray-700 mb-2">Message to All Users</label><textarea id="announcement-text" class="w-full h-32 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 mb-4" placeholder="Type here..."></textarea><div class="flex items-center justify-between"><button id="send-announcement-btn" onclick="sendAnnouncement()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Send Broadcast</button></div></div></div>
<div id="view-events" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><div class="flex items-center justify-between mb-6 px-4 md:px-0"><h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2><button onclick="openEventComposer()" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Event</button></div><div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0"></div></div>
<div id="view-explore" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:pt-20 hidden bg-white">
<div id="explore-header-container" class="sticky top-0 bg-white z-20 border-b border-gray-100 md:hidden"><div class="h-14 flex items-center px-4 shrink-0"><div class="relative bg-gray-100 rounded-xl flex items-center px-3 py-2 w-full"><i data-lucide="search" class="w-4 h-4 text-gray-400 mr-2"></i><input type="text" id="mobile-explore-search" class="bg-transparent border-none outline-none text-sm w-full" placeholder="Search..." oninput="handleSearch(this.value)"></div></div><div class="tab-group"><button id="tab-explore-main" onclick="switchExploreMainTab('explore')" class="tab-btn active"><i data-lucide="grid" class="w-5 h-5"></i></button><button id="tab-explore-video" onclick="switchExploreMainTab('video')" class="tab-btn"><i data-lucide="play-circle" class="w-5 h-5"></i></button><button id="tab-explore-people" onclick="switchExploreMainTab('people')" class="tab-btn"><i data-lucide="users" class="w-5 h-5"></i></button></div></div>
<div class="hidden md:block w-full bg-white z-10 border-b border-gray-100"><div class="max-w-5xl mx-auto tab-group border-b-0 px-0 justify-center"><button id="tab-explore-main-d" onclick="switchExploreMainTab('explore')" class="tab-btn active max-w-[120px]"><i data-lucide="grid" class="w-4 h-4"></i> Posts</button><button id="tab-explore-video-d" onclick="switchExploreMainTab('video')" class="tab-btn max-w-[120px]"><i data-lucide="play-circle" class="w-4 h-4"></i> Videos</button><button id="tab-explore-people-d" onclick="switchExploreMainTab('people')" class="tab-btn max-w-[120px]"><i data-lucide="users" class="w-4 h-4"></i> People</button></div></div>
<div id="explore-content-wrapper" class="pb-32 max-w-5xl mx-auto py-6"><div id="explore-people-results" class="hidden flex-col p-4 pt-0"></div><div id="explore-results" class="space-y-0 pt-0"></div></div></div>
</main>
<aside id="trending-panel" class="trending-panel hidden xl:flex app-panel mb-16 md:mb-0 flex-col bg-white"><div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20"><div class="flex items-center gap-3"><span class="text-[19px] font-bold text-[#1f1f1f] google-font">People</span></div></div><div class="flex-1 overflow-y-auto p-5"><div class="mb-8"><h3 class="text-lg font-bold text-[#1f1f1f] mb-4">Who to follow</h3><div id="who-to-follow-list" class="flex flex-col gap-4"></div></div><div id="promo-section" class="hidden"><div class="relative group rounded-xl overflow-hidden cursor-pointer"><a id="promo-link" href="#" target="_blank" class="block w-full h-full"><img id="promo-image" src="" class="w-full h-auto object-cover rounded-xl border border-gray-200 hover:opacity-95 transition-opacity"></a><button id="edit-promo-btn" onclick="openPromoModal(event)" class="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/80 hidden z-20"><i data-lucide="edit-2" class="w-4 h-4"></i></button><div class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-md font-medium uppercase tracking-wide backdrop-blur-sm pointer-events-none">Promoted</div></div></div></div></aside></div>
<nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg transition-transform duration-300">
<div class="mobile-nav-item active" onclick="switchView('feed')"><i data-lucide="home"></i></div><div class="mobile-nav-item" onclick="switchView('explore')"><i data-lucide="compass"></i></div><div class="mobile-nav-item" onclick="openCreateMenu()"><i data-lucide="plus-square"></i></div><div class="mobile-nav-item" onclick="switchView('notifications')"><div class="relative"><i data-lucide="bell"></i><span id="mobile-footer-badge" class="mobile-footer-badge">0</span></div></div><div class="mobile-nav-item" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"><img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200"></div></nav>
<input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">
<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import {getAuth,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import {getFirestore,collection,doc,getDoc,setDoc,updateDoc,deleteDoc,arrayUnion,arrayRemove,addDoc,onSnapshot,query,orderBy,where,serverTimestamp,getDocs,writeBatch} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";import {getStorage,ref,getDownloadURL,uploadBytes} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
const firebaseConfig={apiKey:"AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",authDomain:"edulinki.firebaseapp.com",projectId:"edulinki",storageBucket:"edulinki.firebasestorage.app",messagingSenderId:"248886466474",appId:"1:248886466474:web:160043201a6b28bafbbdd3",measurementId:"G-MQBH12VL7N"},app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),storage=getStorage(app);window.auth=auth;window.db=db;
let currentUser=null,users=[],posts=[],notifications=[],savedPosts=[],activeNotifTab='friends',activeNetworkTab='people',alertCallback=null;
window.replyingToCommentId=null;window.currentViewingProfileId=null;window.activeExploreTab='explore';window.activeExploreCategory='For You';window.currentProfileTab='posts';window.currentMedia=[];window.uploadMode='single';window.currentEventCover=null;window.editingPostId=null;window.threadParentCommentId=null;window.threadPostId=null;
let currentEventCoverBlob=null,currentAvatarBlob=null,currentBannerBlob=null;window.currentPromoBlob=null;window.notifSelectionMode=false;window.selectedNotifs=new Set();window.notifSearchTerm='';window.selectedCollaborators=[];let lastScrollTop=0;
const d=document,$=i=>d.getElementById(i),show=i=>$(i)?.classList.remove('hidden'),hide=i=>$(i)?.classList.add('hidden'),toggle=i=>$(i)?.classList.toggle('hidden');
const refreshIcons=()=>{if(window.lucide)window.lucide.createIcons()},formatDate=t=>{if(!t)return'';let d=t.toDate?t.toDate():new Date(t);if(isNaN(d.getTime()))return'';let n=new Date(),diff=(n-d)/1000;return diff<60?'Just now':diff<3600?Math.floor(diff/60)+'m ago':diff<86400?Math.floor(diff/3600)+'h ago':Math.floor(diff/86400)+'d ago'};
const formatContent=t=>{if(!t)return'';return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,'<br>').replace(/@(\w+)/g,(m,u)=>{let f=users.find(x=>(x.username||'').toLowerCase()===u.toLowerCase());return f?`<span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation();showProfile('${f.id}')">@${u}</span>`:`<span class="text-blue-600 font-bold">@${u}</span>`})};
$('view-feed')?.addEventListener('scroll',()=>{let c=$('view-feed').scrollTop;$('main-header').style.transform=c>lastScrollTop&&c>60?'translateY(-100%)':'translateY(0)';lastScrollTop=c<=0?0:c},{passive:true});
onAuthStateChanged(auth,async u=>{if(u){let ref=doc(db,"users",u.uid),snap=await getDoc(ref),isOff=u.email==='edulinkbht@gmail.com';if(snap.exists()){currentUser={id:u.uid,...snap.data()};if(isOff&&!currentUser.isOfficial)updateDoc(ref,{isOfficial:true})}else{currentUser={id:u.uid,name:u.displayName||u.email.split('@')[0],email:u.email,avatar:u.photoURL||`https://api.dicebear.com/9.x/lorelei/svg?seed=${u.uid}`,bio:"New EduLink Member",following:[],followers:[],friends:[],saved:[],links:[],isOfficial:isOff,settings:{privateNetwork:false},username:""};setDoc(ref,currentUser)}currentUser.following||=[];currentUser.followers||=[];currentUser.friends||=[];currentUser.saved||=[];currentUser.links||=[];currentUser.settings||={privateNetwork:false};window.currentUser=currentUser;savedPosts=currentUser.saved;if(!currentUser.username)show('username-modal');updateUI();initListeners();refreshIcons();initBannerDrag();$('app-loader').style.opacity='0';setTimeout(()=>$('app-loader').remove(),500);let p=new URLSearchParams(location.search).get('postId');if(p)setTimeout(()=>openPostView(p),1000)}else location.href='index.html'});
window.saveUsername=async()=>{let v=$('new-username-input').value.trim().toLowerCase();if(v.length<3||/\s/.test(v))return showToast("Invalid username",true);let q=query(collection(db,"users"),where("username","==",v)),s=await getDocs(q);if(!s.empty)return showToast("Taken",true);updateDoc(doc(db,"users",currentUser.id),{username:v});currentUser.username=v;hide('username-modal');showToast("Saved")};
function initListeners(){onSnapshot(collection(db,"users"),s=>{users=s.docs.map(d=>({id:d.id,...d.data()}));if(!$('view-network').classList.contains('hidden'))renderNetwork();if(!$('view-profile').classList.contains('hidden')&&window.currentViewingProfileId)showProfile(window.currentViewingProfileId,window.currentProfileTab);renderRightSidebar();refreshIcons()});onSnapshot(doc(db,"global","promo"),s=>{if(s.exists()){let d=s.data();if(d.imageUrl){show('promo-section');$('promo-image').src=d.imageUrl;$('promo-link').href=d.linkUrl||'#'}}});onSnapshot(query(collection(db,"posts"),orderBy("timestamp","desc")),{includeMetadataChanges:true},s=>{posts=s.docs.map(d=>({id:d.id,...d.data(),timestamp:d.data().timestamp}));if(s.metadata.hasPendingWrites)return;let ch=s.docChanges(),ren=$('feed-container').children.length===0;ch.forEach(c=>{if(c.type!=='modified')ren=true;else{$(`like-count-${c.doc.id}`)&&( $(`like-count-${c.doc.id}`).innerText=c.doc.data().likes?.length||0);$(`comment-count-${c.doc.id}`)&&( $(`comment-count-${c.doc.id}`).innerText=c.doc.data().comments?.length||0)}});if(!$('view-feed').classList.contains('hidden')&&ren)renderFeed();if(!$('view-saved').classList.contains('hidden'))renderSaved();if(!$('view-profile').classList.contains('hidden')&&window.currentViewingProfileId)showProfile(window.currentViewingProfileId,window.currentProfileTab);if(!$('view-network').classList.contains('hidden')&&activeNetworkTab==='posts')renderNetwork();if(!$('view-explore').classList.contains('hidden'))handleSearch($('global-search').value||$('mobile-explore-search').value);if(!$('post-view-overlay').classList.contains('hidden')&&window.currentViewingPostId){renderCommentsInModal(window.currentViewingPostId);updatePostViewStats(window.currentViewingPostId)}renderRightSidebar()});onSnapshot(query(collection(db,"notifications"),where("receiverId","==",currentUser.id)),s=>{notifications=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.timestamp?.toDate?b.timestamp.toDate():0)-(a.timestamp?.toDate?a.timestamp.toDate():0));let u=notifications.filter(n=>!n.read).length,txt=u>99?'99+':u;if($('nav-notif-badge')){if(u>0){$('nav-notif-badge').style.display='flex';$('nav-notif-badge').innerText=txt}else $('nav-notif-badge').style.display='none'}if($('mobile-footer-badge')){if(u>0){$('mobile-footer-badge').style.display='flex';$('mobile-footer-badge').innerText=txt}else $('mobile-footer-badge').style.display='none'}if(!$('view-notifications').classList.contains('hidden'))renderNotifications();refreshIcons()})}
window.renderRightSidebar=()=>{renderWhoToFollow()};function renderWhoToFollow(){let l=$('who-to-follow-list');if(!l||!currentUser)return;l.innerHTML='';let c=users.filter(u=>u.id!==currentUser.id&&u.name&&u.name!=='undefined').sort(()=>0.5-Math.random()).slice(0,3);if(c.length===0)l.innerHTML=`<div class="text-sm text-gray-400 p-2">No suggestions.</div>`;else c.forEach(u=>{let d=document.createElement('div');d.className="flex items-center justify-between";d.innerHTML=`<div class="flex items-center gap-3 overflow-hidden" onclick="showProfile('${u.id}')"><img src="${u.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover shrink-0"><div class="min-w-0"><div class="font-bold text-sm text-gray-900 truncate hover:underline cursor-pointer">${u.name}</div><div class="text-xs text-gray-500 truncate">@${u.username||'user'}</div></div></div><button onclick="event.stopPropagation();toggleFollow('${u.id}')" class="bg-black text-white text-xs px-3 py-1.5 rounded-full font-bold hover:bg-gray-800 transition-colors">Follow</button>`;l.appendChild(d)})}
window.openPromoModal=e=>{e?.stopPropagation();show('promo-modal');if($('promo-image').src)$('promo-img-url').value=$('promo-image').src;if($('promo-link').href)$('promo-target-url').value=$('promo-link').href};window.handlePromoFile=e=>{if(e.target.files[0]){window.currentPromoBlob=e.target.files[0];showToast("Image selected")}}
window.savePromo=async()=>{let b=event.target,ot=b.innerText;b.innerText="Saving...";b.disabled=true;let i=$('promo-img-url').value.trim(),l=$('promo-target-url').value.trim();if(window.currentPromoBlob)try{i=await uploadToImgHippo(window.currentPromoBlob)}catch(e){return showToast("Upload failed")}if(!i){b.innerText=ot;b.disabled=false;return showToast("Image URL required")}await setDoc(doc(db,"global","promo"),{imageUrl:i,linkUrl:l});showToast("Promo updated!");hide('promo-modal');window.currentPromoBlob=null;b.innerText=ot;b.disabled=false};
window.updatePostViewStats=pid=>{let p=posts.find(x=>x.id===pid);if(!p)return;$(`post-view-likes-count`)&&( $(`post-view-likes-count`).innerText=`${p.likes?p.likes.length:0} likes`);$(`mobile-like-count`)&&( $(`mobile-like-count`).innerText=`${p.likes?p.likes.length:0} likes`);$(`reel-like-count`)&&( $(`reel-like-count`).innerText=p.likes?p.likes.length:0);$(`reel-comment-count`)&&( $(`reel-comment-count`).innerText=p.comments?p.comments.length:0);if($('reel-like-icon')){let l=p.likes?.includes(currentUser.id);$('reel-like-icon').className=l?'reel-interact-icon fill-red-500 text-red-500':'reel-interact-icon text-white'}if($('reel-save-icon')){let s=savedPosts.includes(pid);$('reel-save-icon').className=s?'reel-interact-icon fill-yellow-500 text-yellow-500':'reel-interact-icon text-white'}};
function updateUI(){if(!currentUser)return;$('sidebar-name')&&( $('sidebar-name').innerText=currentUser.name);$('sidebar-avatar')&&( $('sidebar-avatar').src=currentUser.avatar);$('mobile-avatar')&&( $('mobile-avatar').src=currentUser.avatar);$('header-avatar')&&( $('header-avatar').src=currentUser.avatar);$('compose-name')&&( $('compose-name').innerText=currentUser.name);$('compose-avatar')&&( $('compose-avatar').src=currentUser.avatar);$('edit-name')&&( $('edit-name').value=currentUser.name);$('edit-bio')&&( $('edit-bio').value=currentUser.bio);$('edit-avatar-preview')&&( $('edit-avatar-preview').src=currentUser.avatar);$('edit-banner-preview')&&( $('edit-banner-preview').src=currentUser.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80');$('thread-input-avatar')&&( $('thread-input-avatar').src=currentUser.avatar);$('banner-pos-hint').innerText=`${currentUser.bannerPos||50}%`;$('toggle-privacy')?.classList.toggle('active',currentUser.settings?.privateNetwork);if(currentUser.email==='edulinkbht@gmail.com'){$('nav-announcements')||$('desktop-nav-items').insertAdjacentHTML('beforeend',`<a href="#" onclick="switchView('announcements');return false;" id="nav-announcements" class="nav-item text-blue-600"><i data-lucide="megaphone" class="w-5 h-5"></i><span class="hidden lg:block">Announcements</span></a>`);show('edit-promo-btn');show('promo-section');show('create-option-ad')}else hide('create-option-ad');refreshIcons()}
window.showAlert=(m,cb)=>{$('alert-msg').innerText=m;show('custom-alert');setTimeout(()=>{$('custom-alert').classList.remove('opacity-0');$('custom-alert-box').classList.remove('scale-95')},10);alertCallback=cb;let b=$('alert-confirm-btn'),n=b.cloneNode(true);b.parentNode.replaceChild(n,b);n.onclick=()=>{if(alertCallback)alertCallback();closeAlert(true)}};window.closeAlert=()=>{ $('custom-alert').classList.add('opacity-0');$('custom-alert-box').classList.add('scale-95');setTimeout(()=>hide('custom-alert'),200)};
let isDragB=false,startY=0,initBP=50,curBP=50;function initBannerDrag(){let c=$('banner-edit-area');c.addEventListener('mousedown',sd);c.addEventListener('touchstart',sd,{passive:false});window.addEventListener('mousemove',dg);window.addEventListener('touchmove',dg,{passive:false});window.addEventListener('mouseup',ed);window.addEventListener('touchend',ed)}function sd(e){if(e.target.closest('#banner-edit-area')){isDragB=true;startY=e.type.includes('mouse')?e.clientY:e.touches[0].clientY;initBP=curBP}}function dg(e){if(!isDragB)return;if(e.cancelable)e.preventDefault();let y=e.type.includes('mouse')?e.clientY:e.touches[0].clientY,d=startY-y,n=initBP+(d/2);curBP=Math.max(0,Math.min(100,n));$('edit-banner-preview').style.objectPosition=`center ${Math.round(curBP)}%`;$('banner-pos-hint').innerText=`${Math.round(curBP)}%`}function ed(){isDragB=false}
window.openSettings=()=>show('settings-overlay');window.closeSettings=()=>hide('settings-overlay');window.togglePrivacy=async()=>{let t=$('toggle-privacy'),p=!t.classList.contains('active');t.classList.toggle('active');let s=currentUser.settings||{};s.privateNetwork=p;await updateDoc(doc(db,"users",currentUser.id),{settings:s});currentUser.settings=s;showToast(`Account is now ${p?'Private':'Public'}`)};
window.switchView=v=>{['feed','events','saved','network','profile','explore','notifications','announcements'].forEach(x=>hide(`view-${x}`));let mh=$('main-header');if(mh){show('main-header');mh.style.transform='translateY(0)'}if($('mobile-bottom-nav'))show('mobile-bottom-nav');hide('mobile-notifications-header');hide('mobile-explore-header');if(v==='profile')hide('main-header');if(window.innerWidth<768){if(v==='notifications'){hide('main-header');show('mobile-notifications-header');$('mobile-notifications-header').classList.add('flex')}else if(v==='explore')hide('main-header')}if(window.innerWidth>=1280)show('trending-panel');if(v!=='ai')show(`view-${v}`);document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(e=>e.classList.remove('active'));if(v==='feed'){$('nav-feed').classList.add('active');document.querySelectorAll('.mobile-nav-item')[0].classList.add('active');if($('feed-container').children.length===0)renderFeed()}else if(v==='explore'){$('nav-explore').classList.add('active');document.querySelectorAll('.mobile-nav-item')[1].classList.add('active');switchExploreMainTab('explore')}else if(v==='network'){$('nav-network').classList.add('active');if($('network-content').children.length===0)renderNetwork()}else if(v==='notifications'){$('nav-notifications').classList.add('active');document.querySelectorAll('.mobile-nav-item')[3].classList.add('active');renderNotifications()}else if(v==='saved'){$('nav-saved')?.classList.add('active');renderSaved()}else if(v==='announcements'){$('nav-announcements')?.classList.add('active')}setTimeout(refreshIcons,10)};
window.switchNetworkTab=t=>{activeNetworkTab=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));$(`net-tab-${t}`).classList.add('active');renderNetwork()};
window.renderNetwork=()=>{let c=$('network-content');c.innerHTML="";if(activeNetworkTab==='people'){let g=document.createElement('div');g.className="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 md:px-0";let f=users.filter(u=>currentUser.following.includes(u.id));if(f.length===0)c.innerHTML=`<div class="flex flex-col items-center justify-center py-10 opacity-60"><p>You aren't following anyone.</p></div>`;else{f.forEach(u=>{let x=document.createElement('div');x.className="bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 hover:shadow-md transition-all cursor-pointer";x.onclick=()=>showProfile(u.id);x.innerHTML=`<img src="${u.avatar}" class="w-12 h-12 rounded-full border border-gray-100 bg-gray-50 object-cover"><div><h4 class="font-bold text-gray-900">${u.name} ${u.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 inline text-blue-500"></i>':''}</h4><p class="text-xs text-gray-500 line-clamp-1">${u.bio}</p></div><button onclick="event.stopPropagation();toggleFollow('${u.id}')" class="ml-auto text-xs border border-gray-200 px-3 py-1 rounded-full hover:bg-gray-50">Unfollow</button>`;g.appendChild(x)});c.appendChild(g)}}else{let fp=posts.filter(p=>currentUser.following.includes(p.authorId)),pc=document.createElement('div');pc.className="space-y-4 px-4 md:px-0";if(fp.length===0)pc.innerHTML=`<div class="text-center py-10 text-gray-400">No posts.</div>`;else fp.forEach(p=>pc.appendChild(createPostElement(p)));c.appendChild(pc)}refreshIcons()};
window.renderFeed=(ft="")=>{let c=$('feed-container');c.innerHTML="";let dp=[...posts];if(ft)dp=dp.filter(p=>p.content.toLowerCase().includes(ft.toLowerCase()));dp.filter(p=>{let a=users.find(u=>u.id===p.authorId),priv=a?.settings?.privateNetwork,foll=currentUser.following.includes(p.authorId);return p.authorId===currentUser.id||(priv?foll:(!p.settings||p.settings.privacy==='public'||foll))}).forEach(p=>c.appendChild(createPostElement(p)));refreshIcons()};
function createPostElement(p){let a=users.find(u=>u.id===p.authorId)||{name:'Unknown',avatar:'',id:p.authorId},lk=p.likes?.includes(currentUser.id),sv=savedPosts.includes(p.id),dt=formatDate(p.timestamp),s=p.settings||{},d=document.createElement('article');d.className="post-card group overflow-hidden fade-in";d.onclick=()=>openPostView(p.id);let mH="",cH=formatContent(p.content);if(p.media){let ma=Array.isArray(p.media)?p.media:[p.media];if(ma.length===1){let src=ma[0],iv=src.includes('video')||src.endsWith('.mp4');mH=iv?`<div class="mt-3 rounded-xl overflow-hidden aspect-[4/5] bg-black flex items-center justify-center"><video src="${src}" class="w-full h-full object-cover" controls onclick="event.stopPropagation()"></video></div>`:`<div class="mt-3 rounded-xl overflow-hidden cursor-pointer aspect-[4/5] bg-gray-100" onclick="event.stopPropagation();openLightbox('${src}','image')"><img src="${src}" class="w-full h-full object-cover"></div>`}else{let sl='',do_='';ma.forEach((src,i)=>{sl+=`<div class="post-carousel-item">${(src.includes('video')||src.endsWith('.mp4'))?`<video src="${src}" controls></video>`:`<img src="${src}">`}</div>`;do_+=`<div class="carousel-dot ${i===0?'active':''}" id="dot-${p.id}-${i}"></div>`});mH=`<div class="mt-3 rounded-xl overflow-hidden post-carousel" id="carousel-${p.id}"><div class="post-carousel-inner" id="inner-${p.id}">${sl}</div><button class="carousel-nav-btn prev" onclick="event.stopPropagation();moveCarousel('${p.id}',-1)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next" onclick="event.stopPropagation();moveCarousel('${p.id}',1)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><div class="carousel-dots">${do_}</div></div>`;if(!window.carouselStates)window.carouselStates={};window.carouselStates[p.id]={index:0,total:ma.length}}}let ac=p.collaborators?.filter(c=>c.status==='accepted')||[],ci=ac.length?`<div class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded-lg ml-2 cursor-pointer hover:bg-gray-200" onclick="event.stopPropagation();openCollabList('${p.id}')"><i data-lucide="user" class="w-3 h-3 text-gray-600"></i><span class="text-xs font-bold text-gray-600">${ac.length}</span></div>`:'';d.innerHTML=`<div class="p-4 md:p-5"><div class="post-header"><div class="flex gap-3"><div class="post-avatar-container"><img src="${a.avatar}" class="post-avatar"></div><div><div class="flex items-center"><span class="post-author-name" onclick="event.stopPropagation();showProfile('${a.id}')">${a.name}</span>${a.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 text-blue-500 ml-1"></i>':''}${ci}</div><div class="post-meta">${dt}</div></div></div><button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event,'${p.id}','${a.id}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button></div><div class="post-content"><div class="post-body">${cH}</div>${mH}</div><div class="post-actions"><div class="flex items-center gap-1"><button id="like-btn-${p.id}" class="action-btn like" onclick="event.stopPropagation();toggleLike('${p.id}')"><i data-lucide="heart" class="w-5 h-5 ${lk?'fill-red-500 text-red-500':''}"></i></button><span id="like-count-${p.id}" class="text-xs font-medium px-1">${p.likes?p.likes.length:0}</span><button class="action-btn comment ml-2" onclick="event.stopPropagation();openPostView('${p.id}')"><i data-lucide="message-circle" class="w-5 h-5"></i> <span id="comment-count-${p.id}">${p.comments?p.comments.length:0}</span></button></div><div class="flex items-center gap-1"><button id="save-btn-${p.id}" class="action-btn bookmark" onclick="event.stopPropagation();toggleSave('${p.id}')"><i data-lucide="bookmark" class="w-5 h-5 ${sv?'fill-yellow-500 text-yellow-500':''}"></i></button><button class="action-btn share-btn" onclick="event.stopPropagation();sharePost('${p.id}')"><i data-lucide="share-2" class="w-5 h-5"></i></button></div></div></div>`;return d}
window.moveCarousel=(pid,dir,iso=false)=>{let k=iso?`overlay-${pid}`:pid;if(!window.carouselStates?.[k])return;let st=window.carouselStates[k],ni=st.index+dir;if(ni>=0&&ni<st.total){st.index=ni;let inn=$(iso?`overlay-inner-${pid}`:`inner-${pid}`),wrap=$(iso?`overlay-carousel-${pid}`:`carousel-${pid}`);if(inn)inn.style.transform=`translateX(-${st.index*100}%)`;wrap.querySelectorAll('.carousel-dot').forEach((d,i)=>d.classList.toggle('active',i===st.index))}};
window.switchExploreMainTab=t=>{window.activeExploreTab=t;['main','video','people'].forEach(x=>{let b=$(`tab-explore-${x}`),bd=$(`tab-explore-${x}-d`);if(b)b.classList.remove('active');if(bd)bd.classList.remove('active')});let tm=$(`tab-explore-${t==='explore'?'main':t}`),td=$(`tab-explore-${t==='explore'?'main':t}-d`);if(tm)tm.classList.add('active');if(td)td.classList.add('active');window.activeExploreCategory=t==='video'?'All':'For You';handleSearch($('mobile-explore-search').value)};
window.toggleExploreSearch=()=>toggle('explore-search-bar');
window.handleSearch=q=>{if($('view-explore').classList.contains('hidden'))switchView('explore');let t=q?q.toLowerCase().trim():'',pl=$('explore-people-results'),vr=$('explore-results');$('global-search').value=t;$('mobile-explore-search').value=t;if(window.activeExploreTab==='people'){show('explore-people-results');hide('explore-results');pl.classList.add('flex');let fu=t.length>0?users.filter(u=>(u.name||"").toLowerCase().includes(t)||(u.username||"").toLowerCase().includes(t)):users.slice(0,10);pl.innerHTML='';if(fu.length)fu.forEach(u=>{let d=document.createElement('div');d.className="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer";d.onclick=()=>showProfile(u.id);d.innerHTML=`<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-12 h-12 rounded-full border border-gray-100 object-cover bg-gray-50"><div><div class="font-bold text-[#1f1f1f] text-[15px] flex items-center gap-1">${u.name} ${u.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 text-blue-500"></i>':''}</div><div class="text-xs text-gray-500 font-medium">@${u.username||'user'}  ${u.followers?.length||0} followers</div></div></div><button onclick="event.stopPropagation();toggleFollow('${u.id}')" class="bg-black text-white text-xs px-4 py-1.5 rounded-full font-bold hover:bg-gray-800 transition-colors">Follow</button>`;pl.appendChild(d)});else pl.innerHTML=`<div class="text-gray-400 text-xs italic text-center py-4">No people found</div>`;return}else{hide('explore-people-results');show('explore-results');pl.classList.remove('flex')}let fp=[...posts];if(window.activeExploreTab==='video')fp=fp.filter(p=>p.media&&(Array.isArray(p.media)?p.media.some(m=>m.includes('video')):p.media.includes('video')));if(t){let kw=t.split(" ").filter(k=>k.length);fp=fp.filter(p=>kw.some(k=>(p.content||'').toLowerCase().includes(k)))}else fp=fp.sort(()=>0.5-Math.random());vr.innerHTML='';if(fp.length===0)vr.innerHTML=`<div class="text-center py-20 text-gray-400">No posts.</div>`;else{let lc=document.createElement('div');lc.className="flex flex-col gap-0.5 md:gap-4";fp.forEach(p=>lc.appendChild(createPostElement(p)));vr.appendChild(lc)}refreshIcons()};
window.openCollabSelector=()=>{let o=$('user-list-overlay'),c=$('user-list-content');$('user-list-title').innerText="Tag Collaborators";c.innerHTML='';let ru=users.filter(u=>u.id!==currentUser.id&&(currentUser.following.includes(u.id)||currentUser.followers.includes(u.id)));if(ru.length===0)c.innerHTML=`<div class="text-center text-gray-400 py-8">No contacts found.</div>`;else ru.forEach(u=>{let is=window.selectedCollaborators.find(s=>s.id===u.id),d=document.createElement('div');d.className=`flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer ${is?'bg-gray-100':''}`;d.onclick=()=>toggleCollaborator(u);d.innerHTML=`<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username||'user'}</div></div></div>${is?'<i data-lucide="check" class="text-gray-600 w-5 h-5"></i>':''}`;c.appendChild(d)});show('user-list-overlay');refreshIcons()};window.toggleCollaborator=u=>{let i=window.selectedCollaborators.findIndex(x=>x.id===u.id);if(i>-1)window.selectedCollaborators.splice(i,1);else window.selectedCollaborators.push({id:u.id,name:u.name,avatar:u.avatar,username:u.username,status:'pending'});closeUserList();openCollabSelector();renderCollabChips()};window.renderCollabChips=()=>{let c=$('collab-chips-container');c.innerHTML='';window.selectedCollaborators.forEach(u=>{let d=document.createElement('div');d.className='collab-chip';d.innerHTML=`<img src="${u.avatar}" class="w-4 h-4 rounded-full mr-2"> <span>${u.name}</span> <i onclick="event.stopPropagation();removeCollaborator('${u.id}')" data-lucide="x" class="w-3 h-3 ml-2 text-gray-500 hover:text-red-500 cursor-pointer"></i>`;c.appendChild(d)});refreshIcons()};window.removeCollaborator=id=>{window.selectedCollaborators=window.selectedCollaborators.filter(u=>u.id!==id);renderCollabChips()};
window.openCollabList=pid=>{let p=posts.find(x=>x.id===pid);if(!p||!p.collaborators)return;let c=$('user-list-content');$('user-list-title').innerText="Collaborators";c.innerHTML='';p.collaborators.filter(x=>x.status==='accepted').forEach(x=>{let d=document.createElement('div');d.className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer";d.onclick=()=>{closeUserList();showProfile(x.id)};d.innerHTML=`<div class="flex items-center gap-3"><img src="${x.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${x.name}</div><div class="text-xs text-gray-500">@${x.username||'user'}</div></div></div>`;c.appendChild(d)});show('user-list-overlay')};
window.toggleLike=async pid=>{let b=$(`like-btn-${pid}`),cs=$(`like-count-${pid}`);if(b){let i=b.querySelector('svg')||b.querySelector('i');if(i.classList.contains('text-red-500')){i.classList.remove('fill-red-500','text-red-500');if(cs)cs.innerText=Math.max(0,(parseInt(cs.innerText)||0)-1)}else{i.classList.add('fill-red-500','text-red-500');if(cs)cs.innerText=(parseInt(cs.innerText)||0)+1}}let ob=$('post-view-like-btn'),ocs=$('post-view-likes-count');if(ob&&window.currentViewingPostId===pid){ob.classList.remove('fill-red-500','text-red-500','text-gray-700');if(ob.classList.contains('text-red-500')){ob.classList.add('text-gray-700');ocs.innerText=`${Math.max(0,(parseInt(ocs.innerText)||0)-1)} likes`}else{ob.classList.add('fill-red-500','text-red-500');ocs.innerText=`${(parseInt(ocs.innerText)||0)+1} likes`}}let p=posts.find(x=>x.id===pid);if(p.likes?.includes(currentUser.id))await updateDoc(doc(db,"posts",pid),{likes:arrayRemove(currentUser.id)});else{await updateDoc(doc(db,"posts",pid),{likes:arrayUnion(currentUser.id)});if(p.authorId!==currentUser.id)sendNotification(p.authorId,'like','liked your post',pid)}};
window.openLikes=pid=>{let p=posts.find(x=>x.id===pid);if(!p)return;let c=$('likes-list-content');c.innerHTML='';if(!p.likes||!p.likes.length)c.innerHTML=`<div class="text-center text-gray-400 py-8">No likes yet.</div>`;else p.likes.forEach(id=>{let u=users.find(x=>x.id===id);if(u){let d=document.createElement('div');d.className="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl cursor-pointer";d.onclick=()=>{hide('likes-overlay');showProfile(u.id)};d.innerHTML=`<img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div></div>`;c.appendChild(d)}});show('likes-overlay')};window.closeLikes=()=>hide('likes-overlay');
window.toggleSave=async pid=>{let b=$(`save-btn-${pid}`);if(b){let i=b.querySelector('svg');i.classList.toggle('fill-yellow-500');i.classList.toggle('text-yellow-500');showToast(i.classList.contains('text-yellow-500')?"Post saved":"Post removed")}let ur=doc(db,"users",currentUser.id);if(savedPosts.includes(pid)){await updateDoc(ur,{saved:arrayRemove(pid)});savedPosts=savedPosts.filter(x=>x!==pid)}else{await updateDoc(ur,{saved:arrayUnion(pid)});savedPosts.push(pid)}};
window.sharePost=pid=>{navigator.clipboard.writeText(`${window.location.origin}${window.location.pathname}?postId=${pid}`).then(()=>showToast("Link copied!"))};
window.renderSaved=()=>{let c=$('saved-container');c.innerHTML="";if(!savedPosts.length)c.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60"><i data-lucide="bookmark" class="w-16 h-16 mb-2"></i><p>No saved posts</p></div>`;else posts.filter(p=>savedPosts.includes(p.id)).forEach(p=>c.appendChild(createPostElement(p)));refreshIcons()};
async function sendNotification(rid,type,txt,pid=null){await addDoc(collection(db,"notifications"),{receiverId:rid,senderId:currentUser.id,type,content:txt,timestamp:serverTimestamp(),read:false,postId:pid})}
window.switchNotifTab=t=>{activeNotifTab=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));$(`ntab-${t}`)?.classList.add('active');$(`ntab-${t}-mobile`)?.classList.add('active');renderNotifications()};
window.toggleNotifMenu=()=>{$('notif-menu-dropdown').classList.toggle('hidden');$('notif-menu-dropdown').classList.toggle('flex')};window.toggleNotifSelection=()=>{window.notifSelectionMode=!window.notifSelectionMode;if(!window.notifSelectionMode)window.selectedNotifs.clear();toggleNotifMenu();renderNotifications()};window.toggleNotifSearchMobile=()=>toggle('mobile-notif-search-container');window.handleNotifSearch=v=>{window.notifSearchTerm=v.toLowerCase();renderNotifications()};
window.deleteSelectedNotifs=async()=>{if(!window.selectedNotifs.size)return showToast("None selected");showAlert(`Delete ${window.selectedNotifs.size}?`,async()=>{let b=writeBatch(db);window.selectedNotifs.forEach(id=>b.delete(doc(db,"notifications",id)));await b.commit();window.notifSelectionMode=false;window.selectedNotifs.clear();toggleNotifMenu();showToast("Deleted")})};
window.toggleNotifSelect=id=>{if(window.selectedNotifs.has(id))window.selectedNotifs.delete(id);else window.selectedNotifs.add(id);renderNotifications()};
window.renderNotifications=()=>{let c=$('notification-list');c.innerHTML="";let f=notifications.filter(n=>{let s=users.find(u=>u.id===n.senderId)||{name:'Admin',isOfficial:false},iso=n.type==='official'||s.isOfficial;let tm=false;if(activeNotifTab==='official')tm=iso;else if(activeNotifTab==='friends')tm=!iso&&(currentUser.following.includes(n.senderId)||n.type.includes('request'));else tm=!iso&&!currentUser.following.includes(n.senderId)&&!n.type.includes('request');if(window.notifSearchTerm)return tm&&(n.content.toLowerCase().includes(window.notifSearchTerm)||s.name.toLowerCase().includes(window.notifSearchTerm));return tm});if(!f.length)c.innerHTML=`<div class="text-center text-xs text-gray-400 py-4">No notifications</div>`;else f.forEach(n=>{let s=users.find(u=>u.id===n.senderId)||{name:'Admin',avatar:''},d=document.createElement('div');d.className=`w-full flex items-start gap-3 p-4 border-b border-gray-100 bg-white hover:bg-gray-50 transition-colors ${n.read?'':'bg-blue-50/20'}`;let ic="",bg="";if(n.type==='like'){ic='<i data-lucide="heart" class="w-3.5 h-3.5 text-white"></i>';bg="bg-red-500"}else if(n.type==='comment'){ic='<i data-lucide="message-circle" class="w-3.5 h-3.5 text-white"></i>';bg="bg-blue-500"}else if(n.type==='follow'){ic='<i data-lucide="user-plus" class="w-3.5 h-3.5 text-white"></i>';bg="bg-indigo-500"}else{ic='<i data-lucide="bell" class="w-3.5 h-3.5 text-white"></i>';bg="bg-gray-500"}let ca=(n.type==='like'||n.type==='comment')&&n.postId?`onclick="if(!window.notifSelectionMode) openPostView('${n.postId}')"`:`onclick="if(!window.notifSelectionMode) showProfile('${s.id}')"`;let ab="";if(n.type==='follow_request')ab=`<div class="flex gap-2 mt-2"><button onclick="acceptFollow('${n.id}','${s.id}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-md">Accept</button><button onclick="deleteNotification('${n.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-md">Delete</button></div>`;if(n.type==='collab_request')ab=`<div class="flex gap-2 mt-2"><button onclick="acceptCollab('${n.id}','${n.postId}')" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-md">Accept</button><button onclick="declineCollab('${n.id}','${n.postId}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1 rounded-md">Decline</button></div>`;d.innerHTML=`${window.notifSelectionMode?`<div class="pt-1"><input type="checkbox" ${window.selectedNotifs.has(n.id)?'checked':''} onchange="toggleNotifSelect('${n.id}')" class="w-4 h-4 accent-blue-600 cursor-pointer rounded"></div>`:''}<div class="relative cursor-pointer shrink-0" onclick="if(!window.notifSelectionMode) showProfile('${s.id}')"><img src="${s.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100"><div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${bg} flex items-center justify-center border border-white shadow-sm">${ic}</div></div><div class="flex-1 min-w-0 pt-0.5"><div class="text-[14px] leading-snug cursor-pointer" ${ca}><span class="font-bold text-gray-900 hover:underline">${s.name}</span><span class="text-gray-600 ml-1">${n.content}</span></div><div class="text-[11px] text-gray-400 mt-1">${formatDate(n.timestamp)}</div>${ab}</div>${!window.notifSelectionMode?`<button onclick="deleteNotification('${n.id}')" class="p-1.5 text-gray-300 hover:text-red-500 rounded-full"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>`:''}`;c.appendChild(d)});refreshIcons()};
window.deleteNotification=async id=>{showAlert("Delete?",async()=>await deleteDoc(doc(db,"notifications",id)))};
window.acceptCollab=async(nid,pid)=>{let r=doc(db,"posts",pid),s=await getDoc(r);if(s.exists()){let c=s.data().collaborators||[],i=c.findIndex(x=>x.id===currentUser.id);if(i>-1){c[i].status='accepted';await updateDoc(r,{collaborators:c});showToast("Accepted!")}}await deleteDoc(doc(db,"notifications",nid))};
window.declineCollab=async(nid,pid)=>{let r=doc(db,"posts",pid),s=await getDoc(r);if(s.exists()){let c=s.data().collaborators||[];c=c.filter(x=>x.id!==currentUser.id);await updateDoc(r,{collaborators:c});showToast("Declined")}await deleteDoc(doc(db,"notifications",nid))};
window.acceptFollow=async(nid,sid)=>{await updateDoc(doc(db,"users",currentUser.id),{followers:arrayUnion(sid)});await updateDoc(doc(db,"users",sid),{following:arrayUnion(currentUser.id)});await deleteDoc(doc(db,"notifications",nid));sendNotification(sid,'follow','accepted follow request');showToast("Accepted")};
window.clearAllNotifications=async()=>{showAlert("Clear all?",async()=>{let b=writeBatch(db),q=query(collection(db,"notifications"),where("receiverId","==",currentUser.id)),s=await getDocs(q);s.forEach(d=>b.delete(d.ref));await b.commit();showToast("Cleared")})};
window.toggleNotifications=()=>switchView('notifications');
window.showProfile=(uid,tab='posts')=>{if(!uid)uid=currentUser.id;closePostView();closeThread();let u=users.find(x=>x.id===uid);if(!u)return;window.currentViewingProfileId=uid;window.currentProfileTab=tab;let c=$('view-profile'),me=uid===currentUser.id,fol=currentUser.following?.includes(uid),btn=me?`<button onclick="openEditProfile()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm">Edit Profile</button>`:`<button id="profile-follow-btn" onclick="toggleFollow('${uid}')" class="${fol?'bg-gray-100 text-gray-700':'bg-[#0b57d0] text-white'} px-4 py-2 rounded-lg font-bold text-sm">${fol?'Following':'Follow'}</button>`,stats=(me||!u.settings?.privateNetwork||fol)?`<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="cursor-pointer" onclick="openUserList('following','${uid}')"><strong class="text-gray-900">${u.following?.length||0}</strong> Following</span><span class="cursor-pointer" onclick="openUserList('followers','${uid}')"><strong class="text-gray-900">${u.followers?.length||0}</strong> Followers</span></div>`:`<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="italic"><i data-lucide="lock" class="w-3 h-3 inline"></i> Private</span></div>`;c.innerHTML=`<div class="profile-banner-container"><img src="${u.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'}" class="profile-banner-img" style="object-position: center ${u.bannerPos||50}%"></div><div class="px-4 md:px-6 relative"><div class="flex justify-between items-end -mt-10 mb-4"><img src="${u.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover">${btn}</div><div class="mb-6"><h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">${u.name} ${u.isOfficial?'<i data-lucide="badge-check" class="text-blue-600 w-6 h-6"></i>':''}</h1><div class="text-sm font-medium text-gray-500">@${u.username||'user'}</div><p class="text-gray-600 mt-2">${u.bio}</p>${stats}</div><div class="tab-group mb-0"><button onclick="switchProfileTab('posts')" class="tab-btn ${tab==='posts'?'active':''}"><i data-lucide="grid" class="w-5 h-5"></i></button>${me?`<button onclick="switchProfileTab('saved')" class="tab-btn ${tab==='saved'?'active':''}"><i data-lucide="bookmark" class="w-5 h-5"></i></button>`:''}<button onclick="switchProfileTab('liked')" class="tab-btn ${tab==='liked'?'active':''}"><i data-lucide="heart" class="w-5 h-5"></i></button><button onclick="switchProfileTab('tagged')" class="tab-btn ${tab==='tagged'?'active':''}"><i data-lucide="user-check" class="w-5 h-5"></i></button><button onclick="switchProfileTab('links')" class="tab-btn ${tab==='links'?'active':''}"><i data-lucide="link" class="w-5 h-5"></i></button></div><div id="profile-content-area" class="pt-1 md:pt-4 pb-20 md:pb-0"></div></div>`;switchView('profile');renderProfileContent(uid,tab);refreshIcons()};
window.switchProfileTab=t=>{document.querySelectorAll('#view-profile .tab-btn').forEach(b=>b.classList.remove('active'));Array.from(document.querySelectorAll('#view-profile .tab-btn')).find(b=>b.getAttribute('onclick').includes(t))?.classList.add('active');window.currentProfileTab=t;renderProfileContent(window.currentViewingProfileId,t)};
window.renderProfileContent=(uid,tab)=>{let ca=$('profile-content-area');ca.innerHTML="";let u=users.find(x=>x.id===uid);if(tab==='links'){let ln=u.links||[],me=uid===currentUser.id,h='<div class="max-w-4xl mx-auto py-6 space-y-4 md:grid md:grid-cols-2 md:gap-4 md:space-y-0 px-2">';if(me)h+=`<button onclick="show('add-link-modal')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold flex items-center justify-center gap-2 h-full"><i data-lucide="plus" class="w-5 h-5"></i> Add Link</button>`;if(!ln.length&&!me)h+=`<div class="col-span-2 text-center text-gray-400 py-10">No links.</div>`;else ln.forEach((l,i)=>{h+=`<a href="${l.url}" target="_blank" class="flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors border border-gray-200 group relative"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-gray-200 mr-4 shrink-0"><i data-lucide="link" class="w-5 h-5 text-blue-600"></i></div><div class="flex-1 min-w-0"><div class="font-bold text-gray-900 truncate">${l.title}</div><div class="text-xs text-gray-500 truncate">${l.url}</div></div><i data-lucide="external-link" class="w-4 h-4 text-gray-400 ml-2"></i>${me?`<button onclick="event.preventDefault();deleteLink(${i})" class="absolute top-2 right-2 text-red-500 opacity-0 group-hover:opacity-100"><i data-lucide="trash-2" class="w-3 h-3"></i></button>`:''}</a>`});ca.innerHTML=h+'</div>';refreshIcons();return}if(tab==='liked'&&uid!==currentUser.id){ca.innerHTML=`<div class="flex flex-col items-center justify-center py-20 text-gray-400 opacity-60"><i data-lucide="lock" class="w-16 h-16 mb-2"></i><p>Private likes.</p></div>`;refreshIcons();return}let tp=[];if(tab==='posts')tp=posts.filter(p=>p.authorId===uid);else if(tab==='saved')tp=posts.filter(p=>savedPosts.includes(p.id));else if(tab==='liked')tp=posts.filter(p=>p.likes?.includes(uid));else if(tab==='tagged')tp=posts.filter(p=>p.collaborators?.some(c=>c.id===uid&&c.status==='accepted'));if(uid!==currentUser.id&&tab==='posts'){let fol=currentUser.following.includes(uid),priv=u.settings?.privateNetwork;tp=tp.filter(p=>(priv?!fol:(!p.settings||p.settings.privacy==='public'||fol)))}if(!tp.length)ca.innerHTML=`<div class="text-center py-20 text-gray-400">No posts</div>`;else{let g=`<div class="grid-post-container">`;tp.forEach(p=>{let c='',m=Array.isArray(p.media)?p.media[0]:p.media;if(m){if(m.includes('video')||m.endsWith('.mp4'))c=`<video src="${m}" class="w-full h-full object-cover pointer-events-none"></video><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-8 h-8 text-white drop-shadow-md"></i></div>`;else c=`<img src="${m}" class="w-full h-full object-cover">`}else c=`<div class="grid-post-text-preview">${p.content.substring(0,60)}...</div>`;g+=`<div class="grid-post-item group" onclick="openPostView('${p.id}')">${c}<div class="grid-post-overlay"><div class="flex items-center gap-1"><i data-lucide="heart" class="w-5 h-5 fill-white"></i> ${p.likes?.length||0}</div></div></div>`});ca.innerHTML=g+`</div>`}refreshIcons()};
window.saveLink=async()=>{let t=$('new-link-title').value.trim(),u=$('new-link-url').value.trim();if(!t||!u)return showToast("Fill all fields",true);let l={title:t,url:u,type:'web'};await updateDoc(doc(db,"users",currentUser.id),{links:arrayUnion(l)});currentUser.links=(currentUser.links||[]).concat(l);hide('add-link-modal');$('new-link-title').value="";$('new-link-url').value="";renderProfileContent(currentUser.id,'links');showToast("Link added")};
window.deleteLink=async i=>{showAlert("Remove link?",async()=>{let l=currentUser.links[i];await updateDoc(doc(db,"users",currentUser.id),{links:arrayRemove(l)});currentUser.links.splice(i,1);renderProfileContent(currentUser.id,'links');showToast("Removed")})};
window.openEditProfile=()=>{let b=currentUser.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';curBP=currentUser.bannerPos||50;initBP=curBP;$('edit-banner-preview').src=b;$('edit-banner-preview').style.objectPosition=`center ${curBP}%`;$('banner-pos-hint').innerText=`${curBP}%`;$('edit-email').value=currentUser.email||"";$('edit-profile-overlay').classList.remove('pointer-events-none','opacity-0')};window.closeEditProfile=()=>$('edit-profile-overlay').classList.add('pointer-events-none','opacity-0');
window.handleEditAvatarSelect=e=>{if(e.target.files[0]){currentAvatarBlob=e.target.files[0];let r=new FileReader();r.onload=ev=>$('edit-avatar-preview').src=ev.target.result;r.readAsDataURL(currentAvatarBlob)}};window.handleEditBannerSelect=e=>{if(e.target.files[0]){currentBannerBlob=e.target.files[0];let r=new FileReader();r.onload=ev=>$('edit-banner-preview').src=ev.target.result;r.readAsDataURL(currentBannerBlob)}};
window.saveProfileChanges=async()=>{let b=$('save-profile-btn'),ot=b.innerText;b.innerText="Saving...";b.disabled=true;let n=$('edit-name').value,bio=$('edit-bio').value;if(!n)return showToast("Name required");let a=currentUser.avatar,bn=currentUser.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';try{if(currentAvatarBlob)a=await uploadToImgHippo(currentAvatarBlob);if(currentBannerBlob)bn=await uploadToImgHippo(currentBannerBlob)}catch(e){return showToast("Upload failed")}await updateDoc(doc(db,"users",currentUser.id),{name:n,bio,avatar:a,banner:bn,bannerPos:curBP});currentUser.name=n;currentUser.bio=bio;currentUser.avatar=a;currentUser.banner=bn;currentUser.bannerPos=curBP;currentAvatarBlob=null;currentBannerBlob=null;updateUI();closeEditProfile();showProfile(currentUser.id,window.currentProfileTab);showToast("Updated");b.innerText=ot;b.disabled=false};
window.doLogout=async()=>{await signOut(auth);location.href="index.html"};
window.toggleFollow=async uid=>{let m=doc(db,"users",currentUser.id),t=doc(db,"users",uid),u=users.find(x=>x.id===uid),p=u?.settings?.privateNetwork;if(currentUser.following.includes(uid)){currentUser.following=currentUser.following.filter(x=>x!==uid);showToast("Unfollowed");await updateDoc(m,{following:arrayRemove(uid)});await updateDoc(t,{followers:arrayRemove(currentUser.id)})}else{if(p){showToast("Requested");sendNotification(uid,'follow_request','wants to follow you')}else{currentUser.following.push(uid);showToast("Following");await updateDoc(m,{following:arrayUnion(uid)});await updateDoc(t,{followers:arrayUnion(currentUser.id)});sendNotification(uid,'follow','started following you')}}renderRightSidebar();if(!$('view-network').classList.contains('hidden'))renderNetwork();showProfile(uid,window.currentProfileTab)};
window.openPostView=pid=>{let p=posts.find(x=>x.id===pid);if(!p)return;window.currentViewingPostId=pid;let o=$('post-view-overlay');o.classList.remove('mobile-reel-view');document.body.classList.remove('reel-mode');let a=users.find(x=>x.id===p.authorId)||{name:'Unknown',avatar:'',id:p.authorId},dt=formatDate(p.timestamp),ch=formatContent(p.content);$('post-view-avatar').src=a.avatar;$('post-view-username').innerText=a.name;$('post-view-date').innerText=dt;$('post-view-likes-count').innerText=p.settings?.showLikes!==false?`${p.likes?.length||0} likes`:'';$('mobile-post-pfp').src=a.avatar;$('mobile-post-username').innerText=a.name;$('mobile-post-caption').innerHTML=ch;$('mobile-like-count').innerText=p.likes?.length||0;$('reel-user-avatar').src=a.avatar;$('reel-username').innerText=a.name;$('reel-caption').innerHTML=p.content.length>80?`<span>${p.content.substring(0,80)}... </span><span class="font-bold text-gray-300 cursor-pointer" onclick="event.stopPropagation();toggleReelCaption('${pid}')">more</span>`:p.content;if(p.content.length>80)$('reel-caption').dataset.full=p.content;updatePostViewStats(pid);let mc=$('post-view-media-container'),po=$('video-play-overlay');mc.innerHTML='';mc.appendChild(po);if(p.media){let ma=Array.isArray(p.media)?p.media:[p.media];if(ma.length===1){let s=ma[0],iv=s.includes('video')||s.endsWith('.mp4');if(iv){let v=document.createElement('video');v.src=s;v.className="stage-content rounded-lg shadow-2xl";v.controls=false;v.playsInline=true;v.muted=false;v.loop=true;v.onclick=e=>{e.stopPropagation();if(v.paused){v.play();po.classList.remove('show')}else{v.pause();po.classList.add('show')}};po.onclick=v.onclick;po.classList.add('show');if(window.innerWidth<768){v.onloadedmetadata=()=>{o.classList.add('mobile-reel-view');document.body.classList.add('reel-mode');v.className="w-full h-full object-cover";v.muted=false}}mc.insertBefore(v,po)}else mc.innerHTML=`<img src="${s}" class="stage-content rounded-lg shadow-2xl">`}else{let sl='',do_='';ma.forEach((s,i)=>{sl+=`<div class="post-carousel-item">${(s.includes('video')||s.endsWith('.mp4'))?`<video src="${s}" controls></video>`:`<img src="${s}">`}</div>`;do_+=`<div class="carousel-dot ${i===0?'active':''}" id="overlay-dot-${p.id}-${i}"></div>`});mc.innerHTML=`<div class="rounded-lg overflow-hidden post-carousel shadow-2xl" id="overlay-carousel-${p.id}"><div class="post-carousel-inner" id="overlay-inner-${p.id}">${sl}</div><button class="carousel-nav-btn prev" onclick="event.stopPropagation();moveCarousel('${p.id}',-1,true)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next" onclick="event.stopPropagation();moveCarousel('${p.id}',1,true)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><div class="carousel-dots">${do_}</div></div>`;if(!window.carouselStates)window.carouselStates={};window.carouselStates[`overlay-${p.id}`]={index:0,total:ma.length}}}else mc.innerHTML=`<div class="flex flex-col items-center justify-center h-full text-white opacity-40"><i data-lucide="image-off" class="w-16 h-16 mb-2"></i><span>No Media</span></div>`;$('post-view-caption-area').innerHTML=`<div class="flex gap-3"><img src="${a.avatar}" class="w-8 h-8 rounded-full border border-gray-100 object-cover shrink-0 cursor-pointer" onclick="showProfile('${a.id}')"><div><div class="flex items-center gap-1.5 mb-0.5"><span class="font-bold text-sm cursor-pointer" onclick="showProfile('${a.id}')">${a.name}</span>${a.isOfficial?'<i data-lucide="badge-check" class="w-3 h-3 text-blue-500 fill-blue-50"></i>':''}</div><div class="text-sm text-gray-800 leading-snug">${ch}</div></div></div>`;renderCommentsInModal(pid);let lb=$('post-view-like-btn'),il=p.likes?.includes(currentUser.id);lb.className=il?'w-6 h-6 fill-red-500 text-red-500 cursor-pointer hover:scale-110 transition-transform':'w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform';lb.onclick=()=>toggleLike(pid);let sb=$('post-view-save-btn'),is=savedPosts.includes(pid);sb.className=is?'w-6 h-6 fill-yellow-500 text-yellow-500 cursor-pointer hover:scale-110 transition-transform':'w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform';sb.onclick=()=>toggleSave(pid);show('post-view-overlay');refreshIcons()};
window.toggleReelCaption=pid=>{let e=$('reel-caption');if(!e?.dataset.full)return;if(e.getAttribute('data-expanded')==='true'){e.innerHTML=`<span>${e.dataset.full.substring(0,80)}... </span><span class="font-bold text-gray-300 cursor-pointer" onclick="event.stopPropagation();toggleReelCaption('${pid}')">more</span>`;e.setAttribute('data-expanded','false');e.style.maxHeight=''}else{e.innerHTML=`<span>${e.dataset.full}</span> <span class="font-bold text-gray-300 cursor-pointer block mt-1" onclick="event.stopPropagation();toggleReelCaption('${pid}')">less</span>`;e.setAttribute('data-expanded','true');e.style.overflowY='auto';e.style.maxHeight='200px'}};
window.toggleMobileCommentDrawer=()=>document.querySelector('.discussion-panel').classList.toggle('open');window.closePostView=()=>{hide('post-view-overlay');document.body.classList.remove('reel-mode');document.querySelector('.discussion-panel').classList.remove('open');window.currentViewingPostId=null;window.replyingToCommentId=null;let v=document.querySelector('#post-view-media-container video');if(v)v.pause()};
function renderCommentsInModal(pid){let p=posts.find(x=>x.id===pid);if(!p)return;let c=$('post-view-comments'),h='';$(`post-view-likes-count`).innerText=p.settings?.showLikes!==false?`${p.likes?.length||0} likes`:'';if(p.comments){p.comments.filter(x=>!x.parentId).forEach(k=>h+=createCommentHTML(k,p.comments,pid,true))}c.innerHTML=h;refreshIcons()}
function createCommentHTML(c,all,pid,link=true){let a=users.find(u=>u.id===c.authorId)||{name:'U',avatar:''},il=c.likes?.includes(currentUser.id),me=c.authorId===currentUser.id,reps=all.filter(r=>r.parentId===c.id),html=`<div class="comment-row ${me?'me':''}"><img src="${a.avatar}" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-100 shrink-0 object-cover cursor-pointer hover:opacity-80" onclick="showProfile('${c.authorId}')"><div class="comment-content-box"><div class="comment-meta"><span class="font-bold text-gray-900 cursor-pointer" onclick="showProfile('${c.authorId}')">${a.name}</span><span class="text-[10px] opacity-60"> Now</span></div><div class="comment-bubble group relative">${formatContent(c.content)}<button onclick="toggleCommentLike('${pid}','${c.id}')" class="absolute -right-2 -bottom-2 bg-white rounded-full p-1 shadow-sm opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center"><i data-lucide="heart" class="w-3 h-3 ${il?'fill-red-500 text-red-500':'text-gray-400'}"></i></button></div><div class="comment-actions-row">${c.likes?.length?`<span class="text-[10px] font-bold text-gray-500">${c.likes.length} like${c.likes.length!==1?'s':''}</span>`:''}<span class="comment-action-link" onclick="replyToComment('${c.id}','${a.name}')">Reply</span>${(me||currentUser.email==='edulinkbht@gmail.com')?`<span onclick="deleteComment('${pid}','${c.id}')" class="comment-action-link text-red-500">Delete</span>`:''}</div>${link&&reps.length>0?`<div class="mt-2 pl-2"><button onclick="openThread('${pid}','${c.id}')" class="text-xs font-semibold text-blue-600 hover:underline flex items-center gap-1">View ${reps.length} replies</button></div>`:''}</div></div>`;return html}
window.openThread=(pid,cid)=>{window.threadPostId=pid;window.threadParentCommentId=cid;renderThreadContent(pid,cid);show('thread-overlay');$('thread-input').focus()};window.closeThread=()=>{hide('thread-overlay');window.threadPostId=null;window.threadParentCommentId=null;window.replyingToCommentId=null};
window.renderThreadContent=(pid,cid)=>{let p=posts.find(x=>x.id===pid);if(!p)return;let pc=p.comments.find(x=>x.id===cid);if(!pc)return;let rs=p.comments.filter(r=>r.parentId===cid),c=$('thread-content'),h=`<div class="relative pb-4"><div class="z-10 relative bg-white border-b border-gray-100 p-4">${createCommentHTML(pc,p.comments,pid,false)}</div><div class="absolute left-[34px] top-12 bottom-0 w-0.5 bg-gray-200 z-0"></div><div class="pl-8 pt-4 px-4 space-y-6 relative z-10">`;if(rs.length)rs.forEach(r=>h+=createCommentHTML(r,p.comments,pid,false));else h+=`<div class="text-center text-gray-400 text-sm py-4">No replies yet.</div>`;h+=`</div></div>`;c.innerHTML=h;refreshIcons()};
window.submitThreadReply=async()=>{let t=$('thread-input').value.trim();if(!t||!window.threadPostId)return;let r=doc(db,"posts",window.threadPostId),nc={id:"c-"+Date.now(),authorId:currentUser.id,content:t,timestamp:Date.now(),likes:[],parentId:window.threadParentCommentId};await updateDoc(r,{comments:arrayUnion(nc)});let p=posts.find(x=>x.id===window.threadPostId),pc=p.comments.find(x=>x.id===window.threadParentCommentId);if(pc&&pc.authorId!==currentUser.id)sendNotification(pc.authorId,'reply','replied to comment',window.threadPostId);$('thread-input').value=""};
window.deleteComment=async(pid,cid)=>{showAlert("Delete comment?",async()=>{let r=doc(db,"posts",pid),p=posts.find(x=>x.id===pid),nc=p.comments.filter(x=>x.id!==cid&&x.parentId!==cid);await updateDoc(r,{comments:nc});showToast("Deleted")})};
window.toggleCommentLike=async(pid,cid)=>{let p=posts.find(x=>x.id===pid);if(!p)return;let c=p.comments||[],i=c.findIndex(x=>x.id===cid);if(i===-1)return;let co=c[i];if(!co.likes)co.likes=[];if(co.likes.includes(currentUser.id))co.likes=co.likes.filter(x=>x!==currentUser.id);else{co.likes.push(currentUser.id);if(co.authorId!==currentUser.id)sendNotification(co.authorId,'like','liked comment',pid)}c[i]=co;await updateDoc(doc(db,"posts",pid),{comments:c})};
window.replyToComment=(cid,u)=>{if(!$('thread-overlay').classList.contains('hidden')){$('thread-input').value=`@${u} `;$('thread-input').focus()}else{$('comment-input-desktop').value=`@${u} `;$('comment-input-desktop').focus();window.replyingToCommentId=cid}};
window.submitCommentDesktop=async()=>{let t=$('comment-input-desktop').value.trim();if(!t||!window.currentViewingPostId)return;let r=doc(db,"posts",window.currentViewingPostId),nc={id:"c-"+Date.now(),authorId:currentUser.id,content:t,timestamp:Date.now(),likes:[],parentId:window.replyingToCommentId};await updateDoc(r,{comments:arrayUnion(nc)});let p=posts.find(x=>x.id===window.currentViewingPostId);if(window.replyingToCommentId){let pc=p.comments.find(x=>x.id===window.replyingToCommentId);if(pc&&pc.authorId!==currentUser.id)sendNotification(pc.authorId,'reply','replied to comment',window.currentViewingPostId)}else if(p.authorId!==currentUser.id)sendNotification(p.authorId,'comment','commented on post',window.currentViewingPostId);$('comment-input-desktop').value="";window.replyingToCommentId=null};
window.promptForImageLink=()=>{let u=prompt("Enter Image URL:");if(u){window.currentMedia=[u];window.currentMediaType='image';show('media-preview-container');$('preview-inner').innerHTML=`<img src="${u}" class="h-20 w-20 object-cover rounded-md">`;showToast("Added")}};
window.sendAnnouncement=async()=>{let t=$('announcement-text').value.trim();if(!t)return;showAlert("Broadcast?",async()=>{let c=0;for(const u of users){if(u.id!==currentUser.id){await addDoc(collection(db,"notifications"),{receiverId:u.id,senderId:currentUser.id,type:'official',content:t,timestamp:serverTimestamp(),read:false});c++}}showToast(`Sent to ${c}`);$('announcement-text').value=""})};
window.openCreateMenu=()=>{ $('create-menu-overlay').classList.remove('opacity-0','pointer-events-none');$('create-menu-modal').classList.remove('scale-95')};window.closeCreateMenu=()=>{ $('create-menu-overlay').classList.add('opacity-0','pointer-events-none');$('create-menu-modal').classList.add('scale-95')};window.openEventComposer=()=>{ closeCreateMenu();removeEventCover();$('event-overlay').classList.remove('opacity-0','pointer-events-none');$('event-modal-box').classList.remove('scale-95')};window.closeEventComposer=()=>{ $('event-overlay').classList.add('opacity-0','pointer-events-none');$('event-modal-box').classList.add('scale-95')};window.handleEventCoverSelect=e=>{if(e.target.files[0]){currentEventCoverBlob=e.target.files[0];let r=new FileReader();r.onload=ev=>{window.currentEventCover=ev.target.result;$('event-cover-preview').src=window.currentEventCover;show('event-cover-preview-container');hide('add-cover-btn')};r.readAsDataURL(currentEventCoverBlob)}};window.removeEventCover=()=>{window.currentEventCover=null;currentEventCoverBlob=null;$('event-cover-preview').src="";hide('event-cover-preview-container');show('add-cover-btn');$('event-cover-input').value=""};window.publishEvent=()=>{showToast("Events coming soon!",false);closeEventComposer()};
window.showPostOptions=(e,pid,aid)=>{e.stopPropagation();let o=$('post-options-overlay'),m=$('post-options-modal'),c=$('post-options-content'),me=aid===currentUser.id,adm=currentUser.email==='edulinkbht@gmail.com',h='';if(me)h+=`<button onclick="editPost('${pid}');hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="edit-2" class="w-5 h-5"></i> Edit Post</button>`;if(me||adm)h+=`<button onclick="deletePost('${pid}');hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Post</button>`;if(!me){let s=savedPosts.includes(pid);h+=`<button onclick="toggleSave('${pid}');hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="bookmark" class="w-5 h-5 ${s?'fill-yellow-500 text-yellow-500':''}"></i> ${s?'Unsave':'Save'}</button><button onclick="showToast('Reported');hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="flag" class="w-5 h-5"></i> Report</button>`}h+=`<button onclick="sharePost('${pid}');hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="link" class="w-5 h-5"></i> Copy Link</button>`;c.innerHTML=h;refreshIcons();show('post-options-overlay');requestAnimationFrame(()=>{o.classList.remove('opacity-0');m.classList.remove('translate-y-full','md:scale-95');m.classList.add('translate-y-0','md:scale-100')})};
window.hidePostMenu=()=>{let o=$('post-options-overlay'),m=$('post-options-modal');o.classList.add('opacity-0');m.classList.add('translate-y-full','md:scale-95');m.classList.remove('translate-y-0','md:scale-100');setTimeout(()=>hide('post-options-overlay'),200)};
window.editPost=pid=>{let p=posts.find(x=>x.id===pid);if(!p)return;$('compose-text').value=p.content;window.editingPostId=pid;$('compose-title-text').innerText="Edit Post";$('btn-publish').innerText="Update";openCompose()};
window.deletePost=async pid=>{showAlert("Delete post?",async()=>{await deleteDoc(doc(db,"posts",pid));showToast("Deleted")})};
window.openCompose=()=>{window.selectedCollaborators=[];renderCollabChips();closeCreateMenu();$('compose-overlay').classList.remove('opacity-0','pointer-events-none');$('compose-modal').classList.remove('scale-95')};window.closeCompose=()=>{$('compose-overlay').classList.add('opacity-0','pointer-events-none');$('compose-modal').classList.add('scale-95');setTimeout(()=>{window.editingPostId=null;$('compose-title-text').innerText="Create Post";$('btn-publish').innerText="Post";$('compose-text').value="";removeMedia()},200)};window.toggleComposeSettings=()=>toggle('compose-settings-area');
window.openUploadOptions=()=>show('upload-options-modal');window.triggerUpload=m=>{window.uploadMode=m;hide('upload-options-modal');let i=$('media-input');if(m==='multiple')i.setAttribute('multiple','');else i.removeAttribute('multiple');i.click()};
window.handleFileSelect=e=>{let f=e.target.files;if(f.length){window.currentMediaBlob=[];window.currentMedia=[];show('media-preview-container');$('preview-inner').innerHTML='';Array.from(f).forEach(file=>{window.currentMediaBlob.push(file);let r=new FileReader();r.onload=ev=>{window.currentMedia.push(ev.target.result);let iv=file.type.startsWith('video'),el=document.createElement(iv?'video':'img');el.src=ev.target.result;el.className="h-20 w-20 object-cover rounded-md border border-gray-200 shrink-0";$('preview-inner').appendChild(el)};r.readAsDataURL(file)})}};
window.removeMedia=()=>{window.currentMedia=[];window.currentMediaBlob=[];hide('media-preview-container');$('media-input').value=""};
async function uploadToImgHippo(f){let d=new FormData();d.append('api_key','d28bf3c492ad07b53dc4e3f9ce99b072');d.append('file',f);let r=await fetch('https://api.imghippo.com/v1/upload',{method:'POST',body:d}),j=await r.json();if(j.success)return j.data.url;throw new Error('Fail')}
window.publishPost=async()=>{let txt=$('compose-text').value,b=$('btn-publish'),pr=$('post-setting-privacy').checked,sl=$('post-setting-likes').checked,sc=$('post-setting-comments').checked,oh=b.innerHTML;if(!txt.trim()&&!window.currentMedia.length)return showToast("Empty!",true);b.innerHTML=`Posting...`;b.disabled=true;try{let mu=[];if(window.currentMediaBlob?.length)for(const f of window.currentMediaBlob)mu.push(await uploadToImgHippo(f));else if(window.currentMedia.length)mu=window.currentMedia;let mp=mu.length===1?mu[0]:(mu.length?mu:null),pd={authorId:currentUser.id,content:txt,media:mp,timestamp:serverTimestamp(),likes:[],comments:[],collaborators:window.selectedCollaborators||[],settings:{privacy:pr?'private':'public',showLikes:sl,showComments:sc}};if(window.editingPostId){await updateDoc(doc(db,"posts",window.editingPostId),{content:txt,settings:pd.settings});showToast("Updated!")}else{let r=await addDoc(collection(db,"posts"),pd);showToast("Posted!");window.selectedCollaborators.forEach(c=>sendNotification(c.id,'collab_request','invited to collaborate',r.id))}closeCompose()}catch(e){console.error(e);showToast("Error",true)}finally{b.innerHTML=oh;b.disabled=false}};
window.showToast=(m,e=false)=>{let t=$('toast'),tm=$('toast-msg'),i=$('toast-icon');tm.innerText=m;t.style.backgroundColor=e?'#d93025':'#303134';i.setAttribute('data-lucide',e?'alert-circle':'check-circle-2');i.classList.toggle('text-white',e);i.classList.toggle('text-[#c4eed0]',!e);refreshIcons();t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)};
window.openLightbox=(s,t='image')=>{let w=$('lightbox-wrapper'),l=$('lightbox');w.innerHTML=(t==='video'||s.includes('.mp4'))?`<video src="${s}" controls autoplay class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"></video>`:`<img src="${s}" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">`;l.classList.remove('pointer-events-none','opacity-0');l.classList.add('active')};window.closeLightbox=()=>{let l=$('lightbox');l.classList.remove('active');l.classList.add('pointer-events-none','opacity-0');let v=l.querySelector('video');if(v)v.pause()};
refreshIcons();
</script></body></html>
