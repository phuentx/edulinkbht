<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduLink</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --surface: #ffffff; 
            --background: #f9fafb; 
            --primary: #0b57d0;
            --on-surface: #1f1f1f;
            --outline: #eaecf0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background);
            color: var(--on-surface);
            overflow: hidden; 
        }

        h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }

        /* No Scrollbars */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { width: 0px; background: transparent; display: none; }
        
        /* Prevent icon squishing globally */
        i[data-lucide], svg { flex-shrink: 0; }

        .fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        /* --- UNIFIED PANEL STYLES --- */
        .app-panel {
            background: #ffffff;
            border-radius: 20px;
            border: 1px solid var(--outline);
            height: 100%; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03); 
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .app-panel {
                border-radius: 0 !important;
                border: none !important;
                box-shadow: none !important;
            }
            body {
                padding: 0 !important;
                background-color: #fff;
            }
            #workspace-layout {
                gap: 0 !important;
            }
        }

        /* --- SIDEBAR --- */
        #main-sidebar {
            width: 88px;
            flex-shrink: 0;
            padding: 24px 12px;
            transition: width 0.3s cubic-bezier(0.2, 0, 0, 1), padding 0.3s ease;
        }

        @media (min-width: 1024px) {
            #main-sidebar {
                width: 260px; 
                padding: 24px 20px;
            }
        }

        .nav-item {
            display: flex; align-items: center; gap: 14px;
            padding: 12px; 
            color: #667085;
            font-weight: 500;
            font-size: 15px;
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 4px;
            justify-content: center;
        }

        .nav-item:hover {
            color: #1f1f1f;
            background-color: #f3f4f6;
        }

        .nav-item.active {
            color: #0b57d0;
            background-color: #eff4ff;
            font-weight: 600;
        }

        @media (min-width: 1024px) {
            .nav-item {
                justify-content: flex-start;
                padding: 10px 16px; 
            }
        }
        
        .sidebar-user {
            display: flex; align-items: center; gap: 12px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            justify-content: center;
        }
        .sidebar-user:hover { background-color: #f9fafb; }
        
        @media (min-width: 1024px) {
            .sidebar-user { justify-content: flex-start; padding: 8px 12px; }
        }
        
        .create-btn {
            display: flex; 
            align-items: center; 
            justify-content: flex-start; 
            gap: 12px;
            background: #1f1f1f;
            color: white;
            padding: 12px 20px; 
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            line-height: 1; 
            min-width: 0;
            white-space: nowrap;
        }
        
        .create-btn:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        /* --- POST CARD DESIGN (Twitter-Style Full Width) --- */
        .post-card { 
            background: white; 
            border-bottom: 1px solid var(--outline); 
            border-radius: 0; 
            transition: background-color 0.2s ease; 
            margin-bottom: 0;
            box-shadow: none;
            overflow: visible;
        }
        .post-card:hover { 
            background-color: #f8fafe; 
            cursor: pointer; 
            transform: none;
        }
        
        .post-header {
            display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;
        }

        .post-avatar-container {
            position: relative;
        }
        .post-avatar {
            width: 44px; height: 44px;
            border-radius: 50%;
            background-color: #f3f4f6;
            border: 1px solid #eaecf0;
            object-fit: cover;
        }
        
        .post-author-name {
            font-weight: 700; font-size: 15px; color: #1f1f1f;
            line-height: 1.2;
        }
        .post-author-name:hover { text-decoration: underline; color: #0b57d0; }
        
        .post-meta {
            font-size: 12px; color: #667085; margin-top: 3px; font-weight: 500;
        }

        .post-body {
            font-size: 15px; line-height: 1.6; color: #374151;
            margin-bottom: 16px;
        }
        
        .post-actions {
            display: flex; align-items: center; justify-content: space-between;
            padding-top: 14px; border-top: 1px solid #f2f4f7;
        }

        .action-btn {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 12px; border-radius: 10px;
            color: #667085; font-size: 13px; font-weight: 600;
            transition: all 0.2s;
            background: transparent; border: none; cursor: pointer;
        }
        .action-btn:hover { background-color: #f9fafb; color: #1f1f1f; }
        .action-btn.like:hover { background-color: #fff1f2; color: #e11d48; }
        .action-btn.comment:hover { background-color: #eff6ff; color: #2563eb; }
        .action-btn.bookmark:hover { background-color: #f5f3ff; color: #7c3aed; }
        .action-btn.ai-pin { color: #0b57d0; background-color: #eff6ff; } 
        .action-btn.ai-pin:hover { background-color: #dbeafe; }

        .code-preview {
            background: #111827; border-radius: 16px; overflow: hidden;
            border: 1px solid #1f2937; margin-top: 16px; margin-bottom: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .code-preview-header {
            padding: 10px 16px; background: #1f2937; border-bottom: 1px solid #374151;
            display: flex; align-items: center; gap: 6px;
        }
        .window-dot { width: 10px; height: 10px; border-radius: 50%; }
        
        /* --- COMPOSE & CREATE MENUS --- */
        #compose-modal, #create-menu-modal, #event-modal-box, #mentorship-modal-box, #edit-profile-modal {
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid #eaecf0;
        }
        
        .compose-header {
            display: flex; align-items: center; justify-content: space-between;
            padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f0f0f0;
        }
        .compose-title { font-size: 18px; font-weight: 600; color: #1f1f1f; font-family: 'Google Sans', sans-serif; }

        .compose-user-area {
            display: flex; align-items: center; gap: 12px; margin-bottom: 16px;
        }
        
        .compose-textarea {
            width: 100%; min-height: 120px;
            font-size: 17px; line-height: 1.6;
            color: #1f1f1f; placeholder-color: #98a2b3;
            border: none; outline: none; resize: none;
            background: transparent;
        }

        .compose-tools {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0;
        }

        .tool-group { display: flex; gap: 4px; }
        
        .tool-btn {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #444746; transition: background 0.2s; cursor: pointer;
        }
        .tool-btn:hover { background-color: #f3f4f6; color: #1f1f1f; }

        /* Create Menu Specific */
        .create-option-card {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 24px; border-radius: 16px; border: 1px solid #eaecf0;
            background: #fff; cursor: pointer; transition: all 0.2s;
            gap: 12px;
        }
        .create-option-card:hover {
            border-color: #0b57d0; background: #eff4ff; transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(11, 87, 208, 0.1);
        }
        .create-icon-bg {
            width: 56px; height: 56px; border-radius: 50%; background: #f3f4f6;
            display: flex; align-items: center; justify-content: center; color: #1f1f1f;
            margin-bottom: 8px; transition: background 0.2s;
        }
        .create-option-card:hover .create-icon-bg { background: #d3e3fd; color: #0b57d0; }

        /* Notion Style Event Form */
        .notion-input-row {
            display: flex; align-items: center; gap: 12px; padding: 8px 0;
            color: #374151; font-size: 15px;
        }
        .notion-label {
            width: 100px; color: #667085; display: flex; align-items: center; gap: 6px; font-size: 14px;
        }
        .notion-input {
            flex: 1; border: none; outline: none; background: transparent;
            font-size: 15px; color: #1f1f1f;
        }
        .notion-input:focus { background: #f9fafb; border-radius: 4px; }
        
        .media-preview-wrapper {
            margin-top: 12px; position: relative; 
            width: 100%; background: #f8f9fa; border-radius: 12px;
            overflow: hidden; border: 1px solid #eaecf0;
            display: flex; justify-content: center; align-items: center;
        }
        .media-preview-content {
            width: 100%; height: auto; max-height: 400px;
            object-fit: contain; display: block;
        }

        /* --- OTHER --- */
        .gemini-input-wrapper {
            background-color: #f3f4f6; 
            border-radius: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            display: flex; flex-direction: column;
            min-height: 52px;
        }
        .gemini-input-wrapper:focus-within {
            background-color: #ffffff;
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px #e3e3e3; 
        }
        .gemini-input-wrapper.search-active { background-color: #fff; box-shadow: 0 0 20px rgba(11, 87, 208, 0.1), 0 0 0 1.5px #c2e7ff; }
        .gemini-input-wrapper.idea-active { background-color: #fff; box-shadow: 0 0 20px rgba(192, 132, 252, 0.1), 0 0 0 1.5px #e8d5fc; }

        .gemini-code-container { border-radius: 12px; overflow: hidden; margin: 20px 0; border: 1px solid #444746; background: #1e1f20; }
        .gemini-code-header { background: #2f3033; padding: 10px 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444746; font-size: 13px; color: #e3e3e3; font-family: 'Google Sans', sans-serif; font-weight: 500; }
        .gemini-code-btn { display: flex; align-items: center; gap: 6px; color: #e3e3e3; cursor: pointer; padding: 6px 10px; border-radius: 6px; transition: background 0.2s; }
        .gemini-code-btn:hover { background: rgba(255,255,255,0.1); }
        pre { background: #1e1f20; padding: 20px; color: #e3e3e3; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 0.95rem; margin: 0; }
        .code-keyword { color: #ffab91; } .code-function { color: #81c784; } 

        .feed-panel { flex: 1; min-width: 0; order: 1; }
        .ai-panel { width: 100%; flex-shrink: 0; order: 2; }
        @media (min-width: 1280px) { .ai-panel { width: 440px; } }

        /* Focus Mode Logic - Sidebar stays standard, Feed is hidden, AI Panel expands */
        #workspace-layout.swapped { justify-content: flex-start;  padding-left: 0; gap: 20px; }
        /* Hide middle panel when swapped to focus on Newton */
        #workspace-layout.swapped #main-panel { display: none !important; }
        /* When swapped (focused), AI panel takes remaining width next to sidebar */
        .swapped .ai-panel { 
            flex: 1; 
            width: 100% !important;
            max-width: none; 
            order: 1;  
            border: 2px solid #a8c7fa;  
            box-shadow: 0 12px 40px rgba(11, 87, 208, 0.1); 
        }
        
        .plus-menu {
            position: absolute; bottom: 140px; left: 20px; background: white; border: 1px solid #eaecf0;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 200px; display: flex; flex-direction: column; padding: 6px;
            z-index: 50; transform-origin: bottom left; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }
        .plus-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .model-menu {
            position: absolute; top: 50px; right: 60px; background: white; border: 1px solid #eaecf0;
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 220px; display: flex; flex-direction: column; padding: 6px;
            z-index: 100; transform-origin: top right; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
        }
        .model-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

        .menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: #1f1f1f; font-size: 14px; font-weight: 500; transition: background 0.1s; }
        .menu-item:hover { background: #f9fafb; }
        .menu-item.active-item { background: #eff4ff; color: #0b57d0; }

        .idea-container { border: 1px solid #eaecf0; border-radius: 20px; overflow: hidden; margin-bottom: 16px; transition: all 0.3s ease; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .idea-header { padding: 18px; background: #ffffff; cursor: pointer; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid transparent; }
        .idea-body { padding: 0; height: 0; overflow: hidden; opacity: 0; transition: all 0.3s ease; }
        .idea-container.expanded { border-color: #c2e7ff; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .idea-container.expanded .idea-body { height: auto; padding: 24px; opacity: 1; }
        .idea-container.expanded .idea-header { border-bottom: 1px solid #f0f0f0; background: #f9fafb; }

        .roadmap-container { position: relative; margin-left: 10px; border-left: 2px solid #eaecf0; padding-bottom: 8px; margin-top: 10px; }
        .roadmap-step { position: relative; padding-left: 32px; margin-bottom: 24px; }
        .roadmap-step:last-child { margin-bottom: 0; }
        .roadmap-dot { position: absolute; left: -13px; top: 0; width: 24px; height: 24px; background: white; border: 2px solid #0b57d0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #0b57d0; font-size: 11px; font-weight: 700; z-index: 2; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .roadmap-content { background: #f9fafb; padding: 14px 18px; border-radius: 12px; border: 1px solid #eaecf0; transition: background 0.2s; }
        
        .website-link { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: white; border: 1px solid #eaecf0; border-radius: 20px; color: #1f1f1f; font-size: 13px; font-weight: 500; transition: all 0.2s; text-decoration: none; }
        .website-link:hover { background: #f9fafb; border-color: #d3e3fd; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .website-link img { width: 16px; height: 16px; border-radius: 3px; }

        .google-panel { background: #ffffff; border-radius: 20px; padding: 0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #eaecf0; margin-bottom: 20px; overflow: hidden; }
        .search-summary-section { background: #f9fafb; padding: 24px; border-bottom: 1px solid #eaecf0; }
        .search-grid { display: grid; grid-template-columns: 1fr; gap: 0px; }
        .search-card { background: #fff; padding: 16px 24px; border-bottom: 1px solid #f0f0f0; transition: background 0.1s; cursor: pointer; text-decoration: none; display: block; }
        .search-card:hover { background: #f9fafb; }
        .search-favicon { width: 24px; height: 24px; border-radius: 50%; background: #f3f4f6; padding: 2px; object-fit: contain; }

        .notebook-overlay { position: fixed; bottom: 0; left: 50%; width: 96%; max-width: 1200px; height: 92vh; background: white; border-top-left-radius: 32px; border-top-right-radius: 32px; box-shadow: 0 -10px 40px rgba(0,0,0,0.05); z-index: 100; transform: translate(-50%, 110%); transition: transform 0.4s cubic-bezier(0.2, 0, 0, 1); display: flex; flex-direction: column; }
        .notebook-active { transform: translate(-50%, 0); }
        .backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .backdrop.active { opacity: 1; pointer-events: auto; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: #f2f2f2; padding: 14px 28px; border-radius: 48px; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; cursor: pointer; color: #667085; }
        .icon-btn:hover { background-color: #f3f4f6; color: #1f1f1f; }
        
        .hashtag { color: #0b57d0; font-weight: 500; cursor: pointer; padding: 2px 6px; border-radius: 6px; }
        .hashtag:hover { background: #eff4ff; }

        /* --- POST MENU STYLES --- */
        .post-options-menu {
            position: absolute;
            background: white;
            border: 1px solid #eaecf0;
            border-radius: 12px;
            box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 160px;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
            transition: all 0.1s ease-out;
            padding: 6px;
        }
        .post-options-menu.active {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }
        .post-option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.1s;
            font-weight: 500;
        }
        .post-option-item:hover {
            background: #f3f4f6;
            color: #1f1f1f;
        }
        .post-option-item.danger {
            color: #d92d20;
        }
        .post-option-item.danger:hover {
            background: #fef2f2;
            color: #b91c1c;
        }

        /* --- NOTIFICATION TABS (Refined) --- */
        .tab-group { 
            display: inline-flex; 
            background: #f3f4f6; 
            padding: 4px; 
            border-radius: 12px; 
            width: auto;
            border: 1px solid #eaecf0;
        }
        .tab-btn { 
            padding: 8px 20px; 
            font-size: 13px; 
            font-weight: 600; 
            color: #667085; 
            border-radius: 8px; 
            transition: all 0.2s ease; 
            cursor: pointer;
            background: transparent;
        }
        .tab-btn:hover {
            color: #1f1f1f;
        }
        .tab-btn.active { 
            background: #ffffff; 
            color: #0b57d0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); 
        }

        /* --- UPDATED CHAT STYLES (Notion Style) --- */
        .chat-sidebar-item { 
            display: flex; align-items: center; gap: 10px; padding: 8px 12px; 
            margin: 2px 8px; border-radius: 6px; cursor: pointer; color: #37352f; 
            transition: background 0.1s; font-size: 14px; font-weight: 500;
        }
        .chat-sidebar-item:hover { background: #efefef; }
        .chat-sidebar-item.active { background: #e0e0e0; color: #1f1f1f; }

        .chat-bubble-me { 
            background: #0b57d0; color: white; 
            padding: 8px 14px; border-radius: 10px; 
            font-size: 15px; max-width: 70%; align-self: flex-end; 
            margin-bottom: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .chat-bubble-them { 
            background: #f2f3f5; color: #37352f; 
            padding: 8px 14px; border-radius: 10px; 
            font-size: 15px; max-width: 70%; align-self: flex-start; 
            margin-bottom: 6px; 
        }
        .chat-date-divider { text-align: center; font-size: 11px; color: #9ca3af; margin: 16px 0; font-weight: 500; }

        .mobile-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; flex: 1; gap: 4px; color: #98a2b3; transition: all 0.2s; cursor: pointer;
        }
        .mobile-nav-item.active { color: #0b57d0; }
        .mobile-nav-item i { width: 24px; height: 24px; transition: transform 0.2s; }
        .mobile-nav-item.active i { transform: scale(1.1); stroke-width: 2.5px; }

        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0",
    "marked": "https://esm.sh/marked@^17.0.1"
  }
}
</script>
</head>

<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]" onload="initApp()" onclick="hidePostMenu()">

    <!-- Post Options Global Menu -->
    <div id="global-post-menu" class="post-options-menu"></div>

    <!-- Post View Overlay -->
    <div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-end md:items-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closePostView()"></div>
        <div class="bg-white w-full md:w-[1000px] h-[95vh] md:h-[85vh] md:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col md:flex-row transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
             <div class="w-full md:w-[60%] flex flex-col h-full bg-white md:border-r border-gray-100 relative">
                 <div class="h-16 border-b border-gray-100 flex items-center justify-between px-6 shrink-0 bg-white z-10 sticky top-0">
                    <button onclick="closePostView()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down" class="w-6 h-6"></i></button>
                    <span class="font-bold text-lg text-[#1f1f1f] hidden md:block">Post</span>
                    <span class="font-bold text-lg text-[#1f1f1f] md:hidden">Details</span>
                    <button class="icon-btn hover:bg-gray-100"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                 </div>
                 <div id="post-view-scroll" class="flex-1 overflow-y-auto p-0 scroll-smooth">
                    <div id="injected-post" class="p-6 md:p-8"></div>
                    <div id="mobile-comments-section" class="md:hidden border-t border-gray-100">
                        <div class="p-4 bg-gray-50/50">
                            <h4 class="text-sm font-bold text-gray-800 mb-4">Comments</h4>
                            <div id="comments-list-mobile"></div>
                        </div>
                    </div>
                 </div>
                 <div class="md:hidden border-t border-gray-100 p-3 bg-white shrink-0 sticky bottom-0 z-20">
                     <div class="flex gap-3 items-center">
                        <img id="mobile-comment-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200">
                        <div class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm text-gray-500" onclick="document.getElementById('comment-input-desktop').focus()">Add a comment...</div>
                     </div>
                 </div>
             </div>
             <div class="hidden md:flex w-[40%] flex-col h-full bg-[#fff]">
                 <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white">
                     <span class="font-bold text-[#1f1f1f]">Comments</span>
                     <button onclick="closePostView()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div id="comments-list-desktop" class="flex-1 overflow-y-auto p-0 bg-white"></div>
                 <div class="p-4 border-t border-gray-100 bg-white shrink-0">
                    <div class="bg-gray-50 rounded-2xl p-3 border border-gray-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all flex gap-3">
                        <img id="comment-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 shrink-0 mt-1">
                        <div class="flex-1">
                            <textarea id="comment-input-desktop" placeholder="Add a comment..." class="w-full bg-transparent outline-none text-[14px] text-gray-800 placeholder-gray-500 resize-none min-h-[40px] py-1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                            <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200/60">
                                <div class="flex gap-1">
                                    <button class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors"><i data-lucide="smile" class="w-4 h-4"></i></button>
                                </div>
                                <button onclick="submitComment()" class="bg-[#0b57d0] text-white px-5 py-1.5 rounded-full text-[13px] font-bold hover:bg-blue-700 transition-all shadow-sm hover:shadow active:scale-95">Post</button>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()">
        <button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i data-lucide="x" class="w-8 h-8"></i></button>
        <div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div>
    </div>

    <div id="toast" class="toast">
        <i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span>
    </div>

    <!-- CREATE SELECTION OVERLAY -->
    <div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()">
        <div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2>
                <button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="create-option-card" onclick="openCompose()">
                    <div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Post</span>
                </div>
                <div class="create-option-card" onclick="openEventComposer()">
                    <div class="create-icon-bg"><i data-lucide="calendar-plus" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Event</span>
                </div>
                <div class="create-option-card" onclick="openMentorship()">
                    <div class="create-icon-bg"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Mentorship</span>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE OVERLAY -->
    <div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeEditProfile()">
        <div id="edit-profile-modal" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold google-font">Edit Profile</h2>
                <button onclick="closeEditProfile()" class="icon-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex flex-col gap-4">
                <div class="flex flex-col items-center mb-2">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()">
                        <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full border-2 border-gray-100 object-cover">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="camera" class="text-white w-6 h-6"></i>
                        </div>
                    </div>
                    <input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)">
                    <span class="text-xs text-gray-500 mt-2">Tap to change</span>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Display Name</label>
                    <input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Bio</label>
                    <textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="2"></textarea>
                </div>
                <button onclick="saveProfileChanges()" class="bg-[#0b57d0] text-white py-3 rounded-xl font-bold mt-2 hover:bg-blue-700">Save Changes</button>
                <button onclick="logout()" class="text-red-600 text-sm font-bold mt-2 hover:underline">Sign Out</button>
            </div>
        </div>
    </div>

    <!-- MENTORSHIP MODAL -->
    <div id="mentorship-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="mentorship-modal-box" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative transform scale-95 transition-transform duration-200 flex flex-col items-center text-center">
            <button onclick="closeMentorship()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
            <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Construction" class="w-24 h-24 mb-4">
            <h3 class="text-xl font-bold text-[#1f1f1f] mb-2 google-font">Under Construction!</h3>
            <p class="text-sm text-[#667085] leading-relaxed">The Mentorship module is currently being built with ❤️. Check back soon for exciting updates!</p>
            <button onclick="closeMentorship()" class="mt-6 bg-[#0b57d0] text-white px-6 py-2.5 rounded-full font-bold text-sm hover:bg-[#0b57d0]/90 transition-all">Got it</button>
        </div>
    </div>

    <!-- EVENT MODAL -->
    <input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
    <div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0">
             <div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group">
                <img id="event-cover-preview" class="w-full h-full object-cover">
                <button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
                 <button onclick="document.getElementById('event-cover-input').click()" class="absolute bottom-2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20">
                    Change
                </button>
            </div>
            <button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="p-8 pt-6">
                <div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()">
                    <i data-lucide="image" class="w-4 h-4"></i> Add cover
                </div>
                <input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font">
                <div class="flex flex-col gap-1 mb-6">
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div>
                        <input type="date" id="event-date" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div>
                        <input type="time" id="event-time" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div>
                        <input type="text" id="event-location" placeholder="Add location..." class="notion-input">
                    </div>
                </div>
                <textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea>
                <div class="flex justify-end mt-6 pt-4 border-t border-gray-100">
                    <button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- POST COMPOSE OVERLAY -->
    <div id="compose-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCompose()">
        <div id="compose-modal" class="bg-white w-[95%] max-w-[620px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()">
            <div class="compose-header">
                <span class="compose-title" id="compose-title-text">Create Post</span>
                <button onclick="closeCompose()" class="icon-btn hover:bg-[#f0f4f9] w-8 h-8"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex gap-3 mb-4 items-center">
                <img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
                <div>
                    <div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div>
                    <div class="relative mt-1" onclick="event.stopPropagation()">
                        <button onclick="togglePrivacyMenu()" class="flex items-center gap-1.5 text-xs bg-gray-100 rounded-md py-1.5 px-3 text-gray-700 font-medium hover:bg-gray-200 transition-colors">
                            <i id="privacy-icon-display" data-lucide="globe" class="w-3.5 h-3.5"></i>
                            <span id="privacy-text-display">Public</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                        </button>
                        <input type="hidden" id="post-privacy" value="public">
                        <div id="privacy-menu" class="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-100 rounded-xl shadow-xl hidden z-50 p-1 transform origin-top-left transition-all">
                            <div onclick="selectPrivacy('public')" class="flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-lg cursor-pointer text-sm text-gray-700 transition-colors">
                                <div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i data-lucide="globe" class="w-4 h-4"></i></div>
                                <div class="flex flex-col"><span class="font-semibold text-xs">Public</span><span class="text-[10px] text-gray-400">Anyone can see</span></div>
                            </div>
                            <div onclick="selectPrivacy('private')" class="flex items-center gap-3 px-3 py-2.5 hover:bg-gray-50 rounded-lg cursor-pointer text-sm text-gray-700 transition-colors">
                                <div class="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i data-lucide="lock" class="w-4 h-4"></i></div>
                                <div class="flex flex-col"><span class="font-semibold text-xs">Private</span><span class="text-[10px] text-gray-400">Only you</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <textarea id="compose-text" placeholder="What do you want to share today?" class="compose-textarea"></textarea>
            
            <div id="media-preview-container" class="hidden media-preview-wrapper group">
                <img id="media-preview-img" src="" class="hidden media-preview-content">
                <video id="media-preview-video" src="" class="hidden media-preview-content" controls></video>
                <button onclick="removeMedia()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1.5 hover:bg-black/80 transition-colors shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="compose-tools">
                <div class="tool-group">
                    <button onclick="document.getElementById('media-input').click()" class="tool-btn" title="Add Media"><i data-lucide="image" class="w-5 h-5"></i></button>
                    <button onclick="insertCodeBlock()" class="tool-btn" title="Add Code"><i data-lucide="code-2" class="w-5 h-5"></i></button>
                    <button class="tool-btn" title="More"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                </div>
                <button id="btn-publish" onclick="publishPost()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-full font-bold text-[15px] hover:bg-[#0b57d0]/90 transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
            </div>
        </div>
    </div>

    <!-- NOTEBOOK -->
    <div id="notebook-backdrop" class="backdrop" onclick="closeNotebook()"></div>
    <div id="notebook-sheet" class="notebook-overlay overflow-hidden">
        <div class="h-20 border-b border-[#f0f0f0] flex items-center justify-between px-8 shrink-0 bg-white">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-[#eff4ff] flex items-center justify-center text-[#0b57d0]"><i data-lucide="notebook-pen" class="w-5 h-5"></i></div>
                <span class="google-font font-medium text-[22px] text-[#1f1f1f]">Smart Note</span>
            </div>
            <div class="flex items-center gap-3">
                <button id="btn-use-ai" onclick="generateAiNotes()" class="hidden md:flex px-5 py-2.5 rounded-full text-sm font-bold text-[#0b57d0] bg-[#f9fafb] hover:bg-[#eff4ff] gap-2 items-center transition-colors"><i data-lucide="sparkles" class="w-4 h-4"></i> Generate Summary</button>
                <button onclick="saveNote()" class="px-6 py-2.5 rounded-full text-sm font-bold bg-[#0b57d0] text-white hover:bg-[#0b57d0]/90 ml-2 shadow-sm">Save Note</button>
                <button onclick="closeNotebook()" class="icon-btn"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
        </div>
        <div class="flex-1 flex flex-col md:flex-row h-full overflow-hidden">
            <div class="hidden md:block w-[35%] bg-[#f9fafb] p-8 border-r border-[#eaecf0] overflow-y-auto">
                <div class="mb-4 text-xs font-bold text-[#667085] uppercase tracking-wider">Reference Content</div>
                <div id="notebook-source-content" class="bg-white p-6 rounded-[20px] shadow-sm border border-[#eaecf0] text-[14px] text-[#1f1f1f] leading-relaxed"></div>
            </div>
            <div class="w-full md:w-[65%] p-8 md:p-10 flex flex-col bg-white">
                <input id="note-title" type="text" placeholder="Untitled Note" class="text-3xl font-medium text-[#1f1f1f] outline-none w-full mb-6 google-font placeholder-[#b0b0b0]">
                <textarea id="note-body" placeholder="Start typing..." class="flex-1 w-full resize-none outline-none text-[17px] text-[#444746] leading-8"></textarea>
            </div>
        </div>
    </div>

    <!-- MAIN SIDEBAR -->
    <aside id="main-sidebar" class="hidden md:flex app-panel">
        <div class="h-12 flex items-center gap-3 mb-6 px-2">
            <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
            <h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
        </div>
        
        <button onclick="openCreateMenu()" class="create-btn hidden lg:flex">
            <i data-lucide="plus" class="w-5 h-5"></i><span>Create</span>
        </button>

        <nav class="flex-1 space-y-1">
            <a href="#" onclick="switchView('feed'); return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i> <span class="hidden lg:block">Home</span></a>
            <a href="#" onclick="switchView('network'); return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i> <span class="hidden lg:block">Network</span></a>
            <a href="#" onclick="switchView('chat'); return false;" id="nav-chat" class="nav-item"><i data-lucide="message-circle" class="w-5 h-5"></i> <span class="hidden lg:block">Chat</span></a>
            <a href="#" onclick="showProfile(currentUser.id); return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i> <span class="hidden lg:block">Profile</span></a>
            
            <div class="pt-6 pb-2 px-3 hidden lg:block">
                <span class="text-xs font-bold text-[#98a2b3] uppercase tracking-wider">Library</span>
            </div>
            <a href="#" onclick="switchView('saved'); return false;" id="nav-saved" class="nav-item"><i data-lucide="bookmark" class="w-5 h-5"></i> <span class="hidden lg:block">Saved</span></a>
            <a href="#" class="nav-item"><i data-lucide="file-text" class="w-5 h-5"></i> <span class="hidden lg:block">Notes</span></a>
        </nav>
        
        <div class="mt-auto pt-4 border-t border-gray-100">
            <div class="sidebar-user group" onclick="if(currentUser.id !== 'guest') showProfile(currentUser.id)">
                <img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
                <div class="hidden lg:block">
                    <div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div>
                    <div class="text-xs text-[#667085]">View Profile</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
        <main id="main-panel" class="flex-1 app-panel min-w-0 relative">
             <header class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 sticky top-0 bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0]">
                <div class="md:hidden flex items-center gap-3">
                     <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
                     <h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
                </div>
                <div class="flex-1 max-w-[600px] relative group hidden md:block">
                    <i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i>
                    <input type="text" placeholder="Search EduLink" id="global-search" onkeyup="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]">
                </div>
                <div class="flex items-center gap-3 pl-4">
                    <button class="icon-btn relative" onclick="toggleNotifications()">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                        <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                    </button>
                    <img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="if(currentUser.id !== 'guest') showProfile(currentUser.id)">
                </div>
            </header>

            <!-- FEED VIEW -->
            <div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white">
                <div id="feed-container"></div>
                <div class="flex flex-col items-center justify-center py-10 opacity-60">
                    <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-24 h-24 mb-4 opacity-80 grayscale hover:grayscale-0 transition-all duration-500">
                    <h3 class="text-lg font-bold text-gray-400 google-font">Grow and Share</h3>
                    <p class="text-sm text-gray-400 text-center max-w-xs mt-1">Your network starts here. Share your first idea!</p>
                </div>
            </div>

            <!-- SAVED VIEW -->
            <div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2>
                <div id="saved-container" class="space-y-4"></div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>

            <!-- NOTIFICATIONS VIEW (Moved from Overlay) -->
            <div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Notifications</h2>
                <div class="tab-group mb-6 mx-4 md:mx-0">
                    <button onclick="switchNotifTab('friends')" id="ntab-friends" class="tab-btn active">Friends</button>
                    <button onclick="switchNotifTab('others')" id="ntab-others" class="tab-btn">Others</button>
                    <button onclick="switchNotifTab('official')" id="ntab-official" class="tab-btn">Official</button>
                </div>
                <div id="notification-list" class="space-y-2 px-4 md:px-0 w-full"></div>
            </div>

            <!-- CHAT VIEW (UPDATED DESIGN) -->
            <div id="view-chat" class="flex-1 h-full hidden flex flex-col bg-white">
                <div class="flex h-full">
                    <div class="w-1/4 min-w-[260px] border-r border-gray-100 flex flex-col bg-[#fbfbfa]">
                        <div class="p-4 border-b border-gray-100 font-medium text-xs text-gray-500 uppercase tracking-wide">Direct Messages</div>
                        <div id="chat-list" class="flex-1 overflow-y-auto pt-2"></div>
                    </div>
                    <div class="flex-1 flex flex-col relative bg-white">
                        <div id="chat-header" class="h-16 border-b border-gray-100 bg-white flex items-center justify-between px-6 font-semibold text-gray-800 text-[15px]">
                            Select a friend to chat
                        </div>
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col"></div>
                        <div id="chat-input-area" class="p-4 bg-white hidden">
                            <form onsubmit="sendChatMessage(event)" class="flex gap-3 items-center border border-gray-200 rounded-xl p-2 px-3 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all">
                                <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent outline-none text-sm text-gray-800 placeholder-gray-400">
                                <button type="submit" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EVENTS VIEW -->
            <div id="view-events" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <div class="flex items-center justify-between mb-6 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2>
                    <button onclick="openEventComposer()" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Event</button>
                </div>
                <div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0">
                </div>
            </div>
             <!-- SEARCH RESULTS VIEW -->
            <div id="view-search-results" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]"></div>

        </main>

        <!-- AI PANEL (Newton) -->
        <aside id="ai-panel" class="ai-panel hidden xl:flex app-panel mb-16 md:mb-0">
             <div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-3">
                    <img id="ai-header-logo" src="https://i.imghippo.com/files/XEEq5247S.png" class="w-9 h-9 object-contain">
                    <span id="ai-header-name" class="text-[19px] font-medium text-[#1f1f1f] google-font">Newton</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="resetChat()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="New Chat">
                        <i data-lucide="plus" class="w-5 h-5 text-[#667085]"></i>
                    </button>
                    <div class="relative">
                        <button onclick="toggleModelMenu()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="More Options">
                            <i data-lucide="more-vertical" class="w-5 h-5 text-[#667085]"></i>
                        </button>
                        <div id="model-menu" class="model-menu">
                            <div class="px-2 py-2 text-xs font-bold text-[#667085] uppercase tracking-wider">Select Model</div>
                            <div onclick="switchModel('standard')" class="menu-item active-item" id="model-btn-standard">
                                <img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-5 h-5 object-contain"> Newton
                            </div>
                            <div onclick="switchModel('friendly')" class="menu-item" id="model-btn-friendly">
                                <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-5 h-5 rounded-full bg-indigo-50"> Tutor Chase
                            </div>
                            <div onclick="switchModel('logical')" class="menu-item" id="model-btn-logical">
                                <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Adrian" class="w-5 h-5 rounded-full bg-teal-50"> Tutor Adrian
                            </div>
                            <div onclick="switchModel('arun')" class="menu-item" id="model-btn-arun">
                                <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Destiny" class="w-5 h-5 rounded-full bg-orange-50"> Arun
                            </div>
                        </div>
                    </div>
                    <button onclick="toggleNewtonExpand()" class="hidden md:flex icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="Swap & Expand View">
                        <i id="expand-icon" data-lucide="maximize-2" class="w-5 h-5 text-[#667085]"></i>
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden relative bg-white flex flex-col">
                <div id="ai-context-chip" class="hidden mx-6 mt-4 bg-[#eff4ff] border border-[#c2e7ff] rounded-2xl p-3 flex items-center justify-between animate-fade-in slide-in-right">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 border border-[#c2e7ff] shadow-sm"><i data-lucide="paperclip" class="w-4 h-4 text-[#0b57d0]"></i></div>
                        <div class="flex flex-col min-w-0"><span class="text-[10px] text-[#444746] font-bold uppercase tracking-wider">Active Context</span><span class="text-[13px] text-[#1f1f1f] truncate font-bold" id="ai-context-text">Post Data</span></div>
                    </div>
                    <button onclick="clearContext()" class="icon-btn w-8 h-8"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6" id="chat-history">
                    <div class="chat-wrapper flex flex-col w-full mb-6 fade-in">
                        <div class="flex items-center gap-2 mb-2"><img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-6 h-6 object-contain"></div>
                        <div class="chat-msg-ai"><p>Hello! I'm Newton, your personal AI tutor. I'm here to help you learn, solve problems, and explore new ideas together. What are you working on today?</p></div>
                    </div>
                </div>
                
                <div class="p-6 bg-white relative">
                     <div id="plus-menu" class="plus-menu">
                        <div class="menu-item" onclick="document.getElementById('media-input').click(); togglePlusMenu()">
                            <i data-lucide="image"></i> Upload Media
                        </div>
                        <div class="menu-item" onclick="insertCodeSnippetAI(); togglePlusMenu()">
                            <i data-lucide="code-2"></i> Code Snippet
                        </div>
                    </div>

                    <div id="search-container" class="gemini-input-wrapper relative z-20 flex flex-col group">
                        <textarea id="ai-input" rows="1" placeholder="Ask anything..." 
                            class="w-full bg-transparent text-[#1f1f1f] p-4 pl-6 pr-6 outline-none resize-none max-h-48 overflow-y-auto text-[16px] rounded-t-[28px] placeholder-[#98a2b3] border-none focus:ring-0" 
                            oninput="handleInput(this)" 
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessageAction(); }"></textarea>
                        
                        <div class="flex items-center justify-between px-3 pb-2 pt-0">
                            <div class="flex items-center gap-1">
                                <button onclick="togglePlusMenu()" class="icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Add Features"><i id="plus-icon" data-lucide="plus-circle" class="w-5 h-5 text-[#667085]"></i></button>
                                <button id="web-search-btn" onclick="toggleWebSearch()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Search the Web"><i data-lucide="globe" class="w-5 h-5 text-[#667085]"></i></button>
                                <button id="menu-idea-validator" onclick="toggleIdeaMode()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Idea Validator"><i data-lucide="lightbulb" class="w-5 h-5 text-[#667085]"></i></button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="ai-send-btn" onclick="sendMessageAction()" class="bg-[#1e1e1e] text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#333] hover:scale-105 transition-all shadow-sm">
                                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3 flex items-center justify-center gap-2"><span class="text-[10px] font-medium text-[#98a2b3] opacity-60">Newton may display inaccurate info, so double-check its responses.</span></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Bottom Nav for Mobile -->
    <nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg">
        <div class="mobile-nav-item active" onclick="switchView('feed')">
            <i data-lucide="home"></i>
            <span class="text-[10px] font-medium">Home</span>
        </div>
        <div class="mobile-nav-item" onclick="switchView('network')">
            <i data-lucide="users"></i>
            <span class="text-[10px] font-medium">Network</span>
        </div>
        <div class="mobile-nav-item" onclick="openCreateMenu()">
            <div class="w-10 h-10 bg-[#1f1f1f] rounded-full flex items-center justify-center text-white shadow-md mb-1">
                <i data-lucide="plus" style="width:20px;height:20px"></i>
            </div>
        </div>
        <div class="mobile-nav-item" onclick="switchView('ai')">
            <i data-lucide="sparkles"></i>
            <span class="text-[10px] font-medium">Newton</span>
        </div>
        <div class="mobile-nav-item" onclick="if(currentUser.id !== 'guest') showProfile(currentUser.id)">
            <img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200">
            <span class="text-[10px] font-medium">Profile</span>
        </div>
    </nav>

    <input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, updateDoc, arrayUnion, arrayRemove, query, where, orderBy, setDoc, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Expose Firebase to global scope for vanilla JS functions
        window.db = db;
        window.auth = auth;
        window.collection = collection;
        window.addDoc = addDoc;
        window.doc = doc;
        window.onSnapshot = onSnapshot;
        window.updateDoc = updateDoc;
        window.arrayUnion = arrayUnion;
        window.arrayRemove = arrayRemove;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.serverTimestamp = serverTimestamp;

        window.logout = () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        }

        // --- GLOBAL DATA STORES (Updated via listeners) ---
        // Initial state is null until auth resolves
        window.currentUser = null;
        window.users = [];
        window.posts = [];
        window.notifications = [];
        window.chats = {}; 
        window.savedPosts = [];
        window.activeChatUserId = null;
        window.activeChatId = null;

        // --- INITIALIZATION ---
        window.initApp = function() {
            lucide.createIcons();
            setupClassifier();
            
            // Listen to public data immediately
            listenToFeed();
            listenToUsers();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Sync User to Firestore
                    const userRef = doc(db, "users", user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (!userSnap.exists()) {
                        await setDoc(userRef, {
                            id: user.uid,
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            avatar: user.photoURL || "https://api.dicebear.com/9.x/notionists/svg?seed=" + user.uid,
                            bio: "New to EduLink",
                            following: [],
                            followers: [],
                            friends: []
                        });
                    }
                    
                    window.currentUser = { ...userSnap.data(), id: user.uid, name: user.displayName || user.email.split('@')[0], avatar: user.photoURL || "https://api.dicebear.com/9.x/notionists/svg?seed=" + user.uid }; 
                    if(!window.currentUser.following) window.currentUser.following = [];
                    if(!window.currentUser.friends) window.currentUser.friends = [];

                    updateUserInterface();
                    listenToNotifications();
                    showToast(`Welcome back, ${window.currentUser.name.split(' ')[0]}!`);
                } else {
                    // Redirect to login page if not authenticated
                    window.location.href = "index.html";
                }
            });
        };

        function listenToUsers() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                window.users = snapshot.docs.map(d => d.data());
                // RE-RENDER FEED when users load to fix "Unknown" user issue
                if(window.posts.length > 0) renderFeed();
            });
        }

        function listenToFeed() {
            const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                window.posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFeed();
            });
        }

        function listenToNotifications() {
             if(!currentUser) return;
             const q = query(collection(db, "notifications"), where("receiverId", "==", currentUser.id), orderBy("timestamp", "desc"));
             onSnapshot(q, (snapshot) => {
                 window.notifications = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                 const badge = document.getElementById('notif-badge');
                 const unread = window.notifications.some(n => !n.read);
                 if(unread) badge.classList.remove('hidden');
                 else badge.classList.add('hidden');
                 if(!document.getElementById('view-notifications').classList.contains('hidden')) renderNotifications();
             });
        }

        // --- CORE UI FUNCTIONS ---
        window.updateUserInterface = () => {
            if (!currentUser) return;
            document.getElementById('sidebar-name').innerText = currentUser.name;
            document.getElementById('sidebar-avatar').src = currentUser.avatar;
            document.getElementById('mobile-avatar').src = currentUser.avatar;
            document.getElementById('header-avatar').src = currentUser.avatar;
            document.getElementById('compose-name').innerText = currentUser.name;
            document.getElementById('compose-avatar').src = currentUser.avatar;
            document.getElementById('comment-input-avatar').src = currentUser.avatar;
            document.getElementById('mobile-comment-avatar').src = currentUser.avatar;
            
            if(document.getElementById('edit-name')) {
                document.getElementById('edit-name').value = currentUser.name;
                document.getElementById('edit-bio').value = currentUser.bio;
                document.getElementById('edit-avatar-preview').src = currentUser.avatar;
            }
        }

        // --- FEED ---
        window.renderFeed = (filterTerm = "") => {
            const container = document.getElementById('feed-container');
            container.innerHTML = "";
            let displayPosts = window.posts.filter(p => {
                // If private and not author, hide
                if (p.privacy === 'private' && currentUser && p.authorId !== currentUser.id) return false;
                return true;
            });

            if(filterTerm) {
                const term = filterTerm.toLowerCase();
                displayPosts = displayPosts.filter(p => p.content.toLowerCase().includes(term));
            }

            displayPosts.forEach(post => container.appendChild(createPostElement(post)));
            lucide.createIcons();
        }

        window.createPostElement = (post) => {
            // First check if the author is ME (avoids wait for users list)
            let author = null;
            if(currentUser && post.authorId === currentUser.id) {
                author = currentUser;
            } else {
                author = window.users.find(u => u.id === post.authorId);
            }
            
            if (!author) {
                author = { name: 'User', avatar: 'https://api.dicebear.com/9.x/notionists/svg?seed=' + post.authorId };
            }

            const isLiked = currentUser && post.likes && post.likes.includes(currentUser.id);
            const isSaved = window.savedPosts.includes(post.id);
            const dateStr = post.timestamp?.toDate ? post.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Just now';

            const div = document.createElement('article');
            div.className = "post-card group overflow-hidden fade-in";
            div.onclick = () => openPostView(post.id);
            
            let mediaHTML = "";
            if (post.media) {
                const isVideo = post.media.startsWith('data:video');
                mediaHTML = isVideo 
                ? `<div class="mt-3 rounded-xl overflow-hidden"><video src="${post.media}" class="w-full max-h-[400px]" controls onclick="event.stopPropagation()"></video></div>`
                : `<div class="mt-3 rounded-xl overflow-hidden cursor-pointer" onclick="event.stopPropagation(); openLightbox('${post.media}')">
                    <img src="${post.media}" class="w-full max-h-[400px] object-cover bg-gray-50">
                </div>`;
            }

            let tagsHTML = marked.parse(post.content.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>'));
            let privacyIcon = post.privacy === 'private' ? '<i data-lucide="lock" class="w-3 h-3 ml-1 text-gray-400"></i>' : '<i data-lucide="globe" class="w-3 h-3 ml-1 text-gray-400"></i>';
            let officialBadge = author.isOfficial ? `<i data-lucide="badge-check" class="w-4 h-4 official-badge"></i>` : '';
            const commentsCount = post.commentsCount || 0;

            div.innerHTML = `
                <div class="p-4 md:p-5">
                    <div class="post-header">
                        <div class="flex gap-3">
                            <div class="post-avatar-container">
                                <img src="${author.avatar}" class="post-avatar">
                            </div>
                            <div>
                                <div class="flex items-center">
                                    <span class="post-author-name" onclick="event.stopPropagation(); showProfile('${author.id}')">${author.name}</span>
                                    ${officialBadge}
                                </div>
                                <div class="post-meta flex items-center">${dateStr} • ${privacyIcon}</div>
                            </div>
                        </div>
                        <button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event, '${post.id}', '${author.name}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                    </div>
                    <div class="post-content">
                        <div class="post-body" data-raw-text="${post.content.replace(/"/g, '&quot;')}">${tagsHTML}</div>
                        ${mediaHTML}
                    </div>
                    <div class="post-actions">
                        <div class="flex items-center gap-1">
                             <button class="action-btn like" onclick="event.stopPropagation(); toggleLike('${post.id}')"><i data-lucide="thumbs-up" class="w-5 h-5 ${isLiked ? 'fill-blue-600 text-blue-600' : ''}"></i> <span class="text-xs font-medium">${post.likes ? post.likes.length : 0}</span></button>
                             <button class="action-btn comment" onclick="event.stopPropagation(); openPostView('${post.id}')"><i data-lucide="message-square" class="w-5 h-5"></i> <span class="text-xs font-medium">${commentsCount}</span></button>
                        </div>
                         <div class="flex items-center gap-1">
                             <button class="action-btn bookmark" onclick="event.stopPropagation(); toggleSave('${post.id}')"><i data-lucide="bookmark" class="w-5 h-5 ${isSaved ? 'fill-current text-purple-600' : ''}"></i></button>
                             <button class="action-btn ai-pin" onclick="event.stopPropagation(); pinPost('${post.id}', '${author.name}')" title="Analyze with Newton"><i data-lucide="sparkles" class="w-5 h-5"></i></button>
                         </div>
                    </div>
                </div>
            `;
            return div;
        }

        // --- ACTIONS ---
        window.publishPost = async () => {
            if (!currentUser) return; // Should not happen due to redirect

            const textRaw = document.getElementById('compose-text').value; 
            const privacy = document.getElementById('post-privacy').value;
            
            if (!textRaw.trim() && !window.currentMedia) { showToast("Empty post!", true); return; }
            
            const btn = document.getElementById('btn-publish');
            btn.innerText = "Posting..."; btn.disabled = true;

            await addDoc(collection(db, "posts"), {
                authorId: currentUser.id,
                content: textRaw,
                media: window.currentMedia || null,
                timestamp: serverTimestamp(),
                likes: [],
                commentsCount: 0,
                privacy: privacy
            });

            document.getElementById('compose-text').value = ""; 
            window.removeMedia(); 
            btn.innerText = "Post"; btn.disabled = false; 
            closeCompose(); 
            showToast("Posted!"); 
        };

        window.toggleLike = async (postId) => {
            if (!currentUser) return;

            const postRef = doc(db, "posts", postId);
            const post = window.posts.find(p => p.id === postId);
            if(post.likes && post.likes.includes(currentUser.id)) {
                await updateDoc(postRef, { likes: arrayRemove(currentUser.id) });
            } else {
                await updateDoc(postRef, { likes: arrayUnion(currentUser.id) });
                if(post.authorId !== currentUser.id) sendNotif(post.authorId, 'like', 'liked your post');
            }
        };

        window.submitComment = async () => {
            if (!currentUser) return;

            const txt = document.getElementById('comment-input-desktop').value.trim();
            if(!txt || !window.currentViewingPostId) return;
            
            const postRef = doc(db, "posts", window.currentViewingPostId);
            const commentsRef = collection(postRef, "comments");
            
            await addDoc(commentsRef, {
                authorId: currentUser.id,
                content: txt,
                timestamp: serverTimestamp()
            });

            // Update comment count
            const post = window.posts.find(p => p.id === window.currentViewingPostId);
            await updateDoc(postRef, { commentsCount: (post.commentsCount || 0) + 1 });

            if(post.authorId !== currentUser.id) sendNotif(post.authorId, 'comment', 'commented on your post');
            
            document.getElementById('comment-input-desktop').value = "";
        };

        // --- CHAT WITH ANYONE ---
        window.startChat = async (targetUserId) => {
            if (!currentUser) return;
            
            // Simple query for now. In production, consider composite keys or subcollections.
            const q = query(collection(db, "chats"), where("participants", "array-contains", currentUser.id));
            const snapshot = await getDocs(q);
            let chatDoc = snapshot.docs.find(d => d.data().participants.includes(targetUserId));
            
            if(!chatDoc) {
                // Create new chat
                const ref = await addDoc(collection(db, "chats"), {
                    participants: [currentUser.id, targetUserId],
                    lastMessage: "",
                    lastUpdated: serverTimestamp()
                });
                window.activeChatId = ref.id;
            } else {
                window.activeChatId = chatDoc.id;
            }
            
            window.activeChatUserId = targetUserId;
            switchView('chat');
            
            // Listen to messages
            const msgsRef = collection(db, "chats", window.activeChatId, "messages");
            const qMsgs = query(msgsRef, orderBy("timestamp", "asc"));
            onSnapshot(qMsgs, (snap) => {
                const msgs = snap.docs.map(d => d.data());
                renderMessages(msgs);
            });
            
            renderChatHeader(targetUserId);
        };

        window.sendChatMessage = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text || !window.activeChatId) return;

            const chatRef = doc(db, "chats", window.activeChatId);
            const msgsRef = collection(chatRef, "messages");

            await addDoc(msgsRef, {
                senderId: currentUser.id,
                text: text,
                timestamp: serverTimestamp()
            });
            
            await updateDoc(chatRef, {
                lastMessage: text,
                lastUpdated: serverTimestamp()
            });

            input.value = "";
        };

        window.renderMessages = (msgs) => {
            const container = document.getElementById('chat-messages');
            container.innerHTML = "";
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = m.senderId === currentUser.id ? 'chat-bubble-me' : 'chat-bubble-them';
                div.innerText = m.text;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        };

        window.renderChatHeader = (userId) => {
             const user = window.users.find(u => u.id === userId);
             document.getElementById('chat-header').innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${user.avatar}" class="w-8 h-8 rounded-full border border-gray-200">
                    <span class="font-semibold text-gray-800">${user.name}</span>
                </div>
            `;
            document.getElementById('chat-input-area').classList.remove('hidden');
        };

        window.sendNotif = async (receiverId, type, content) => {
            await addDoc(collection(db, "notifications"), {
                receiverId, type, content, senderId: currentUser.id, timestamp: serverTimestamp(), read: false
            });
        };

        // --- POST VIEW LISTENERS ---
        let commentsUnsubscribe = null;
        window.openPostView = (postId) => {
             window.currentViewingPostId = postId;
             const post = window.posts.find(p => p.id === postId);
             if(!post) return;
             const author = window.users.find(u => u.id === post.authorId);
             
             const overlayContent = document.getElementById('injected-post');
             const tagsHTML = marked.parse(post.content.replace(/#(\w+)/g, '<span class="hashtag">#$1</span>'));
             const dateStr = post.timestamp?.toDate ? post.timestamp.toDate().toLocaleTimeString() : '';

             overlayContent.innerHTML = `
                <div class="flex gap-4 items-center mb-6">
                    <img src="${author.avatar}" class="w-12 h-12 rounded-full border border-gray-200 cursor-pointer" onclick="showProfile('${author.id}')">
                    <div>
                        <h3 class="font-bold text-[#1f1f1f] text-[16px]">${author.name}</h3>
                        <div class="text-xs text-[#667085] font-medium">${dateStr}</div>
                    </div>
                </div>
                <div class="text-[#1f1f1f] text-[16px] leading-relaxed">${tagsHTML}</div>
            `;
            
            // Listen to comments
            const q = query(collection(db, "posts", postId, "comments"), orderBy("timestamp", "asc"));
            if(commentsUnsubscribe) commentsUnsubscribe();
            commentsUnsubscribe = onSnapshot(q, (snap) => {
                const comments = snap.docs.map(d => d.data());
                renderCommentsInModal(comments);
            });

            document.getElementById('post-view-overlay').classList.remove('hidden');
            lucide.createIcons();
        };

        window.renderCommentsInModal = (comments) => {
             const containerDesktop = document.getElementById('comments-list-desktop');
             const containerMobile = document.getElementById('comments-list-mobile');
             let html = '';
             comments.forEach(c => {
                 const cAuthor = window.users.find(u => u.id === c.authorId) || {name: 'User', avatar:''};
                 html += `
                    <div class="flex gap-3 p-5 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <img src="${cAuthor.avatar}" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-100 shrink-0">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-sm text-gray-900">${cAuthor.name}</span>
                            </div>
                            <p class="text-[14px] text-gray-800 leading-relaxed">${c.content}</p>
                        </div>
                    </div>
                 `;
             });
             containerDesktop.innerHTML = html;
             containerMobile.innerHTML = html;
        };
        
        window.closePostView = () => {
            document.getElementById('post-view-overlay').classList.add('hidden');
            window.currentViewingPostId = null;
            if(commentsUnsubscribe) commentsUnsubscribe();
        };

    </script>
    <script>
        // Existing utility functions (UI only) maintained below
        let currentContext = "", currentMedia = null, currentMediaType = null;
        let classifier, mediaVisionLog = "", isWebSearchActive = false, isIdeaMode = false;
        let stopGeneration = false; 
        let abortController = null;
        let isPlusMenuOpen = false;
        let isModelMenuOpen = false;
        let currentEventCover = null;
        let editingPostId = null;

        function setupClassifier() { if(typeof ml5 !== 'undefined') classifier = ml5.imageClassifier('MobileNet', () => console.log("MobileNet Ready")); }
        
        // --- View Switching Logic ---
        function switchView(viewName) {
            const views = ['feed', 'events', 'saved', 'profile', 'chat', 'search-results', 'notifications'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });
            const aiPanel = document.getElementById('ai-panel');
            const mainPanel = document.getElementById('main-panel');
            const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
            const desktopNavItems = document.querySelectorAll('.nav-item');

            if (window.innerWidth < 768) {
                if (viewName === 'ai') {
                    mainPanel.classList.add('hidden'); aiPanel.classList.remove('hidden'); aiPanel.classList.add('flex');
                } else {
                    mainPanel.classList.remove('hidden'); aiPanel.classList.add('hidden'); aiPanel.classList.remove('flex');
                }
            } 

            if(viewName !== 'ai' && viewName !== 'network') document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if(viewName === 'chat') { aiPanel.classList.remove('xl:flex'); aiPanel.classList.add('hidden'); } 
            else if (window.innerWidth >= 1280 && viewName !== 'ai') { aiPanel.classList.add('xl:flex'); aiPanel.classList.remove('hidden'); }

            desktopNavItems.forEach(el => el.classList.remove('active'));
            mobileNavItems.forEach(el => el.classList.remove('active'));

            if(viewName === 'feed') { document.getElementById('nav-feed').classList.add('active'); mobileNavItems[0].classList.add('active'); } 
            else if (viewName === 'network') { showToast("Network features coming soon"); document.getElementById('nav-network').classList.add('active'); mobileNavItems[1].classList.add('active'); document.getElementById('view-feed').classList.remove('hidden'); } 
            else if (viewName === 'chat') { document.getElementById('nav-chat').classList.add('active'); mobileNavItems[3].classList.add('active'); } 
            else if (viewName === 'saved') { document.getElementById('nav-saved').classList.add('active'); renderSaved(); } 
            else if (viewName === 'ai') { mobileNavItems[3].classList.add('active'); }
            
            if(viewName === 'feed') renderFeed();
            lucide.createIcons();
        }

        // --- Notifications UI ---
        function switchNotifTab(tab) {
            // Re-render based on local filtering of global notifications array
            window.activeNotifTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`ntab-${tab}`).classList.add('active');
            renderNotifications();
        }

        function renderNotifications() {
            const container = document.getElementById('notification-list');
            container.innerHTML = "";
            // Use global window.notifications populated by Firestore listener
            const filtered = window.notifications.filter(n => {
                const sender = window.users.find(u => u.id === n.senderId);
                // Simple logic for tab filtering
                return true; 
            });

            if (filtered.length === 0) { container.innerHTML = `<div class="text-center text-xs text-gray-400 py-4">No notifications here</div>`; return; }

            filtered.forEach(n => {
                const sender = window.users.find(u => u.id === n.senderId) || {name: 'Someone', avatar: ''};
                const div = document.createElement('div');
                div.className = "w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors cursor-pointer border border-transparent hover:border-gray-100 bg-white shadow-sm mb-2";
                let icon = "";
                if(n.type === 'like') icon = '<i data-lucide="heart" class="w-3 h-3 text-white"></i>';
                if(n.type === 'comment') icon = '<i data-lucide="message-circle" class="w-3 h-3 text-white"></i>';
                let colorClass = n.type === 'like' ? 'bg-red-500' : 'bg-blue-600';
                div.innerHTML = `
                    <div class="relative"><img src="${sender.avatar}" class="w-10 h-10 rounded-full bg-gray-200"><div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${colorClass} flex items-center justify-center border-2 border-white">${icon}</div></div>
                    <div class="flex-1"><div class="text-sm"><span class="font-bold text-gray-900">${sender.name}</span> <span class="text-gray-600">${n.content}</span></div></div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }
        
        function toggleNotifications() { switchView('notifications'); document.getElementById('notif-badge').classList.add('hidden'); }

        // --- Profile UI ---
        function showProfile(userId) {
            const user = window.users.find(u => u.id === userId);
            const container = document.getElementById('view-profile');
            const isMe = userId === currentUser.id;
            let actionBtn = isMe ? `<button onclick="openEditProfile()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">Edit Profile</button>` 
            : `<button onclick="startChat('${userId}')" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg font-bold text-sm transition-colors">Message</button>`;
            
            const userPosts = window.posts.filter(p => p.authorId === userId);

            container.innerHTML = `
                <div class="h-32 bg-gradient-to-r from-blue-600 to-indigo-600 relative"></div>
                <div class="px-6 relative">
                    <div class="flex justify-between items-end -mt-10 mb-4">
                        <img src="${user.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white">
                        ${actionBtn}
                    </div>
                    <div class="mb-6"><h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">${user.name}</h1><p class="text-gray-600 mt-1">${user.bio}</p></div>
                    <div class="border-t border-gray-100 pt-6"><h3 class="font-bold text-lg mb-4">Posts</h3><div id="profile-posts-container"></div></div>
                </div>
            `;
            switchView('profile');
            const postsContainer = document.getElementById('profile-posts-container');
            if(userPosts.length > 0) userPosts.forEach(p => postsContainer.appendChild(createPostElement(p)));
            else postsContainer.innerHTML = '<div class="text-center py-10 text-gray-400">No posts yet</div>';
            lucide.createIcons();
        }

        // --- Search ---
        function handleSearch(query) {
            if(!query) { switchView('feed'); return; }
            switchView('search-results');
            const view = document.getElementById('view-search-results');
            const term = query.toLowerCase();
            const foundUsers = window.users.filter(u => u.name.toLowerCase().includes(term));
            let html = `<div class="font-bold mb-2">People</div>`;
            if(foundUsers.length) {
                foundUsers.forEach(u => {
                    html += `<div class="flex items-center gap-3 p-3 bg-white rounded-xl mb-2 cursor-pointer hover:shadow-sm" onclick="showProfile('${u.id}')"><img src="${u.avatar}" class="w-10 h-10 rounded-full"><div><div class="font-bold text-sm">${u.name}</div><div class="text-xs text-gray-500">${u.bio}</div></div></div>`;
                });
            } else { html += `<div class="text-gray-400 text-sm mb-4">No people found</div>`; }
            view.innerHTML = html;
        }

        // --- Modals & Helpers ---
        function openEditProfile() { document.getElementById('edit-profile-overlay').classList.remove('pointer-events-none', 'opacity-0'); }
        function closeEditProfile() { document.getElementById('edit-profile-overlay').classList.add('pointer-events-none', 'opacity-0'); }
        function openCreateMenu() { 
            document.getElementById('create-menu-overlay').classList.remove('opacity-0', 'pointer-events-none'); 
            document.getElementById('create-menu-modal').classList.remove('scale-95'); 
        }
        function closeCreateMenu() { document.getElementById('create-menu-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('create-menu-modal').classList.add('scale-95'); }
        function openCompose() { closeCreateMenu(); document.getElementById('compose-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('compose-modal').classList.remove('scale-95'); }
        function closeCompose() { document.getElementById('compose-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('compose-modal').classList.add('scale-95'); }
        function openLightbox(src) { document.getElementById('lightbox-wrapper').innerHTML = `<img src="${src}" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">`; document.getElementById('lightbox').classList.add('active'); document.getElementById('lightbox').classList.remove('pointer-events-none'); document.getElementById('lightbox').classList.remove('opacity-0'); }
        function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); document.getElementById('lightbox').classList.add('pointer-events-none'); document.getElementById('lightbox').classList.add('opacity-0'); }
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast'); const toastMsg = document.getElementById('toast-msg'); const icon = document.getElementById('toast-icon');
            toastMsg.innerText = message;
            if (isError) { toast.style.backgroundColor = '#d93025'; icon.setAttribute('data-lucide', 'alert-circle'); icon.classList.remove('text-[#c4eed0]'); icon.classList.add('text-white'); } 
            else { toast.style.backgroundColor = '#303134'; icon.setAttribute('data-lucide', 'check-circle-2'); icon.classList.add('text-[#c4eed0]'); }
            lucide.createIcons(); toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    window.currentMedia = e.target.result; 
                    const container = document.getElementById('media-preview-container'); container.classList.remove('hidden');
                    const img = document.getElementById('media-preview-img'); img.src = window.currentMedia; img.classList.remove('hidden');
                    showToast("Media Uploaded");
                };
                reader.readAsDataURL(file);
            }
        }
        function removeMedia() { window.currentMedia = null; document.getElementById('media-preview-container').classList.add('hidden'); document.getElementById('media-input').value = ""; }
        function toggleLike(postId) { window.toggleLike(postId); }
        function toggleSave(postId) { 
            if(window.savedPosts.includes(postId)) window.savedPosts = window.savedPosts.filter(id => id !== postId);
            else window.savedPosts.push(postId);
            showToast("Saved status updated");
        }
        
        // --- AI LOGIC (Pollinations) ---
        let conversationHistory = []; const MAX_HISTORY = 10; 
        const models = { standard: { name: "Newton", avatar: "https://i.imghippo.com/files/XEEq5247S.png", system: "You are Newton, an AI tutor. Explain clearly.", greeting: "Hello! I'm Newton. How can I help?" } };
        let activeModel = 'standard';
        let isSwapped = false;
        function toggleNewtonExpand() {
            document.body.classList.toggle('mode-focus');
            const layout = document.getElementById('workspace-layout');
            const icon = document.getElementById('expand-icon');
            isSwapped = !isSwapped;
            if (isSwapped) { layout.classList.add('swapped'); icon.setAttribute('data-lucide', 'minimize-2'); showToast("Focus Mode Active"); } 
            else { layout.classList.remove('swapped'); icon.setAttribute('data-lucide', 'maximize-2'); }
            lucide.createIcons();
        }
        function handleInput(textarea) { textarea.style.height = 'auto'; textarea.style.height = (textarea.scrollHeight) + 'px'; }
        async function addMessage(text, isUser) {
            const h = document.getElementById('chat-history'); 
            const d = document.createElement('div'); 
            d.className = isUser ? 'chat-wrapper flex justify-end fade-in mb-6' : 'chat-wrapper flex flex-col fade-in w-full mb-6';
            if(isUser) {
                d.innerHTML = `<div class="chat-msg-user">${text}</div>`;
                h.appendChild(d);
                conversationHistory.push({ role: 'user', content: text });
            } else {
                d.innerHTML = `<div class="flex items-center gap-4 mb-2"><img src="${models.standard.avatar}" class="w-6 h-6 object-contain"></div><div class="chat-msg-ai"></div>`;
                h.appendChild(d);
                const contentDiv = d.querySelector('.chat-msg-ai');
                conversationHistory.push({ role: 'assistant', content: text });
                const words = text.split(' '); let currentText = "";
                for(let i=0; i<words.length; i++) {
                    currentText += words[i] + " "; contentDiv.innerHTML = marked.parse(currentText); h.scrollTop = h.scrollHeight;
                    await new Promise(resolve => setTimeout(resolve, 15)); 
                }
            }
            if (conversationHistory.length > MAX_HISTORY) conversationHistory = conversationHistory.slice(-MAX_HISTORY);
            h.scrollTop = h.scrollHeight;
        }
        async function sendMessageAction() {
            const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return;
            addMessage(txt, true); inp.value = ""; handleInput(inp); 
            
            const historyStr = conversationHistory.slice(0, -1).map(msg => `${msg.role === 'user' ? 'User' : 'Newton'}: ${msg.content}`).join('\n');
            let q = `${models.standard.system} \n${currentContext ? "Current Context: " + currentContext : ""}\nConversation History:\n${historyStr}\nUser: ${txt}`;
            
            try { 
                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(q)}?model=openai`); 
                const ans = await res.text();
                await addMessage(ans, false); 
            } catch(e) { addMessage("Connection error.", false); }
        }
        function pinPost(pid, author) {
            const p = document.getElementById(pid); const post = window.posts.find(post => post.id === pid); let content = post ? post.content : "Content";
            currentContext = `Context: ${author}'s post. Content: ${content}.`;
            document.getElementById('ai-context-chip').classList.remove('hidden'); document.getElementById('ai-context-text').innerText = `Post by ${author}`;
            if(window.innerWidth < 768) switchView('ai'); else if(!isSwapped) toggleNewtonExpand();
            addMessage(`I'm looking at ${author}'s post.`, false);
        }
        function clearContext() { currentContext = ""; document.getElementById('ai-context-chip').classList.add('hidden'); }
    </script>
</body>
</html>
