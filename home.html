<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EduLink</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --surface: #ffffff; 
            --background: #f9fafb; 
            --primary: #0b57d0;
            --on-surface: #1f1f1f;
            --outline: #eaecf0;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--background);
            color: var(--on-surface);
            overflow: hidden; 
        }

        h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }

        /* No Scrollbars */
        * { scrollbar-width: none; -ms-overflow-style: none; }
        *::-webkit-scrollbar { width: 0px; background: transparent; display: none; }
        
        i[data-lucide], svg { flex-shrink: 0; }

        .fade-in { animation: fadeUp 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        .app-panel {
            background: #ffffff;
            border-radius: 20px;
            border: 1px solid var(--outline);
            height: 100%; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03); 
            transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        @media (max-width: 768px) {
            .app-panel { border-radius: 0 !important; border: none !important; box-shadow: none !important; }
            body { padding: 0 !important; background-color: #fff; }
            #workspace-layout { gap: 0 !important; }
        }

        #main-sidebar { width: 88px; flex-shrink: 0; padding: 24px 12px; transition: width 0.3s ease; }
        @media (min-width: 1024px) { #main-sidebar { width: 260px; padding: 24px 20px; } }

        .nav-item { display: flex; align-items: center; gap: 14px; padding: 12px; color: #667085; font-weight: 500; font-size: 15px; border-radius: 12px; transition: all 0.2s ease; cursor: pointer; text-decoration: none; margin-bottom: 4px; justify-content: center; position: relative; }
        .nav-item:hover { color: #1f1f1f; background-color: #f3f4f6; }
        .nav-item.active { color: #0b57d0; background-color: #eff4ff; font-weight: 600; }
        @media (min-width: 1024px) { .nav-item { justify-content: flex-start; padding: 10px 16px; } }
        
        .sidebar-user { display: flex; align-items: center; gap: 12px; padding: 8px; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; justify-content: center; }
        .sidebar-user:hover { background-color: #f9fafb; }
        @media (min-width: 1024px) { .sidebar-user { justify-content: flex-start; padding: 8px 12px; } }
        
        .create-btn { display: flex; align-items: center; justify-content: flex-start; gap: 12px; background: #1f1f1f; color: white; padding: 12px 20px; border-radius: 12px; font-weight: 500; font-size: 14px; transition: all 0.2s ease; width: 100%; margin-bottom: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); white-space: nowrap; }
        .create-btn:hover { background: #000; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        .post-card { background: white; border-bottom: 1px solid var(--outline); border-radius: 0; transition: background-color 0.2s ease; margin-bottom: 0; box-shadow: none; overflow: visible; }
        .post-card:hover { background-color: #f8fafe; cursor: pointer; }
        .post-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .post-avatar { width: 44px; height: 44px; border-radius: 50%; background-color: #f3f4f6; border: 1px solid #eaecf0; object-fit: cover; }
        .post-author-name { font-weight: 700; font-size: 15px; color: #1f1f1f; line-height: 1.2; }
        .post-author-name:hover { text-decoration: underline; color: #0b57d0; }
        .post-meta { font-size: 12px; color: #667085; margin-top: 3px; font-weight: 500; }
        .post-body { font-size: 15px; line-height: 1.6; color: #374151; margin-bottom: 16px; }
        .post-actions { display: flex; align-items: center; justify-content: space-between; padding-top: 14px; border-top: 1px solid #f2f4f7; }

        .action-btn { display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 10px; color: #667085; font-size: 13px; font-weight: 600; transition: all 0.2s; background: transparent; border: none; cursor: pointer; }
        .action-btn:hover { background-color: #f9fafb; color: #1f1f1f; }
        .action-btn.like:hover { background-color: #fff1f2; color: #e11d48; }
        .action-btn.comment:hover { background-color: #eff6ff; color: #2563eb; }
        .action-btn.bookmark:hover { background-color: #f5f3ff; color: #7c3aed; }
        .action-btn.ai-pin { color: #0b57d0; background-color: #eff6ff; } 
        .action-btn.ai-pin:hover { background-color: #dbeafe; }

        #compose-modal, #create-menu-modal, #event-modal-box, #mentorship-modal-box, #edit-profile-modal { box-shadow: 0 20px 60px rgba(0,0,0,0.15); border: 1px solid #eaecf0; }
        .compose-header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid #f0f0f0; }
        .compose-textarea { width: 100%; min-height: 120px; font-size: 17px; line-height: 1.6; color: #1f1f1f; border: none; outline: none; resize: none; background: transparent; }
        .compose-tools { display: flex; align-items: center; justify-content: space-between; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f0f0f0; }
        .tool-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #444746; transition: background 0.2s; cursor: pointer; }
        .tool-btn:hover { background-color: #f3f4f6; color: #1f1f1f; }

        .create-option-card { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; border-radius: 16px; border: 1px solid #eaecf0; background: #fff; cursor: pointer; transition: all 0.2s; gap: 12px; }
        .create-option-card:hover { border-color: #0b57d0; background: #eff4ff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(11, 87, 208, 0.1); }
        .create-icon-bg { width: 56px; height: 56px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #1f1f1f; margin-bottom: 8px; transition: background 0.2s; }
        .create-option-card:hover .create-icon-bg { background: #d3e3fd; color: #0b57d0; }

        /* AI Input & Panel */
        .gemini-input-wrapper { background-color: #f3f4f6; border-radius: 24px; transition: all 0.3s; border: 1px solid transparent; display: flex; flex-direction: column; min-height: 52px; }
        .gemini-input-wrapper:focus-within { background-color: #ffffff; box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px #e3e3e3; }
        .gemini-input-wrapper.search-active { background-color: #fff; box-shadow: 0 0 20px rgba(11, 87, 208, 0.1), 0 0 0 1.5px #c2e7ff; }
        .gemini-input-wrapper.idea-active { background-color: #fff; box-shadow: 0 0 20px rgba(192, 132, 252, 0.1), 0 0 0 1.5px #e8d5fc; }
        
        .ai-panel { width: 100%; flex-shrink: 0; order: 2; }
        @media (min-width: 1280px) { .ai-panel { width: 440px; } }
        #workspace-layout.swapped #main-panel { display: none !important; }
        .swapped .ai-panel { flex: 1; width: 100% !important; max-width: none; order: 1; border: 2px solid #a8c7fa; box-shadow: 0 12px 40px rgba(11, 87, 208, 0.1); }
        
        .plus-menu, .model-menu, .post-options-menu { position: absolute; background: white; border: 1px solid #eaecf0; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); z-index: 50; opacity: 0; pointer-events: none; transition: all 0.2s; padding: 6px; transform: scale(0.95); }
        .plus-menu.active, .model-menu.active, .post-options-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .menu-item, .post-option-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: #1f1f1f; font-size: 14px; font-weight: 500; }
        .menu-item:hover, .post-option-item:hover { background: #f9fafb; }
        .menu-item.active-tool { color: #0b57d0; background: #eff4ff; font-weight: 600; }
        
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: #f2f2f2; padding: 14px 28px; border-radius: 48px; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Chat & AI Bubbles */
        .chat-sidebar-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; margin: 2px 8px; border-radius: 8px; cursor: pointer; color: #37352f; transition: background 0.1s; font-size: 14px; font-weight: 500; }
        .chat-sidebar-item:hover { background: #efefef; }
        .chat-sidebar-item.active { background: #e0e0e0; color: #1f1f1f; font-weight: 600; }
        
        .chat-bubble-me { background: #0b57d0; color: white; padding: 10px 16px; border-radius: 18px 18px 2px 18px; font-size: 15px; max-width: 75%; align-self: flex-end; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); line-height: 1.5; }
        .chat-bubble-them { background: #f0f2f5; color: #1f1f1f; padding: 10px 16px; border-radius: 18px 18px 18px 2px; font-size: 15px; max-width: 75%; align-self: flex-start; margin-bottom: 8px; line-height: 1.5; }
        
        .chat-msg-user { background: #f0f4f8; color: #1f1f1f; padding: 12px 16px; border-radius: 12px; font-size: 15px; margin-bottom: 8px; display: inline-block; max-width: 90%; margin-left: auto; }
        .chat-msg-ai { color: #1f1f1f; font-size: 15px; line-height: 1.6; }

        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; flex: 1; gap: 4px; color: #98a2b3; transition: all 0.2s; cursor: pointer; position: relative; }
        .mobile-nav-item.active { color: #0b57d0; }
        .red-dot { position: absolute; top: 10px; right: 20px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; display: none; }
        .red-dot.show { display: block; }
        .sidebar-red-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; position: absolute; top: 8px; right: 10px; display: none; }
        .sidebar-red-dot.show { display: block; }
        
        .mention { color: #2563eb; font-weight: 600; cursor: pointer; }
        .mention:hover { text-decoration: underline; }
        
        /* Nested Comments */
        .comment-thread { position: relative; }
        .nested-reply { margin-left: 48px; position: relative; }
        .nested-reply::before { content: ""; position: absolute; left: -24px; top: -20px; width: 16px; height: 40px; border-left: 2px solid #e5e7eb; border-bottom: 2px solid #e5e7eb; border-bottom-left-radius: 12px; }

        /* Google Panel */
        .google-panel { background: white; padding: 16px; border-radius: 16px; border: 1px solid #eaecf0; margin-bottom: 12px; }
        .search-summary-title { font-weight: bold; color: #1f1f1f; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .search-grid { display: grid; gap: 12px; margin-top: 12px; }
        .search-card { border: 1px solid #f0f0f0; border-radius: 12px; padding: 12px; transition: background 0.2s; }
        .search-card:hover { background: #f9fafb; }
        .search-header { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #667085; margin-bottom: 4px; }
        .search-favicon { width: 16px; height: 16px; border-radius: 4px; }
        .search-title { font-weight: 600; color: #1f5fcd; display: block; margin-bottom: 4px; }
        .search-snippet { font-size: 13px; color: #4b5563; line-height: 1.4; }

    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.560.0",
    "marked": "https://esm.sh/marked@^17.0.1"
  }
}
</script>
</head>

<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]" onclick="hidePostMenu()">

    <div id="global-post-menu" class="post-options-menu"></div>

    <!-- POST VIEW OVERLAY (Comments) -->
    <div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-end md:items-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closePostView()"></div>
        <div class="bg-white w-full md:w-[1000px] h-[95vh] md:h-[85vh] md:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col md:flex-row transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
             <div class="w-full md:w-[60%] flex flex-col h-full bg-white md:border-r border-gray-100 relative">
                 <div class="h-16 border-b border-gray-100 flex items-center justify-between px-6 shrink-0 bg-white z-10 sticky top-0">
                    <button onclick="closePostView()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down" class="w-6 h-6"></i></button>
                    <span class="font-bold text-lg text-[#1f1f1f] hidden md:block">Post</span>
                    <span class="font-bold text-lg text-[#1f1f1f] md:hidden">Details</span>
                    <button class="icon-btn hover:bg-gray-100"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                 </div>
                 <div id="post-view-scroll" class="flex-1 overflow-y-auto p-0 scroll-smooth">
                    <div id="injected-post" class="p-6 md:p-8"></div>
                    <!-- Mobile Comments -->
                    <div class="md:hidden border-t border-gray-100">
                        <div class="p-4 bg-gray-50/50">
                            <h4 class="text-sm font-bold text-gray-800 mb-4">Comments</h4>
                            <div id="comments-list-mobile"></div>
                        </div>
                    </div>
                 </div>
                 <div class="md:hidden border-t border-gray-100 p-3 bg-white shrink-0 sticky bottom-0 z-20">
                     <div class="flex gap-3 items-center">
                        <img src="" id="comment-input-avatar-mobile" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200">
                        <div class="flex-1 relative">
                            <input id="comment-input-mobile" type="text" class="w-full bg-gray-100 rounded-full px-4 py-2 text-sm text-gray-800 outline-none" placeholder="Add a comment...">
                        </div>
                        <button onclick="submitComment('mobile')" class="text-[#0b57d0] font-bold text-sm">Post</button>
                     </div>
                 </div>
             </div>
             <!-- Desktop Comments Panel -->
             <div class="hidden md:flex w-[40%] flex-col h-full bg-[#fff]">
                 <div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white">
                     <span class="font-bold text-[#1f1f1f]">Comments</span>
                     <button onclick="closePostView()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
                 </div>
                 <div id="comments-list-desktop" class="flex-1 overflow-y-auto p-0 bg-white"></div>
                 <div class="p-4 border-t border-gray-100 bg-white shrink-0">
                    <div class="bg-gray-50 rounded-2xl p-3 border border-gray-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all flex gap-3">
                        <img id="comment-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 shrink-0 mt-1">
                        <div class="flex-1">
                            <textarea id="comment-input-desktop" placeholder="Add a comment..." class="w-full bg-transparent outline-none text-[14px] text-gray-800 placeholder-gray-500 resize-none min-h-[40px] py-1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                            <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200/60">
                                <div class="flex gap-1"></div>
                                <button onclick="submitComment('desktop')" class="bg-[#0b57d0] text-white px-5 py-1.5 rounded-full text-[13px] font-bold hover:bg-blue-700 transition-all shadow-sm">Post</button>
                            </div>
                        </div>
                    </div>
                 </div>
             </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()">
        <button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i data-lucide="x" class="w-8 h-8"></i></button>
        <div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div>
    </div>

    <div id="toast" class="toast">
        <i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span>
    </div>

    <!-- CREATE SELECTION OVERLAY -->
    <div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()">
        <div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2>
                <button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="create-option-card" onclick="openCompose()">
                    <div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Post</span>
                </div>
                <div class="create-option-card" onclick="openEventComposer()">
                    <div class="create-icon-bg"><i data-lucide="calendar-plus" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Event</span>
                </div>
                <div class="create-option-card" onclick="openMentorship()">
                    <div class="create-icon-bg"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
                    <span class="font-bold text-[#1f1f1f]">Mentorship</span>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE OVERLAY -->
    <div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeEditProfile()">
        <div id="edit-profile-modal" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold google-font">Edit Profile</h2>
                <button onclick="closeEditProfile()" class="icon-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex flex-col gap-4">
                <div class="flex flex-col items-center mb-2">
                    <div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()">
                        <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full border-2 border-gray-100 object-cover">
                        <div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="camera" class="text-white w-6 h-6"></i>
                        </div>
                    </div>
                    <input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)">
                    <span class="text-xs text-gray-500 mt-2">Tap to change</span>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Display Name</label>
                    <input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Bio</label>
                    <textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="2"></textarea>
                </div>
                <button onclick="saveProfileChanges()" class="bg-[#0b57d0] text-white py-3 rounded-xl font-bold mt-2 hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- MENTORSHIP MODAL -->
    <div id="mentorship-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="mentorship-modal-box" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative transform scale-95 transition-transform duration-200 flex flex-col items-center text-center">
            <button onclick="closeMentorship()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
            <img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Construction" class="w-24 h-24 mb-4">
            <h3 class="text-xl font-bold text-[#1f1f1f] mb-2 google-font">Under Construction!</h3>
            <p class="text-sm text-[#667085] leading-relaxed">The Mentorship module is currently being built with ❤️. Check back soon for exciting updates!</p>
            <button onclick="closeMentorship()" class="mt-6 bg-[#0b57d0] text-white px-6 py-2.5 rounded-full font-bold text-sm hover:bg-[#0b57d0]/90 transition-all">Got it</button>
        </div>
    </div>

    <!-- EVENT MODAL -->
    <input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
    <div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
        <div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0">
             <div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group">
                <img id="event-cover-preview" class="w-full h-full object-cover">
                <button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
                 <button onclick="document.getElementById('event-cover-input').click()" class="absolute bottom-2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20">
                    Change
                </button>
            </div>
            <button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="p-8 pt-6">
                <div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()">
                    <i data-lucide="image" class="w-4 h-4"></i> Add cover
                </div>
                <input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font">
                <div class="flex flex-col gap-1 mb-6">
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div>
                        <input type="date" id="event-date" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div>
                        <input type="time" id="event-time" class="notion-input">
                    </div>
                    <div class="notion-input-row">
                        <div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div>
                        <input type="text" id="event-location" placeholder="Add location..." class="notion-input">
                    </div>
                </div>
                <textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea>
                <div class="flex justify-end mt-6 pt-4 border-t border-gray-100">
                    <button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button>
                </div>
            </div>
        </div>
    </div>

    <!-- POST COMPOSE OVERLAY -->
    <div id="compose-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCompose()">
        <div id="compose-modal" class="bg-white w-[95%] max-w-[620px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()">
            <div class="compose-header">
                <span class="compose-title" id="compose-title-text">Create Post</span>
                <button onclick="closeCompose()" class="icon-btn hover:bg-[#f0f4f9] w-8 h-8"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="flex gap-3 mb-4 items-center">
                <img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
                <div>
                    <div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div>
                    <div class="relative mt-1">
                        <div class="flex items-center gap-1.5 text-xs bg-gray-100 rounded-md py-1.5 px-3 text-gray-700 font-medium">
                            <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                            <span>Public</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <textarea id="compose-text" placeholder="What do you want to share today?" class="compose-textarea"></textarea>
            
            <div id="media-preview-container" class="hidden media-preview-wrapper group">
                <img id="media-preview-img" src="" class="hidden media-preview-content">
                <video id="media-preview-video" src="" class="hidden media-preview-content" controls></video>
                <button onclick="removeMedia()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1.5 hover:bg-black/80 transition-colors shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="compose-tools">
                <div class="tool-group">
                    <button onclick="document.getElementById('media-input').click()" class="tool-btn" title="Add Media"><i data-lucide="image" class="w-5 h-5"></i></button>
                    <button onclick="insertCodeBlock()" class="tool-btn" title="Add Code"><i data-lucide="code-2" class="w-5 h-5"></i></button>
                </div>
                <button id="btn-publish" onclick="publishPost()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-full font-bold text-[15px] hover:bg-[#0b57d0]/90 transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
            </div>
        </div>
    </div>

    <!-- MAIN SIDEBAR -->
    <aside id="main-sidebar" class="hidden md:flex app-panel">
        <div class="h-12 flex items-center gap-3 mb-6 px-2">
            <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
            <h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
        </div>
        
        <button onclick="openCreateMenu()" class="create-btn hidden lg:flex">
            <i data-lucide="plus" class="w-5 h-5"></i><span>Create</span>
        </button>

        <nav class="flex-1 space-y-1">
            <a href="#" onclick="switchView('feed'); return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i> <span class="hidden lg:block">Home</span></a>
            <a href="#" onclick="switchView('network'); return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i> <span class="hidden lg:block">Network</span></a>
            <a href="#" onclick="switchView('chat'); return false;" id="nav-chat" class="nav-item relative">
                <div class="relative">
                    <i data-lucide="message-circle" class="w-5 h-5"></i>
                    <span id="sidebar-chat-dot" class="sidebar-red-dot" style="top: -2px; right: -2px;"></span>
                </div>
                <span class="hidden lg:block">Chat</span>
            </a>
            <a href="#" onclick="showProfile(currentUser.id); return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i> <span class="hidden lg:block">Profile</span></a>
            <a href="#" onclick="switchView('saved'); return false;" id="nav-saved" class="nav-item"><i data-lucide="bookmark" class="w-5 h-5"></i> <span class="hidden lg:block">Saved</span></a>
        </nav>
        
        <div class="mt-auto pt-4 border-t border-gray-100">
            <div class="sidebar-user group" onclick="showProfile(currentUser.id)">
                <img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
                <div class="hidden lg:block">
                    <div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div>
                    <div class="text-xs text-[#667085]">View Profile</div>
                </div>
            </div>
        </div>
    </aside>

    <div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
        <main id="main-panel" class="flex-1 app-panel min-w-0 relative">
             <header class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 sticky top-0 bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0]">
                <div class="md:hidden flex items-center gap-3">
                     <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
                     <h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
                </div>
                <div class="flex-1 max-w-[600px] relative group hidden md:block">
                    <i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i>
                    <input type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]">
                </div>
                <div class="flex items-center gap-3 pl-4">
                    <button class="icon-btn relative" onclick="toggleNotifications()">
                        <i data-lucide="bell" class="w-6 h-6"></i>
                        <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
                    </button>
                    <img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="showProfile(currentUser.id)">
                </div>
            </header>

            <!-- FEED VIEW -->
            <div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white">
                <div id="feed-container"></div>
            </div>

            <!-- SAVED VIEW -->
            <div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2>
                <div id="saved-container" class="space-y-4 px-4 md:px-0"></div>
            </div>

            <!-- PROFILE VIEW -->
            <div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>

            <!-- NOTIFICATIONS VIEW -->
            <div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Notifications</h2>
                <div id="notification-list" class="space-y-2 px-4 md:px-0 w-full"></div>
            </div>

            <!-- CHAT VIEW -->
            <div id="view-chat" class="flex-1 h-full hidden flex flex-col bg-white">
                <div class="flex h-full">
                    <div class="w-1/4 min-w-[260px] border-r border-gray-100 flex flex-col bg-[#fbfbfa]">
                        <div class="flex items-center justify-between p-4 border-b border-gray-100">
                            <span class="font-medium text-xs text-gray-500 uppercase tracking-wide">Chats</span>
                        </div>
                        <div id="chat-list" class="flex-1 overflow-y-auto pt-2"></div>
                    </div>
                    <div class="flex-1 flex flex-col relative bg-white">
                        <div id="chat-header" class="h-16 border-b border-gray-100 bg-white flex items-center justify-between px-6 font-semibold text-gray-800 text-[15px]">Select a chat</div>
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col"></div>
                        <div id="chat-input-area" class="p-4 bg-white hidden">
                            <form onsubmit="sendChatMessage(event)" class="flex gap-3 items-center border border-gray-200 rounded-xl p-2 px-3 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all">
                                <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent outline-none text-sm text-gray-800 placeholder-gray-400">
                                <button type="submit" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EVENTS VIEW -->
            <div id="view-events" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <div class="flex items-center justify-between mb-6 px-4 md:px-0">
                    <h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2>
                    <button onclick="openEventComposer()" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Event</button>
                </div>
                <div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0"></div>
            </div>
             
            <!-- SEARCH RESULTS VIEW -->
            <div id="view-search-results" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
                <h2 class="text-2xl font-bold mb-4">Search Results</h2>
                <div id="search-results-container" class="space-y-4"></div>
            </div>

        </main>

        <!-- AI PANEL (Newton) -->
        <aside id="ai-panel" class="ai-panel hidden xl:flex app-panel mb-16 md:mb-0">
             <div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20">
                <div class="flex items-center gap-3">
                    <img id="ai-header-logo" src="https://i.imghippo.com/files/XEEq5247S.png" class="w-9 h-9 object-contain">
                    <span id="ai-header-name" class="text-[19px] font-medium text-[#1f1f1f] google-font">Newton</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="resetChat()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="New Chat"><i data-lucide="plus" class="w-5 h-5 text-[#667085]"></i></button>
                    <div class="relative">
                        <button onclick="toggleModelMenu()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]"><i data-lucide="more-vertical" class="w-5 h-5 text-[#667085]"></i></button>
                        <div id="model-menu" class="model-menu">
                            <div class="px-2 py-2 text-xs font-bold text-[#667085] uppercase tracking-wider">Select Model</div>
                            <div onclick="switchModel('standard')" class="menu-item active-item" id="model-btn-standard"><img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-5 h-5 object-contain"> Newton</div>
                            <div onclick="switchModel('friendly')" class="menu-item" id="model-btn-friendly"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-5 h-5 rounded-full bg-indigo-50"> Tutor Chase</div>
                            <div onclick="switchModel('logical')" class="menu-item" id="model-btn-logical"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Adrian" class="w-5 h-5 rounded-full bg-teal-50"> Tutor Adrian</div>
                            <div onclick="switchModel('arun')" class="menu-item" id="model-btn-arun"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Destiny" class="w-5 h-5 rounded-full bg-orange-50"> Arun</div>
                        </div>
                    </div>
                    <button onclick="toggleNewtonExpand()" class="hidden md:flex icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]"><i id="expand-icon" data-lucide="maximize-2" class="w-5 h-5 text-[#667085]"></i></button>
                </div>
            </div>
            <div class="flex-1 overflow-hidden relative bg-white flex flex-col">
                <div id="ai-context-chip" class="hidden mx-6 mt-4 bg-[#eff4ff] border border-[#c2e7ff] rounded-2xl p-3 flex items-center justify-between animate-fade-in slide-in-right">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shrink-0 border border-[#c2e7ff] shadow-sm"><i data-lucide="paperclip" class="w-4 h-4 text-[#0b57d0]"></i></div>
                        <div class="flex flex-col min-w-0"><span class="text-[10px] text-[#444746] font-bold uppercase tracking-wider">Active Context</span><span class="text-[13px] text-[#1f1f1f] truncate font-bold" id="ai-context-text">Post Data</span></div>
                    </div>
                    <button onclick="clearContext()" class="icon-btn w-8 h-8"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-6" id="chat-history">
                    <div class="chat-wrapper flex flex-col w-full mb-6 fade-in">
                        <div class="flex items-center gap-2 mb-2"><img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-6 h-6 object-contain"></div>
                        <div class="chat-msg-ai"><p>Hello! I'm Newton, your personal AI tutor. I'm here to help you learn, solve problems, and explore new ideas together. What are you working on today?</p></div>
                    </div>
                </div>
                
                <div class="p-6 bg-white relative">
                     <div id="plus-menu" class="plus-menu">
                        <div class="menu-item" onclick="document.getElementById('media-input').click(); togglePlusMenu()">
                            <i data-lucide="image"></i> Upload Media
                        </div>
                        <div class="menu-item" onclick="insertCodeSnippetAI(); togglePlusMenu()">
                            <i data-lucide="code-2"></i> Code Snippet
                        </div>
                    </div>

                    <div id="search-container" class="gemini-input-wrapper relative z-20 flex flex-col group">
                        <textarea id="ai-input" rows="1" placeholder="Ask anything..." 
                            class="w-full bg-transparent text-[#1f1f1f] p-4 pl-6 pr-6 outline-none resize-none max-h-48 overflow-y-auto text-[16px] rounded-t-[28px] placeholder-[#98a2b3] border-none focus:ring-0" 
                            oninput="handleInput(this)" 
                            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessageAction(); }"></textarea>
                        
                        <div class="flex items-center justify-between px-3 pb-2 pt-0">
                            <div class="flex items-center gap-1">
                                <button onclick="togglePlusMenu()" class="icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Add Features"><i id="plus-icon" data-lucide="plus-circle" class="w-5 h-5 text-[#667085]"></i></button>
                                <button id="web-search-btn" onclick="toggleWebSearch()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Search the Web"><i data-lucide="globe" class="w-5 h-5 text-[#667085]"></i></button>
                                <button id="menu-idea-validator" onclick="toggleIdeaMode()" class="hidden md:flex icon-btn w-9 h-9 hover:bg-[#e0e2e5]" title="Idea Validator"><i data-lucide="lightbulb" class="w-5 h-5 text-[#667085]"></i></button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="ai-send-btn" onclick="sendMessageAction()" class="bg-[#1e1e1e] text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#333] hover:scale-105 transition-all shadow-sm">
                                    <i data-lucide="arrow-up" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3 flex items-center justify-center gap-2"><span class="text-[10px] font-medium text-[#98a2b3] opacity-60">Newton may display inaccurate info, so double-check its responses.</span></div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Bottom Nav for Mobile -->
    <nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg">
        <div class="mobile-nav-item active" onclick="switchView('feed')"><i data-lucide="home"></i><span class="text-[10px] font-medium">Home</span></div>
        <div class="mobile-nav-item" onclick="switchView('network')"><i data-lucide="users"></i><span class="text-[10px] font-medium">Network</span></div>
        <div class="mobile-nav-item" onclick="openCreateMenu()"><div class="w-10 h-10 bg-[#1f1f1f] rounded-full flex items-center justify-center text-white shadow-md mb-1"><i data-lucide="plus" style="width:20px;height:20px"></i></div></div>
        <div class="mobile-nav-item" onclick="switchView('chat')">
            <div class="relative"><i data-lucide="message-circle"></i><span id="mobile-chat-dot" class="red-dot border-white absolute -top-1 -right-1" style="width:8px;height:8px;border-width:1.5px;"></span></div>
            <span class="text-[10px] font-medium">Chat</span>
        </div>
        <div class="mobile-nav-item" onclick="showProfile(currentUser.id)"><img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200"><span class="text-[10px] font-medium">Profile</span></div>
    </nav>

    <input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, getDocs, doc, onSnapshot, query, orderBy, where, serverTimestamp, updateDoc, arrayUnion, arrayRemove, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- GLOBAL STATE ---
        window.currentUser = null;
        window.users = []; 
        window.posts = [];
        window.notifications = [];
        window.activeChats = new Set();
        window.chats = {};
        window.currentMedia = null;
        window.activeChatUserId = null;
        window.activeModel = 'standard';
        window.currentViewingPostId = null;
        let classifier;
        let isWebSearchActive = false;
        let isIdeaMode = false;
        let isPlusMenuOpen = false;
        let isModelMenuOpen = false;
        let mediaVisionLog = "";
        let currentContext = "";
        let abortController = null;
        let stopGeneration = false;

        const models = {
            standard: { name: "Newton", avatar: "https://i.imghippo.com/files/XEEq5247S.png", system: "You are Newton.", greeting: "Hello! I'm Newton. How can I help?" },
            friendly: { name: "Tutor Chase", avatar: "https://api.dicebear.com/9.x/lorelei/svg?seed=Chase", system: "You are Chase.", greeting: "Hi! I'm Chase!" },
            logical: { name: "Tutor Adrian", avatar: "https://api.dicebear.com/9.x/lorelei/svg?seed=Adrian", system: "You are Adrian.", greeting: "Greetings." },
            arun: { name: "Arun", avatar: "https://api.dicebear.com/9.x/lorelei/svg?seed=Destiny", system: "You are Arun.", greeting: "Let's master this." }
        };

        // --- ICON RELOAD FIX (MutationObserver) ---
        const observer = new MutationObserver(() => { if(window.lucide) window.lucide.createIcons(); });
        observer.observe(document.body, { childList: true, subtree: true });
        
        function refreshIcons() { setTimeout(() => { if(window.lucide) window.lucide.createIcons(); }, 50); }

        // --- INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) await setDoc(userRef, { uid: user.uid, name: user.displayName||user.email.split('@')[0], email: user.email, avatar: user.photoURL||`https://api.dicebear.com/9.x/notionists/svg?seed=${user.uid}`, bio: "New to EduLink", following:[], followers:[], friends:[], savedPosts:[] });
                
                onSnapshot(userRef, (doc) => { window.currentUser = { id: doc.id, ...doc.data() }; updateUserInterface(); });
                listenToUsers(); listenToPosts(); listenToNotifications(); listenToActiveChats();
                
                document.getElementById('nav-feed').classList.add('active');
                refreshIcons();
            } else { window.location.href = "index.html"; }
        });

        function listenToUsers() { onSnapshot(collection(db, "users"), (s) => { window.users = s.docs.map(d => ({id:d.id, ...d.data()})); }); }
        
        function listenToPosts() { 
            onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (s) => { 
                window.posts = s.docs.map(d => ({id:d.id, ...d.data(), timestamp: d.data().timestamp?.toDate ? d.data().timestamp.toDate().getTime() : Date.now()})); 
                if(document.getElementById('view-feed').classList.contains('hidden') === false) renderFeed();
                if(window.currentViewingPostId) renderCommentsInModal(window.currentViewingPostId); 
            }, (error) => {
                console.error("Error fetching posts:", error);
                document.getElementById('feed-container').innerHTML = `<div class="p-8 text-center text-gray-400">Unable to load posts. Check connection.</div>`;
            }); 
        }
        
        function listenToNotifications() {
            if(!auth.currentUser) return;
            onSnapshot(query(collection(db, "notifications"), where("receiverId", "==", auth.currentUser.uid), orderBy("timestamp", "desc")), (s) => {
                window.notifications = s.docs.map(d => ({id:d.id, ...d.data()}));
                const hasUnread = window.notifications.some(n => !n.read);
                const badge = document.getElementById('notif-badge');
                if(hasUnread && badge) badge.classList.remove('hidden'); else if(badge) badge.classList.add('hidden');
                
                const hasUnreadMsg = window.notifications.some(n => n.type === 'message' && !n.read);
                const sidebarDot = document.getElementById('sidebar-chat-dot');
                const mobileDot = document.getElementById('mobile-chat-dot');
                if(hasUnreadMsg) { if(sidebarDot) sidebarDot.classList.add('show'); if(mobileDot) mobileDot.classList.add('show'); } 
                else { if(sidebarDot) sidebarDot.classList.remove('show'); if(mobileDot) mobileDot.classList.remove('show'); }

                if(!document.getElementById('view-notifications').classList.contains('hidden')) renderNotifications();
            });
        }

        // Logic to track only ACTIVE chats
        function listenToActiveChats() {
             const stored = localStorage.getItem('eduLink_activeChats');
             if(stored) window.activeChats = new Set(JSON.parse(stored));
        }

        function updateUserInterface() {
            if(!window.currentUser) return;
            const u = window.currentUser;
            const els = ['sidebar-name','compose-name']; els.forEach(id => { const el=document.getElementById(id); if(el) el.innerText=u.name; });
            const imgs = ['sidebar-avatar','mobile-avatar','header-avatar','compose-avatar','comment-input-avatar','comment-input-avatar-mobile','edit-avatar-preview'];
            imgs.forEach(id => { const el=document.getElementById(id); if(el) el.src=u.avatar; });
            const en=document.getElementById('edit-name'); if(en) en.value=u.name;
            const eb=document.getElementById('edit-bio'); if(eb) eb.value=u.bio;
        }

        // --- UI ---
        window.switchView = function(v) {
            ['feed','events','saved','profile','chat','search-results','notifications'].forEach(id => document.getElementById('view-'+id).classList.add('hidden'));
            const ai = document.getElementById('ai-panel'); const main = document.getElementById('main-panel');
            if(window.innerWidth<768) {
                if(v==='ai') { main.classList.add('hidden'); ai.classList.remove('hidden','xl:flex'); ai.classList.add('flex'); }
                else { main.classList.remove('hidden'); ai.classList.add('hidden'); ai.classList.remove('flex'); }
            } else { if(v==='chat') { ai.classList.add('hidden'); ai.classList.remove('xl:flex'); } else { ai.classList.remove('hidden'); ai.classList.add('xl:flex'); } }
            
            if(v!=='ai') document.getElementById('view-'+v).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el=>el.classList.remove('active'));
            if(v==='feed') document.getElementById('nav-feed').classList.add('active');
            if(v==='chat') document.getElementById('nav-chat').classList.add('active');
            if(v==='saved') { document.getElementById('nav-saved').classList.add('active'); renderSaved(); }
            if(v==='notifications') renderNotifications();
            if(v==='feed') renderFeed();
            if(v==='chat') renderChatList();
            refreshIcons();
        }

        // --- FEED ---
        window.renderFeed = function() {
            const c = document.getElementById('feed-container'); c.innerHTML = "";
            if(!window.posts.length) { c.innerHTML = `<div class="p-10 text-center text-gray-400">No posts yet. Be the first!</div>`; return; }
            window.posts.forEach(p => c.appendChild(createPostElement(p)));
            refreshIcons();
        }

        window.createPostElement = function(post) {
            const author = window.users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '', isOfficial: false };
            const isLiked = post.likes?.includes(window.currentUser.id);
            const isSaved = window.currentUser.savedPosts?.includes(post.id);
            const dateStr = new Date(post.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            const div = document.createElement('article');
            div.className = "post-card group overflow-hidden fade-in";
            div.onclick = () => openPostView(post.id);

            let mediaHTML = "";
            if (post.media) {
                const isVideo = (post.mediaType === 'video') || post.media.includes('video');
                mediaHTML = isVideo 
                ? `<div class="mt-3 rounded-xl overflow-hidden"><video src="${post.media}" class="w-full max-h-[400px]" controls onclick="event.stopPropagation()"></video></div>`
                : `<div class="mt-3 rounded-xl overflow-hidden cursor-pointer" onclick="event.stopPropagation(); openLightbox('${post.media}')"><img src="${post.media}" class="w-full max-h-[400px] object-cover bg-gray-50"></div>`;
            }

            div.innerHTML = `
                <div class="p-4 md:p-5">
                    <div class="post-header">
                        <div class="flex gap-3">
                            <img src="${author.avatar}" class="post-avatar">
                            <div>
                                <div class="flex items-center">
                                    <span class="post-author-name" onclick="event.stopPropagation(); showProfile('${author.id}')">${author.name}</span>
                                    ${author.isOfficial ? '<i data-lucide="badge-check" class="w-4 h-4 text-blue-500 ml-1"></i>' : ''}
                                </div>
                                <div class="post-meta flex items-center">${dateStr}</div>
                            </div>
                        </div>
                        ${author.id === window.currentUser.id ? `<button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event, '${post.id}', '${author.name}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>` : ''}
                    </div>
                    <div class="post-body">${marked.parse(post.content)}</div>
                    ${mediaHTML}
                    <div class="post-actions">
                        <div class="flex items-center gap-1">
                             <button class="action-btn like" onclick="event.stopPropagation(); toggleLike('${post.id}')"><i data-lucide="heart" class="w-5 h-5 ${isLiked ? 'fill-red-500 text-red-500' : ''}"></i> <span class="text-xs font-medium">${post.likes ? post.likes.length : 0}</span></button>
                             <button class="action-btn comment" onclick="event.stopPropagation(); openPostView('${post.id}')"><i data-lucide="message-square" class="w-5 h-5"></i> <span class="text-xs font-medium">${post.comments ? post.comments.length : 0}</span></button>
                        </div>
                        <button class="action-btn bookmark" onclick="event.stopPropagation(); toggleSave('${post.id}')"><i data-lucide="bookmark" class="w-5 h-5 ${isSaved ? 'fill-current text-purple-600' : ''}"></i></button>
                    </div>
                </div>
            `;
            return div;
        }

        // --- COMMENTS (Nested & Blue Mentions) ---
        window.openPostView = function(pid) {
            window.currentViewingPostId = pid;
            const post = window.posts.find(p => p.id === pid);
            if(!post) return;
            const author = window.users.find(u => u.id === post.authorId);
            
            document.getElementById('injected-post').innerHTML = `
                <div class="flex gap-4 items-center mb-6">
                    <img src="${author.avatar}" class="w-12 h-12 rounded-full border border-gray-200">
                    <div><h3 class="font-bold text-[#1f1f1f] text-[16px]">${author.name}</h3><div class="text-xs text-[#667085] font-medium">Post Details</div></div>
                </div>
                <div class="text-[#1f1f1f] text-[16px] leading-relaxed mb-4">${marked.parse(post.content)}</div>
                ${post.media ? `<img src="${post.media}" class="w-full rounded-xl mb-4">` : ''}
            `;
            renderCommentsInModal(pid);
            document.getElementById('post-view-overlay').classList.remove('hidden');
            refreshIcons();
        }

        window.renderCommentsInModal = function(pid) {
            const post = window.posts.find(p => p.id === pid);
            if(!post) return;
            const comments = post.comments || [];
            
            // Separate top-level and replies
            const topLevel = comments.filter(c => !c.parentId);
            
            const renderCommentHTML = (c, isReply = false) => {
                const author = window.users.find(u => u.id === c.authorId) || {name:'Unknown', avatar:''};
                const isLiked = c.likes && c.likes.includes(window.currentUser.id);
                // Highlight mentions in blue
                const contentWithBlueMention = c.content.replace(/(@\w+)/g, '<span class="mention">$1</span>');
                
                const replies = comments.filter(r => r.parentId === c.id);
                const replyHTML = replies.map(r => renderCommentHTML(r, true)).join('');

                return `
                <div class="comment-thread ${isReply ? 'nested-reply' : ''}">
                    <div class="flex gap-3 p-4 ${isReply ? 'pt-2 pb-2' : 'border-b border-gray-50'}">
                        <img src="${author.avatar}" class="w-8 h-8 rounded-full bg-gray-200 shrink-0">
                        <div class="flex-1">
                            <div class="flex items-center gap-2"><span class="font-bold text-sm text-gray-900">${author.name}</span><span class="text-xs text-gray-400">${new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span></div>
                            <div class="text-sm text-gray-800 mt-1">${contentWithBlueMention}</div>
                            <div class="flex gap-4 mt-2">
                                <button onclick="toggleCommentLike('${pid}', '${c.id}')" class="text-xs font-semibold ${isLiked ? 'text-red-500' : 'text-gray-500'} hover:text-red-500">Like ${c.likes?.length ? `(${c.likes.length})` : ''}</button>
                                <button onclick="replyToComment('${author.name}', '${c.id}')" class="text-xs font-semibold text-gray-500 hover:text-blue-500">Reply</button>
                            </div>
                        </div>
                    </div>
                    ${replyHTML}
                </div>`;
            };

            const html = topLevel.map(c => renderCommentHTML(c)).join('');
            document.getElementById('comments-list-desktop').innerHTML = html || '<div class="p-8 text-center text-gray-400">No comments yet.</div>';
            document.getElementById('comments-list-mobile').innerHTML = html || '<div class="p-4 text-center text-gray-400 text-sm">No comments yet.</div>';
        }

        window.toggleCommentLike = async function(pid, cid) {
            const postRef = doc(db, "posts", pid);
            const post = window.posts.find(p => p.id === pid);
            const comments = [...post.comments];
            const idx = comments.findIndex(c => c.id === cid);
            if(idx === -1) return;
            
            const comment = comments[idx];
            if(!comment.likes) comment.likes = [];
            
            if(comment.likes.includes(window.currentUser.id)) {
                comment.likes = comment.likes.filter(id => id !== window.currentUser.id);
            } else {
                comment.likes.push(window.currentUser.id);
            }
            comments[idx] = comment;
            await updateDoc(postRef, { comments: comments });
        }

        let pendingReplyParentId = null;

        window.replyToComment = function(name, parentId) {
            const dInput = document.getElementById('comment-input-desktop');
            const mInput = document.getElementById('comment-input-mobile');
            const val = `@${name} `;
            dInput.value = val; mInput.value = val;
            dInput.focus();
            pendingReplyParentId = parentId;
        }

        window.submitComment = async function(mode) {
            const inputId = mode === 'desktop' ? 'comment-input-desktop' : 'comment-input-mobile';
            const txt = document.getElementById(inputId).value.trim();
            if(!txt || !window.currentViewingPostId) return;
            
            const postRef = doc(db, "posts", window.currentViewingPostId);
            const post = window.posts.find(p => p.id === window.currentViewingPostId);
            
            // Check if user removed the @mention, if so, treat as top level
            if(pendingReplyParentId && !txt.includes('@')) pendingReplyParentId = null;

            const newComment = { 
                id: "c"+Date.now(), 
                authorId: window.currentUser.id, 
                content: txt, 
                timestamp: Date.now(), 
                likes: [],
                parentId: pendingReplyParentId 
            };

            await updateDoc(postRef, { comments: arrayUnion(newComment) });
            if(post.authorId !== window.currentUser.id) sendNotification(post.authorId, 'comment', 'commented on your post', window.currentViewingPostId);
            
            document.getElementById(inputId).value = "";
            pendingReplyParentId = null;
        }

        window.toggleLike = async function(postId) {
            const postRef = doc(db, "posts", postId);
            const post = window.posts.find(p => p.id === postId);
            if(post.likes.includes(window.currentUser.id)) await updateDoc(postRef, { likes: arrayRemove(window.currentUser.id) });
            else { await updateDoc(postRef, { likes: arrayUnion(window.currentUser.id) }); if(post.authorId !== window.currentUser.id) sendNotification(post.authorId, 'like', 'liked your post', postId); }
        }

        // --- CHAT SYSTEM (Only Active Users + Delete) ---
        window.renderChatList = function() {
            const list = document.getElementById('chat-list'); list.innerHTML = "";
            // Filter users present in activeChats set
            const friends = window.users.filter(u => window.activeChats.has(u.id));
            
            if(friends.length === 0) { list.innerHTML = `<div class="p-4 text-xs text-gray-400 text-center">No active chats. Visit a profile to message.</div>`; return; }

            friends.forEach(f => {
                const div = document.createElement('div');
                div.className = "chat-sidebar-item";
                if(window.activeChatUserId === f.id) div.classList.add('active');
                div.onclick = () => startChat(f.id);
                div.innerHTML = `<img src="${f.avatar}" class="w-6 h-6 rounded-full object-cover"><span>${f.name}</span>`;
                list.appendChild(div);
            });
            refreshIcons();
        }

        window.startChat = function(userId) {
            // Add to active set and persist
            window.activeChats.add(userId);
            localStorage.setItem('eduLink_activeChats', JSON.stringify([...window.activeChats]));
            
            window.activeChatUserId = userId;
            switchView('chat');
            const user = window.users.find(u => u.id === userId);
            document.getElementById('chat-header').innerHTML = `
                <div class="flex items-center gap-3"><img src="${user.avatar}" class="w-8 h-8 rounded-full border border-gray-200"><span class="font-semibold text-gray-800">${user.name}</span></div>
                <button onclick="deleteCurrentChat()" class="icon-btn hover:bg-red-50 text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            `;
            document.getElementById('chat-input-area').classList.remove('hidden');
            
            const chatId = [window.currentUser.id, userId].sort().join("_");
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                window.chats[userId] = snapshot.docs.map(d => d.data());
                renderMessages();
            });
            renderChatList();
        }

        window.deleteCurrentChat = function() {
            if(!window.activeChatUserId) return;
            if(confirm("Delete this conversation from your list?")) {
                window.activeChats.delete(window.activeChatUserId);
                localStorage.setItem('eduLink_activeChats', JSON.stringify([...window.activeChats]));
                window.activeChatUserId = null;
                document.getElementById('chat-messages').innerHTML = "";
                document.getElementById('chat-header').innerText = "Select a chat";
                document.getElementById('chat-input-area').classList.add('hidden');
                renderChatList();
                showToast("Chat removed from list");
            }
        }

        // --- PROFILE SYSTEM (Correct Post Filtering) ---
        window.showProfile = function(id) {
            const u = window.users.find(u => u.id === id); 
            if(!u) return; 
            
            // Logic to check if I can edit
            const isMe = id === window.currentUser.id;
            const btn = isMe 
                ? `<button onclick="openEditProfile()" class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg font-bold">Edit Profile</button>`
                : `<button onclick="startChat('${id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">Message</button>`;

            document.getElementById('view-profile').innerHTML = `
                <div class="h-32 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
                <div class="px-6 -mt-10">
                    <div class="flex justify-between items-end mb-4">
                        <img src="${u.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover">
                        ${btn}
                    </div>
                    <h1 class="text-2xl font-bold">${u.name}</h1>
                    <p class="text-gray-600">${u.bio}</p>
                    <div class="border-t mt-6 pt-4">
                        <h3 class="font-bold mb-4">Posts</h3>
                        <div id="profile-posts-container"></div>
                    </div>
                </div>`;
            
            // Filter Posts for Profile
            const userPosts = window.posts.filter(p => p.authorId === id);
            const container = document.getElementById('profile-posts-container');
            if(userPosts.length > 0) userPosts.forEach(p => container.appendChild(createPostElement(p)));
            else container.innerHTML = "<div class='text-gray-400 py-4'>No posts yet.</div>";

            switchView('profile'); 
        };

        // --- OTHER ---
        window.saveProfileChanges = async function() {
            const name = document.getElementById('edit-name').value;
            const bio = document.getElementById('edit-bio').value;
            const fileInput = document.getElementById('edit-avatar-input');
            let avatarUrl = window.currentUser.avatar;
            
            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                const formData = new FormData();
                formData.append('image', file);
                try {
                    const response = await fetch('https://api.imgbb.com/1/upload?key=d28bf3c492ad07b53dc4e3f9ce99b072', { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.success) avatarUrl = data.data.url;
                } catch(e) { console.error(e); showToast("Image upload failed", true); return; }
            }

            await updateDoc(doc(db, "users", auth.currentUser.uid), { name, bio, avatar: avatarUrl });
            closeEditProfile();
            showToast("Profile Updated");
        }

        window.renderMessages = function() {
            const c = document.getElementById('chat-messages'); c.innerHTML = "";
            const msgs = window.chats[window.activeChatUserId] || [];
            if(msgs.length===0) c.innerHTML = `<div class="text-center text-xs text-gray-400 mt-10">Start conversation</div>`;
            msgs.forEach(m => {
                const div = document.createElement('div');
                div.className = m.senderId === window.currentUser.id ? 'chat-bubble-me' : 'chat-bubble-them';
                div.innerText = m.text;
                c.appendChild(div);
            });
            c.scrollTop = c.scrollHeight;
            refreshIcons();
        }

        window.sendChatMessage = async function(e) {
            e.preventDefault();
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if(!text || !window.activeChatUserId) return;
            const chatId = [window.currentUser.id, window.activeChatUserId].sort().join("_");
            await addDoc(collection(db, "chats", chatId, "messages"), { senderId: window.currentUser.id, text, timestamp: serverTimestamp() });
            
            sendNotification(window.activeChatUserId, 'message', 'sent you a message');
            input.value = "";
        }

        async function sendNotification(receiverId, type, content, linkId = null) {
            await addDoc(collection(db, "notifications"), {
                receiverId, senderId: window.currentUser.id, senderName: window.currentUser.name, 
                senderAvatar: window.currentUser.avatar, type, content, linkId, timestamp: serverTimestamp(), read: false
            });
        }

        window.renderNotifications = function() {
            const c = document.getElementById('notification-list'); c.innerHTML = "";
            if(window.notifications.length === 0) { c.innerHTML = `<div class="text-center text-xs text-gray-400 py-4">No notifications</div>`; return; }
            window.notifications.forEach(n => {
                const div = document.createElement('div');
                div.className = "w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-50 transition-colors cursor-pointer border border-transparent hover:border-gray-100 bg-white shadow-sm mb-2";
                let icon = n.type === 'like' ? '<i data-lucide="heart" class="w-3 h-3 text-white"></i>' : '<i data-lucide="message-circle" class="w-3 h-3 text-white"></i>';
                let color = n.type === 'like' ? 'bg-red-500' : 'bg-blue-600';
                div.innerHTML = `<div class="relative"><img src="${n.senderAvatar}" class="w-10 h-10 rounded-full bg-gray-200"><div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${color} flex items-center justify-center border-2 border-white">${icon}</div></div><div class="flex-1"><div class="text-sm"><span class="font-bold text-gray-900">${n.senderName}</span> <span class="text-gray-600">${n.content}</span></div></div>`;
                c.appendChild(div);
            });
            refreshIcons();
        }

        // --- AI LOGIC (Cleaned Up & Tools Restored) ---
        window.switchModel = (m) => { 
            window.activeModel = m; 
            const model = models[m];
            document.getElementById('ai-header-name').innerText = model.name;
            document.getElementById('ai-header-logo').src = model.avatar;
            document.getElementById('model-menu').classList.remove('active');
            window.resetChat();
            showToast(`Switched to ${model.name}`);
        };

        window.resetChat = () => { 
            const model = models[window.activeModel];
            document.getElementById('chat-history').innerHTML = `<div class="chat-wrapper flex flex-col w-full mb-6 fade-in"><div class="flex items-center gap-2 mb-2"><img src="${model.avatar}" class="w-6 h-6 object-contain"></div><div class="chat-msg-ai"><p>${model.greeting}</p></div></div>`;
        };

        window.sendMessageAction = async function() {
            const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return;
            addMessage(txt, true); inp.value = ""; handleInput(inp);
            
            const model = models[window.activeModel];
            const thinkingId = 'thinking-'+Date.now();
            const h = document.getElementById('chat-history');
            h.insertAdjacentHTML('beforeend', `<div id="${thinkingId}" class="flex flex-col mb-6 fade-in"><div class="flex gap-4"><img src="${model.avatar}" class="w-6 h-6 animate-pulse"><span class="text-sm font-medium animate-pulse">Thinking...</span></div></div>`);
            
            let system = model.system;
            // Restore Tools logic
            if(window.isWebSearchActive) system += " You are an AI Search Engine. Return results in HTML structure with class 'google-panel'.";
            if(window.isIdeaMode) system += " You are a Startup Validator. Return results starting with IDEA_ANALYSIS_START.";

            try {
                const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(system + " " + txt)}?model=openai`);
                const ans = await res.text();
                document.getElementById(thinkingId).remove();
                addMessage(ans, false);
            } catch(e) {
                document.getElementById(thinkingId).remove();
                addMessage("I'm having trouble connecting right now.", false);
            }
        }

        window.addMessage = function(text, isUser) {
            const h = document.getElementById('chat-history');
            const d = document.createElement('div');
            d.className = isUser ? 'chat-wrapper flex justify-end fade-in mb-6' : 'chat-wrapper flex flex-col fade-in w-full mb-6';
            if(isUser) {
                d.innerHTML = `<div class="chat-msg-user">${text}</div>`;
            } else {
                const model = models[window.activeModel];
                let content = marked.parse(text);
                // Handle special modes display logic
                if(text.includes('IDEA_ANALYSIS_START')) content = text.replace('IDEA_ANALYSIS_START','');
                d.innerHTML = `<div class="flex items-start gap-3 mb-2"><img src="${model.avatar}" class="w-8 h-8 object-contain"></div><div class="chat-msg-ai">${content}</div>`;
            }
            h.appendChild(d);
            h.scrollTop = h.scrollHeight;
            refreshIcons();
        }

        window.toggleWebSearch = () => {
            window.isWebSearchActive = !window.isWebSearchActive;
            const btn = document.getElementById('web-search-btn');
            const cont = document.getElementById('search-container');
            const inp = document.getElementById('ai-input');
            const menuBtn = document.getElementById('menu-idea-validator');
            
            // Reset other modes
            if(window.isIdeaMode) { window.isIdeaMode = false; menuBtn.classList.remove('active-tool'); cont.classList.remove('idea-active'); }

            if(window.isWebSearchActive) { btn.classList.add('active-tool'); cont.classList.add('search-active'); inp.placeholder = "Search the web..."; showToast("Web Search Active"); }
            else { btn.classList.remove('active-tool'); cont.classList.remove('search-active'); inp.placeholder = "Ask anything..."; }
            refreshIcons();
        }

        window.toggleIdeaMode = () => {
            window.isIdeaMode = !window.isIdeaMode;
            const btn = document.getElementById('menu-idea-validator');
            const cont = document.getElementById('search-container');
            const inp = document.getElementById('ai-input');
            const searchBtn = document.getElementById('web-search-btn');

            // Reset other modes
            if(window.isWebSearchActive) { window.isWebSearchActive = false; searchBtn.classList.remove('active-tool'); cont.classList.remove('search-active'); }

            if(window.isIdeaMode) { btn.classList.add('active-tool'); cont.classList.add('idea-active'); inp.placeholder = "What is your startup idea?"; showToast("Idea Validator Active"); }
            else { btn.classList.remove('active-tool'); cont.classList.remove('idea-active'); inp.placeholder = "Ask anything..."; }
            refreshIcons();
        }

        // --- GLOBAL HELPERS ---
        window.handleSearch = (q) => {
            if(!q) { switchView('feed'); return; }
            const c = document.getElementById('search-results-container'); c.innerHTML = "";
            const lq = q.toLowerCase();
            const u = window.users.filter(u=>u.name.toLowerCase().includes(lq));
            if(u.length) { c.innerHTML+=`<h3 class="font-bold mb-2">People</h3>`; u.forEach(x=>{const d=document.createElement('div');d.className="flex gap-3 p-3 bg-white rounded-xl shadow-sm cursor-pointer";d.onclick=()=>showProfile(x.id);d.innerHTML=`<img src="${x.avatar}" class="w-10 h-10 rounded-full"><div><div class="font-bold">${x.name}</div><div class="text-xs">${x.bio}</div></div>`;c.appendChild(d);}); }
            const p = window.posts.filter(p=>p.content.toLowerCase().includes(lq));
            if(p.length) { const d=document.createElement('div');d.innerHTML=`<h3 class="font-bold mb-2 mt-4">Posts</h3>`; p.forEach(x=>d.appendChild(createPostElement(x))); c.appendChild(d); }
            switchView('search-results');
        };
        window.openEventComposer = () => { document.getElementById('event-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.remove('scale-95'); };
        window.closeEventComposer = () => { document.getElementById('event-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('event-modal-box').classList.add('scale-95'); };
        window.handleFileSelect = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (ev) => { window.currentMedia = ev.target.result; document.getElementById('media-preview-img').src = ev.target.result; document.getElementById('media-preview-container').classList.remove('hidden'); }; r.readAsDataURL(f); } };
        window.removeMedia = () => { window.currentMedia = null; document.getElementById('media-preview-container').classList.add('hidden'); document.getElementById('media-input').value = ""; };
        window.openCompose = () => { document.getElementById('compose-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('compose-modal').classList.remove('scale-95'); };
        window.closeCompose = () => { document.getElementById('compose-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('compose-modal').classList.add('scale-95'); };
        window.closePostView = () => { document.getElementById('post-view-overlay').classList.add('hidden'); window.currentViewingPostId = null; };
        window.showToast = (msg, err) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); refreshIcons(); }
        window.toggleNotifications = () => switchView('notifications');
        window.openCreateMenu = () => { document.getElementById('create-menu-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('create-menu-modal').classList.remove('scale-95'); };
        window.closeCreateMenu = () => { document.getElementById('create-menu-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('create-menu-modal').classList.add('scale-95'); };
        window.handleEditAvatarSelect = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (ev) => document.getElementById('edit-avatar-preview').src = ev.target.result; r.readAsDataURL(f); }};
        window.openEditProfile = () => { document.getElementById('edit-profile-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('edit-profile-modal').classList.remove('scale-95'); };
        window.closeEditProfile = () => { document.getElementById('edit-profile-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('edit-profile-modal').classList.add('scale-95'); };
        window.openMentorship = () => { document.getElementById('mentorship-overlay').classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('mentorship-modal-box').classList.remove('scale-95'); };
        window.closeMentorship = () => { document.getElementById('mentorship-overlay').classList.add('opacity-0', 'pointer-events-none'); document.getElementById('mentorship-modal-box').classList.add('scale-95'); };
        window.showPostOptions = (e, pid, name) => { e.stopPropagation(); const m = document.getElementById('global-post-menu'); const rect = e.currentTarget.getBoundingClientRect(); m.style.top = (rect.bottom + window.scrollY) + 'px'; m.style.left = (rect.right - 160) + 'px'; m.classList.add('active'); m.innerHTML = `<div class="post-option-item danger" onclick="deletePost('${pid}')">Delete</div>`; };
        window.hidePostMenu = () => document.getElementById('global-post-menu').classList.remove('active');
        window.deletePost = async (pid) => { if(confirm("Delete?")) { await deleteDoc(doc(db, "posts", pid)); showToast("Deleted"); } };
        window.openLightbox = (src) => { document.getElementById('lightbox-wrapper').innerHTML = `<img src="${src}" class="max-w-full max-h-[90vh]">`; document.getElementById('lightbox').classList.remove('opacity-0', 'pointer-events-none'); };
        window.closeLightbox = () => { document.getElementById('lightbox').classList.add('opacity-0', 'pointer-events-none'); };
        window.toggleNewtonExpand = () => { document.body.classList.toggle('mode-focus'); document.getElementById('workspace-layout').classList.toggle('swapped'); };
        window.handleInput = (el) => { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; };
        window.togglePlusMenu = () => document.getElementById('plus-menu').classList.toggle('active');
        window.toggleModelMenu = () => document.getElementById('model-menu').classList.toggle('active');
        window.insertCodeSnippetAI = () => document.getElementById('ai-input').value += " ```js\n\n``` ";
        window.pinPost = (pid) => { document.getElementById('ai-context-chip').classList.remove('hidden'); document.getElementById('ai-context-text').innerText = "Post Context"; };
        window.clearContext = () => document.getElementById('ai-context-chip').classList.add('hidden');

    </script>
</body>
</html>
