<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EduLink</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">

<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

:root {
--surface: #ffffff;
--background: #f9fafb;
--on-surface: #1f1f1f;
--text-secondary: #667085;
--outline: #eaecf0;
--hover-bg: #f3f4f6;
--primary: #0b57d0;
}

body {
font-family: 'Inter', sans-serif;
background-color: var(--background);
color: var(--on-surface);
overflow: hidden;
}

h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }

/* No Scrollbars */
* { scrollbar-width: none; -ms-overflow-style: none; }
*::-webkit-scrollbar { width: 0px; background: transparent; display: none; }

/* Prevent icon squishing globally */
i[data-lucide], svg { flex-shrink: 0; }

.fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

/* --- UNIFIED PANEL STYLES --- */
.app-panel {
background: var(--surface);
border-radius: 20px;
border: 1px solid var(--outline);
height: 100%;
display: flex;
flex-direction: column;
overflow: hidden;
box-shadow: 0 1px 2px rgba(0,0,0,0.03);
transition: all 0.3s cubic-bezier(0.2, 0, 0, 1);
}

/* Mobile Adjustments */
@media (max-width: 768px) {
.app-panel {
border-radius: 0 !important;
border: none !important;
box-shadow: none !important;
}
body {
padding: 0 !important;
}
#workspace-layout {
gap: 0 !important;
}
}

/* --- SIDEBAR --- */
#main-sidebar {
width: 88px;
flex-shrink: 0;
padding: 24px 12px;
transition: width 0.3s cubic-bezier(0.2, 0, 0, 1), padding 0.3s ease;
}

@media (min-width: 1024px) {
#main-sidebar {
width: 260px;
padding: 24px 20px;
}
}

.nav-item {
display: flex; align-items: center; gap: 14px;
padding: 12px;
color: var(--text-secondary);
font-weight: 500;
font-size: 15px;
border-radius: 12px;
transition: all 0.2s ease;
cursor: pointer;
text-decoration: none;
margin-bottom: 4px;
justify-content: center;
position: relative;
}

.nav-item:hover {
color: var(--on-surface);
background-color: var(--hover-bg);
}

.nav-item.active {
color: var(--primary);
background-color: #eff4ff;
font-weight: 600;
}

/* Notification Dot Logic */
.nav-dot {
    position: absolute;
    top: 10px;
    right: 28px;
    width: 9px;
    height: 9px;
    background-color: #ef4444;
    border-radius: 50%;
    border: 2px solid var(--surface);
    display: none;
    z-index: 10;
}

@media (min-width: 1024px) {
    .nav-item {
        justify-content: flex-start;
        padding: 10px 16px;
    }
    .nav-dot {
        top: 8px;
        right: auto;
        left: 28px;
    }
}

.sidebar-user {
display: flex; align-items: center; gap: 12px;
padding: 8px;
border-radius: 12px;
cursor: pointer;
transition: background-color 0.2s;
justify-content: center;
}
.sidebar-user:hover { background-color: var(--hover-bg); }

@media (min-width: 1024px) {
.sidebar-user { justify-content: flex-start; padding: 8px 12px; }
}

.create-btn {
display: flex;
align-items: center;
justify-content: flex-start;
gap: 12px;
background: #1f1f1f;
color: white;
padding: 12px 20px;
border-radius: 12px;
font-weight: 500;
font-size: 14px;
transition: all 0.2s ease;
width: 100%;
margin-bottom: 24px;
box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
line-height: 1;
min-width: 0;
white-space: nowrap;
}

.create-btn:hover {
background: #000;
transform: translateY(-1px);
box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
}

/* --- POST CARD DESIGN --- */
.post-card {
background: var(--surface);
border-bottom: 1px solid var(--outline);
border-radius: 0;
transition: background-color 0.2s ease;
margin-bottom: 0;
box-shadow: none;
overflow: visible;
}
.post-card:hover {
background-color: var(--hover-bg);
cursor: pointer;
transform: none;
}

.post-header {
display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px;
}

.post-avatar-container {
position: relative;
}
.post-avatar {
width: 44px; height: 44px;
border-radius: 50%;
background-color: var(--hover-bg);
border: 1px solid var(--outline);
object-fit: cover;
}

.post-author-name {
font-weight: 700; font-size: 15px; color: var(--on-surface);
line-height: 1.2;
}
.post-author-name:hover { text-decoration: underline; color: var(--primary); }

.post-meta {
font-size: 12px; color: var(--text-secondary); margin-top: 3px; font-weight: 500;
}

.post-body {
font-size: 15px; line-height: 1.6; color: var(--on-surface);
margin-bottom: 16px;
}

.post-actions {
display: flex; align-items: center; justify-content: space-between;
padding-top: 14px; border-top: 1px solid var(--outline);
}

.action-btn {
display: flex; align-items: center; gap: 6px;
padding: 8px 12px; border-radius: 10px;
color: var(--text-secondary); font-size: 13px; font-weight: 600;
transition: all 0.2s;
background: transparent; border: none; cursor: pointer;
}
.action-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }
.action-btn.like:hover { background-color: #fef2f2; color: #ef4444; } 
.action-btn.comment:hover { background-color: #eff6ff; color: #2563eb; }
.action-btn.bookmark:hover { background-color: #fefce8; color: #eab308; }
.action-btn.share-btn { color: var(--primary); background-color: #eff6ff; }
.action-btn.share-btn:hover { background-color: #dbeafe; }

/* --- COMPOSE & CREATE MENUS --- */
#compose-modal, #create-menu-modal, #event-modal-box, #mentorship-modal-box, #edit-profile-modal, #ban-modal-box {
box-shadow: 0 20px 60px rgba(0,0,0,0.15);
border: 1px solid var(--outline);
}

.compose-header {
display: flex; align-items: center; justify-content: space-between;
padding-bottom: 16px; margin-bottom: 16px; border-bottom: 1px solid var(--outline);
}
.compose-title { font-size: 18px; font-weight: 600; color: var(--on-surface); font-family: 'Google Sans', sans-serif; }

.compose-textarea {
width: 100%; min-height: 120px;
font-size: 17px; line-height: 1.6;
color: var(--on-surface); placeholder-color: var(--text-secondary);
border: none; outline: none; resize: none;
background: transparent;
}

.compose-tools {
display: flex; align-items: center; justify-content: space-between;
margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--outline);
}

.tool-btn {
width: 40px; height: 40px; border-radius: 50%;
display: flex; align-items: center; justify-content: center;
color: var(--text-secondary); transition: background 0.2s; cursor: pointer;
}
.tool-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }

/* Create Menu Specific */
.create-option-card {
display: flex; flex-direction: column; align-items: center; justify-content: center;
padding: 24px; border-radius: 16px; border: 1px solid var(--outline);
background: var(--surface); cursor: pointer; transition: all 0.2s;
gap: 12px;
}
.create-option-card:hover {
border-color: var(--primary); background: #eff4ff; transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(11, 87, 208, 0.1);
}

.create-icon-bg {
width: 56px; height: 56px; border-radius: 50%; background: var(--hover-bg);
display: flex; align-items: center; justify-content: center; color: var(--on-surface);
margin-bottom: 8px; transition: background 0.2s;
}
.create-option-card:hover .create-icon-bg { background: #d3e3fd; color: #0b57d0; }

/* Notion Style Event Form */
.notion-input-row {
display: flex; align-items: center; gap: 12px; padding: 8px 0;
color: var(--on-surface); font-size: 15px;
}
.notion-label {
width: 100px; color: var(--text-secondary); display: flex; align-items: center; gap: 6px; font-size: 14px;
}
.notion-input {
flex: 1; border: none; outline: none; background: transparent;
font-size: 15px; color: var(--on-surface);
}
.notion-input:focus { background: var(--hover-bg); border-radius: 4px; }

.media-preview-wrapper {
margin-top: 12px; position: relative;
width: 100%; background: var(--hover-bg); border-radius: 12px;
overflow: hidden; border: 1px solid var(--outline);
display: flex; justify-content: center; align-items: center;
}
.media-preview-content {
width: 100%; height: auto; max-height: 400px;
object-fit: contain; display: block;
}

/* --- OTHER --- */
.gemini-input-wrapper {
background-color: var(--hover-bg);
border-radius: 24px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
border: 1px solid transparent;
display: flex; flex-direction: column;
min-height: 52px;
}
.gemini-input-wrapper:focus-within {
background-color: var(--surface);
box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px var(--outline);
}

.gemini-code-container { border-radius: 12px; overflow: hidden; margin: 20px 0; border: 1px solid #444746; background: #1e1f20; }
.gemini-code-header { background: #2f3033; padding: 10px 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444746; font-size: 13px; color: #e3e3e3; font-family: 'Google Sans', sans-serif; font-weight: 500; }
.gemini-code-btn { display: flex; align-items: center; gap: 6px; color: #e3e3e3; cursor: pointer; padding: 6px 10px; border-radius: 6px; transition: background 0.2s; }
.gemini-code-btn:hover { background: rgba(255,255,255,0.1); }
pre { background: #1e1f20; padding: 20px; color: #e3e3e3; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 0.95rem; margin: 0; }

.feed-panel { flex: 1; min-width: 0; order: 1; }
.ai-panel { width: 100%; flex-shrink: 0; order: 2; }
@media (min-width: 1280px) { .ai-panel { width: 440px; } }

/* Focus Mode Logic */
#workspace-layout.swapped { justify-content: flex-start; padding-left: 0; gap: 20px; }
#workspace-layout.swapped #main-panel { display: none !important; }
.swapped .ai-panel {
flex: 1;
width: 100% !important;
max-width: none;
order: 1;
border: 2px solid #a8c7fa;
box-shadow: 0 12px 40px rgba(11, 87, 208, 0.1);
}

.plus-menu {
position: absolute; bottom: 140px; left: 20px; background: var(--surface); border: 1px solid var(--outline);
border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 200px; display: flex; flex-direction: column; padding: 6px;
z-index: 50; transform-origin: bottom left; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.plus-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

.model-menu {
position: absolute; top: 50px; right: 60px; background: var(--surface); border: 1px solid var(--outline);
border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 220px; display: flex; flex-direction: column; padding: 6px;
z-index: 100; transform-origin: top right; transform: scale(0.95); opacity: 0; pointer-events: none; transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
}
.model-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }

.menu-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--on-surface); font-size: 14px; font-weight: 500; transition: background 0.1s; }
.menu-item:hover { background: var(--hover-bg); }
.menu-item.active-item { background: #eff4ff; color: #0b57d0; }

.backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(2px); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
.backdrop.active { opacity: 1; pointer-events: auto; }

.toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: #f2f2f2; padding: 14px 28px; border-radius: 48px; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

.icon-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background 0.2s; cursor: pointer; color: var(--text-secondary); }
.icon-btn:hover { background-color: var(--hover-bg); color: var(--on-surface); }

.hashtag { color: var(--primary); font-weight: 500; cursor: pointer; padding: 2px 6px; border-radius: 6px; }
.hashtag:hover { background: #eff4ff; }

/* --- POST MENU STYLES --- */
.post-options-menu {
position: absolute;
background: var(--surface);
border: 1px solid var(--outline);
border-radius: 12px;
box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.1);
width: 160px;
z-index: 50;
opacity: 0;
pointer-events: none;
transform: scale(0.95);
transition: all 0.1s ease-out;
padding: 6px;
}
.post-options-menu.active {
opacity: 1;
pointer-events: auto;
transform: scale(1);
}
.post-option-item {
display: flex;
align-items: center;
gap: 10px;
padding: 10px;
font-size: 14px;
color: var(--on-surface);
cursor: pointer;
border-radius: 8px;
transition: background 0.1s;
font-weight: 500;
}
.post-option-item:hover {
background: var(--hover-bg);
color: var(--on-surface);
}
.post-option-item.danger {
color: #d92d20;
}
.post-option-item.danger:hover {
background: #fef2f2;
color: #b91c1c;
}

/* --- NOTIFICATION TABS --- */
.tab-group {
display: inline-flex;
background: var(--hover-bg);
padding: 4px;
border-radius: 12px;
width: auto;
border: 1px solid var(--outline);
}
.tab-btn {
padding: 8px 20px;
font-size: 13px;
font-weight: 600;
color: var(--text-secondary);
border-radius: 8px;
transition: all 0.2s ease;
cursor: pointer;
background: transparent;
}
.tab-btn:hover {
color: var(--on-surface);
}
.tab-btn.active {
background: var(--surface);
color: var(--primary);
box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

/* --- CHAT STYLES --- */
.chat-sidebar-item {
display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 8px 12px;
margin: 2px 8px; border-radius: 6px; cursor: pointer; color: var(--text-secondary);
transition: background 0.1s; font-size: 14px; font-weight: 500;
}
.chat-sidebar-item:hover { background: var(--hover-bg); }
.chat-sidebar-item.active { background: #e0e0e0; color: #1f1f1f; }

.chat-bubble-me {
    background: var(--primary);
    color: white;
    padding: 10px 16px;
    border-radius: 18px 18px 4px 18px;
    font-size: 15px;
    max-width: 75%;
    align-self: flex-end;
    margin-bottom: 2px;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.chat-bubble-them {
    background: var(--hover-bg);
    color: var(--on-surface);
    padding: 10px 16px;
    border-radius: 18px 18px 18px 4px;
    font-size: 15px;
    max-width: 75%;
    align-self: flex-start;
    margin-bottom: 2px;
    position: relative;
}

.chat-date-divider { text-align: center; font-size: 11px; color: var(--text-secondary); margin: 16px 0; font-weight: 500; }

.chat-row {
    position: relative;
    display: flex;
    width: 100%;
    margin-bottom: 6px;
    padding: 2px 0;
    align-items: center;
}
.chat-row.me { justify-content: flex-end; }
.chat-row.them { justify-content: flex-start; }

.chat-actions-menu {
    background: var(--surface);
    border: 1px solid var(--outline);
    border-radius: 20px;
    padding: 4px;
    display: flex; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    z-index: 10;
    gap: 4px;
    opacity: 0; 
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
    margin: 0 8px;
}

.chat-row:hover .chat-actions-menu { 
    opacity: 1; 
    pointer-events: auto;
}

.chat-row.me .chat-actions-menu { order: 1; }
.chat-row.me .chat-bubble-me { order: 2; }

.chat-row.them .chat-bubble-them { order: 1; }
.chat-row.them .chat-actions-menu { order: 2; }

.chat-action-btn {
    padding: 6px;
    border-radius: 50%;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
}
.chat-action-btn:hover { background: var(--hover-bg); color: var(--on-surface); }

.reply-preview-bar {
    background: var(--hover-bg);
    border-left: 3px solid var(--primary);
    padding: 8px 12px;
    margin-bottom: 8px;
    border-radius: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--on-surface);
}

.quoted-reply {
    font-size: 11px;
    color: inherit;
    opacity: 0.8;
    border-left: 2px solid rgba(255,255,255,0.5);
    padding-left: 6px;
    margin-bottom: 4px;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.chat-bubble-them .quoted-reply { border-color: rgba(0,0,0,0.2); }

.mobile-nav-item {
display: flex; flex-direction: column; align-items: center; justify-content: center;
height: 100%; flex: 1; gap: 4px; color: #98a2b3; transition: all 0.2s; cursor: pointer;
position: relative;
}
.mobile-nav-item.active { color: var(--primary); }
.mobile-nav-item i { width: 24px; height: 24px; transition: transform 0.2s; }
.mobile-nav-item.active i { transform: scale(1.1); stroke-width: 2.5px; }

.scale-in { animation: scaleIn 0.3s cubic-bezier(0.2, 0, 0, 1) forwards; }
@keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

/* LOADER OVERLAY */
#app-loader {
    position: fixed; inset: 0; background: var(--surface); z-index: 9999;
    display: flex; justify-content: center; align-items: center;
    transition: opacity 0.5s ease;
}
.loader-spinner {
    width: 40px; height: 40px; border: 4px solid var(--hover-bg);
    border-top: 4px solid var(--primary); border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.profile-banner-container {
    height: 140px;
    width: 100%;
    background-color: #e5e7eb;
    position: relative;
    overflow: hidden;
}
.profile-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.banner-edit-container {
    height: 140px;
    width: 100%;
    background: #e5e7eb;
    position: relative;
    overflow: hidden;
    cursor: grab;
    border-radius: 12px;
}
.banner-edit-container:active { cursor: grabbing; }
.banner-edit-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
    -webkit-user-drag: none;
}

.toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    background-color: #e5e7eb;
    border-radius: 9999px;
    transition: background-color 0.2s;
    cursor: pointer;
}
.toggle-switch.active { background-color: #0b57d0; }
.toggle-dot {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 20px;
    height: 20px;
    background-color: white;
    border-radius: 50%;
    transition: transform 0.2s;
}
.toggle-switch.active .toggle-dot { transform: translateX(20px); }

#banned-overlay {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(5px);
}
.ban-option-btn {
    flex: 1;
    padding: 12px;
    border: 1px solid var(--outline);
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}
.ban-option-btn.active {
    background: #eff6ff;
    border-color: var(--primary);
    color: var(--primary);
}

</style>
</head>
<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]" onclick="hidePostMenu()">

<!-- LOADING OVERLAY -->
<div id="app-loader"><div class="loader-spinner"></div></div>

<!-- CUSTOM ALERT MODAL -->
<div id="custom-alert" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
    <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-[90%] transform scale-95 transition-transform duration-200" id="custom-alert-box">
        <h3 class="text-xl font-bold text-[#1f1f1f] mb-3" id="alert-title">Confirm</h3>
        <p class="text-gray-600 mb-8 text-[15px] leading-relaxed" id="alert-msg">Are you sure?</p>
        <div class="flex justify-end gap-3">
            <button class="px-5 py-2.5 text-gray-700 font-bold text-sm hover:bg-gray-100 rounded-xl transition-colors" onclick="closeAlert(false)">Cancel</button>
            <button class="px-5 py-2.5 bg-[#0b57d0] text-white font-bold text-sm rounded-xl hover:bg-blue-700 transition-colors shadow-sm" id="alert-confirm-btn">Confirm</button>
        </div>
    </div>
</div>

<!-- BAN MODAL FOR ADMIN -->
<div id="ban-modal-overlay" class="fixed inset-0 z-[75] flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeBanModal()">
    <div id="ban-modal-box" class="bg-white w-[90%] max-w-[450px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-blue-600 flex items-center gap-2"><i data-lucide="gavel" class="w-5 h-5"></i> Ban User</h2>
            <button onclick="closeBanModal()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Ban Type</label>
            <div class="flex gap-3">
                <div id="ban-type-perm" class="ban-option-btn active" onclick="toggleBanType('perm')">Permanent</div>
                <div id="ban-type-temp" class="ban-option-btn" onclick="toggleBanType('temp')">Temporary</div>
            </div>
        </div>
        <div id="ban-duration-area" class="mb-4 hidden">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Ban Until</label>
            <input type="datetime-local" id="ban-date-input" class="w-full border border-gray-300 rounded-xl px-4 py-2 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-200 transition-all text-sm">
        </div>
        <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Reason (Visible to User)</label>
            <textarea id="ban-reason" class="w-full border border-gray-300 rounded-xl p-3 outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-200 text-sm resize-none h-24" placeholder="e.g. Violation of community guidelines..."></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-2 border-t border-gray-100">
             <button class="px-5 py-2.5 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-xl transition-colors" onclick="closeBanModal()">Cancel</button>
             <button class="px-5 py-2.5 bg-white border border-blue-600 text-blue-600 font-bold text-sm rounded-xl hover:bg-blue-50 transition-colors shadow-sm flex items-center gap-2" onclick="confirmBan()">
                 <i data-lucide="ban" class="w-4 h-4"></i> Confirm Ban
             </button>
        </div>
    </div>
</div>

<!-- BANNED USER OVERLAY -->
<div id="banned-overlay" class="fixed inset-0 z-[10000] hidden flex flex-col items-center justify-center p-6 text-center">
    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center text-red-600 mb-6 animate-bounce">
        <i data-lucide="shield-alert" class="w-10 h-10"></i>
    </div>
    <h1 class="text-3xl font-bold text-gray-900 mb-2 google-font">Account Suspended</h1>
    <p class="text-gray-600 max-w-md mb-6 leading-relaxed">Your account has been suspended by an administrator due to a violation of our community standards.</p>
    <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 max-w-sm w-full mb-8 text-left">
        <div class="mb-4">
            <span class="text-xs font-bold text-gray-500 uppercase block mb-1">Reason</span>
            <p id="banned-reason-text" class="text-gray-900 font-medium">No reason provided.</p>
        </div>
        <div>
            <span class="text-xs font-bold text-gray-500 uppercase block mb-1">Duration</span>
            <p id="banned-duration-text" class="text-gray-900 font-medium">Permanent</p>
        </div>
    </div>
    <button onclick="doLogout()" class="px-8 py-3 bg-gray-900 text-white font-bold rounded-full hover:bg-black transition-transform hover:scale-105 shadow-lg">Sign Out</button>
</div>

<!-- Post Options Global Menu -->
<div id="global-post-menu" class="post-options-menu"></div>

<!-- Post View Overlay -->
<div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-end md:items-center">
<div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closePostView()"></div>
<div class="bg-white w-full md:w-[1000px] h-[95vh] md:h-[85vh] md:rounded-2xl rounded-t-2xl shadow-2xl relative flex flex-col md:flex-row transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
<div class="w-full md:w-[60%] flex flex-col h-full bg-white md:border-r border-gray-100 relative">
<div class="h-16 border-b border-gray-100 flex items-center justify-between px-6 shrink-0 bg-white z-10 sticky top-0">
<button onclick="closePostView()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down" class="w-6 h-6"></i></button>
<span class="font-bold text-lg text-[#1f1f1f] hidden md:block">Post</span>
<span class="font-bold text-lg text-[#1f1f1f] md:hidden">Details</span>
<button class="icon-btn hover:bg-gray-100"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
</div>
<div id="post-view-scroll" class="flex-1 overflow-y-auto p-0 scroll-smooth">
<div id="injected-post" class="p-6 md:p-8"></div>
<div id="mobile-comments-section" class="md:hidden border-t border-gray-100">
<div class="p-4 bg-gray-50/50">
<h4 class="text-sm font-bold text-gray-800 mb-4">Comments</h4>
<div id="comments-list-mobile"></div>
</div>
</div>
</div>
<div class="md:hidden border-t border-gray-100 p-3 bg-white shrink-0 sticky bottom-0 z-20 comment-input-area">
<div class="flex gap-3 items-center">
<img id="comment-input-avatar-mobile" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200">
<div class="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm text-gray-500">Add a comment...</div>
<button class="text-[#0b57d0] font-bold text-sm">Post</button>
</div>
</div>
<div class="md:hidden border-t border-gray-100 p-3 bg-white shrink-0 sticky bottom-0 z-20 comments-disabled-msg hidden">
    <div class="text-center text-sm text-gray-500 italic py-2">Comments are turned off</div>
</div>
</div>
<div class="hidden md:flex w-[40%] flex-col h-full bg-[#fff]">
<div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white">
<span class="font-bold text-[#1f1f1f]">Comments</span>
<button onclick="closePostView()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="comments-list-desktop" class="flex-1 overflow-y-auto p-0 bg-white"></div>
<div class="p-4 border-t border-gray-100 bg-white shrink-0 comment-input-area">
<div class="bg-gray-50 rounded-2xl p-3 border border-gray-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all flex gap-3">
<img id="comment-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 shrink-0 mt-1">
<div class="flex-1">
<textarea id="comment-input-desktop" placeholder="Add a comment..." class="w-full bg-transparent outline-none text-[14px] text-gray-800 placeholder-gray-500 resize-none min-h-[40px] py-1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
<div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200/60">
<div class="flex gap-1">
<button class="p-2 rounded-full hover:bg-gray-200 text-gray-500 transition-colors"><i data-lucide="smile" class="w-4 h-4"></i></button>
</div>
<button onclick="submitCommentDesktop()" class="bg-[#0b57d0] text-white px-5 py-1.5 rounded-full text-[13px] font-bold hover:bg-blue-700 transition-all shadow-sm hover:shadow active:scale-95">Post</button>
</div>
</div>
</div>
</div>
<div class="p-6 border-t border-gray-100 bg-white shrink-0 text-center text-gray-500 italic comments-disabled-msg hidden">
    Comments are turned off for this post.
</div>
</div>
</div>
</div>

<div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()">
<button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i data-lucide="x" class="w-8 h-8"></i></button>
<div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div>
</div>

<!-- REPLY THREAD OVERLAY -->
<div id="reply-thread-overlay" class="fixed inset-0 z-[65] hidden flex justify-center items-end md:items-center">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeReplyThread()"></div>
    <div class="bg-white w-full md:w-[500px] h-[85vh] md:h-[70vh] md:rounded-2xl rounded-t-2xl shadow-2xl border border-[#eaecf0] relative flex flex-col transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in">
        <div class="h-14 border-b border-gray-100 flex items-center justify-between px-4 shrink-0 bg-white z-10">
            <h3 class="font-bold text-lg text-[#1f1f1f]">Thread</h3>
            <button onclick="closeReplyThread()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="reply-thread-content" class="flex-1 overflow-y-auto bg-white"></div>
        <div class="p-3 border-t border-gray-100 bg-white shrink-0">
             <div class="flex gap-3 items-center bg-gray-50 rounded-2xl p-2 border border-gray-200 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all">
                <img id="reply-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 shrink-0">
                <input id="reply-thread-input" type="text" placeholder="Reply to this thread..." class="flex-1 bg-transparent outline-none text-sm text-gray-800 placeholder-gray-500">
                <button onclick="submitReplyInThread()" class="text-blue-600 font-bold text-sm px-3 hover:bg-blue-50 rounded-full py-1 transition-colors">Send</button>
             </div>
        </div>
    </div>
</div>

<div id="toast" class="toast">
<i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span>
</div>

<!-- LIKES OVERLAY -->
<div id="likes-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeLikes()">
    <div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl border border-[#eaecf0] flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center p-4 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-900">Likes</h3>
            <button onclick="closeLikes()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div id="settings-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeSettings()">
    <div class="bg-white w-[90%] max-w-[450px] rounded-[24px] shadow-2xl p-6 relative transform transition-all scale-100 overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-[#1f1f1f] google-font">Settings</h2>
            <button onclick="closeSettings()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto space-y-6">
            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Privacy</h3>
                <div class="flex items-center justify-between py-2">
                    <div>
                        <div class="font-medium text-gray-900">Private Account</div>
                        <div class="text-xs text-gray-500">Only followers can see your posts</div>
                    </div>
                    <div id="toggle-privacy" class="toggle-switch" onclick="togglePrivacy()">
                        <div class="toggle-dot"></div>
                    </div>
                </div>
            </div>

            <div id="admin-mode-toggle-container" class="hidden">
                 <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Admin</h3>
                <div class="flex items-center justify-between py-2">
                    <div>
                        <div class="font-medium text-gray-900">Admin Mode</div>
                        <div class="text-xs text-gray-500">Show admin controls on profiles</div>
                    </div>
                    <div id="toggle-admin-mode" class="toggle-switch" onclick="toggleAdminMode()">
                        <div class="toggle-dot"></div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">About</h3>
                <a href="pre.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="crown" class="w-4 h-4"></i></div>
                        <span class="font-medium text-gray-900">Premium</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i>
                </a>
                <a href="p.html" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i data-lucide="shield" class="w-4 h-4"></i></div>
                        <span class="font-medium text-gray-900">Privacy Policy</span>
                    </div>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i>
                </a>
            </div>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-100">
            <button onclick="doLogout()" class="w-full py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-colors">Log Out</button>
        </div>
    </div>
</div>

<!-- USER LIST MODAL -->
<div id="user-list-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeUserList()">
<div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl flex flex-col max-h-[80vh] overflow-hidden transform transition-all scale-100" onclick="event.stopPropagation()">
<div class="flex justify-between items-center p-4 border-b border-gray-100">
<h3 class="text-lg font-bold text-gray-900" id="user-list-title">Users</h3>
<button onclick="closeUserList()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div id="user-list-content" class="flex-1 overflow-y-auto p-2"></div>
</div>
</div>

<!-- CREATE SELECTION OVERLAY -->
<div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()">
<div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2>
<button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div class="create-option-card" onclick="openCompose()">
<div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Post</span>
</div>
<div class="create-option-card" onclick="openEventComposer()">
<div class="create-icon-bg"><i data-lucide="calendar-plus" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Event</span>
</div>
<div class="create-option-card" onclick="openMentorship()">
<div class="create-icon-bg"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
<span class="font-bold text-[#1f1f1f]">Mentorship</span>
</div>
</div>
</div>
</div>

<!-- EDIT PROFILE OVERLAY -->
<div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeEditProfile()">
<div id="edit-profile-modal" class="bg-white w-[95%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
<div class="flex justify-between items-center mb-6">
<h2 class="text-xl font-bold google-font">Edit Profile</h2>
<button onclick="closeEditProfile()" class="icon-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="flex flex-col gap-5">
<div class="flex flex-col items-center mb-2">
<div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()">
<img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-2 border-gray-100 object-cover">
<div class="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
<i data-lucide="camera" class="text-white w-6 h-6"></i>
</div>
</div>
<input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)">
<input type="file" id="edit-banner-input" class="hidden" accept="image/*" onchange="handleEditBannerSelect(event)">
</div>
<div>
    <label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Banner Image</label>
    <div id="banner-edit-area" class="banner-edit-container group mb-2 h-36" onclick="document.getElementById('edit-banner-input').click()">
        <img id="edit-banner-preview" src="" class="banner-edit-img" style="object-position: center 50%">
        <div class="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <i data-lucide="upload" class="text-white w-6 h-6"></i>
        </div>
    </div>
    <div class="text-[10px] text-gray-400 mb-1 flex justify-between"><span>Click banner to change, drag to reposition</span> <span id="banner-pos-hint">50%</span></div>
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase">Display Name</label>
<input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900">
</div>
<div>
    <label class="text-xs font-bold text-gray-500 uppercase">Email</label>
    <input type="text" id="edit-email" class="w-full border-b border-gray-200 py-2 outline-none text-gray-500 bg-transparent select-text" disabled>
</div>
<div>
<label class="text-xs font-bold text-gray-500 uppercase">Bio</label>
<textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="3"></textarea>
</div>
<button id="save-profile-btn" onclick="saveProfileChanges()" class="bg-[#0b57d0] text-white py-3 rounded-xl font-bold mt-2 hover:bg-blue-700 transition-all">Save Changes</button>
</div>
</div>
</div>

<!-- MENTORSHIP MODAL -->
<div id="mentorship-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
<div id="mentorship-modal-box" class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative transform scale-95 transition-transform duration-200 flex flex-col items-center text-center">
<button onclick="closeMentorship()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button>
<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Construction" class="w-24 h-24 mb-4">
<h3 class="text-xl font-bold text-[#1f1f1f] mb-2 google-font">Under Construction!</h3>
<p class="text-sm text-[#667085] leading-relaxed">The Mentorship module is currently being built with ❤️. Check back soon for exciting updates!</p>
<button onclick="closeMentorship()" class="mt-6 bg-[#0b57d0] text-white px-6 py-2.5 rounded-full font-bold text-sm hover:bg-[#0b57d0]/90 transition-all">Got it</button>
</div>
</div>

<!-- EVENT MODAL -->
<input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
<div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200">
<div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0">
<div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group">
<img id="event-cover-preview" class="w-full h-full object-cover">
<button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20">
<i data-lucide="x" class="w-4 h-4"></i>
</button>
<button onclick="document.getElementById('event-cover-input').click()" class="absolute bottom-2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20">
Change
</button>
</div>
<button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
<div class="p-8 pt-6">
<div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()">
<i data-lucide="image" class="w-4 h-4"></i> Add cover
</div>
<input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font">
<div class="flex flex-col gap-1 mb-6">
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div>
<input type="date" id="event-date" class="notion-input">
</div>
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div>
<input type="time" id="event-time" class="notion-input">
</div>
<div class="notion-input-row">
<div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div>
<input type="text" id="event-location" placeholder="Add location..." class="notion-input">
</div>
</div>
<textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea>
<div class="flex justify-end mt-6 pt-4 border-t border-gray-100">
<button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button>
</div>
</div>
</div>
</div>

<!-- POST COMPOSE OVERLAY -->
<div id="compose-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCompose()">
<div id="compose-modal" class="bg-white w-[95%] max-w-[620px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200 flex flex-col" onclick="event.stopPropagation()">
<div class="compose-header">
<span class="compose-title" id="compose-title-text">Create Post</span>
<button onclick="closeCompose()" class="icon-btn hover:bg-[#f0f4f9] w-8 h-8"><i data-lucide="x" class="w-5 h-5"></i></button>
</div>
<div class="flex gap-3 mb-4 items-center">
        <img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
        <div><div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div></div>
    </div>
    <textarea id="compose-text" placeholder="What do you want to share today?" class="compose-textarea"></textarea>
    <div id="media-preview-container" class="hidden media-preview-wrapper group">
        <img id="media-preview-img" src="" class="hidden media-preview-content">
        <video id="media-preview-video" src="" class="hidden media-preview-content" controls></video>
        <button onclick="removeMedia()" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1.5 hover:bg-black/80 transition-colors shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>
    <div class="compose-tools">
        <div class="tool-group">
            <button onclick="document.getElementById('media-input').click()" class="tool-btn" title="Upload Media"><i data-lucide="image" class="w-5 h-5"></i></button>
            <button onclick="promptForImageLink()" class="tool-btn" title="Image Link"><i data-lucide="link" class="w-5 h-5"></i></button>
            <button onclick="insertCodeBlock()" class="tool-btn" title="Add Code"><i data-lucide="code-2" class="w-5 h-5"></i></button>
        </div>
        <button id="btn-publish" onclick="publishPost()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-full font-bold text-[15px] hover:bg-[#0b57d0]/90 transition-all shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed">Post</button>
    </div>
    <div class="border-t border-gray-100 pt-3 mt-2">
        <div class="flex items-center justify-between cursor-pointer p-1" onclick="toggleComposeSettings()">
            <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Post Settings</span>
            <i data-lucide="chevron-down" id="compose-settings-arrow" class="w-4 h-4 text-gray-400 transition-transform"></i>
        </div>
        <div id="compose-settings-area" class="hidden mt-3 space-y-3 px-1">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="lock" class="w-4 h-4"></i> Private (Followers Only)</div>
                <input type="checkbox" id="post-setting-privacy" class="accent-blue-600 w-4 h-4 cursor-pointer">
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="heart" class="w-4 h-4"></i> Show Like Count</div>
                <input type="checkbox" id="post-setting-likes" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-square" class="w-4 h-4"></i> Show Comment Count</div>
                <input type="checkbox" id="post-setting-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="users" class="w-4 h-4"></i> Allow viewers to see who liked</div>
                <input type="checkbox" id="post-setting-like-view" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-circle" class="w-4 h-4"></i> Allow comments</div>
                <input type="checkbox" id="post-setting-allow-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked>
            </div>
        </div>
    </div>
</div>
</div>

<!-- MAIN SIDEBAR -->
<aside id="main-sidebar" class="hidden md:flex app-panel">
<div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')">
<img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
<h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
</div>
<button onclick="openCreateMenu()" class="create-btn hidden lg:flex">
    <i data-lucide="plus" class="w-5 h-5"></i><span>Create</span>
</button>
<nav class="flex-1 space-y-1" id="desktop-nav-items">
    <a href="#" onclick="switchView('feed'); return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i> <span class="hidden lg:block">Home</span></a>
    <a href="#" onclick="switchView('explore'); return false;" id="nav-explore" class="nav-item"><i data-lucide="compass" class="w-5 h-5"></i> <span class="hidden lg:block">Explore</span></a>
    <a href="#" onclick="switchView('network'); return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i> <span class="hidden lg:block">Network</span></a>
    <a href="#" onclick="switchView('chat'); return false;" id="nav-chat" class="nav-item relative"><i data-lucide="message-circle" class="w-5 h-5"></i> <span class="hidden lg:block">Chat</span><span id="chat-dot" class="nav-dot"></span></a>
    <a href="workspace.html" class="nav-item"><i data-lucide="briefcase" class="w-5 h-5"></i> <span class="hidden lg:block">Workspace</span></a>
    <a href="#" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null); return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i> <span class="hidden lg:block">Profile</span></a>
    <div class="pt-6 pb-2 px-3 hidden lg:block"><span class="text-xs font-bold text-[#98a2b3] uppercase tracking-wider">Library</span></div>
    <a href="#" onclick="switchView('saved'); return false;" id="nav-saved" class="nav-item"><i data-lucide="bookmark" class="w-5 h-5"></i> <span class="hidden lg:block">Saved</span></a>
</nav>
<div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2">
    <div class="sidebar-user group cursor-pointer" onclick="openSettings()">
        <div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></div>
        <div class="hidden lg:block"><div class="text-sm font-bold text-[#1f1f1f]">Settings</div></div>
    </div>
    <div class="sidebar-user group" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)">
        <img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
        <div class="hidden lg:block">
            <div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div>
            <div class="text-xs text-[#667085]">View Profile</div>
        </div>
    </div>
</div>
</aside>

<div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
<main id="main-panel" class="flex-1 app-panel min-w-0 relative">
<header class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 sticky top-0 bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0]">
<div class="md:hidden flex items-center gap-3 cursor-pointer" onclick="switchView('feed')">
<img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
<h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
</div>
<div class="flex-1 max-w-[600px] relative group hidden md:block">
<i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i>
<input type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]">
</div>
<div class="flex items-center gap-3 pl-4">
<button class="icon-btn relative" onclick="toggleNotifications()">
<i data-lucide="bell" class="w-6 h-6"></i>
<span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white hidden"></span>
</button>
<img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)">
</div>
</header>
    <div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white">
        <div id="feed-container"></div>
    </div>
    <div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
        <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2>
        <div id="saved-container" class="space-y-4"></div>
    </div>
    <div id="view-network" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
        <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">My Network</h2>
        <div class="tab-group mb-6 mx-4 md:mx-0">
            <button onclick="switchNetworkTab('people')" id="net-tab-people" class="tab-btn active">People</button>
            <button onclick="switchNetworkTab('posts')" id="net-tab-posts" class="tab-btn">Posts</button>
        </div>
        <div id="network-content"></div>
    </div>
    <div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>
    <div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
        <div class="flex justify-between items-center mb-6 px-4 md:px-0">
            <h2 class="text-2xl font-bold">Notifications</h2>
            <button onclick="clearAllNotifications()" class="text-xs text-red-500 font-bold hover:underline">Clear All</button>
        </div>
        <div class="tab-group mb-6 mx-4 md:mx-0">
            <button onclick="switchNotifTab('friends')" id="ntab-friends" class="tab-btn active">Following</button>
            <button onclick="switchNotifTab('others')" id="ntab-others" class="tab-btn">Others</button>
            <button onclick="switchNotifTab('official')" id="ntab-official" class="tab-btn">Official</button>
        </div>
        <div id="notification-list" class="space-y-2 px-4 md:px-0 w-full"></div>
    </div>
    <div id="view-chat" class="flex-1 h-full hidden flex flex-col bg-white overflow-hidden">
        <div class="flex h-full">
            <div class="w-1/4 min-w-[260px] border-r border-gray-100 flex flex-col bg-[#fbfbfa]">
                <div class="p-4 border-b border-gray-100">
                    <div class="font-medium text-xs text-gray-500 uppercase tracking-wide mb-2">Direct Messages</div>
                    <input type="text" placeholder="Search chats..." onkeyup="renderChatList(this.value)" class="w-full bg-white border border-gray-200 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-500 transition-colors">
                </div>
                <div id="chat-list" class="flex-1 overflow-y-auto pt-2"></div>
            </div>
            <div class="flex-1 flex flex-col relative bg-white h-full overflow-hidden">
                <div id="chat-header" class="h-16 border-b border-gray-100 bg-white flex items-center justify-between px-6 font-semibold text-gray-800 text-[15px] shrink-0">Select a friend to chat</div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-6 flex flex-col"></div>
                <div id="chat-input-area" class="p-4 bg-white hidden flex-col shrink-0 border-t border-gray-100">
                    <div id="reply-preview" class="hidden reply-preview-bar">
                        <span id="reply-to-text">Replying to...</span>
                        <button onclick="cancelReply()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    <form onsubmit="sendChatMessage(event)" class="flex gap-3 items-center border border-gray-200 rounded-xl p-2 px-3 focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300 transition-all">
                        <input id="message-input" type="text" placeholder="Type a message..." class="flex-1 bg-transparent outline-none text-sm text-gray-800 placeholder-gray-400">
                        <button type="submit" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition-colors"><i data-lucide="send" class="w-4 h-4"></i></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div id="view-announcements" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-white">
        <h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Broadcast Announcement</h2>
        <div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm max-w-2xl mb-8">
            <label class="block text-sm font-bold text-gray-700 mb-2">Message to All Users</label>
            <textarea id="announcement-text" class="w-full h-32 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 mb-4" placeholder="Type your official announcement here..."></textarea>
            <button onclick="sendAnnouncement()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Send Broadcast</button>
        </div>
    </div>
    <div id="view-explore" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff]">
        <h2 class="text-2xl font-bold mb-4 px-4 md:px-0">Explore</h2>
        <div class="md:hidden px-4 mb-4">
             <div class="relative group">
                <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-[#667085]"></i>
                <input type="text" placeholder="Search users & posts..." oninput="handleSearch(this.value)" class="w-full bg-white rounded-full py-3 pl-12 pr-4 outline-none border border-gray-200 focus:border-blue-500 transition-all text-sm">
            </div>
        </div>
        <div id="explore-results" class="px-4 md:px-0 space-y-6"></div>
    </div>
</main>

<aside id="ai-panel" class="ai-panel hidden xl:flex app-panel mb-16 md:mb-0">
     <div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20">
        <div class="flex items-center gap-3">
            <img id="ai-header-logo" src="https://i.imghippo.com/files/XEEq5247S.png" class="w-9 h-9 object-contain">
            <span id="ai-header-name" class="text-[19px] font-medium text-[#1f1f1f] google-font">Newton</span>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="resetChat()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="New Chat"><i data-lucide="plus" class="w-5 h-5 text-[#667085]"></i></button>
            <div class="relative">
                <button onclick="toggleModelMenu()" class="icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="More Options"><i data-lucide="more-vertical" class="w-5 h-5 text-[#667085]"></i></button>
                <div id="model-menu" class="model-menu">
                    <div class="px-2 py-2 text-xs font-bold text-[#667085] uppercase tracking-wider">Select Model</div>
                    <div onclick="switchModel('standard')" class="menu-item active-item" id="model-btn-standard"><img src="https://i.imghippo.com/files/XEEq5247S.png" class="w-5 h-5 object-contain"> Newton</div>
                    <div onclick="switchModel('friendly')" class="menu-item" id="model-btn-friendly"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-5 h-5 rounded-full bg-indigo-50"> Tutor Chase</div>
                </div>
            </div>
            <button onclick="toggleNewtonExpand()" class="hidden md:flex icon-btn bg-[#f9fafb] hover:bg-[#eaecf0] border border-[#eaecf0]" title="Swap & Expand View"><i id="expand-icon" data-lucide="maximize-2" class="w-5 h-5 text-[#667085]"></i></button>
        </div>
    </div>
    <div class="flex-1 overflow-hidden relative bg-white flex flex-col">
        <div id="chat-history" class="flex-1 overflow-y-auto p-6"></div>
        <div class="p-6 bg-white relative">
            <div id="plus-menu" class="plus-menu">
                <div class="menu-item" onclick="document.getElementById('media-input').click(); togglePlusMenu()"><i data-lucide="image"></i> Upload Media</div>
            </div>
            <div id="search-container" class="gemini-input-wrapper relative z-20 flex flex-col group">
                <textarea id="ai-input" rows="1" placeholder="Ask anything..." class="w-full bg-transparent text-[#1f1f1f] p-4 pl-6 pr-6 outline-none resize-none max-h-48 overflow-y-auto text-[16px] rounded-t-[28px] placeholder-[#98a2b3] border-none focus:ring-0" oninput="handleInput(this)" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessageAction(); }"></textarea>
                <div class="flex items-center justify-between px-3 pb-2 pt-0">
                    <div class="flex items-center gap-1">
                        <button onclick="togglePlusMenu()" class="icon-btn w-9 h-9 hover:bg-[#e0e2e5]"><i id="plus-icon" data-lucide="plus-circle" class="w-5 h-5 text-[#667085]"></i></button>
                    </div>
                    <button id="ai-send-btn" onclick="sendMessageAction()" class="bg-[#1e1e1e] text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-[#333] hover:scale-105 transition-all shadow-sm"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </div>
</aside>
</div>

<nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 px-2 shadow-lg">
<div class="mobile-nav-item active" onclick="switchView('feed')"><i data-lucide="home"></i><span class="text-[10px] font-medium">Home</span></div>
<div class="mobile-nav-item" onclick="switchView('explore')"><i data-lucide="compass"></i><span class="text-[10px] font-medium">Explore</span></div>
<div class="mobile-nav-item" onclick="openCreateMenu()"><div class="w-10 h-10 bg-[#1f1f1f] rounded-full flex items-center justify-center text-white mb-1"><i data-lucide="plus" style="width:20px;height:20px"></i></div></div>
<div class="mobile-nav-item" onclick="switchView('chat')"><i data-lucide="message-circle"></i><span class="text-[10px] font-medium">Chat</span></div>
<div class="mobile-nav-item" onclick="showProfile(auth.currentUser ? auth.currentUser.uid : null)"><img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200"><span class="text-[10px] font-medium">Profile</span></div>
</nav>

<input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, writeBatch, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
    authDomain: "edulinki.firebaseapp.com",
    projectId: "edulinki",
    storageBucket: "edulinki.firebasestorage.app",
    messagingSenderId: "248886466474",
    appId: "1:248886466474:web:160043201a6b28bafbbdd3",
    measurementId: "G-MQBH12VL7N"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let users = [];
let posts = [];
let notifications = [];
let savedPosts = [];
let activeChatUserId = null;
let activeNotifTab = 'friends';
let activeNetworkTab = 'people';
let chatPartners = new Set();
window.currentViewingProfileId = null;
window.activeExploreTab = 'people'; 
window.isAdminMode = false;
window.currentThreadCommentId = null;
window.currentContext = "";
window.currentMedia = null;
window.currentMediaType = null;
window.isPlusMenuOpen = false;
window.isModelMenuOpen = false;
window.editingPostId = null;
let currentAvatarBlob = null;
let currentBannerBlob = null;
window.banTargetId = null;
window.banType = 'perm';

function refreshIcons() { if(window.lucide) window.lucide.createIcons(); }
function formatDate(timestamp) {
    if (!timestamp) return '';
    let date = (timestamp.toDate) ? timestamp.toDate() : new Date(timestamp);
    return isNaN(date.getTime()) ? '' : date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

onAuthStateChanged(auth, async (user) => {
    const loader = document.getElementById('app-loader');
    if (user) {
        const userRef = doc(db, "users", user.uid);
        onSnapshot(userRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentUser = { id: user.uid, ...data };
                if (data.isBanned) {
                    const overlay = document.getElementById('banned-overlay');
                    if (data.banExpires && new Date() > data.banExpires.toDate()) {
                        updateDoc(userRef, { isBanned: false, banReason: null, banExpires: null });
                        overlay.classList.add('hidden');
                    } else {
                        document.getElementById('banned-reason-text').innerText = data.banReason || 'Violation of Terms.';
                        document.getElementById('banned-duration-text').innerText = data.banExpires ? data.banExpires.toDate().toLocaleString() : 'Permanent';
                        overlay.classList.remove('hidden');
                        closePostView(); closeCompose(); closeSettings();
                    }
                } else {
                    document.getElementById('banned-overlay').classList.add('hidden');
                }
                if(user.email === 'edulinkbht@gmail.com' && !currentUser.isOfficial) updateDoc(userRef, { isOfficial: true });
                if(user.email === 'edulinkbht@gmail.com') document.getElementById('admin-mode-toggle-container').classList.remove('hidden');
                updateUserInterface();
            }
        });

        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
             currentUser = { id: user.uid, name: user.displayName || user.email.split('@')[0], email: user.email, avatar: user.photoURL || `https://api.dicebear.com/9.x/lorelei/svg?seed=${user.uid}`, bio: "New Member", following: [], followers: [], saved: [], isOfficial: (user.email === 'edulinkbht@gmail.com'), settings: { privateNetwork: false } };
             await setDoc(userRef, currentUser);
        } else { currentUser = { id: user.uid, ...userSnap.data() }; }

        savedPosts = currentUser.saved || [];
        updateUserInterface();
        initRealtimeListeners();
        initBannerDrag();
        if(loader) loader.style.opacity = '0';
        setTimeout(() => loader?.remove(), 500);
    } else { window.location.href = 'index.html'; }
});

function initRealtimeListeners() {
    onSnapshot(collection(db, "users"), (snapshot) => {
        users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(!document.getElementById('view-network').classList.contains('hidden')) renderNetwork();
        if(!document.getElementById('view-profile').classList.contains('hidden') && window.currentViewingProfileId) showProfile(window.currentViewingProfileId);
        if(!document.getElementById('view-chat').classList.contains('hidden')) renderChatList();
        refreshIcons();
    });

    onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snapshot) => {
        posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed();
        if(!document.getElementById('view-saved').classList.contains('hidden')) renderSaved();
        if(window.currentViewingPostId) renderCommentsInModal(window.currentViewingPostId);
        refreshIcons();
    });

    onSnapshot(query(collection(db, "notifications"), where("receiverId", "==", currentUser.id)), (snapshot) => {
        notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
        const badge = document.getElementById('notif-badge');
        if(badge) (notifications.some(n => !n.read)) ? badge.classList.remove('hidden') : badge.classList.add('hidden');
        if(!document.getElementById('view-notifications').classList.contains('hidden')) renderNotifications();
    });

    const updatePartners = (snap, role) => { snap.docs.forEach(d => chatPartners.add(role === 'sender' ? d.data().receiverId : d.data().senderId)); if(!document.getElementById('view-chat').classList.contains('hidden')) renderChatList(); };
    onSnapshot(query(collection(db, "messages"), where("senderId", "==", currentUser.id)), s => updatePartners(s, 'sender'));
    onSnapshot(query(collection(db, "messages"), where("receiverId", "==", currentUser.id)), s => updatePartners(s, 'receiver'));
}

function updateUserInterface() {
    if(!currentUser) return;
    const ids = ['sidebar-name', 'sidebar-avatar', 'mobile-avatar', 'header-avatar', 'compose-name', 'compose-avatar', 'comment-input-avatar', 'comment-input-avatar-mobile', 'edit-name', 'edit-bio', 'edit-avatar-preview', 'reply-input-avatar'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(!el) return;
        if(el.tagName === 'IMG') el.src = currentUser.avatar;
        else if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') el.value = currentUser[id.replace('edit-', '')] || '';
        else el.innerText = currentUser.name;
    });
    const toggle = document.getElementById('toggle-privacy');
    if(toggle) currentUser.settings?.privateNetwork ? toggle.classList.add('active') : toggle.classList.remove('active');
    refreshIcons();
}

let alertCallback = null;
window.showAlert = (msg, onConfirm) => {
    document.getElementById('alert-msg').innerText = msg;
    document.getElementById('custom-alert').classList.remove('hidden');
    setTimeout(() => { document.getElementById('custom-alert').classList.remove('opacity-0'); document.getElementById('custom-alert-box').classList.remove('scale-95'); }, 10);
    alertCallback = onConfirm;
    document.getElementById('alert-confirm-btn').onclick = () => { alertCallback?.(); closeAlert(); };
};
window.closeAlert = () => { document.getElementById('custom-alert').classList.add('opacity-0'); setTimeout(() => document.getElementById('custom-alert').classList.add('hidden'), 200); };

window.openSettings = () => document.getElementById('settings-overlay').classList.remove('hidden');
window.closeSettings = () => document.getElementById('settings-overlay').classList.add('hidden');
window.togglePrivacy = async () => {
    const isPrivate = !document.getElementById('toggle-privacy').classList.contains('active');
    document.getElementById('toggle-privacy').classList.toggle('active');
    await updateDoc(doc(db, "users", currentUser.id), { "settings.privateNetwork": isPrivate });
    showToast(`Account is ${isPrivate ? 'Private' : 'Public'}`);
};
window.toggleAdminMode = () => { window.isAdminMode = !window.isAdminMode; document.getElementById('toggle-admin-mode').classList.toggle('active'); showToast(`Admin Mode ${window.isAdminMode ? 'On' : 'Off'}`); if(window.currentViewingProfileId) showProfile(window.currentViewingProfileId); };

window.switchView = (view) => {
    ['feed', 'events', 'saved', 'network', 'profile', 'chat', 'explore', 'notifications', 'announcements'].forEach(v => document.getElementById(`view-${v}`)?.classList.add('hidden'));
    document.getElementById(`view-${view}`)?.classList.remove('hidden');
    document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${view}`)?.classList.add('active');
    if(view === 'feed') renderFeed();
    if(view === 'network') renderNetwork();
    if(view === 'chat') renderChatList();
    refreshIcons();
};

window.renderFeed = (term = "") => {
    const container = document.getElementById('feed-container'); container.innerHTML = "";
    posts.filter(p => {
        const author = users.find(u => u.id === p.authorId);
        if(!author || author.isBanned) return false;
        if(p.authorId === currentUser.id) return true;
        if(author.settings?.privateNetwork && !currentUser.following.includes(p.authorId)) return false;
        return !term || p.content.toLowerCase().includes(term.toLowerCase());
    }).forEach(p => container.appendChild(createPostElement(p)));
    refreshIcons();
};

function createPostElement(post) {
    const author = users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '' };
    const isLiked = post.likes?.includes(currentUser.id);
    const div = document.createElement('article');
    div.className = "post-card fade-in";
    div.onclick = () => openPostView(post.id);
    div.innerHTML = `
        <div class="p-4">
            <div class="post-header">
                <div class="flex gap-3">
                    <img src="${author.avatar}" class="post-avatar" onclick="event.stopPropagation(); showProfile('${author.id}')">
                    <div>
                        <span class="post-author-name" onclick="event.stopPropagation(); showProfile('${author.id}')">${author.name}</span>
                        <div class="post-meta">${formatDate(post.timestamp)}</div>
                    </div>
                </div>
                <button class="icon-btn" onclick="showPostOptions(event, '${post.id}', '${author.id}')"><i data-lucide="more-horizontal"></i></button>
            </div>
            <div class="post-body">${marked.parse(post.content)}</div>
            ${post.media ? `<div class="mt-3 rounded-xl overflow-hidden"><img src="${post.media}" class="w-full max-h-[400px] object-cover"></div>` : ''}
            <div class="post-actions">
                <button class="action-btn like" onclick="event.stopPropagation(); toggleLike('${post.id}')"><i data-lucide="heart" class="${isLiked ? 'fill-red-500 text-red-500' : ''}"></i> ${post.likes?.length || 0}</button>
                <button class="action-btn comment" onclick="event.stopPropagation(); openPostView('${post.id}')"><i data-lucide="message-square"></i> ${post.comments?.length || 0}</button>
                <button class="action-btn share-btn" onclick="event.stopPropagation(); sharePost('${post.id}')"><i data-lucide="share-2"></i></button>
            </div>
        </div>`;
    return div;
}

window.toggleLike = async (pid) => {
    const postRef = doc(db, "posts", pid);
    const post = posts.find(p => p.id === pid);
    if(post.likes?.includes(currentUser.id)) await updateDoc(postRef, { likes: arrayRemove(currentUser.id) });
    else { await updateDoc(postRef, { likes: arrayUnion(currentUser.id) }); if(post.authorId !== currentUser.id) sendNotification(post.authorId, 'like', 'liked your post', pid); }
};

window.showProfile = (uid) => {
    uid = uid || currentUser.id; window.currentViewingProfileId = uid;
    const user = users.find(u => u.id === uid); if(!user) return;
    const container = document.getElementById('view-profile');
    const isMe = uid === currentUser.id;
    const isFollowing = currentUser.following?.includes(uid);
    container.innerHTML = `
        <div class="profile-banner-container"><img src="${user.banner || 'https://images.unsplash.com/photo-1579546929518-9e396f3cc809'}" class="profile-banner-img"></div>
        <div class="px-6 relative">
            <div class="flex justify-between items-end -mt-10 mb-4">
                <img src="${user.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover">
                <div class="flex gap-2">
                    ${isMe ? '<button onclick="openEditProfile()" class="bg-gray-100 px-4 py-2 rounded-lg font-bold">Edit Profile</button>' : `<button onclick="toggleFollow('${uid}')" class="${isFollowing ? 'bg-gray-100' : 'bg-blue-600 text-white'} px-4 py-2 rounded-lg font-bold">${isFollowing ? 'Following' : 'Follow'}</button>`}
                    ${window.isAdminMode && !isMe ? `<button onclick="initiateBan('${uid}', true)" class="border border-red-500 text-red-500 px-3 py-2 rounded-lg">Ban</button>` : ''}
                </div>
            </div>
            <h1 class="text-2xl font-bold">${user.name}</h1>
            <p class="text-gray-600">${user.bio || ''}</p>
            <div id="profile-posts-container" class="mt-6 border-t pt-6"></div>
        </div>`;
    posts.filter(p => p.authorId === uid).forEach(p => document.getElementById('profile-posts-container').appendChild(createPostElement(p)));
    switchView('profile');
};

window.toggleFollow = async (uid) => {
    const meRef = doc(db, "users", currentUser.id), targetRef = doc(db, "users", uid);
    if(currentUser.following.includes(uid)) { await updateDoc(meRef, { following: arrayRemove(uid) }); await updateDoc(targetRef, { followers: arrayRemove(currentUser.id) }); }
    else { await updateDoc(meRef, { following: arrayUnion(uid) }); await updateDoc(targetRef, { followers: arrayUnion(currentUser.id) }); sendNotification(uid, 'follow', 'started following you'); }
};

window.openPostView = (pid) => {
    const post = posts.find(p => p.id === pid); if(!post) return;
    const author = users.find(u => u.id === post.authorId);
    window.currentViewingPostId = pid;
    document.getElementById('injected-post').innerHTML = `<div class="flex gap-3 items-center mb-4"><img src="${author.avatar}" class="w-10 h-10 rounded-full"><div><div class="font-bold">${author.name}</div><div class="text-xs text-gray-500">${formatDate(post.timestamp)}</div></div></div><div class="text-lg">${marked.parse(post.content)}</div>`;
    renderCommentsInModal(pid);
    document.getElementById('post-view-overlay').classList.remove('hidden');
    refreshIcons();
};

function renderCommentsInModal(pid) {
    const post = posts.find(p => p.id === pid);
    const html = (post?.comments || []).map(c => {
        const a = users.find(u => u.id === c.authorId);
        return `<div class="flex gap-3 p-4 border-b"><img src="${a?.avatar}" class="w-8 h-8 rounded-full"><div><div class="font-bold text-sm">${a?.name}</div><p class="text-sm">${c.content}</p></div></div>`;
    }).join('');
    document.getElementById('comments-list-desktop').innerHTML = html;
}

window.submitCommentDesktop = async () => {
    const txt = document.getElementById('comment-input-desktop').value.trim();
    if(!txt || !window.currentViewingPostId) return;
    await updateDoc(doc(db, "posts", window.currentViewingPostId), { comments: arrayUnion({ authorId: currentUser.id, content: txt, timestamp: Date.now() }) });
    document.getElementById('comment-input-desktop').value = "";
};

window.publishPost = async () => {
    const txt = document.getElementById('compose-text').value.trim();
    if(!txt && !window.currentMedia) return;
    const btn = document.getElementById('btn-publish'); btn.disabled = true;
    try {
        await addDoc(collection(db, "posts"), { authorId: currentUser.id, content: txt, media: window.currentMedia, timestamp: serverTimestamp(), likes: [], comments: [] });
        closeCompose();
    } catch(e) { console.error(e); } finally { btn.disabled = false; }
};

window.doLogout = async () => { await signOut(auth); window.location.href = "index.html"; };
window.showToast = (msg) => { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };

async function sendNotification(rid, type, content, pid = null) { await addDoc(collection(db, "notifications"), { receiverId: rid, senderId: currentUser.id, type, content, timestamp: serverTimestamp(), read: false, postId: pid }); }

window.initiateBan = async (uid, should) => { 
    if(!should) await updateDoc(doc(db, "users", uid), { isBanned: false });
    else { window.banTargetId = uid; document.getElementById('ban-modal-overlay').classList.remove('hidden'); }
};
window.confirmBan = async () => {
    await updateDoc(doc(db, "users", window.banTargetId), { isBanned: true, banReason: document.getElementById('ban-reason').value });
    closeBanModal();
};
window.closeBanModal = () => document.getElementById('ban-modal-overlay').classList.add('hidden');

window.openCompose = () => document.getElementById('compose-overlay').classList.remove('pointer-events-none', 'opacity-0');
window.closeCompose = () => { document.getElementById('compose-overlay').classList.add('pointer-events-none', 'opacity-0'); document.getElementById('compose-text').value = ""; };

window.openEditProfile = () => document.getElementById('edit-profile-overlay').classList.remove('pointer-events-none', 'opacity-0');
window.closeEditProfile = () => document.getElementById('edit-profile-overlay').classList.add('pointer-events-none', 'opacity-0');

window.handleFileSelect = (e) => { const f = e.target.files[0]; if(f) { const r = new FileReader(); r.onload = (ev) => { window.currentMedia = ev.target.result; document.getElementById('media-preview-container').classList.remove('hidden'); document.getElementById('media-preview-img').src = window.currentMedia; }; r.readAsDataURL(f); } };
window.removeMedia = () => { window.currentMedia = null; document.getElementById('media-preview-container').classList.add('hidden'); };

function initBannerDrag() {}
window.togglePlusMenu = () => { window.isPlusMenuOpen = !window.isPlusMenuOpen; document.getElementById('plus-menu').classList.toggle('active'); };
window.toggleModelMenu = () => { window.isModelMenuOpen = !window.isModelMenuOpen; document.getElementById('model-menu').classList.toggle('active'); };

window.sendMessageAction = async () => {
    const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return;
    const h = document.getElementById('chat-history'); h.innerHTML += `<div class="mb-4 text-right"><span class="bg-blue-600 text-white p-2 rounded-lg inline-block">${txt}</span></div>`;
    inp.value = "";
    try {
        const r = await fetch(`https://text.pollinations.ai/${encodeURIComponent(txt)}`);
        const a = await r.text();
        h.innerHTML += `<div class="mb-4"><span class="bg-gray-100 p-2 rounded-lg inline-block">${marked.parse(a)}</span></div>`;
    } catch(e) { h.innerHTML += `<div class="text-red-500">Error.</div>`; }
    h.scrollTop = h.scrollHeight;
};

refreshIcons();
</script>
</body>
</html>
