<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>EduLink</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">

<!-- Dependencies -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

:root {
--surface: #ffffff;
--background: #f9fafb;
--on-surface: #1f1f1f;
--text-secondary: #667085;
--outline: #eaecf0;
--hover-bg: #f3f4f6;
--primary: #0b57d0;
}

body {
font-family: 'Inter', sans-serif;
background-color: var(--background);
color: var(--on-surface);
overflow: hidden;
}

h1, h2, h3, .google-font { font-family: 'Google Sans', 'Inter', sans-serif; }

/* No Scrollbars */
* { scrollbar-width: none; -ms-overflow-style: none; }
*::-webkit-scrollbar { width: 0px; background: transparent; display: none; }

i[data-lucide], svg { flex-shrink: 0; }

.fade-in { animation: fadeUp 0.4s cubic-bezier(0.2, 0, 0, 1) forwards; opacity: 0; transform: translateY(10px); }
@keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

/* --- NAVIGATION & LAYOUT --- */
.app-panel {
background: var(--surface);
border-radius: 20px;
border: 1px solid var(--outline);
height: 100%;
display: flex;
flex-direction: column;
overflow: hidden;
box-shadow: 0 1px 2px rgba(0,0,0,0.03);
}

@media (max-width: 768px) {
.app-panel { border-radius: 0 !important; border: none !important; box-shadow: none !important; }
body { padding: 0 !important; }
}

/* Scroll Hide Header Logic */
#main-header {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 50;
}
#main-header.header-hidden {
    transform: translateY(-100%);
}

/* Twitter Balanced Tabs */
.tab-row {
    display: flex;
    width: 100%;
    border-bottom: 1px solid var(--outline);
    background: var(--surface);
}
.tab-item {
    flex: 1;
    text-align: center;
    padding: 14px 0;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    transition: color 0.2s;
}
.tab-item.active {
    color: var(--on-surface);
}
.tab-item.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    right: 20%;
    height: 3px;
    background: var(--primary);
    border-radius: 10px;
}

/* Instagram Grid */
.insta-grid {
    display: grid;
    grid-template-cols: repeat(3, 1fr);
    gap: 1px;
    background: var(--outline);
}
.grid-item {
    aspect-ratio: 1/1;
    background: #f0f0f0;
    position: relative;
    cursor: pointer;
    overflow: hidden;
}
.grid-item img, .grid-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Sidebar Nav */
#main-sidebar { width: 88px; flex-shrink: 0; padding: 24px 12px; }
@media (min-width: 1024px) { #main-sidebar { width: 260px; padding: 24px 20px; } }

.nav-item {
display: flex; align-items: center; gap: 14px;
padding: 12px; color: var(--text-secondary); font-weight: 500; font-size: 15px;
border-radius: 12px; transition: all 0.2s ease; cursor: pointer; text-decoration: none;
margin-bottom: 4px; justify-content: center; position: relative;
}
.nav-item.active { color: var(--primary); background-color: #eff4ff; font-weight: 600; }
@media (min-width: 1024px) { .nav-item { justify-content: flex-start; padding: 10px 16px; } }

/* Post Cards */
.post-card { background: var(--surface); border-bottom: 1px solid var(--outline); }
.post-avatar { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; }

/* Overlays */
.full-overlay {
    position: fixed; inset: 0; background: var(--surface); z-index: 100;
    display: flex; flex-direction: column; overflow: hidden;
}

/* Chat Bubbles */
.chat-bubble-me { background: var(--primary); color: white; padding: 10px 14px; border-radius: 18px 18px 4px 18px; font-size: 14px; align-self: flex-end; max-width: 80%; }
.chat-bubble-them { background: var(--hover-bg); color: var(--on-surface); padding: 10px 14px; border-radius: 18px 18px 18px 4px; font-size: 14px; align-self: flex-start; max-width: 80%; }

/* Mobile Navigation Controls */
.mobile-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: #98a2b3; }
.mobile-nav-item.active { color: var(--primary); }

.loader-spinner { width: 40px; height: 40px; border: 4px solid var(--hover-bg); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: #303134; color: white; padding: 12px 24px; border-radius: 40px; font-size: 14px; opacity: 0; transition: all 0.3s; z-index: 200; display: flex; align-items: center; gap: 8px; }
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* Circle Button */
.circle-btn {
    width: 36px; height: 36px; border-radius: 50%; background: var(--hover-bg);
    display: flex; items-center; justify-content: center; color: var(--on-surface);
}

.insta-chat-footer {
    display: flex; align-items: center; gap: 10px; padding: 12px;
    border: 1px solid var(--outline); border-radius: 30px; margin: 10px;
}
</style>
</head>
<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-[#f9fafb]">

<div id="app-loader" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center transition-opacity duration-500"><div class="loader-spinner"></div></div>

<!-- THREADS OVERLAY (Focused Conversation) -->
<div id="threads-overlay" class="full-overlay hidden">
    <div class="h-14 border-b border-gray-100 flex items-center px-4 justify-between shrink-0">
        <button onclick="closeThreads()" class="circle-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
        <span class="font-bold">Threads</span>
        <div class="w-8"></div>
    </div>
    <div id="threads-container" class="flex-1 overflow-y-auto"></div>
    <div class="p-3 border-t border-gray-100 bg-white">
        <div class="bg-gray-100 rounded-full px-4 py-2 flex items-center gap-2">
            <input type="text" id="thread-input" placeholder="Reply to thread..." class="flex-1 bg-transparent outline-none text-sm">
            <button onclick="submitThreadReply()" class="text-blue-600 font-bold text-sm">Post</button>
        </div>
    </div>
</div>

<!-- NOTIFICATIONS OVERLAY (NATIVE) -->
<div id="notif-overlay" class="full-overlay hidden">
    <div class="h-14 border-b border-gray-100 flex items-center px-4 justify-between shrink-0">
        <span class="font-bold text-xl">Notifications</span>
        <button onclick="closeNotifOverlay()" class="circle-btn"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div class="tab-row">
        <div onclick="switchNotifTab('friends')" id="ntab-friends" class="tab-item active">Following</div>
        <div onclick="switchNotifTab('others')" id="ntab-others" class="tab-item">Others</div>
        <div onclick="switchNotifTab('official')" id="ntab-official" class="tab-item">Official</div>
    </div>
    <div id="notif-list" class="flex-1 overflow-y-auto p-2"></div>
</div>

<!-- EXPLORE OVERLAY (NATIVE) -->
<div id="explore-overlay" class="full-overlay hidden">
    <div class="p-3 border-b border-gray-100 flex items-center gap-3 shrink-0">
        <div class="flex-1 bg-gray-100 rounded-lg px-3 py-2 flex items-center gap-2">
            <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
            <input type="text" id="explore-search" placeholder="Search EduLink" class="bg-transparent outline-none text-sm w-full" oninput="handleExploreSearch(this.value)">
        </div>
        <button onclick="closeExploreOverlay()" class="text-sm font-bold text-gray-600">Exit</button>
    </div>
    <div id="explore-pre-state" class="flex-1 flex flex-col items-center justify-center p-10 text-center">
        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mb-4"><i data-lucide="compass" class="text-blue-600"></i></div>
        <h3 class="font-bold text-lg">Search and Discover</h3>
        <p class="text-gray-500 text-sm mt-1">Find people, ideas, and communities across EduLink.</p>
    </div>
    <div id="explore-results-container" class="hidden flex-1 flex flex-col">
        <div class="tab-row">
            <div onclick="switchExploreTab('people')" id="etab-people" class="tab-item active">People</div>
            <div onclick="switchExploreTab('posts')" id="etab-posts" class="tab-item">Posts</div>
        </div>
        <div id="explore-results-list" class="flex-1 overflow-y-auto p-3"></div>
    </div>
</div>

<!-- MAIN SIDEBAR (Desktop) -->
<aside id="main-sidebar" class="hidden md:flex app-panel">
<div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')">
<img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
<h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
</div>
<nav class="flex-1">
    <a href="#" onclick="switchView('feed'); return false;" id="nav-feed" class="nav-item active"><i data-lucide="home"></i> <span class="hidden lg:block">Home</span></a>
    <a href="#" onclick="switchView('explore'); return false;" id="nav-explore" class="nav-item"><i data-lucide="compass"></i> <span class="hidden lg:block">Explore</span></a>
    <a href="#" onclick="switchView('chat'); return false;" id="nav-chat" class="nav-item"><i data-lucide="message-circle"></i> <span class="hidden lg:block">Chat</span></a>
    <a href="#" onclick="showProfile(auth.currentUser?.uid); return false;" id="nav-profile" class="nav-item"><i data-lucide="user"></i> <span class="hidden lg:block">Profile</span></a>
</nav>
</aside>

<div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
<main id="main-panel" class="flex-1 app-panel min-w-0 relative">
    <!-- Instagram Style Scrolling Header -->
    <header id="main-header" class="h-16 flex items-center justify-between px-4 shrink-0 bg-white/95 backdrop-blur-md border-b border-gray-100 sticky top-0 z-40">
        <h1 class="text-xl font-bold tracking-tight md:hidden">EduLink</h1>
        <div class="hidden md:block flex-1 max-w-[400px] relative">
            <i data-lucide="search" class="absolute left-4 top-3 w-4 h-4 text-gray-400"></i>
            <input type="text" placeholder="Search" id="global-search" oninput="handleExploreSearch(this.value)" class="w-full bg-gray-100 rounded-full py-2 pl-10 pr-4 outline-none text-sm">
        </div>
        <div class="flex items-center gap-2">
            <button class="icon-btn" onclick="openSettings()"><i data-lucide="settings" class="w-6 h-6"></i></button>
            <button class="icon-btn relative" onclick="openNotifOverlay()">
                <i data-lucide="bell" class="w-6 h-6"></i>
                <span id="notif-badge" class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full border-2 border-white hidden"></span>
            </button>
            <img id="header-avatar" src="" class="w-8 h-8 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hidden md:block" onclick="showProfile(auth.currentUser?.uid)">
        </div>
    </header>

    <!-- FEED VIEW -->
    <div id="view-feed" class="flex-1 h-full overflow-y-auto bg-white" onscroll="handleScroll(this)">
        <div id="feed-container"></div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="flex-1 h-full overflow-y-auto hidden bg-white">
        <div id="profile-header-content"></div>
        <div class="tab-row sticky top-0 z-10">
            <div onclick="switchProfileTab('posts')" id="ptab-posts" class="tab-item active">Posts</div>
            <div onclick="switchProfileTab('saved')" id="ptab-saved" class="tab-item">Saved</div>
            <div onclick="switchProfileTab('liked')" id="ptab-liked" class="tab-item">Liked</div>
        </div>
        <div id="profile-grid" class="insta-grid"></div>
    </div>

    <!-- CHAT VIEW -->
    <div id="view-chat" class="flex-1 h-full flex flex-col hidden bg-white overflow-hidden relative">
        <!-- Chat List View -->
        <div id="chat-list-view" class="flex flex-col h-full">
            <div class="p-4 border-b border-gray-100 flex items-center gap-3">
                <img id="chat-self-pfp" src="" class="w-10 h-10 rounded-full bg-gray-100 object-cover">
                <div class="flex-1 bg-gray-100 rounded-xl px-3 py-2 flex items-center gap-2">
                    <i data-lucide="search" class="w-4 h-4 text-gray-400"></i>
                    <input type="text" placeholder="Search messages" class="bg-transparent outline-none text-sm w-full">
                </div>
            </div>
            <div id="chat-list-container" class="flex-1 overflow-y-auto"></div>
        </div>
        <!-- Individual Chat View -->
        <div id="chat-window-view" class="hidden absolute inset-0 bg-white z-[60] flex flex-col">
            <div class="h-14 border-b border-gray-100 flex items-center px-4 justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="closeChatWindow()" class="circle-btn"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                    <img id="chat-partner-pfp" src="" class="w-8 h-8 rounded-full object-cover">
                    <div>
                        <div id="chat-partner-name" class="font-bold text-sm">User</div>
                        <div class="text-[10px] text-green-500 font-bold">Active now</div>
                    </div>
                </div>
                <button onclick="openChatOptions()" class="circle-btn"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
            <div class="insta-chat-footer bg-white">
                <button class="text-gray-400"><i data-lucide="camera" class="w-6 h-6"></i></button>
                <input id="chat-input" type="text" placeholder="Message..." class="flex-1 outline-none text-sm bg-transparent">
                <button onclick="sendChatMessage()" class="text-blue-600 font-bold text-sm px-2">Send</button>
            </div>
        </div>
    </div>
</main>
</div>

<!-- Mobile Bottom Nav -->
<nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-100 h-16 flex items-center justify-around z-[45]">
    <div class="mobile-nav-item active" onclick="switchView('feed')"><i data-lucide="home"></i></div>
    <div class="mobile-nav-item" onclick="openExploreOverlay()"><i data-lucide="search"></i></div>
    <div class="mobile-nav-item" onclick="openCompose()"><div class="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center"><i data-lucide="plus"></i></div></div>
    <div class="mobile-nav-item" onclick="switchView('chat')"><i data-lucide="message-circle"></i></div>
    <div class="mobile-nav-item" onclick="showProfile(auth.currentUser?.uid)"><img id="mobile-nav-pfp" src="" class="w-6 h-6 rounded-full border border-gray-200 object-cover"></div>
</nav>

<div id="toast" class="toast"><i data-lucide="check-circle" class="w-4 h-4"></i><span id="toast-msg"></span></div>

<!-- MODALS -->
<div id="settings-modal" class="full-overlay hidden">
    <div class="h-14 border-b border-gray-100 flex items-center px-4 justify-between">
        <span class="font-bold text-lg">Settings</span>
        <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="circle-btn"><i data-lucide="x"></i></button>
    </div>
    <div class="p-4 flex flex-col gap-4">
        <button onclick="doLogout()" class="w-full py-3 bg-red-50 text-red-600 font-bold rounded-xl">Log Out</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
    authDomain: "edulinki.firebaseapp.com",
    projectId: "edulinki",
    storageBucket: "edulinki.firebasestorage.app",
    messagingSenderId: "248886466474",
    appId: "1:248886466474:web:160043201a6b28bafbbdd3",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

window.auth = auth; window.db = db;

let currentUser = null;
let users = [];
let posts = [];
let notifications = [];
let activeChatPartnerId = null;
let lastScrollY = 0;
let currentProfileTab = 'posts';
let currentExploreTab = 'people';

// --- HELPERS ---
function refreshIcons() { if(window.lucide) window.lucide.createIcons(); }
function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

// --- AUTH ---
onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (snap.exists()) {
            currentUser = { id: user.uid, ...snap.data() };
        } else {
            currentUser = { id: user.uid, name: user.displayName || 'User', email: user.email, avatar: `https://api.dicebear.com/9.x/lorelei/svg?seed=${user.uid}`, following: [], followers: [], saved: [], liked_posts: [] };
            await setDoc(userRef, currentUser);
        }
        document.getElementById('header-avatar').src = currentUser.avatar;
        document.getElementById('mobile-nav-pfp').src = currentUser.avatar;
        document.getElementById('chat-self-pfp').src = currentUser.avatar;
        initDataListeners();
        document.getElementById('app-loader').style.opacity = '0';
        setTimeout(() => document.getElementById('app-loader').remove(), 500);
    } else {
        window.location.href = 'index.html';
    }
});

function initDataListeners() {
    onSnapshot(collection(db, "users"), (s) => { users = s.docs.map(d => ({ id: d.id, ...d.data() })); });
    onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (s) => {
        posts = s.docs.map(d => ({ id: d.id, ...d.data() }));
        if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed();
        if(!document.getElementById('view-profile').classList.contains('hidden')) renderProfileGrid();
    });
    onSnapshot(query(collection(db, "notifications"), where("receiverId", "==", currentUser.id)), (s) => {
        notifications = s.docs.map(d => ({ id: d.id, ...d.data() }));
        document.getElementById('notif-badge').classList.toggle('hidden', !notifications.some(n => !n.read));
    });
}

// --- CORE NAVIGATION ---
window.switchView = function(view) {
    const views = ['feed', 'profile', 'chat'];
    views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
    document.getElementById(`view-${view}`).classList.remove('hidden');
    
    document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
    document.getElementById('main-header').classList.remove('hidden', 'header-hidden');
    document.getElementById('mobile-nav').classList.remove('hidden');

    if(view === 'feed') {
        renderFeed();
        document.querySelector('[onclick="switchView(\'feed\')"]').classList.add('active');
    } else if(view === 'profile') {
        document.getElementById('main-header').classList.add('hidden');
        showProfile(currentUser.id);
        document.querySelector('[onclick="showProfile(auth.currentUser?.uid)"]').classList.add('active');
    } else if(view === 'chat') {
        document.getElementById('main-header').classList.add('hidden');
        renderChatList();
        document.querySelector('[onclick="switchView(\'chat\')"]').classList.add('active');
    }
    refreshIcons();
}

// Instagram Style Scroll Hide Header
window.handleScroll = function(el) {
    if(window.innerWidth > 768) return;
    const current = el.scrollTop;
    const header = document.getElementById('main-header');
    if (current > lastScrollY && current > 80) {
        header.classList.add('header-hidden');
    } else {
        header.classList.remove('header-hidden');
    }
    lastScrollY = current;
}

// --- OVERLAYS ---
window.openNotifOverlay = function() {
    document.getElementById('notif-overlay').classList.remove('hidden');
    document.getElementById('mobile-nav').classList.add('hidden');
    renderNotifications();
}
window.closeNotifOverlay = function() {
    document.getElementById('notif-overlay').classList.add('hidden');
    document.getElementById('mobile-nav').classList.remove('hidden');
}

window.openExploreOverlay = function() {
    document.getElementById('explore-overlay').classList.remove('hidden');
    document.getElementById('mobile-nav').classList.add('hidden');
}
window.closeExploreOverlay = function() {
    document.getElementById('explore-overlay').classList.add('hidden');
    document.getElementById('mobile-nav').classList.remove('hidden');
}

// --- FEED & POSTS ---
window.renderFeed = function() {
    const container = document.getElementById('feed-container');
    container.innerHTML = posts.map(p => createPostHTML(p)).join('');
    refreshIcons();
}

function createPostHTML(post) {
    const author = users.find(u => u.id === post.authorId) || { name: 'User', avatar: '' };
    const isLiked = post.likes?.includes(currentUser.id);
    const mediaHTML = post.media ? `<img src="${post.media}" class="w-full rounded-xl mt-3 max-h-[400px] object-cover border border-gray-100">` : `<div class="w-full aspect-video bg-gray-50 rounded-xl mt-3 flex items-center justify-center border border-gray-100"><i data-lucide="image" class="text-gray-300 w-10 h-10"></i></div>`;
    
    return `
    <div class="post-card p-4 flex gap-3" onclick="openThreads('${post.id}')">
        <img src="${author.avatar}" class="post-avatar shrink-0" onclick="event.stopPropagation(); showProfile('${author.id}')">
        <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between">
                <span class="font-bold text-sm truncate">${author.name}</span>
                <span class="text-xs text-gray-400">2h</span>
            </div>
            <p class="text-sm mt-1 line-clamp-4">${post.content}</p>
            ${mediaHTML}
            <div class="flex items-center justify-between mt-4">
                <div class="flex gap-4">
                    <button class="flex items-center gap-1.5 text-gray-500" onclick="event.stopPropagation(); toggleLike('${post.id}')"><i data-lucide="heart" class="w-5 h-5 ${isLiked ? 'fill-red-500 text-red-500' : ''}"></i> <span class="text-xs">${post.likes?.length || 0}</span></button>
                    <button class="flex items-center gap-1.5 text-gray-500"><i data-lucide="message-circle" class="w-5 h-5"></i> <span class="text-xs">${post.comments?.length || 0}</span></button>
                </div>
                <button class="text-gray-400"><i data-lucide="bookmark" class="w-5 h-5"></i></button>
            </div>
            ${post.comments?.length > 0 ? `<div class="mt-3 text-blue-600 text-xs font-bold">Show 1 reply</div>` : ''}
        </div>
    </div>`;
}

// --- THREADS SYSTEM ---
let activeThreadPostId = null;
window.openThreads = function(postId) {
    activeThreadPostId = postId;
    const post = posts.find(p => p.id === postId);
    const container = document.getElementById('threads-container');
    const author = users.find(u => u.id === post.authorId);
    
    let html = `
    <div class="p-4 border-b border-gray-100">
        <div class="flex gap-3 mb-4"><img src="${author?.avatar}" class="w-10 h-10 rounded-full"><span class="font-bold pt-2">${author?.name}</span></div>
        <p class="text-lg leading-relaxed">${post.content}</p>
        ${post.media ? `<img src="${post.media}" class="mt-4 rounded-2xl w-full border border-gray-100">` : ''}
    </div>`;

    if(post.comments) {
        html += post.comments.map(c => {
            const cAuthor = users.find(u => u.id === c.authorId);
            return `<div class="p-4 flex gap-3 border-b border-gray-50">
                <img src="${cAuthor?.avatar}" class="w-8 h-8 rounded-full">
                <div><span class="font-bold text-sm">${cAuthor?.name}</span><p class="text-sm mt-0.5 text-gray-800">${c.content}</p></div>
            </div>`;
        }).join('');
    }
    container.innerHTML = html;
    document.getElementById('threads-overlay').classList.remove('hidden');
    refreshIcons();
}
window.closeThreads = function() { document.getElementById('threads-overlay').classList.add('hidden'); }

// --- PROFILE SYSTEM ---
let viewingUserId = null;
window.showProfile = function(userId) {
    viewingUserId = userId;
    switchView('profile');
    const user = users.find(u => u.id === userId);
    if(!user) return;
    
    document.getElementById('profile-header-content').innerHTML = `
    <div class="h-32 bg-gray-100 relative"></div>
    <div class="p-4 relative">
        <div class="flex justify-between items-end -mt-12 mb-4">
            <img src="${user.avatar}" class="w-24 h-24 rounded-full border-4 border-white shadow-sm object-cover">
            <button class="px-4 py-1.5 border border-gray-200 rounded-full font-bold text-sm">Edit Profile</button>
        </div>
        <h2 class="text-xl font-bold">${user.name}</h2>
        <p class="text-gray-500 text-sm">@${user.name.toLowerCase().replace(/ /g,'')}</p>
        <div class="flex gap-5 mt-4 text-sm">
            <span><strong class="text-black">${user.following?.length || 0}</strong> Following</span>
            <span><strong class="text-black">${user.followers?.length || 0}</strong> Followers</span>
        </div>
    </div>`;
    renderProfileGrid();
}

function renderProfileGrid() {
    const grid = document.getElementById('profile-grid');
    let display = [];
    if(currentProfileTab === 'posts') display = posts.filter(p => p.authorId === viewingUserId);
    else if(currentProfileTab === 'liked') display = posts.filter(p => p.likes?.includes(viewingUserId));
    else if(currentProfileTab === 'saved') display = posts.filter(p => currentUser.saved?.includes(p.id));

    grid.innerHTML = display.map(p => `
        <div class="grid-item" onclick="openThreads('${p.id}')">
            ${p.media ? `<img src="${p.media}">` : `<div class="w-full h-full flex items-center justify-center text-gray-300 bg-gray-50"><i data-lucide="file-text"></i></div>`}
        </div>
    `).join('');
    refreshIcons();
}

window.switchProfileTab = function(tab) {
    currentProfileTab = tab;
    document.querySelectorAll('#view-profile .tab-item').forEach(i => i.classList.remove('active'));
    document.getElementById(`ptab-${tab}`).classList.add('active');
    renderProfileGrid();
}

// --- CHAT SYSTEM ---
window.renderChatList = function() {
    const container = document.getElementById('chat-list-container');
    container.innerHTML = users.filter(u => u.id !== currentUser.id).map(u => `
    <div class="p-4 flex items-center gap-3 hover:bg-gray-50 transition-colors" onclick="openChatWindow('${u.id}')">
        <img src="${u.avatar}" class="w-14 h-14 rounded-full object-cover">
        <div class="flex-1 border-b border-gray-50 pb-4">
            <div class="flex justify-between items-center"><span class="font-bold text-sm">${u.name}</span><span class="text-xs text-gray-400">12:30 PM</span></div>
            <p class="text-xs text-gray-500 mt-1 line-clamp-1">Shared a post with you.</p>
        </div>
    </div>`).join('');
}

window.openChatWindow = function(partnerId) {
    activeChatPartnerId = partnerId;
    const partner = users.find(u => u.id === partnerId);
    document.getElementById('chat-partner-pfp').src = partner.avatar;
    document.getElementById('chat-partner-name').innerText = partner.name;
    document.getElementById('chat-window-view').classList.remove('hidden');
    document.getElementById('mobile-nav').classList.add('hidden');
    refreshIcons();
}

window.closeChatWindow = function() {
    document.getElementById('chat-window-view').classList.add('hidden');
    document.getElementById('mobile-nav').classList.remove('hidden');
}

// --- EXPLORE SYSTEM ---
window.handleExploreSearch = function(val) {
    const pre = document.getElementById('explore-pre-state');
    const res = document.getElementById('explore-results-container');
    const list = document.getElementById('explore-results-list');
    
    if(!val) { pre.classList.remove('hidden'); res.classList.add('hidden'); return; }
    pre.classList.add('hidden');
    res.classList.remove('hidden');

    if(currentExploreTab === 'people') {
        const matches = users.filter(u => u.name.toLowerCase().includes(val.toLowerCase()));
        list.innerHTML = matches.map(u => `<div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl mb-2" onclick="showProfile('${u.id}'); closeExploreOverlay()">
            <img src="${u.avatar}" class="w-10 h-10 rounded-full">
            <div><div class="font-bold text-sm">${u.name}</div><div class="text-xs text-gray-500">Student at EduLink</div></div>
        </div>`).join('');
    } else {
        const matches = posts.filter(p => p.content.toLowerCase().includes(val.toLowerCase()));
        list.innerHTML = matches.map(p => `<div class="p-3 border-b border-gray-100" onclick="openThreads('${p.id}'); closeExploreOverlay()">
            <p class="text-sm line-clamp-2">${p.content}</p>
        </div>`).join('');
    }
}

window.switchExploreTab = function(tab) {
    currentExploreTab = tab;
    document.querySelectorAll('#explore-overlay .tab-item').forEach(i => i.classList.remove('active'));
    document.getElementById(`etab-${tab}`).classList.add('active');
    handleExploreSearch(document.getElementById('explore-search').value);
}

// --- GLOBAL ACTIONS ---
window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
window.doLogout = async () => { await signOut(auth); window.location.href = 'index.html'; }
window.toggleLike = async function(pid) {
    const ref = doc(db, "posts", pid);
    if(posts.find(p=>p.id===pid).likes?.includes(currentUser.id)) await updateDoc(ref, { likes: arrayRemove(currentUser.id) });
    else await updateDoc(ref, { likes: arrayUnion(currentUser.id) });
}

refreshIcons();
</script>
</body>
</html>
