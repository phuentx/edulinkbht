<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Live - Mixer Engine</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --bg: #000; --primary: #fe2c55; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; height: 100vh; overflow: hidden; }

        /* --- FEED --- */
        #feed-view { position: absolute; inset: 0; z-index: 50; background: #111; overflow-y: scroll; scroll-snap-type: y mandatory; }
        #feed-view::-webkit-scrollbar { display: none; }
        
        .feed-item {
            width: 100%; height: 100dvh; scroll-snap-align: start; position: relative;
            background: #222; display: flex; align-items: center; justify-content: center;
        }
        .feed-gradient { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent 50%); z-index: 2; }
        .feed-info { position: absolute; bottom: 80px; left: 20px; z-index: 3; max-width: 70%; }
        .f-user { font-size: 18px; font-weight: 700; margin-bottom: 5px; text-shadow: 0 2px 4px black; }
        .f-btn { 
            background: var(--primary); border: none; color: white; padding: 10px 24px; 
            border-radius: 30px; font-weight: 700; margin-top: 10px; cursor: pointer;
        }

        .fab { position: fixed; top: 20px; right: 20px; z-index: 100; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; font-size: 13px; }

        /* --- LIVE ROOM --- */
        #live-view { position: absolute; inset: 0; z-index: 100; display: none; background: #000; }
        
        /* The Canvas is what we actually stream, but we hide it visually and show the video element playing the stream */
        canvas { display: none; } 
        
        #main-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* UI Overlay */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 40px 16px 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .host-tag { background: rgba(0,0,0,0.4); border-radius: 30px; padding: 4px 12px 4px 4px; display: flex; align-items: center; gap: 8px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .h-avi { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .chat-area { height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; mask-image: linear-gradient(transparent, black 10%); pointer-events: auto; margin-bottom: 10px; }
        .msg { background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 12px; align-self: flex-start; font-size: 13px; backdrop-filter: blur(4px); max-width: 80%; }
        
        .controls { display: flex; gap: 10px; pointer-events: auto; align-items: center; }
        .chat-inp { flex: 1; background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 24px; color: white; outline: none; }
        .act-btn { width: 44px; height: 44px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; background: rgba(255,255,255,0.2); color: white; }

        /* Setup */
        #setup-view { position: fixed; inset: 0; z-index: 200; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Hidden Guest Video Element (For Mixer) */
        #guest-source { display: none; }

    </style>
</head>
<body>

    <div id="feed-view">
        <button class="fab" onclick="openSetup()"><i data-lucide="plus" size="16"></i> GO LIVE</button>
        <div id="feed-list"></div>
    </div>

    <div id="setup-view">
        <video id="preview-vid" autoplay muted playsinline style="width:100%; height:100%; object-fit:cover; position:absolute; opacity:0.5;"></video>
        <div style="z-index:2; width:80%; text-align:center;">
            <input id="room-title" type="text" placeholder="Live Title..." style="background:rgba(0,0,0,0.5); border:1px solid #555; padding:15px; width:100%; color:white; border-radius:10px; margin-bottom:20px; outline:none;">
            <button onclick="startLive()" style="background:var(--primary); width:100%; padding:15px; border:none; border-radius:30px; color:white; font-weight:bold; font-size:18px;">Start Broadcast</button>
            <button onclick="closeSetup()" style="background:none; border:none; color:#aaa; margin-top:20px;">Cancel</button>
        </div>
    </div>

    <div id="live-view">
        <video id="main-video" autoplay playsinline></video>
        
        <video id="guest-source" autoplay playsinline></video>
        
        <canvas id="mixer-canvas" width="720" height="1280"></canvas>

        <div id="ui-layer">
            <div class="top-row">
                <div class="host-tag">
                    <div class="h-avi" id="ui-avi">H</div>
                    <div>
                        <div style="font-weight:700; font-size:14px;" id="ui-name">Host</div>
                        <div style="font-size:11px; opacity:0.7"><span id="ui-viewers">0</span> watching</div>
                    </div>
                </div>
                <button class="act-btn" onclick="leave()" style="width:36px; height:36px;"><i data-lucide="x" size="18"></i></button>
            </div>

            <div>
                <div class="chat-area" id="chat-list"></div>
                <div class="controls">
                    <input id="chat-input" class="chat-inp" placeholder="Comment..." autocomplete="off">
                    
                    <button id="btn-request" class="act-btn" onclick="sendRequest()" style="display:none;">
                        <i data-lucide="hand"></i>
                    </button>
                    
                    <button id="btn-accept" class="act-btn" onclick="acceptGuest()" style="display:none; background:#00c853;">
                        <i data-lucide="user-plus"></i>
                    </button>

                    <button class="act-btn" style="background:linear-gradient(45deg, #ff0050, #00f2ea);"><i data-lucide="heart" fill="white"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, increment, query, where, orderBy, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        lucide.createIcons();

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const iceServers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

        // GLOBAL STATE
        let role = null; 
        let roomId = null;
        let myId = Math.random().toString(36).substr(2, 6).toUpperCase();
        let localStream;    // Camera stream
        let mixerStream;    // Canvas stream (what goes out)
        let guestStream;    // Incoming guest stream
        let pcs = {};       // Peer Connections
        let pendingGuestId = null;
        
        // Canvas Mixer
        const canvas = document.getElementById('mixer-canvas');
        const ctx = canvas.getContext('2d');
        let mixerInterval;

        // --- 1. FEED ---
        const feedQ = query(collection(db, "rooms"), where("status", "==", "live"));
        onSnapshot(feedQ, (snap) => {
            const list = document.getElementById('feed-list');
            list.innerHTML = '';
            if(snap.empty) list.innerHTML = `<div style="height:100vh; display:flex; align-items:center; justify-content:center; color:#666;">No active lives</div>`;
            
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement('div');
                div.className = 'feed-item';
                div.innerHTML = `
                    <div style="width:100%; height:100%; background:linear-gradient(45deg, #111, #333);"></div>
                    <div class="feed-gradient"></div>
                    <div class="feed-info">
                        <div class="f-user">${data.hostName}</div>
                        <div style="opacity:0.8; margin-bottom:10px;">${data.title}</div>
                        <button class="f-btn">Join Live</button>
                    </div>
                `;
                div.onclick = () => joinLive(d.id, data);
                list.appendChild(div);
            });
        });

        // --- 2. HOST LOGIC (The Mixer) ---
        window.openSetup = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: {facingMode:'user', width: {ideal: 720}, height: {ideal: 1280}}, audio: true });
                document.getElementById('preview-vid').srcObject = localStream;
                document.getElementById('feed-view').style.display = 'none';
                document.getElementById('setup-view').style.display = 'flex';
            } catch(e) { alert("Need Camera"); }
        };

        window.startLive = async () => {
            role = 'host'; roomId = myId;
            const title = document.getElementById('room-title').value || "Chilling";
            
            document.getElementById('setup-view').style.display = 'none';
            document.getElementById('live-view').style.display = 'block';
            
            // 1. Start Mixer
            startMixer(); 
            
            // 2. Play Local Stream on Main Video (Host sees canvas output too, or direct local)
            // Let's show canvas output so Host sees what Viewers see
            document.getElementById('main-video').srcObject = mixerStream;
            document.getElementById('main-video').muted = true; // Mute self

            // 3. Create Room
            await setDoc(doc(db, "rooms", roomId), {
                hostId: myId, hostName: "Host "+myId, title, status: 'live', viewers: 0
            });

            // 4. Signaling Listeners
            onSnapshot(collection(db, `rooms/${roomId}/offers`), s => {
                s.docChanges().forEach(c => { if(c.type==='added') handleOffer(c.doc.data()); });
            });
            
            // 5. Guest Request Listener
            onSnapshot(collection(db, `rooms/${roomId}/requests`), s => {
                s.docChanges().forEach(c => { 
                    if(c.type==='added') {
                        pendingGuestId = c.doc.data().userId;
                        document.getElementById('btn-accept').style.display = 'flex';
                        alert("Guest Request Received!");
                    }
                });
            });

            listenChat();
        };

        // --- THE CANVAS MIXER (Magic happens here) ---
        function startMixer() {
            // Capture Canvas at 30 FPS
            mixerStream = canvas.captureStream(30);
            
            // Add Audio from Local Mic to Mixer Stream
            // (Note: Canvas capture stream has no audio by default)
            const audioTrack = localStream.getAudioTracks()[0];
            mixerStream.addTrack(audioTrack);

            mixerInterval = setInterval(() => {
                // Clear
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // If Guest exists, Split Screen
                if (guestStream) {
                    // Host Top
                    ctx.drawImage(document.getElementById('preview-vid'), 0, 0, canvas.width, canvas.height / 2); // Using preview-vid as source element for raw frames
                    // Guest Bottom
                    ctx.drawImage(document.getElementById('guest-source'), 0, canvas.height / 2, canvas.width, canvas.height / 2);
                    
                    // Separator
                    ctx.fillStyle = '#fe2c55';
                    ctx.fillRect(0, (canvas.height/2)-2, canvas.width, 4);
                } else {
                    // Host Full Screen
                    ctx.drawImage(document.getElementById('preview-vid'), 0, 0, canvas.width, canvas.height);
                }
            }, 33); // ~30 FPS
        }

        // --- HOST WEBRTC ---
        async function handleOffer(data) {
            const pc = new RTCPeerConnection(iceServers);
            pcs[data.from] = pc;

            // Host sends MIXER STREAM, not raw camera
            mixerStream.getTracks().forEach(t => pc.addTrack(t, mixerStream));

            // If this is the GUEST, we expect to receive video
            if (data.isGuest) {
                pc.ontrack = e => {
                    const el = document.getElementById('guest-source');
                    el.srcObject = e.streams[0];
                    guestStream = e.streams[0]; // Mixer will pick this up
                    
                    // Mix Guest Audio into Mixer Stream? 
                    // Web Audio API needed for perfect mixing, but for now:
                    // Viewers will only hear Host via WebRTC track.
                    // FIX: We need to replace the audio track sent to viewers with a mixed one.
                    // For this simple demo: Viewers hear Host. Guest audio is tricky without WebAudio.
                    // Let's focus on Video Composition first.
                };
            }

            pc.onicecandidate = e => {
                if(e.candidate) addDoc(collection(db, `rooms/${roomId}/candidates`), { candidate:e.candidate.toJSON(), to:data.from, from:myId });
            };

            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await addDoc(collection(db, `rooms/${roomId}/answers`), { answer, to:data.from, from:myId });
        }

        window.acceptGuest = async () => {
            // Signal the specific user to upgrade
            await addDoc(collection(db, `rooms/${roomId}/guest_approvals`), { userId: pendingGuestId });
            document.getElementById('btn-accept').style.display = 'none';
        };

        // --- 3. VIEWER LOGIC ---
        async function joinLive(id, data) {
            roomId = id; role = 'viewer';
            document.getElementById('feed-view').style.display = 'none';
            document.getElementById('live-view').style.display = 'block';
            document.getElementById('ui-name').innerText = data.hostName;
            document.getElementById('btn-request').style.display = 'flex';

            await updateDoc(doc(db, "rooms", roomId), { viewers: increment(1) });
            connectToHost(data.hostId);
            listenChat();

            // Listen for Guest Approval
            onSnapshot(collection(db, `rooms/${roomId}/guest_approvals`), snap => {
                snap.docChanges().forEach(c => {
                    if(c.type === 'added' && c.doc.data().userId === myId) {
                        becomeGuest(data.hostId);
                    }
                });
            });
        }

        async function connectToHost(hostId) {
            const pc = new RTCPeerConnection(iceServers);
            pcs['host'] = pc;
            
            pc.addTransceiver('video', {direction:'recvonly'});
            pc.addTransceiver('audio', {direction:'recvonly'});

            pc.ontrack = e => {
                document.getElementById('main-video').srcObject = e.streams[0];
            };

            pc.onicecandidate = e => {
                if(e.candidate) addDoc(collection(db, `rooms/${roomId}/candidates`), { candidate:e.candidate.toJSON(), to:hostId, from:myId });
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await addDoc(collection(db, `rooms/${roomId}/offers`), { offer, to:hostId, from:myId, isGuest: false });

            // Answer Listener
            onSnapshot(collection(db, `rooms/${roomId}/answers`), s => {
                s.docChanges().forEach(c => { if(c.type==='added' && c.doc.data().to===myId) pc.setRemoteDescription(new RTCSessionDescription(c.doc.data().answer)); });
            });
            // ICE Listener
            onSnapshot(collection(db, `rooms/${roomId}/candidates`), s => {
                s.docChanges().forEach(c => { if(c.type==='added' && c.doc.data().to===myId) pc.addIceCandidate(new RTCIceCandidate(c.doc.data().candidate)); });
            });
        }

        // --- 4. BECOME GUEST ---
        async function becomeGuest(hostId) {
            // 1. Get Camera
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            } catch(e) { alert("Camera Fail"); return; }

            // 2. Re-connect to Host sending Video
            const pc = new RTCPeerConnection(iceServers);
            pcs['host_guest'] = pc; // New connection
            
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = e => {
                if(e.candidate) addDoc(collection(db, `rooms/${roomId}/candidates`), { candidate:e.candidate.toJSON(), to:hostId, from:myId });
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            // Flag isGuest: true tells Host to put us in the Mixer
            await addDoc(collection(db, `rooms/${roomId}/offers`), { offer, to:hostId, from:myId, isGuest: true });
            
            // We reuse existing Answer/ICE listeners because they target 'myId'
            alert("You are joining the stage!");
        }

        window.sendRequest = async () => {
            await addDoc(collection(db, `rooms/${roomId}/requests`), { userId: myId });
            alert("Request Sent!");
        };

        // --- 5. CHAT ---
        function listenChat() {
            onSnapshot(query(collection(db, `rooms/${roomId}/chat`), orderBy('ts')), snap => {
                snap.docChanges().forEach(c => {
                    if(c.type==='added') {
                        const d = c.doc.data();
                        const div = document.createElement('div');
                        div.className = 'msg';
                        div.innerHTML = `<span style="opacity:0.6; font-weight:700;">${d.name}: </span>${d.text}`;
                        const box = document.getElementById('chat-list');
                        box.appendChild(div);
                        box.scrollTop = box.scrollHeight;
                    }
                });
            });
        }

        document.getElementById('chat-input').onkeydown = async (e) => {
            if(e.key==='Enter' && e.target.value.trim()){
                await addDoc(collection(db, `rooms/${roomId}/chat`), { name: role==='host'?"Host":"User", text:e.target.value, ts:Date.now() });
                e.target.value = '';
            }
        };

        // Utils
        window.leave = async () => {
            if(role==='host') {
                if(confirm("End Live?")) {
                    await updateDoc(doc(db, "rooms", roomId), {status:'ended'});
                    await deleteDoc(doc(db, "rooms", roomId));
                    location.reload();
                }
            } else {
                await updateDoc(doc(db, "rooms", roomId), {viewers:increment(-1)});
                location.reload();
            }
        };
        window.closeSetup = () => {
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            document.getElementById('setup-view').style.display='none';
            document.getElementById('feed-view').style.display='block';
        };

    </script>
</body>
</html>
