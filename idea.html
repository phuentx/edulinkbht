<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Edulinki Live - Stable</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        :root { --bg: #000; --primary: #fe2c55; --glass: rgba(255, 255, 255, 0.15); }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; height: 100vh; overflow: hidden; }

        /* HOME FEED */
        #home-feed { position: absolute; inset: 0; z-index: 50; background: #121212; display: flex; flex-direction: column; }
        .feed-header { padding: 15px 20px; background: #000; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .logo span { color: var(--primary); }
        .grid { flex: 1; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-content: start; }
        .card { 
            aspect-ratio: 9/16; background: #222; border-radius: 12px; position: relative; overflow: hidden; cursor: pointer; 
        }
        .card-badge { position: absolute; top: 10px; left: 10px; background: var(--primary); padding: 3px 6px; font-size: 10px; border-radius: 4px; font-weight: bold; }
        .card-info { position: absolute; bottom: 0; width: 100%; padding: 10px; background: linear-gradient(transparent, black); }

        .fab { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: var(--primary); color: white; padding: 12px 30px; border-radius: 30px; 
            font-weight: bold; border: none; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 15px rgba(254,44,85,0.5);
        }

        /* LIVE STAGE */
        #live-stage { position: absolute; inset: 0; z-index: 100; display: none; background: #000; }
        #video-layer { position: absolute; inset: 0; z-index: 1; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .host-mirror { transform: scaleX(-1); }

        #ui-layer { position: absolute; inset: 0; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .top-bar { padding: 40px 16px 10px; display: flex; justify-content: space-between; pointer-events: auto; background: linear-gradient(black, transparent); }
        .host-info { background: rgba(0,0,0,0.5); padding: 4px 12px 4px 4px; border-radius: 30px; display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px); }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .bottom-bar { padding: 16px; pointer-events: auto; background: linear-gradient(transparent, black); }
        .chat-box { height: 200px; overflow-y: auto; margin-bottom: 10px; display: flex; flex-direction: column; gap: 6px; mask-image: linear-gradient(transparent, black 20%); }
        .msg { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 12px; align-self: flex-start; font-size: 13px; backdrop-filter: blur(4px); }
        .input-row { display: flex; gap: 10px; }
        .chat-input { flex: 1; background: rgba(255,255,255,0.2); border: none; padding: 12px; border-radius: 20px; color: white; outline: none; }
        .icon-btn { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.1); border: none; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        /* Hearts */
        .hearts-box { position: absolute; bottom: 80px; right: 20px; width: 50px; height: 300px; pointer-events: none; }
        .heart { position: absolute; bottom: 0; animation: float 2s forwards; font-size: 24px; }
        @keyframes float { 0% { transform: translateY(0) scale(0.5); opacity: 1; } 100% { transform: translateY(-200px) scale(1.5); opacity: 0; } }

        /* Setup */
        #setup { position: fixed; inset: 0; background: #000; z-index: 200; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .preview { width: 80%; aspect-ratio: 9/16; background: #222; border-radius: 20px; overflow: hidden; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="home-feed">
        <div class="feed-header">
            <div class="logo">Edulinki<span>Live</span></div>
            <div class="avatar" style="background:#333">U</div>
        </div>
        <div class="grid" id="grid"></div>
        <button class="fab" onclick="openSetup()"><i data-lucide="plus"></i> GO LIVE</button>
    </div>

    <div id="setup">
        <div style="position:absolute; top:20px; right:20px" onclick="closeSetup()"><i data-lucide="x"></i></div>
        <div class="preview">
            <video id="previewVid" autoplay playsinline muted class="host-mirror"></video>
        </div>
        <input id="streamTitle" type="text" placeholder="Add a title..." style="background:#333; border:none; padding:15px; border-radius:10px; color:white; width:80%; margin-bottom:15px; outline:none;">
        <button onclick="startHosting()" style="background:var(--primary); border:none; padding:15px 40px; border-radius:30px; color:white; font-weight:bold; font-size:16px;">Start Live</button>
    </div>

    <div id="live-stage">
        <div id="video-layer"></div>
        
        <div id="ui-layer">
            <div class="top-bar">
                <div class="host-info">
                    <div class="avatar" id="hostIcon">H</div>
                    <div>
                        <div style="font-size:13px; font-weight:bold" id="hostName">Host</div>
                        <div style="font-size:10px; opacity:0.8"><span id="viewCount">0</span> Viewers</div>
                    </div>
                </div>
                <button class="icon-btn" onclick="leaveRoom()"><i data-lucide="x"></i></button>
            </div>

            <div class="hearts-box" id="hearts"></div>

            <div class="bottom-bar">
                <div class="chat-box" id="chat"></div>
                <div class="input-row">
                    <input id="msgInput" class="chat-input" placeholder="Say something..." autocomplete="off">
                    <button class="icon-btn" onclick="sendHeart()" style="background:linear-gradient(45deg, #ff0050, #00f2ea)"><i data-lucide="heart" fill="white"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, updateDoc, increment, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        lucide.createIcons();

        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const iceServers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] }] };

        // 2. STATE
        let localStream;
        let role = null; 
        let roomId = null;
        let myId = Math.random().toString(36).substr(2, 6).toUpperCase();
        let pcs = {}; // Store peer connections
        
        // 3. UI FUNCTIONS
        window.openSetup = async () => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
                document.getElementById('previewVid').srcObject = localStream;
                document.getElementById('home-feed').style.display = 'none';
                document.getElementById('setup').style.display = 'flex';
            } catch(e) { alert("Camera denied"); }
        }

        window.closeSetup = () => {
            if(localStream) localStream.getTracks().forEach(t=>t.stop());
            document.getElementById('setup').style.display = 'none';
            document.getElementById('home-feed').style.display = 'flex';
        }

        // 4. HOME FEED LISTENER
        onSnapshot(query(collection(db, "rooms"), where("status", "==", "live")), (snap) => {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement('div');
                div.className = 'card';
                div.onclick = () => joinStream(d.id, data);
                // Placeholder gradient BG
                const hue = parseInt(d.id, 36) % 360;
                div.innerHTML = `
                    <div style="width:100%; height:100%; background:linear-gradient(45deg, hsl(${hue}, 60%, 20%), #000);"></div>
                    <div class="card-badge">LIVE</div>
                    <div class="card-info">
                        <div style="font-weight:bold">${data.hostName}</div>
                        <div style="font-size:12px; opacity:0.8">${data.title}</div>
                    </div>
                `;
                grid.appendChild(div);
            });
            if(snap.empty) grid.innerHTML = '<div style="color:#666; width:200%; text-align:center; padding:50px;">No active streams</div>';
        });

        // 5. HOST LOGIC
        window.startHosting = async () => {
            const title = document.getElementById('streamTitle').value || "Chilling";
            roomId = myId;
            role = 'host';

            // Switch UI
            document.getElementById('setup').style.display = 'none';
            document.getElementById('live-stage').style.display = 'block';

            // Show Local Video
            const vid = document.createElement('video');
            vid.srcObject = localStream;
            vid.autoplay = true; vid.muted = true; vid.className = 'host-mirror';
            document.getElementById('video-layer').appendChild(vid);

            // DB Room
            await setDoc(doc(db, "rooms", roomId), {
                hostId: myId, hostName: "Host " + myId, title, status: 'live', viewers: 0
            });

            // Listen for Viewers
            listenForOffers();
            listenForInteractions();
        }

        function listenForOffers() {
            // Watch for offers from viewers
            onSnapshot(collection(db, `rooms/${roomId}/offers`), (snap) => {
                snap.docChanges().forEach(async change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        handleViewerJoin(data.from, data.offer);
                    }
                });
            });
        }

        async function handleViewerJoin(viewerId, offer) {
            console.log("Viewer Joining:", viewerId);
            const pc = new RTCPeerConnection(iceServers);
            pcs[viewerId] = pc;

            // Add Host Tracks
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            // ICE Handling
            pc.onicecandidate = e => {
                if(e.candidate) addDoc(collection(db, `rooms/${roomId}/candidates`), { 
                    candidate: e.candidate.toJSON(), to: viewerId, from: myId 
                });
            };

            await pc.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            // Send Answer
            await addDoc(collection(db, `rooms/${roomId}/answers`), {
                answer, to: viewerId, from: myId
            });
        }

        // 6. VIEWER LOGIC
        async function joinStream(id, data) {
            roomId = id;
            role = 'viewer';
            document.getElementById('home-feed').style.display = 'none';
            document.getElementById('live-stage').style.display = 'block';
            document.getElementById('hostName').innerText = data.hostName;

            await updateDoc(doc(db, "rooms", roomId), { viewers: increment(1) });
            
            const pc = new RTCPeerConnection(iceServers);
            pcs['host'] = pc;

            pc.addTransceiver('video', { direction: 'recvonly' });
            pc.addTransceiver('audio', { direction: 'recvonly' });

            pc.ontrack = e => {
                const vid = document.createElement('video');
                vid.srcObject = e.streams[0];
                vid.autoplay = true; vid.playsInline = true;
                document.getElementById('video-layer').innerHTML = '';
                document.getElementById('video-layer').appendChild(vid);
            };

            pc.onicecandidate = e => {
                if(e.candidate) addDoc(collection(db, `rooms/${roomId}/candidates`), { 
                    candidate: e.candidate.toJSON(), to: data.hostId, from: myId 
                });
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // Send Offer
            await addDoc(collection(db, `rooms/${roomId}/offers`), {
                offer, to: data.hostId, from: myId
            });

            // Listen for Answer
            onSnapshot(collection(db, `rooms/${roomId}/answers`), (snap) => {
                snap.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const d = change.doc.data();
                        if(d.to === myId) await pc.setRemoteDescription(new RTCSessionDescription(d.answer));
                    }
                });
            });

            // Listen for ICE
            onSnapshot(collection(db, `rooms/${roomId}/candidates`), (snap) => {
                snap.docChanges().forEach(async change => {
                    if(change.type === 'added') {
                        const d = change.doc.data();
                        if(d.to === myId) await pc.addIceCandidate(new RTCIceCandidate(d.candidate));
                    }
                });
            });

            listenForInteractions();
        }

        // 7. INTERACTIONS (Chat & Hearts)
        function listenForInteractions() {
            // Room Stats
            onSnapshot(doc(db, "rooms", roomId), (d) => {
                if(d.exists()) document.getElementById('viewCount').innerText = d.data().viewers;
                else if(role === 'viewer') { alert("Live Ended"); window.location.reload(); }
            });

            // Chat
            const chatBox = document.getElementById('chat');
            onSnapshot(query(collection(db, `rooms/${roomId}/chat`), orderBy('ts')), (snap) => {
                snap.docChanges().forEach(c => {
                    if(c.type === 'added') {
                        const d = c.doc.data();
                        const div = document.createElement('div');
                        div.className = 'msg';
                        div.innerText = `${d.name}: ${d.text}`;
                        chatBox.appendChild(div);
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                });
            });

            // Hearts
            onSnapshot(collection(db, `rooms/${roomId}/hearts`), (snap) => {
                snap.docChanges().forEach(c => {
                    if(c.type === 'added' && !c.doc.metadata.hasPendingWrites) spawnHeart();
                });
            });
        }

        document.getElementById('msgInput').onkeydown = async (e) => {
            if(e.key === 'Enter' && e.target.value.trim()) {
                await addDoc(collection(db, `rooms/${roomId}/chat`), {
                    name: role==='host' ? "Host" : "User", text: e.target.value, ts: Date.now()
                });
                e.target.value = '';
            }
        }

        window.sendHeart = async () => {
            spawnHeart();
            await addDoc(collection(db, `rooms/${roomId}/hearts`), { ts: Date.now() });
        }

        function spawnHeart() {
            const h = document.createElement('div');
            h.className = 'heart';
            h.innerText = ['â¤ï¸','ðŸ”¥','ðŸ˜'][Math.floor(Math.random()*3)];
            h.style.left = Math.random()*20 + 'px';
            document.getElementById('hearts').appendChild(h);
            setTimeout(() => h.remove(), 2000);
        }

        // 8. CLEANUP
        window.leaveRoom = async () => {
            if(role === 'host') {
                if(confirm("End Live?")) {
                    await updateDoc(doc(db, "rooms", roomId), { status: 'ended' });
                    window.location.reload();
                }
            } else {
                await updateDoc(doc(db, "rooms", roomId), { viewers: increment(-1) });
                window.location.reload();
            }
        }

    </script>
</body>
</html>
