<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Newton AI - Scholar & Code Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet">

<!-- Leaflet for Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- PDF.js for PDF Parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Initialize PDF.js worker
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<!-- PrismJS for Syntax Highlighting (Code Mode) -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-tsx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

<!-- TradingView Widget -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

<!-- KaTeX for Math Rendering -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    bgPrimary: '#FFFFFF',
                    bgSecondary: '#F9FAFB',
                    bgTertiary: '#F3F4F6',
                    textPrimary: '#111827',
                    textSecondary: '#374151',
                    accent: '#D97757',
                    accentBlue: '#2563EB',
                    accentGreen: '#10B981',
                    borderSubtle: '#E5E7EB',
                    scholarGold: '#B45309',
                    scholarBg: '#FFFBEB',
                    studyBg: '#ECFDF5',
                    studyBorder: '#A7F3D0',
                    codeBg: '#1e1e1e', /* Dark editor background */
                },
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    serif: ['Merriweather', 'serif'],
                    mono: ['JetBrains Mono', 'monospace'],
                },
                boxShadow: {
                    'soft': '0 2px 10px rgba(0, 0, 0, 0.03)',
                    'medium': '0 4px 20px rgba(0, 0, 0, 0.06)',
                    'float': '0 10px 40px -10px rgba(0,0,0,0.1)',
                }
            }
        }
    }
</script>

<style>
    :root {
        --scrollbar-width: 0px;
    }
    
    body {
        background-color: #F9FAFB;
        color: #111827;
        font-family: 'Inter', sans-serif;
        -webkit-font-smoothing: antialiased;
    }

    /* --- SCROLLBAR HIDING UTILITIES --- */
    ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Typography Override */
    .prose-content {
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        line-height: 1.6;
        color: #374151;
    }
    .prose-content p { margin-bottom: 1.25em; }
    .prose-content h1, .prose-content h2, .prose-content h3 { 
        font-family: 'Merriweather', serif; 
        font-weight: 700; 
        color: #111827; 
        margin-top: 1.5em; 
        margin-bottom: 0.75em; 
        letter-spacing: -0.02em;
    }
    .prose-content ul, .prose-content ol { margin-bottom: 1.25em; padding-left: 1.5em; list-style-type: disc; }
    .prose-content li { margin-bottom: 0.5em; }
    .prose-content strong { font-weight: 600; color: #111827; }
    .prose-content a { color: #2563EB; text-decoration: underline; text-underline-offset: 2px; }
    .prose-content blockquote { border-left: 3px solid #E5E7EB; padding-left: 1rem; color: #6B7280; margin-left: 0; }
    
    /* Code Blocks - Modern "Canvas" Style */
    .code-block-wrapper {
        background-color: #1e1e1e;
        border: 1px solid #333;
        border-radius: 8px;
        margin: 1.5em 0;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .code-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 16px;
        background-color: #252526;
        border-bottom: 1px solid #333;
        font-size: 0.75rem;
        color: #9CA3AF;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
    }
    .code-header-actions {
        display: flex;
        gap: 8px;
    }
    .code-action-btn {
        background: transparent;
        border: none;
        color: #9CA3AF;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .code-action-btn:hover {
        background: rgba(255,255,255,0.1);
        color: white;
    }
    .prose-content pre {
        margin: 0;
        padding: 16px;
        overflow-x: auto;
        background-color: #1e1e1e; /* Match wrapper */
        color: #d4d4d4; /* Default light text */
    }
    .prose-content code {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
        text-shadow: none; /* Remove Prism text shadow if any */
    }
    /* Inline code styling */
    .prose-content :not(pre) > code {
        background-color: #F3F4F6;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.85em;
        color: #D97757;
        font-weight: 500;
        border: 1px solid #E5E7EB;
        font-family: 'JetBrains Mono', monospace;
    }

    /* CODE PLAN CARD (Refined Prompt UI) */
    .code-plan-card {
        background: #F8FAFC;
        border: 1px solid #E2E8F0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
        border-left: 4px solid #6366F1; /* Indigo accent */
    }
    .code-plan-title {
        color: #4338CA;
        font-size: 0.8rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .code-plan-content {
        font-size: 0.9rem;
        color: #334155;
        line-height: 1.5;
    }
    .code-plan-content strong {
        color: #1E293B;
        font-weight: 600;
    }

    /* WEB GRID */
    .web-grid-wrapper { margin-bottom: 1.5rem; }
    .web-grid-header {
        display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
        font-size: 0.8rem; font-weight: 600; color: #4B5563; text-transform: uppercase; letter-spacing: 0.05em;
    }
    .web-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
    }
    .web-card {
        background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 12px;
        padding: 0; display: flex; flex-direction: column; text-decoration: none !important; color: inherit !important;
        transition: border-color 0.2s, box-shadow 0.2s; height: 100%; position: relative; overflow: hidden;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .web-card:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); border-color: #93C5FD; text-decoration: none !important; }
    .web-card-visual { height: 110px; width: 100%; object-fit: cover; background: #F8FAFC; border-bottom: 1px solid #E2E8F0; }
    .web-card-content { padding: 12px; display: flex; flex-direction: column; gap: 6px; }
    .web-card-top { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: #64748B; }
    .web-card-favicon { width: 14px; height: 14px; border-radius: 2px; }
    .web-card-source { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #475569; }
    .web-card-title {
        font-size: 0.9rem; font-weight: 600; color: #1E293B; line-height: 1.4;
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; font-family: 'Inter', sans-serif;
    }

    /* SCHOLAR CARD STYLING */
    .scholar-card {
        background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 12px; padding: 16px; margin-bottom: 16px;
        position: relative; z-index: 1; transition: border-color 0.2s, box-shadow 0.2s; margin-left: 2px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .scholar-card::before {
        content: ''; position: absolute; left: -24px; top: 24px; width: 10px; height: 10px;
        background: #FFFFFF; border: 2px solid #94A3B8; border-radius: 50%; z-index: 2;
    }
    .scholar-card::after {
        content: ''; position: absolute; left: -20px; top: 28px; width: 20px; height: 2px; background: #E2E8F0; z-index: 0;
    }
    .scholar-card:hover { border-color: #94A3B8; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); }
    .scholar-type {
        font-size: 0.65rem; font-weight: 700; text-transform: uppercase; color: #64748B;
        margin-bottom: 6px; letter-spacing: 0.05em; display: flex; align-items: center; gap: 6px;
    }
    .scholar-type i { color: #D97757; }
    .scholar-title {
        font-family: 'Inter', sans-serif; font-size: 1rem; font-weight: 600; color: #1E293B;
        margin-bottom: 4px; line-height: 1.4; display: flex; gap: 8px; align-items: flex-start;
    }
    .scholar-favicon { width: 16px; height: 16px; margin-top: 3px; border-radius: 2px; flex-shrink: 0; }
    .scholar-title a { color: #1E293B; text-decoration: none; }
    .scholar-title a:hover { color: #2563EB; }
    .scholar-authors { font-size: 0.85rem; color: #475569; margin-bottom: 8px; margin-left: 24px; }
    .scholar-journal {
        display: inline-block; font-size: 0.75rem; color: #334155; background: #F1F5F9;
        padding: 2px 8px; border-radius: 4px; font-weight: 500; margin-bottom: 10px;
        border: 1px solid #E2E8F0; margin-left: 24px;
    }
    .scholar-abstract { font-size: 0.85rem; color: #475569; line-height: 1.6; padding-top: 10px; border-top: 1px solid #E2E8F0; margin-left: 24px; }

    /* MEDIA & VISUALS */
    .media-scroll-container {
        display: flex;
        gap: 24px; /* Increased gap */
        overflow-x: auto;
        padding-bottom: 16px;
        margin: 24px 0;
    }
    
    .study-img-card {
        flex: 0 0 360px; /* BIGGER */
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        overflow: hidden;
        background: #FFF;
        position: relative;
        cursor: pointer;
        transition: box-shadow 0.2s;
    }
    .study-img-card:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
    .study-img {
        width: 100%;
        height: 240px; /* BIGGER */
        object-fit: cover;
        background: #F3F4F6;
    }
    .study-img-caption {
        font-size: 0.9rem; /* Larger Text */
        padding: 14px 16px;
        color: #4B5563;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        border-top: 1px solid #F3F4F6;
    }
    
    /* VIDEO CARD */
    .video-card {
        display: flex;
        flex-direction: column;
        text-decoration: none !important;
        background: #000;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        flex: 0 0 360px; /* BIGGER */
        transition: box-shadow 0.2s;
        cursor: pointer;
    }
    .video-card:hover { box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15); }
    .video-thumbnail-container {
        position: relative;
        width: 100%;
        height: 240px; /* BIGGER */
    }
    .video-thumbnail { width: 100%; height: 100%; object-fit: cover; opacity: 0.85; }
    .video-play-btn {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 56px; height: 56px; /* Larger Button */
        background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: white; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        font-size: 1.4rem;
    }
    .video-title {
        color: white; font-size: 0.9rem; padding: 16px; font-weight: 500; line-height: 1.4;
        background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
        position: absolute; bottom: 0; width: 100%;
    }

    /* PERPLEXITY-STYLE FOLLOW UP */
    .follow-up-section {
        margin-top: 24px; padding-top: 16px; border-top: 1px solid #E5E7EB;
        display: flex; flex-direction: column; gap: 8px;
    }
    .follow-up-header {
        font-size: 0.75rem; font-weight: 600; color: #9CA3AF;
        text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;
        display: flex; align-items: center; gap: 6px;
    }
    .follow-up-btn {
        width: 100%; text-align: left; padding: 10px 14px;
        background-color: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 8px;
        color: #374151; font-size: 0.9rem; font-weight: 500;
        transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
        display: flex; align-items: center; justify-content: space-between; cursor: pointer;
    }
    .follow-up-btn:hover {
        background-color: #FFFFFF; border-color: #D1D5DB;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); color: #111827;
    }
    .follow-up-btn i { color: #9CA3AF; font-size: 0.8rem; transition: transform 0.2s; }
    .follow-up-btn:hover i { color: #6B7280; transform: translateX(2px); }

    /* STEP DESIGN FOR STUDY MODE */
    .study-steps-container { position: relative; padding-left: 16px; margin-top: 16px; }
    .study-step-item { position: relative; padding-bottom: 24px; padding-left: 20px; border-left: 2px solid #E5E7EB; }
    .study-step-item:last-child { border-left: 2px solid transparent; }
    .study-step-number {
        position: absolute; left: -11px; top: 0; width: 20px; height: 20px;
        background: #10B981; color: white; border-radius: 50%; font-size: 0.7rem; font-weight: 700;
        display: flex; align-items: center; justify-content: center; border: 2px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .study-step-content { background: #F9FAFB; border: 1px solid #F3F4F6; border-radius: 8px; padding: 12px; }
    .study-step-title { font-weight: 600; color: #111827; font-size: 0.85rem; margin-bottom: 4px; display: block; }
    .study-step-text { font-size: 0.9rem; color: #374151; line-height: 1.5; }

    /* Thread Connector Lines */
    .message-row { position: relative; padding-bottom: 0; margin-bottom: 0; }
    .message-inner {
        position: relative; max-width: 48rem; margin-left: auto; margin-right: auto;
        padding-left: 1rem; padding-right: 0.5rem; display: flex; gap: 1.5rem; 
    }
    .thread-line {
        position: absolute; left: calc(1rem + 19px); top: 0; bottom: 0; width: 2px;
        background-color: #E5E7EB; z-index: 0;
    }
    .message-row:first-child .thread-line { top: 40px; }
    .message-row:last-child .thread-line { bottom: auto; height: 20px; }
    .avatar-container { position: relative; z-index: 10; width: 40px; height: 40px; flex-shrink: 0; }
    .message-content-box { padding-bottom: 32px; }

    /* MAP & PLACE CARD STYLING */
    .map-wrapper { margin-top: 1rem; margin-bottom: 1.5rem; border: 1px solid #E5E7EB; border-radius: 12px; overflow: hidden; background: #F9FAFB; }
    .map-header { padding: 10px 16px; background: #FFFFFF; border-bottom: 1px solid #E5E7EB; display: flex; justify-content: space-between; align-items: center; }
    .map-title { font-weight: 600; color: #111827; font-size: 0.9rem; display: flex; align-items: center; gap: 8px; }
    .interactive-map { height: 300px; width: 100%; background: #e5e7eb; z-index: 1; }
    
    /* Location Details Cards */
    .location-cards-container { display: flex; gap: 12px; padding: 12px; overflow-x: auto; background: #F9FAFB; border-top: 1px solid #E5E7EB; }
    .location-card { flex: 0 0 240px; background: white; border: 1px solid #E5E7EB; border-radius: 8px; overflow: hidden; transition: transform 0.2s; }
    .location-card:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .loc-img-wrapper { width: 100%; height: 140px; background: #F1F5F9; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
    .loc-img { width: 100%; height: 100%; object-fit: cover; }
    .loc-no-img { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; color: #94A3B8; font-size: 0.75rem; background: #F1F5F9; }
    .loc-info { padding: 12px; }
    .loc-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; color: #111827; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .loc-desc { font-size: 0.75rem; color: #6B7280; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 12px; line-height: 1.4; }
    .loc-actions { display: flex; gap: 4px; }
    .loc-btn { flex: 1; font-size: 0.75rem; padding: 6px; text-align: center; border-radius: 6px; text-decoration: none; font-weight: 500; transition: background 0.2s; }
    .btn-maps { background: #EFF6FF; color: #2563EB; }
    .btn-maps:hover { background: #DBEAFE; }

    /* Animations */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .msg-enter { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { animation: spin 1s linear infinite; }

    /* --- LANDING MODE STYLES --- */
    #input-area-wrapper { transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    .landing-mode #input-area-wrapper { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); width: 100%; max-width: 48rem; background: transparent; backdrop-filter: none; padding: 0 20px; }
    .landing-mode #main-input-container { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1), 0 10px 15px -3px rgba(0, 0, 0, 0.04); border-color: #E5E7EB; transform: scale(1.02); padding: 4px; }
    .landing-mode textarea { min-height: 80px; font-size: 1.125rem; padding: 1.5rem; }
    .landing-mode #chat-container { opacity: 0; pointer-events: none; }
    .landing-mode #landing-logo { display: flex; animation: fadeIn 0.8s ease-out; }
    .landing-mode #scroll-btn { display: none; }

    /* Normal State styles for Input Area */
    .input-area-shadow { box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s ease; }
    .input-area-shadow:focus-within { box-shadow: 0 0 0 2px rgba(217, 119, 87, 0.2), 0 4px 12px rgba(0,0,0,0.08); border-color: #D97757; background-color: #FFFFFF; }

    /* Mobile specific */
    @media (max-width: 768px) {
        .sidebar-overlay { background-color: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
        .message-inner { padding-left: 0.75rem; gap: 0.75rem; }
        .avatar-container { width: 32px; height: 32px; }
        .thread-line { left: calc(0.75rem + 15px); } 
        .message-row:first-child .thread-line { top: 32px; }
        .message-row:last-child .thread-line { height: 16px; }
        .landing-mode #input-area-wrapper { top: 40%; }
        .web-grid { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
    }
    
    .shimmer {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .mode-badge {
        font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; padding: 4px 10px;
        border-radius: 100px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;
    }
    
    .focus-menu-item {
        display: flex; align-items: center; gap: 8px; padding: 8px 12px;
        font-size: 0.85rem; color: #4B5563; border-radius: 6px; cursor: pointer;
        transition: all 0.2s; font-weight: 500;
    }
    .focus-menu-item:hover { background-color: #F3F4F6; color: #111827; }
    .focus-menu-item.active { background-color: #EFF6FF; color: #2563EB; }
    .focus-menu-item i { width: 16px; text-align: center; }

    /* Perplexity-style Attachment Preview */
    .attachment-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 8px 16px 16px 16px;
    }
    .attachment-card {
        position: relative;
        display: inline-flex;
        align-items: center;
        background: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 12px;
        padding: 8px;
        padding-right: 12px;
        gap: 12px;
        min-width: 180px;
        max-width: 260px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .attachment-card:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        border-color: #D1D5DB;
        transform: translateY(-1px);
    }
    .attachment-thumb {
        width: 48px; height: 48px; border-radius: 8px; object-fit: cover;
        background-color: #F3F4F6; border: 1px solid rgba(0,0,0,0.04);
    }
    .attachment-icon-placeholder {
        width: 48px; height: 48px; border-radius: 8px;
        background-color: #F3F4F6; color: #6B7280;
        display: flex; align-items: center; justify-content: center;
        font-size: 1.5rem;
        border: 1px solid rgba(0,0,0,0.04);
    }
    .attachment-info {
        display: flex; flex-direction: column;
        justify-content: center;
        flex: 1;
        min-width: 0;
        line-height: 1.3;
    }
    .attachment-name {
        font-size: 0.85rem; font-weight: 600; color: #1F2937; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .attachment-type {
        font-size: 0.75rem; color: #6B7280; font-weight: 500;
    }
    .attachment-remove-btn {
        width: 24px; height: 24px;
        display: flex; align-items: center; justify-content: center;
        color: #9CA3AF; cursor: pointer; border-radius: 50%;
        transition: all 0.2s; font-size: 0.9rem;
    }
    .attachment-remove-btn:hover { 
        background-color: #FEE2E2; color: #EF4444; 
    }

    /* TradingView Widget Container */
    .tradingview-widget-container {
        height: 400px;
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1.5rem;
        border: 1px solid #E5E7EB;
    }

    /* Thinking Accordion (Perplexity Style) */
    .thinking-accordion {
        margin-bottom: 16px;
        border-left: 2px solid #E5E7EB;
        padding-left: 12px;
    }
    .thinking-accordion[open] .thinking-summary {
        margin-bottom: 8px;
    }
    .thinking-summary {
        cursor: pointer;
        font-size: 0.8rem;
        color: #6B7280;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
        list-style: none;
    }
    .thinking-summary::-webkit-details-marker {
        display: none;
    }
    .thinking-summary:hover {
        color: #374151;
    }
    .thinking-summary::before {
        content: '\f0da'; /* FontAwesome caret right */
        font-family: 'Font Awesome 6 Free';
        font-weight: 900;
        transition: transform 0.2s;
        font-size: 0.8rem;
    }
    .thinking-accordion[open] .thinking-summary::before {
        transform: rotate(90deg);
    }
    .thinking-content {
        font-size: 0.85rem;
        color: #4B5563;
        line-height: 1.5;
        background: #F9FAFB;
        padding: 12px;
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
    }
    
    /* Better Attachment Links (No Underline) */
    a.attachment-link-card {
        text-decoration: none !important;
        transition: all 0.2s;
        background-color: #F9FAFB;
    }
    a.attachment-link-card:hover {
        background-color: #F3F4F6;
        border-color: #D1D5DB;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    a.attachment-link-card span {
        text-decoration: none !important;
    }

</style>
</head>
<body class="h-screen flex overflow-hidden bg-bgSecondary">

<!-- Overlay Modal -->
<div id="media-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black/95 backdrop-blur-md opacity-0 transition-opacity duration-300" onclick="closeModal()">
    <div class="relative w-full h-full flex flex-col items-center justify-center p-0" onclick="event.stopPropagation()">
        <!-- Close Button -->
        <button class="absolute top-4 right-4 z-50 w-12 h-12 flex items-center justify-center rounded-full bg-black/40 hover:bg-black/60 text-white transition-colors border border-white/20 shadow-lg backdrop-blur-sm" onclick="closeModal()">
            <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
        
        <!-- Image Container -->
        <img id="modal-img" class="max-h-[98vh] max-w-[98vw] h-auto w-auto rounded-md shadow-2xl object-contain hidden transition-transform duration-300">
        
        <!-- Caption Overlay -->
        <p id="modal-caption" class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/95 text-center font-medium text-lg max-w-2xl bg-black/60 px-6 py-2 rounded-full backdrop-blur-sm border border-white/10 pointer-events-none"></p>
    </div>
</div>

<!-- HTML Preview Modal (For Code Mode) -->
<div id="preview-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm transition-opacity duration-200">
    <div class="bg-white rounded-lg shadow-2xl w-[90vw] h-[85vh] relative flex flex-col overflow-hidden">
        <div class="h-10 bg-gray-100 border-b border-gray-200 flex items-center justify-between px-4">
            <span class="text-sm font-semibold text-gray-600 flex items-center gap-2"><i class="fa-solid fa-eye"></i> Live Preview</span>
            <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-800"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <iframe id="preview-frame" class="w-full h-full bg-white"></iframe>
    </div>
</div>

<!-- URL Input Modal -->
<div id="url-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/40 backdrop-blur-sm transition-opacity duration-200">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="url-modal-content">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <i class="fa-solid fa-link text-gray-500"></i> Add Link
        </h3>
        <input type="text" id="url-input-field" class="w-full border border-gray-300 rounded-xl px-4 py-3 text-base focus:outline-none focus:border-gray-400 focus:ring-2 focus:ring-gray-100 transition-all mb-2" placeholder="https://example.com" onkeydown="if(event.key === 'Enter') confirmUrlInput()">
        <p class="text-xs text-gray-500 mb-6 ml-1">Paste a URL for the AI to analyze.</p>
        <div class="flex justify-end gap-3">
            <button onclick="closeUrlModal()" class="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 font-medium transition-colors">Cancel</button>
            <button onclick="confirmUrlInput()" class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-900 text-white font-medium shadow-md transition-colors">Add Link</button>
        </div>
    </div>
</div>

<!-- Sidebar Overlay for Mobile -->
<div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 sidebar-overlay z-40 hidden md:hidden"></div>

<!-- Sidebar -->
<aside id="sidebar" class="fixed md:relative w-[280px] h-full bg-[#F9FAFB] border-r border-[#E5E5E5] flex flex-col transform -translate-x-full md:translate-x-0 transition-transform duration-300 z-50">
    <!-- Brand -->
    <div class="p-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-textPrimary rounded-lg flex items-center justify-center text-white">
                <i class="fa-solid fa-cube text-sm"></i>
            </div>
            <span class="font-serif font-bold text-lg tracking-tight text-textPrimary">Newton</span>
        </div>
        <button class="md:hidden text-textSecondary" onclick="toggleSidebar()">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

    <!-- New Chat Button -->
    <div class="px-4 mb-4">
        <button onclick="startNewChat()" class="w-full bg-white hover:bg-gray-50 border border-gray-200 text-textPrimary font-medium py-3 px-4 rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 group">
            <i class="fa-solid fa-plus text-accent group-hover:scale-110 transition-transform"></i>
            <span>New Thread</span>
        </button>
    </div>

    <!-- History -->
    <div class="flex-1 overflow-y-auto px-4 py-2 space-y-1 no-scrollbar" id="history-list"></div>

    <!-- User Profile Bottom -->
    <div class="p-4 border-t border-gray-200 bg-[#F9FAFB]">
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors group">
            <img src="https://ui-avatars.com/api/?name=User&background=374151&color=fff" class="w-8 h-8 rounded-full shadow-sm ring-2 ring-transparent group-hover:ring-gray-300 transition-all">
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-textPrimary truncate">Professional Plan</p>
                <p class="text-xs text-textSecondary truncate">user@example.com</p>
            </div>
            <i class="fa-solid fa-gear text-textSecondary hover:text-textPrimary text-xs"></i>
        </div>
    </div>
</aside>

<!-- Main Content -->
<main id="main-container" class="flex-1 flex flex-col h-full relative bg-white w-full">
    <!-- Header -->
    <header class="h-16 border-b border-gray-100 flex items-center justify-between px-4 md:px-8 bg-white/80 backdrop-blur-md sticky top-0 z-30">
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="md:hidden text-textSecondary hover:text-textPrimary">
                <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="flex items-center gap-2 cursor-pointer hover:bg-gray-50 px-2 py-1 rounded-lg transition-colors border border-transparent hover:border-gray-200" id="model-selector">
                <span class="text-sm font-medium text-textSecondary">Model:</span>
                <span class="text-sm font-bold text-textPrimary">Newton (OpenAI)</span>
                <i class="fa-solid fa-chevron-down text-xs text-gray-400"></i>
            </div>
        </div>
        <div class="flex items-center gap-4">
             <button onclick="toggleScholarMode()" id="header-scholar-btn" class="text-gray-400 hover:text-accent transition-colors text-sm font-medium flex items-center gap-2">
                <i class="fa-solid fa-graduation-cap"></i> <span class="hidden sm:inline">Scholar</span>
            </button>
            <button class="text-gray-400 hover:text-textPrimary transition-colors">
                <i class="fa-regular fa-star"></i>
            </button>
        </div>
    </header>

    <!-- Chat Area -->
    <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth bg-white no-scrollbar">
        <div id="messages-list" class="max-w-4xl mx-auto pb-12 hidden"></div>
        <div id="scroll-anchor" class="h-8"></div>
    </div>

    <!-- Input Area Wrapper -->
    <div id="input-area-wrapper" class="w-full bg-white/90 backdrop-blur-sm pt-2 pb-6 px-4 z-20">
        <div class="max-w-3xl mx-auto relative">
            
            <!-- Landing Logo -->
            <div id="landing-logo" class="hidden flex-col items-center justify-center mb-8 gap-4">
                <div class="w-16 h-16 bg-[#F3F2F0] rounded-2xl flex items-center justify-center shadow-inner border border-white">
                    <i class="fa-solid fa-cube text-3xl text-textPrimary"></i>
                </div>
                <h1 class="text-3xl font-serif font-bold text-textPrimary tracking-tight">Newton AI</h1>
            </div>

            <!-- Scroll to bottom -->
            <button id="scroll-btn" onclick="scrollToBottom()" class="absolute -top-12 left-1/2 -translate-x-1/2 bg-white border border-gray-200 shadow-lg rounded-full w-8 h-8 flex items-center justify-center text-gray-500 hover:text-textPrimary hidden z-10">
                <i class="fa-solid fa-arrow-down"></i>
            </button>

            <!-- Focus Menu (Web Search) -->
            <div id="web-search-menu" class="absolute bottom-16 left-32 bg-white border border-gray-200 shadow-xl rounded-xl p-2 min-w-[180px] hidden z-50 flex flex-col gap-1 transform transition-all duration-200 origin-bottom-left">
                <div onclick="setWebFocus('all')" class="focus-menu-item active" data-focus="all">
                    <i class="fa-solid fa-globe text-gray-500"></i> Websites (All)
                </div>
                <div onclick="setWebFocus('social')" class="focus-menu-item" data-focus="social">
                    <i class="fa-solid fa-hashtag text-gray-500"></i> Social Media
                </div>
                <div onclick="setWebFocus('finance')" class="focus-menu-item" data-focus="finance">
                    <i class="fa-solid fa-chart-line text-gray-500"></i> Finance
                </div>
                <div onclick="setWebFocus('academic')" class="focus-menu-item" data-focus="academic">
                    <i class="fa-solid fa-graduation-cap text-gray-500"></i> Academic
                </div>
            </div>

             <!-- Attachment Menu -->
            <div id="attachment-menu" class="absolute bottom-16 left-4 bg-white border border-gray-200 shadow-xl rounded-xl p-2 min-w-[160px] hidden z-50 flex flex-col gap-1 transform transition-all duration-200 origin-bottom-left">
                <div onclick="selectAttachment('device')" class="focus-menu-item">
                    <i class="fa-regular fa-folder-open text-gray-500"></i> Upload Files
                </div>
                <div onclick="selectAttachment('link')" class="focus-menu-item">
                    <i class="fa-solid fa-link text-gray-500"></i> Add Link
                </div>
            </div>

            <!-- Input Container -->
            <div class="input-area-shadow bg-white border border-gray-200 rounded-2xl overflow-hidden transition-all duration-200" id="main-input-container">
                <div id="active-mode-badge" class="hidden px-4 pt-3 pb-0 flex flex-wrap gap-2"></div>
                
                <!-- Attachment Preview -->
                <div id="attachment-preview" class="hidden attachment-preview-container"></div>

                <textarea id="user-input" rows="1" class="w-full p-4 max-h-[200px] outline-none text-textPrimary placeholder-gray-400 resize-none bg-transparent font-sans text-base" placeholder="Ask anything..." oninput="autoResize(this)" onkeydown="handleKeydown(event)"></textarea>
                
                <div class="flex items-center justify-between px-3 pb-3">
                    <div class="flex items-center gap-1">
                        <button onclick="toggleAttachmentMenu()" id="btn-attach" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-textPrimary hover:bg-gray-100 transition-colors" title="Attach"><i class="fa-solid fa-paperclip"></i></button>
                        <!-- Added 'multiple' attribute for multi-file support -->
                        <input type="file" id="file-upload" class="hidden" accept="image/*,application/pdf" multiple onchange="handleFileUpload(this)">
                        <div class="h-5 w-[1px] bg-gray-200 mx-1"></div>
                        <button onclick="toggleWebSearch()" id="toolbar-web-btn" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-50 transition-colors relative" title="Web Search"><i class="fa-solid fa-globe"></i></button>
                        <button onclick="toggleScholarMode()" id="toolbar-scholar-btn" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-50 transition-colors" title="Scholar Mode"><i class="fa-solid fa-graduation-cap"></i></button>
                        <button onclick="toggleIdeaMode()" id="toolbar-idea-btn" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-50 transition-colors" title="Idea Mode"><i class="fa-regular fa-lightbulb"></i></button>
                        <button onclick="toggleStudyMode()" id="toolbar-study-btn" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-50 transition-colors" title="Study Mode"><i class="fa-solid fa-microscope"></i></button>
                        <button onclick="toggleCodeMode()" id="toolbar-code-btn" class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-700 hover:bg-gray-50 transition-colors" title="Code Canvas"><i class="fa-solid fa-code"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                         <span id="char-count" class="text-xs text-gray-300 font-mono hidden sm:inline">0</span>
                         <button onclick="checkLocationAndSend()" id="send-btn" class="bg-[#D97757] hover:bg-[#C26345] text-white rounded-lg px-3 py-1.5 transition-colors disabled:opacity-50 disabled:cursor-not-allowed shadow-sm flex items-center justify-center gap-2">
                            <span class="text-sm font-semibold">Run</span>
                            <i class="fa-solid fa-arrow-up text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- JS Logic -->
<script>
    
    // State
    let chats = JSON.parse(localStorage.getItem('newton_chats')) || [];
    let currentChatId = null;
    let isScholarMode = false;
    let isWebSearchMode = false;
    let isIdeaMode = false;
    let isStudyMode = false;
    let isCodeMode = false;
    let webSearchFocus = 'all'; // all, social, finance, academic
    
    // Updated: Array to store multiple attachments
    let attachments = []; 
    // Structure: { id: string, type: 'image'|'pdf'|'link', data: string (base64 or text), name: string }

    const mapsStore = {}; 
    const mapMarkersStore = {};
    const previewStore = {}; // NEW: Store preview content

    // --- Modal Logic ---
    function openImageModal(src, caption) {
        const modal = document.getElementById('media-modal');
        const img = document.getElementById('modal-img');
        const cap = document.getElementById('modal-caption');
        
        img.src = src;
        img.classList.remove('hidden');
        if(caption) {
            cap.innerText = caption;
            cap.classList.remove('hidden');
        } else {
            cap.innerText = '';
            cap.classList.add('hidden');
        }
        
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
        });
    }

    function closeModal() {
        const modal = document.getElementById('media-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('modal-img').src = '';
        }, 300);
    }

    // --- Preview Modal Logic (Refined) ---
    function openPreviewModal(previewId) {
        const modal = document.getElementById('preview-modal');
        const frame = document.getElementById('preview-frame');
        
        const htmlContent = previewStore[previewId];
        if (!htmlContent) return;

        // Write content to iframe
        const doc = frame.contentDocument || frame.contentWindow.document;
        doc.open();
        doc.write(htmlContent);
        doc.close();

        modal.classList.remove('hidden');
        setTimeout(() => modal.classList.remove('opacity-0'), 10);
    }

    function closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            const frame = document.getElementById('preview-frame');
            frame.src = 'about:blank'; // Clear content
        }, 200);
    }

    // --- URL Modal Logic ---
    function openUrlModal() {
        const modal = document.getElementById('url-modal');
        const content = document.getElementById('url-modal-content');
        const input = document.getElementById('url-input-field');
        
        input.value = '';
        modal.classList.remove('hidden');
        // Small delay to allow display block to apply before opacity transition
        requestAnimationFrame(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
            input.focus();
        });
    }

    function closeUrlModal() {
        const modal = document.getElementById('url-modal');
        const content = document.getElementById('url-modal-content');
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }

    function confirmUrlInput() {
        const input = document.getElementById('url-input-field');
        const url = input.value.trim();
        
        if (url && url.length > 0) {
            let validUrl = url;
            if (!validUrl.startsWith('http')) {
                validUrl = 'https://' + validUrl;
            }
            // Add Link to Attachments Array
            attachments.push({
                id: Date.now().toString() + Math.random(),
                type: 'link',
                data: validUrl, // For link, data is the URL
                name: (new URL(validUrl)).hostname
            });
            renderAttachmentPreview();
            closeUrlModal();
        }
    }

    // --- Core Functions ---

    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const ov = document.getElementById('sidebar-overlay');
        if (sb.classList.contains('-translate-x-full')) {
            sb.classList.remove('-translate-x-full');
            ov.classList.remove('hidden');
        } else {
            sb.classList.add('-translate-x-full');
            ov.classList.add('hidden');
        }
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
        document.getElementById('char-count').innerText = el.value.length;
    }

    function handleKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            checkLocationAndSend();
        }
    }

    function setInput(text) {
        const el = document.getElementById('user-input');
        el.value = text;
        autoResize(el);
        el.focus();
    }

    function useFollowUp(text) {
        const input = document.getElementById('user-input');
        input.value = text;
        checkLocationAndSend();
    }

    function updateModeUI() {
        const badge = document.getElementById('active-mode-badge');
        const scholarBtn = document.getElementById('toolbar-scholar-btn');
        const webBtn = document.getElementById('toolbar-web-btn');
        const ideaBtn = document.getElementById('toolbar-idea-btn');
        const studyBtn = document.getElementById('toolbar-study-btn');
        const codeBtn = document.getElementById('toolbar-code-btn');
        const headScholarBtn = document.getElementById('header-scholar-btn');
        const input = document.getElementById('user-input');

        // Reset UI
        const defaultClass = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-gray-900 hover:bg-gray-100 transition-colors";
        scholarBtn.className = defaultClass;
        webBtn.className = defaultClass + " relative";
        ideaBtn.className = defaultClass;
        studyBtn.className = defaultClass;
        codeBtn.className = defaultClass;

        headScholarBtn.classList.remove('text-[#D97757]');
        
        badge.innerHTML = '';
        badge.classList.add('hidden');
        input.placeholder = "Ask anything...";

        if (isScholarMode) {
            isWebSearchMode = false; isIdeaMode = false; isStudyMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#FFF4F0] text-[#D97757] border border-[#FED7AA]"><i class="fa-solid fa-graduation-cap"></i> Scholar Mode</span>`;
            badge.classList.remove('hidden');
            scholarBtn.className = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-900 bg-gray-100 transition-colors";
            headScholarBtn.classList.add('text-[#D97757]');
            input.placeholder = "Ask a research question...";
        }

        if (isWebSearchMode) {
            isScholarMode = false; isIdeaMode = false; isStudyMode = false; isCodeMode = false;
            let focusIcon = 'fa-globe';
            let focusColor = 'text-gray-900';
            let focusText = 'Web Search';
            
            if(webSearchFocus === 'social') { focusIcon = 'fa-hashtag'; focusColor = 'text-gray-900'; focusText = 'Social Search'; }
            if(webSearchFocus === 'finance') { focusIcon = 'fa-chart-line'; focusColor = 'text-gray-900'; focusText = 'Finance Search'; }
            if(webSearchFocus === 'academic') { focusIcon = 'fa-graduation-cap'; focusColor = 'text-gray-900'; focusText = 'Academic Search'; }

            badge.innerHTML += `<span class="mode-badge bg-gray-50 ${focusColor} border border-gray-200"><i class="fa-solid ${focusIcon}"></i> ${focusText}</span>`;
            badge.classList.remove('hidden');
            webBtn.className = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-900 bg-gray-100 transition-colors relative";
            input.placeholder = "Search the web...";
        }
        
        if (isIdeaMode) {
            isScholarMode = false; isWebSearchMode = false; isStudyMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#FFF4F0] text-[#D97757] border border-[#FED7AA]"><i class="fa-regular fa-lightbulb"></i> Startup Blueprint</span>`;
            badge.classList.remove('hidden');
            ideaBtn.className = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-900 bg-gray-100 transition-colors";
            input.placeholder = "Describe your startup idea...";
        }

        if (isStudyMode) {
            isScholarMode = false; isWebSearchMode = false; isIdeaMode = false; isCodeMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#ECFDF5] text-[#059669] border border-[#A7F3D0]"><i class="fa-solid fa-microscope"></i> Study Mode</span>`;
            badge.classList.remove('hidden');
            studyBtn.className = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-900 bg-gray-100 transition-colors";
            input.placeholder = "Enter a complex math problem or science topic...";
        }

        if (isCodeMode) {
            isScholarMode = false; isWebSearchMode = false; isIdeaMode = false; isStudyMode = false;
            badge.innerHTML += `<span class="mode-badge bg-[#312e81] text-indigo-100 border border-indigo-500"><i class="fa-solid fa-code"></i> Code Canvas</span>`;
            badge.classList.remove('hidden');
            codeBtn.className = "w-8 h-8 flex items-center justify-center rounded-lg text-gray-900 bg-gray-100 transition-colors";
            input.placeholder = "Describe the app or script you want to build...";
        }
    }

    function toggleScholarMode() { isScholarMode = !isScholarMode; if(isScholarMode) resetOtherModes('scholar'); updateModeUI(); closeWebMenu(); }
    function toggleIdeaMode() { isIdeaMode = !isIdeaMode; if(isIdeaMode) resetOtherModes('idea'); updateModeUI(); closeWebMenu(); }
    function toggleStudyMode() { isStudyMode = !isStudyMode; if(isStudyMode) resetOtherModes('study'); updateModeUI(); closeWebMenu(); }
    function toggleCodeMode() { isCodeMode = !isCodeMode; if(isCodeMode) resetOtherModes('code'); updateModeUI(); closeWebMenu(); }

    function resetOtherModes(current) {
        if(current !== 'scholar') isScholarMode = false;
        if(current !== 'web') isWebSearchMode = false;
        if(current !== 'idea') isIdeaMode = false;
        if(current !== 'study') isStudyMode = false;
        if(current !== 'code') isCodeMode = false;
    }
    
    // Updated Logic for Web Search Toggle
    function toggleWebSearch() {
        const menu = document.getElementById('web-search-menu');
        
        // If mode is already ON, turn it OFF.
        if (isWebSearchMode) {
            isWebSearchMode = false;
            updateModeUI();
            closeWebMenu();
            return;
        }

        // If mode is OFF, open the MENU to select focus.
        if (menu.classList.contains('hidden')) {
            menu.classList.remove('hidden');
            document.querySelectorAll('.focus-menu-item').forEach(el => {
                if(el.dataset.focus === 'all') el.classList.add('active');
                else el.classList.remove('active');
            });
        } else {
            menu.classList.add('hidden');
        }
    }
    
    function setWebFocus(focus) {
        webSearchFocus = focus;
        isWebSearchMode = true;
        resetOtherModes('web');
        
        // Update menu active states
        document.querySelectorAll('.focus-menu-item').forEach(el => {
            if(el.dataset.focus === focus) el.classList.add('active');
            else el.classList.remove('active');
        });

        updateModeUI();
        closeWebMenu();
    }

    function closeWebMenu() {
        document.getElementById('web-search-menu').classList.add('hidden');
    }
    
    // Attachment Menu Functions
    function toggleAttachmentMenu() {
        const menu = document.getElementById('attachment-menu');
        if (menu.classList.contains('hidden')) {
            menu.classList.remove('hidden');
        } else {
            menu.classList.add('hidden');
        }
    }

    function selectAttachment(type) {
        const menu = document.getElementById('attachment-menu');
        menu.classList.add('hidden');
        
        if (type === 'device') {
            document.getElementById('file-upload').click();
        } else if (type === 'link') {
            openUrlModal();
        }
    }

    // Close menu when clicking outside
    document.addEventListener('click', function(event) {
        const webMenu = document.getElementById('web-search-menu');
        const webBtn = document.getElementById('toolbar-web-btn');
        if (!webMenu.contains(event.target) && !webBtn.contains(event.target)) {
            webMenu.classList.add('hidden');
        }

        const attachMenu = document.getElementById('attachment-menu');
        const attachBtn = document.getElementById('btn-attach');
        if (!attachMenu.contains(event.target) && !attachBtn.contains(event.target)) {
            attachMenu.classList.add('hidden');
        }
        
        const urlModal = document.getElementById('url-modal');
        const urlContent = document.getElementById('url-modal-content');
        if(urlModal.contains(event.target) && !urlContent.contains(event.target) && !urlModal.classList.contains('hidden')) {
            closeUrlModal();
        }
        
        const previewModal = document.getElementById('preview-modal');
        if(previewModal.contains(event.target) && !previewModal.children[0].contains(event.target) && !previewModal.classList.contains('hidden')) {
            closePreviewModal();
        }
    });

    // --- Layout State Management ---

    function setLandingMode(enabled) {
        const main = document.getElementById('main-container');
        if (enabled) {
            main.classList.add('landing-mode');
            document.getElementById('messages-list').classList.add('hidden');
        } else {
            main.classList.remove('landing-mode');
            document.getElementById('messages-list').classList.remove('hidden');
        }
    }

    // --- Chat Logic ---

    function renderHistory() {
        const list = document.getElementById('history-list');
        list.innerHTML = '';
        
        const now = new Date();
        const todayChats = [];
        const oldChats = [];

        chats.forEach(chat => {
            const date = new Date(parseInt(chat.id));
            if (date.toDateString() === now.toDateString()) {
                todayChats.push(chat);
            } else {
                oldChats.push(chat);
            }
        });

        const createGroup = (label, items) => {
            if(items.length === 0) return;
            const header = document.createElement('div');
            header.className = "text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4 mb-2 px-2";
            header.innerText = label;
            list.appendChild(header);
            items.forEach(c => createItem(c));
        };

        const createItem = (chat) => {
            const btn = document.createElement('button');
            const isActive = chat.id === currentChatId;
            btn.className = `w-full text-left py-2 px-3 rounded-lg text-sm truncate transition-colors flex items-center gap-2 group relative ${isActive ? 'bg-gray-200 text-textPrimary font-medium' : 'text-textSecondary hover:bg-gray-100'}`;
            btn.onclick = () => loadChat(chat.id);
            btn.innerHTML = `
                <span class="truncate flex-1">${chat.title}</span>
                <i class="fa-solid fa-trash text-gray-400 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-all text-xs z-10 p-1" onclick="deleteChat(event, '${chat.id}')"></i>
            `;
            list.appendChild(btn);
        };

        createGroup('Today', todayChats.reverse());
        createGroup('Previous', oldChats.reverse());
    }

    function startNewChat() {
        currentChatId = Date.now().toString();
        const newChat = { id: currentChatId, title: 'New Conversation', messages: [] };
        chats.push(newChat);
        localStorage.setItem('newton_chats', JSON.stringify(chats));
        renderHistory();
        setLandingMode(true);
        document.getElementById('messages-list').innerHTML = '';
        document.getElementById('user-input').value = '';
        document.getElementById('user-input').focus();
        isWebSearchMode = false;
        isScholarMode = false;
        isIdeaMode = false;
        isStudyMode = false;
        isCodeMode = false;
        webSearchFocus = 'all';
        clearAttachments();
        updateModeUI();
    }

    function loadChat(id) {
        currentChatId = id;
        const chat = chats.find(c => c.id === id);
        if (!chat) return;
        setLandingMode(false);
        document.getElementById('messages-list').innerHTML = '';
        chat.messages.forEach(msg => renderMessage(msg));
        renderHistory();
        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('-translate-x-full');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }
        clearAttachments();
        scrollToBottom();
    }

    function deleteChat(e, id) {
        e.stopPropagation();
        chats = chats.filter(c => c.id !== id);
        localStorage.setItem('newton_chats', JSON.stringify(chats));
        if (currentChatId === id) startNewChat();
        else renderHistory();
    }

    function scrollToBottom() {
        setTimeout(() => {
            const anchor = document.getElementById('scroll-anchor');
            anchor.scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    // --- MAP FUNCTIONS ---
    function findNearMe(mapId, originalQuery) {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser.");
            return;
        }

        const map = mapsStore[mapId];
        if(!map) return;

        // Improved Geolocation Call
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const userLatLng = L.latLng(lat, lon);

            // Add User Marker
            L.circleMarker([lat, lon], {
                radius: 8,
                fillColor: "#3b82f6",
                color: "#fff",
                weight: 2,
                opacity: 1,
                fillOpacity: 1
            }).addTo(map).bindPopup("You are here").openPopup();

            const markers = mapMarkersStore[mapId] || [];
            let closestDistance = Infinity;
            let closestMarker = null;

            markers.forEach(m => {
                const dist = userLatLng.distanceTo(m.getLatLng()); 
                if(dist < closestDistance) {
                    closestDistance = dist;
                    closestMarker = m;
                }
            });

            if (closestDistance > 20000) {
                 document.getElementById('user-input').value = originalQuery; 
                 checkLocationAndSend(); 
            } else if (closestMarker) {
                const bounds = L.latLngBounds([userLatLng, closestMarker.getLatLng()]);
                map.fitBounds(bounds, { padding: [100, 100], maxZoom: 16 });
            } else {
                 map.setView([lat, lon], 14);
            }
        }, 
        () => alert("Unable to retrieve your location. Check browser permissions."),
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
        });
    }
    
    function measureDistance(mapId) {
         if (!navigator.geolocation) {
            alert("Geolocation is not supported.");
            return;
        }
        const map = mapsStore[mapId];
        if(!map) return;
        
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const userLatLng = L.latLng(lat, lon);
            
            // Add User Marker
            L.circleMarker([lat, lon], {
                radius: 6, fillColor: "#10b981", color: "#fff", weight: 2, opacity: 1, fillOpacity: 1
            }).addTo(map).bindPopup("You").openPopup();

            const markers = mapMarkersStore[mapId] || [];
            if(markers.length > 0) {
                // Measure to the first/primary result
                const target = markers[0].getLatLng();
                const dist = (userLatLng.distanceTo(target) / 1000).toFixed(2);
                
                L.polyline([userLatLng, target], {color: '#10b981', dashArray: '5, 10'}).addTo(map)
                 .bindPopup(`Distance: ${dist} km`).openPopup();
                 
                const bounds = L.latLngBounds([userLatLng, target]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        },
        () => alert("Unable to get high accuracy location."),
        {
            enableHighAccuracy: true,
            timeout: 10000
        });
    }

    function cleanSearchQuery(text) {
        let clean = text.toLowerCase();
        const removePhrases = [
            "i want to visit", "i want to go to", "i'm looking for", "i am looking for", "find me", "show me", "where is", "where's", 
            "nearest", "nearby", "near me", "near", "closest", "in my location", "my location", "location", "please", 
            "is there a", "are there any", "can you find", "search for", "the"
        ];
        removePhrases.forEach(phrase => { clean = clean.replace(new RegExp(phrase, 'g'), ''); });
        clean = clean.replace(/[?.!,]/g, '');
        return clean.trim();
    }

    // --- Search Real Places (Nominatim) ---
    async function searchRealPlaces(query, lat, lon) {
        try {
            let keyword = cleanSearchQuery(query);
            if (!keyword || keyword.length < 3 || keyword === 'it') {
                if (keyword === 'it') return [];
            }
            if (!keyword) keyword = "places";

            let url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(keyword)}&format=json&limit=5&addressdetails=1`;
            if (lat && lon) {
                const delta = 0.05; 
                url += `&viewbox=${lon-delta},${lat+delta},${lon+delta},${lat-delta}&bounded=1`;
            }
            const res = await fetch(url, { headers: { 'User-Agent': 'NewtonAI/1.0' } });
            const data = await res.json();
            
            if (data && data.length > 0) {
                return data.map(place => ({
                    name: place.name || place.display_name.split(',')[0],
                    lat: parseFloat(place.lat),
                    lon: parseFloat(place.lon),
                    desc: place.display_name,
                    city: place.address ? (place.address.city || place.address.town || place.address.village) : ''
                }));
            }
            return null;
        } catch(e) {
            return null;
        }
    }

    // --- Thread Rendering ---
    function tryParseJSONBlock(str) {
        const start = str.indexOf('{');
        if (start === -1) return null;
        let depth = 0;
        for (let i = start; i < str.length; i++) {
            if (str[i] === '{') depth++;
            else if (str[i] === '}') {
                depth--;
                if (depth === 0) {
                    try {
                        const jsonStr = str.substring(start, i + 1);
                        // Basic validation to ensure it's not just a small random object
                        const parsed = JSON.parse(jsonStr);
                        if(parsed && (parsed.title || parsed.roadmap || parsed.goals || parsed.subject)) {
                            return { data: parsed, fullMatch: jsonStr };
                        }
                    } catch (e) { }
                    return null; 
                }
            }
        }
        return null;
    }

    function renderMessage(msg, animate = false) {
        const container = document.getElementById('messages-list');
        const div = document.createElement('div');
        
        div.className = `message-row ${animate ? 'msg-enter' : ''}`;
        
        const isAI = msg.role === 'ai';
        const avatarIcon = isAI 
            ? `<i class="fa-solid fa-cube text-xs text-white"></i>` 
            : `<i class="fa-regular fa-user text-xs text-white"></i>`;
        
        const avatar = `
            <div class="avatar-container rounded-full ${isAI ? 'bg-textPrimary' : 'bg-[#D97757]'} flex items-center justify-center shadow-sm flex-shrink-0 border-2 border-white">
                ${avatarIcon}
            </div>`;
        
        const name = isAI ? 'Newton' : 'You';
        const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let contentHtml = "";
        let mapData = null;

        if (isAI) {
            const mapRegex = /<<<LOCATIONS_START>>>([\s\S]*?)<<<LOCATIONS_END>>>/;
            const webRegex = /<<<WEB_START>>>([\s\S]*?)<<<WEB_END>>>/g;
            const scholarRegex = /<<<PAPER_START>>>([\s\S]*?)<<<PAPER_END>>>/g;
            const ideaRegex = /<<<IDEA_START>>>([\s\S]*?)<<<IDEA_END>>>/;
            const studyRegex = /<<<STUDY_START>>>([\s\S]*?)<<<STUDY_END>>>/;
            const mediaRegex = /<<<MEDIA_START>>>([\s\S]*?)<<<MEDIA_END>>>/;
            const followUpRegex = /<<<FOLLOWUP_START>>>([\s\S]*?)<<<FOLLOWUP_END>>>/;
            // New Regex for Financial Charts
            const chartRegex = /<<<CHART_START>>>([\s\S]*?)<<<CHART_END>>>/;
            const thoughtRegex = /<<<THOUGHT_START>>>([\s\S]*?)<<<THOUGHT_END>>>/;
            // Code Mode Specific Regex
            const codePlanRegex = /<<<PLAN_START>>>([\s\S]*?)<<<PLAN_END>>>/;
            
            let processedContent = msg.content;
            let ideaData = null;
            let studyData = null;
            let mediaData = null;
            let followUpData = null;
            let chartSymbol = null;
            let thoughtProcess = null;
            let codePlan = null;

            // 0. Parse Thought Process
            const thoughtMatch = processedContent.match(thoughtRegex);
            if (thoughtMatch) {
                thoughtProcess = thoughtMatch[1].trim();
                processedContent = processedContent.replace(thoughtMatch[0], '');
            }

            // 0.5 Parse Code Plan
            const planMatch = processedContent.match(codePlanRegex);
            if (planMatch) {
                codePlan = planMatch[1].trim();
                processedContent = processedContent.replace(planMatch[0], '');
            }
            
            // 1. Try Strict Tags for Idea Mode
            const ideaMatch = processedContent.match(ideaRegex);
            if (ideaMatch) {
                try {
                    ideaData = JSON.parse(ideaMatch[1]);
                    processedContent = processedContent.replace(ideaMatch[0], '');
                } catch(e) {}
            }
            
            // 2. Try JSON Block detection for Study Mode (More robust than custom tags)
            const jsonBlockRegex = /```json\s*([\s\S]*?)\s*```/;
            const jsonMatch = processedContent.match(jsonBlockRegex);
            if (jsonMatch) {
                try {
                    const parsed = JSON.parse(jsonMatch[1]);
                    if(parsed.subject || parsed.steps) {
                        studyData = parsed;
                        processedContent = processedContent.replace(jsonMatch[0], '');
                    }
                } catch(e) {}
            }

            // 3. Media & Follow Up Tags (General)
            const mediaMatch = processedContent.match(mediaRegex);
            if (mediaMatch) {
                try {
                    mediaData = JSON.parse(mediaMatch[1]);
                    processedContent = processedContent.replace(mediaMatch[0], '');
                } catch(e) {}
            }
            
            const followUpMatch = processedContent.match(followUpRegex);
            if (followUpMatch) {
                try {
                    followUpData = JSON.parse(followUpMatch[1]);
                    processedContent = processedContent.replace(followUpMatch[0], '');
                } catch(e) {}
            }

            // 4. Financial Chart Parsing
            const chartMatch = processedContent.match(chartRegex);
            if (chartMatch) {
                chartSymbol = chartMatch[1].trim();
                processedContent = processedContent.replace(chartMatch[0], '');
            }

            // Fallback: tryParseJSONBlock if no strict tags but mode is set
            if (!ideaData && msg.mode === 'idea') {
                const extracted = tryParseJSONBlock(processedContent);
                if (extracted && extracted.data.roadmap) { 
                    ideaData = extracted.data;
                    processedContent = processedContent.replace(extracted.fullMatch, '');
                }
            }
            if (!studyData && msg.mode === 'study') {
                const extracted = tryParseJSONBlock(processedContent);
                if (extracted && extracted.data.subject) { 
                    studyData = extracted.data;
                    processedContent = processedContent.replace(extracted.fullMatch, '');
                }
            }

            const mapMatch = processedContent.match(mapRegex);

            // --- MAP PARSING ---
            if (mapMatch) {
                try {
                    mapData = JSON.parse(mapMatch[1]);
                    processedContent = processedContent.replace(mapMatch[0], ''); 
                } catch(e) { 
                     const fallbackMatch = msg.content.match(/\[\s*\{.*?"lat":.*?\}\s*\]/s);
                     if(fallbackMatch) {
                         try {
                            mapData = JSON.parse(fallbackMatch[0]);
                            processedContent = processedContent.replace(fallbackMatch[0], '');
                         } catch(e2) {}
                     }
                }
            }
            
            // --- SCHOLAR PARSING ---
            const paperMatches = [...processedContent.matchAll(scholarRegex)];
            if (paperMatches.length > 0) {
                let papersHtml = `<div class="scholar-feed">`;
                paperMatches.forEach(match => {
                    const block = match[1];
                    const title = (block.match(/Title:\s*(.*)/) || [])[1] || "Untitled Paper";
                    const authors = (block.match(/Authors:\s*(.*)/) || [])[1] || "Unknown Authors";
                    const journal = (block.match(/Journal:\s*(.*)/) || [])[1] || "Academic Source";
                    // If link is empty or "N/A", generate a Google Scholar search link
                    let link = (block.match(/Link:\s*(.*)/) || [])[1] || "";
                    if(!link || link.length < 5 || link.toLowerCase().includes('example') || link.toLowerCase().includes('n/a')) {
                        link = `https://scholar.google.com/scholar?q=${encodeURIComponent(title)}`;
                    }

                    // Try to get a valid domain for favicon
                    let domain = 'scholar.google.com';
                    try {
                        const urlObj = new URL(link);
                        domain = urlObj.hostname;
                    } catch(e) {}

                    const summary = (block.match(/Summary:\s*(.*)/) || [])[1] || "";
                    
                    papersHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-graduation-cap"></i> Academic Paper</div>
                        <div class="scholar-title">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="scholar-favicon" onerror="this.style.display='none'">
                            <a href="${link}" target="_blank">${title}</a>
                        </div>
                        <div class="scholar-authors">${authors}</div>
                        <div class="scholar-journal">${journal}</div>
                        ${summary ? `<div class="scholar-abstract">${summary}</div>` : ''}
                    </div>`;
                    
                    processedContent = processedContent.replace(match[0], '');
                });
                papersHtml += `</div>`;
                processedContent = papersHtml + processedContent;
            }

            // --- WEB SEARCH PARSING (PERPLEXITY STYLE) ---
            const webMatches = [...processedContent.matchAll(webRegex)];
            if (webMatches.length > 0) {
                let webHtml = `<div class="web-grid-wrapper"><div class="web-grid-header"><i class="fa-solid fa-layer-group text-blue-500"></i> Sources</div><div class="web-grid">`;
                
                webMatches.forEach(match => {
                    const block = match[1];
                    const source = (block.match(/Source:\s*(.*)/) || [])[1] || "Web";
                    const title = (block.match(/Title:\s*(.*)/) || [])[1] || "Result";
                    const link = (block.match(/Link:\s*(.*)/) || [])[1] || "#";
                    
                    const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(title)}&w=320&h=180&c=7&rs=1`;
                    
                    let domain = "google.com";
                    try { domain = new URL(link).hostname; } catch(e){}

                    webHtml += `
                    <a href="${link}" target="_blank" class="web-card">
                        <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                        <div class="web-card-content">
                            <div class="web-card-top">
                                <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                <div class="web-card-source">${source}</div>
                            </div>
                            <div class="web-card-title">${title}</div>
                        </div>
                    </a>`;
                    
                    processedContent = processedContent.replace(match[0], '');
                });
                webHtml += `</div></div>`;
                processedContent = webHtml + processedContent;
            }

            // Clean up any double newlines left by removals
            processedContent = processedContent.replace(/\n\s*\n/g, '\n\n').trim();
            
            contentHtml = marked.parse(processedContent);

            // --- INJECT FINANCIAL CHART ---
            if (chartSymbol) {
                const chartId = 'chart-' + Date.now();
                const chartHtml = `
                <div class="tradingview-widget-container" id="${chartId}">
                    <div class="tradingview-widget-container__widget" style="height: 100%; width: 100%;"></div>
                </div>`;
                
                // Inject at top
                contentHtml = chartHtml + contentHtml;

                // Script injection must be delayed
                setTimeout(() => {
                    const container = document.getElementById(chartId).querySelector('.tradingview-widget-container__widget');
                    if (window.TradingView && container) {
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": chartSymbol,
                            "interval": "D",
                            "timezone": "Etc/UTC",
                            "theme": "light",
                            "style": "1",
                            "locale": "en",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "container_id": container.id || container.parentElement.id
                        });
                        // Since TradingView.widget replaces content by ID, we need the container ID
                        container.id = 'tv-' + Math.random().toString(36).substring(7);
                        new TradingView.widget({
                            "autosize": true,
                            "symbol": chartSymbol,
                            "interval": "D",
                            "timezone": "Etc/UTC",
                            "theme": "light",
                            "style": "1",
                            "locale": "en",
                            "enable_publishing": false,
                            "allow_symbol_change": true,
                            "container_id": container.id
                        });
                    }
                }, 500);
            }

            // --- INJECT MEDIA (GENERAL) ---
            if (mediaData && ((mediaData.visuals && mediaData.visuals.length > 0) || (mediaData.videos && mediaData.videos.length > 0))) {
                let mediaHtml = `<div class="media-scroll-container no-scrollbar">`;
                
                // Render Videos
                if (mediaData.videos) {
                    mediaData.videos.forEach(v => {
                        const query = encodeURIComponent(v.query || v.title);
                        const thumbUrl = `https://tse2.mm.bing.net/th?q=${query}+youtube+thumbnail&w=320&h=180&c=7&rs=1`;
                        const ytUrl = `https://www.youtube.com/results?search_query=${query}`;
                        mediaHtml += `
                        <a href="${ytUrl}" target="_blank" class="video-card">
                            <div class="video-thumbnail-container">
                                <img src="${thumbUrl}" class="video-thumbnail">
                                <div class="video-play-btn"><i class="fa-solid fa-play"></i></div>
                            </div>
                            <div class="video-title">${v.title}</div>
                        </a>`;
                    });
                }

                // Render Images
                if (mediaData.visuals) {
                    mediaData.visuals.forEach(visual => {
                         const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(visual)}&w=320&h=200&c=7&rs=1`;
                         const safeVisual = visual.replace(/'/g, "\\'");
                         mediaHtml += `
                         <div class="study-img-card" onclick="openImageModal('${imgUrl}', '${safeVisual}')">
                            <img src="${imgUrl}" class="study-img" loading="lazy">
                            <div class="study-img-caption">${visual}</div>
                         </div>`;
                    });
                }
                mediaHtml += `</div>`;
                contentHtml = mediaHtml + contentHtml;
            }

            // --- INJECT FOLLOW UP (GENERAL - PERPLEXITY STYLE) ---
            if (followUpData && followUpData.length > 0) {
                let followUpHtml = `<div class="follow-up-section"><div class="follow-up-header"><i class="fa-solid fa-layer-group"></i> Related</div>`;
                followUpData.forEach(q => {
                    followUpHtml += `<button onclick="useFollowUp('${q.replace(/'/g, "\\'")}')" class="follow-up-btn"><span>${q}</span> <i class="fa-solid fa-plus"></i></button>`;
                });
                followUpHtml += `</div>`;
                contentHtml += followUpHtml;
            }

            // --- INJECT CODE PLAN (CODE MODE) ---
            if (codePlan) {
                const planHtml = `
                <div class="code-plan-card">
                    <div class="code-plan-title"><i class="fa-solid fa-compass-drafting"></i> Implementation Plan</div>
                    <div class="code-plan-content">
                        ${marked.parse(codePlan)}
                    </div>
                </div>`;
                contentHtml = planHtml + contentHtml;
            }

            // --- INJECT IDEA BLUEPRINT ---
            if (ideaData) {
                let blueprintHtml = '';
                blueprintHtml += `
                <div class="scholar-card">
                    <div class="scholar-type"><i class="fa-regular fa-lightbulb"></i> Startup Concept</div>
                    <div class="scholar-title">${ideaData.title || 'Startup Concept'}</div>
                    <div class="scholar-authors" style="font-style: italic;">${ideaData.tagline || ''}</div>
                    <div class="scholar-abstract" style="margin-top: 8px;">${ideaData.ideology || ''}</div>
                </div>`;

                if (ideaData.goals && ideaData.goals.length > 0) {
                    blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-bullseye"></i> Strategic Goals</div>
                        <div class="scholar-abstract">
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${ideaData.goals.map(g => `<li style="margin-bottom: 6px; display: flex; gap: 8px;"><i class="fa-solid fa-check text-green-500 mt-1 text-xs"></i> <span>${g}</span></li>`).join('')}
                            </ul>
                        </div>
                    </div>`;
                }

                if (ideaData.roadmap && ideaData.roadmap.length > 0) {
                    blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-route"></i> Execution Roadmap</div>
                        <div class="scholar-abstract">
                             ${ideaData.roadmap.map(step => `
                                <div style="margin-bottom: 12px;">
                                    <div style="font-weight: 600; color: #334155; font-size: 0.9rem;">${step.step}</div>
                                    <div style="color: #64748B; font-size: 0.85rem;">${step.detail}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }

                if (ideaData.resources && ideaData.resources.length > 0) {
                     blueprintHtml += `
                    <div class="scholar-card">
                        <div class="scholar-type"><i class="fa-solid fa-link"></i> Market Resources</div>
                        <div style="margin-top: 10px;">
                            <div class="web-grid">
                                ${ideaData.resources.map(res => {
                                    let domain = 'google.com';
                                    try { domain = new URL(res.link).hostname; } catch(e){}
                                    const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(res.title + " logo")}&w=320&h=180&c=7&rs=1`;
                                    return `
                                    <a href="${res.link}" target="_blank" class="web-card">
                                        <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                                        <div class="web-card-content">
                                            <div class="web-card-top">
                                                <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                                <div class="web-card-source">${res.title}</div>
                                            </div>
                                            <div class="web-card-title text-xs text-gray-600">${res.desc || res.title}</div>
                                        </div>
                                    </a>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
                }
                
                contentHtml = blueprintHtml + contentHtml;
            }

            // --- INJECT STUDY BOARD ---
            if (studyData) {
                let studyHtml = '';

                // 1. Overview Card
                studyHtml += `
                <div class="scholar-card" style="border-left: 3px solid #10B981;">
                    <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-book-open"></i> ${studyData.level || 'Study Topic'}</div>
                    <div class="scholar-title">${studyData.subject || 'General'}</div>
                    <div class="scholar-abstract" style="margin-top:10px;">
                        ${studyData.explanation ? marked.parse(studyData.explanation) : ''}
                    </div>
                </div>`;

                // 2. Visuals Card (Images & Videos) - Using same visual renderer but specific for study layout
                if ((studyData.visuals && studyData.visuals.length > 0) || (studyData.videos && studyData.videos.length > 0)) {
                    studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-regular fa-image"></i> Visual & Video Aids</div>
                        <div class="media-scroll-container no-scrollbar" style="margin-top: 10px;">`;
                    
                    if (studyData.videos) {
                        studyData.videos.forEach(v => {
                            const query = encodeURIComponent(v.query || v.title);
                            const thumbUrl = `https://tse2.mm.bing.net/th?q=${query}+youtube+thumbnail&w=320&h=180&c=7&rs=1`;
                            const ytUrl = `https://www.youtube.com/results?search_query=${query}`;
                            studyHtml += `
                            <a href="${ytUrl}" target="_blank" class="video-card">
                                <div class="video-thumbnail-container">
                                    <img src="${thumbUrl}" class="video-thumbnail">
                                    <div class="video-play-btn"><i class="fa-solid fa-play"></i></div>
                                </div>
                                <div class="video-title">${v.title}</div>
                            </a>`;
                        });
                    }

                    if (studyData.visuals) {
                        studyData.visuals.forEach(visual => {
                             const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(visual)}&w=320&h=200&c=7&rs=1`;
                             const safeVisual = visual.replace(/'/g, "\\'");
                             studyHtml += `
                             <div class="study-img-card" onclick="openImageModal('${imgUrl}', '${safeVisual}')">
                                <img src="${imgUrl}" class="study-img" loading="lazy">
                                <div class="study-img-caption">${visual}</div>
                             </div>`;
                        });
                    }
                    studyHtml += `</div></div>`;
                }

                // 3. Steps Card (Improved UI)
                if (studyData.steps && studyData.steps.length > 0) {
                    studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-list-ol"></i> Solution Steps</div>
                        <div class="study-steps-container">`;
                    studyData.steps.forEach((step, index) => {
                        studyHtml += `
                        <div class="study-step-item">
                            <div class="study-step-number">${index + 1}</div>
                            <div class="study-step-content">
                                <span class="study-step-title">${step.label || 'Step ' + (index+1)}</span>
                                <div class="study-step-text">${marked.parse(step.text || '')}</div>
                            </div>
                        </div>`;
                    });
                    studyHtml += `</div></div>`;
                }

                // 4. Final Answer Card
                if (studyData.final_answer) {
                    studyHtml += `
                    <div class="scholar-card" style="background: #F0FDF4; border: 1px solid #86EFAC;">
                        <div class="scholar-type" style="color: #15803D;"><i class="fa-solid fa-calculator"></i> Final Answer</div>
                        <div style="font-size: 1.1rem; font-weight: 600; color: #14532D; margin-top: 8px;">
                            ${studyData.final_answer}
                        </div>
                    </div>`;
                }

                // 5. Resources Card
                if (studyData.resources && studyData.resources.length > 0) {
                     studyHtml += `
                    <div class="scholar-card" style="border-left: 3px solid #10B981;">
                        <div class="scholar-type" style="color: #059669;"><i class="fa-solid fa-link"></i> Learning Resources</div>
                        <div style="margin-top: 10px;">
                            <div class="web-grid">`;
                     studyData.resources.forEach(res => {
                         let domain = 'google.com';
                         try { domain = new URL(res.link).hostname; } catch(e){}
                         const imgUrl = `https://tse2.mm.bing.net/th?q=${encodeURIComponent(res.title + " logo")}&w=320&h=180&c=7&rs=1`;
                         studyHtml += `
                            <a href="${res.link}" target="_blank" class="web-card">
                                <img src="${imgUrl}" class="web-card-visual" loading="lazy" onerror="this.src='https://www.google.com/s2/favicons?domain=${domain}&sz=64'; this.style.objectFit='contain'; this.style.padding='20px';">
                                <div class="web-card-content">
                                    <div class="web-card-top">
                                        <img src="https://www.google.com/s2/favicons?domain=${domain}&sz=32" class="web-card-favicon">
                                        <div class="web-card-source">${res.title}</div>
                                    </div>
                                    <div class="web-card-title text-xs text-gray-600">${res.desc || res.title}</div>
                                </div>
                            </a>`;
                     });
                     studyHtml += `</div></div></div>`;
                }
                
                // 6. Follow Up Suggestions (Perplexity Style for Study Mode too)
                if (studyData.follow_up && studyData.follow_up.length > 0) {
                    studyHtml += `<div class="follow-up-section"><div class="follow-up-header"><i class="fa-solid fa-layer-group"></i> Related</div>`;
                    studyData.follow_up.forEach(q => {
                        studyHtml += `<button onclick="useFollowUp('${q.replace(/'/g, "\\'")}')" class="follow-up-btn"><span>${q}</span> <i class="fa-solid fa-plus"></i></button>`;
                    });
                    studyHtml += `</div>`;
                }

                contentHtml = studyHtml + contentHtml;
            }

            // --- INJECT THOUGHT PROCESS (PERPLEXITY STYLE) ---
            if (thoughtProcess) {
                const thoughtHtml = `
                <details class="thinking-accordion">
                    <summary class="thinking-summary">Thinking Process</summary>
                    <div class="thinking-content">
                        ${marked.parse(thoughtProcess)}
                    </div>
                </details>`;
                contentHtml = thoughtHtml + contentHtml;
            }

        } else {
            contentHtml = msg.content.replace(/\n/g, '<br>');
        }
        
        // --- ATTACHED IMAGE RENDERING IN USER MESSAGE (MULTIPLE) ---
        // Handle images attached by user in the message object
        // NOTE: Our current storage format sends ONE image. 
        // For new system, we should allow rendering multiple.
        
        // Render attached images first
        if (msg.role === 'user' && msg.attachments && msg.attachments.length > 0) {
            let attachmentsHtml = '<div class="flex flex-wrap gap-2 mb-3 mt-1">';
            msg.attachments.forEach(att => {
                if (att.type === 'image') {
                    // CHANGED: Increased image size to be more prominent
                    attachmentsHtml += `
                    <img src="${att.data}" class="rounded-xl h-auto w-auto max-h-[300px] max-w-full border border-gray-200 shadow-sm object-contain bg-gray-50 cursor-pointer hover:shadow-md transition-shadow" onclick="openImageModal('${att.data}')">`;
                } else if (att.type === 'pdf') {
                    attachmentsHtml += `
                    <div class="h-24 w-20 bg-gray-100 rounded-lg flex flex-col items-center justify-center border border-gray-200 p-2 text-center" title="${att.name}">
                        <i class="fa-regular fa-file-pdf text-red-500 text-2xl mb-1"></i>
                        <span class="text-[10px] text-gray-600 overflow-hidden line-clamp-2 w-full leading-tight">${att.name}</span>
                    </div>`;
                } else if (att.type === 'link') {
                     let domain = att.name;
                     // CHANGED: Improved link card design, removed underline
                     attachmentsHtml += `
                    <a href="${att.data}" target="_blank" class="attachment-link-card h-10 px-3 bg-gray-50 rounded-lg flex items-center border border-gray-200 gap-2 no-underline hover:bg-gray-100 transition-colors">
                        <div class="w-6 h-6 rounded-full bg-white flex items-center justify-center text-blue-500 text-xs shadow-sm border border-gray-100"><i class="fa-solid fa-link"></i></div>
                        <span class="text-xs text-gray-700 font-medium truncate max-w-[120px] no-underline">${domain}</span>
                    </a>`;
                }
            });
            attachmentsHtml += '</div>';
            contentHtml = attachmentsHtml + contentHtml;
        } 
        // Fallback for old single image/link format
        else if (msg.role === 'user') {
            if (msg.image) {
                // CHANGED: Increased image size for legacy fallback as well
                contentHtml = `<div class="mb-3 mt-1"><img src="${msg.image}" class="rounded-xl h-auto w-auto max-h-[300px] max-w-full border border-gray-200 shadow-sm object-contain bg-gray-50 cursor-pointer hover:shadow-md transition-shadow" onclick="openImageModal('${msg.image}')"></div>` + contentHtml;
            }
            if (msg.link) {
                 // handled in text mostly, but could add visual here if desired
            }
        }

        const uniqueMapId = 'map-' + Date.now() + Math.floor(Math.random() * 1000);
        
        let locationsHtml = '';
        if (mapData && mapData.length > 0) {
            const originalQuery = chats.find(c => c.id === currentChatId)?.messages.slice().reverse().find(m => m.role === 'user')?.content || '';
            const safeQuery = originalQuery.replace(/'/g, "\\'"); 

            locationsHtml += `
            <div class="map-wrapper">
                <div class="map-header">
                    <div class="map-title"><i class="fa-solid fa-map-location-dot text-accentBlue"></i> Locations Found</div>
                    <div class="flex gap-2">
                         <button onclick="measureDistance('${uniqueMapId}')" class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full font-medium hover:bg-gray-200 transition-colors flex items-center gap-1"><i class="fa-solid fa-ruler-combined"></i> Measure</button>
                         <button onclick="findNearMe('${uniqueMapId}', '${safeQuery}')" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-medium hover:bg-blue-100 transition-colors flex items-center gap-1"><i class="fa-solid fa-location-crosshairs"></i> Near Me</button>
                    </div>
                </div>
                <div id="${uniqueMapId}" class="interactive-map"></div>
            </div>`;
            
            locationsHtml += `<div class="location-cards-container no-scrollbar">`;
            mapData.forEach((loc) => {
                const city = loc.city || "";
                const searchQuery = encodeURIComponent(loc.name + " " + city + " storefront exterior");
                const imgUrl = `https://tse2.mm.bing.net/th?q=${searchQuery}&w=400&h=300&c=7&rs=1&pid=1.7`;
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.name + ' ' + (loc.lat ? loc.lat+','+loc.lon : ''))}`;
                
                locationsHtml += `
                <div class="location-card">
                    <div class="loc-img-wrapper group">
                         <img src="${imgUrl}" class="loc-img transition-transform group-hover:scale-105" loading="lazy" onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\'loc-no-img\'><i class=\'fa-regular fa-image text-xl mb-1\'></i><span>No Image</span></div>'">
                    </div>
                    <div class="loc-info">
                        <div class="loc-name" title="${loc.name}">${loc.name}</div>
                        <div class="loc-desc" title="${loc.desc}">${loc.desc || 'No description available'}</div>
                        <div class="loc-actions">
                            <a href="${mapsUrl}" target="_blank" class="loc-btn btn-maps"><i class="fa-solid fa-diamond-turn-right"></i> Directions</a>
                        </div>
                    </div>
                </div>`;
            });
            locationsHtml += `</div>`;
        }

        div.innerHTML = `
            <div class="message-inner">
                <div class="thread-line"></div>
                <div class="avatar-container">
                    ${avatar}
                </div>
                <div class="flex-1 min-w-0 pt-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="font-semibold text-sm text-textPrimary">${name}</span>
                        <span class="text-xs text-gray-400">${time}</span>
                        ${msg.mode === 'scholar' ? '<span class="text-[10px] bg-slate-100 text-slate-600 px-2 rounded-full font-bold border border-slate-200">SCHOLAR</span>' : ''}
                        ${msg.mode === 'web' ? '<span class="text-[10px] bg-blue-50 text-accentBlue px-2 rounded-full font-bold">WEB</span>' : ''}
                        ${msg.mode === 'idea' ? '<span class="text-[10px] bg-[#FFF4F0] text-[#D97757] px-2 rounded-full font-bold border border-[#FED7AA]">STARTUP BLUEPRINT</span>' : ''}
                        ${msg.mode === 'study' ? '<span class="text-[10px] bg-[#ECFDF5] text-[#059669] px-2 rounded-full font-bold border border-[#A7F3D0]">STUDY MODE</span>' : ''}
                        ${msg.mode === 'code' ? '<span class="text-[10px] bg-[#312e81] text-indigo-100 px-2 rounded-full font-bold border border-indigo-500">CODE CANVAS</span>' : ''}
                    </div>
                    ${locationsHtml}
                    <div class="prose-content text-textSecondary leading-7 message-content-box">
                        ${contentHtml}
                    </div>
                    ${isAI ? `<div class="flex gap-4 mb-2"><button onclick="copyToClipboard(this)" class="text-xs text-gray-400 hover:text-textPrimary flex items-center gap-1 transition-colors"><i class="fa-regular fa-copy"></i> Copy</button></div>` : ''}
                </div>
            </div>
        `;
        
        container.appendChild(div);

        // --- RENDER KATEX MATH ---
        if (window.renderMathInElement) {
            renderMathInElement(div, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError : false
            });
        }
        
        if(isAI) {
            // Updated Code Block Rendering with Canvas Logic
            div.querySelectorAll('pre code').forEach((block) => {
                const parent = block.parentElement;
                
                // Add Prism class
                const lang = block.className.replace('language-', '') || 'txt';
                block.className = `language-${lang}`; // Ensure standard class
                
                const wrapper = document.createElement('div');
                wrapper.className = 'code-block-wrapper';
                
                // Add specific logic for HTML/Web preview
                let previewBtn = '';
                if (lang === 'html' || lang === 'xml' || lang === 'svg') {
                    // NEW: Use previewStore to handle large content
                    const previewId = 'prev-' + Date.now() + Math.random().toString(36).substr(2, 9);
                    previewStore[previewId] = block.innerText;
                    previewBtn = `<button onclick="openPreviewModal('${previewId}')" class="code-action-btn"><i class="fa-solid fa-eye"></i> Preview</button>`;
                }

                wrapper.innerHTML = `
                <div class="code-header">
                    <span class="flex items-center gap-2"><i class="fa-solid fa-code text-xs"></i> ${lang.toUpperCase()}</span>
                    <div class="code-header-actions">
                        ${previewBtn}
                        <button onclick="navigator.clipboard.writeText(this.closest('.code-block-wrapper').querySelector('code').innerText)" class="code-action-btn"><i class="fa-regular fa-copy"></i> Copy</button>
                    </div>
                </div>`;
                
                parent.parentNode.insertBefore(wrapper, parent);
                wrapper.appendChild(parent);
                
                // Trigger Prism Highlight
                if(window.Prism) Prism.highlightElement(block);
            });

            if (mapData && mapData.length > 0) {
                setTimeout(() => {
                    const map = L.map(uniqueMapId);
                    
                    // Default view
                    map.setView([mapData[0].lat, mapData[0].lon], 13);
                    
                    // Switch to Google Maps Tiles (Standard Road Map)
                    L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                        maxZoom: 20,
                        subdomains:['mt0','mt1','mt2','mt3']
                    }).addTo(map);

                    const bounds = L.latLngBounds();
                    const markers = [];
                    mapData.forEach(loc => {
                        const marker = L.marker([loc.lat, loc.lon]).addTo(map);
                        marker.bindPopup(`<b>${loc.name}</b><br>${loc.desc || ''}`);
                        bounds.extend([loc.lat, loc.lon]);
                        markers.push(marker);
                    });
                    
                    // IF SINGLE PLACE: HIGH ZOOM
                    if (mapData.length === 1) {
                         map.setView([mapData[0].lat, mapData[0].lon], 16); 
                    } else {
                         map.fitBounds(bounds, { padding: [50, 50] });
                    }
                    
                    mapsStore[uniqueMapId] = map;
                    mapMarkersStore[uniqueMapId] = markers;
                }, 500); 
            }
        }
    }
    
    // --- IMAGE RESIZER ---
    function resizeImage(file, maxWidth, maxHeight, callback) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                let width = img.width;
                let height = img.height;
                if (width > height) {
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                } else {
                    if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL(file.type));
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
    
    // --- PDF TEXT EXTRACTION ---
    async function extractPdfText(file) {
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";
            
            // Limit to first 5 pages to keep context reasonable
            const maxPages = Math.min(pdf.numPages, 5);
            
            for (let i = 1; i <= maxPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(' ');
                fullText += `--- Page ${i} ---\n${pageText}\n\n`;
            }
            
            if (pdf.numPages > 5) {
                fullText += `\n[...PDF truncated. Total pages: ${pdf.numPages}]`;
            }
            
            return fullText;
        } catch (error) {
            console.error("PDF Parsing Error:", error);
            return null;
        }
    }
    
    function renderAttachmentPreview() {
        const preview = document.getElementById('attachment-preview');
        preview.innerHTML = '';
        preview.style.display = 'none';

        if (attachments.length === 0) {
            // Update button state (GREY STYLE REMOVED)
            const btn = document.getElementById('btn-attach');
            btn.classList.remove('text-gray-900', 'bg-gray-200');
            btn.classList.add('hover:bg-gray-100', 'text-gray-400');
            return;
        }

        preview.style.display = 'flex';
        
        attachments.forEach(att => {
            let html = '';
            if (att.type === 'image') {
                html = `
                <div class="attachment-card">
                    <img src="${att.data}" class="attachment-thumb">
                    <div class="attachment-info">
                        <span class="attachment-name">Image</span>
                        <span class="attachment-type">Upload</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            } else if (att.type === 'pdf') {
                html = `
                <div class="attachment-card">
                    <div class="attachment-icon-placeholder">
                        <i class="fa-regular fa-file-pdf"></i>
                    </div>
                    <div class="attachment-info">
                        <span class="attachment-name" title="${att.name}">${att.name}</span>
                        <span class="attachment-type">PDF</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            } else if (att.type === 'link') {
                html = `
                <div class="attachment-card">
                    <div class="attachment-icon-placeholder">
                        <i class="fa-solid fa-link"></i>
                    </div>
                    <div class="attachment-info">
                        <span class="attachment-name" title="${att.name}">${att.name}</span>
                        <span class="attachment-type">Link</span>
                    </div>
                    <i class="fa-solid fa-xmark attachment-remove-btn" onclick="removeAttachment('${att.id}')"></i>
                </div>`;
            }
            preview.innerHTML += html;
        });

        // Update button state (GREY STYLE)
        const btn = document.getElementById('btn-attach');
        btn.classList.add('text-gray-900', 'bg-gray-200');
        btn.classList.remove('hover:bg-gray-100', 'text-gray-400');
    }

    function removeAttachment(id) {
        attachments = attachments.filter(a => a.id !== id);
        renderAttachmentPreview();
        if(attachments.length === 0) document.getElementById('file-upload').value = '';
    }

    async function checkLocationAndSend() {
        const inputEl = document.getElementById('user-input');
        const text = inputEl.value.trim();
        // Allow empty text if something is attached
        if(!text && attachments.length === 0) return;
        
        const lowerText = text.toLowerCase();
        const explicitMapRequest = lowerText.includes('map') || lowerText.includes('show me') || lowerText.includes('location');
        const locationKeywords = /(nearest|nearby|near|location|where|closest|find|show)/;
        const placeKeywords = /(shop|store|publish|print|place|restaurant|cafe|library|book|gym|hotel|museum|park|hospital|school|university|agency|center)/;
        
        let isLocationIntent = explicitMapRequest || (lowerText.match(locationKeywords) && lowerText.match(placeKeywords)) || (lowerText.includes("where is") && lowerText.match(placeKeywords));

        // Contextual Check
        if (!isLocationIntent && (lowerText === 'location?' || lowerText === 'where is it?' || lowerText.includes('give the map'))) {
            isLocationIntent = true;
        }

        if (isLocationIntent) {
            const cleaned = cleanSearchQuery(text);
            const isVague = !cleaned || cleaned.length < 3 || cleaned === 'it';
            
            if (isVague) {
                sendMessage(null, null, true);
                return;
            }

            if (navigator.geolocation) {
                const btn = document.getElementById('send-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                btn.disabled = true;

                // Improved: Enable High Accuracy for specific map requests
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        const { latitude, longitude } = position.coords;
                        
                        let addressContext = `Lat: ${latitude}, Lon: ${longitude}`;
                        try {
                            const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`, { headers: { 'User-Agent': 'NewtonAI/1.0' } });
                            const data = await resp.json();
                            if(data && data.address) {
                                const city = data.address.city || data.address.town || data.address.village || '';
                                addressContext = `${city}, ${data.address.country || ''} (Lat: ${latitude}, Lon: ${longitude})`;
                            }
                        } catch(e) {}
                        
                        const realPlaces = await searchRealPlaces(text, latitude, longitude);
                        sendMessage(addressContext, realPlaces, true);
                    },
                    (error) => {
                        btn.innerHTML = originalHtml;
                        btn.disabled = false;
                        console.warn("Location fetch failed, proceeding without location.");
                        sendMessage(null, null, true); 
                    },
                    { 
                        enableHighAccuracy: true, 
                        timeout: 15000, 
                        maximumAge: 0 
                    }
                );
            } else {
                sendMessage(null, null, true);
            }
        } else {
            sendMessage(null, null, false);
        }
    }

    async function sendMessage(locationContext, realPlacesData, isLocationIntent) {
        const inputEl = document.getElementById('user-input');
        const text = inputEl.value.trim();
        
        // Ensure there is something to send
        if (!text && attachments.length === 0) return;

        if (!currentChatId) startNewChat();
        setLandingMode(false);

        inputEl.value = '';
        inputEl.style.height = 'auto';
        document.getElementById('char-count').innerText = '0';

        const currentMode = isStudyMode ? 'study' : (isIdeaMode ? 'idea' : (isScholarMode ? 'scholar' : (isWebSearchMode ? 'web' : (isCodeMode ? 'code' : 'normal'))));
        
        // Capture attached media for this message and clear state
        const sentAttachments = [...attachments];
        clearAttachments();
        
        // Construct User Message Object
        const userMsg = { 
            role: 'user', 
            content: text, 
            mode: currentMode,
            attachments: sentAttachments
        };
        
        // Legacy fields for backward compat in rendering if needed (optional)
        const firstImage = sentAttachments.find(a => a.type === 'image');
        if(firstImage) userMsg.image = firstImage.data;

        const chat = chats.find(c => c.id === currentChatId);
        if(chat) {
            chat.messages.push(userMsg);
            if (chat.messages.length === 1) {
                let title = "New Conversation";
                if(text) title = text.substring(0, 30) + '...';
                else if(sentAttachments.length > 0) title = 'File Analysis';
                chat.title = title;
                renderHistory();
            }
            localStorage.setItem('newton_chats', JSON.stringify(chats));
        }
        renderMessage(userMsg, true);
        scrollToBottom();

        // --- FETCH WEBSITE CONTENT (IF LINKS ATTACHED) ---
        let websiteContext = "";
        const links = sentAttachments.filter(a => a.type === 'link');
        if (links.length > 0) {
            const loadingMsgId = 'reading-' + Date.now();
            try {
                document.getElementById('messages-list').insertAdjacentHTML('beforeend', 
                    `<div id="${loadingMsgId}" class="text-xs text-center text-gray-400 my-2 flex justify-center items-center gap-2"><i class="fa-solid fa-circle-notch fa-spin"></i> Reading website content...</div>`);
                scrollToBottom();

                for (const link of links) {
                    const res = await fetch(`https://r.jina.ai/${link.data}`);
                    if(res.ok) {
                        let content = await res.text();
                        if(content.length > 15000) content = content.substring(0, 15000) + "\n... [Truncated]";
                        websiteContext += `\n\n### WEBPAGE CONTENT (${link.data}) ###\n${content}\n\n`;
                    }
                }
                
                document.getElementById(loadingMsgId)?.remove();
            } catch(e) {
                console.warn("Failed to fetch website content", e);
                document.getElementById(loadingMsgId)?.remove();
            }
        }

        const loadingId = 'loading-' + Date.now();
        const loadingHtml = `<div id="${loadingId}" class="message-row pl-4 pr-2"><div class="message-inner"><div class="thread-line"></div><div class="avatar-container rounded-full bg-textPrimary flex items-center justify-center shadow-sm border-2 border-white"><i class="fa-solid fa-cube text-xs text-white"></i></div><div class="flex-1 space-y-3 py-2"><div class="h-4 bg-gray-100 rounded w-1/4 shimmer"></div><div class="h-4 bg-gray-100 rounded w-3/4 shimmer"></div></div></div></div>`;
        document.getElementById('messages-list').insertAdjacentHTML('beforeend', loadingHtml);
        scrollToBottom();

        // --- CONSTRUCT HISTORY STRING FOR PROMPT ---
        let historyString = "";
        const MAX_CONTEXT_CHARS = 1500; // Reduced for URL safety
        
        if(chat) {
            for (let i = chat.messages.length - 1; i >= 0; i--) {
                const m = chat.messages[i];
                let cleanContent = m.content.replace(/<<<.*?>>>/g, '[Data Block]'); 
                const attTags = (m.attachments || []).map(a => `[User attached ${a.type}: ${a.name}]`).join(' ');
                const msgString = `### ${m.role === 'user' ? 'USER' : 'ASSISTANT'} (${m.mode || 'normal'} mode):\n${attTags} ${cleanContent}\n\n`;
                
                if ((historyString.length + msgString.length) < MAX_CONTEXT_CHARS) {
                    historyString = msgString + historyString;
                } else {
                    break;
                }
            }
        }

        // --- GLOBAL INSTRUCTION FOR THINKING PROCESS ---
        const thinkingInstruction = `
        CRITICAL: Begin your response with a hidden "Thinking Block" that outlines your plan.
        Format: <<<THOUGHT_START>>> [Your brief step-by-step analysis plan, search strategy, or reasoning here] <<<THOUGHT_END>>>.
        This block will be parsed and shown as a collapsible "Thinking Process" to the user.
        `;

        let prompt = "";
        if (isLocationIntent) {
             const locInfo = locationContext ? `User Accurate Location: ${locationContext}` : "User location is unavailable.";
             
             if (!realPlacesData || realPlacesData.length === 0) {
                 prompt = `Role: Helpful Local Guide & Map Generator. 
                 Query: "${text}". 
                 ${locInfo}
                 ${thinkingInstruction}

                 INSTRUCTIONS:
                 1. If the user asks for ONE specific place (e.g. "The Eiffel Tower"), generate coordinates for ONLY that place.
                 2. If general (e.g. "restaurants"), generate 3 plausible locations.
                 3. WRAP MAP DATA IN: <<<LOCATIONS_START>>> [JSON] <<<LOCATIONS_END>>>. 
                 
                 REQUIRED JSON FORMAT:
                 [
                    {"name": "Place Name", "lat": 27.5983, "lon": 89.8766, "desc": "Contextual description", "city": "City"}
                 ]
                 
                 (Keep text response brief)`;
             } else {
                 prompt = `Role: Helpful Local Guide. Query: "${text}". ${locInfo}
                I found real places. JSON: ${JSON.stringify(realPlacesData)}
                ${thinkingInstruction}

                INSTRUCTIONS:
                1. Use the real place data provided.
                2. If the user asked for a SINGLE specific place, only return that one in the JSON.
                3. WRAP MAP DATA IN: <<<LOCATIONS_START>>> [JSON] <<<LOCATIONS_END>>>.

                REQUIRED JSON FORMAT:
                [
                    {"name": "Place Name", "lat": 12.34, "lon": 56.78, "desc": "Brief description", "city": "City"}
                ]`;
             }

        } else if (isScholarMode) {
            prompt = `Role: Academic Research Assistant. 
            Task: Provide critical analysis and findings for the user query.
            ${thinkingInstruction}
            
            IMPORTANT:
            1. You MUST include AT LEAST 3 (ideally 4-5) REAL academic references.
            2. Do not use 'example.com' or placeholder links. 
            3. If you don't have a direct link, use a Google Scholar search URL: https://scholar.google.com/scholar?q=Title
            
            FORMAT EACH PAPER EXACTLY LIKE THIS:
            <<<PAPER_START>>>
            Title: [Paper Title]
            Authors: [Author Names]
            Journal: [Journal Name, Year]
            Link: [Real URL or Google Scholar Search]
            Summary: [One sentence key finding]
            <<<PAPER_END>>>

            Repeat the block for each paper. Then provide your analysis.
            
            Finally, provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Query: ${text}`;

        } else if (isIdeaMode) {
            prompt = `Role: Startup Incubator / Product Manager.
            Task: Analyze the user's idea and generate a structured Blueprint.
            ${thinkingInstruction}

            IMPORTANT: You MUST include AT LEAST 3 distinct resources (competitors, tools, or inspiration websites) in the 'resources' array.

            REQUIRED JSON FORMAT (Must be valid JSON):
            <<<IDEA_START>>>
            {
              "title": "Startup Name",
              "tagline": "A catchy slogan",
              "ideology": "Core mission statement and ideology.",
              "goals": ["Goal 1", "Goal 2", "Goal 3"],
              "roadmap": [
                {"step": "Phase 1", "detail": "Actionable step 1"},
                {"step": "Phase 2", "detail": "Actionable step 2"}
              ],
              "resources": [
                {"title": "Competitor/Tool Name", "link": "https://full-url.com", "desc": "Why it is relevant"},
                {"title": "Resource 2", "link": "https://example.com", "desc": "Relevance"},
                {"title": "Resource 3", "link": "https://another.com", "desc": "Relevance"}
              ]
            }
            <<<IDEA_END>>>

            After the JSON, provide a brief, encouraging summary and feedback text.
            Also, provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Idea: ${text}`;
            
        } else if (isStudyMode) {
            prompt = `Role: Expert AI Tutor (Newton).
            Task: Teach the user about "${text}".
            ${thinkingInstruction}

            CRITICAL: Return strictly a VALID JSON object. Do not wrap it in markdown ticks if possible, or use standard markdown code blocks.
            
            MATH RULES:
            1. Use LaTeX for math. 
            2. Enclose inline math with single '$' (e.g., $E=mc^2$).
            3. Enclose block math with double '$$'.
            4. ESCAPE backslashes in JSON strings (e.g., "\\frac{a}{b}" becomes "\\\\frac{a}{b}").
            
            JSON FORMAT:
            \`\`\`json
            {
               "subject": "Subject",
               "level": "Grade Level",
               "explanation": "Detailed explanation using standard LaTeX math.",
               "steps": [
                  {"label": "Step 1", "text": "Details using LaTeX math."}
               ],
               "visuals": ["keyword1", "keyword2"],
               "videos": [{"title": "Video Topic", "query": "search query for youtube"}],
               "resources": [{"title": "Name", "link": "url", "desc": "info"}],
               "final_answer": "Final result in LaTeX.",
               "follow_up": ["Question 1?", "Question 2?", "Question 3?"]
            }
            \`\`\`
            
            IMPORTANT:
            - Provide 3 smart "follow_up" questions.
            - Provide 2-3 visual keywords.
            - Provide 2-3 video search queries for YouTube.
            - NO conversational text outside the JSON.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Topic: ${text}`;

        } else if (isCodeMode) {
            // NEW: CODE MODE PROMPT
            prompt = `Role: Senior Staff Software Engineer (Newton Code Canvas).
            Task: 
            1. Analyze the user's coding request.
            2. Refine the requirements and create a brief technical specification.
            3. Generate clean, modern, efficient, and complete code (single file if web app).
            
            ${thinkingInstruction}

            OUTPUT FORMAT:
            
            First, output the Refined Plan in this specific format:
            <<<PLAN_START>>>
            **Goal:** [Brief statement of what will be built]
            **Tech Stack:** [e.g., HTML5, Tailwind, JS, React, etc.]
            **Architecture:** [Brief explanation of the approach]
            <<<PLAN_END>>>

            Then, provide the explanation and the code blocks.
            Use standard Markdown code blocks for code (e.g. \`\`\`html ... \`\`\`).
            
            IMPORTANT:
            - Output the FULL COMPLETE CODE. Do not skip sections.
            - If it's a web application, keep it in a single file (HTML + embedded CSS/JS).
            - Do not output raw JSON. Output standard Markdown.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            Current Request: ${text}`;

        } else if (isWebSearchMode) {
            let focusInstruction = "";
            let roleInstruction = "Role: Web Search Engine.";
            
            if (webSearchFocus === 'social') {
                roleInstruction = "Role: Social Media Researcher & Trend Analyst.";
                focusInstruction = "Focus on discussions from Reddit, Twitter (X), Quora, and forums. Analyze public sentiment, common opinions, and viral trends.";
            } else if (webSearchFocus === 'finance') {
                roleInstruction = "Role: Financial Analyst & Market Researcher.";
                focusInstruction = "Focus on stock market data, economic news, company reports, crypto trends, and investment analysis.";
                // Specific Instruction for Charts - REINFORCED
                focusInstruction += `\nCRITICAL: If the user asks for the price or a chart of a specific asset (stock, crypto, pair), specifically output the TradingView symbol using this exact format:
                <<<CHART_START>>>EXCHANGE:SYMBOL<<<CHART_END>>>
                Examples: <<<CHART_START>>>NASDAQ:AAPL<<<CHART_END>>>, <<<CHART_START>>>BINANCE:BTCUSDT<<<CHART_END>>>, <<<CHART_START>>>NYSE:GME<<<CHART_END>>>.`;
            } else if (webSearchFocus === 'academic') {
                roleInstruction = "Role: Academic Researcher.";
                focusInstruction = "Focus on research papers, university publications, scientific journals, and educational resources. Use formal citation style where possible.";
            } else {
                roleInstruction = "Role: Advanced Web Search Engine.";
                focusInstruction = "Provide comprehensive, high-quality search results from diverse and trusted sources.";
            }

            prompt = `${roleInstruction}
            Task: Simulate a focused search for "${text}".
            ${focusInstruction}
            ${thinkingInstruction}
            
            FORMAT RESULTS EXACTLY LIKE THIS:

            <<<WEB_START>>>
            Source: [Source Name]
            Title: [Page Title]
            Link: [Full URL]
            Image: [URL to a relevant image, or 'null' if none]
            Summary: [Brief context]
            <<<WEB_END>>>

            Provide at least 3 distinct results. If you know a relevant image URL for the article, include it. Otherwise use 'null'.
            Then provide a summary text synthesizing the information found.
            
            If relevant, provide 1-2 search queries for YouTube videos or image keywords. Wrap them in <<<MEDIA_START>>> { "visuals": ["keyword"], "videos": [{"title": "...", "query": "..."}] } <<<MEDIA_END>>>.
            Also provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.

            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            `;
        } else {
            // General prompt handling (supports images, links, pdfs)
            
            // Build Context from Attachments
            let attachmentContext = "";
            sentAttachments.forEach(a => {
                if(a.type === 'pdf') attachmentContext += `\n\n### PDF CONTENT (${a.name}) ###\n${a.data}\n\n`;
                if(a.type === 'link') {} // Links handled via websiteContext var above
                if(a.type === 'image') attachmentContext += `\n\n[User attached an image]`; // Image handled in message structure
            });

            // General Finance Check logic - REINFORCED
            const chartInstruction = `\nCRITICAL: If the user asks for the price or a chart of a specific asset (stock, crypto, etc.), output the TradingView symbol like: <<<CHART_START>>>NASDAQ:TSLA<<<CHART_END>>> or <<<CHART_START>>>BINANCE:ETHUSDT<<<CHART_END>>>.`;

            prompt = `Role: Newton AI (Helpful, Professional Assistant, powered by Gemini).
            
            ### CONVERSATION HISTORY (Truncated) ###
            ${historyString}
            
            ${websiteContext}
            ${attachmentContext}

            ### CURRENT USER INPUT ###
            ${text}
            
            Answer the user based on the context provided above (website text, PDF text, images).
            ${chartInstruction}
            ${thinkingInstruction}
            
            If the answer would benefit from visuals (like "show me a dog" or "explain an engine"), provide 1-2 search queries for YouTube videos or image keywords. 
            Wrap them in <<<MEDIA_START>>> { "visuals": ["keyword"], "videos": [{"title": "...", "query": "..."}] } <<<MEDIA_END>>>.
            
            Always provide 3 follow-up questions wrapped in <<<FOLLOWUP_START>>> ["Q1", "Q2", "Q3"] <<<FOLLOWUP_END>>>.
            `;
        }

        const finalSystemPrompt = "You are Newton AI, a helpful assistant. Use Markdown for formatting.";
        // Ensure prompt is a string
        const fullPrompt = `${finalSystemPrompt}\n\n${prompt}`;

        try {
            // --- POLLINATIONS AI (OPENAI) CALL ---
            const seed = Math.floor(Math.random() * 1000000);
            const model = 'openai'; 
            let response;

            const images = sentAttachments.filter(a => a.type === 'image');
            
            // Check URL length for GET
            const encodedPrompt = encodeURIComponent(fullPrompt);
            const getUrl = `https://text.pollinations.ai/${encodedPrompt}?model=${model}&seed=${seed}`;
            
            // Use POST if:
            // 1. Images are present (Multimodal)
            // 2. URL is too long (> 1600 chars to be safe for most hosted environments)
            if (images.length > 0 || getUrl.length > 1600) {
                const messages = [
                    { role: 'user', content: [] }
                ];
                
                // Add Text
                messages[0].content.push({ type: "text", text: fullPrompt });

                // Add Images
                images.forEach(img => {
                    messages[0].content.push({ type: "image_url", image_url: { url: img.data } });
                });

                // If no images, simplify content to just string to avoid potential parsing issues on some endpoints
                if (images.length === 0) {
                     messages[0].content = fullPrompt;
                }

                response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages, model, seed }),
                    mode: 'cors',
                    referrerPolicy: 'no-referrer'
                });

            } else {
                // GET Request (Preferred for short/simple queries)
                response = await fetch(getUrl, {
                    method: 'GET',
                    mode: 'cors',
                    referrerPolicy: 'no-referrer'
                });
            }
            
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`Pollinations API Error: ${response.status} ${response.statusText} - ${errorText}`);
            }
            
            const aiText = await response.text();
            let finalContent = aiText;
            
            // Try parsing as JSON if it looks like JSON
            if (aiText.trim().startsWith('{')) {
                try {
                    const parsed = JSON.parse(aiText);
                    if (parsed.content) finalContent = parsed.content;
                    else if (parsed.choices && parsed.choices[0] && parsed.choices[0].message) finalContent = parsed.choices[0].message.content;
                    // Handle specific case from user log if it's a specific provider format
                    else if (parsed.reasoning_content && !parsed.content) {
                         // If we only got reasoning, maybe the model stopped? 
                         // Or maybe the content is effectively the reasoning?
                         // Let's use reasoning if content is missing, but prepend a note.
                         finalContent = "Thinking process:\n" + parsed.reasoning_content + "\n\n(No final output provided)";
                    }
                } catch (e) {
                    // console.warn("Not JSON or failed to parse");
                }
            }

            document.getElementById(loadingId).remove();

            const aiMsg = { role: 'ai', content: finalContent, mode: currentMode };
            if(chat) {
                chat.messages.push(aiMsg);
                localStorage.setItem('newton_chats', JSON.stringify(chats));
            }
            renderMessage(aiMsg, true);
            scrollToBottom();
        } catch (e) {
            document.getElementById(loadingId).remove();
            console.error(e);
            
            const errorAlertId = 'err-' + Date.now();
            const errorHtml = `
            <div id="${errorAlertId}" class="message-row pl-4 pr-2">
                <div class="message-inner">
                    <div class="thread-line"></div>
                     <div class="avatar-container rounded-full bg-red-500 flex items-center justify-center shadow-sm border-2 border-white">
                        <i class="fa-solid fa-triangle-exclamation text-xs text-white"></i>
                    </div>
                    <div class="flex-1 py-2">
                        <div class="p-3 bg-red-50 text-red-700 rounded-lg text-sm border border-red-100">
                            <strong>Error:</strong> Could not connect to the AI service (Gemini).<br>
                            <span class="text-xs opacity-75">Details: ${e.message}</span>
                        </div>
                    </div>
                </div>
            </div>`;
            document.getElementById('messages-list').insertAdjacentHTML('beforeend', errorHtml);
            scrollToBottom();
        }
    }

    function copyToClipboard(btn) {
        const text = btn.closest('.flex-1').querySelector('.prose-content').innerText;
        navigator.clipboard.writeText(text);
    }

    function triggerFileUpload() { document.getElementById('file-upload').click(); }
    
    async function handleFileUpload(input) { 
        if(input.files && input.files.length > 0) {
            
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                
                if (file.type === 'application/pdf') {
                    const text = await extractPdfText(file);
                    if(text) {
                        attachments.push({
                            id: Date.now() + Math.random(),
                            type: 'pdf',
                            data: text,
                            name: file.name
                        });
                    }
                } else if (file.type.startsWith('image/')) {
                    // Use resizeImage which is callback based, wrap in promise
                    await new Promise((resolve) => {
                        resizeImage(file, 800, 800, (base64) => {
                            attachments.push({
                                id: Date.now() + Math.random(),
                                type: 'image',
                                data: base64,
                                name: file.name
                            });
                            resolve();
                        });
                    });
                }
            }
            renderAttachmentPreview();
        }
    }
    
    function clearAttachments() {
        attachments = [];
        renderAttachmentPreview();
        document.getElementById('file-upload').value = '';
    }

    // Initialize
    if (!currentChatId || chats.length === 0) setLandingMode(true);
    renderHistory();

</script>
</body>
</html>
