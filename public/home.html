<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
<title>EduLink - Place where learning meets</title>
<link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');
:root { --surface:#ffffff; --background:#ffffff; --on-surface:#0f0f0f; --text-secondary:#606060; --outline:#e5e7eb; --hover-bg:#f2f2f2; --primary:#065fd4; }
body { font-family:'Inter',sans-serif; background-color:var(--background); color:var(--on-surface); overflow:hidden; }
h1,h2,h3,.google-font { font-family:'Google Sans','Inter',sans-serif; }
* { scrollbar-width:none; -ms-overflow-style:none; } *::-webkit-scrollbar { width:0px; background:transparent; display:none; }
i[data-lucide],svg { flex-shrink:0; }
.fade-in { animation:fadeUp 0.4s cubic-bezier(0.2,0,0,1) forwards; opacity:0; transform:translateY(10px); }
@keyframes fadeUp { to { opacity:1; transform:translateY(0); } }
.app-panel { background:var(--surface); border-radius:0; border:none; height:100%; display:flex; flex-direction:column; overflow:hidden; transition:all 0.3s cubic-bezier(0.2,0,0,1); }
@media (min-width:768px) { .app-panel { border-radius:20px; border:1px solid var(--outline); box-shadow:0 1px 2px rgba(0,0,0,0.03); } }
@media (max-width:768px) { body { padding:0!important; } #workspace-layout { gap:0!important; } }
#main-sidebar { width:88px; flex-shrink:0; padding:24px 12px; transition:width 0.3s cubic-bezier(0.2,0,0,1),padding 0.3s ease; }
@media (min-width:1024px) { #main-sidebar { width:260px; padding:24px 20px; } }
.nav-item { display:flex; align-items:center; gap:14px; padding:12px; color:var(--text-secondary); font-weight:500; font-size:15px; border-radius:12px; transition:all 0.2s ease; cursor:pointer; text-decoration:none; margin-bottom:4px; justify-content:center; position:relative; }
.nav-item:hover { color:var(--on-surface); background-color:var(--hover-bg); }
.nav-item.active { color:var(--primary); background-color:#eff4ff; font-weight:600; }
.nav-badge { position:absolute; top:10px; right:12px; background-color:#cc0000; color:white; font-size:10px; font-weight:700; height:16px; min-width:16px; padding:0 4px; border-radius:10px; display:none; align-items:center; justify-content:center; border:2px solid #fff; z-index:10; }
.mobile-footer-badge { position:absolute; top:-4px; right:-4px; background-color:#cc0000; color:white; font-size:10px; font-weight:700; height:16px; min-width:16px; padding:0 4px; border-radius:10px; display:none; align-items:center; justify-content:center; border:2px solid #ffffff; z-index:20; }
@media (min-width:1024px) { .nav-item { justify-content:flex-start; padding:10px 16px; } .nav-badge { right:auto; left:28px; top:8px; } }
.sidebar-user { display:flex; align-items:center; gap:12px; padding:8px; border-radius:12px; cursor:pointer; transition:background-color 0.2s; justify-content:center; }
.sidebar-user:hover { background-color:var(--hover-bg); }
@media (min-width:1024px) { .sidebar-user { justify-content:flex-start; padding:8px 12px; } }
.create-btn { display:flex; align-items:center; justify-content:flex-start; gap:12px; background:#1f1f1f; color:white; padding:12px 20px; border-radius:12px; font-weight:500; font-size:14px; transition:all 0.2s ease; width:100%; margin-bottom:24px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); line-height:1; min-width:0; white-space:nowrap; }
.create-btn:hover { background:#000; transform:translateY(-1px); box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); }
.post-card { background:var(--surface); border-bottom:1px solid var(--outline); border-radius:0; transition:background-color 0.2s ease; margin-bottom:0; box-shadow:none; overflow:visible; }
.post-card:hover { background-color:#fdfdfd; cursor:pointer; transform:none; }
.post-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
.post-avatar-container { position:relative; }
.post-avatar { width:40px; height:40px; border-radius:50%; background-color:var(--hover-bg); object-fit:cover; }
.post-author-name { font-weight:600; font-size:15px; color:var(--on-surface); line-height:1.2; }
.post-author-name:hover { text-decoration:underline; color:var(--primary); }
.post-meta { font-size:12px; color:var(--text-secondary); margin-top:2px; font-weight:400; }
.post-body { font-size:15px; line-height:1.6; color:var(--on-surface); margin-bottom:12px; white-space:pre-wrap; }
.post-actions { display:flex; align-items:center; justify-content:space-between; padding-top:12px; border-top:1px solid transparent; }
.action-btn { display:flex; align-items:center; gap:8px; padding:8px; border-radius:18px; color:#0f0f0f; font-size:13px; font-weight:500; transition:all 0.2s; background:transparent; border:none; cursor:pointer; }
.action-btn:hover { background-color:transparent; opacity: 0.7; }
.action-btn.like.active { color: #ff0000; opacity: 1; }
.action-btn.like.active svg { fill: #ff0000; stroke: none; }
.action-btn.bookmark.active { color: #eab308; opacity: 1; }
.action-btn.bookmark.active svg { fill: #eab308; stroke: #eab308; } 
#compose-modal,#create-menu-modal,#edit-profile-modal,#user-list-modal,#settings-modal,#likes-overlay,#username-modal,#add-link-modal,#promo-modal,#upload-options-modal,#share-modal,#post-options-modal,#notif-options-modal,#qr-overlay,#scanner-overlay { box-shadow:0 20px 60px rgba(0,0,0,0.15); border:1px solid var(--outline); }
.compose-header { display:flex; align-items:center; justify-content:center; padding-bottom:16px; margin-bottom:16px; border-bottom:1px solid var(--outline); position:relative; }
.compose-title { font-size:16px; font-weight:700; color:var(--on-surface); font-family:'Google Sans',sans-serif; }
.compose-textarea { width:100%; min-height:120px; font-size:17px; line-height:1.6; color:var(--on-surface); border:none; outline:none; resize:none; background:transparent; }
.compose-tools { display:flex; align-items:center; justify-content:space-between; margin-top:16px; padding-top:16px; border-top:1px solid var(--outline); }
.tool-group { display:flex; gap:4px; }
.tool-btn { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--text-secondary); transition:background 0.2s; cursor:pointer; }
.tool-btn:hover { background-color:var(--hover-bg); color:var(--on-surface); }
.create-option-card { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:24px; border-radius:16px; border:1px solid var(--outline); background:var(--surface); cursor:pointer; transition:all 0.2s; gap:12px; height:140px; }
.create-option-card:hover { border-color:var(--primary); background:#eff4ff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(11,87,208,0.1); }
.create-icon-bg { width:56px; height:56px; border-radius:50%; background:var(--hover-bg); display:flex; align-items:center; justify-content:center; color:var(--on-surface); margin-bottom:8px; transition:background 0.2s; }
.create-option-card:hover .create-icon-bg { background:#d3e3fd; color:#0b57d0; }
.media-preview-wrapper { margin-top:12px; position:relative; width:100%; background:var(--hover-bg); border-radius:12px; overflow:hidden; border:1px solid var(--outline); display:flex; justify-content:center; align-items:center; }
.media-preview-content { width:100%; height:auto; max-height:400px; object-fit:contain; display:block; }
.feed-panel { flex:1; min-width:0; order:1; }
.trending-panel { width:100%; flex-shrink:0; order:2; border-left:1px solid var(--outline); }
@media (min-width:1280px) { .trending-panel { width:380px; } }
.backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.2); backdrop-filter:blur(2px); z-index:90; opacity:0; pointer-events:none; transition:opacity 0.3s; }
.backdrop.active { opacity:1; pointer-events:auto; }
.toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%) translateY(20px); background:#0f0f0f; color:#f2f2f2; padding:14px 28px; border-radius:48px; font-size:15px; opacity:0; pointer-events:none; transition:all 0.3s; z-index:200; display:flex; align-items:center; gap:12px; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.icon-btn { width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:background 0.2s; cursor:pointer; color:var(--on-surface); }
.icon-btn:hover { background-color:var(--hover-bg); }
.post-options-menu { position:absolute; background:var(--surface); border:1px solid var(--outline); border-radius:12px; box-shadow:0 4px 6px -2px rgba(0,0,0,0.05),0 10px 15px -3px rgba(0,0,0,0.1); width:160px; z-index:50; opacity:0; pointer-events:none; transform:scale(0.95); transition:all 0.1s ease-out; padding:6px; }
.post-options-menu.active { opacity:1; pointer-events:auto; transform:scale(1); }
.post-option-item { display:flex; align-items:center; gap:10px; padding:10px; font-size:14px; color:var(--on-surface); cursor:pointer; border-radius:8px; transition:background 0.1s; font-weight:500; }
.post-option-item:hover { background:var(--hover-bg); color:var(--on-surface); }
.post-option-item.danger { color:#d92d20; }
.post-option-item.danger:hover { background:#fef2f2; color:#b91c1c; }
.tab-group { display:flex; width:100%; background:transparent; padding:0; border:none; border-bottom:1px solid var(--outline); border-radius:0; }
.tab-btn { flex:1; padding:14px 0; font-size:14px; font-weight:600; color:var(--text-secondary); border-radius:0; transition:all 0.2s ease; cursor:pointer; background:transparent; text-align:center; position:relative; display:flex; align-items:center; justify-content:center; gap:8px; }
.tab-btn:hover { color:var(--on-surface); background-color:var(--hover-bg); }
.tab-btn.active { color:var(--on-surface); background:transparent; box-shadow:none; }
.tab-btn.active i { stroke-width:3px; }
.tab-btn.active::after { content:''; position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:60px; height:4px; background-color:var(--on-surface); border-radius:4px 4px 0 0; }
.grid-post-container { display:grid; grid-template-columns:repeat(3,1fr); gap:4px; }
@media (min-width:768px) { .grid-post-container { gap:16px; } }
.grid-post-item { position:relative; aspect-ratio:4/5; overflow:hidden; cursor:pointer; background-color:#f3f4f6; border-radius: 12px; }
.grid-post-item:hover .grid-post-overlay { opacity:1; }
.grid-post-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; color:white; font-weight:bold; gap:16px; }
.grid-post-text-preview { width:100%; height:100%; padding:12px; font-size:10px; display:flex; align-items:center; justify-content:center; text-align:center; color:#4b5563; background:#f9fafb; overflow:hidden; }
.mobile-nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; flex:1; gap:4px; color:var(--on-surface); transition:all 0.2s; cursor:pointer; position:relative; }
.mobile-nav-item.active { color:var(--on-surface); }
.mobile-nav-item i { width:24px; height:24px; transition:transform 0.2s; stroke-width: 1.5px; }
.mobile-nav-item.active i { transform:scale(1.1); stroke-width:2.5px; fill: var(--on-surface); }
.scale-in { animation:scaleIn 0.3s cubic-bezier(0.2,0,0,1) forwards; }
@keyframes scaleIn { from { transform:scale(0.95); opacity:0; } to { transform:scale(1); opacity:1; } }
#app-loader { position:fixed; inset:0; background:var(--surface); z-index:9999; display:flex; justify-content:center; align-items:center; transition:opacity 0.5s ease; }
.loader-spinner { width:40px; height:40px; border:4px solid var(--hover-bg); border-top:4px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
.loader-logo { width:80px; height:80px; object-fit:contain; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.profile-banner-container { height:140px; width:100%; background-color:#e5e7eb; position:relative; overflow:hidden; cursor:default; }
.profile-banner-img { width:100%; height:100%; object-fit:cover; pointer-events:none; }
.banner-edit-container { height:140px; width:100%; background:#e5e7eb; position:relative; overflow:hidden; cursor:grab; border-radius:0; }
.banner-edit-container:active { cursor:grabbing; }
.banner-edit-img { width:100%; height:100%; object-fit:cover; user-select:none; -webkit-user-drag:none; }
.toggle-checkbox:checked { right:0; border-color:#0b57d0; }
.toggle-checkbox:checked+.toggle-label { background-color:#0b57d0; }
.toggle-switch { position:relative; width:44px; height:24px; background-color:#e5e7eb; border-radius:9999px; transition:background-color 0.2s; cursor:pointer; }
.toggle-switch.active { background-color:#0b57d0; }
.toggle-dot { position:absolute; top:2px; left:2px; width:20px; height:20px; background-color:white; border-radius:50%; transition:transform 0.2s; }
.toggle-switch.active .toggle-dot { transform:translateX(20px); }
#main-header { transition:transform 0.3s cubic-bezier(0.2,0,0,1); }
#explore-header-container { transition:transform 0.3s cubic-bezier(0.2,0,0,1); }
.collab-chip { display:inline-flex; align-items:center; background-color:#f3f4f6; padding:4px 10px; border-radius:20px; font-size:13px; margin-right:6px; margin-bottom:6px; color:#1f1f1f; border:1px solid #e5e7eb; }
.post-modal-layout { display:flex; flex-direction:column; width:100%; height:100%; overflow:hidden; gap:0; }
body.reel-mode #mobile-bottom-nav { display:none!important; }

@media (min-width:768px) { 
    .post-modal-layout { flex-direction:row; width:90vw; max-width:1200px; height:85vh; gap:0; align-items:center; background:transparent; border-radius: 24px; overflow: hidden; } 
    .stage-panel { flex:1; height:100%; background:radial-gradient(circle at center,#000 0%,#0f0f0f 100%); position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden; min-width:0; } 
    .stage-content { max-width:100%; max-height:100%; object-fit:contain; } 
    .discussion-panel { width:450px; height:100%; background:#ffffff; display:flex; flex-direction:column; overflow:hidden; flex-shrink:0; } 
}
@media (max-width:767px) { 
    .post-modal-layout { display:flex; flex-direction:column; background:#fff; width:100vw; height:100%; overflow:hidden; } 
    .mobile-header { display:flex; flex-shrink:0; height:60px; align-items:center; justify-content:space-between; padding:0 16px; border-bottom:1px solid #f0f0f0; background:#fff; z-index:20; } 
    .stage-panel { flex:1; background:#000; width:100%; position:relative; display:flex; align-items:center; justify-content:center; overflow:hidden; } 
    .stage-content { width:100%; height:100%; object-fit:contain; } 
    .discussion-panel { display:none; } 
}

/* Post Overlay Mobile Specific */
.mobile-post-overlay { display: none; flex-direction: column; width: 100%; height: 100%; background: #fff; overflow-y: auto; }
@media (max-width: 767px) { .mobile-post-overlay { display: flex; } .desktop-post-view { display: none !important; } }

.discussion-header { padding:12px 16px; border-bottom:1px solid var(--outline); display:flex; align-items:center; justify-content:space-between; background:#fff; z-index:10; }
.discussion-scroll { flex:1; overflow-y:auto; padding:0; background:#fff; }
.caption-box { padding:16px; border-bottom:1px solid var(--outline); background:#fff; }
.comments-list { padding:0; display:flex; flex-direction:column; }
.discussion-footer { padding:12px 16px; border-top:1px solid var(--outline); background:#fff; z-index:10; }
.comment-row { display:flex; gap:12px; align-items:flex-start; padding:8px 0; transition:background-color 0.1s; position: relative; }
.comment-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; background-color:var(--hover-bg); flex-shrink: 0; position: relative; z-index: 2; }
.comment-content-box { display:flex; flex-direction:column; gap:2px; flex: 1; min-width: 0; }
.comment-header { font-size:12px; font-weight:600; color:var(--on-surface); display:flex; align-items:center; gap:4px; line-height: 1.2; }
.comment-time { font-size:11px; font-weight:400; color:var(--text-secondary); }
.comment-text { font-size:13px; line-height:18px; color:var(--on-surface); white-space: pre-wrap; word-break: break-word; }
.comment-actions-row { display:flex; align-items:center; gap:16px; margin-top:2px; }
.comment-action-btn { display:flex; align-items:center; gap:4px; font-size:11px; font-weight:500; color:var(--text-secondary); cursor:pointer; background:none; border:none; padding:2px 0; }
.comment-reply-btn { font-size: 11px; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
.chat-input-wrapper { display:flex; align-items:flex-end; background:transparent; padding:8px 0; gap: 12px; border-top: 1px solid transparent; }
.chat-input-field { flex: 1; border-bottom: 1px solid #ccc; padding-bottom: 4px; outline: none; transition: border-bottom-color 0.2s; font-size: 14px; max-height: 80px; resize: none; overflow-y: hidden; }
.chat-input-field:focus { border-bottom-color: var(--on-surface); }
.play-pause-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; opacity:0; transition:opacity 0.2s; }
.play-pause-overlay.show { opacity:1; }
.play-pause-icon { width:80px; height:80px; background:rgba(0,0,0,0.4); border-radius:50%; padding:20px; color:white; backdrop-filter:blur(4px); }
.read-more-btn { color: var(--text-secondary); font-weight: 600; font-size: 14px; cursor: pointer; margin-left: 4px; }
.read-more-btn:hover { text-decoration: underline; }
.explore-tab-btn { font-size:16px; font-weight:700; color:#9ca3af; padding-bottom:4px; border-bottom:2px solid transparent; transition:all 0.2s; }
.explore-tab-btn.active { color:#1f1f1f; border-color:#1f1f1f; }
.category-chip { padding:6px 16px; border-radius:9999px; font-size:13px; font-weight:600; white-space:nowrap; border:1px solid #e5e7eb; color:#4b5563; background:white; cursor:pointer; transition:all 0.2s; }
.category-chip.active { background:#1f1f1f; color:white; border-color:#1f1f1f; }
.category-chip.active { background:#1f1f1f; color:white; border-color:#1f1f1f; }
.category-chip:hover:not(.active) { background:#f9fafb; }
@media (min-width:1024px) { #explore-results .grid { gap:16px!important; } #explore-results .aspect-square { border-radius:12px; } }
.trend-item { padding:12px; border-radius:12px; cursor:pointer; transition:background 0.2s; }
.trend-item:hover { background:var(--hover-bg); }
.trend-rank { font-size:11px; color:var(--text-secondary); margin-bottom:2px; }
.trend-tag { font-weight:700; color:var(--on-surface); margin-bottom:2px; font-size:15px; }
.trend-count { font-size:11px; color:var(--text-secondary); }
.post-carousel { position:relative; width:100%; overflow:hidden; background-color:#000; aspect-ratio:4/5; }
.post-carousel-inner { display:flex; transition:transform 0.3s ease-out; height:100%; width:100%; }
.post-carousel-item { min-width:100%; flex:0 0 100%; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#000; }
.post-carousel-item img,.post-carousel-item video { width:100%; height:100%; object-fit:cover; }
.carousel-dots-outside { display:flex; justify-content:center; gap:6px; margin-top:10px; }
.carousel-dot { width:6px; height:6px; border-radius:50%; background:#d1d5db; transition:background 0.2s; }
.carousel-dot.active { background:#3b82f6; }
.carousel-nav-btn { position:absolute; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.5); color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:10; border:none; }
.carousel-nav-btn.prev { left:8px; } .carousel-nav-btn.next { right:8px; }
#thread-overlay { border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15); }
#ptr-spinner { position:absolute; top:70px; left:50%; transform:translateX(-50%) translateY(-20px); width:40px; height:40px; background:white; border-radius:50%; box-shadow:0 3px 10px rgba(0,0,0,0.1); display:flex; justify-content:center; align-items:center; z-index:15; opacity:0; pointer-events:none; transition:transform 0.2s,opacity 0.2s; color:#0b57d0; }
@media(max-width: 768px) {
  #thread-overlay .discussion-panel { height: 75vh; width: 100%; position: absolute; bottom: 0; transform: translateY(0); }
  .thread-mobile-container { height: 75vh; background: #fff; width: 100%; display: flex; flex-direction: column; border-radius: 20px 20px 0 0; }
}
.share-icon-btn { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; padding: 12px 4px; border-radius: 12px; transition: background-color 0.2s; cursor: pointer; }
.share-icon-btn:hover { background-color: var(--hover-bg); }
.share-icon-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; transition: transform 0.2s; }
.share-icon-btn:hover .share-icon-circle { transform: scale(1.05); }
body.modal-open #mobile-bottom-nav { display: none !important; }

/* Thread Lines CSS */
.thread-connector-container {
    position: relative;
    margin-left: 4px;
    padding-left: 10px;
}
.reply-item-container {
    position: relative;
}
.reply-connector-line {
    position: absolute;
    top: -10px;
    left: -14px;
    width: 20px;
    height: 30px;
    border-left: 2px solid #e5e7eb;
    border-bottom: 2px solid #e5e7eb;
    border-bottom-left-radius: 12px;
    z-index: 1;
}
.reply-vertical-line {
    position: absolute;
    top: 0;
    left: -14px;
    width: 2px;
    height: 100%;
    background-color: #e5e7eb;
    z-index: 0;
}
.reply-item-container:last-child .reply-vertical-line {
    display: none;
}
</style>
</head>
<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-white">
<div id="app-loader"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="loader-logo"></div>
<div id="custom-alert" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200">
<div class="bg-white rounded-2xl p-6 shadow-2xl max-w-sm w-[90%] transform scale-95 transition-transform duration-200" id="custom-alert-box"><h3 class="text-lg font-bold text-[#1f1f1f] mb-2" id="alert-title">Confirm</h3><p class="text-gray-600 mb-6 text-sm" id="alert-msg">Are you sure?</p><div class="flex justify-end gap-3"><button class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg transition-colors" onclick="closeAlert(false)">Cancel</button><button class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700 transition-colors" id="alert-confirm-btn">Confirm</button></div></div></div>
<div id="username-modal" class="fixed inset-0 z-[90] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden"><div class="bg-white w-[90%] max-w-[400px] rounded-[24px] shadow-2xl p-8 relative flex flex-col items-center"><h2 class="text-2xl font-bold text-[#1f1f1f] mb-2 google-font">Create Username</h2><p class="text-sm text-gray-500 mb-6 text-center">Choose a unique username.</p><div class="w-full relative mb-4"><span class="absolute left-4 top-3 text-gray-400 font-bold">@</span><input type="text" id="new-username-input" class="w-full bg-gray-100 rounded-xl py-3 pl-8 pr-4 outline-none focus:ring-2 focus:ring-blue-500 font-medium" placeholder="username"></div><button onclick="saveUsername()" class="w-full bg-[#0b57d0] text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition-all">Start Exploring</button></div></div>
<div id="add-link-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden"><div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-2xl p-6 relative"><h3 class="text-lg font-bold text-gray-900 mb-4">Add Link</h3><div class="space-y-4 mb-6"><div><label class="text-xs font-bold text-gray-500 uppercase">Title</label><input type="text" id="new-link-title" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div><div><label class="text-xs font-bold text-gray-500 uppercase">URL</label><input type="url" id="new-link-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('add-link-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button onclick="saveLink()" class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Add Link</button></div></div></div>
<div id="promo-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden"><div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-2xl p-6 relative"><h3 class="text-lg font-bold text-gray-900 mb-4">Edit Promo</h3><div class="space-y-4 mb-6"><div><label class="text-xs font-bold text-gray-500 uppercase">Image URL</label><div class="flex gap-2"><input type="text" id="promo-img-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"><button onclick="document.getElementById('promo-file-input').click()" class="icon-btn bg-gray-100 hover:bg-gray-200"><i data-lucide="upload" class="w-4 h-4"></i></button></div><input type="file" id="promo-file-input" class="hidden" accept="image/*" onchange="handlePromoFile(event)"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Target Link</label><input type="url" id="promo-target-url" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900"></div></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('promo-modal').classList.add('hidden')" class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button><button onclick="savePromo()" class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Save</button></div></div></div>
<div id="post-options-overlay" class="fixed inset-0 z-[75] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="hidePostMenu()"><div id="post-options-modal" class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button onclick="hidePostMenu()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="font-bold text-gray-900 text-lg">Options</span><div class="w-10"></div></div><div class="p-4 flex flex-col gap-2" id="post-options-content"></div></div></div>
<div id="share-overlay" class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeShareMenu()"><div id="share-modal" class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button onclick="closeShareMenu()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="font-bold text-gray-900 text-lg">Share</span><div class="w-10"></div></div><div class="p-6 overflow-y-auto"><div id="share-post-preview" class="hidden"></div><div class="flex items-center justify-between gap-3 mb-6 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors" onclick="triggerShare('copy')"><div class="flex items-center gap-3 overflow-hidden"><img id="share-owner-avatar" src="" class="w-10 h-10 rounded-full border border-gray-200 object-cover shrink-0 bg-gray-200"><div class="flex flex-col min-w-0"><span class="text-xs text-gray-500 font-medium">Post Link</span><span id="share-link-text" class="font-bold text-gray-900 truncate text-sm">...</span></div></div><div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></div></div><input type="hidden" id="share-link-input"><div class="grid grid-cols-4 gap-2 mb-2"><div class="share-icon-btn" onclick="triggerShare('copy')"><div class="share-icon-circle bg-gray-100 text-gray-800 border border-gray-200"><i data-lucide="link" class="w-6 h-6"></i></div><span class="text-xs font-medium text-gray-700">Copy Link</span></div><div class="share-icon-btn" onclick="triggerShare('twitter')"><div class="share-icon-circle bg-black text-white"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4l11.733 16h4.267l-11.733 -16z"/><path d="M4 20l6.768 -6.768m2.46 -2.46l6.772 -6.772"/></svg></div><span class="text-xs font-medium text-gray-700">X</span></div><div class="share-icon-btn" onclick="triggerShare('whatsapp')"><div class="share-icon-circle bg-[#25D366] text-white"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"/><path d="M9 10a.5 .5 0 0 0 1 0v-1a.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a.5 .5 0 0 0 0 -1h-1a.5 .5 0 0 0 0 1"/></svg></div><span class="text-xs font-medium text-gray-700">WhatsApp</span></div><div class="share-icon-btn" onclick="triggerShare('email')"><div class="share-icon-circle bg-blue-500 text-white"><i data-lucide="mail" class="w-6 h-6"></i></div><span class="text-xs font-medium text-gray-700">Email</span></div></div></div></div></div>
<div id="qr-overlay" class="fixed inset-0 z-[80] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeQR()"><div id="qr-modal" class="bg-white w-full md:w-[400px] md:rounded-[24px] rounded-t-[24px] shadow-2xl p-6 relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col items-center" onclick="event.stopPropagation()"><div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6 md:hidden"></div><h3 class="text-lg font-bold text-gray-900 mb-2 text-center">My QR Code</h3><div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm mb-4"><img id="qr-image" src="" class="w-48 h-48 object-contain"></div><div class="flex items-center justify-between gap-3 mb-2 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors" onclick="copyQRLink()"><div class="flex items-center gap-3 overflow-hidden"><img id="qr-owner-avatar" src="" class="w-10 h-10 rounded-full border border-gray-200 object-cover shrink-0 bg-gray-200"><div class="flex flex-col min-w-0"><span class="text-xs text-gray-500 font-medium">Profile Link</span><span id="qr-display-name" class="font-bold text-gray-900 truncate text-sm">@username</span></div></div><div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="copy" class="w-4 h-4 text-gray-600"></i></div></div><div class="flex items-center justify-between gap-3 mb-4 p-3 bg-gray-50 rounded-xl border border-gray-200 w-full cursor-pointer hover:bg-gray-100 transition-colors" onclick="openScanner(); closeQR()"><div class="flex items-center gap-3 overflow-hidden"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-gray-200 text-black shrink-0"><i data-lucide="camera" class="w-5 h-5"></i></div><div class="flex flex-col min-w-0"><span class="text-xs text-gray-500 font-medium">Scan</span><span class="font-bold text-gray-900 truncate text-sm">Scan QR Code</span></div></div><div class="bg-white p-2 rounded-lg border border-gray-200 shadow-sm"><i data-lucide="chevron-right" class="w-4 h-4 text-gray-600"></i></div></div><input type="hidden" id="qr-hidden-url"></div></div>
<div id="scanner-overlay" class="fixed inset-0 z-[100] bg-black hidden flex-col"><div class="flex justify-between items-center p-4"><button onclick="closeScanner()" class="icon-btn bg-white/10 text-white hover:bg-white/20"><i data-lucide="x" class="w-6 h-6"></i></button><span class="text-white font-bold text-lg">Scan QR Code</span><div class="w-10"></div></div><div class="flex-1 flex flex-col items-center justify-center relative"><div id="qr-reader" class="w-full max-w-sm rounded-xl overflow-hidden shadow-2xl"></div><p class="text-gray-400 mt-6 text-sm px-4 text-center">Point your camera at an EduLink QR code to visit their profile.</p></div></div>
<div id="upload-options-modal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/60 backdrop-blur-sm hidden" onclick="document.getElementById('upload-options-modal').classList.add('hidden')"><div class="bg-white w-[90%] max-w-[300px] rounded-2xl shadow-xl p-4 transform scale-100 transition-transform" onclick="event.stopPropagation()"><h3 class="text-center font-bold text-gray-900 mb-4 text-lg">Select Upload Type</h3><div class="flex flex-col gap-3"><button onclick="triggerUpload('single')" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors"><div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600"><i data-lucide="image" class="w-5 h-5"></i></div><span class="font-bold text-gray-700">Single</span></button><button onclick="triggerUpload('multiple')" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl border border-gray-100 transition-colors"><div class="w-10 h-10 rounded-full bg-purple-50 flex items-center justify-center text-purple-600"><i data-lucide="layers" class="w-5 h-5"></i></div><span class="font-bold text-gray-700">Multiple (Carousel)</span></button></div></div></div>
<div id="mobile-notifications-header" class="md:hidden fixed top-0 left-0 w-full bg-white z-30 flex-col hidden border-b border-gray-100 pb-0"><div class="h-14 flex items-center justify-between px-4 shrink-0 relative"><span class="font-bold text-lg text-[#1f1f1f]">Notifications</span><div class="flex items-center gap-3"><button onclick="toggleNotifSearchMobile()" class="icon-btn"><i data-lucide="search" class="w-5 h-5 text-[#1f1f1f]"></i></button><div class="relative"><button onclick="toggleNotifMenu()" class="icon-btn"><i data-lucide="more-vertical" class="w-5 h-5 text-[#1f1f1f]"></i></button></div></div></div><div id="mobile-notif-search-container" class="px-4 pb-2 hidden"><div class="relative"><i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i><input type="text" id="notif-search" placeholder="Search..." oninput="handleNotifSearch(this.value)" class="w-full bg-gray-100 rounded-xl py-2 pl-9 pr-4 text-sm outline-none focus:ring-1 focus:ring-blue-500 transition-all"></div></div><div class="tab-group mb-0 mx-0 w-full"><button onclick="switchNotifTab('all')" id="ntab-all-mobile" class="tab-btn active"><i data-lucide="bell" class="w-5 h-5"></i> All</button><button onclick="switchNotifTab('official')" id="ntab-official-mobile" class="tab-btn"><i data-lucide="megaphone" class="w-5 h-5"></i> Official</button></div></div>
<div id="notif-options-overlay" class="fixed inset-0 z-[80] flex items-end justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeNotifOptions()"><div id="notif-options-modal" class="bg-white w-full rounded-t-[24px] shadow-2xl relative transform translate-y-full transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button onclick="closeNotifOptions()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="font-bold text-gray-900 text-lg">Options</span><div class="w-10"></div></div><div class="p-6 flex flex-col gap-2"><button onclick="toggleNotifSelection(); closeNotifOptions()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="check-square" class="w-5 h-5"></i> Select</button><button onclick="deleteSelectedNotifs(); closeNotifOptions()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Selected</button><button onclick="clearAllNotifications(); closeNotifOptions()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="trash" class="w-5 h-5"></i> Delete All</button></div></div></div>
<div id="thread-overlay" class="fixed inset-0 z-[65] hidden flex justify-center items-end md:items-center"><div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeThread()"></div><div class="bg-white w-full md:w-[450px] h-[75vh] md:h-[85vh] md:rounded-[24px] rounded-t-[20px] shadow-2xl relative flex flex-col transform transition-transform duration-300 scale-100 opacity-100 overflow-hidden scale-in thread-mobile-container"><div class="discussion-header"><div class="flex items-center gap-3"><button onclick="closeThread()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="chevron-down" class="w-6 h-6 text-gray-600"></i></button><span class="font-bold text-lg text-[#1f1f1f]">Thread</span></div><button onclick="closeThread()" class="icon-btn hover:bg-gray-100 hidden md:flex"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button></div><div id="thread-content" class="discussion-scroll bg-white"></div><div class="discussion-footer"><div class="chat-input-wrapper"><img id="thread-input-avatar" src="" class="w-7 h-7 rounded-full bg-gray-200 object-cover mr-2 shrink-0"><textarea id="thread-input" placeholder="Add a reply..." class="chat-input-field" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitThreadReply();}"></textarea><button onclick="submitThreadReply()" class="text-white bg-[#065fd4] font-medium text-sm px-4 py-2 rounded-full hover:bg-blue-700 transition-colors">Reply</button></div></div></div></div>

<!-- Post View Overlay -->
<div id="post-view-overlay" class="fixed inset-0 z-[60] hidden flex justify-center items-center">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closePostView()"></div>
    
    <!-- Desktop Modal Layout -->
    <div class="post-modal-layout scale-in relative z-10 desktop-post-view hidden md:flex">
         <div id="post-view-media-container" class="stage-panel group relative"><div id="video-play-overlay" class="play-pause-overlay"><i data-lucide="play" class="play-pause-icon"></i></div></div>
         <div class="discussion-panel">
            <div class="discussion-header"><div class="flex items-center gap-3"><span class="font-bold text-xl text-[#0f0f0f]">Comments</span></div><button onclick="closePostView()" class="icon-btn hover:bg-gray-100 hidden md:flex"><i data-lucide="x" class="w-5 h-5 text-gray-500"></i></button></div>
            <div id="post-view-scroll" class="discussion-scroll scroll-smooth">
                <div id="post-view-caption-area" class="caption-box hidden"></div>
                <div id="post-view-comments" class="comments-list"></div>
            </div>
            <div class="discussion-footer">
                <div class="flex justify-between items-center mb-3 px-1 hidden md:flex"><div class="flex gap-4"><i id="post-view-like-btn" data-lucide="heart" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform"></i><i data-lucide="message-circle" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform" onclick="document.getElementById('comment-input-desktop').focus()"></i><i data-lucide="send" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform" onclick="if(window.currentViewingPostId)sharePost(window.currentViewingPostId)"></i></div><div class="flex gap-4 items-center"><span class="font-bold text-sm text-gray-900 cursor-pointer hover:underline" id="post-view-likes-count" onclick="openLikes(window.currentViewingPostId)">0 likes</span><i id="post-view-save-btn" data-lucide="bookmark" class="w-6 h-6 text-gray-700 cursor-pointer hover:scale-110 transition-transform"></i></div></div>
                <div class="chat-input-wrapper"><img id="comment-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-200 object-cover"><textarea id="comment-input-desktop" placeholder="Add a comment..." class="chat-input-field" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitCommentDesktop();}"></textarea><button onclick="submitCommentDesktop()" class="text-white bg-[#065fd4] font-medium text-sm px-4 py-2 rounded-full hover:bg-blue-700 transition-colors">Comment</button></div>
            </div>
         </div>
    </div>

    <!-- Mobile Post Overlay Layout -->
    <div id="mobile-post-detail-view" class="mobile-post-overlay z-20 md:hidden">
        <!-- Header -->
        <div class="flex items-center p-3 border-b border-gray-100 bg-white sticky top-0 z-20 h-14">
            <button onclick="closePostView()" class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center shrink-0 absolute left-3"><i data-lucide="arrow-left" class="w-5 h-5 text-gray-700"></i></button>
            <span class="mx-auto font-bold text-lg text-[#1f1f1f]">Post</span>
        </div>
        <!-- Scrollable Content -->
        <div class="overflow-y-auto flex-1 pb-4">
            <!-- User Row -->
            <div class="flex justify-between items-center px-4 pt-4 pb-2">
                <div class="flex items-center gap-3 cursor-pointer" id="mobile-post-user-area">
                    <img id="mobile-post-pfp-lg" class="w-10 h-10 rounded-full border border-gray-200 object-cover bg-gray-50">
                    <div>
                        <div class="font-bold text-[#1f1f1f] text-sm" id="mobile-post-username-lg">User</div>
                        <div class="text-xs text-gray-500" id="mobile-post-time"></div>
                    </div>
                </div>
                <button onclick="showPostOptions(event, window.currentViewingPostId, window.currentViewingAuthorId)" class="icon-btn w-8 h-8"><i data-lucide="more-horizontal" class="w-5 h-5 text-gray-600"></i></button>
            </div>
            <!-- Content/Caption -->
            <div class="px-4 pb-3">
                 <div id="mobile-post-caption-text" class="text-[15px] leading-relaxed text-[#1f1f1f] whitespace-pre-wrap"></div>
            </div>
            <!-- Media -->
            <div id="mobile-post-media-area" class="w-full"></div>
            
            <!-- Actions Footer -->
            <div class="px-4 py-3 flex items-center justify-between border-t border-gray-100 mt-2">
                <div class="flex items-center gap-6">
                     <button onclick="if(window.currentViewingPostId) toggleLike(window.currentViewingPostId)" class="flex items-center gap-2">
                        <i id="mobile-overlay-like-icon" data-lucide="heart" class="w-7 h-7 text-[#1f1f1f]"></i>
                        <span id="mobile-overlay-like-count" class="font-bold text-sm text-[#1f1f1f]">0</span>
                     </button>
                     <button onclick="toggleMobileCommentDrawer()" class="flex items-center gap-2">
                        <i data-lucide="message-circle" class="w-7 h-7 text-[#1f1f1f]"></i>
                        <span id="mobile-overlay-comment-count" class="font-bold text-sm text-[#1f1f1f]">0</span>
                     </button>
                     <button onclick="if(window.currentViewingPostId) sharePost(window.currentViewingPostId)" class="flex items-center gap-2">
                        <i data-lucide="send" class="w-7 h-7 text-[#1f1f1f]"></i>
                     </button>
                </div>
                <button onclick="if(window.currentViewingPostId) toggleSave(window.currentViewingPostId)">
                    <i id="mobile-overlay-save-icon" data-lucide="bookmark" class="w-7 h-7 text-[#1f1f1f]"></i>
                </button>
            </div>
            <div class="px-4 pb-4 text-sm" id="mobile-liked-by-area"></div>
        </div>
    </div>
</div>

<!-- Mobile Comments Overlay (Drawer) -->
<div id="mobile-comments-overlay" class="fixed inset-0 z-[70] hidden md:hidden">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleMobileCommentDrawer()"></div>
    <div class="absolute bottom-0 left-0 w-full h-[75vh] bg-white rounded-t-[24px] flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full">
        <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <span class="font-bold text-lg">Comments</span>
            <button onclick="toggleMobileCommentDrawer()" class="icon-btn bg-gray-50"><i data-lucide="x" class="w-5 h-5 text-gray-600"></i></button>
        </div>
        <div id="mobile-comments-list" class="flex-1 overflow-y-auto p-0"></div>
        <div class="p-3 border-t border-gray-100 bg-white pb-[env(safe-area-inset-bottom)]">
            <div class="chat-input-wrapper">
                <img id="mobile-comment-input-avatar" src="" class="w-8 h-8 rounded-full bg-gray-200 object-cover">
                <textarea id="comment-input-mobile" placeholder="Add a comment..." class="chat-input-field" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();submitCommentMobile();}"></textarea>
                <button onclick="submitCommentMobile()" class="text-white bg-[#065fd4] font-medium text-sm px-4 py-2 rounded-full hover:bg-blue-700 transition-colors">Post</button>
            </div>
        </div>
    </div>
</div>

<div id="lightbox" class="fixed inset-0 bg-black/95 z-[9999] flex justify-center items-center opacity-0 pointer-events-none transition-opacity duration-300" onclick="closeLightbox()"><button class="absolute top-8 right-8 text-white/70 hover:text-white bg-white/10 rounded-full p-3 hover:bg-white/20"><i data-lucide="x" class="w-8 h-8"></i></button><div id="lightbox-wrapper" class="w-full h-full flex justify-center items-center p-6"></div></div>
<div id="toast" class="toast"><i id="toast-icon" data-lucide="check-circle-2" class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span></div>
<div id="likes-overlay" class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeLikes()"><div id="likes-modal" class="bg-white w-full h-[70vh] md:h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button onclick="closeLikes()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="font-bold text-gray-900 text-lg">Likes</span><div class="w-10"></div></div><div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div></div></div>
<div id="settings-overlay" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 backdrop-blur-sm hidden" onclick="closeSettings()"><div class="bg-white w-[90%] max-w-[450px] rounded-[24px] shadow-2xl p-6 relative transform transition-all scale-100 overflow-hidden flex flex-col max-h-[85vh]" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-[#1f1f1f] google-font">Settings</h2><button onclick="closeSettings()" class="icon-btn hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="flex-1 overflow-y-auto space-y-6"><div><h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">Privacy</h3><div class="flex items-center justify-between py-2"><div><div class="font-medium text-gray-900">Private Account</div><div class="text-xs text-gray-500">Only followers can see your posts</div></div><div id="toggle-privacy" class="toggle-switch" onclick="togglePrivacy()"><div class="toggle-dot"></div></div></div></div><div><h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">About</h3><a href="#" class="flex items-center justify-between py-3 hover:bg-gray-50 rounded-lg px-2 -mx-2 transition-colors group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600"><i data-lucide="crown" class="w-4 h-4"></i></div><span class="font-medium text-gray-900">Premium</span></div><i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 group-hover:text-gray-600"></i></a></div></div><div class="mt-6 pt-4 border-t border-gray-100"><button onclick="doLogout()" class="w-full py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-colors">Log Out</button></div></div></div>
<div id="user-list-overlay" class="fixed inset-0 z-[70] flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeUserList()"><div id="user-list-modal" class="bg-white w-full h-[70vh] md:h-auto md:w-[400px] md:max-h-[80vh] md:rounded-[24px] rounded-t-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="h-16 border-b border-gray-100 flex items-center justify-between px-4 shrink-0"><button onclick="closeUserList()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="font-bold text-gray-900 text-lg" id="user-list-title">Users</span><div class="w-10"></div></div><div id="user-list-content" class="flex-1 overflow-y-auto p-2"></div></div></div>
<div id="create-menu-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="closeCreateMenu()"><div id="create-menu-modal" class="bg-white w-[90%] max-w-[500px] rounded-[24px] shadow-2xl p-6 relative transform scale-95 transition-transform duration-200" onclick="event.stopPropagation()"><div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-[#1f1f1f] google-font">Create New</h2><button onclick="closeCreateMenu()" class="icon-btn hover:bg-[#f0f4f9]"><i data-lucide="x" class="w-5 h-5"></i></button></div><div class="grid grid-cols-1 gap-4"><div class="create-option-card" onclick="openCompose()"><div class="create-icon-bg"><i data-lucide="pen-tool" class="w-6 h-6"></i></div><span class="font-bold text-[#1f1f1f]">Post</span></div><div id="create-option-ad" class="create-option-card hidden" onclick="openPromoModal(event);closeCreateMenu()"><div class="create-icon-bg"><i data-lucide="megaphone" class="w-6 h-6"></i></div><span class="font-bold text-[#1f1f1f]">Ad</span></div></div></div></div>
<div id="edit-profile-overlay" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/40 backdrop-blur-sm hidden opacity-0 transition-opacity duration-200" onclick="closeEditProfile()"><div id="edit-profile-modal" class="bg-white w-full h-full md:h-auto md:w-[95%] md:max-w-[500px] md:max-h-[90vh] md:rounded-[24px] rounded-none shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div class="flex justify-between items-center h-16 px-4 border-b border-gray-100 shrink-0 bg-white"><button onclick="closeEditProfile()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><h2 class="text-lg font-bold google-font">Edit Profile</h2><div class="w-10"></div></div><div class="flex-1 overflow-y-auto p-0 pb-20 md:pb-6 relative"><div class="relative"><div id="banner-edit-area" class="h-36 w-full bg-gray-200 relative overflow-hidden cursor-grab group" onclick="document.getElementById('edit-banner-input').click()"><img id="edit-banner-preview" src="" class="w-full h-full object-cover pointer-events-none select-none"><div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="text-white w-8 h-8 drop-shadow-md"></i></div></div><div class="absolute -bottom-10 left-4"><div class="relative group cursor-pointer" onclick="document.getElementById('edit-avatar-input').click()"><img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-4 border-white bg-gray-100 object-cover"><div class="absolute inset-0 rounded-full bg-black/20 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="camera" class="text-white w-6 h-6 drop-shadow-md"></i></div></div></div><div class="absolute top-2 right-2 bg-black/50 text-white text-[10px] px-2 py-1 rounded-md pointer-events-none backdrop-blur-sm">Drag to reposition: <span id="banner-pos-hint">50%</span></div></div><div class="mt-12 px-6 flex flex-col gap-6"><input type="file" id="edit-avatar-input" class="hidden" accept="image/*" onchange="handleEditAvatarSelect(event)"><input type="file" id="edit-banner-input" class="hidden" accept="image/*" onchange="handleEditBannerSelect(event)"><div><label class="text-xs font-bold text-gray-500 uppercase">Display Name</label><input type="text" id="edit-name" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900 text-lg"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Username</label><div class="relative"><span class="absolute left-0 top-2 text-gray-400 font-medium">@</span><input type="text" id="edit-username" class="w-full border-b border-gray-200 py-2 pl-4 outline-none focus:border-blue-500 font-medium text-gray-900"></div></div><div><label class="text-xs font-bold text-gray-500 uppercase">Email</label><input type="text" id="edit-email" class="w-full border-b border-gray-200 py-2 outline-none text-gray-500 bg-transparent select-text" disabled></div><div><label class="text-xs font-bold text-gray-500 uppercase">Bio</label><textarea id="edit-bio" class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 text-sm text-gray-700 resize-none" rows="3"></textarea></div></div></div><div class="p-4 border-t border-gray-100 bg-white absolute bottom-0 w-full md:relative"><button id="save-profile-btn" onclick="saveProfileChanges()" class="w-full bg-gray-100 text-gray-900 py-3 rounded-xl font-bold hover:bg-gray-200 transition-all">Save Changes</button></div></div></div>
<input type="file" id="event-cover-input" class="hidden" accept="image/*" onchange="handleEventCoverSelect(event)">
<div id="event-overlay" class="fixed inset-0 z-[55] flex items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"><div id="event-modal-box" class="bg-white w-[95%] max-w-[550px] rounded-[16px] shadow-2xl relative transform scale-95 transition-transform duration-200 flex flex-col overflow-hidden p-0"><div id="event-cover-preview-container" class="w-full h-40 bg-gray-100 hidden relative group"><img id="event-cover-preview" class="w-full h-full object-cover"><button onclick="removeEventCover()" class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70 z-20"><i data-lucide="x" class="w-4 h-4"></i></button><button onclick="document.getElementById('event-cover-input').click()" class="absolute top-1/2 -translate-y-1/2 right-2 bg-white/80 text-gray-700 text-xs font-bold px-3 py-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white z-20 shadow-sm">Change</button></div><button onclick="closeEventComposer()" class="absolute top-4 right-4 icon-btn hover:bg-[#f0f4f9] z-10 bg-white/50 backdrop-blur-sm"><i data-lucide="x" class="w-5 h-5"></i></button><div class="p-8 pt-6"><div id="add-cover-btn" class="mb-6 opacity-60 hover:opacity-100 transition-opacity cursor-pointer flex items-center gap-2 text-sm text-[#667085]" onclick="document.getElementById('event-cover-input').click()"><i data-lucide="image" class="w-4 h-4"></i> Add cover</div><input type="text" id="event-title" placeholder="Untitled Event" class="text-3xl font-bold text-[#1f1f1f] placeholder-[#d1d5db] border-none outline-none bg-transparent w-full mb-6 google-font"><div class="flex flex-col gap-1 mb-6"><div class="notion-input-row"><div class="notion-label"><i data-lucide="clock" class="w-4 h-4"></i> Date</div><input type="date" id="event-date" class="notion-input"></div><div class="notion-input-row"><div class="notion-label"><i data-lucide="watch" class="w-4 h-4"></i> Time</div><input type="time" id="event-time" class="notion-input"></div><div class="notion-input-row"><div class="notion-label"><i data-lucide="map-pin" class="w-4 h-4"></i> Location</div><input type="text" id="event-location" placeholder="Add location..." class="notion-input"></div></div><textarea id="event-desc" placeholder="Add description..." class="w-full min-h-[100px] resize-none border-none outline-none text-[#374151] text-[15px] leading-relaxed bg-transparent"></textarea><div class="flex justify-end mt-6 pt-4 border-t border-gray-100"><button onclick="publishEvent()" class="bg-[#0b57d0] text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-[#0b57d0]/90 transition-all shadow-sm">Create Event</button></div></div></div></div>
<div id="compose-overlay" class="fixed inset-0 z-[55] flex items-end md:items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200" onclick="attemptCloseCompose()"><div id="compose-modal" class="bg-white w-full h-full md:h-auto md:w-[95%] md:max-w-[620px] rounded-none md:rounded-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden" onclick="event.stopPropagation()"><div id="compose-progress-overlay" class="absolute inset-0 bg-white/90 backdrop-blur-sm z-[60] hidden flex-col items-center justify-center"><div class="w-64 h-2 bg-gray-200 rounded-full overflow-hidden mb-4"><div id="post-progress-bar" class="h-full bg-[#0b57d0] transition-all duration-300 w-0"></div></div><p class="font-bold text-gray-900 animate-pulse">Posting...</p></div><div class="flex items-center justify-between h-16 px-4 border-b border-gray-100 md:h-16"><button onclick="handleComposeBack()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i></button><span class="text-lg font-bold text-gray-900" id="compose-header-title">Create Post</span><div class="w-10"></div></div><div id="compose-body" class="flex-1 overflow-y-auto relative"><div id="compose-step-1" class="p-4 h-full flex flex-col"><div class="grid grid-cols-2 gap-4" id="media-grid-container"></div></div><div id="compose-step-2" class="p-4 hidden"><div class="flex gap-3 mb-4 items-center"><img id="compose-avatar" src="" class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover"><div><div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div></div></div><textarea id="compose-text" placeholder="What's on your mind?" class="w-full min-h-[150px] text-lg resize-none border-none outline-none bg-transparent placeholder-gray-400"></textarea><div id="collab-chips-container" class="flex flex-wrap mb-2"></div></div></div><div class="bg-white border-t border-gray-100 z-10"><div id="compose-footer-settings" class="hidden border-b border-gray-100"><div class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleComposeSettings()"><span class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2"><i data-lucide="settings-2" class="w-4 h-4"></i> Post Settings</span><i data-lucide="chevron-up" id="compose-settings-arrow" class="w-4 h-4 text-gray-400 transition-transform"></i></div><div id="compose-settings-area" class="hidden px-4 pb-4 space-y-3 bg-gray-50/50"><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="lock" class="w-4 h-4"></i> Private (Followers Only)</div><input type="checkbox" id="post-setting-privacy" class="accent-blue-600 w-4 h-4 cursor-pointer"></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="heart" class="w-4 h-4"></i> Show Like Count</div><input type="checkbox" id="post-setting-likes" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-square" class="w-4 h-4"></i> Show Comment Count</div><input type="checkbox" id="post-setting-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="users" class="w-4 h-4"></i> Allow viewers to see who liked</div><input type="checkbox" id="post-setting-like-view" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div><div class="flex items-center justify-between"><div class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="message-circle" class="w-4 h-4"></i> Allow comments</div><input type="checkbox" id="post-setting-allow-comments" class="accent-blue-600 w-4 h-4 cursor-pointer" checked></div></div></div><div class="p-4"><button id="compose-action-btn" class="w-full py-3 bg-gray-100 text-gray-900 font-bold rounded-xl hover:bg-gray-200 transition-colors" onclick="handleComposeAction()">Skip</button></div></div></div></div>
<aside id="main-sidebar" class="hidden md:flex app-panel"><div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain"><h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1></div><button onclick="openCreateMenu()" class="create-btn hidden lg:flex"><i data-lucide="plus" class="w-5 h-5"></i><span>Create</span></button><nav class="flex-1 space-y-1" id="desktop-nav-items"><a href="#" onclick="switchView('feed');return false;" id="nav-feed" class="nav-item active"><i data-lucide="home" class="w-5 h-5"></i> <span class="hidden lg:block">Home</span></a><a href="#" onclick="switchView('explore');return false;" id="nav-explore" class="nav-item"><i data-lucide="compass" class="w-5 h-5"></i> <span class="hidden lg:block">Explore</span></a><a href="#" onclick="switchView('network');return false;" id="nav-network" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i> <span class="hidden lg:block">Network</span></a><a href="#" onclick="switchView('notifications');return false;" id="nav-notifications" class="nav-item relative"><i data-lucide="bell" class="w-5 h-5"></i><span class="hidden lg:block">Notifications</span><span id="nav-notif-badge" class="nav-badge">0</span></a><a href="#" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null);return false;" id="nav-profile" class="nav-item"><i data-lucide="user" class="w-5 h-5"></i> <span class="hidden lg:block">Profile</span></a></nav><div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2"><div class="sidebar-user group cursor-pointer" onclick="openSettings()"><div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-600 hover:bg-gray-200 transition-colors"><i data-lucide="settings" class="w-5 h-5"></i></div><div class="hidden lg:block"><div class="text-sm font-bold text-[#1f1f1f]">Settings</div></div></div><div class="sidebar-user group" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"><img id="sidebar-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover"><div class="hidden lg:block"><div id="sidebar-name" class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">User</div><div class="text-xs text-[#667085]">View Profile</div></div></div></div></aside>
<div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300"><main id="main-panel" class="flex-1 app-panel min-w-0 relative"><header id="main-header" class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 absolute top-0 w-full bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0] transition-transform duration-300"><div class="md:hidden flex items-center gap-3 cursor-pointer" onclick="switchView('feed')"><img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain"><h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1></div><div class="flex-1 max-w-[600px] relative group hidden md:block"><i data-lucide="search" class="absolute left-5 top-3.5 w-5 h-5 text-[#667085] group-focus-within:text-[#0b57d0] transition-colors"></i><input type="text" placeholder="Search EduLink" id="global-search" oninput="handleSearch(this.value)" class="w-full bg-[#f3f4f6] rounded-full py-3.5 pl-14 pr-6 outline-none focus:bg-[#ffffff] focus:shadow-sm focus:ring-1 focus:ring-gray-200 transition-all text-[#1f1f1f] text-[15px]"></div><div class="flex items-center gap-3 pl-4"><button onclick="openSettings()" class="icon-btn hover:bg-gray-100 md:hidden"><i data-lucide="settings" class="w-6 h-6"></i></button><button class="icon-btn relative" onclick="toggleNotifications()"><i data-lucide="bell" class="w-6 h-6"></i></button><img id="header-avatar" src="" class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all hidden md:block" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"></div></header>
<div id="ptr-spinner"><i data-lucide="arrow-down" class="w-5 h-5"></i></div>
<div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white pt-16 md:pt-20"><div id="feed-container"></div><div class="flex flex-col items-center justify-center py-10 opacity-60"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=Chase" class="w-24 h-24 mb-4 opacity-80 grayscale hover:grayscale-0 transition-all duration-500"><h3 class="text-lg font-bold text-gray-400 google-font">Grow and Share</h3><p class="text-sm text-gray-400 text-center max-w-xs mt-1">Your network starts here. Share your first idea!</p></div></div>
<div id="view-saved" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Saved Posts</h2><div id="saved-container" class="space-y-4"></div></div>
<div id="view-network" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">My Network</h2><div class="tab-group mb-4 mx-0 md:mx-0"><button onclick="switchNetworkTab('people')" id="net-tab-people" class="tab-btn active">People</button><button onclick="switchNetworkTab('posts')" id="net-tab-posts" class="tab-btn">Posts</button></div><div id="network-content"></div></div>
<div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>
<div id="view-notifications" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:p-6 hidden bg-white pt-[106px] md:pt-6"><div class="flex justify-between items-center mb-6 px-4 md:px-0 hidden md:flex"><h2 class="text-2xl font-bold">Notifications</h2><button onclick="clearAllNotifications()" class="text-xs text-red-500 font-bold hover:underline">Clear All</button></div><div class="tab-group mb-4 mx-0 md:mx-0 hidden md:flex"><button onclick="switchNotifTab('all')" id="ntab-all" class="tab-btn active"><i data-lucide="bell" class="w-4 h-4"></i> All</button><button onclick="switchNotifTab('official')" id="ntab-official" class="tab-btn"><i data-lucide="megaphone" class="w-4 h-4"></i> Official</button></div><div id="notification-list" class="flex flex-col w-full pb-24 md:pb-0"></div></div>
<div id="view-announcements" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-white pt-16 md:pt-6"><h2 class="text-2xl font-bold mb-6 px-4 md:px-0">Broadcast Announcement</h2><div class="p-6 bg-white rounded-xl border border-gray-200 shadow-sm max-w-2xl mb-8"><label class="block text-sm font-bold text-gray-700 mb-2">Message to All Users</label><textarea id="announcement-text" class="w-full h-32 border border-gray-300 rounded-lg p-3 outline-none focus:border-blue-500 mb-4" placeholder="Type your official announcement here..."></textarea><div class="flex items-center justify-between"><button id="send-announcement-btn" onclick="sendAnnouncement()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">Send Broadcast</button></div></div></div>
<div id="view-events" class="flex-1 h-full overflow-y-auto p-0 md:p-6 hidden bg-[#f9fafb] md:bg-[#fff] pt-16 md:pt-6"><div class="flex items-center justify-between mb-6 px-4 md:px-0"><h2 class="text-2xl font-bold text-[#1f1f1f]">Upcoming Events</h2><button onclick="openEventComposer()" class="bg-[#0b57d0] text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> New Event</button></div><div id="events-list" class="grid grid-cols-1 gap-4 px-4 md:px-0"></div></div>
<div id="view-explore" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 md:pt-20 hidden bg-white"><div id="explore-header-container" class="sticky top-0 bg-white z-20 border-b border-gray-100 md:hidden"><div class="h-14 flex items-center px-4 shrink-0"><div class="relative bg-gray-100 rounded-xl flex items-center px-3 py-2 w-full"><i data-lucide="search" class="w-4 h-4 text-gray-400 mr-2"></i><input type="text" id="mobile-explore-search" class="bg-transparent border-none outline-none text-sm w-full" placeholder="Search..." oninput="handleSearch(this.value)"></div></div><div class="tab-group"><button id="tab-explore-main" onclick="switchExploreMainTab('explore')" class="tab-btn active"><i data-lucide="grid" class="w-5 h-5"></i></button><button id="tab-explore-video" onclick="switchExploreMainTab('video')" class="tab-btn"><i data-lucide="play-circle" class="w-5 h-5"></i></button><button id="tab-explore-people" onclick="switchExploreMainTab('people')" class="tab-btn"><i data-lucide="users" class="w-5 h-5"></i></button><button id="tab-explore-tags" onclick="switchExploreMainTab('tags')" class="tab-btn"><i data-lucide="hash" class="w-5 h-5"></i></button></div></div><div class="hidden md:block w-full bg-white z-10 border-b border-gray-100"><div class="max-w-5xl mx-auto tab-group border-b-0 px-0 justify-center"><button id="tab-explore-main-d" onclick="switchExploreMainTab('explore')" class="tab-btn active max-w-[120px]"><i data-lucide="grid" class="w-4 h-4"></i> Posts</button><button id="tab-explore-video-d" onclick="switchExploreMainTab('video')" class="tab-btn max-w-[120px]"><i data-lucide="play-circle" class="w-4 h-4"></i> Videos</button><button id="tab-explore-people-d" onclick="switchExploreMainTab('people')" class="tab-btn max-w-[120px]"><i data-lucide="users" class="w-4 h-4"></i> People</button><button id="tab-explore-tags-d" onclick="switchExploreMainTab('tags')" class="tab-btn max-w-[120px]"><i data-lucide="hash" class="w-4 h-4"></i> Tags</button></div></div><div id="explore-content-wrapper" class="pb-32 max-w-5xl mx-auto py-6"><div id="explore-people-results" class="hidden flex-col p-4 pt-0"></div><div id="explore-results" class="space-y-0 pt-0"></div></div></div></main><aside id="trending-panel" class="trending-panel hidden xl:flex app-panel mb-16 md:mb-0 flex-col bg-white"><div class="h-16 md:h-20 shrink-0 border-b border-[#f0f0f0] flex items-center justify-between px-6 bg-white/95 backdrop-blur z-20"><div class="flex items-center gap-3"><span class="text-[19px] font-bold text-[#1f1f1f] google-font">People</span></div></div><div class="flex-1 overflow-y-auto p-5"><div class="mb-8"><h3 class="text-lg font-bold text-[#1f1f1f] mb-4">Who to follow</h3><div id="who-to-follow-list" class="flex flex-col gap-4"></div></div><div id="promo-section" class="hidden"><div class="relative group rounded-xl overflow-hidden cursor-pointer"><a id="promo-link" href="#" target="_blank" class="block w-full h-full"><img id="promo-image" src="" class="w-full h-auto object-cover rounded-xl border border-gray-200 hover:opacity-95 transition-opacity"></a><button id="edit-promo-btn" onclick="openPromoModal(event)" class="absolute top-2 right-2 bg-black/60 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/80 hidden z-20"><i data-lucide="edit-2" class="w-4 h-4"></i></button><div class="absolute bottom-2 left-2 bg-black/60 text-white text-[10px] px-2 py-0.5 rounded-md font-medium uppercase tracking-wide backdrop-blur-sm pointer-events-none">Promoted</div></div></div></div></aside></div>
<nav id="mobile-bottom-nav" class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg transition-transform duration-300"><div class="mobile-nav-item active" onclick="switchView('feed')"><i data-lucide="home"></i></div><div class="mobile-nav-item" onclick="switchView('explore')"><i data-lucide="compass"></i></div><div class="mobile-nav-item" onclick="openCreateMenu()"><i data-lucide="plus-square"></i></div><div class="mobile-nav-item" onclick="switchView('notifications')"><div class="relative"><i data-lucide="bell"></i><span id="mobile-footer-badge" class="mobile-footer-badge">0</span></div></div><div class="mobile-nav-item" onclick="showProfile(auth.currentUser?auth.currentUser.uid:null)"><img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200"></div></nav>
<input type="file" id="media-input" class="hidden" accept="image/*,video/*" onchange="handleFileSelect(event)">
<input type="file" id="grid-upload-input" class="hidden" accept="image/*,video/*" onchange="onGridFileSelect(event)">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadString, getDownloadURL, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
const firebaseConfig = { apiKey:"AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno", authDomain:"edulinki.firebaseapp.com", projectId:"edulinki", storageBucket:"edulinki.firebasestorage.app", messagingSenderId:"248886466474", appId:"1:248886466474:web:160043201a6b28bafbbdd3", measurementId:"G-MQBH12VL7N" };
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app); const storage=getStorage(app); window.auth=auth; window.db=db;
let currentUser=null, users=[], posts=[], notifications=[], savedPosts=[], activeNotifTab='all', activeNetworkTab='people';
window.replyingToCommentId=null; window.currentViewingProfileId=null; window.activeExploreTab='explore'; window.activeExploreCategory='For You'; window.currentProfileTab='posts';
window.currentMedia=[]; window.uploadMode='single'; window.currentMediaType=null; window.isWebSearchActive=false;
let stopGeneration=false, abortController=null; window.isPlusMenuOpen=false; window.currentEventCover=null; window.editingPostId=null; window.threadParentCommentId=null; window.threadPostId=null;
let currentEventCoverBlob=null, currentAvatarBlob=null, currentBannerBlob=null; window.currentPromoBlob=null;
window.notifSelectionMode=false; window.selectedNotifs=new Set(); window.notifSearchTerm=''; window.selectedCollaborators=[];
window.currentSharePid=null; window.currentViewingAuthorId=null;
window.currentSuggestionIds = []; window.lastSuggestionRefresh = 0;
window.composeStep=1; window.composeImages=[null,null,null,null]; window.composeImageBlobs=[...window.composeImages];
let lastScrollTop=0, lastExploreScrollTop=0, html5QrCode, ptrStartY=0, ptrDist=0, isPtr=false, isRefreshing=false;
const feedView=document.getElementById('view-feed'), exploreView=document.getElementById('view-explore'), ptrSpinner=document.getElementById('ptr-spinner'),
refreshIcons=()=>window.lucide?.createIcons();

function setupSwipeClose(mid,oid,cb){
    let sy=0, m=document.getElementById(mid); if(!m)return;
    const chk=()=>{const c=m.querySelector('.overflow-y-auto'); return document.getElementById(oid).classList.contains('hidden')||(c&&c.scrollTop>0)};
    m.addEventListener('touchstart',e=>{if(!chk()) sy=e.touches[0].clientY},{passive:true});
    m.addEventListener('touchmove',e=>{if(chk()||!sy)return; const d=e.touches[0].clientY-sy; if(d>0){e.preventDefault(); m.style.transform=`translateY(${d}px)`}},{passive:false});
    m.addEventListener('touchend',e=>{if(chk()||!sy)return; const d=e.changedTouches[0].clientY-sy; if(d>100){cb(); setTimeout(()=>m.style.transform='',300)}else m.style.transform=''; sy=0},{passive:true});
}

if(feedView){
    feedView.addEventListener('touchstart',e=>{if(!feedView.scrollTop&&!isRefreshing){ptrStartY=e.touches[0].pageY;isPtr=true;ptrSpinner.style.transition='none'}},{passive:true});
    feedView.addEventListener('touchmove',e=>{if(!isPtr||isRefreshing)return; const d=e.touches[0].pageY-ptrStartY; if(d>0&&!feedView.scrollTop){if(e.cancelable)e.preventDefault(); ptrDist=d; const y=Math.min(d*.4,80); Object.assign(ptrSpinner.style,{transform:`translateX(-50%) translateY(${y}px) rotate(${y*3}deg)`,opacity:Math.min(y/40,1)})}else{isPtr=false;ptrSpinner.style.opacity='0';ptrSpinner.style.transform='translateX(-50%) translateY(-20px)'}},{passive:false});
    feedView.addEventListener('touchend',async()=>{if(!isPtr||isRefreshing)return; isPtr=false; ptrSpinner.style.transition='all .3s'; if(ptrDist>100){isRefreshing=true; Object.assign(ptrSpinner.style,{transform:'translateX(-50%) translateY(50px)',opacity:'1'}); ptrSpinner.innerHTML='<i data-lucide="loader-2" class="animate-spin w-5 h-5 text-blue-600"></i>'; refreshIcons(); await new Promise(r=>setTimeout(r,1000)); renderFeed(); showToast("Feed updated"); isRefreshing=false; ptrSpinner.style.transform='translateX(-50%) translateY(-20px)'; ptrSpinner.style.opacity='0'; setTimeout(()=>{ptrSpinner.innerHTML='<i data-lucide="arrow-down" class="w-5 h-5 text-blue-600"></i>';refreshIcons()},300)}else{ptrSpinner.style.transform='translateX(-50%) translateY(-20px)';ptrSpinner.style.opacity='0'} ptrDist=0});
    feedView.addEventListener('scroll',()=>{const c=feedView.scrollTop, h=document.getElementById('main-header'); h.style.transform=c>lastScrollTop&&c>60?'translateY(-100%)':'translateY(0)'; lastScrollTop=Math.max(0,c)},{passive:true});
}
if(exploreView) exploreView.addEventListener('scroll',()=>{const c=exploreView.scrollTop, h=document.getElementById('explore-header-container'); h.style.transform=c>lastExploreScrollTop&&c>60?'translateY(-100%)':'translateY(0)'; lastExploreScrollTop=Math.max(0,c)},{passive:true});

const formatDate=t=>{if(!t)return''; const d=t.toDate?t.toDate():new Date(t), s=(new Date()-d)/1000; return s<60?'Just now':s<3600?~~(s/60)+'m ago':s<86400?~~(s/3600)+'h ago':s<604800?~~(s/86400)+'d ago':d.toLocaleDateString()};
const formatContent=t=>{if(!t)return''; return t.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])).replace(/@(\w+)/g,(m,u)=>{const f=users.find(x=>(x.username||'').toLowerCase()===u.toLowerCase()); return `<span class="text-blue-600 font-bold ${f?'cursor-pointer hover:underline" onclick="event.stopPropagation(); showProfile(\''+f.id+'\')':''}">@${u}</span>`}).replace(/#(\w+)/g,'<span class="text-blue-600 font-bold cursor-pointer hover:underline" onclick="event.stopPropagation(); searchTag(\'$1\')">#$1</span>').replace(/\n/g,'<br>')};
window.searchTag=t=>{switchView('explore'); document.getElementById('mobile-explore-search').value=document.getElementById('global-search').value=`#${t}`; handleSearch(`#${t}`)};
onAuthStateChanged(auth,async u=>{
    const l=document.getElementById('app-loader'); if(!u) return window.location.href='index.html';
    const r=doc(db,"users",u.uid), s=await getDoc(r), off=u.email==='edulinkbht@gmail.com';
    if(s.exists()){ currentUser={id:u.uid,...s.data()}; if(off&&!currentUser.isOfficial) await updateDoc(r,{isOfficial:true}); }
    else{ currentUser={id:u.uid,name:u.displayName||u.email.split('@')[0],email:u.email,avatar:u.photoURL||`https://api.dicebear.com/9.x/lorelei/svg?seed=${u.uid}`,bio:"New EduLink Member",following:[],followers:[],friends:[],saved:[],links:[],isOfficial:off,settings:{privateNetwork:false},username:""}; await setDoc(r,currentUser); }
    currentUser.following||=[]; currentUser.followers||=[]; currentUser.friends||=[]; currentUser.saved||=[]; currentUser.links||=[]; currentUser.settings||={privateNetwork:false}; window.currentUser=currentUser; savedPosts=currentUser.saved;
    if(!currentUser.username) document.getElementById('username-modal').classList.remove('hidden');
    updateUserInterface(); initRealtimeListeners(); refreshIcons(); initBannerDrag();
    if(l){l.style.opacity='0'; setTimeout(()=>l.remove(),500)}
    const p=new URLSearchParams(window.location.search).get('postId');
    if(p) setTimeout(()=>{openPostView(p); window.history.pushState({},document.title,window.location.pathname)},1000);
});

window.saveUsername=async()=>{
    const v=document.getElementById('new-username-input').value.trim().toLowerCase();
    if(v.length<3||/\s/.test(v)||!/^[a-z0-9_.]+$/.test(v)) return showToast("Invalid username",true);
    if(!(await getDocs(query(collection(db,"users"),where("username","==",v)))).empty) return showToast("Taken",true);
    await updateDoc(doc(db,"users",currentUser.id),{username:v}); currentUser.username=v;
    document.getElementById('username-modal').classList.add('hidden'); showToast("Username set!");
};

function initRealtimeListeners(){
    onSnapshot(collection(db,"users"),s=>{
        users=s.docs.map(d=>({id:d.id,...d.data()}));
        if(window.pendingProfileUid && users.some(u=>u.id===window.pendingProfileUid)){ showProfile(window.pendingProfileUid); window.pendingProfileUid=null; window.history.replaceState({},document.title,window.location.pathname); }
        if(!document.getElementById('view-network').classList.contains('hidden')) renderNetwork();
        renderRightSidebar(); refreshIcons();
    });

    onSnapshot(doc(db,"global","promo"),s=>{
        const sec=document.getElementById('promo-section');
        if(s.exists()&&s.data().imageUrl){ sec.classList.remove('hidden'); document.getElementById('promo-image').src=s.data().imageUrl; document.getElementById('promo-link').href=s.data().linkUrl||'#'; }
        else if(currentUser?.email!=='edulinkbht@gmail.com') sec.classList.add('hidden');
    });

    onSnapshot(query(collection(db,"posts"),orderBy("timestamp","desc")),{includeMetadataChanges:true},s=>{
        posts=s.docs.map(d=>({id:d.id,...d.data(),timestamp:d.data().timestamp}));
        const ch=s.docChanges();
        
        // Handle removals with scoped selectors
        ch.filter(c => c.type === 'removed').forEach(c => {
           document.querySelectorAll(`[id*='post-card-'][id$='-${c.doc.id}']`).forEach(el => el.remove());
        });

        // Handle updates and adds
        if(ch.some(c=>c.type==='added')) {
             if(!document.getElementById('view-feed').classList.contains('hidden')) renderFeed();
             if(!document.getElementById('view-explore').classList.contains('hidden')) handleSearch(document.getElementById('global-search').value||document.getElementById('mobile-explore-search').value);
        }

        posts.forEach(p => {
             // Realtime Like/Save Buttons & Counts across all contexts
             const isLiked = p.likes && p.likes.includes(currentUser.id);
             document.querySelectorAll(`.js-like-btn-${p.id}`).forEach(btn => {
                if(isLiked) btn.classList.add('active'); else btn.classList.remove('active');
             });
             
             document.querySelectorAll(`.js-like-count-${p.id}`).forEach(el => el.innerText = p.likes?.length || 0);
             document.querySelectorAll(`.js-comment-count-${p.id}`).forEach(el => el.innerText = p.comments?.length || 0);
             
             const isSaved = savedPosts.includes(p.id);
             document.querySelectorAll(`.js-save-btn-${p.id}`).forEach(btn => {
                if(isSaved) btn.classList.add('active'); else btn.classList.remove('active');
             });

             // Realtime Content Update (Edit)
             const newHtml = p.content.length>180 ? `${formatContent(p.content.substring(0,180))}...<span id="read-more-${p.id}" class="read-more-btn" onclick="event.stopPropagation(); toggleReadMore('${p.id}')">more</span>` : formatContent(p.content);
             document.querySelectorAll(`.js-post-body-${p.id}`).forEach(el => {
                 if(el.dataset.full !== p.content) {
                     el.dataset.full = p.content.replace(/"/g,'&quot;');
                     el.innerHTML = newHtml;
                 }
             });
        });
        
        if(!document.getElementById('view-saved').classList.contains('hidden')) renderSaved();
        if(!document.getElementById('view-network').classList.contains('hidden')&&activeNetworkTab==='posts') renderNetwork();
        
        if(window.currentViewingPostId){ 
            const cp=posts.find(p=>p.id===window.currentViewingPostId); 
            if(cp){ 
                renderCommentsInModal(window.currentViewingPostId); 
                updatePostViewStats(window.currentViewingPostId); 
            } else closePostView();
        }
        if(window.threadPostId) renderThreadContent(window.threadPostId,window.threadParentCommentId);
        
        renderRightSidebar(); setTimeout(refreshIcons,50);
    });

    onSnapshot(query(collection(db,"notifications"),where("receiverId","==",currentUser.id)),s=>{
        notifications=s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.timestamp?.toDate?.()||0)-(a.timestamp?.toDate?.()||0));
        const u=notifications.filter(n=>!n.read).length, t=u>99?'99+':u, d=document.getElementById('nav-notif-badge'), m=document.getElementById('mobile-footer-badge');
        if(d){d.style.display=u?'flex':'none'; d.innerText=t} if(m){m.style.display=u?'flex':'none'; m.innerText=t}
        if(!document.getElementById('view-notifications').classList.contains('hidden')) renderNotifications(); refreshIcons();
    });
}

window.renderRightSidebar=()=>{
    const l=document.getElementById('who-to-follow-list'), now=Date.now();
    if(!l||!currentUser) return;
    if(!window.currentSuggestionIds?.length || now-(window.lastSuggestionRefresh||0)>180000){
        window.currentSuggestionIds=users.filter(u=>u.id!==currentUser.id&&u.name).sort(()=>.5-Math.random()).slice(0,3).map(u=>u.id); window.lastSuggestionRefresh=now;
    }
    const c=window.currentSuggestionIds.map(id=>users.find(u=>u.id===id)).filter(Boolean);
    l.innerHTML=c.length?c.map(u=>{
        const isF=currentUser.following.includes(u.id);
        return `<div class="flex items-center justify-between" onclick="showProfile('${u.id}')"><div class="flex items-center gap-3 overflow-hidden"><img src="${u.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover shrink-0"><div class="min-w-0"><div class="font-bold text-sm text-gray-900 truncate hover:underline cursor-pointer">${u.name}</div><div class="text-xs text-gray-500 truncate">@${u.username||'user'}</div></div></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="${isF?'bg-gray-100 text-gray-900 border border-gray-200':'bg-black text-white'} text-xs px-3 py-1.5 rounded-full font-bold hover:opacity-80 transition-colors">${isF?'Following':'Follow'}</button></div>`
    }).join(''):'<div class="text-sm text-gray-400 p-2">No suggestions.</div>';
};
window.openPromoModal=e=>{ if(e){e.stopPropagation();e.preventDefault();} document.getElementById('promo-modal').classList.remove('hidden'); const i=document.getElementById('promo-image'), l=document.getElementById('promo-link'); if(i.src) document.getElementById('promo-img-url').value=i.src; if(l.href) document.getElementById('promo-target-url').value=l.href; };
window.handlePromoFile=e=>{ const f=e.target.files[0]; if(f){ window.currentPromoBlob=f; showToast("Image selected"); } };
window.savePromo=async()=>{ const b=event.target, ot=b.innerText; b.innerText="Saving..."; b.disabled=true; let i=document.getElementById('promo-img-url').value.trim(); const l=document.getElementById('promo-target-url').value.trim(); if(window.currentPromoBlob) try{ i=await uploadToImgHippo(window.currentPromoBlob); }catch(e){ return showToast("Upload failed"); } if(!i){ showToast("Image URL required"); b.innerText=ot; b.disabled=false; return; } await setDoc(doc(db,"global","promo"),{imageUrl:i,linkUrl:l}); showToast("Promo updated!"); document.getElementById('promo-modal').classList.add('hidden'); window.currentPromoBlob=null; b.innerText=ot; b.disabled=false; };
window.updatePostViewStats=pid=>{ const p=posts.find(x=>x.id===pid); if(!p) return; const dl=document.getElementById('post-view-likes-count'), ml=document.getElementById('mobile-overlay-like-count'), mc=document.getElementById('mobile-overlay-comment-count'), rli=document.getElementById('mobile-overlay-like-icon'), rsi=document.getElementById('mobile-overlay-save-icon'); if(dl) dl.innerText=`${p.likes?p.likes.length:0} likes`; if(ml){ ml.innerText=p.likes?p.likes.length:0; } if(mc) mc.innerText=p.comments?p.comments.length:0; if(rli){ if(p.likes&&p.likes.includes(currentUser.id)) rli.classList.add('fill-red-500','text-red-500'), rli.classList.remove('text-[#1f1f1f]'); else rli.classList.remove('fill-red-500','text-red-500'), rli.classList.add('text-[#1f1f1f]'); } if(rsi){ if(savedPosts.includes(pid)) rsi.classList.add('fill-yellow-500','text-yellow-500','text-yellow-500'); else rsi.classList.remove('fill-yellow-500','text-yellow-500','text-yellow-500'), rsi.classList.add('text-[#1f1f1f]'); } };
function updateUserInterface(){ if(!currentUser) return; const u=currentUser; document.getElementById('sidebar-name').innerText=u.name; document.getElementById('sidebar-avatar').src=u.avatar; document.getElementById('mobile-avatar').src=u.avatar; document.getElementById('header-avatar').src=u.avatar; document.getElementById('compose-name').innerText=u.name; document.getElementById('compose-avatar').src=u.avatar; document.getElementById('edit-name').value=u.name; document.getElementById('edit-username').value=u.username || ""; document.getElementById('edit-bio').value=u.bio; document.getElementById('edit-avatar-preview').src=u.avatar; const bp=u.bannerPos||50, bu=u.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'; document.getElementById('edit-banner-preview').src=bu; document.getElementById('edit-banner-preview').style.objectPosition=`center ${currentBannerPos}%`; document.getElementById('banner-pos-hint').innerText=`${currentBannerPos}%`; const tp=document.getElementById('toggle-privacy'); if(tp) u.settings?.privateNetwork?tp.classList.add('active'):tp.classList.remove('active'); if(u.email==='edulinkbht@gmail.com'){ const nav=document.querySelector('#desktop-nav-items'); if(!document.getElementById('nav-announcements')){ const a=document.createElement('a'); a.href="#"; a.id="nav-announcements"; a.className="nav-item text-blue-600"; a.innerHTML=`<i data-lucide="megaphone" class="w-5 h-5"></i> <span class="hidden lg:block">Announcements</span>`; a.onclick=()=>{switchView('announcements');return false;}; nav.appendChild(a); } document.getElementById('edit-promo-btn').classList.remove('hidden'); document.getElementById('promo-section').classList.remove('hidden'); document.getElementById('create-option-ad').classList.remove('hidden'); } else document.getElementById('create-option-ad').classList.add('hidden'); refreshIcons(); }
let alertCallback=null; window.showAlert=(m,cb)=>{ document.getElementById('alert-msg').innerText=m; const a=document.getElementById('custom-alert'); a.classList.remove('hidden'); setTimeout(()=>{a.classList.remove('opacity-0'); document.getElementById('custom-alert-box').classList.remove('scale-95');},10); alertCallback=cb; const b=document.getElementById('alert-confirm-btn'), nb=b.cloneNode(true); b.parentNode.replaceChild(nb,b); nb.onclick=()=>{if(alertCallback)alertCallback();closeAlert(true);}; };
window.closeAlert=()=>{ const a=document.getElementById('custom-alert'); a.classList.add('opacity-0'); document.getElementById('custom-alert-box').classList.add('scale-95'); setTimeout(()=>a.classList.add('hidden'),200); };
let isDraggingBanner=false, startY=0, initialBannerPos=50, currentBannerPos=50;
function initBannerDrag(){ const c=document.getElementById('banner-edit-area'); c.addEventListener('mousedown',sd); c.addEventListener('touchstart',sd,{passive:false}); window.addEventListener('mousemove',dg); window.addEventListener('touchmove',dg,{passive:false}); window.addEventListener('mouseup',ed); window.addEventListener('touchend',ed); }
function sd(e){ if(e.target.closest('#banner-edit-area')){ isDraggingBanner=true; startY=e.type.includes('mouse')?e.clientY:e.touches[0].clientY; initialBannerPos=currentBannerPos; } }
function dg(e){ if(!isDraggingBanner) return; if(e.cancelable) e.preventDefault(); const y=e.type.includes('mouse')?e.clientY:e.touches[0].clientY, d=startY-y, p=initialBannerPos+(d/2); currentBannerPos=Math.round(Math.max(0,Math.min(100,p))); document.getElementById('edit-banner-preview').style.objectPosition=`center ${currentBannerPos}%`; document.getElementById('banner-pos-hint').innerText=`${currentBannerPos}%`; }
function ed(){ isDraggingBanner=false; }
window.openSettings=()=>document.getElementById('settings-overlay').classList.remove('hidden'); window.closeSettings=()=>document.getElementById('settings-overlay').classList.add('hidden');
window.togglePrivacy=async()=>{ const t=document.getElementById('toggle-privacy'), p=!t.classList.contains('active'); t.classList.toggle('active'); const s=currentUser.settings||{}; s.privateNetwork=p; await updateDoc(doc(db,"users",currentUser.id),{settings:s}); currentUser.settings=s; showToast(`Account is ${p?'Private':'Public'}`); };
window.switchView=async v=>{
    ['feed','events','saved','network','profile','explore','notifications','announcements'].forEach(n=>{const e=document.getElementById(`view-${n}`);if(e)e.classList.add('hidden');});
    const tp=document.getElementById('trending-panel'), mh=document.getElementById('main-header'), mbn=document.getElementById('mobile-bottom-nav'), mnh=document.getElementById('mobile-notifications-header'), meh=document.getElementById('mobile-explore-header');
    if(mh){mh.classList.remove('hidden');mh.style.transform='translateY(0)';}
    if(mbn)mbn.classList.remove('hidden');
    if(mnh)mnh.classList.add('hidden','flex');
    if(v==='profile'&&mh) mh.classList.add('hidden');
    if(window.innerWidth<768){
        if(v==='notifications'){if(mh)mh.classList.add('hidden');if(mnh)mnh.classList.remove('hidden'),mnh.classList.add('flex');}
        else if(v==='explore'){if(mh)mh.classList.add('hidden');}
    }
    if(window.innerWidth>=1280) tp.classList.remove('hidden'),tp.classList.add('xl:flex');
    if(v!=='ai') document.getElementById(`view-${v}`)?.classList.remove('hidden');
    document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(e=>e.classList.remove('active'));
    const nav=document.getElementById(`nav-${v}`), mnav=document.querySelectorAll('.mobile-nav-item');
    if(nav) nav.classList.add('active');
    if(v==='feed'){mnav[0]?.classList.add('active');if(document.getElementById('feed-container').children.length===0)renderFeed();}
    else if(v==='explore'){mnav[1]?.classList.add('active');switchExploreMainTab('explore');}
    else if(v==='network'){if(nav)nav.classList.add('active');if(document.getElementById('network-content').children.length===0)renderNetwork();}
    else if(v==='notifications'){
        if(nav)nav.classList.add('active');
        mnav[3]?.classList.add('active');
        renderNotifications();
        const unread = notifications.filter(n=>!n.read);
        if(unread.length > 0) {
           const batch = writeBatch(db);
           unread.forEach(n => {
               const ref = doc(db, "notifications", n.id);
               batch.update(ref, {read: true});
           });
           await batch.commit();
        }
    }
    else if(v==='saved'){if(nav)nav.classList.add('active');if(document.getElementById('saved-container').children.length===0)renderSaved();}
    setTimeout(()=>refreshIcons(),10);
};
window.switchNetworkTab=t=>{activeNetworkTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active')); document.getElementById(`net-tab-${t}`)?.classList.add('active'); renderNetwork()};
window.renderNetwork=()=>{
    const c=document.getElementById('network-content'), isP=activeNetworkTab==='people'; c.innerHTML="";
    if(isP){
        const f=users.filter(u=>currentUser.following.includes(u.id));
        if(!f.length) c.innerHTML='<div class="flex flex-col items-center justify-center py-10 opacity-60"><p>You aren\'t following anyone yet.</p></div>';
        else{
            const g=document.createElement('div'); g.className="grid grid-cols-1 md:grid-cols-2 gap-4 px-4 md:px-0";
            f.forEach(u=>{const d=document.createElement('div'); d.className="bg-white p-4 rounded-xl border border-gray-100 flex items-center gap-4 hover:shadow-md transition-all cursor-pointer"; d.onclick=()=>showProfile(u.id); d.innerHTML=`<img src="${u.avatar}" class="w-12 h-12 rounded-full border border-gray-100 bg-gray-50 object-cover"><div><h4 class="font-bold text-gray-900">${u.name} ${u.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 inline text-blue-500"></i>':''}</h4><p class="text-xs text-gray-500 line-clamp-1">${u.bio}</p></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="ml-auto text-xs border border-gray-200 px-3 py-1 rounded-full hover:bg-gray-50">Unfollow</button>`; g.appendChild(d)}); c.appendChild(g);
        }
    } else {
        const fp=posts.filter(p=>currentUser.following.includes(p.authorId));
        if(!fp.length) c.innerHTML='<div class="text-center py-10 text-gray-400">No posts.</div>';
        else{ const pc=document.createElement('div'); pc.className="space-y-4 px-4 md:px-0"; fp.forEach(p=>pc.appendChild(createPostElement(p,'network'))); c.appendChild(pc) }
    } refreshIcons();
};

window.renderFeed=t=>{
    const c=document.getElementById('feed-container'); c.innerHTML="";
    posts.filter(p=>{
        const a=users.find(u=>u.id===p.authorId), priv=a?.settings?.privateNetwork, fol=currentUser.following.includes(p.authorId);
        return (p.authorId===currentUser.id||(priv?fol:((!p.settings||p.settings.privacy==='public')||fol))) && (!t||p.content.toLowerCase().includes(t.toLowerCase()));
    }).forEach(p=>c.appendChild(createPostElement(p,'feed'))); refreshIcons();
};

let touchStartX=0, touchEndX=0;
window.handleTouchStart=e=>touchStartX=e.changedTouches[0].screenX;
window.handleTouchEnd=(e,pid,ov)=>{
    touchEndX=e.changedTouches[0].screenX; const w=e.currentTarget.closest('.post-carousel');
    if(Math.abs(touchStartX-touchEndX)>50) moveCarousel(w?w.id:pid, touchStartX>touchEndX?1:-1, ov, true);
};

function createPostElement(p,ctx='feed'){
    const a=users.find(u=>u.id===p.authorId)||{name:'Unknown',avatar:'',isOfficial:false,id:p.authorId}, st=p.settings||{privacy:'public',showLikes:true,showComments:true};
    const d=document.createElement('article'); 
    d.id = `post-card-${ctx}-${p.id}`; 
    d.className="post-card group overflow-hidden fade-in"; 
    d.onclick=()=>openPostView(p.id);
    let mh="", lh="";
    if(p.media){
        const ma=Array.isArray(p.media)?p.media:[p.media];
        if(ma.length===1){
            const s=ma[0], iv=s.includes('video')||s.includes('.mp4');
            mh=`<div class="mt-3 rounded-xl overflow-hidden aspect-[4/5] ${iv?'bg-black flex items-center justify-center':'bg-gray-100 cursor-pointer'}" onclick="event.stopPropagation();${iv?'':`openLightbox('${s}','image')`}">${iv?`<video src="${s}" class="w-full h-full object-cover" controls onclick="event.stopPropagation()"></video>`:`<img src="${s}" class="w-full h-full object-cover">`}</div>`;
        } else {
            const cid=`carousel-${ctx}-${p.id}`, iid=`inner-${ctx}-${p.id}`, cntId=`counter-${ctx}-${p.id}`;
            let sl='', dt=''; ma.forEach((s,i)=>{ sl+=`<div class="post-carousel-item">${(s.includes('video')||s.includes('.mp4'))?`<video src="${s}" controls></video>`:`<img src="${s}">`}</div>`; dt+=`<div class="carousel-dot ${i===0?'active':''}" id="dot-${ctx}-${p.id}-${i}"></div>`});
            mh=`<div class="carousel-wrapper"><div class="mt-3 rounded-xl overflow-hidden post-carousel touch-pan-y" id="${cid}" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event,'${p.id}',false)"><div class="post-carousel-inner" id="${iid}">${sl}</div><button class="carousel-nav-btn prev" onclick="event.stopPropagation();moveCarousel('${cid}',-1,false,true)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next" onclick="event.stopPropagation();moveCarousel('${cid}',1,false,true)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button><div class="absolute top-3 right-3 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm pointer-events-none"><span id="${cntId}">1</span>/${ma.length}</div></div><div class="carousel-dots-outside">${dt}</div></div>`;
            (window.carouselStates=window.carouselStates||{})[cid]={index:0,total:ma.length};
        }
    }
    
    // Updated Liked By Logic: Only show followers who liked it, excluding self
    if(p.likes?.length && currentUser.following){
        const f = p.likes.filter(id => currentUser.following.includes(id) && id !== currentUser.id);
        if(f.length > 0) {
            const ff = users.find(u => u.id === f[0]);
            if(ff) lh=`<div class="flex items-center mt-3 ml-1"><img src="${ff.avatar}" class="w-5 h-5 rounded-full border border-white -mr-1 z-10"><span class="text-[11px] text-gray-500 ml-2">Liked by <span class="font-bold text-gray-900">${ff.name}</span>${f.length>1?` and ${f.length-1} others`:''}</span></div>`;
        }
    }

    const txt=formatContent(p.content), trunc=p.content.length>180;
    const isLiked = p.likes?.includes(currentUser.id);
    const isSaved = savedPosts.includes(p.id);

    d.innerHTML=`<div class="p-4 md:p-5"><div class="post-header"><div class="flex gap-3"><div class="post-avatar-container"><img src="${a.avatar}" class="post-avatar"></div><div><div class="flex items-center"><span class="post-author-name" onclick="event.stopPropagation(); showProfile('${a.id}')">${a.name}</span>${a.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 official-badge text-blue-500 ml-1"></i>':''}${st.privacy==='private'?'<i data-lucide="lock" class="w-3 h-3 text-gray-400 ml-1"></i>':''}</div><div class="post-meta flex items-center">${formatDate(p.timestamp)}</div></div></div><button class="icon-btn w-8 h-8 -mr-2" onclick="showPostOptions(event,'${p.id}','${p.authorId}')"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button></div><div class="post-content"><div class="post-body js-post-body-${p.id}" data-full="${txt.replace(/"/g,'&quot;')}">${trunc?`${formatContent(p.content.substring(0,180))}...<span id="read-more-${p.id}" class="read-more-btn" onclick="event.stopPropagation(); toggleReadMore('${p.id}')">more</span>`:txt}</div>${mh}</div>${lh}<div class="post-actions"><div class="flex items-center gap-1"><button class="action-btn like js-like-btn-${p.id} ${isLiked?'active':''}" onclick="event.stopPropagation(); toggleLike('${p.id}')"><i data-lucide="heart" class="w-6 h-6"></i></button>${st.showLikes?`<span class="js-like-count-${p.id} text-xs font-medium px-1 hover:underline cursor-pointer" onclick="event.stopPropagation();openLikes('${p.id}')">${p.likes?.length||0}</span>`:''}<button class="action-btn comment ml-2" onclick="event.stopPropagation(); openPostView('${p.id}')"><i data-lucide="${st.allowComments===false?'message-circle-off':'message-circle'}" class="w-6 h-6"></i> ${st.showComments?`<span class="js-comment-count-${p.id} text-xs font-medium">${p.comments?.length||0}</span>`:''}</button><button class="action-btn share-btn ml-2" onclick="event.stopPropagation(); sharePost('${p.id}')"><i data-lucide="share-2" class="w-6 h-6"></i></button></div><button class="action-btn bookmark js-save-btn-${p.id} ${isSaved?'active':''}" onclick="event.stopPropagation(); toggleSave('${p.id}')"><i data-lucide="bookmark" class="w-6 h-6"></i></button></div></div>`;
    return d;
}

window.toggleReadMore=pid=>{
    const b=document.querySelector(`.js-post-body-${pid}`), btn=document.getElementById(`read-more-${pid}`);
    if(btn&&btn.innerText==='more') document.querySelectorAll(`.js-post-body-${pid}`).forEach(el => el.innerHTML=el.getAttribute('data-full')+`<span id="read-more-${pid}" class="read-more-btn" onclick="event.stopPropagation(); toggleReadMore('${pid}')">less</span>`);
    else{ const p=posts.find(x=>x.id===pid); if(p) document.querySelectorAll(`.js-post-body-${pid}`).forEach(el => el.innerHTML=`${formatContent(p.content.substring(0,180))}...<span id="read-more-${pid}" class="read-more-btn" onclick="event.stopPropagation(); toggleReadMore('${pid}')">more</span>`); }
};

window.moveCarousel=(fid,dir,ov=false,isFull=false)=>{
    const k=isFull||ov?fid:`carousel-feed-${fid}`; if(!window.carouselStates?.[k])return;
    const s=window.carouselStates[k], n=s.index+dir;
    if(n>=0&&n<s.total){
        s.index=n; document.getElementById(k.replace('carousel-','inner-')).style.transform=`translateX(-${n*100}%)`;
        document.getElementById(k).nextElementSibling.querySelectorAll('.carousel-dot').forEach((d,i)=>d.classList.toggle('active',i===n));
        const cnt=document.getElementById(k.replace('carousel-','counter-')); if(cnt) cnt.innerText=n+1;
    }
};

window.switchExploreMainTab=t=>{
    window.activeExploreTab=t; const m=t==='explore'?'main':t;
    ['main','video','people','tags'].forEach(x=>{ const el=document.getElementById(`tab-explore-${x}`), ed=document.getElementById(`tab-explore-${x}-d`); if(el)el.classList.remove('active'); if(ed)ed.classList.remove('active'); });
    document.getElementById(`tab-explore-${m}`)?.classList.add('active'); document.getElementById(`tab-explore-${m}-d`)?.classList.add('active');
    window.activeExploreCategory=t==='video'?'All':'For You'; handleSearch(document.getElementById('mobile-explore-search').value);
};

window.toggleExploreSearch=()=>{ const b=document.getElementById('explore-search-bar'); if(b){ b.classList.toggle('hidden'); if(!b.classList.contains('hidden')) document.getElementById('mobile-explore-search').focus() } };

window.handleSearch=q=>{
    if(document.getElementById('view-explore').classList.contains('hidden')) switchView('explore');
    const t=q?q.toLowerCase().trim():'', pl=document.getElementById('explore-people-results'), v=document.getElementById('explore-results');
    if(window.activeExploreTab==='people'){
        pl.classList.remove('hidden'); pl.classList.add('flex'); v.innerHTML=''; pl.innerHTML='';
        const fu=t?users.filter(u=>(u.name||"").toLowerCase().includes(t)||(u.username||"").toLowerCase().includes(t)):users.slice(0,10);
        if(fu.length) fu.forEach(u=>{ const d=document.createElement('div'); d.className="flex items-center justify-between p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer last:border-b-0"; d.onclick=()=>showProfile(u.id); d.innerHTML=`<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-12 h-12 rounded-full border border-gray-100 object-cover bg-gray-50"><div><div class="font-bold text-[#1f1f1f] text-[15px] flex items-center gap-1">${u.name}${u.isOfficial?'<i data-lucide="badge-check" class="w-4 h-4 text-blue-500 fill-blue-50"></i>':''}</div><div class="text-xs text-gray-500 font-medium">@${u.username||'user'}  ${u.followers?.length||0} followers</div></div></div><button onclick="event.stopPropagation(); toggleFollow('${u.id}')" class="bg-black text-white text-xs px-4 py-1.5 rounded-full font-bold hover:bg-gray-800 transition-colors shadow-sm">Follow</button>`; pl.appendChild(d) });
        else pl.innerHTML='<div class="text-gray-400 text-xs italic text-center py-4">No people found</div>';
    } else {
        pl.classList.add('hidden'); pl.classList.remove('flex'); v.innerHTML='';
        let fp=posts.filter(p=>{
            if(window.activeExploreTab==='video') return p.media&&(Array.isArray(p.media)?p.media.some(m=>m.includes('video')||m.endsWith('.mp4')):(p.media.includes('video')||p.media.endsWith('.mp4')));
            if(window.activeExploreTab==='tags') return p.content.includes('#'); return true;
        });
        if(t) fp=fp.filter(p=>p.content.toLowerCase().includes(t)); else if(window.activeExploreTab!=='tags') fp.sort(()=>0.5-Math.random());
        if(!fp.length) v.innerHTML='<div class="text-center py-20 text-gray-400"><p>No posts found.</p></div>';
        else{ const l=document.createElement('div'); l.className="flex flex-col gap-0.5 md:gap-4"; fp.forEach(p=>l.appendChild(createPostElement(p,'explore'))); v.appendChild(l); }
    } refreshIcons();
};
window.openCollabSelector=()=>{ const o=document.getElementById('user-list-overlay'), c=document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText="Tag Collaborators"; c.innerHTML=''; const r=users.filter(u=>u.id!==currentUser.id&&(currentUser.following.includes(u.id)||currentUser.followers.includes(u.id))); if(!r.length) c.innerHTML='<div class="text-center text-gray-400 py-8">No contacts.</div>'; else r.forEach(u=>{ const sel=window.selectedCollaborators.find(x=>x.id===u.id), d=document.createElement('div'); d.className=`flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer ${sel?'bg-gray-100':''}`; d.onclick=()=>toggleCollaborator(u); d.innerHTML=`<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username||'user'}</div></div></div>${sel?'<i data-lucide="check" class="text-gray-600 w-5 h-5"></i>':''}`; c.appendChild(d); }); o.classList.remove('hidden'); refreshIcons(); };
window.toggleCollaborator=u=>{ const i=window.selectedCollaborators.findIndex(x=>x.id===u.id); if(i>-1) window.selectedCollaborators.splice(i,1); else window.selectedCollaborators.push({id:u.id,name:u.name,avatar:u.avatar,username:u.username,status:'pending'}); closeUserList(); openCollabSelector(); renderCollabChips(); };
window.renderCollabChips=()=>{ const c=document.getElementById('collab-chips-container'); c.innerHTML=''; window.selectedCollaborators.forEach(u=>{ const ch=document.createElement('div'); ch.className='collab-chip'; ch.innerHTML=`<img src="${u.avatar}" class="w-4 h-4 rounded-full mr-2"> <span>${u.name}</span> <i onclick="event.stopPropagation(); removeCollaborator('${u.id}')" data-lucide="x" class="w-3 h-3 ml-2 text-gray-500 hover:text-red-500 cursor-pointer"></i>`; c.appendChild(ch); }); refreshIcons(); };
window.removeCollaborator=id=>{ window.selectedCollaborators=window.selectedCollaborators.filter(u=>u.id!==id); renderCollabChips(); };
window.openCollabList=pid=>{ const p=posts.find(x=>x.id===pid); if(!p||!p.collaborators) return; const c=document.getElementById('user-list-content'); document.getElementById('user-list-title').innerText="Collaborators"; c.innerHTML=''; p.collaborators.filter(x=>x.status==='accepted').forEach(u=>{ const d=document.createElement('div'); d.className="flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer"; d.onclick=()=>{closeUserList();showProfile(u.id);}; d.innerHTML=`<div class="flex items-center gap-3"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500">@${u.username||'user'}</div></div></div>`; c.appendChild(d); }); document.getElementById('user-list-overlay').classList.remove('hidden'); };
window.toggleLike=async(pid)=>{
    // Optimistic Update across all views
    const isLiking = !document.querySelector(`.js-like-btn-${pid}`)?.classList.contains('active');
    
    document.querySelectorAll(`.js-like-btn-${pid}`).forEach(btn => btn.classList.toggle('active', isLiking));
    document.querySelectorAll(`.js-like-count-${pid}`).forEach(el => {
        let count = parseInt(el.innerText) || 0;
        el.innerText = Math.max(0, count + (isLiking ? 1 : -1));
    });

    const r=doc(db,"posts",pid), p=posts.find(x=>x.id===pid);
    if(p.likes&&p.likes.includes(currentUser.id)) await updateDoc(r,{likes:arrayRemove(currentUser.id)});
    else {
        await updateDoc(r,{likes:arrayUnion(currentUser.id)});
        if(p.authorId!==currentUser.id) {
             sendNotification(p.authorId,'like','liked your post',pid);
        }
    }
};
const toggleModalAnim=(oid,mid,show)=>{
    const o=document.getElementById(oid), m=document.getElementById(mid);
    if(show){
        o.classList.remove('hidden'); m.style.transition='none';
        o.classList.add('opacity-0'); m.classList.add('translate-y-full','md:scale-95'); m.classList.remove('translate-y-0','md:scale-100');
        void m.offsetWidth; m.style.transition='';
        setTimeout(()=>{o.classList.remove('opacity-0'); m.classList.remove('translate-y-full','md:scale-95'); m.classList.add('translate-y-0','md:scale-100')},20);
    } else {
        o.classList.add('opacity-0'); m.classList.add('translate-y-full','md:scale-95'); m.classList.remove('translate-y-0','md:scale-100');
        setTimeout(()=>o.classList.add('hidden'),200);
    }
};

window.openLikes=pid=>{
    const p=posts.find(x=>x.id===pid), c=document.getElementById('likes-list-content');
    c.innerHTML = !p.likes?.length ? '<div class="text-center text-gray-400 py-8">No likes yet.</div>' : 
    p.likes.map(uid=>{
        const u=users.find(x=>x.id===uid);
        return u ? `<div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-xl cursor-pointer" onclick="closeLikes();showProfile('${u.id}')"><img src="${u.avatar}" class="w-10 h-10 rounded-full border border-gray-200 object-cover"><div><div class="font-bold text-sm text-gray-900">${u.name}</div><div class="text-xs text-gray-500 truncate w-32">${u.bio}</div></div></div>` : '';
    }).join('');
    toggleModalAnim('likes-overlay','likes-modal',true);
};

window.closeLikes=()=>toggleModalAnim('likes-overlay','likes-modal',false);

window.toggleSave=async(pid)=>{
    // Optimistic Update
    const isSaving = !document.querySelector(`.js-save-btn-${pid}`)?.classList.contains('active');
    document.querySelectorAll(`.js-save-btn-${pid}`).forEach(btn => btn.classList.toggle('active', isSaving));
    
    showToast(isSaving?"Saved":"Removed");
    if(isSaving) savedPosts.push(pid); else savedPosts=savedPosts.filter(x=>x!==pid);
    await updateDoc(doc(db,"users",currentUser.id),{saved:isSaving?arrayUnion(pid):arrayRemove(pid)});
};

window.sharePost=pid=>{
    window.currentSharePid=pid;
    const url=`${window.location.origin}${window.location.pathname}?postId=${pid}`, p=posts.find(x=>x.id===pid), pc=document.getElementById('share-post-preview');
    document.getElementById('share-link-input').value=url; document.getElementById('share-link-text').innerText=url;
    
    if(p){
        const a=users.find(u=>u.id===p.authorId)||{name:'Unknown',avatar:''};
        document.getElementById('share-owner-avatar').src=a.avatar;
        const m=p.media?(Array.isArray(p.media)?p.media[0]:p.media):null, isV=m&&(m.includes('video')||m.endsWith('.mp4'));
        const mh=m?(isV?`<div class="w-16 h-16 bg-black rounded-lg flex items-center justify-center shrink-0"><i data-lucide="play" class="w-6 h-6 text-white"></i></div>`:`<img src="${m}" class="w-16 h-16 rounded-lg object-cover shrink-0 bg-gray-200">`):'';
        
        pc.innerHTML=`<div class="bg-white border border-gray-200 rounded-xl p-3 shadow-sm mb-6"><div class="flex items-center gap-2 mb-2"><img src="${a.avatar}" class="w-5 h-5 rounded-full object-cover"><span class="text-xs font-bold text-gray-900 truncate">${a.name}</span></div><div class="flex gap-3 items-center"><div class="flex-1 min-w-0"><p class="text-xs text-gray-600 line-clamp-2 mb-2 leading-relaxed">${p.content||(m?'Shared a post':'')}</p><div class="flex items-center gap-3 text-gray-400"><div class="flex items-center gap-1 text-[10px] font-medium"><i data-lucide="heart" class="w-3 h-3"></i> ${p.likes?.length||0}</div><div class="flex items-center gap-1 text-[10px] font-medium"><i data-lucide="message-circle" class="w-3 h-3"></i> ${p.comments?.length||0}</div></div></div>${mh}</div></div>`;
        pc.classList.remove('hidden'); refreshIcons();
    } else pc.classList.add('hidden');
    toggleModalAnim('share-overlay','share-modal',true);
};
window.closeShareMenu=()=>{
    const o=document.getElementById('share-overlay'), m=document.getElementById('share-modal');
    o.classList.add('opacity-0'); m.classList.add('translate-y-full','md:scale-95'); m.classList.remove('translate-y-0','md:scale-100');
    setTimeout(()=>{o.classList.add('hidden'); window.currentSharePid=null},200);
};

window.triggerShare=pf=>{
    if(!window.currentSharePid) return;
    const u=`${window.location.origin}${window.location.pathname}?postId=${window.currentSharePid}`, txt="Check out this post on EduLink!";
    const acts={
        copy:()=>navigator.clipboard.writeText(u).then(()=>showToast("Link copied!")),
        twitter:()=>window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(txt)}&url=${encodeURIComponent(u)}`,'_blank'),
        whatsapp:()=>window.open(`https://wa.me/?text=${encodeURIComponent(txt+" "+u)}`,'_blank'),
        email:()=>window.open(`mailto:?subject=${encodeURIComponent(txt)}&body=${encodeURIComponent(txt+"\n\n"+u)}`)
    };
    acts[pf]?.();
    if(pf!=='copy') closeShareMenu();
};

window.renderSaved=()=>{
    const c=document.getElementById('saved-container'); c.innerHTML='';
    if(!savedPosts.length) c.innerHTML='<div class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60"><i data-lucide="bookmark" class="w-16 h-16 mb-2"></i><p>No saved posts</p></div>';
    else posts.filter(p=>savedPosts.includes(p.id)).forEach(p=>c.appendChild(createPostElement(p,'saved')));
    refreshIcons();
};

async function sendNotification(rid,t,c,pid=null){
    await setDoc(doc(db,"notifications",`${t}_${currentUser.id}_${pid||'general'}_${rid}`),{receiverId:rid,senderId:currentUser.id,type:t,content:c,timestamp:serverTimestamp(),read:false,postId:pid},{merge:true});
}

window.switchNotifTab=t=>{
    activeNotifTab=t; document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    [`ntab-${t}`,`ntab-${t}-mobile`].forEach(id=>document.getElementById(id)?.classList.add('active'));
    renderNotifications();
};

window.toggleNotifMenu=()=>{
    const o=document.getElementById('notif-options-overlay'), m=document.getElementById('notif-options-modal');
    o.classList.remove('hidden'); m.style.transition='none'; o.classList.add('opacity-0'); m.classList.add('translate-y-full');
    void m.offsetWidth; m.style.transition='';
    setTimeout(()=>{o.classList.remove('opacity-0'); m.classList.remove('translate-y-full')},20);
};

window.closeNotifOptions=()=>{
    const o=document.getElementById('notif-options-overlay'), m=document.getElementById('notif-options-modal');
    o.classList.add('opacity-0'); m.classList.add('translate-y-full');
    setTimeout(()=>o.classList.add('hidden'),200);
};
// --- Notification Logic ---
window.toggleNotifSelection=()=>{window.notifSelectionMode=!window.notifSelectionMode; if(!window.notifSelectionMode) window.selectedNotifs.clear(); renderNotifications()};
window.toggleNotifSearchMobile=()=>{const c=document.getElementById('mobile-notif-search-container'); c.classList.toggle('hidden'); if(!c.classList.contains('hidden')) document.getElementById('notif-search').focus()};
window.handleNotifSearch=v=>{window.notifSearchTerm=v.toLowerCase(); renderNotifications()};
window.toggleNotifSelect=id=>{window.selectedNotifs.has(id)?window.selectedNotifs.delete(id):window.selectedNotifs.add(id); renderNotifications()};

window.deleteSelectedNotifs=async()=>{
    if(!window.selectedNotifs.size) return showToast("None selected");
    showAlert(`Delete ${window.selectedNotifs.size} items?`,async()=>{
        const b=writeBatch(db); window.selectedNotifs.forEach(id=>b.delete(doc(db,"notifications",id)));
        await b.commit(); window.notifSelectionMode=false; window.selectedNotifs.clear(); toggleNotifMenu(); showToast("Deleted");
    });
};

window.renderNotifications=()=>{
    const c=document.getElementById('notification-list'), term=window.notifSearchTerm; c.innerHTML='';
    const fl=notifications.filter(n=>{
        const s=users.find(u=>u.id===n.senderId)||{name:'Admin',isOfficial:false}, isOff=n.type==='official'||s.isOfficial;
        return (activeNotifTab==='official'?isOff:!isOff) && (!term||n.content.toLowerCase().includes(term)||s.name.toLowerCase().includes(term));
    });
    if(!fl.length) return c.innerHTML='<div class="text-center text-xs text-gray-400 py-4">No notifications</div>';
    
    const map={like:{i:'heart',c:'bg-red-500'},comment:{i:'message-circle',c:'bg-blue-500'},reply:{i:'corner-down-right',c:'bg-teal-500'},follow:{i:'user-plus',c:'bg-indigo-500'},official:{i:'megaphone',c:'bg-purple-600'},follow_request:{i:'lock',c:'bg-orange-500'},collab_request:{i:'users',c:'bg-pink-500'},mention:{i:'at-sign',c:'bg-green-500'},default:{i:'bell',c:'bg-gray-500'}};

    c.innerHTML = fl.map(n=>{
        const s=users.find(u=>u.id===n.senderId)||{name:'Admin',avatar:''}, cfg=map[n.type]||map.default;
        const click=window.notifSelectionMode?'':(['like','comment','reply','mention'].includes(n.type)&&n.postId?`openPostView('${n.postId}')`:`showProfile('${s.id}')`);
        let act='';
        if(n.type==='follow_request') act=`<div class="flex gap-2 mt-2"><button onclick="acceptFollow('${n.id}','${s.id}')" class="btn-xs-blue">Accept</button><button onclick="deleteNotification('${n.id}')" class="btn-xs-gray">Delete</button></div>`;
        if(n.type==='collab_request') act=`<div class="flex gap-2 mt-2"><button onclick="acceptCollab('${n.id}','${n.postId}')" class="btn-xs-blue">Accept</button><button onclick="declineCollab('${n.id}','${n.postId}')" class="btn-xs-gray">Decline</button></div>`;
        const chk=window.notifSelectionMode?`<div class="pt-1"><input type="checkbox" ${window.selectedNotifs.has(n.id)?'checked':''} onchange="toggleNotifSelect('${n.id}')" class="w-4 h-4 accent-blue-600 cursor-pointer rounded"></div>`:'';
        return `<div class="w-full flex items-start gap-3 p-4 border-b border-gray-100 bg-white hover:bg-gray-50 transition-colors">${chk}<div class="relative cursor-pointer shrink-0" onclick="${window.notifSelectionMode?'':`showProfile('${s.id}')`}"><img src="${s.avatar}" class="w-10 h-10 rounded-full bg-gray-200 object-cover border border-gray-100"><div class="absolute -bottom-1 -right-1 w-5 h-5 rounded-full ${cfg.c} flex items-center justify-center border border-white shadow-sm"><i data-lucide="${cfg.i}" class="w-3.5 h-3.5 text-white"></i></div></div><div class="flex-1 min-w-0 pt-0.5"><div class="text-[14px] leading-snug cursor-pointer" onclick="${click}"><span class="font-bold text-gray-900 hover:underline">${s.name}</span> <span class="text-gray-600 ml-1">${n.content}</span></div><div class="text-[11px] text-gray-400 mt-1">${formatDate(n.timestamp)}</div>${act}</div>${!window.notifSelectionMode?`<button onclick="deleteNotification('${n.id}')" class="p-1.5 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all self-start -mt-1 -mr-2"><i data-lucide="x" class="w-3.5 h-3.5"></i></button>`:''}</div>`;
    }).join('');
    refreshIcons();
};

window.deleteNotification=async id=>showAlert("Delete?",async()=>await deleteDoc(doc(db,"notifications",id)));
window.clearAllNotifications=async()=>showAlert("Clear all?",async()=>{const b=writeBatch(db),s=await getDocs(query(collection(db,"notifications"),where("receiverId","==",currentUser.id))); s.forEach(d=>b.delete(d.ref)); await b.commit(); showToast("Cleared")});
window.toggleNotifications=()=>switchView('notifications');

// --- Collab & Follow Logic ---
window.acceptCollab=async(nid,pid)=>{const r=doc(db,"posts",pid),s=await getDoc(r); if(s.exists()){const c=s.data().collaborators||[],i=c.findIndex(x=>x.id===currentUser.id); if(i>-1){c[i].status='accepted'; await updateDoc(r,{collaborators:c}); showToast("Accepted!")}} await deleteDoc(doc(db,"notifications",nid))};
window.declineCollab=async(nid,pid)=>{const r=doc(db,"posts",pid),s=await getDoc(r); if(s.exists()) await updateDoc(r,{collaborators:(s.data().collaborators||[]).filter(x=>x.id!==currentUser.id)}); showToast("Declined"); await deleteDoc(doc(db,"notifications",nid))};
window.acceptFollow=async(nid,sid)=>{await Promise.all([updateDoc(doc(db,"users",currentUser.id),{followers:arrayUnion(sid)}), updateDoc(doc(db,"users",sid),{following:arrayUnion(currentUser.id)}), deleteDoc(doc(db,"notifications",nid)), sendNotification(sid,'follow','accepted follow')]); showToast("Accepted")};

window.toggleFollow=async(uid)=>{
    const m=doc(db,"users",currentUser.id), t=doc(db,"users",uid), u=users.find(x=>x.id===uid), isF=currentUser.following.includes(uid), priv=u?.settings?.privateNetwork;
    if(isF){
        currentUser.following=currentUser.following.filter(id=>id!==uid); showToast("Unfollowed");
        await Promise.all([updateDoc(m,{following:arrayRemove(uid)}), updateDoc(t,{followers:arrayRemove(currentUser.id)})]);
    } else {
        if(priv){ showToast("Request sent"); sendNotification(uid,'follow_request','wants to follow you'); }
        else{ currentUser.following.push(uid); showToast("Following"); await Promise.all([updateDoc(m,{following:arrayUnion(uid)}), updateDoc(t,{followers:arrayUnion(currentUser.id)}), sendNotification(uid,'follow','started following you')]); }
    }
    const btn=document.getElementById('profile-follow-btn'); if(btn) btn.innerText=isF?(priv?'Request':'Follow'):(priv?'Requested':'Following');
    const ul=document.getElementById(`ul-btn-${uid}`); if(ul){ ul.innerText=!isF?'Following':'Follow'; ul.className=!isF?"bg-gray-100 text-gray-900 text-xs px-3 py-1 rounded-full font-bold hover:bg-gray-200":"bg-black text-white text-xs px-3 py-1 rounded-full font-bold hover:bg-gray-800"; }
    renderRightSidebar(); if(!document.getElementById('view-network').classList.contains('hidden')) renderNetwork(); refreshIcons();
};

// --- Profile View Logic ---
window.showProfile=(uid,tab='posts')=>{
    if(!uid) uid=currentUser.id; closePostView(); closeThread(); window.currentViewingProfileId=uid; window.currentProfileTab=tab;
    const u=users.find(x=>x.id===uid); if(!u) return;
    const c=document.getElementById('view-profile'), me=uid===currentUser.id, fol=currentUser.following?.includes(uid);
    
    let ab=me ? `<div class="flex gap-2"><button onclick="openEditProfile()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-200">Edit Profile</button><button onclick="openQR()" class="bg-gray-100 text-gray-700 px-2 py-2 rounded-lg hover:bg-gray-200"><i data-lucide="qr-code" class="w-5 h-5"></i></button></div>` 
              : `<div class="flex gap-2"><button id="profile-follow-btn" onclick="toggleFollow('${uid}')" class="${fol?'bg-gray-100 text-gray-700':'bg-[#0b57d0] text-white'} px-4 py-2 rounded-lg font-bold text-sm transition-colors">${fol?'Following':(u.settings?.privateNetwork?'Request':'Follow')}</button><button onclick="openQR('${uid}')" class="bg-gray-100 text-gray-700 px-2 py-2 rounded-lg hover:bg-gray-200"><i data-lucide="qr-code" class="w-5 h-5"></i></button></div>`;

    const stats=(me||!u.settings?.privateNetwork||fol) ? `<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="cursor-pointer hover:underline" onclick="openUserList('following','${uid}')"><strong class="text-gray-900">${u.following?.length||0}</strong> Following</span><span class="cursor-pointer hover:underline" onclick="openUserList('followers','${uid}')"><strong class="text-gray-900">${u.followers?.length||0}</strong> Followers</span></div>` : `<div class="flex gap-4 mt-3 text-sm text-gray-500"><span class="italic"><i data-lucide="lock" class="w-3 h-3 inline"></i> Private Account</span></div>`;
    
    const tabs=['posts','saved','liked','tagged','links'].map(t=>(!me&&t==='saved')?'':`<button onclick="switchProfileTab('${t}')" class="tab-btn ${tab===t?'active':''}"><i data-lucide="${{posts:'grid',saved:'bookmark',liked:'heart',tagged:'user-check',links:'link'}[t]}" class="w-5 h-5"></i></button>`).join('');

    c.innerHTML=`<div class="profile-banner-container"><img src="${u.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80'}" class="profile-banner-img" style="object-position:center ${u.bannerPos||50}%"></div><div class="px-4 md:px-6 relative"><div class="flex justify-between items-end -mt-10 mb-4"><img src="${u.avatar}" class="w-24 h-24 rounded-full border-4 border-white bg-white object-cover">${ab}</div><div class="mb-6"><h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">${u.name} ${u.isOfficial?'<i data-lucide="badge-check" class="text-blue-600 w-6 h-6"></i>':''}</h1><div class="text-sm font-medium text-gray-500">@${u.username||'user'}</div><p class="text-gray-600 mt-2">${u.bio}</p>${stats}</div><div class="tab-group mb-0">${tabs}</div><div id="profile-content-area" class="pt-1 md:pt-4 pb-20 md:pb-0"></div></div>`;
    switchView('profile'); renderProfileContent(uid,tab); refreshIcons();
};

window.switchProfileTab=t=>{document.querySelectorAll('#view-profile .tab-btn').forEach(b=>b.classList.toggle('active',b.getAttribute('onclick').includes(t))); window.currentProfileTab=t; renderProfileContent(window.currentViewingProfileId,t)};

window.renderProfileContent=(uid,t)=>{
    const c=document.getElementById('profile-content-area'), u=users.find(x=>x.id===uid); c.innerHTML="";
    if(t==='links'){
        const is=uid===currentUser.id, l=u.links||[];
        c.innerHTML=`<div class="max-w-4xl mx-auto py-6 space-y-4 md:grid md:grid-cols-2 md:gap-4 md:space-y-0 px-2">${is?`<button onclick="document.getElementById('add-link-modal').classList.remove('hidden')" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 font-bold hover:bg-gray-50 flex items-center justify-center gap-2 h-full"><i data-lucide="plus" class="w-5 h-5"></i> Add New Link</button>`:''}${!l.length&&!is?'<div class="col-span-2 text-center text-gray-400 py-10">No links added yet.</div>':l.map((k,i)=>`<a href="${k.url}" target="_blank" class="flex items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 border border-gray-200 group relative"><div class="w-10 h-10 rounded-full bg-white flex items-center justify-center border border-gray-200 mr-4 shrink-0"><i data-lucide="link" class="w-5 h-5 text-blue-600"></i></div><div class="flex-1 min-w-0"><div class="font-bold text-gray-900 truncate">${k.title}</div><div class="text-xs text-gray-500 truncate">${k.url}</div></div><i data-lucide="external-link" class="w-4 h-4 text-gray-400 ml-2"></i>${is?`<button onclick="event.preventDefault(); deleteLink(${i})" class="absolute top-2 right-2 p-1.5 bg-white rounded-full shadow-sm text-red-500 opacity-0 group-hover:opacity-100 hover:bg-red-50"><i data-lucide="trash-2" class="w-3 h-3"></i></button>`:''}</a>`).join('')}</div>`; refreshIcons(); return;
    }
    if(t==='liked'&&uid!==currentUser.id) return c.innerHTML='<div class="flex flex-col items-center justify-center py-20 text-gray-400 opacity-60"><i data-lucide="lock" class="w-16 h-16 mb-2"></i><p>This user\'s likes are private.</p></div>', refreshIcons();

    let tp = posts.filter(p => t==='posts'?p.authorId===uid : t==='saved'?savedPosts.includes(p.id) : t==='liked'?p.likes?.includes(uid) : (p.collaborators?.some(x=>x.id===uid&&x.status==='accepted')||p.mentions?.includes(uid)));
    if(uid!==currentUser.id && t==='posts') tp=tp.filter(p=> (u.settings?.privateNetwork ? !currentUser.following.includes(uid) : (p.settings?.privacy==='public'||currentUser.following.includes(uid))));

    c.innerHTML=tp.length ? `<div class="grid-post-container">${tp.map(p=>{
        const m=Array.isArray(p.media)?p.media[0]:p.media, isV=m&&(m.includes('video')||m.endsWith('.mp4')||m.startsWith('data:video'));
        return `<div class="grid-post-item group" onclick="openPostView('${p.id}')">${m?(isV?`<video src="${m}" class="w-full h-full object-cover pointer-events-none"></video><div class="absolute inset-0 flex items-center justify-center"><i data-lucide="play" class="w-8 h-8 text-white drop-shadow-md"></i></div>`:`<img src="${m}" class="w-full h-full object-cover">`+(Array.isArray(p.media)&&p.media.length>1?`<div class="absolute top-2 right-2"><i data-lucide="layers" class="w-4 h-4 text-white drop-shadow-md"></i></div>`: '')):`<div class="grid-post-text-preview">${p.content.substring(0,60)}${p.content.length>60?'...':''}</div>`}<div class="grid-post-overlay"><div class="flex items-center gap-1"><i data-lucide="heart" class="w-5 h-5 fill-white"></i> ${p.likes?.length||0}</div><div class="flex items-center gap-1"><i data-lucide="message-circle" class="w-5 h-5 fill-white"></i> ${p.comments?.length||0}</div></div></div>`;
    }).join('')}</div>` : '<div class="text-center py-20 text-gray-400">No posts yet</div>'; refreshIcons();
};

// --- Profile Edit ---
const animModal=(oid,mid,s)=>{const o=document.getElementById(oid),m=document.getElementById(mid); if(s){o.classList.remove('hidden');m.style.transition='none';o.classList.add('opacity-0');m.classList.add('translate-y-full','md:scale-95');void m.offsetWidth;m.style.transition='';setTimeout(()=>{o.classList.remove('opacity-0');m.classList.remove('translate-y-full','md:scale-95');m.classList.add('translate-y-0','md:scale-100')},20)}else{o.classList.add('opacity-0');m.classList.add('translate-y-full','md:scale-95');m.classList.remove('translate-y-0','md:scale-100');setTimeout(()=>o.classList.add('hidden'),200)}};
window.openEditProfile=()=>{
    document.getElementById('edit-banner-preview').src=currentUser.banner||'https://images.unsplash.com/photo-1579546929518-9e396f3cc809?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80';
    document.getElementById('edit-banner-preview').style.objectPosition=`center ${currentBannerPos=initialBannerPos=currentUser.bannerPos||50}%`;
    document.getElementById('banner-pos-hint').innerText=`${currentBannerPos}%`; document.getElementById('edit-email').value=currentUser.email||"";
    document.body.classList.add('modal-open'); animModal('edit-profile-overlay','edit-profile-modal',true);
};
window.closeEditProfile=()=>{document.body.classList.remove('modal-open'); animModal('edit-profile-overlay','edit-profile-modal',false)};
window.handleEditAvatarSelect=e=>{const f=e.target.files[0]; if(f){currentAvatarBlob=f; const r=new FileReader(); r.onload=x=>document.getElementById('edit-avatar-preview').src=x.target.result; r.readAsDataURL(f)}};
window.handleEditBannerSelect=e=>{const f=e.target.files[0]; if(f){currentBannerBlob=f; const r=new FileReader(); r.onload=x=>document.getElementById('edit-banner-preview').src=x.target.result; r.readAsDataURL(f)}};

window.saveProfileChanges=async()=>{
    const b=document.getElementById('save-profile-btn'), ot=b.innerText, n=document.getElementById('edit-name').value, bio=document.getElementById('edit-bio').value, un=document.getElementById('edit-username').value.trim().toLowerCase();
    b.innerText="Saving..."; b.disabled=true;
    if(!n) return showToast("Name required"),b.innerText=ot,b.disabled=false;
    if(un!==currentUser.username && (un.length<3||!/^[a-z0-9_.]+$/.test(un)||!(await getDocs(query(collection(db,"users"),where("username","==",un)))).empty)) return showToast("Invalid/Taken username",true),b.innerText=ot,b.disabled=false;

    let av=currentUser.avatar, bu=currentUser.banner;
    try{ if(currentAvatarBlob) av=await uploadToImgHippo(currentAvatarBlob); if(currentBannerBlob) bu=await uploadToImgHippo(currentBannerBlob); } catch(e){return showToast("Upload failed"),b.innerText=ot,b.disabled=false}
    
    await updateDoc(doc(db,"users",currentUser.id),{name:n,bio:bio,avatar:av,banner:bu,bannerPos:currentBannerPos,username:un});
    Object.assign(currentUser,{name:n,bio:bio,avatar:av,banner:bu,bannerPos:currentBannerPos,username:un});
    currentAvatarBlob=currentBannerBlob=null; updateUserInterface(); closeEditProfile(); showProfile(currentUser.id,window.currentProfileTab); showToast("Updated"); b.innerText=ot; b.disabled=false;
};

// --- Links ---
window.saveLink=async()=>{
    const t=document.getElementById('new-link-title').value.trim(), u=document.getElementById('new-link-url').value.trim();
    if(!t||!u) return showToast("Fill all fields",true);
    const l={title:t,url:u,type:'web'}; await updateDoc(doc(db,"users",currentUser.id),{links:arrayUnion(l)});
    (currentUser.links=currentUser.links||[]).push(l); document.getElementById('add-link-modal').classList.add('hidden');
    document.getElementById('new-link-title').value=document.getElementById('new-link-url').value=""; renderProfileContent(currentUser.id,'links'); showToast("Link added!");
};
window.deleteLink=async i=>showAlert("Remove link?",async()=>{await updateDoc(doc(db,"users",currentUser.id),{links:arrayRemove(currentUser.links[i])}); currentUser.links.splice(i,1); renderProfileContent(currentUser.id,'links'); showToast("Removed")});

// --- Post View ---
window.openPostView = pid => {
    const p = posts.find(x => x.id === pid), o = document.getElementById('post-view-overlay'); 
    if(!p) return;
    window.currentViewingPostId = pid;
    window.currentViewingAuthorId = p.authorId;
    o.classList.remove('mobile-reel-view'); 
    document.body.classList.remove('reel-mode');
    
    const a = users.find(u => u.id === p.authorId) || {name: 'Unknown', avatar: ''};

    // Mobile Overlay Content Population
    document.getElementById('mobile-post-pfp-lg').src = a.avatar;
    document.getElementById('mobile-post-username-lg').innerText = a.name;
    document.getElementById('mobile-post-time').innerText = formatDate(p.timestamp);
    document.getElementById('mobile-post-user-area').onclick = () => { closePostView(); showProfile(a.id); };
    
    // Mobile Caption (with logic)
    const capEl = document.getElementById('mobile-post-caption-text');
    const txt = p.content;
    const trunc = txt.length > 180;
    if(trunc) {
        capEl.innerHTML = `${formatContent(txt.substring(0, 180))}...<span class="read-more-btn" onclick="this.parentElement.innerHTML='${formatContent(txt.replace(/"/g, '&quot;'))}'">more</span>`;
    } else {
        capEl.innerHTML = formatContent(txt);
    }

    // Mobile Media
    const mmc = document.getElementById('mobile-post-media-area');
    mmc.innerHTML = '';
    if(p.media) {
        const ma = Array.isArray(p.media) ? p.media : [p.media];
        if(ma.length === 1) {
            const s = ma[0], iv = s.includes('video') || s.endsWith('.mp4') || s.startsWith('data:video');
            if(iv) {
                mmc.innerHTML = `<video src="${s}" class="w-full h-auto max-h-[600px] object-contain bg-black" controls></video>`;
            } else {
                mmc.innerHTML = `<img src="${s}" class="w-full h-auto object-cover bg-gray-100">`; // Changed to full width auto height as requested
            }
        } else {
            // Carousel for mobile overlay
            let sl = '', dt = ''; 
            const cid = `mobile-overlay-carousel-${p.id}`;
            ma.forEach((s, i) => {
                sl += `<div class="post-carousel-item" style="background:#fff">${(s.startsWith('data:video')||s.includes('.mp4')) ? `<video src="${s}" controls class="w-full h-full object-contain"></video>` : `<img src="${s}" class="w-full h-full object-contain">`}</div>`;
                dt += `<div class="carousel-dot ${i===0?'active':''}" id="mobile-overlay-dot-${p.id}-${i}"></div>`;
            });
            mmc.innerHTML = `<div class="carousel-wrapper aspect-square"><div class="rounded-lg overflow-hidden post-carousel touch-pan-y" id="${cid}" style="background:#000" ontouchstart="handleTouchStart(event)" ontouchend="handleTouchEnd(event,'${p.id}',false)"><div class="post-carousel-inner" id="mobile-overlay-inner-${p.id}">${sl}</div><button class="carousel-nav-btn prev" onclick="event.stopPropagation();moveCarousel('${cid}',-1,false,true)"><i data-lucide="chevron-left" class="w-4 h-4"></i></button><button class="carousel-nav-btn next" onclick="event.stopPropagation();moveCarousel('${cid}',1,false,true)"><i data-lucide="chevron-right" class="w-4 h-4"></i></button></div><div class="carousel-dots-outside">${dt}</div></div>`;
            (window.carouselStates = window.carouselStates || {})[cid] = {index: 0, total: ma.length};
        }
    }

    // Liked By Logic for Mobile Overlay
    const mlba = document.getElementById('mobile-liked-by-area');
    mlba.innerHTML = '';
    if(p.likes?.length && currentUser.following){
        const f = p.likes.filter(id => currentUser.following.includes(id) && id !== currentUser.id);
        if(f.length > 0) {
            const ff = users.find(u => u.id === f[0]);
            if(ff) mlba.innerHTML = `<div class="flex items-center"><img src="${ff.avatar}" class="w-5 h-5 rounded-full border border-white -mr-1 z-10"><span class="text-[13px] text-gray-900 ml-2">Liked by <span class="font-bold">${ff.name}</span>${f.length>1?` and ${f.length-1} others`:''}</span></div>`;
        }
    }

    // Render Comments (Desktop Modal + Mobile Drawer List)
    renderCommentsInModal(pid);
    updatePostViewStats(pid);

    const il = p.likes?.includes(currentUser.id), is = savedPosts.includes(pid);
    
    // Update Icons State
    // Desktop
    const dLike = document.getElementById('post-view-like-btn');
    if(dLike) { dLike.className = `w-6 h-6 cursor-pointer hover:scale-110 transition-transform ${il ? 'fill-red-500 text-red-500' : 'text-gray-700'}`; }
    const dSave = document.getElementById('post-view-save-btn');
    if(dSave) { dSave.className = `w-6 h-6 cursor-pointer hover:scale-110 transition-transform ${is ? 'fill-yellow-500 text-yellow-500' : 'text-gray-700'}`; }

    // Mobile
    const mLike = document.getElementById('mobile-overlay-like-icon');
    if(mLike) { mLike.className = `w-7 h-7 ${il ? 'fill-red-500 text-red-500' : 'text-[#1f1f1f]'}`; }
    const mSave = document.getElementById('mobile-overlay-save-icon');
    if(mSave) { mSave.className = `w-7 h-7 ${is ? 'fill-yellow-500 text-yellow-500' : 'text-[#1f1f1f]'}`; }

    document.getElementById('comment-input-mobile').value = ""; // Clear input
    document.getElementById('mobile-comment-input-avatar').src = currentUser.avatar;

    o.classList.remove('hidden'); 
    o.classList.add('flex'); 
    refreshIcons();
};

window.toggleMobileCommentDrawer = () => {
    const d = document.getElementById('mobile-comments-overlay');
    const panel = d.querySelector('.absolute.bottom-0');
    
    if(d.classList.contains('hidden')) {
        // Open
        d.classList.remove('hidden');
        setTimeout(() => {
            panel.classList.remove('translate-y-full');
            panel.classList.add('translate-y-0');
        }, 10);
    } else {
        // Close
        panel.classList.remove('translate-y-0');
        panel.classList.add('translate-y-full');
        setTimeout(() => {
            d.classList.add('hidden');
        }, 300);
    }
};

window.toggleReelCaption=pid=>{const e=document.getElementById('reel-caption'); if(!e||!e.dataset.full)return; const ex=e.getAttribute('data-expanded')==='true'; e.innerHTML=ex?`<span>${e.dataset.full.substring(0,80)}... </span><span class="font-bold text-gray-300 cursor-pointer" onclick="event.stopPropagation(); toggleReelCaption('${pid}')">more</span>`:`<span>${e.dataset.full}</span> <span class="font-bold text-gray-300 cursor-pointer block mt-1" onclick="event.stopPropagation(); toggleReelCaption('${pid}')">less</span>`; e.setAttribute('data-expanded',!ex); Object.assign(e.style,{overflowY:ex?'hidden':'auto',maxHeight:ex?'':'200px'})};
window.closePostView=()=>{const o=document.getElementById('post-view-overlay'); o.classList.add('hidden'); o.classList.remove('flex'); document.body.classList.remove('reel-mode'); document.querySelector('.discussion-panel')?.classList.remove('open'); window.currentViewingPostId=window.replyingToCommentId=null; document.querySelector('#post-view-media-container video')?.pause()};
window.doLogout=async()=>{ await signOut(auth); window.location.href="index.html" };

function renderCommentsInModal(pid){
    const p=posts.find(x=>x.id===pid); 
    if(!p) return;
    
    // Desktop count update
    const c=document.getElementById('post-view-comments'); 
    document.getElementById('post-view-likes-count').innerText=p.settings?.showLikes!==false?`${p.likes?.length||0} likes`:'';
    
    // Mobile count update
    document.getElementById('mobile-overlay-comment-count').innerText = p.comments?.length||0;

    const topLevel = p.comments?.filter(x => !x.parentId) || [];
    const html = topLevel.length 
        ? topLevel.map(k => createThreadedCommentHTML(k, p.comments, pid)).join('') 
        : '<div class="flex flex-col items-center justify-center py-10 text-gray-400"><i data-lucide="message-square" class="w-12 h-12 mb-2 opacity-50"></i><p>No comments yet.</p></div>';

    if(c) c.innerHTML = html;
    
    // Mobile Drawer Content
    const mc = document.getElementById('mobile-comments-list');
    if(mc) mc.innerHTML = html;

    refreshIcons();
}

// Recursive/Threaded Comment rendering with visual lines
function createThreadedCommentHTML(c, allComments, pid) {
    const a = users.find(u => u.id === c.authorId) || {name: 'Unknown', avatar: ''};
    const replies = allComments.filter(r => r.parentId === c.id);
    
    let replyHtml = '';
    if(replies.length > 0) {
        replyHtml = `<div class="thread-connector-container">`;
        replies.forEach(rep => {
             // Visual Connector Line Logic
             const ra = users.find(u => u.id === rep.authorId) || {name: 'Unknown', avatar: ''};
             replyHtml += `
             <div class="reply-item-container">
                <div class="reply-connector-line"></div>
                <div class="reply-vertical-line"></div>
                <div class="comment-row pl-2">
                    <img src="${ra.avatar}" class="comment-avatar" onclick="showProfile('${rep.authorId}')">
                    <div class="comment-content-box">
                        <div class="comment-header">
                            <span onclick="showProfile('${rep.authorId}')" class="cursor-pointer hover:underline">${ra.name}</span>
                            <span class="comment-time">${formatDate(rep.timestamp)}</span>
                        </div>
                        <div class="comment-text">${formatContent(rep.content)}</div>
                        <div class="comment-actions-row">
                            <button class="comment-action-btn" onclick="toggleCommentLike('${pid}','${rep.id}')">
                                <i data-lucide="heart" class="w-3.5 h-3.5 ${rep.likes?.includes(currentUser.id)?'fill-red-500 text-red-500':''}"></i> 
                                <span>${rep.likes?.length||''}</span>
                            </button>
                            ${rep.authorId===currentUser.id ? `<button onclick="deleteComment('${pid}','${rep.id}')" class="comment-action-btn text-red-600">Delete</button>` : ''}
                        </div>
                    </div>
                </div>
             </div>`;
        });
        replyHtml += `</div>`;
    }

    return `
    <div class="comment-wrapper px-4 pt-3">
        <div class="comment-row">
            <img src="${a.avatar}" class="comment-avatar" onclick="showProfile('${c.authorId}')">
            <div class="comment-content-box">
                <div class="comment-header">
                    <span onclick="showProfile('${c.authorId}')" class="cursor-pointer hover:underline">${a.name}</span>
                    <span class="comment-time">${formatDate(c.timestamp)}</span>
                </div>
                <div class="comment-text">${formatContent(c.content)}</div>
                <div class="comment-actions-row">
                    <button class="comment-action-btn" onclick="toggleCommentLike('${pid}','${c.id}')">
                        <i data-lucide="heart" class="w-3.5 h-3.5 ${c.likes?.includes(currentUser.id)?'fill-red-500 text-red-500':''}"></i> 
                        <span>${c.likes?.length||''}</span>
                    </button>
                    <div class="comment-reply-btn" onclick="replyToComment('${c.id}','${a.name}')">Reply</div>
                    ${c.authorId===currentUser.id ? `<button onclick="deleteComment('${pid}','${c.id}')" class="comment-action-btn text-red-600">Delete</button>` : ''}
                </div>
            </div>
        </div>
        ${replyHtml}
    </div>`;
}

// Reuse existing reply/delete functions, ensure they work with mobile
window.replyToComment=(cid,u)=>{ 
    window.replyingToCommentId=cid; 
    // Desktop input
    const dInp = document.getElementById('comment-input-desktop');
    if(dInp && dInp.offsetParent !== null) {
        dInp.value=`@${u} `; dInp.focus();
    }
    // Mobile input - open drawer first if hidden
    const mInp = document.getElementById('comment-input-mobile');
    const drawer = document.getElementById('mobile-comments-overlay');
    
    if(window.innerWidth < 768 && drawer.classList.contains('hidden')) {
        toggleMobileCommentDrawer();
    }
    
    setTimeout(() => {
        if(mInp) {
            mInp.value=`@${u} `; mInp.focus();
        }
    }, 100);
};

window.submitCommentDesktop=async()=>{ 
    const t=document.getElementById('comment-input-desktop').value.trim(); 
    await processCommentSubmission(t);
    document.getElementById('comment-input-desktop').value=""; 
};

window.submitCommentMobile=async()=>{
    const t=document.getElementById('comment-input-mobile').value.trim();
    await processCommentSubmission(t);
    document.getElementById('comment-input-mobile').value="";
};

async function processCommentSubmission(t) {
    if(!t||!window.currentViewingPostId) return; 
    const r=doc(db,"posts",window.currentViewingPostId), nc={id:"c-"+Date.now()+"-"+Math.floor(Math.random()*1000),authorId:currentUser.id,content:t,timestamp:Date.now(),likes:[],parentId:window.replyingToCommentId}; 
    await updateDoc(r,{comments:arrayUnion(nc)}); 
    const p=posts.find(x=>x.id===window.currentViewingPostId); 
    if(window.replyingToCommentId){
        const pc=p.comments.find(x=>x.id===window.replyingToCommentId);
        if(pc&&pc.authorId!==currentUser.id) sendNotification(pc.authorId,'reply','replied to your comment',window.currentViewingPostId);
    } else if(p&&p.authorId!==currentUser.id) sendNotification(p.authorId,'comment','commented on your post',window.currentViewingPostId); 
    window.replyingToCommentId=null;
}

window.openThread=(pid,cid)=>{ window.threadPostId=pid; window.threadParentCommentId=cid; renderThreadContent(pid,cid); document.getElementById('thread-overlay').classList.remove('hidden'); document.getElementById('thread-input').focus(); document.getElementById('thread-input-avatar').src=currentUser.avatar; };
window.closeThread=()=>{ document.getElementById('thread-overlay').classList.add('hidden'); window.threadPostId=null; window.threadParentCommentId=null; window.replyingToCommentId=null; };
window.renderThreadContent=(pid,cid)=>{ 
    // Legacy thread view function, mostly superseded by the threaded view in main comments, but kept for deep link logic if needed
    const p=posts.find(x=>x.id===pid); if(!p) return; 
    const pc=p.comments.find(x=>x.id===cid); if(!pc) return; 
    // ... existing thread logic kept for safety ...
};

window.submitThreadReply=async()=>{ const t=document.getElementById('thread-input').value.trim(); if(!t||!window.threadPostId||!window.threadParentCommentId) return; const r=doc(db,"posts",window.threadPostId), nc={id:"c-"+Date.now()+"-"+Math.floor(Math.random()*1000),authorId:currentUser.id,content:t,timestamp:Date.now(),likes:[],parentId:window.threadParentCommentId}; await updateDoc(r,{comments:arrayUnion(nc)}); const p=posts.find(x=>x.id===window.threadPostId), pc=p.comments.find(x=>x.id===window.threadParentCommentId); if(pc&&pc.authorId!==currentUser.id) sendNotification(pc.authorId,'reply','replied to your comment',window.threadPostId); document.getElementById('thread-input').value=""; };
window.deleteComment=async(pid,cid)=>{ showAlert("Delete comment?",async()=>{ const r=doc(db,"posts",pid), p=posts.find(x=>x.id===pid), nc=p.comments.filter(x=>x.id!==cid&&x.parentId!==cid); await updateDoc(r,{comments:nc}); showToast("Deleted"); }); };
window.toggleCommentLike=async(pid,cid)=>{ const p=posts.find(x=>x.id===pid); if(!p) return; const c=p.comments||[], i=c.findIndex(x=>x.id===cid); if(i===-1) return; const cm=c[i]; if(!cm.likes) cm.likes=[]; if(cm.likes.includes(currentUser.id)) cm.likes=cm.likes.filter(x=>x!==currentUser.id); else { cm.likes.push(currentUser.id); if(cm.authorId!==currentUser.id) sendNotification(cm.authorId,'like','liked your comment',pid); } c[i]=cm; await updateDoc(doc(db,"posts",pid),{comments:c}); };

window.promptForImageLink=()=>{ const u=prompt("Enter Image URL:"); if(u&&(u.startsWith('http')||u.startsWith('data:'))){ window.currentMedia=[u]; window.currentMediaType='image'; document.getElementById('media-preview-container').classList.remove('hidden'); document.getElementById('preview-inner').innerHTML=`<img src="${u}" class="h-20 w-20 object-cover rounded-md">`; showToast("Added"); } };
window.sendAnnouncement=async()=>{ const t=document.getElementById('announcement-text').value.trim(); if(!t) return; showAlert("Broadcast?",async()=>{ for(const u of users) if(u.id!==currentUser.id) await addDoc(collection(db,"notifications"),{receiverId:u.id,senderId:currentUser.id,type:'official',content:t,timestamp:serverTimestamp(),read:false}); showToast("Sent"); document.getElementById('announcement-text').value=""; }); };
window.openCreateMenu=()=>{ document.getElementById('create-menu-overlay').classList.remove('opacity-0','pointer-events-none'); document.getElementById('create-menu-modal').classList.remove('scale-95'); };
window.closeCreateMenu=()=>{ document.getElementById('create-menu-overlay').classList.add('opacity-0','pointer-events-none'); document.getElementById('create-menu-modal').classList.add('scale-95'); };
window.openEventComposer=()=>{ closeCreateMenu(); removeEventCover(); document.getElementById('event-overlay').classList.remove('opacity-0','pointer-events-none'); document.getElementById('event-modal-box').classList.remove('scale-95'); };
window.closeEventComposer=()=>{ document.getElementById('event-overlay').classList.add('opacity-0','pointer-events-none'); document.getElementById('event-modal-box').classList.add('scale-95'); };
window.handleEventCoverSelect=e=>{ const f=e.target.files[0]; if(f){ currentEventCoverBlob=f; const r=new FileReader(); r.onload=x=>{window.currentEventCover=x.target.result; document.getElementById('event-cover-preview').src=window.currentEventCover; document.getElementById('event-cover-preview-container').classList.remove('hidden'); document.getElementById('add-cover-btn').classList.add('hidden');}; r.readAsDataURL(f); } };
window.removeEventCover=()=>{ window.currentEventCover=null; currentEventCoverBlob=null; document.getElementById('event-cover-preview').src=""; document.getElementById('event-cover-preview-container').classList.add('hidden'); document.getElementById('add-cover-btn').classList.remove('hidden'); document.getElementById('event-cover-input').value=""; };
window.publishEvent=()=>{ showToast("Coming soon!",false); closeEventComposer(); };
window.showPostOptions=(e,pid,aid)=>{ 
    e.stopPropagation(); 
    const o=document.getElementById('post-options-overlay'), m=document.getElementById('post-options-modal'), c=document.getElementById('post-options-content'), me=aid===currentUser.id, adm=currentUser.email==='edulinkbht@gmail.com', ce=me, cd=me||adm; 
    let h=''; 
    if(ce) h+=`<button onclick="editPost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="edit-2" class="w-5 h-5"></i> Edit Post</button>`; 
    if(cd) h+=`<button onclick="deletePost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="trash-2" class="w-5 h-5"></i> Delete Post</button>`; 
    if(!me){ const s=savedPosts.includes(pid); h+=`<button onclick="toggleSave('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="bookmark" class="w-5 h-5 ${s?'fill-yellow-500 text-yellow-500':''}"></i> ${s?'Unsave':'Save'} Post</button>`; h+=`<button onclick="showToast('Reported'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-red-50 rounded-xl transition-colors font-bold text-red-600 text-left"><i data-lucide="flag" class="w-5 h-5"></i> Report Post</button>`; } 
    h+=`<button onclick="sharePost('${pid}'); hidePostMenu()" class="flex items-center gap-3 w-full p-4 hover:bg-gray-50 rounded-xl transition-colors font-bold text-gray-800 text-left"><i data-lucide="link" class="w-5 h-5"></i> Copy Link</button>`; 
    c.innerHTML=h; 
    refreshIcons(); 
    
    // RESET TRANSFORM & ENSURE INITIAL STATE
    m.style.transform = '';
    m.style.transition = 'none';
    o.classList.add('opacity-0');
    m.classList.add('translate-y-full', 'md:scale-95');
    m.classList.remove('translate-y-0', 'md:scale-100');
    
    o.classList.remove('hidden');
    void m.offsetWidth; // Force Reflow
    
    m.style.transition = '';
    setTimeout(() => {
        o.classList.remove('opacity-0');
        m.classList.remove('translate-y-full', 'md:scale-95');
        m.classList.add('translate-y-0', 'md:scale-100');
    }, 20);
};
window.hidePostMenu=()=>{ const o=document.getElementById('post-options-overlay'), m=document.getElementById('post-options-modal'); o.classList.add('opacity-0'); m.classList.add('translate-y-full','md:scale-95'); m.classList.remove('translate-y-0','md:scale-100'); setTimeout(()=>o.classList.add('hidden'),200); };
window.editPost=pid=>{ 
    const p=posts.find(x=>x.id===pid); 
    if(!p) return; 
    document.getElementById('compose-text').value=p.content; 
    window.editingPostId=pid; 
    document.getElementById('compose-header-title').innerText="Edit Post"; 
    
    // Reset and Populate Grid
    window.composeImages = [null, null, null, null];
    window.composeImageBlobs = [null, null, null, null];
    
    if(p.media) {
        const m = Array.isArray(p.media) ? p.media : [p.media];
        m.forEach((url, i) => {
            if(i < 4) window.composeImages[i] = url;
        });
    }
    renderMediaGrid();
    
    // Start at Step 1 to show images
    window.composeStep = 1;
    document.getElementById('compose-step-1').classList.remove('hidden');
    document.getElementById('compose-step-2').classList.add('hidden');
    document.getElementById('compose-footer-settings').classList.add('hidden');
    
    // Update button text
    const hasImage = window.composeImages.some(x => x !== null);
    const btn = document.getElementById('compose-action-btn');
    btn.innerText = hasImage ? "Next" : "Skip"; 
    btn.onclick = window.handleComposeAction;

    openCompose(true); 
};
window.deletePost=async(pid)=>{ showAlert("Delete post?",async()=>{ await deleteDoc(doc(db,"posts",pid)); showToast("Deleted"); }); };
window.openCompose=(isEdit = false)=>{ 
    closeCreateMenu(); 
    document.getElementById('compose-overlay').classList.remove('opacity-0','pointer-events-none'); 
    const modal = document.getElementById('compose-modal');
    modal.classList.remove('scale-95'); 
    modal.classList.remove('translate-y-full');
    
    if(!isEdit){
        // Reset Logic
        window.composeStep = 1;
        window.composeImages = [null, null, null, null];
        window.composeImageBlobs = [null, null, null, null];
        window.selectedCollaborators=[]; 
        window.editingPostId=null;
        document.getElementById('compose-text').value="";
        document.getElementById('compose-header-title').innerText="Create Post";
        document.getElementById('compose-step-1').classList.remove('hidden');
        document.getElementById('compose-step-2').classList.add('hidden');
        document.getElementById('compose-action-btn').innerText = "Skip";
        renderMediaGrid();
        renderCollabChips();
    }
};
window.attemptCloseCompose=()=>{
    // If editing or content added, confirm discard
    const hasContent = document.getElementById('compose-text').value.trim().length > 0 || window.composeImages.some(x=>x!==null);
    if(hasContent && !window.editingPostId) {
        showAlert("Discard post?", () => closeCompose());
    } else {
        closeCompose();
    }
};
window.closeCompose=()=>{ 
    document.getElementById('compose-overlay').classList.add('opacity-0','pointer-events-none'); 
    const modal = document.getElementById('compose-modal');
    modal.classList.add('scale-95'); 
    modal.classList.add('translate-y-full');
    setTimeout(() => { 
        window.editingPostId=null; 
        document.getElementById('compose-text').value="";
        window.composeImages = [null, null, null, null];
        window.composeImageBlobs = [null, null, null, null];
    },200); 
};
window.toggleComposeSettings=()=>{ const a=document.getElementById('compose-settings-area'), ar=document.getElementById('compose-settings-arrow'); a.classList.toggle('hidden'); ar.style.transform=a.classList.contains('hidden')?'rotate(0deg)':'rotate(180deg)'; };
window.openUploadOptions=()=>document.getElementById('upload-options-modal').classList.remove('hidden');
window.triggerUpload=m=>{ window.uploadMode=m; document.getElementById('upload-options-modal').classList.add('hidden'); const i=document.getElementById('media-input'); if(m==='multiple') i.setAttribute('multiple',''); else i.removeAttribute('multiple'); i.click(); };
window.handleFileSelect=e=>{ const f=e.target.files; if(f.length>0){ window.currentMediaBlob=[]; window.currentMedia=[]; const c=document.getElementById('media-preview-container'), inr=document.getElementById('preview-inner'); c.classList.remove('hidden'); inr.innerHTML=''; const ps=Array.from(f).map(file=>{ window.currentMediaBlob.push(file); return new Promise(r=>{ const d=new FileReader(); d.onload=ev=>{ window.currentMedia.push(ev.target.result); const iv=file.type.startsWith('video'), el=document.createElement(iv?'video':'img'); el.src=ev.target.result; el.className="h-20 w-20 object-cover rounded-md border border-gray-200 shrink-0"; inr.appendChild(el); r(); }; d.readAsDataURL(file); }); }); Promise.all(ps).then(()=>showToast(`${f.length} file(s) ready`)); } };
window.removeMedia=()=>{ window.currentMedia=[]; window.currentMediaBlob=[]; document.getElementById('media-preview-container').classList.add('hidden'); document.getElementById('media-input').value=""; };

// New Compose Flow Logic
window.renderMediaGrid = () => {
    const grid = document.getElementById('media-grid-container');
    grid.innerHTML = '';
    const btn = document.getElementById('compose-action-btn');
    let hasImage = false;

    for(let i=0; i<4; i++) {
        const url = window.composeImages[i];
        const div = document.createElement('div');
        div.className = "aspect-square border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center relative overflow-hidden bg-gray-50 transition-colors";
        
        if (url) {
            hasImage = true;
            div.className = "aspect-square rounded-xl overflow-hidden relative shadow-sm border border-gray-200";
            if (url.includes('video') || url.endsWith('.mp4') || (window.composeImageBlobs[i] && window.composeImageBlobs[i].type.startsWith('video'))) {
                 div.innerHTML = `<video src="${url}" class="w-full h-full object-cover pointer-events-none"></video><button onclick="removeGridImage(${i})" class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full hover:bg-black/80"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            } else {
                 div.innerHTML = `<img src="${url}" class="w-full h-full object-cover"><button onclick="removeGridImage(${i})" class="absolute top-2 right-2 bg-black/60 text-white p-1 rounded-full hover:bg-black/80"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            }
        } else {
            const isNext = (i === 0) || (window.composeImages[i-1] !== null);
            if (isNext) {
                div.innerHTML = `<i data-lucide="plus" class="w-8 h-8 text-gray-400"></i>`;
                div.classList.add('cursor-pointer', 'hover:bg-gray-100');
                div.onclick = () => window.handleGridUpload(i);
            } else {
                div.innerHTML = ''; 
                div.className = "aspect-square border-2 border-dashed border-gray-200 rounded-xl bg-transparent";
            }
        }
        grid.appendChild(div);
    }
    
    if(window.composeStep === 1) {
        btn.innerText = hasImage ? "Next" : "Skip";
        btn.onclick = window.handleComposeAction;
    }
    refreshIcons();
};

window.handleGridUpload = (index) => {
    window.currentUploadIndex = index;
    document.getElementById('grid-upload-input').click();
};

window.onGridFileSelect = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
        window.composeImages[window.currentUploadIndex] = ev.target.result;
        window.composeImageBlobs[window.currentUploadIndex] = file;
        renderMediaGrid();
    };
    reader.readAsDataURL(file);
    document.getElementById('grid-upload-input').value = ""; 
};

window.removeGridImage = (index) => {
    window.composeImages[index] = null;
    window.composeImageBlobs[index] = null;
    const valid = window.composeImages.filter(x => x !== null);
    const validBlobs = window.composeImageBlobs.filter(x => x !== null);
    window.composeImages = [null, null, null, null];
    window.composeImageBlobs = [null, null, null, null];
    valid.forEach((v, i) => window.composeImages[i] = v);
    validBlobs.forEach((v, i) => window.composeImageBlobs[i] = v);
    
    renderMediaGrid();
};

window.handleComposeAction = () => {
    if (window.composeStep === 1) {
        goToStep2();
    } else {
        publishPost();
    }
};

window.goToStep2 = () => {
    window.composeStep = 2;
    document.getElementById('compose-step-1').classList.add('hidden');
    document.getElementById('compose-step-2').classList.remove('hidden');
    document.getElementById('compose-footer-settings').classList.remove('hidden'); // Show settings container
    document.getElementById('compose-action-btn').innerText = "Post";
    document.getElementById('compose-action-btn').onclick = window.publishPost;
};

window.handleComposeBack = () => {
    if (window.composeStep === 2) {
        window.composeStep = 1;
        document.getElementById('compose-step-1').classList.remove('hidden');
        document.getElementById('compose-step-2').classList.add('hidden');
        document.getElementById('compose-footer-settings').classList.add('hidden'); // Hide settings container
        
        document.getElementById('compose-header-title').innerText = "Create Post";
        
        const hasImage = window.composeImages.some(x => x !== null);
        const btn = document.getElementById('compose-action-btn');
        btn.innerText = hasImage ? "Next" : "Skip";
        btn.onclick = window.handleComposeAction;
    } else {
        attemptCloseCompose();
    }
};

async function uploadToImgHippo(f){ const d=new FormData(); d.append('api_key','d28bf3c492ad07b53dc4e3f9ce99b072'); d.append('file',f); try{ const r=await fetch('https://api.imghippo.com/v1/upload',{method:'POST',body:d}), j=await r.json(); if(j.success) return j.data.url; else throw new Error('Upload failed'); }catch(e){throw e;} }
window.publishPost=async()=>{ 
    const tr=document.getElementById('compose-text').value;
    const hasImages = window.composeImages.some(x => x !== null);
    
    if(!tr.trim() && !hasImages) return showToast("Empty!",true);
    
    // Progress Bar Simulation
    const progressOverlay = document.getElementById('compose-progress-overlay');
    const progressBar = document.getElementById('post-progress-bar');
    progressOverlay.classList.remove('hidden');
    progressOverlay.classList.add('flex');
    
    let progress = 0;
    const interval = setInterval(() => {
        if(progress < 90) {
            progress += Math.random() * 15;
            progressBar.style.width = `${Math.min(progress, 90)}%`;
        }
    }, 300);

    const priv=document.getElementById('post-setting-privacy').checked, sl=document.getElementById('post-setting-likes').checked, sc=document.getElementById('post-setting-comments').checked, alv=document.getElementById('post-setting-like-view').checked, ac=document.getElementById('post-setting-allow-comments').checked; 
    
    try{ 
        let mu=[]; 
        for(let i=0; i<4; i++){
            const url = window.composeImages[i];
            const blob = window.composeImageBlobs[i];
            
            if(url) {
                if(blob) {
                    try { 
                        mu.push(await uploadToImgHippo(blob)); 
                    } catch(e) { 
                        const mr=ref(storage,`posts/${currentUser.id}/${Date.now()}_${i}_${blob.name}`); 
                        await uploadBytes(mr,blob); 
                        mu.push(await getDownloadURL(mr)); 
                    } 
                } else {
                    mu.push(url);
                }
            }
        }
        
        const mp=mu.length===1?mu[0]:(mu.length>0?mu:null); 
    
        const mentionMatches = tr.match(/@(\w+)/g);
        const mentionUids = [];
        if(mentionMatches){
            mentionMatches.forEach(m => {
                const uname = m.substring(1).toLowerCase();
                const found = users.find(u => (u.username||"").toLowerCase() === uname);
                if(found) mentionUids.push(found.id);
            });
        }

        const pd={authorId:currentUser.id,content:tr,media:mp,timestamp:serverTimestamp(),likes:[],comments:[],collaborators:window.selectedCollaborators||[],mentions:mentionUids,settings:{privacy:priv?'private':'public',showLikes:sl,showComments:sc,allowLikeView:alv,allowComments:ac}}; 
        let pid=null; 
        
        if(window.editingPostId){ 
            await updateDoc(doc(db,"posts",window.editingPostId),{content:tr,media:mp,settings:pd.settings}); 
            pid=window.editingPostId; 
            showToast("Updated!"); 
        } else { 
            const r=await addDoc(collection(db,"posts"),pd); 
            pid=r.id; 
            showToast("Posted!"); 
            if(window.selectedCollaborators?.length) window.selectedCollaborators.forEach(c=>sendNotification(c.id,'collab_request','invited to collaborate',pid)); 
        } 
    
        if(mentionUids.length > 0) {
            mentionUids.forEach(uid => {
                if(uid !== currentUser.id) sendNotification(uid, 'mention', 'mentioned you in a post', pid);
            });
        }

        clearInterval(interval);
        progressBar.style.width = '100%';
        await new Promise(r => setTimeout(r, 500)); 
        
        progressOverlay.classList.add('hidden');
        progressOverlay.classList.remove('flex');
        progressBar.style.width = '0%'; 

        closeCompose(); 
    }catch(e){ 
        console.error(e); 
        clearInterval(interval);
        progressOverlay.classList.add('hidden');
        progressOverlay.classList.remove('flex');
        showToast("Error",true); 
    }
};
window.showToast=(m,e=false)=>{ const t=document.getElementById('toast'), tm=document.getElementById('toast-msg'), i=document.getElementById('toast-icon'); tm.innerText=m; if(e){t.style.backgroundColor='#d93025';i.setAttribute('data-lucide','alert-circle');i.classList.remove('text-[#c4eed0]');i.classList.add('text-white');} else {t.style.backgroundColor='#303134';i.setAttribute('data-lucide','check-circle-2');i.classList.add('text-[#c4eed0]');} refreshIcons(); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); };
window.openLightbox=(s,t='image')=>{ const w=document.getElementById('lightbox-wrapper'), l=document.getElementById('lightbox'); if(t==='video'||s.includes('.mp4')||s.includes('data:video')) w.innerHTML=`<video src="${s}" controls autoplay class="max-w-full max-h-[90vh] rounded-lg shadow-2xl"></video>`; else w.innerHTML=`<img src="${s}" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain">`; l.classList.add('active'); l.classList.remove('pointer-events-none','opacity-0'); };
window.closeLightbox=()=>{ const l=document.getElementById('lightbox'); l.classList.remove('active'); l.classList.add('pointer-events-none','opacity-0'); const v=l.querySelector('video'); if(v) v.pause(); };

window.openQR = (uid) => {
    const id = uid || currentUser.id;
    const u = users.find(x => x.id === id) || currentUser;
    const url = `${window.location.origin}${window.location.pathname}?uid=${id}`;
    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}`;
    
    document.getElementById('qr-image').src = qrUrl;
    
    const disp = u.username ? `@${u.username}` : u.name;
    document.getElementById('qr-display-name').innerText = disp;
    document.getElementById('qr-owner-avatar').src = u.avatar;
    
    document.getElementById('qr-hidden-url').value = url;
    
    const overlay = document.getElementById('qr-overlay');
    const modal = document.getElementById('qr-modal');
    
    modal.style.transform = '';
    modal.style.transition = 'none';
    overlay.classList.add('opacity-0');
    modal.classList.add('translate-y-full', 'md:scale-95');
    modal.classList.remove('translate-y-0', 'md:scale-100');
    
    overlay.classList.remove('hidden');
    void modal.offsetWidth; 
    
    modal.style.transition = '';
    setTimeout(()=>{
       overlay.classList.remove('opacity-0');
       modal.classList.remove('translate-y-full', 'md:scale-95');
       modal.classList.add('translate-y-0', 'md:scale-100');
    }, 20);
};

window.copyQRLink = () => {
    const url = document.getElementById('qr-hidden-url').value;
    if(url) {
        navigator.clipboard.writeText(url).then(() => {
            showToast("Link copied!");
        });
    }
};

window.closeQR = () => {
    const overlay = document.getElementById('qr-overlay');
    const modal = document.getElementById('qr-modal');
    overlay.classList.add('opacity-0');
    modal.classList.add('translate-y-full', 'md:scale-95');
    modal.classList.remove('translate-y-0', 'md:scale-100');
    setTimeout(() => overlay.classList.add('hidden'), 200);
};

window.openScanner = () => {
    const overlay = document.getElementById('scanner-overlay');
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    
    if(!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
    }
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
    .catch(err => {
        console.error("Error starting scanner", err);
        showToast("Camera error", true);
        closeScanner();
    });
};

window.closeScanner = () => {
    if(html5QrCode) {
        html5QrCode.stop().then(() => {
            const overlay = document.getElementById('scanner-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }).catch(err => console.error(err));
    } else {
        const overlay = document.getElementById('scanner-overlay');
        overlay.classList.add('hidden');
        overlay.classList.remove('flex');
    }
};

function onScanSuccess(decodedText, decodedResult) {
    if(decodedText.includes('uid=')) {
        const urlParams = new URLSearchParams(new URL(decodedText).search);
        const uid = urlParams.get('uid');
        if(uid) {
            closeScanner();
            showProfile(uid);
            showToast("Profile found!");
        }
    } else {
        closeScanner();
        showToast("Invalid EduLink QR", true);
    }
}

window.openUserList = (type, uid) => {
    const u = users.find(x => x.id === uid);
    if(!u) return;
    
    const list = type === 'following' ? u.following : u.followers;
    const title = type === 'following' ? 'Following' : 'Followers';
    
    document.getElementById('user-list-title').innerText = title;
    const c = document.getElementById('user-list-content');
    c.innerHTML = '';
    
    if(!list || list.length === 0) {
        c.innerHTML = '<div class="text-center text-gray-400 py-8">No users found.</div>';
    } else {
        list.forEach(id => {
            const fu = users.find(x => x.id === id);
            if(fu) {
                const d = document.createElement('div');
                d.className = "flex items-center justify-between p-3 hover:bg-gray-50 rounded-xl cursor-pointer";
                d.onclick = () => { closeUserList(); showProfile(fu.id); };
                
                const isFollowing = currentUser.following.includes(fu.id);
                const isMe = fu.id === currentUser.id;
                let btn = '';
                if(!isMe) {
                    const btnClass = isFollowing ? "bg-gray-100 text-gray-900" : "bg-black text-white";
                    const btnText = isFollowing ? "Following" : "Follow";
                    btn = `<button id="ul-btn-${fu.id}" onclick="event.stopPropagation(); toggleFollow('${fu.id}')" class="text-xs font-bold px-3 py-1.5 rounded-full border border-gray-200 transition-colors ${btnClass}">${btnText}</button>`;
                }

                d.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <img src="${fu.avatar}" class="w-10 h-10 rounded-full border border-gray-100 object-cover shrink-0 bg-gray-50">
                        <div class="min-w-0">
                            <div class="font-bold text-sm text-gray-900 truncate">${fu.name} ${fu.isOfficial?'<i data-lucide="badge-check" class="w-3 h-3 inline text-blue-500"></i>':''}</div>
                            <div class="text-xs text-gray-500 truncate">@${fu.username||'user'}</div>
                        </div>
                    </div>
                    ${btn}
                `;
                c.appendChild(d);
            }
        });
    }
    refreshIcons();

    const overlay = document.getElementById('user-list-overlay');
    const modal = document.getElementById('user-list-modal');
    
    modal.style.transform = '';
    modal.style.transition = 'none';
    overlay.classList.add('opacity-0');
    modal.classList.add('translate-y-full', 'md:scale-95');
    modal.classList.remove('translate-y-0', 'md:scale-100');
    
    overlay.classList.remove('hidden');
    void modal.offsetWidth; 
    
    modal.style.transition = '';
    setTimeout(() => {
        overlay.classList.remove('opacity-0');
        modal.classList.remove('translate-y-full', 'md:scale-95');
        modal.classList.add('translate-y-0', 'md:scale-100');
    }, 20);
};

window.closeUserList = () => {
    const overlay = document.getElementById('user-list-overlay');
    const modal = document.getElementById('user-list-modal');
    overlay.classList.add('opacity-0');
    modal.classList.add('translate-y-full', 'md:scale-95');
    modal.classList.remove('translate-y-0', 'md:scale-100');
    setTimeout(() => overlay.classList.add('hidden'), 200);
};

if(typeof setupSwipeClose === 'function'){
    setupSwipeClose('share-modal', 'share-overlay', window.closeShareMenu);
    setupSwipeClose('edit-profile-modal', 'edit-profile-overlay', window.closeEditProfile);
    setupSwipeClose('likes-modal', 'likes-overlay', window.closeLikes);
    setupSwipeClose('post-options-modal', 'post-options-overlay', window.hidePostMenu);
    setupSwipeClose('notif-options-modal', 'notif-options-overlay', window.closeNotifOptions);
    setupSwipeClose('qr-modal', 'qr-overlay', window.closeQR);
    setupSwipeClose('user-list-modal', 'user-list-overlay', window.closeUserList);
}

const urlParams = new URLSearchParams(window.location.search);
const deepLinkUid = urlParams.get('uid');
if(deepLinkUid) {
    window.pendingProfileUid = deepLinkUid;
}

refreshIcons();
</script>
</body>
</html>
