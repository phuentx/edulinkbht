<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLink - Workspace</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              notion: {
                bg: '#FFFFFF',
                sidebar: '#F7F7F5',
                hover: '#EFEFEF',
                border: '#E9E9E7',
                text: '#37352F',
                textLight: '#9B9A97',
                blue: '#2383E2'
              }
            },
            boxShadow: {
                'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                'popover': '0 4px 12px -2px rgba(0, 0, 0, 0.12), 0 2px 6px -1px rgba(0, 0, 0, 0.08)',
                'menu': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05)'
            },
            keyframes: {
                slideIn: {
                    '0%': { transform: 'translateX(100%)', opacity: '0' },
                    '100%': { transform: 'translateX(0)', opacity: '1' }
                },
                popIn: {
                    '0%': { transform: 'scale(0.95)', opacity: '0' },
                    '100%': { transform: 'scale(1)', opacity: '1' }
                },
                shake: {
                    '0%, 100%': { transform: 'translateX(0)' },
                    '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-2px)' },
                    '20%, 40%, 60%, 80%': { transform: 'translateX(2px)' }
                }
            },
            animation: {
                slideIn: 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                popIn: 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)',
                shake: 'shake 0.5s ease-in-out'
            }
          }
        }
      }
    </script>
    <style>
        body { background-color: #FFFFFF; color: #37352F; height: 100vh; overflow: hidden; }
        
        /* Hidden Scrollbars but Scrollable */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-active { border-bottom: 2px solid #37352F; color: #37352F; font-weight: 600; }
        .tab-inactive { color: #9B9A97; }
        .tab-inactive:hover { color: #37352F; }

        .ai-shimmer {
            background: linear-gradient(90deg, #2383E2, #9D34DA, #2383E2);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        
        .chat-content a, #doc-content a { 
            color: #2383E2; 
            text-decoration: underline; 
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0 2px;
            border-radius: 2px;
            cursor: pointer;
        }
        .chat-content a:hover, #doc-content a:hover {
            color: #1a6cb8;
            background-color: rgba(35, 131, 226, 0.1);
        }
        
        #doc-content:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
        }
        
        .mention-highlight {
            background-color: rgba(245, 166, 35, 0.2);
            color: #d97706;
            font-weight: 600;
            padding: 0 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 1.2em;
            background-color: var(--cursor-color, #2383E2);
            pointer-events: none;
            transition: all 0.1s ease;
            z-index: 20;
        }
        .remote-cursor-label {
            position: absolute;
            top: -1.4em;
            left: -2px;
            background-color: var(--cursor-color, #2383E2);
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
            font-weight: 600;
        }

        .folder-arrow { transition: transform 0.2s; }
        .folder-open .folder-arrow { transform: rotate(90deg); }
        .folder-content { display: none; }
        .folder-open .folder-content { display: block; }

        /* Hover Controls */
        .sidebar-item .item-actions { opacity: 0; transition: opacity 0.2s; }
        .sidebar-item:hover .item-actions { opacity: 1; }
        
        /* Chat Row Hover Logic */
        .chat-row .chat-actions { opacity: 0; transition: all 0.2s ease; pointer-events: none; transform: scale(0.9); }
        .chat-row:hover .chat-actions { opacity: 1; pointer-events: auto; transform: scale(1); }

        .reminder-item .reminder-actions { opacity: 0; transition: opacity 0.2s; }
        .reminder-item:hover .reminder-actions { opacity: 1; }

        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.4rem center; background-size: 1em; padding-right: 2rem; }
    </style>
</head>
<body class="flex text-[15px]">

    <div id="notification-toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none w-80"></div>
    <div id="sidebar-context-menu" class="fixed hidden bg-white border border-gray-200 shadow-popover rounded-lg py-1 z-[150] w-48 text-sm"></div>

    <!-- SIDEBAR -->
    <div class="w-[260px] bg-notion-sidebar border-r border-notion-border flex flex-col h-full flex-shrink-0 transition-all duration-300">
        <!-- User Profile Dropdown -->
        <div class="h-14 flex items-center px-3 hover:bg-notion-hover cursor-pointer m-2 rounded-md transition-colors group relative">
            <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-white object-cover mr-3 shadow-sm border border-gray-200">
            <span id="user-name" class="font-medium truncate flex-1 text-notion-text">Loading...</span>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 bg-notion-hover pl-2 shadow-sm rounded-lg border border-gray-200/50">
                <button id="btn-settings" class="p-1.5 hover:bg-white rounded-md text-gray-500 hover:text-notion-text transition-colors" title="Edit Profile">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                </button>
                <button id="btn-logout" class="p-1.5 hover:bg-red-50 rounded-md text-gray-400 hover:text-red-500 transition-colors" title="Sign Out">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </div>

        <div class="px-4 py-3 text-xs font-semibold text-notion-textLight flex justify-between items-center group tracking-wide mt-2">
            <span>WORKSPACE</span>
            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                <button id="trigger-create-folder" class="hover:bg-gray-200 rounded p-1" title="New Folder"><svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg></button>
                <button id="trigger-create-project" class="hover:bg-gray-200 rounded p-1" title="New Project"><svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button>
            </div>
        </div>
        <div id="project-list" class="flex-shrink-0 overflow-y-auto px-2 space-y-1 no-scrollbar max-h-[40vh]"></div>

        <div class="px-4 py-3 text-xs font-semibold text-notion-textLight flex justify-between items-center group tracking-wide mt-4 border-t border-gray-200/50 pt-4">
            <span>TEAMS</span>
            <button id="trigger-create-team" class="hover:bg-gray-200 rounded p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Create Team">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
            </button>
        </div>
        <div id="team-list" class="flex-1 overflow-y-auto px-2 space-y-1 no-scrollbar pb-4"></div>

        <div class="p-4 border-t border-notion-border text-notion-textLight text-xs flex justify-center cursor-default">EduLink v2.6</div>
    </div>

    <!-- MAIN AREA -->
    <div class="flex-1 flex flex-col h-full bg-white relative">
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white z-10">
            <div class="w-24 h-24 bg-gray-50 rounded-full flex items-center justify-center mb-6 text-5xl shadow-sm border border-gray-100 animate-pulse">ðŸ‘‹</div>
            <h2 class="text-2xl font-semibold text-notion-text">Welcome to EduLink</h2>
            <p class="text-notion-textLight mt-2 text-base">Select a project or team from the sidebar.</p>
            <button id="btn-create-empty" class="mt-8 px-6 py-3 bg-notion-blue text-white rounded-lg shadow-sm hover:bg-blue-600 transition text-sm font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                Create New Project
            </button>
        </div>

        <div id="workspace-container" class="flex flex-col h-full hidden w-full">
            <div class="h-16 border-b border-notion-border flex items-center justify-between px-6 bg-white sticky top-0 z-40">
                <div class="flex items-center gap-3 flex-1 min-w-0 mr-6">
                    <span class="text-2xl cursor-default select-none" id="doc-icon">ðŸ“„</span>
                    <input id="doc-title" type="text" class="text-lg font-semibold text-notion-text outline-none hover:bg-notion-sidebar px-2 py-1.5 rounded w-full max-w-md transition-colors bg-transparent placeholder-gray-400" placeholder="Untitled">
                    <div id="save-indicator" class="text-xs text-notion-textLight hidden whitespace-nowrap bg-gray-50 px-2 py-1 rounded border border-gray-100">Saving...</div>
                </div>

                <div class="flex items-center gap-3 relative">
                    <!-- Broadcast & Announce (Same Style as Share) -->
                    <button id="btn-broadcast-create" class="hidden text-sm font-medium text-notion-text hover:bg-notion-sidebar px-4 py-2 rounded-lg transition-colors border border-gray-200 hover:border-gray-300 flex items-center gap-2 animate-slideIn">
                        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg> <span>Broadcast</span>
                    </button>
                    <button id="btn-announce-create" class="hidden text-sm font-medium text-notion-text hover:bg-notion-sidebar px-4 py-2 rounded-lg transition-colors border border-gray-200 hover:border-gray-300 flex items-center gap-2 animate-slideIn">
                        <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6"/></svg> <span>Announce</span>
                    </button>

                    <button id="btn-open-share" class="text-sm font-medium text-notion-text hover:bg-notion-sidebar px-4 py-2 rounded-lg transition-colors border border-gray-200 hover:border-gray-300 flex items-center gap-2">
                        <span>Share</span>
                    </button>

                    <span class="h-6 w-[1px] bg-gray-200 mx-1"></span>
                    <div class="flex -space-x-3 overflow-hidden cursor-pointer hover:opacity-100 opacity-90 transition py-1 px-1" id="member-avatars" onclick="document.getElementById('share-modal').classList.remove('hidden')" title="Manage Members"></div>

                    <div class="relative">
                        <button id="btn-notifications" class="text-notion-textLight hover:text-notion-text p-2 rounded-lg hover:bg-gray-100 relative transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                            <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full hidden"></span>
                        </button>
                        <div id="notification-popover" class="hidden absolute top-14 right-0 w-80 bg-white border border-gray-200 shadow-popover rounded-xl z-50 flex flex-col max-h-96 animate-slideIn origin-top-right overflow-hidden">
                            <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 backdrop-blur-sm">
                                <span class="font-semibold text-xs text-gray-500 tracking-wide">NOTIFICATIONS</span>
                            </div>
                            <div id="notification-list" class="overflow-y-auto no-scrollbar flex-1 p-0 min-h-[120px]"></div>
                        </div>
                    </div>
                    <button id="btn-toggle-sidebar" class="text-notion-textLight hover:text-notion-text p-2 rounded-lg hover:bg-gray-100" title="Toggle Sidebar"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7"/></svg></button>
                </div>
            </div>

            <!-- Editor -->
            <div class="flex flex-1 overflow-hidden relative">
                <div class="flex-1 overflow-y-auto bg-white cursor-text relative no-scrollbar flex justify-center" id="editor-container" onclick="focusEditor(event)">
                    <div class="w-full max-w-[850px] py-12 px-14 min-h-full flex flex-col relative">
                        <div id="editor-toolbar" class="sticky top-0 bg-white/95 backdrop-blur z-30 flex gap-2 py-2 mb-6 border-b border-transparent hover:border-gray-100 transition-colors opacity-0 hover:opacity-100 items-center">
                            <button onclick="formatDoc('bold')" class="p-1.5 hover:bg-gray-100 rounded-md text-gray-600 font-bold w-8 h-8 flex items-center justify-center text-sm border border-transparent hover:border-gray-200">B</button>
                            <button onclick="formatDoc('italic')" class="p-1.5 hover:bg-gray-100 rounded-md text-gray-600 italic w-8 h-8 flex items-center justify-center text-sm border border-transparent hover:border-gray-200">I</button>
                            <div class="w-[1px] h-4 bg-gray-200 mx-1"></div>
                            <button onclick="window.openLinkModal()" class="p-1.5 hover:bg-gray-100 rounded-md text-gray-600 flex items-center gap-1.5 text-sm px-3 border border-transparent hover:border-gray-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Link</button>
                        </div>
                        <div id="ai-indicator" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-white border border-gray-200 shadow-xl rounded-full px-5 py-2.5 flex items-center gap-2 z-50 animate-bounce"><span class="ai-shimmer font-semibold text-sm">âœ¨ AI is writing...</span></div>
                        <div id="read-only-banner" class="hidden mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-500 flex items-center gap-3"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg><span class="font-medium">View Only</span></div>
                        <div id="remote-cursors-layer" class="absolute inset-0 pointer-events-none z-10 overflow-hidden"></div>
                        <div id="doc-content" contenteditable="true" class="w-full h-full min-h-[75vh] outline-none text-[#37352F] leading-8 text-[17px] font-sans placeholder-gray-300 relative z-20" placeholder="Type '/' for AI commands..."></div>
                    </div>
                </div>

                <!-- AI Selection Menu -->
                <div id="ai-selection-menu" class="fixed hidden bg-white border border-gray-200 shadow-xl rounded-full p-1.5 z-[200] flex gap-2 items-center animate-popIn">
                    <div class="flex items-center gap-1.5 pl-2">
                        <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        <input id="ai-selection-input" type="text" class="text-sm outline-none w-48 text-gray-700 placeholder-gray-400 bg-transparent" placeholder="Ask AI to edit...">
                    </div>
                    <button id="btn-ai-submit" class="p-1.5 rounded-full hover:bg-gray-100 text-notion-blue transition-colors" onclick="window.handleAIEdit()"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg></button>
                </div>

                <!-- Slash AI Menu -->
                <div id="slash-menu" class="fixed hidden bg-white border border-gray-200 rounded-xl shadow-menu z-[100] w-64 overflow-hidden animate-popIn">
                    <div class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wide bg-gray-50 border-b border-gray-100">AI Assistant</div>
                    <div class="p-1">
                        <button onclick="executeAICommand('Continue writing')" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg> Continue writing
                        </button>
                        <button onclick="executeAICommand('Summarize')" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"/></svg> Summarize
                        </button>
                        <button onclick="executeAICommand('Fix grammar and spelling')" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg> Fix grammar
                        </button>
                        <button onclick="executeAICommand('Translate to Spanish')" class="w-full text-left px-3 py-2 text-sm text-gray-700 hover:bg-blue-50 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg> Translate to Spanish
                        </button>
                    </div>
                </div>

                <div id="right-panel" class="w-[360px] border-l border-notion-border bg-white flex flex-col shadow-sm relative z-30 transition-all duration-300">
                    <div class="flex border-b border-notion-border h-14 items-center px-2 gap-1">
                        <button class="flex-1 h-full text-[14px] tab-active transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50" data-tab="chat" title="Chat"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg></button>
                        <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50" data-tab="comments" title="Comments"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/></svg></button>
                        <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50" data-tab="calendar" title="Calendar"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></button>
                        <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50" data-tab="ai" title="AI"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></button>
                    </div>

                    <div id="tab-chat" class="flex-1 flex flex-col h-full overflow-hidden relative">
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar bg-[#FBFAFA]"></div>
                        <!-- Mention Popover -->
                        <div id="mention-suggestions" class="absolute bottom-16 left-4 bg-white border border-gray-200 shadow-xl rounded-lg hidden z-50 w-48 max-h-40 overflow-y-auto no-scrollbar"></div>
                        
                        <div class="p-4 border-t border-notion-border bg-white flex flex-col gap-2 relative">
                            <select id="chat-recipient" class="text-xs p-1.5 bg-gray-50 border border-gray-200 rounded outline-none text-gray-600 mb-1 w-fit">
                                <option value="all">Everyone</option>
                            </select>
                            <form id="chat-form" class="relative">
                                <input id="chat-input" type="text" autocomplete="off" class="w-full text-[15px] p-3 pr-10 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:bg-white focus:border-gray-300 transition-all placeholder-gray-400" placeholder="Message or @mention...">
                                <button type="submit" class="absolute right-3 top-3 text-gray-400 hover:text-notion-blue"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg></button>
                            </form>
                        </div>
                    </div>
                    <div id="tab-comments" class="flex-1 flex flex-col h-full hidden overflow-hidden">
                        <div class="p-4 bg-yellow-50 text-xs text-yellow-800 border-b border-yellow-100 flex justify-between items-center font-medium"><span>Discussion & Feedback</span></div>
                        <div id="comments-list" class="flex-1 overflow-y-auto p-5 space-y-3 no-scrollbar bg-white"></div>
                        <div class="p-4 border-t border-notion-border bg-white"><form id="comments-form" class="relative"><textarea id="comment-input" rows="2" class="w-full text-[15px] p-3 border border-gray-200 rounded-lg outline-none focus:border-notion-blue resize-none bg-gray-50 focus:bg-white transition-colors" placeholder="Add a comment..."></textarea><button type="submit" class="mt-2 w-full py-2 bg-gray-100 text-xs font-semibold text-gray-600 rounded-lg hover:bg-gray-200 transition-colors">Post Comment</button></form></div>
                    </div>
                    <div id="tab-calendar" class="flex-1 flex flex-col h-full hidden overflow-hidden bg-white">
                        <div class="p-5 border-b border-gray-100"><h3 class="font-semibold text-sm mb-4 text-gray-700 flex items-center gap-2"><svg class="w-4 h-4 text-notion-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Add Reminder</h3><form id="reminder-form" class="space-y-3"><input id="rem-title" type="text" placeholder="Event or Task..." class="w-full p-2.5 text-sm border border-gray-200 rounded-lg outline-none focus:border-notion-blue bg-gray-50 focus:bg-white transition-colors" required><div class="flex gap-2"><input id="rem-date" type="date" class="flex-1 p-2.5 text-sm border border-gray-200 rounded-lg outline-none bg-gray-50 focus:bg-white transition-colors text-gray-500" required><input id="rem-time" type="time" class="flex-1 p-2.5 text-sm border border-gray-200 rounded-lg outline-none bg-gray-50 focus:bg-white transition-colors text-gray-500" required></div><button type="submit" class="w-full py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm transition-transform active:scale-[0.98]">Set Reminder</button></form></div>
                        <div class="flex-1 overflow-y-auto no-scrollbar p-5"><h4 class="text-[11px] font-bold text-gray-400 uppercase mb-3 tracking-wider flex justify-between">Upcoming Events</h4><div id="reminder-list" class="space-y-3"></div></div>
                    </div>
                    <div id="tab-ai" class="flex-1 flex flex-col h-full hidden overflow-hidden">
                        <div class="p-4 bg-blue-50 text-xs text-blue-800 border-b border-blue-100 leading-relaxed flex gap-2"><span class="text-xl">ðŸ¤–</span> <span><strong>AI Assistant:</strong> Ask questions about the document, summarize content, or generate ideas.</span></div>
                        <div id="ai-messages" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar bg-white"></div>
                        <div class="p-4 border-t border-notion-border bg-white"><form id="ai-form" class="relative"><input id="ai-input" type="text" class="w-full text-[15px] p-3 pr-10 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:border-purple-300 focus:bg-white transition-all placeholder-gray-400" placeholder="Ask AI something..."><button type="submit" class="absolute right-3 top-3 text-purple-500 hover:text-purple-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></form></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Re-introduced Message Context Menu -->
    <div id="msg-context-menu" class="fixed hidden bg-white border border-gray-200 shadow-popover rounded-lg py-1 z-[160] w-40 text-sm overflow-hidden">
        <button id="btn-delete-me" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
            Hide for me
        </button>
        <button id="btn-delete-all" class="w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 hidden flex items-center gap-2 border-t border-gray-100">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            Delete for all
        </button>
    </div>

    <div id="link-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text mb-5">Insert Link</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Text</label><input id="link-text-input" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue" placeholder="Display text"></div>
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">URL</label><input id="link-url-input" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue" placeholder="https://example.com"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="document.getElementById('link-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button><button id="btn-confirm-link" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm font-medium transition-colors">Insert Link</button></div>
        </div>
    </div>
    
    <div id="share-folder-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform">
            <div class="flex items-center gap-3 mb-5">
                <div class="p-2 bg-blue-50 rounded-lg text-notion-blue"><svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>
                <h3 class="text-lg font-bold text-notion-text">Share Folder</h3>
            </div>
            <p class="text-sm text-gray-500 mb-5 leading-relaxed">Inviting a user here will add them to <strong>every project</strong> currently inside this folder and give them access to the folder structure.</p>
            
            <div class="mb-2">
                <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-2">User Email</label>
                <input id="folder-share-email" type="email" class="w-full p-3 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue transition-all" placeholder="colleague@example.com">
            </div>

            <div class="flex justify-end gap-3 mt-8"><button onclick="window.hideModal('share-folder-modal')" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button><button id="btn-confirm-folder-share" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm font-medium transition-colors">Share All</button></div>
        </div>
    </div>

    <div id="broadcast-compose-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[480px] p-6 scale-95 transition-transform duration-200 transform">
            <div class="flex items-center gap-2 mb-4 text-notion-text">
                <svg id="bc-icon" class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6"/></svg>
                <h3 class="text-lg font-bold" id="bc-modal-title">Announcement</h3>
            </div>
            <p class="text-sm text-gray-500 mb-4">Send a message to project members.</p>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Recipients</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="bc-recipient" value="all" checked class="text-notion-blue" onchange="toggleBcList(false)"> All Members</label>
                    <label class="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="bc-recipient" value="specific" class="text-notion-blue" onchange="toggleBcList(true)"> Specific Users</label>
                </div>
                <div id="bc-user-list" class="mt-2 hidden p-2 border border-gray-200 rounded max-h-32 overflow-y-auto bg-gray-50 no-scrollbar"></div>
            </div>

            <textarea id="broadcast-input" rows="3" class="w-full p-3 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue bg-gray-50 focus:bg-white transition-colors resize-none" placeholder="Type your announcement..."></textarea>
            <div class="flex justify-end gap-3 mt-6"><button onclick="document.getElementById('broadcast-compose-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button><button id="btn-send-broadcast" class="px-4 py-2 text-sm bg-notion-text text-white rounded-lg hover:bg-black shadow-sm font-medium transition-colors">Send</button></div>
        </div>
    </div>

    <div id="broadcast-receive-overlay" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center backdrop-blur-md animate-slideIn">
        <div class="bg-white rounded-2xl shadow-2xl w-[500px] p-8 text-center relative animate-popIn">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-notion-blue"><svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Announcement</h2>
            <div class="w-12 h-1 bg-notion-blue rounded-full mx-auto mb-6"></div>
            <p id="broadcast-message-text" class="text-lg text-gray-600 leading-relaxed mb-8">...</p>
            <button onclick="document.getElementById('broadcast-receive-overlay').classList.add('hidden')" class="px-8 py-3 bg-gray-900 text-white rounded-xl font-medium hover:bg-black transition-colors shadow-lg">Got it</button>
        </div>
    </div>

    <div id="reminder-overlay" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center backdrop-blur-md animate-slideIn">
        <div class="bg-white rounded-2xl shadow-2xl w-[400px] p-8 text-center relative animate-popIn animate-shake">
            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-500"><svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Reminder!</h2>
            <p id="reminder-overlay-text" class="text-lg text-gray-600 leading-relaxed mb-8">...</p>
            <button onclick="document.getElementById('reminder-overlay').classList.add('hidden')" class="px-8 py-3 bg-gray-900 text-white rounded-xl font-medium hover:bg-black transition-colors shadow-lg">Dismiss</button>
        </div>
    </div>

    <div id="create-folder-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text mb-5">Create Folder</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Folder Name</label><input id="new-folder-name" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue" placeholder="e.g. Science Projects"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="hideModal('create-folder-modal')" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-folder" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create</button></div>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text mb-5">Create New Project</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Title</label><input id="new-proj-title" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue focus:ring-1 focus:ring-blue-100 transition-all" placeholder="e.g. Marketing Plan Q4"></div>
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Folder</label><select id="new-proj-folder" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue bg-white"><option value="">No Folder</option></select></div>
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Initial Privacy</label><div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg bg-gray-50"><input type="checkbox" id="new-proj-private" class="w-4 h-4 rounded text-notion-blue focus:ring-offset-0 focus:ring-0"><span class="text-sm text-gray-700 font-medium">Private (Invite only)</span></div></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button id="btn-cancel-create" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-create" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create Project</button></div>
        </div>
    </div>
    
    <div id="create-team-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text mb-5">Create New Team</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Team Name</label><input id="new-team-name" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue" placeholder="e.g. Engineering"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="hideModal('create-team-modal')" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-team" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create Team</button></div>
        </div>
    </div>

    <div id="manage-team-modal" class="fixed inset-0 bg-black/40 z-[85] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[480px] p-6 scale-95 transition-transform duration-200 transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-notion-text" id="manage-team-title">Manage Team</h3>
                <button onclick="hideModal('manage-team-modal')" class="text-gray-400 hover:text-gray-600">&times;</button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Team Name</label>
                        <input id="edit-team-name" type="text" class="w-full p-2 text-sm border border-gray-200 rounded outline-none focus:border-notion-blue">
                    </div>
                    <button id="btn-update-team-name" class="px-3 py-2 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200 h-[38px]">Update</button>
                </div>
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Team Logo URL</label>
                        <input id="edit-team-logo" type="text" class="w-full p-2 text-sm border border-gray-200 rounded outline-none focus:border-notion-blue" placeholder="https://...">
                    </div>
                    <button id="btn-update-team-logo" class="px-3 py-2 bg-gray-100 text-gray-600 text-xs rounded hover:bg-gray-200 h-[38px]">Save</button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-6">
                <input id="team-invite-email" type="email" placeholder="Invite member by email..." class="flex-1 p-2.5 text-sm border border-gray-200 rounded-lg outline-none focus:border-notion-blue">
                <button id="btn-team-invite" class="px-4 py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm">Invite</button>
            </div>

            <div>
                <div class="text-[11px] font-bold text-gray-400 uppercase tracking-wide mb-3">Members</div>
                <div id="team-members-list" class="flex flex-col gap-2 max-h-[150px] overflow-y-auto no-scrollbar bg-gray-50 rounded-lg p-2 min-h-[80px]"></div>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text mb-6">Edit Profile</h3>
            <div class="space-y-6">
                <div class="flex flex-col items-center"><img id="edit-profile-preview" src="" class="w-24 h-24 rounded-full border-4 border-gray-50 mb-3 object-cover shadow-sm bg-gray-100"><span class="text-xs text-gray-400">Preview</span></div>
                <div><label class="block text-xs font-semibold text-notion-textLight mb-1.5 uppercase tracking-wide">Display Name</label><input id="edit-display-name" type="text" class="w-full p-2.5 border border-gray-200 rounded-lg text-sm outline-none focus:border-notion-blue" placeholder="Your Name"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button id="btn-cancel-profile" class="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg font-medium transition-colors">Cancel</button><button id="btn-save-profile" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm font-medium transition-colors">Save Changes</button></div>
        </div>
    </div>

    <div id="share-modal" class="fixed inset-0 bg-black/30 z-[90] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-modal w-[520px] overflow-hidden">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-[#FBFBFA]">
                <h3 class="font-semibold text-sm text-gray-700">Share Project</h3>
                <button class="text-gray-400 hover:text-gray-600 p-1.5 rounded-lg hover:bg-gray-100" onclick="document.getElementById('share-modal').classList.add('hidden')"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex gap-2">
                    <input id="invite-email" type="email" placeholder="Add people by email..." class="flex-1 p-2.5 text-sm border border-gray-200 rounded-lg outline-none focus:border-notion-blue transition-colors">
                    <select id="invite-role" class="text-sm bg-gray-50 border border-gray-200 rounded-lg px-3 outline-none text-gray-600 cursor-pointer hover:bg-gray-100 transition-colors"><option value="editor">Editor</option><option value="commenter">Commenter</option><option value="viewer">Viewer</option></select>
                    <button id="btn-send-invite" class="px-4 py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm transition-colors">Invite</button>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <label class="block text-[10px] font-bold text-gray-400 uppercase tracking-wide mb-2">Or Share with Team</label>
                    <div class="flex gap-2">
                        <select id="share-team-select" class="flex-1 p-2 text-sm border border-gray-200 rounded-lg outline-none bg-white"><option value="">Select a team...</option></select>
                        <button id="btn-share-team" class="px-3 py-2 bg-white border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-100 transition-colors">Add Team</button>
                    </div>
                </div>
                <div class="mt-2 pt-4 border-t border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-2"><div class="p-2 bg-gray-100 rounded-full text-gray-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg></div><div class="text-xs text-gray-500">Anyone with the link can view if public</div></div>
                    <button id="btn-copy-link" class="text-xs font-semibold text-notion-blue hover:text-blue-700 hover:bg-blue-50 px-3 py-1.5 rounded-md transition-colors flex items-center gap-1.5"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>Copy Link</button>
                </div>
                <div class="mt-4"><div class="text-[11px] font-bold text-gray-400 uppercase tracking-wide mb-3">Who has access</div><div id="members-list" class="flex flex-col gap-2 max-h-[240px] overflow-y-auto no-scrollbar"></div></div>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, orderBy, serverTimestamp, getDoc, setDoc, deleteDoc, getDocs, or } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
        authDomain: "edulinki.firebaseapp.com",
        projectId: "edulinki",
        storageBucket: "edulinki.firebasestorage.app",
        messagingSenderId: "248886466474",
        appId: "1:248886466474:web:160043201a6b28bafbbdd3",
        measurementId: "G-MQBH12VL7N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentProjectId = null;
    let currentRole = 'editor'; 
    let unsubscribeDoc, unsubscribeChat, unsubscribeReminders, unsubscribeComments, unsubscribeNotifs, unsubscribeBroadcasts, unsubscribePresence, unsubscribeFolders, unsubscribeProjects;
    
    // Global State
    let initialLoad = true;
    let debounceTimer;
    let activeReminders = [];
    let notifiedReminders = new Set();
    let sessionStartTime = new Date();
    let userColors = ['#F5A623', '#2383E2', '#27AE60', '#EB5757', '#9D34DA', '#FF0080'];
    let myColor = userColors[Math.floor(Math.random() * userColors.length)];
    let myTeams = []; 
    let myFolders = [];
    let mentionableUsers = new Set();
    let currentSelectionRange = null;

    // --- GLOBAL HELPERS (Attached to window for HTML events) ---
    window.showModal = (id) => { const m = document.getElementById(id); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95'); }, 10); }
    window.hideModal = (id) => { const m = document.getElementById(id); m.classList.add('opacity-0'); m.children[0].classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
    window.toggleBcList = (show) => { document.getElementById('bc-user-list').style.display = show ? 'block' : 'none'; }
    window.playSound = () => { const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); audio.volume = 0.5; audio.play().catch(e=>{}); }
    
    function linkify(text) {
        const urlRegex = /((https?:\/\/|www\.)[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            let href = url; if (!href.startsWith('http')) href = 'http://' + href;
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }

    function notify(msg, type='info') {
        const container = document.getElementById('notification-toast-container');
        const el = document.createElement('div');
        let icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        if(type==='invite') icon = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
        if(type==='success') icon = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        el.className = "bg-white border border-gray-200 text-notion-text text-sm p-4 rounded-xl shadow-xl animate-slideIn pointer-events-auto flex items-start gap-4 w-full";
        el.innerHTML = `<div class="mt-0.5 flex-shrink-0 text-notion-blue">${icon}</div><div class="flex-1"><div class="font-semibold text-gray-800">${type === 'invite' ? 'New Invitation' : (type === 'success' ? 'Success' : 'Notification')}</div><div class="text-xs text-gray-500 mt-1 leading-relaxed">${msg}</div></div>`;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(100%)'; setTimeout(() => el.remove(), 300); }, 6000);
    }

    function saveCursor(el) {
        const sel = window.getSelection();
        if(!sel.rangeCount) return null;
        const range = sel.getRangeAt(0);
        if(!el.contains(range.startContainer)) return null;
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(el);
        preCaretRange.setEnd(range.startContainer, range.startOffset);
        return preCaretRange.toString().length;
    }

    function restoreCursor(el, pos) {
        if(pos === null) return;
        const range = document.createRange();
        range.setStart(el, 0); range.collapse(true);
        let stack = [el], node, foundStart = false, stop = false, charIndex = 0;
        while (!stop && (node = stack.pop())) {
            if (node.nodeType === 3) {
                const nextCharIndex = charIndex + node.length;
                if (!foundStart && pos >= charIndex && pos <= nextCharIndex) {
                    range.setStart(node, pos - charIndex); range.collapse(true); foundStart = true; stop = true;
                }
                charIndex = nextCharIndex;
            } else { let i = node.childNodes.length; while (i--) stack.push(node.childNodes[i]); }
        }
        const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    }

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = 'index.html'; } 
        else {
            try {
                currentUser = user; 
                updateUserUI();
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, email: user.email, displayName: user.displayName||"", photoURL: user.photoURL||"", lastLogin: serverTimestamp() }, { merge: true });
                
                // Request Notification Permission
                if (Notification.permission !== 'granted') { Notification.requestPermission(); }

                const urlParams = new URLSearchParams(window.location.search); 
                const pid = urlParams.get('project');
                
                loadFolders();
                loadTeams(); 
                loadUserNotifications(); 
                if(pid) selectProject(pid); 
                
                setInterval(checkReminders, 10000);
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('user-name').textContent = "Error Loading";
            }
        }
    });

    function updateUserUI() {
        document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
        const avatarUrl = currentUser.photoURL && !currentUser.photoURL.includes('dicebear') ? currentUser.photoURL : `https://api.dicebear.com/9.x/lorelei/svg?seed=${currentUser.email}`;
        document.getElementById('user-avatar').src = avatarUrl;
        document.getElementById('edit-profile-preview').src = avatarUrl;
    }
    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // --- FOLDERS & PROJECT ORGANIZATION ---
    function loadFolders() {
        if(unsubscribeFolders) unsubscribeFolders();
        // Query folders where I am owner OR sharedWith contains my email
        const q = query(
            collection(db, "folders"), 
            or(
                where("ownerId", "==", currentUser.uid),
                where("sharedWith", "array-contains", currentUser.email)
            )
        );
        unsubscribeFolders = onSnapshot(q, (snap) => {
            myFolders = [];
            const folderSelect = document.getElementById('new-proj-folder');
            folderSelect.innerHTML = '<option value="">No Folder</option>';
            snap.forEach(d => {
                const fData = d.data();
                myFolders.push({id: d.id, ...fData});
                folderSelect.innerHTML += `<option value="${d.id}">${fData.name} ${fData.ownerId !== currentUser.uid ? '(Shared)' : ''}</option>`;
            });
            loadProjects(); 
        });
    }

    document.getElementById('trigger-create-folder').addEventListener('click', () => window.showModal('create-folder-modal'));
    document.getElementById('btn-confirm-folder').addEventListener('click', async() => {
        const name = document.getElementById('new-folder-name').value.trim();
        if(!name) return;
        await addDoc(collection(db, "folders"), { name, ownerId: currentUser.uid, sharedWith: [], createdAt: serverTimestamp() });
        window.hideModal('create-folder-modal');
        document.getElementById('new-folder-name').value = '';
    });

    // --- TEAMS LOGIC ---
    function loadTeams() {
        const q = query(collection(db, "teams"), where("members", "array-contains", currentUser.email));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('team-list'); list.innerHTML = '';
            const shareSelect = document.getElementById('share-team-select');
            shareSelect.innerHTML = '<option value="">Select a team...</option>';
            myTeams = [];

            snap.forEach(d => {
                const t = d.data();
                myTeams.push({id: d.id, ...t});
                t.members.forEach(m => mentionableUsers.add(m)); // Add team members to mentions
                const div = document.createElement('div');
                div.className = "px-3 py-2 rounded-md cursor-pointer text-[14px] flex items-center gap-2.5 transition-colors text-notion-textLight hover:bg-[#EFEFEF] hover:text-notion-text";
                const img = t.logo ? `<img src="${t.logo}" class="w-4 h-4 rounded-full object-cover">` : `<span class="text-base">ðŸ›¡ï¸</span>`;
                div.innerHTML = `${img} <span class="font-medium truncate">${t.name}</span>`;
                div.onclick = () => openManageTeam(d.id, t);
                list.appendChild(div);

                const opt = document.createElement('option');
                opt.value = d.id; opt.textContent = t.name;
                shareSelect.appendChild(opt);
            });
        });
    }

    document.getElementById('trigger-create-team').addEventListener('click', () => window.showModal('create-team-modal'));
    document.getElementById('btn-confirm-team').addEventListener('click', async () => {
        const name = document.getElementById('new-team-name').value.trim();
        if(!name) return;
        await addDoc(collection(db, "teams"), {
            name, ownerId: currentUser.uid, members: [currentUser.email], pending: [], logo: ""
        });
        window.hideModal('create-team-modal'); notify("Team created!", "success");
    });

    let managingTeamId = null;
    function openManageTeam(tid, data) {
        managingTeamId = tid;
        document.getElementById('manage-team-title').textContent = `Manage ${data.name}`;
        document.getElementById('edit-team-name').value = data.name;
        document.getElementById('edit-team-logo').value = data.logo || "";
        
        const list = document.getElementById('team-members-list'); list.innerHTML = '';
        data.members.forEach(m => {
            list.innerHTML += `<div class="flex justify-between p-2 text-sm text-gray-700 bg-white rounded border border-gray-100 mb-1"><span>${m}</span>${m===currentUser.email?'<span class="text-xs text-gray-400">(You)</span>':''}</div>`;
        });
        if(data.pending) {
            data.pending.forEach(p => {
                 list.innerHTML += `<div class="flex justify-between p-2 text-sm text-gray-400 bg-white rounded border border-gray-100 border-dashed mb-1"><span>${p} (Pending)</span></div>`;
            });
        }
        window.showModal('manage-team-modal');
    }

    document.getElementById('btn-update-team-name').addEventListener('click', async () => {
        const newName = document.getElementById('edit-team-name').value.trim();
        if(managingTeamId && newName) { await updateDoc(doc(db, "teams", managingTeamId), { name: newName }); notify("Team name updated"); }
    });
    document.getElementById('btn-update-team-logo').addEventListener('click', async () => {
        const url = document.getElementById('edit-team-logo').value.trim();
        if(managingTeamId) { await updateDoc(doc(db, "teams", managingTeamId), { logo: url }); notify("Team logo updated"); }
    });

    document.getElementById('btn-team-invite').addEventListener('click', async () => {
        const email = document.getElementById('team-invite-email').value.trim();
        if(!email || !managingTeamId) return;
        const ref = doc(db, "teams", managingTeamId);
        const snap = await getDoc(ref);
        if(snap.exists() && !snap.data().members.includes(email) && (!snap.data().pending || !snap.data().pending.includes(email))) {
            await updateDoc(ref, { pending: arrayUnion(email) });
            notify(`Invite sent to ${email}`, 'success');
            const uq = query(collection(db, "users"), where("email", "==", email));
            const usnap = await getDocs(uq);
            usnap.forEach(async u => {
                 await addDoc(collection(db, `users/${u.id}/notifications`), {
                     type: 'team_invite', teamId: managingTeamId, teamName: snap.data().name, title: "Team Invitation", text: `You invited to team <strong>${snap.data().name}</strong>.`, timestamp: serverTimestamp(), read: false
                 });
            });
            document.getElementById('team-invite-email').value = '';
            window.hideModal('manage-team-modal');
        }
    });

    document.getElementById('btn-share-team').addEventListener('click', async () => {
        const teamId = document.getElementById('share-team-select').value;
        if(!teamId || !currentProjectId) return;
        const team = myTeams.find(t => t.id === teamId);
        if(team) {
            const ref = doc(db, "projects", currentProjectId);
            const pSnap = await getDoc(ref);
            let access = pSnap.data().access;
            let emails = pSnap.data().memberEmails;
            team.members.forEach(m => {
                if(!emails.includes(m)) { emails.push(m); access.push({email: m, role: 'editor'}); }
            });
            await updateDoc(ref, { memberEmails: emails, access: access });
            notify(`Shared with team ${team.name}`, 'success');
        }
    });

    // --- PROJECTS SIDEBAR & CONTEXT MENU ---
    function loadProjects() {
        if(unsubscribeProjects) unsubscribeProjects(); 
        const q = query(collection(db, "projects"), where("memberEmails", "array-contains", currentUser.email));
        unsubscribeProjects = onSnapshot(q, (snap) => {
            const list = document.getElementById('project-list'); list.innerHTML = '';
            const organized = {};
            const unorganized = [];

            myFolders.forEach(f => organized[f.id] = { id: f.id, name: f.name, owner: f.ownerId, projects: [] });

            snap.forEach((doc) => {
                const p = { id: doc.id, ...doc.data() };
                p.memberEmails.forEach(e => mentionableUsers.add(e)); // Add all project peers to mentions
                if (p.folderId && organized[p.folderId]) {
                    organized[p.folderId].projects.push(p);
                } else {
                    unorganized.push(p);
                }
            });

            // Render Folders
            Object.values(organized).forEach(f => {
                const folderDiv = document.createElement('div');
                folderDiv.className = "mb-1";
                const isShared = f.owner !== currentUser.uid;
                folderDiv.innerHTML = `
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 cursor-pointer hover:bg-gray-100 flex items-center justify-between group sidebar-item">
                        <div class="flex items-center gap-2 flex-1" onclick="this.parentElement.parentElement.classList.toggle('folder-open')">
                            <svg class="w-3 h-3 text-gray-400 folder-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            <span class="truncate">${f.name} ${isShared ? 'ðŸ‘¥' : ''}</span>
                        </div>
                        <button class="item-actions hover:bg-gray-200 rounded h-6 w-6 flex items-center justify-center text-gray-400" onclick="window.showFolderMenu(event, '${f.id}', ${!isShared})">â€¢â€¢â€¢</button>
                    </div>
                    <div class="folder-content pl-2 border-l border-gray-100 ml-4 mb-2"></div>
                `;
                const contentDiv = folderDiv.querySelector('.folder-content');
                f.projects.forEach(p => contentDiv.appendChild(createProjectEl(p)));
                list.appendChild(folderDiv);
            });

            // Render Unorganized
            unorganized.forEach(p => list.appendChild(createProjectEl(p)));
            
            if (currentProjectId) document.getElementById(`proj-${currentProjectId}`)?.classList.add('bg-[#EFEFEF]', 'text-notion-text');
            initialLoad = false;
        });
    }

    function createProjectEl(data) {
        const div = document.createElement('div');
        div.id = `proj-${data.id}`;
        div.className = `px-3 py-2 rounded-md cursor-pointer text-[14px] flex items-center justify-between transition-colors text-notion-textLight hover:bg-[#EFEFEF] hover:text-notion-text sidebar-item group`;
        div.innerHTML = `
            <div class="flex items-center gap-2.5 truncate" onclick="window.selectProject('${data.id}')">
                <span class="opacity-80 text-base">${data.icon || "ðŸ“„"}</span> 
                <span class="truncate font-medium">${data.title}</span>
            </div>
            <button class="item-actions hover:bg-gray-300 rounded h-6 w-6 flex items-center justify-center text-gray-500" onclick="window.showProjectMenu(event, '${data.id}', ${data.ownerId === currentUser.uid}, '${data.folderId || ''}')">â€¢â€¢â€¢</button>
        `;
        return div;
    }

    // Sidebar Menu Logic
    window.showProjectMenu = (e, pid, isOwner, fid) => {
        e.stopPropagation();
        const menu = document.getElementById('sidebar-context-menu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.remove('hidden');
        
        let folderOptions = '';
        myFolders.forEach(f => {
            if(f.id !== fid && f.owner === currentUser.uid) {
                folderOptions += `<button onclick="window.moveProject('${pid}', '${f.id}')" class="w-full text-left px-3 py-2 hover:bg-gray-100">Move to ${f.name}</button>`;
            }
        });
        if(fid) folderOptions += `<button onclick="window.moveProject('${pid}', null)" class="w-full text-left px-3 py-2 hover:bg-gray-100 text-orange-600">Remove from Folder</button>`;

        let html = folderOptions;
        if(html) html += `<div class="border-t border-gray-100 my-1"></div>`;
        
        if(isOwner) {
            html += `<button onclick="window.deleteProject('${pid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600">Delete Project</button>`;
        } else {
            html += `<button onclick="window.leaveProject('${pid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600">Leave Project</button>`;
        }
        menu.innerHTML = html;
    };

    window.showFolderMenu = (e, fid, isOwner) => {
        e.stopPropagation();
        const menu = document.getElementById('sidebar-context-menu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.remove('hidden');
        
        let html = '';
        if(isOwner) {
            html += `<button onclick="window.shareFolder('${fid}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 text-notion-blue font-medium">Share Folder</button>
            <div class="border-t border-gray-100 my-1"></div>
            <button onclick="window.deleteFolder('${fid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 text-red-600">Delete Folder</button>`;
        } else {
            html += `<div class="px-3 py-2 text-xs text-gray-400 italic">Shared with you</div>`;
        }
        menu.innerHTML = html;
    };

    let sharingFolderId = null;
    window.shareFolder = (fid) => {
        sharingFolderId = fid;
        document.getElementById('folder-share-email').value = '';
        window.showModal('share-folder-modal');
    };

    document.getElementById('btn-confirm-folder-share').addEventListener('click', async () => {
        const email = document.getElementById('folder-share-email').value.trim();
        if(!email || !sharingFolderId) return;

        await updateDoc(doc(db, "folders", sharingFolderId), {
            sharedWith: arrayUnion(email)
        });

        const q = query(collection(db, "projects"), where("folderId", "==", sharingFolderId));
        const snap = await getDocs(q);
        
        const updates = [];
        let count = 0;
        snap.forEach(d => {
            const data = d.data();
            if(!data.memberEmails.includes(email)) {
                updates.push(updateDoc(doc(db, "projects", d.id), {
                    memberEmails: arrayUnion(email),
                    access: arrayUnion({ email, role: 'editor' })
                }));
                count++;
            }
        });
        await Promise.all(updates);
        
        notify(`Shared folder & ${count} projects with ${email}`, 'success');
        window.hideModal('share-folder-modal');
    });

    document.addEventListener('click', () => document.getElementById('sidebar-context-menu').classList.add('hidden'));

    window.moveProject = async (pid, fid) => { await updateDoc(doc(db, "projects", pid), { folderId: fid }); notify("Project moved"); };
    window.deleteProject = async (pid) => { if(confirm("Delete project permanently?")) { await deleteDoc(doc(db, "projects", pid)); if(currentProjectId === pid) window.location.href = "home.html"; notify("Project deleted"); } };
    window.leaveProject = async (pid) => { if(confirm("Leave this project?")) { await window.removeMember(currentUser.email, pid); notify("Left project"); } }; 
    window.deleteFolder = async (fid) => {
        if(confirm("Delete folder? Projects inside will be moved to main workspace.")) {
            const q = query(collection(db, "projects"), where("folderId", "==", fid));
            const snap = await getDocs(q);
            snap.forEach(async d => await updateDoc(doc(db, "projects", d.id), { folderId: null }));
            await deleteDoc(doc(db, "folders", fid));
            notify("Folder deleted");
        }
    };
    
    window.selectProject = async (id) => {
        if(currentProjectId === id) return;
        document.querySelectorAll('[id^="proj-"]').forEach(d => d.classList.remove('bg-[#EFEFEF]', 'text-notion-text'));
        document.getElementById(`proj-${id}`)?.classList.add('bg-[#EFEFEF]', 'text-notion-text');
        currentProjectId = id;
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('workspace-container').classList.remove('hidden');
        
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?project=' + id;
        window.history.pushState({path:newUrl},'',newUrl);

        if(unsubscribeDoc) unsubscribeDoc();
        if(unsubscribeChat) unsubscribeChat();
        if(unsubscribeReminders) unsubscribeReminders();
        if(unsubscribeComments) unsubscribeComments();
        if(unsubscribePresence) unsubscribePresence();

        unsubscribeDoc = onSnapshot(doc(db, "projects", id), (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            const myAccess = data.access.find(a => a.email === currentUser.email);
            currentRole = myAccess ? myAccess.role : 'viewer';

            document.getElementById('doc-title').value = data.title;
            document.getElementById('doc-icon').textContent = data.icon || "ðŸ“„";
            const editor = document.getElementById('doc-content');
            const incomingContent = data.content || "";
            if (editor.innerHTML !== incomingContent) {
                 if(document.activeElement === editor) {
                     const cursorPos = saveCursor(editor);
                     editor.innerHTML = incomingContent;
                     restoreCursor(editor, cursorPos);
                 } else { editor.innerHTML = incomingContent; }
            }
            if(currentRole === 'viewer') { editor.setAttribute('contenteditable', 'false'); document.getElementById('read-only-banner').classList.remove('hidden'); } 
            else { editor.setAttribute('contenteditable', 'true'); document.getElementById('read-only-banner').classList.add('hidden'); }

            const ac = document.getElementById('member-avatars'); ac.innerHTML = '';
            const recipientSelect = document.getElementById('chat-recipient');
            recipientSelect.innerHTML = '<option value="all">Everyone</option>';
            const bcList = document.getElementById('bc-user-list'); bcList.innerHTML = '';
            
            data.access.forEach(m => {
                mentionableUsers.add(m.email); // Ensure project members are in mentions
                if (data.access.indexOf(m) < 5) {
                    const img = document.createElement('img');
                    img.src = `https://api.dicebear.com/9.x/lorelei/svg?seed=${m.email}`;
                    img.className = "w-8 h-8 rounded-full border-2 border-white bg-gray-100 -ml-2.5 first:ml-0 hover:z-10 relative transition-transform hover:scale-110";
                    img.title = `${m.email} (${m.role})`;
                    ac.appendChild(img);
                }
                
                if(m.email !== currentUser.email) {
                    const opt = document.createElement('option');
                    opt.value = m.email; opt.textContent = m.email.split('@')[0];
                    recipientSelect.appendChild(opt);
                    bcList.innerHTML += `<label class="flex items-center gap-2 p-1 hover:bg-gray-100 rounded text-xs"><input type="checkbox" value="${m.email}" class="bc-target-user"> ${m.email}</label>`;
                }
            });
            renderMembersList(data.access, data.ownerId === currentUser.uid);
            
            if(data.ownerId === currentUser.uid) {
                document.getElementById('btn-broadcast-create').classList.remove('hidden');
                document.getElementById('btn-announce-create').classList.add('hidden');
            } else {
                document.getElementById('btn-broadcast-create').classList.add('hidden');
                document.getElementById('btn-announce-create').classList.remove('hidden');
            }
        });

        loadChat(id); loadComments(id); loadReminders(id); setupPresence(id);
    }

    // --- EDITOR ---
    window.formatDoc = (cmd) => { document.execCommand(cmd, false, null); document.getElementById('doc-content').focus(); };
    window.openLinkModal = () => { const sel = window.getSelection().toString(); document.getElementById('link-text-input').value = sel || "Link"; document.getElementById('link-url-input').value = ""; window.showModal('link-modal'); };
    document.getElementById('btn-confirm-link').addEventListener('click', () => {
        const text = document.getElementById('link-text-input').value; const url = document.getElementById('link-url-input').value;
        if(text && url) { document.getElementById('doc-content').focus(); document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text}</a>`); }
        window.hideModal('link-modal');
    });

    // --- SLASH COMMANDS LOGIC ---
    const contentInput = document.getElementById('doc-content');
    const slashMenu = document.getElementById('slash-menu');
    
    contentInput.addEventListener('keyup', (e) => {
        if(e.key === '/') {
            const sel = window.getSelection();
            if(sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                slashMenu.style.left = `${rect.left}px`;
                slashMenu.style.top = `${rect.bottom + 10}px`;
                slashMenu.classList.remove('hidden');
            }
        } else {
            if(e.key === 'Escape' || e.key === ' ') {
                slashMenu.classList.add('hidden');
            }
        }
    });

    window.executeAICommand = async (command) => {
        slashMenu.classList.add('hidden');
        contentInput.focus();
        document.execCommand('delete', false, null); 
        document.getElementById('ai-indicator').classList.remove('hidden');
        
        const context = contentInput.innerText;
        const prompt = `Act as a professional writing assistant. ${command}: ${context.substring(0, 1000)}`;
        
        try {
            const result = await fetchAI(prompt, "");
            document.execCommand('insertHTML', false, ` ${result} `);
        } catch(e) { notify("AI failed to respond", "error"); }
        document.getElementById('ai-indicator').classList.add('hidden');
    };

    // --- CONTEXTUAL AI EDIT MENU ---
    document.addEventListener('selectionchange', () => {
        const sel = window.getSelection();
        const menu = document.getElementById('ai-selection-menu');
        const editor = document.getElementById('editor-container');
        
        if (!sel.rangeCount || sel.isCollapsed || !editor.contains(sel.anchorNode)) {
            menu.classList.add('hidden');
            return;
        }

        const range = sel.getRangeAt(0);
        const rect = range.getBoundingClientRect();
        
        if (rect.width === 0) return;

        // Store range so we can restore it when clicking the AI button
        currentSelectionRange = range.cloneRange();

        menu.style.left = `${rect.left + (rect.width / 2) - 100}px`;
        menu.style.top = `${rect.top - 50}px`;
        menu.classList.remove('hidden');
    });

    window.handleAIEdit = async () => {
        const input = document.getElementById('ai-selection-input');
        const prompt = input.value.toLowerCase().trim();
        const menu = document.getElementById('ai-selection-menu');
        
        if (!prompt) return;

        // Restore selection if lost
        if (currentSelectionRange) {
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(currentSelectionRange);
        }

        // Smart Styling Heuristics
        if (prompt.includes('red')) document.execCommand('foreColor', false, 'red');
        else if (prompt.includes('blue')) document.execCommand('foreColor', false, 'blue');
        else if (prompt.includes('green')) document.execCommand('foreColor', false, 'green');
        else if (prompt.includes('bold')) document.execCommand('bold');
        else if (prompt.includes('italic')) document.execCommand('italic');
        else if (prompt.includes('underline')) document.execCommand('underline');
        else if (prompt.includes('times')) document.execCommand('fontName', false, 'Times New Roman');
        else if (prompt.includes('serif')) document.execCommand('fontName', false, 'serif');
        else if (prompt.includes('sans')) document.execCommand('fontName', false, 'sans-serif');
        else {
            // Generative AI Edit
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const selectedText = sel.toString();
                menu.classList.add('hidden'); 
                document.getElementById('ai-indicator').classList.remove('hidden');
                const newText = await fetchAI(prompt, selectedText);
                document.execCommand('insertHTML', false, newText);
                document.getElementById('ai-indicator').classList.add('hidden');
            }
        }
        
        input.value = '';
        menu.classList.add('hidden');
        currentSelectionRange = null;
    };
    
    document.getElementById('ai-selection-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') window.handleAIEdit();
    });

    document.addEventListener('click', (e) => {
        if(!slashMenu.contains(e.target) && e.target !== contentInput) slashMenu.classList.add('hidden');
    });

    const titleInput = document.getElementById('doc-title');
    function save() {
        if(!currentProjectId || currentRole === 'viewer') return;
        document.getElementById('save-indicator').classList.remove('hidden');
        updateDoc(doc(db, "projects", currentProjectId), { title: titleInput.value, content: contentInput.innerHTML, lastModified: serverTimestamp() }).then(() => setTimeout(() => document.getElementById('save-indicator').classList.add('hidden'), 500));
    }
    contentInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(save, 500); updateMyPresence(); });
    titleInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(save, 800); });
    
    // --- PRESENCE ---
    function setupPresence(pid) {
        const container = document.getElementById('editor-container');
        container.addEventListener('mousemove', throttle((e) => {}, 200));
        contentInput.addEventListener('keyup', updateMyPresence);
        contentInput.addEventListener('click', updateMyPresence);
        const presenceRef = collection(db, `projects/${pid}/presence`);
        unsubscribePresence = onSnapshot(presenceRef, (snap) => {
            const layer = document.getElementById('remote-cursors-layer'); layer.innerHTML = '';
            snap.forEach(d => {
                if(d.id === currentUser.uid) return;
                const p = d.data();
                if(Date.now() - p.timestamp > 30000) return; 
                const cursor = document.createElement('div'); cursor.className = 'remote-cursor'; cursor.style.left = p.x + 'px'; cursor.style.top = p.y + 'px'; cursor.style.setProperty('--cursor-color', p.color);
                const label = document.createElement('div'); label.className = 'remote-cursor-label'; label.innerText = p.name; cursor.appendChild(label);
                layer.appendChild(cursor);
            });
        });
    }
    function updateMyPresence() {
        if(!currentProjectId) return;
        const sel = window.getSelection();
        if(sel.rangeCount > 0) {
            const range = sel.getRangeAt(0); const rect = range.getBoundingClientRect(); const containerRect = document.getElementById('editor-container').getBoundingClientRect();
            const x = rect.left - containerRect.left + document.getElementById('editor-container').scrollLeft;
            const y = rect.top - containerRect.top + document.getElementById('editor-container').scrollTop;
            setDoc(doc(db, `projects/${currentProjectId}/presence`, currentUser.uid), { name: currentUser.displayName || "User", color: myColor, x: x, y: y, timestamp: Date.now() });
        }
    }
    function throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }}}

    // --- BROADCAST & ANNOUNCE ---
    const openBroadcast = (title) => {
        document.getElementById('bc-modal-title').textContent = title;
        document.getElementById('broadcast-input').value = ""; 
        window.showModal('broadcast-compose-modal');
    }
    document.getElementById('btn-broadcast-create').addEventListener('click', () => openBroadcast('Broadcast'));
    document.getElementById('btn-announce-create').addEventListener('click', () => openBroadcast('Announcement'));

    document.getElementById('btn-send-broadcast').addEventListener('click', async () => {
        const text = document.getElementById('broadcast-input').value.trim();
        const type = document.querySelector('input[name="bc-recipient"]:checked').value;
        let recipients = [];
        
        if(type === 'specific') {
            const els = document.querySelectorAll('.bc-target-user:checked');
            recipients = Array.from(els).map(el => el.value);
        } else {
            const pDoc = await getDoc(doc(db, "projects", currentProjectId));
            if (pDoc.exists()) {
                recipients = pDoc.data().memberEmails;
            }
        }

        if(!text || recipients.length === 0) return;

        const batchPromises = recipients.map(async (email) => {
            const uq = query(collection(db, "users"), where("email", "==", email));
            const usnap = await getDocs(uq);
            usnap.forEach(async u => {
                await addDoc(collection(db, `users/${u.id}/notifications`), {
                    type: 'broadcast', 
                    text: text, 
                    senderId: currentUser.uid, 
                    timestamp: serverTimestamp(), 
                    read: false 
                });
            });
        });

        await Promise.all(batchPromises);
        window.hideModal('broadcast-compose-modal'); notify("Broadcast sent!", "success");
    });
    
    // --- TABS & SIDEBAR ---
    const tabs = document.querySelectorAll('[data-tab]'); const tabContents = { 'chat': document.getElementById('tab-chat'), 'comments': document.getElementById('tab-comments'), 'calendar': document.getElementById('tab-calendar'), 'ai': document.getElementById('tab-ai') };
    tabs.forEach(t => t.addEventListener('click', () => { tabs.forEach(x => { x.classList.remove('tab-active'); x.classList.add('tab-inactive'); }); t.classList.add('tab-active'); t.classList.remove('tab-inactive'); Object.values(tabContents).forEach(c => c.classList.add('hidden')); tabContents[t.dataset.tab].classList.remove('hidden'); }));
    document.getElementById('btn-toggle-sidebar').addEventListener('click', () => { const p = document.getElementById('right-panel'); p.style.width = p.style.width === '0px' ? '360px' : '0px'; });
    window.focusEditor = (e) => { if(currentRole!=='viewer' && e.target.id === 'editor-container') { document.getElementById('doc-content').focus(); } }

    // --- CHAT: MENTIONS & ACTIONS ---
    const chatInput = document.getElementById('chat-input');
    const mentionBox = document.getElementById('mention-suggestions');
    
    chatInput.addEventListener('input', (e) => {
        const val = e.target.value;
        const lastWord = val.split(' ').pop();
        if(lastWord.startsWith('@') && lastWord.length > 1) {
            const query = lastWord.substring(1).toLowerCase();
            const matches = Array.from(mentionableUsers).filter(m => m.toLowerCase().includes(query));
            if(matches.length > 0) {
                mentionBox.innerHTML = matches.map(m => `<div class="p-2 hover:bg-gray-100 cursor-pointer text-xs" onclick="window.insertMention('${m}')">${m}</div>`).join('');
                mentionBox.classList.remove('hidden');
            } else {
                mentionBox.classList.add('hidden');
            }
        } else {
            mentionBox.classList.add('hidden');
        }
    });

    window.insertMention = (email) => {
        const val = chatInput.value;
        const words = val.split(' ');
        words.pop(); 
        chatInput.value = words.join(' ') + ` @${email} `;
        mentionBox.classList.add('hidden');
        chatInput.focus();
    };

    // Chat Message Action Menu Logic
    let selectedMsgId = null;
    window.openMsgMenu = (e, mid, isSender) => {
        e.stopPropagation();
        selectedMsgId = mid;
        const menu = document.getElementById('msg-context-menu');
        menu.style.left = (e.clientX - 140) + 'px'; 
        menu.style.top = (e.clientY + 5) + 'px';
        menu.classList.remove('hidden');
        document.getElementById('btn-delete-all').classList.toggle('hidden', !isSender);
    };
    
    document.getElementById('btn-delete-me').addEventListener('click', async () => {
        if(!selectedMsgId) return;
        await updateDoc(doc(db, `projects/${currentProjectId}/messages`, selectedMsgId), { hiddenBy: arrayUnion(currentUser.uid) });
        document.getElementById('msg-context-menu').classList.add('hidden');
    });
    document.getElementById('btn-delete-all').addEventListener('click', async () => {
        if(!selectedMsgId) return;
        await deleteDoc(doc(db, `projects/${currentProjectId}/messages`, selectedMsgId));
        document.getElementById('msg-context-menu').classList.add('hidden');
    });
    document.addEventListener('click', () => { document.getElementById('msg-context-menu').classList.add('hidden'); });

    function loadChat(pid) { 
        if(unsubscribeChat) unsubscribeChat();
        unsubscribeChat = onSnapshot(query(collection(db, `projects/${pid}/messages`), orderBy("timestamp", "asc")), (snap) => { 
            const div = document.getElementById('chat-messages'); div.innerHTML = ''; 
            snap.forEach(d => { 
                const m = d.data();
                if(m.hiddenBy && m.hiddenBy.includes(currentUser.uid)) return;
                
                if(m.to && m.to !== 'all') { if(m.to !== currentUser.email && m.senderId !== currentUser.uid) return; }

                const isMe = m.senderId === currentUser.uid;
                const wrap = document.createElement('div'); 
                wrap.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} group relative chat-row mb-1`; 
                
                let bubbleClass = isMe ? 'bg-[#EBF5FE] text-notion-text' : 'bg-white border border-gray-200 text-notion-text';
                let extraLabel = '';
                if(m.to && m.to !== 'all') { bubbleClass = 'bg-purple-50 text-purple-900 border border-purple-100'; extraLabel = `<span class="text-[9px] bg-purple-200 text-purple-800 px-1 rounded ml-1">Private</span>`; }

                let content = linkify(m.text);
                const mentionRegex = new RegExp(`@${currentUser.displayName}|@${currentUser.email}`, 'gi');
                if(!isMe && m.text.match(mentionRegex)) {
                    content = content.replace(mentionRegex, (match) => `<span class="mention-highlight">${match}</span>`);
                    const msgTime = m.timestamp ? m.timestamp.toDate() : new Date();
                    if(new Date() - msgTime < 10000) { 
                        window.playSound(); 
                        notify(`You were mentioned by ${m.senderName}`, 'info');
                    }
                }

                // Chat Actions Buttons (Three Dots Menu Style)
                const menuTrigger = `<button onclick="window.openMsgMenu(event, '${d.id}', ${isMe})" class="absolute top-1/2 -translate-y-1/2 ${isMe ? '-left-6' : '-right-6'} chat-actions text-gray-400 hover:text-gray-600 px-1 text-lg leading-none">â‹®</button>`;

                wrap.innerHTML = `${menuTrigger}<div class="text-[10px] text-gray-400 ml-1 mb-0.5 flex items-center">${m.senderName} ${extraLabel}</div><div class="px-3.5 py-2.5 rounded-xl text-[14px] max-w-[90%] ${bubbleClass} shadow-sm leading-relaxed chat-content relative">${content}</div>`; 
                div.appendChild(wrap); 
            }); 
            div.scrollTop = div.scrollHeight; 
        }); 
    }
    document.getElementById('chat-form').addEventListener('submit', async(e) => { 
        e.preventDefault(); 
        const inp = document.getElementById('chat-input'); 
        const recipient = document.getElementById('chat-recipient').value;
        if(!inp.value.trim()) return; 
        addDoc(collection(db, `projects/${currentProjectId}/messages`), { 
            text: inp.value.trim(), 
            senderId: currentUser.uid, 
            senderName: currentUser.displayName||"User", 
            to: recipient,
            timestamp: serverTimestamp(),
            hiddenBy: []
        }); 
        inp.value = ''; 
    });

    function loadComments(pid) { 
        if(unsubscribeComments) unsubscribeComments();
        unsubscribeComments = onSnapshot(query(collection(db, `projects/${pid}/comments`), orderBy("timestamp", "asc")), (snap) => { const div = document.getElementById('comments-list'); div.innerHTML = ''; snap.forEach(d => { const c = d.data(); const item = document.createElement('div'); item.className = "flex gap-3 items-start p-3 bg-gray-50/80 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors"; item.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=${c.senderEmail}" class="w-6 h-6 rounded-full mt-1 border border-black/5"><div class="flex-1 min-w-0"><div class="flex justify-between items-center"><span class="text-[12px] font-bold text-gray-800">${c.senderName}</span><span class="text-[10px] text-gray-400">${c.timestamp?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ''}</span></div><div class="text-[14px] text-notion-text mt-1 chat-content break-words">${linkify(c.text)}</div></div>`; div.appendChild(item); }); div.scrollTop = div.scrollHeight; }); 
    }
    document.getElementById('comments-form').addEventListener('submit', async (e) => { e.preventDefault(); const inp = document.getElementById('comment-input'); if(!inp.value.trim()) return; addDoc(collection(db, `projects/${currentProjectId}/comments`), { text: inp.value.trim(), senderId: currentUser.uid, senderEmail: currentUser.email, senderName: currentUser.displayName||"User", timestamp: serverTimestamp() }); inp.value = ''; });
    
    // --- REMINDERS WITH OVERLAY & SYSTEM NOTIFICATION ---
    function loadReminders(pid) { 
        if(unsubscribeReminders) unsubscribeReminders();
        unsubscribeReminders = onSnapshot(query(collection(db, `projects/${pid}/reminders`), orderBy("due", "asc")), (snap) => { 
            const div = document.getElementById('reminder-list'); div.innerHTML = ''; activeReminders = []; 
            if(snap.empty) div.innerHTML = '<div class="text-center text-xs text-gray-400 py-6">No upcoming events</div>'; 
            snap.forEach(d => { 
                const r = d.data(); const dateObj = r.due ? r.due.toDate() : new Date(); activeReminders.push({ id: d.id, title: r.title, date: dateObj }); 
                const item = document.createElement('div'); 
                item.className = "flex items-center p-3 bg-blue-50/30 border border-blue-100 rounded-lg hover:bg-blue-50/60 transition relative group reminder-item"; 
                // reminder-actions for hover logic
                const del = document.createElement('button'); del.className="absolute top-1.5 right-1.5 text-gray-300 hover:text-red-500 reminder-actions p-1"; del.innerHTML = "&times;"; del.onclick = (e) => { e.stopPropagation(); deleteDoc(doc(db, `projects/${pid}/reminders`, d.id)); }; 
                item.innerHTML = `<div class="w-12 text-center leading-tight mr-4 border-r border-blue-100 pr-4"><div class="text-[10px] text-blue-600 uppercase font-bold tracking-wide">${dateObj.toLocaleString('default', {month:'short'})}</div><div class="text-xl font-bold text-gray-800">${dateObj.getDate()}</div></div><div class="flex-1"><div class="text-[14px] font-semibold text-notion-text">${r.title}</div><div class="text-[12px] text-gray-500 mt-0.5">${dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€¢ ${r.addedBy}</div></div>`; item.appendChild(del); div.appendChild(item); 
            }); 
        }); 
    }
    function checkReminders() {
        const now = new Date();
        activeReminders.forEach(r => {
            if(r.date <= now && !notifiedReminders.has(r.id)) {
                const diff = now - r.date;
                if(diff < 5 * 60 * 1000) { 
                    // In-App Overlay
                    document.getElementById('reminder-overlay-text').textContent = r.title;
                    document.getElementById('reminder-overlay').classList.remove('hidden');
                    window.playSound();
                    
                    // System Notification (Background)
                    if (Notification.permission === "granted") {
                        new Notification("EduLink Reminder", { body: r.title, icon: "https://i.imghippo.com/files/vgr8207c.png" });
                    }

                    notifiedReminders.add(r.id);
                }
            }
        });
    }
    document.getElementById('reminder-form').addEventListener('submit', async (e) => { e.preventDefault(); const title = document.getElementById('rem-title').value; const date = document.getElementById('rem-date').value; const time = document.getElementById('rem-time').value; if(!title || !date || !time) return; const due = new Date(`${date}T${time}`); await addDoc(collection(db, `projects/${currentProjectId}/reminders`), { title, due, addedBy: currentUser.displayName || "User", timestamp: serverTimestamp() }); document.getElementById('reminder-form').reset(); });

    // --- AI ---
    async function fetchAI(prompt, context) { try { const clean = encodeURIComponent(`Context: ${context.substring(0,500)}...\nQ: ${prompt}`); const res = await fetch(`https://text.pollinations.ai/${clean}`); if(!res.ok) throw new Error(); return await res.text(); } catch(e) { return "AI Unavailable"; } }
    document.getElementById('ai-form').addEventListener('submit', async(e)=>{ e.preventDefault(); const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return; const div = document.getElementById('ai-messages'); div.innerHTML += `<div class="flex flex-col items-end"><div class="bg-gray-100 text-[14px] px-3.5 py-2.5 rounded-xl max-w-[90%] mb-3 text-notion-text shadow-sm">${txt}</div></div>`; inp.value = ''; div.scrollTop = div.scrollHeight; const resp = await fetchAI(txt, document.getElementById('doc-content').innerText); div.innerHTML += `<div class="flex flex-col items-start"><div class="bg-purple-50 border border-purple-100 text-[14px] px-3.5 py-2.5 rounded-xl max-w-[90%] mb-3 text-notion-text leading-relaxed shadow-sm">${resp}</div></div>`; div.scrollTop = div.scrollHeight; });

    // --- PROFILE ---
    const btnSettings = document.getElementById('btn-settings'); btnSettings.addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('edit-display-name').value = currentUser.displayName || ""; window.showModal('profile-modal'); });
    document.getElementById('btn-cancel-profile').addEventListener('click', () => window.hideModal('profile-modal'));
    document.getElementById('btn-save-profile').addEventListener('click', async () => { const newName = document.getElementById('edit-display-name').value.trim(); if(!newName) return; try { await updateProfile(currentUser, { displayName: newName }); await updateDoc(doc(db, "users", currentUser.uid), { displayName: newName }); updateUserUI(); notify("Profile updated successfully", "success"); window.hideModal('profile-modal'); } catch(e) { notify("Failed to update profile", "error"); } });
    
    // --- NOTIFICATIONS & INVITES & GLOBAL BROADCASTS ---
    document.getElementById('btn-notifications').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('notification-popover').classList.toggle('hidden'); document.getElementById('notif-badge').classList.add('hidden'); });
    document.addEventListener('click', (e) => { if(!document.getElementById('btn-notifications').contains(e.target) && !document.getElementById('notification-popover').contains(e.target)) { document.getElementById('notification-popover').classList.add('hidden'); } });
    function loadUserNotifications() {
        const q = query(collection(db, `users/${currentUser.uid}/notifications`), orderBy('timestamp', 'desc'));
        unsubscribeNotifs = onSnapshot(q, (snap) => {
            const list = document.getElementById('notification-list');
            if(snap.empty) { list.innerHTML = '<div class="p-8 text-center text-gray-400 text-sm italic">No new notifications</div>'; return; }
            list.innerHTML = '';
            let hasUnread = false;
            snap.docChanges().forEach(change => {
                if(change.type === 'added') {
                    const n = change.doc.data();
                    // Handle Global Broadcast Alert
                    if (n.type === 'broadcast' && !n.read) {
                        window.playSound();
                        document.getElementById('broadcast-message-text').textContent = n.text;
                        document.getElementById('broadcast-receive-overlay').classList.remove('hidden');
                        
                        if (Notification.permission === "granted") {
                            new Notification("Announcement", { body: n.text, icon: "https://i.imghippo.com/files/vgr8207c.png" });
                        }

                        updateDoc(doc(db, `users/${currentUser.uid}/notifications`, change.doc.id), { read: true });
                    }
                }
            });

            snap.forEach(d => {
                const n = d.data();
                const item = document.createElement('div');
                item.className = "p-4 border-b border-gray-50 hover:bg-gray-50 text-sm flex gap-3 relative group transition-colors";
                const delBtn = document.createElement('button'); delBtn.className = "absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"; delBtn.innerHTML = "&times;";
                delBtn.onclick = (e) => { e.stopPropagation(); deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, d.id)); };
                
                let icon = n.read ? '<div class="w-2.5 h-2.5 rounded-full bg-transparent mt-1.5 flex-shrink-0"></div>' : '<div class="w-2.5 h-2.5 rounded-full bg-blue-500 mt-1.5 flex-shrink-0 shadow-sm border border-white"></div>';
                if(!n.read) hasUnread = true;
                
                let actions = '';
                if(n.type === 'team_invite') {
                    actions = `<div class="mt-2 flex gap-2"><button onclick="window.acceptTeam('${n.teamId}', '${d.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Accept</button><button onclick="window.declineTeam('${d.id}')" class="px-3 py-1 bg-gray-200 text-gray-700 rounded text-xs">Decline</button></div>`;
                }

                item.innerHTML = `${icon}<div class="flex-1 pr-4"><div class="font-semibold text-notion-text leading-tight text-[14px]">${n.title || (n.type === 'broadcast' ? 'Announcement' : 'Notification')}</div><div class="text-gray-500 mt-1 leading-relaxed text-[13px]">${n.text}</div>${actions}<div class="text-[11px] text-gray-400 mt-2 font-medium">${n.timestamp?.toDate().toLocaleDateString() || ""}</div></div>`;
                item.appendChild(delBtn); list.appendChild(item);
                if(!n.read && n.type !== 'broadcast') { updateDoc(doc(db, `users/${currentUser.uid}/notifications`, d.id), { read: true }); }
            });
            if(hasUnread) document.getElementById('notif-badge').classList.remove('hidden');
        });
    }

    window.acceptTeam = async (tid, nid) => {
        const ref = doc(db, "teams", tid);
        await updateDoc(ref, { pending: arrayRemove(currentUser.email), members: arrayUnion(currentUser.email) });
        await deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, nid));
        notify("Joined team!", "success");
    };
    window.declineTeam = async (nid) => { await deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, nid)); notify("Invite declined"); };

    // --- CREATE & SHARE ---
    [document.getElementById('trigger-create-project'), document.getElementById('btn-create-empty')].forEach(b => b.addEventListener('click', ()=>window.showModal('create-modal')));
    document.getElementById('btn-cancel-create').addEventListener('click', ()=>window.hideModal('create-modal'));
    document.getElementById('btn-confirm-create').addEventListener('click', async()=>{
        const title = document.getElementById('new-proj-title').value || "Untitled"; 
        const isPrivate = document.getElementById('new-proj-private').checked;
        const folderId = document.getElementById('new-proj-folder').value || null;
        
        const docRef = await addDoc(collection(db, "projects"), { 
            title, icon: "ðŸ“„", content: "", 
            ownerId: currentUser.uid, 
            folderId: folderId,
            memberEmails: [currentUser.email], 
            access: [{email:currentUser.email, role:'owner'}], 
            createdAt: serverTimestamp(), 
            isPrivate 
        });
        window.hideModal('create-modal'); selectProject(docRef.id);
    });
    document.getElementById('btn-open-share').addEventListener('click', ()=>window.showModal('share-modal'));
    document.getElementById('btn-copy-link').addEventListener('click', () => { if(!currentProjectId) return; const url = window.location.protocol + "//" + window.location.host + window.location.pathname + '?project=' + currentProjectId; navigator.clipboard.writeText(url).then(() => notify("Link copied to clipboard!", "success")).catch(err => notify("Failed to copy link", "error")); });
    function renderMembersList(access, isOwner) {
        const d = document.getElementById('members-list'); d.innerHTML = '';
        access.forEach(m => { 
            let roleDisplay = `<span class="text-[11px] text-gray-400 capitalize font-medium">${m.role}</span>`;
            let actions = '';
            if(isOwner && m.email !== currentUser.email) {
                roleDisplay = `<select onchange="window.updateMemberRole('${m.email}', this.value)" class="text-[11px] bg-transparent border-none outline-none text-gray-500 font-medium cursor-pointer hover:text-gray-800"><option value="editor" ${m.role==='editor'?'selected':''}>Editor</option><option value="commenter" ${m.role==='commenter'?'selected':''}>Commenter</option><option value="viewer" ${m.role==='viewer'?'selected':''}>Viewer</option></select>`;
                actions = `<button class="text-xs text-red-400 hover:text-red-600 font-medium px-2 py-1 rounded hover:bg-red-50 transition-colors" onclick="window.removeMember('${m.email}', '${currentProjectId}')">Remove</button>`;
            } else if(m.role === 'owner') roleDisplay = `<span class="text-[11px] text-notion-blue font-bold uppercase tracking-wider">Owner</span>`;
            d.innerHTML += `<div class="flex justify-between items-center p-2.5 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-100 transition-all group"><div class="flex items-center gap-3"><img src="https://api.dicebear.com/9.x/lorelei/svg?seed=${m.email}" class="w-8 h-8 rounded-full bg-white border border-gray-200"><div class="flex flex-col"><span class="text-sm font-semibold text-notion-text">${m.email}</span>${roleDisplay}</div></div>${actions}</div>`; 
        });
    }
    document.getElementById('btn-send-invite').addEventListener('click', async()=>{
        const email = document.getElementById('invite-email').value; const role = document.getElementById('invite-role').value; if(!email) return;
        const ref = doc(db, "projects", currentProjectId); const snap = await getDoc(ref);
        if(snap.exists() && !snap.data().access.find(a=>a.email===email)) {
            await updateDoc(ref, { memberEmails: arrayUnion(email), access: arrayUnion({email, role}) });
            notify(`Invited ${email}`, 'success'); 
            const usersQ = query(collection(db, "users"), where("email", "==", email)); const userSnap = await getDocs(usersQ);
            if(!userSnap.empty) { userSnap.forEach(async (u) => { await addDoc(collection(db, `users/${u.id}/notifications`), { title: "Project Invitation", text: `You were invited to join <strong>${snap.data().title || "a project"}</strong> as ${role}.`, timestamp: serverTimestamp(), read: false }); }); }
            document.getElementById('invite-email').value = '';
        } else { notify("User already exists or error", "error"); }
    });
    window.updateMemberRole = async (email, newRole) => {
        const ref = doc(db, "projects", currentProjectId); const snap = await getDoc(ref); if(!snap.exists()) return;
        let access = snap.data().access; access = access.map(m => m.email === email ? { ...m, role: newRole } : m);
        await updateDoc(ref, { access }); notify(`Updated ${email} to ${newRole}`, 'success');
    };
    window.removeMember = async (email, pid) => {
        if(!pid) pid = currentProjectId;
        if(!confirm(`Remove/Leave ${email}?`)) return;
        const ref = doc(db, "projects", pid); const snap = await getDoc(ref);
        const access = snap.data().access.filter(a=>a.email!==email); const emails = snap.data().memberEmails.filter(e=>e!==email);
        await updateDoc(ref, {access, memberEmails: emails}); 
        if(email === currentUser.email) { window.location.href = "home.html"; } 
        else { notify("Member removed"); }
    }

</script>
</body>
</html>
