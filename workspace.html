<!DOCTYPE html>
<html lang="en" class="transition-colors duration-200">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLink - Workspace</title>
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Initialize Dark Mode immediately to prevent flash
      if (localStorage.getItem('darkMode') === 'true') {
          document.documentElement.classList.add('dark');
      }

      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              notion: {
                bg: '#FFFFFF',
                sidebar: '#F7F7F5',
                hover: '#EFEFEF',
                border: '#E9E9E7',
                text: '#37352F',
                textLight: '#9B9A97',
                blue: '#2383E2',
                // Dark mode palette
                dark: {
                    bg: '#191919',
                    sidebar: '#202020',
                    hover: '#2C2C2C',
                    border: '#2F2F2F',
                    text: '#D4D4D4',
                    textLight: '#9B9A97'
                }
              }
            },
            boxShadow: {
                'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                'popover': '0 4px 12px -2px rgba(0, 0, 0, 0.12), 0 2px 6px -1px rgba(0, 0, 0, 0.08)',
                'menu': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0,0,0,0.05)'
            },
            keyframes: {
                slideIn: {
                    '0%': { transform: 'translateX(100%)', opacity: '0' },
                    '100%': { transform: 'translateX(0)', opacity: '1' }
                },
                popIn: {
                    '0%': { transform: 'scale(0.95)', opacity: '0' },
                    '100%': { transform: 'scale(1)', opacity: '1' }
                },
                shake: {
                    '0%, 100%': { transform: 'translateX(0)' },
                    '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-2px)' },
                    '20%, 40%, 60%, 80%': { transform: 'translateX(2px)' }
                }
            },
            animation: {
                slideIn: 'slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                popIn: 'popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)',
                shake: 'shake 0.5s ease-in-out'
            }
          }
        }
      }
    </script>
    <style>
        body { background-color: #FFFFFF; color: #37352F; height: 100vh; overflow: hidden; }
        
        html.dark body { background-color: #191919; color: #D4D4D4; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .tab-active { border-bottom: 2px solid #37352F; color: #37352F; font-weight: 600; }
        html.dark .tab-active { border-bottom: 2px solid #D4D4D4; color: #D4D4D4; }
        
        .tab-inactive { color: #9B9A97; }
        .tab-inactive:hover { color: #37352F; }
        html.dark .tab-inactive:hover { color: #D4D4D4; }

        .ai-shimmer {
            background: linear-gradient(90deg, #2383E2, #9D34DA, #2383E2);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            animation: shimmer 3s linear infinite;
        }
        @keyframes shimmer { to { background-position: 200% center; } }
        
        .chat-content a, #doc-content a { 
            color: #2383E2; 
            text-decoration: underline; 
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
            font-weight: 500;
            transition: all 0.2s ease;
            padding: 0 2px;
            border-radius: 2px;
            cursor: pointer;
        }
        .chat-content a:hover, #doc-content a:hover {
            color: #1a6cb8;
            background-color: rgba(35, 131, 226, 0.1);
        }
        
        #doc-content:empty:before {
            content: attr(placeholder);
            color: #9ca3af;
            pointer-events: none;
        }
        
        .mention-highlight {
            background-color: rgba(245, 166, 35, 0.2);
            color: #d97706;
            font-weight: 600;
            padding: 0 4px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .remote-cursor {
            position: absolute;
            width: 2px;
            height: 1.2em;
            background-color: var(--cursor-color, #2383E2);
            pointer-events: none;
            transition: all 0.1s ease;
            z-index: 20;
        }
        .remote-cursor-label {
            position: absolute;
            top: -1.4em;
            left: -2px;
            background-color: var(--cursor-color, #2383E2);
            color: white;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
            font-weight: 600;
        }

        .folder-arrow { transition: transform 0.2s; }
        .folder-open .folder-arrow { transform: rotate(90deg); }
        .folder-content { display: none; }
        .folder-open .folder-content { display: block; }

        .sidebar-item .item-actions { opacity: 0; transition: opacity 0.2s; }
        .sidebar-item:hover .item-actions { opacity: 1; }
        
        .chat-row .chat-actions { 
            opacity: 0; 
            transition: all 0.2s ease; 
            pointer-events: none; 
            transform: scale(0.9); 
        }
        .chat-row:hover .chat-actions, .chat-row.actions-open .chat-actions { 
            opacity: 1; 
            pointer-events: auto; 
            transform: scale(1); 
        }

        .reminder-item .reminder-actions { opacity: 0; transition: opacity 0.2s; }
        .reminder-item:hover .reminder-actions { opacity: 1; }

        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.4rem center; background-size: 1em; padding-right: 2rem; }

        /* Custom Toggle Switch */
        .toggle-switch {
            width: 40px;
            height: 22px;
            background-color: #E5E7EB;
            border-radius: 9999px;
            position: relative;
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
        }
        html.dark .toggle-switch {
            background-color: #4B5563;
        }
        .toggle-switch.active {
            background-color: #2383E2;
        }
        .toggle-dot {
            width: 18px;
            height: 18px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .toggle-switch.active .toggle-dot {
            transform: translateX(18px);
        }
    </style>
</head>
<body class="flex flex-col text-[15px] h-full">

    <div id="notification-toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none w-80"></div>
    <div id="sidebar-context-menu" class="fixed hidden bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] shadow-popover rounded-lg py-1 z-[150] w-48 text-sm dark:text-[#D4D4D4]"></div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="fixed inset-0 bg-white dark:bg-[#191919] z-[200] flex flex-col items-center justify-center">
        <div class="mb-8 p-4 bg-gray-50 dark:bg-[#262626] rounded-full">
            <div class="text-6xl">ðŸŽ“</div>
        </div>
        <h1 class="text-3xl font-bold mb-2 text-notion-text dark:text-[#D4D4D4]">EduLink Workspace</h1>
        <p class="text-gray-500 mb-8 dark:text-[#9B9A97]">Sign in to access your projects</p>
        <button id="btn-login" class="px-6 py-3 bg-notion-blue text-white font-medium rounded-lg hover:bg-blue-600 transition-colors shadow-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"/></svg>
            Sign in with Google
        </button>
    </div>

    <!-- MAIN APP CONTAINER (Hidden until login) -->
    <div id="app-container" class="flex h-full hidden">
        <!-- SIDEBAR -->
        <div class="w-[260px] bg-notion-sidebar dark:bg-notion-dark-sidebar border-r border-notion-border dark:border-notion-dark-border flex flex-col h-full flex-shrink-0 transition-all duration-300">
            <!-- User Profile -->
            <div class="h-14 flex items-center px-3 hover:bg-notion-hover dark:hover:bg-notion-dark-hover cursor-pointer m-2 rounded-md transition-colors group relative">
                <img id="user-avatar" src="" class="w-8 h-8 rounded-full bg-white object-cover mr-3 shadow-sm border border-gray-200 dark:border-[#2F2F2F]">
                <span id="user-name" class="font-medium truncate flex-1 text-notion-text dark:text-[#D4D4D4]">Loading...</span>
                <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity absolute right-2 bg-notion-hover dark:bg-notion-dark-hover pl-2 shadow-sm rounded-lg border border-gray-200/50 dark:border-[#2F2F2F]">
                    <button id="btn-settings" class="p-1.5 hover:bg-white dark:hover:bg-[#2C2C2C] rounded-md text-gray-500 dark:text-[#9B9A97] hover:text-notion-text dark:hover:text-[#D4D4D4] transition-colors" title="Settings">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                    <button id="btn-logout" class="p-1.5 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-md text-gray-400 dark:text-[#9B9A97] hover:text-red-500 dark:hover:text-red-400 transition-colors" title="Sign Out">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                    </button>
                </div>
            </div>

            <div class="px-4 py-3 text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] flex justify-between items-center group tracking-wide mt-2">
                <span>WORKSPACE</span>
                <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button id="trigger-create-folder" class="hover:bg-gray-200 dark:hover:bg-[#2C2C2C] rounded p-1" title="New Folder"><svg class="w-3.5 h-3.5 text-gray-600 dark:text-[#9B9A97]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg></button>
                    <button id="trigger-create-project" class="hover:bg-gray-200 dark:hover:bg-[#2C2C2C] rounded p-1" title="New Project"><svg class="w-3.5 h-3.5 text-gray-600 dark:text-[#9B9A97]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg></button>
                </div>
            </div>
            <div id="project-list" class="flex-shrink-0 overflow-y-auto px-2 space-y-1 no-scrollbar max-h-[40vh]"></div>

            <div class="px-4 py-3 text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] flex justify-between items-center group tracking-wide mt-4 border-t border-gray-200/50 dark:border-[#2F2F2F] pt-4">
                <span>TEAMS</span>
                <button id="trigger-create-team" class="hover:bg-gray-200 dark:hover:bg-[#2C2C2C] rounded p-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Create Team">
                    <svg class="w-4 h-4 text-gray-600 dark:text-[#9B9A97]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                </button>
            </div>
            <div id="team-list" class="flex-1 overflow-y-auto px-2 space-y-1 no-scrollbar pb-4"></div>

            <div class="p-4 border-t border-notion-border dark:border-notion-dark-border text-notion-textLight dark:text-[#9B9A97] text-xs flex justify-center cursor-default">EduLink v4.0</div>
        </div>

        <!-- MAIN AREA -->
        <div class="flex-1 flex flex-col h-full bg-white dark:bg-notion-dark-bg relative transition-colors duration-200">
            <!-- EMPTY STATE -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-notion-dark-bg z-10 transition-colors">
                <div class="w-24 h-24 bg-gray-50 dark:bg-[#262626] rounded-full flex items-center justify-center mb-6 text-5xl shadow-sm border border-gray-100 dark:border-[#2F2F2F] animate-pulse">ðŸ‘‹</div>
                <h2 class="text-2xl font-semibold text-notion-text dark:text-[#D4D4D4]">Welcome to EduLink</h2>
                <p class="text-notion-textLight dark:text-[#9B9A97] mt-2 text-base">Select a project from the sidebar.</p>
                <button id="btn-create-empty" class="mt-8 px-6 py-3 bg-notion-blue text-white rounded-lg shadow-sm hover:bg-blue-600 transition text-sm font-medium flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                    Create New Project
                </button>
            </div>

            <!-- PROJECT WORKSPACE -->
            <div id="workspace-container" class="flex flex-col h-full hidden w-full">
                <div class="h-16 border-b border-notion-border dark:border-notion-dark-border flex items-center justify-between px-6 bg-white dark:bg-notion-dark-bg sticky top-0 z-40 transition-colors">
                    <div class="flex items-center gap-3 flex-1 min-w-0 mr-6">
                        <span class="text-2xl cursor-default select-none" id="doc-icon">ðŸ“„</span>
                        <input id="doc-title" type="text" class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] outline-none hover:bg-notion-sidebar dark:hover:bg-[#2C2C2C] px-2 py-1.5 rounded w-full max-w-md transition-colors bg-transparent placeholder-gray-400" placeholder="Untitled">
                        <div id="save-indicator" class="text-xs text-notion-textLight hidden whitespace-nowrap bg-gray-50 dark:bg-[#262626] px-2 py-1 rounded border border-gray-100 dark:border-[#2F2F2F]">Saving...</div>
                    </div>

                    <div class="flex items-center gap-3 relative">
                        <button id="btn-broadcast-create" class="hidden text-sm font-medium text-notion-text dark:text-[#D4D4D4] hover:bg-notion-sidebar dark:hover:bg-[#2C2C2C] px-4 py-2 rounded-lg transition-colors border border-gray-200 dark:border-[#2F2F2F] hover:border-gray-300 dark:hover:border-[#3F3F3F] flex items-center gap-2 animate-slideIn">
                            <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg> <span>Broadcast</span>
                        </button>
                        <button id="btn-announce-create" class="hidden text-sm font-medium text-notion-text dark:text-[#D4D4D4] hover:bg-notion-sidebar dark:hover:bg-[#2C2C2C] px-4 py-2 rounded-lg transition-colors border border-gray-200 dark:border-[#2F2F2F] hover:border-gray-300 dark:hover:border-[#3F3F3F] flex items-center gap-2 animate-slideIn">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6"/></svg> <span>Announce</span>
                        </button>

                        <button id="btn-open-share" class="text-sm font-medium text-notion-text dark:text-[#D4D4D4] hover:bg-notion-sidebar dark:hover:bg-[#2C2C2C] px-4 py-2 rounded-lg transition-colors border border-gray-200 dark:border-[#2F2F2F] hover:border-gray-300 dark:hover:border-[#3F3F3F] flex items-center gap-2">
                            <span>Share</span>
                        </button>

                        <span class="h-6 w-[1px] bg-gray-200 dark:bg-[#2F2F2F] mx-1"></span>
                        <div class="flex -space-x-3 overflow-hidden cursor-pointer hover:opacity-100 opacity-90 transition py-1 px-1" id="member-avatars" onclick="document.getElementById('share-modal').classList.remove('hidden')" title="Manage Members"></div>

                        <div class="relative">
                            <button id="btn-notifications" class="text-notion-textLight dark:text-[#9B9A97] hover:text-notion-text dark:hover:text-[#D4D4D4] p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2C] relative transition-colors">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                                <span id="notif-badge" class="absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full hidden"></span>
                            </button>
                            <div id="notification-popover" class="hidden absolute top-14 right-0 w-80 bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] shadow-popover rounded-xl z-50 flex flex-col max-h-96 animate-slideIn origin-top-right overflow-hidden">
                                <div class="px-5 py-4 border-b border-gray-100 dark:border-[#2F2F2F] flex justify-between items-center bg-gray-50/80 dark:bg-[#262626] backdrop-blur-sm">
                                    <span class="font-semibold text-xs text-gray-500 dark:text-[#9B9A97] tracking-wide">NOTIFICATIONS</span>
                                </div>
                                <div id="notification-list" class="overflow-y-auto no-scrollbar flex-1 p-0 min-h-[120px]"></div>
                            </div>
                        </div>
                        <button id="btn-toggle-sidebar" class="text-notion-textLight dark:text-[#9B9A97] hover:text-notion-text dark:hover:text-[#D4D4D4] p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2C]" title="Toggle Sidebar"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7"/></svg></button>
                    </div>
                </div>

                <!-- Editor -->
                <div class="flex flex-1 overflow-hidden relative">
                    <div class="flex-1 overflow-y-auto bg-white dark:bg-notion-dark-bg cursor-text relative no-scrollbar flex justify-center" id="editor-container" onclick="focusEditor(event)">
                        <div class="w-full max-w-[850px] py-12 px-14 min-h-full flex flex-col relative">
                            <div id="editor-toolbar" class="sticky top-0 bg-white/95 dark:bg-[#191919]/95 backdrop-blur z-30 flex gap-2 py-2 mb-6 border-b border-transparent hover:border-gray-100 dark:hover:border-[#2F2F2F] transition-colors opacity-0 hover:opacity-100 items-center">
                                <button onclick="formatDoc('bold')" class="p-1.5 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-md text-gray-600 dark:text-[#9B9A97] font-bold w-8 h-8 flex items-center justify-center text-sm border border-transparent hover:border-gray-200 dark:hover:border-[#2F2F2F]">B</button>
                                <button onclick="formatDoc('italic')" class="p-1.5 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-md text-gray-600 dark:text-[#9B9A97] italic w-8 h-8 flex items-center justify-center text-sm border border-transparent hover:border-gray-200 dark:hover:border-[#2F2F2F]">I</button>
                                <div class="w-[1px] h-4 bg-gray-200 dark:bg-[#2F2F2F] mx-1"></div>
                                <button onclick="window.openLinkModal()" class="p-1.5 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-md text-gray-600 dark:text-[#9B9A97] flex items-center gap-1.5 text-sm px-3 border border-transparent hover:border-gray-200 dark:hover:border-[#2F2F2F]"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Link</button>
                            </div>
                            <div id="ai-indicator" class="hidden fixed bottom-10 left-1/2 -translate-x-1/2 bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] shadow-xl rounded-full px-5 py-2.5 flex items-center gap-2 z-50 animate-bounce"><span class="ai-shimmer font-semibold text-sm">âœ¨ AI is writing...</span></div>
                            <div id="read-only-banner" class="hidden mb-6 p-4 bg-gray-50 dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm text-gray-500 dark:text-[#9B9A97] flex items-center gap-3"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg><span class="font-medium">View Only</span></div>
                            <div id="remote-cursors-layer" class="absolute inset-0 pointer-events-none z-10 overflow-hidden"></div>
                            <div id="doc-content" contenteditable="true" class="w-full h-full min-h-[75vh] outline-none text-[#37352F] dark:text-[#D4D4D4] leading-8 text-[17px] font-sans placeholder-gray-300 relative z-20" placeholder="Type '/' for AI commands..."></div>
                        </div>
                    </div>

                    <!-- Slash AI Menu -->
                    <div id="slash-menu" class="fixed hidden bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] rounded-xl shadow-menu z-[100] w-64 overflow-hidden animate-popIn">
                        <div id="slash-main-content">
                            <div class="px-3 py-2 text-xs font-semibold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide bg-gray-50 dark:bg-[#262626] border-b border-gray-100 dark:border-[#2F2F2F]">AI Assistant</div>
                            <div class="p-1">
                                <button onclick="window.showSlashAIInput()" class="w-full text-left px-3 py-2 text-sm text-notion-text dark:text-[#D4D4D4] hover:bg-purple-50 dark:hover:bg-purple-900/20 hover:text-purple-600 rounded-lg flex items-center gap-2.5 font-medium">
                                    <span class="ai-shimmer">âœ¨</span> Ask AI...
                                </button>
                                <div class="h-[1px] bg-gray-100 dark:bg-[#2F2F2F] my-1 mx-2"></div>
                                <button onclick="executeAICommand('Continue writing')" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-[#D4D4D4] hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg> Continue writing
                                </button>
                                <button onclick="executeAICommand('Summarize')" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-[#D4D4D4] hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7"/></svg> Summarize
                                </button>
                                <button onclick="executeAICommand('Fix grammar and spelling')" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-[#D4D4D4] hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg> Fix grammar
                                </button>
                                <button onclick="executeAICommand('Translate to Spanish')" class="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-[#D4D4D4] hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-notion-blue rounded-lg flex items-center gap-2.5">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/></svg> Translate to Spanish
                                </button>
                            </div>
                        </div>
                        <div id="slash-ai-input-container" class="hidden p-2">
                            <div class="flex items-center gap-2 bg-gray-50 dark:bg-[#262626] rounded-lg p-1.5 border border-gray-200 dark:border-[#2F2F2F]">
                                 <span class="ai-shimmer text-lg">âœ¨</span>
                                 <input id="slash-ai-custom-input" type="text" class="bg-transparent outline-none text-sm w-full text-gray-700 dark:text-[#D4D4D4]" placeholder="What should AI write?">
                            </div>
                            <div class="text-[10px] text-gray-400 mt-1 px-1">Press Enter to generate</div>
                        </div>
                    </div>

                    <div id="right-panel" class="w-[360px] border-l border-notion-border dark:border-notion-dark-border bg-white dark:bg-notion-dark-bg flex flex-col shadow-sm relative z-30 transition-all duration-300">
                        <div class="flex border-b border-notion-border dark:border-notion-dark-border h-14 items-center px-2 gap-1">
                            <button class="flex-1 h-full text-[14px] tab-active transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50 dark:hover:bg-[#2C2C2C]" data-tab="chat" title="Chat"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg></button>
                            <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50 dark:hover:bg-[#2C2C2C]" data-tab="comments" title="Comments"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z"/></svg></button>
                            <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50 dark:hover:bg-[#2C2C2C]" data-tab="calendar" title="Calendar"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></button>
                            <button class="flex-1 h-full text-[14px] tab-inactive transition-colors flex items-center justify-center gap-1.5 rounded-t-md hover:bg-gray-50 dark:hover:bg-[#2C2C2C]" data-tab="ai" title="AI"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg></button>
                        </div>

                        <div id="tab-chat" class="flex-1 flex flex-col h-full overflow-hidden relative">
                            <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar bg-[#FBFAFA] dark:bg-notion-dark-bg"></div>
                            <!-- Mention Popover -->
                            <div id="mention-suggestions" class="absolute bottom-16 left-4 bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] shadow-xl rounded-lg hidden z-50 w-48 max-h-40 overflow-y-auto no-scrollbar text-sm dark:text-[#D4D4D4]"></div>
                            
                            <div class="p-4 border-t border-notion-border dark:border-notion-dark-border bg-white dark:bg-notion-dark-bg flex flex-col gap-2 relative">
                                <select id="chat-recipient" class="text-xs p-1.5 bg-gray-50 dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] rounded outline-none text-gray-600 dark:text-[#9B9A97] mb-1 w-fit">
                                    <option value="all">Everyone</option>
                                </select>
                                <form id="chat-form" class="relative">
                                    <input id="chat-input" type="text" autocomplete="off" class="w-full text-[15px] p-3 pr-10 bg-gray-50 dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:bg-white dark:focus:bg-[#191919] focus:border-gray-300 dark:focus:border-[#3F3F3F] transition-all placeholder-gray-400 dark:placeholder-[#5A5A5A] text-notion-text dark:text-[#D4D4D4]" placeholder="Message or @mention...">
                                    <button type="submit" class="absolute right-3 top-3 text-gray-400 hover:text-notion-blue"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"/></svg></button>
                                </form>
                            </div>
                        </div>
                        <div id="tab-comments" class="flex-1 flex flex-col h-full hidden overflow-hidden">
                            <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 text-xs text-yellow-800 dark:text-yellow-200 border-b border-yellow-100 dark:border-yellow-900/30 flex justify-between items-center font-medium"><span>Discussion & Feedback</span></div>
                            <div id="comments-list" class="flex-1 overflow-y-auto p-5 space-y-3 no-scrollbar bg-white dark:bg-notion-dark-bg"></div>
                            <div class="p-4 border-t border-notion-border dark:border-notion-dark-border bg-white dark:bg-notion-dark-bg"><form id="comments-form" class="relative"><textarea id="comment-input" rows="2" class="w-full text-[15px] p-3 border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue resize-none bg-gray-50 dark:bg-[#262626] focus:bg-white dark:focus:bg-[#191919] transition-colors dark:text-[#D4D4D4]" placeholder="Add a comment..."></textarea><button type="submit" class="mt-2 w-full py-2 bg-gray-100 dark:bg-[#2C2C2C] text-xs font-semibold text-gray-600 dark:text-[#9B9A97] rounded-lg hover:bg-gray-200 dark:hover:bg-[#3F3F3F] transition-colors">Post Comment</button></form></div>
                        </div>
                        <div id="tab-calendar" class="flex-1 flex flex-col h-full hidden overflow-hidden bg-white dark:bg-notion-dark-bg">
                            <div class="p-5 border-b border-gray-100 dark:border-[#2F2F2F]"><h3 class="font-semibold text-sm mb-4 text-gray-700 dark:text-[#D4D4D4] flex items-center gap-2"><svg class="w-4 h-4 text-notion-blue" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>Add Reminder</h3><form id="reminder-form" class="space-y-3"><input id="rem-title" type="text" placeholder="Event or Task..." class="w-full p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue bg-gray-50 dark:bg-[#262626] focus:bg-white dark:focus:bg-[#191919] transition-colors dark:text-[#D4D4D4]" required><div class="flex gap-2"><input id="rem-date" type="date" class="flex-1 p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none bg-gray-50 dark:bg-[#262626] focus:bg-white dark:focus:bg-[#191919] transition-colors text-gray-500 dark:text-[#9B9A97]" required><input id="rem-time" type="time" class="flex-1 p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none bg-gray-50 dark:bg-[#262626] focus:bg-white dark:focus:bg-[#191919] transition-colors text-gray-500 dark:text-[#9B9A97]" required></div><button type="submit" class="w-full py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm transition-transform active:scale-[0.98]">Set Reminder</button></form></div>
                            <div class="flex-1 overflow-y-auto no-scrollbar p-5"><h4 class="text-[11px] font-bold text-gray-400 uppercase mb-3 tracking-wider flex justify-between">Upcoming Events</h4><div id="reminder-list" class="space-y-3"></div></div>
                        </div>
                        <div id="tab-ai" class="flex-1 flex flex-col h-full hidden overflow-hidden">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900/20 text-xs text-blue-800 dark:text-blue-200 border-b border-blue-100 dark:border-blue-900/30 leading-relaxed flex gap-2"><span class="text-xl">ðŸ¤–</span> <span><strong>AI Assistant:</strong> Ask questions about the document, summarize content, or generate ideas.</span></div>
                            <div id="ai-messages" class="flex-1 overflow-y-auto p-5 space-y-4 no-scrollbar bg-white dark:bg-notion-dark-bg"></div>
                            <div class="p-4 border-t border-notion-border dark:border-notion-dark-border bg-white dark:bg-notion-dark-bg"><form id="ai-form" class="relative"><input id="ai-input" type="text" class="w-full text-[15px] p-3 pr-10 bg-gray-50 dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-purple-300 focus:bg-white dark:focus:bg-[#191919] transition-all placeholder-gray-400 dark:placeholder-[#5A5A5A] text-notion-text dark:text-[#D4D4D4]" placeholder="Ask AI something..."><button type="submit" class="absolute right-3 top-3 text-purple-500 hover:text-purple-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button></form></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Message Context Menu -->
    <div id="msg-context-menu" class="fixed hidden bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] shadow-popover rounded-lg py-1 z-[160] w-40 text-sm overflow-hidden dark:text-[#D4D4D4]">
        <button id="btn-delete-me" class="w-full text-left px-4 py-2 hover:bg-gray-50 dark:hover:bg-[#2C2C2C] text-gray-700 dark:text-[#D4D4D4] flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>
            Hide for me
        </button>
        <button id="btn-delete-all" class="w-full text-left px-4 py-2 hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 hidden flex items-center gap-2 border-t border-gray-100 dark:border-[#2F2F2F]">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            Delete for all
        </button>
    </div>

    <div id="link-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] mb-5">Insert Link</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Text</label><input id="link-text-input" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]" placeholder="Display text"></div>
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">URL</label><input id="link-url-input" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]" placeholder="https://example.com"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="document.getElementById('link-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg font-medium transition-colors">Cancel</button><button id="btn-confirm-link" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm font-medium transition-colors">Insert Link</button></div>
        </div>
    </div>
    
    <div id="share-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[500px] overflow-hidden scale-95 transition-transform duration-200 transform">
             <div class="p-5 border-b border-gray-100 dark:border-[#2F2F2F] flex justify-between items-center bg-[#FBFBFA] dark:bg-[#262626]">
                <h3 class="font-semibold text-sm text-gray-700 dark:text-[#D4D4D4]">Share Project</h3>
                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-[#D4D4D4] p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2C]" onclick="hideModal('share-modal')"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-6 space-y-6">
                <div class="flex gap-2">
                    <input id="invite-email" type="email" placeholder="Add people by email..." class="flex-1 p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue transition-colors bg-white dark:bg-[#262626] dark:text-[#D4D4D4]">
                    <select id="invite-role" class="p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none bg-white dark:bg-[#262626] dark:text-[#D4D4D4]">
                        <option value="editor">Editor</option>
                        <option value="commenter">Commenter</option>
                        <option value="viewer">Viewer</option>
                    </select>
                    <button id="btn-send-invite" class="px-4 py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm transition-colors">Invite</button>
                </div>
                
                <div class="bg-gray-50 dark:bg-[#262626] p-3 rounded-lg border border-gray-100 dark:border-[#2F2F2F]">
                    <label class="block text-[10px] font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-2">Or Share with Team</label>
                    <div class="flex gap-2">
                        <select id="share-team-select" class="flex-1 p-2 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none bg-white dark:bg-[#202020] dark:text-[#D4D4D4]"><option value="">Select a team...</option></select>
                        <button id="btn-share-team" class="px-3 py-2 bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] text-gray-600 dark:text-[#D4D4D4] text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-[#3F3F3F] transition-colors">Add Team</button>
                    </div>
                </div>

                <div class="mt-4">
                     <div class="flex justify-between items-center mb-3">
                        <div class="text-[11px] font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide">Who has access</div>
                        <button id="btn-copy-link" class="text-xs text-notion-blue hover:underline flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Copy Link</button>
                    </div>
                    <div id="members-list" class="flex flex-col gap-2 max-h-[200px] overflow-y-auto no-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="rename-folder-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] mb-5">Rename Folder</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Name</label><input id="rename-folder-input" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="hideModal('rename-folder-modal')" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-rename-folder" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Save</button></div>
        </div>
    </div>

    <div id="share-folder-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[500px] overflow-hidden scale-95 transition-transform duration-200 transform">
             <div class="p-5 border-b border-gray-100 dark:border-[#2F2F2F] flex justify-between items-center bg-[#FBFBFA] dark:bg-[#262626]">
                <h3 class="font-semibold text-sm text-gray-700 dark:text-[#D4D4D4]">Share Folder</h3>
                <button class="text-gray-400 hover:text-gray-600 dark:hover:text-[#D4D4D4] p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-[#2C2C2C]" onclick="hideModal('share-folder-modal')"><svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg></button>
            </div>
            <div class="p-6 space-y-6">
                <p class="text-xs text-gray-500 dark:text-[#9B9A97] mb-4">Sharing will grant access to all projects inside this folder.</p>
                <div class="flex gap-2">
                    <input id="folder-share-email" type="email" placeholder="Add people by email..." class="flex-1 p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue transition-colors bg-white dark:bg-[#262626] dark:text-[#D4D4D4]">
                    <button id="btn-confirm-folder-share" class="px-4 py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm transition-colors">Invite</button>
                </div>
                
                <div class="bg-gray-50 dark:bg-[#262626] p-3 rounded-lg border border-gray-100 dark:border-[#2F2F2F]">
                    <label class="block text-[10px] font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-2">Or Share with Team</label>
                    <div class="flex gap-2">
                        <select id="folder-share-team-select" class="flex-1 p-2 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none bg-white dark:bg-[#202020] dark:text-[#D4D4D4]"><option value="">Select a team...</option></select>
                        <button id="btn-folder-share-team" class="px-3 py-2 bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] text-gray-600 dark:text-[#D4D4D4] text-sm font-medium rounded-lg hover:bg-gray-100 dark:hover:bg-[#3F3F3F] transition-colors">Add Team</button>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="text-[11px] font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-3">Who has access</div>
                    <div id="folder-members-list" class="flex flex-col gap-2 max-h-[200px] overflow-y-auto no-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="broadcast-compose-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[480px] p-6 scale-95 transition-transform duration-200 transform">
            <div class="flex items-center gap-2 mb-4 text-notion-text dark:text-[#D4D4D4]">
                <svg id="bc-icon" class="w-6 h-6 text-gray-600 dark:text-[#9B9A97]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6"/></svg>
                <h3 class="text-lg font-bold" id="bc-modal-title">Announcement</h3>
            </div>
            <p class="text-sm text-gray-500 dark:text-[#9B9A97] mb-4">Send a message to project members.</p>
            
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 dark:text-[#9B9A97] uppercase tracking-wide mb-2">Recipients</label>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 text-sm cursor-pointer dark:text-[#D4D4D4]"><input type="radio" name="bc-recipient" value="all" checked class="text-notion-blue" onchange="toggleBcList(false)"> All Members</label>
                    <label class="flex items-center gap-2 text-sm cursor-pointer dark:text-[#D4D4D4]"><input type="radio" name="bc-recipient" value="specific" class="text-notion-blue" onchange="toggleBcList(true)"> Specific Users</label>
                </div>
                <div id="bc-user-list" class="mt-2 hidden p-2 border border-gray-200 dark:border-[#2F2F2F] rounded max-h-32 overflow-y-auto bg-gray-50 dark:bg-[#262626] no-scrollbar dark:text-[#D4D4D4]"></div>
            </div>

            <textarea id="broadcast-input" rows="3" class="w-full p-3 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-gray-50 dark:bg-[#262626] focus:bg-white dark:focus:bg-[#191919] transition-colors resize-none dark:text-[#D4D4D4]" placeholder="Type your announcement..."></textarea>
            <div class="flex justify-end gap-3 mt-6"><button onclick="document.getElementById('broadcast-compose-modal').classList.add('hidden')" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg font-medium transition-colors">Cancel</button><button id="btn-send-broadcast" class="px-4 py-2 text-sm bg-notion-text dark:bg-white text-white dark:text-black rounded-lg hover:bg-black dark:hover:bg-gray-200 shadow-sm font-medium transition-colors">Send</button></div>
        </div>
    </div>

    <div id="broadcast-receive-overlay" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center backdrop-blur-md animate-slideIn">
        <div class="bg-white dark:bg-[#202020] rounded-2xl shadow-2xl w-[500px] p-8 text-center relative animate-popIn">
            <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-notion-blue"><svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg></div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-[#D4D4D4] mb-2">Announcement</h2>
            <div class="w-12 h-1 bg-notion-blue rounded-full mx-auto mb-6"></div>
            <p id="broadcast-message-text" class="text-lg text-gray-600 dark:text-[#9B9A97] leading-relaxed mb-8">...</p>
            <button onclick="document.getElementById('broadcast-receive-overlay').classList.add('hidden')" class="px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-black rounded-xl font-medium hover:bg-black dark:hover:bg-gray-200 transition-colors shadow-lg">Got it</button>
        </div>
    </div>

    <div id="reminder-overlay" class="fixed inset-0 bg-black/60 z-[200] hidden flex items-center justify-center backdrop-blur-md animate-slideIn">
        <div class="bg-white dark:bg-[#202020] rounded-2xl shadow-2xl w-[400px] p-8 text-center relative animate-popIn animate-shake">
            <div class="w-16 h-16 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-500"><svg class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-[#D4D4D4] mb-2">Reminder!</h2>
            <p id="reminder-overlay-text" class="text-lg text-gray-600 dark:text-[#9B9A97] leading-relaxed mb-8">...</p>
            <button onclick="document.getElementById('reminder-overlay').classList.add('hidden')" class="px-8 py-3 bg-gray-900 dark:bg-white text-white dark:text-black rounded-xl font-medium hover:bg-black dark:hover:bg-gray-200 transition-colors shadow-lg">Dismiss</button>
        </div>
    </div>

    <div id="create-folder-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[380px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] mb-5">Create Folder</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Folder Name</label><input id="new-folder-name" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]" placeholder="e.g. Science Projects"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="hideModal('create-folder-modal')" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-folder" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create</button></div>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] mb-5">Create New Project</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Title</label><input id="new-proj-title" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue focus:ring-1 focus:ring-blue-100 dark:focus:ring-blue-900 transition-all bg-white dark:bg-[#262626] dark:text-[#D4D4D4]" placeholder="e.g. Marketing Plan Q4"></div>
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Folder</label><select id="new-proj-folder" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]"><option value="">No Folder</option></select></div>
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Initial Privacy</label><div class="flex items-center gap-3 p-3 border border-gray-200 dark:border-[#2F2F2F] rounded-lg bg-gray-50 dark:bg-[#262626]"><input type="checkbox" id="new-proj-private" class="w-4 h-4 rounded text-notion-blue focus:ring-offset-0 focus:ring-0"><span class="text-sm text-gray-700 dark:text-[#D4D4D4] font-medium">Private (Invite only)</span></div></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button id="btn-cancel-create" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-create" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create Project</button></div>
        </div>
    </div>
    
    <div id="create-team-modal" class="fixed inset-0 bg-black/40 z-[80] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform">
            <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4] mb-5">Create New Team</h3>
            <div class="space-y-5">
                <div><label class="block text-xs font-semibold text-notion-textLight dark:text-[#9B9A97] mb-1.5 uppercase tracking-wide">Team Name</label><input id="new-team-name" type="text" class="w-full p-2.5 border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]" placeholder="e.g. Engineering"></div>
            </div>
            <div class="flex justify-end gap-3 mt-8"><button onclick="hideModal('create-team-modal')" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg transition-colors font-medium">Cancel</button><button id="btn-confirm-team" class="px-4 py-2 text-sm bg-notion-blue text-white rounded-lg hover:bg-blue-600 shadow-sm transition-colors font-medium">Create Team</button></div>
        </div>
    </div>

    <div id="manage-team-modal" class="fixed inset-0 bg-black/40 z-[85] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[480px] p-6 scale-95 transition-transform duration-200 transform">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-notion-text dark:text-[#D4D4D4]" id="manage-team-title">Manage Team</h3>
                <button onclick="hideModal('manage-team-modal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-[#D4D4D4]">&times;</button>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-1">Team Name</label>
                        <input id="edit-team-name" type="text" class="w-full p-2 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]">
                    </div>
                    <button id="btn-update-team-name" class="px-3 py-2 bg-gray-100 dark:bg-[#2C2C2C] text-gray-600 dark:text-[#D4D4D4] text-xs rounded hover:bg-gray-200 dark:hover:bg-[#3F3F3F] h-[38px]">Update</button>
                </div>
                <div class="flex gap-2 items-end">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-1">Team Logo</label>
                        <div class="flex gap-2">
                            <input id="edit-team-logo-file" type="file" accept="image/*" class="flex-1 p-2 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4] file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                            <div id="team-logo-preview" class="w-10 h-10 rounded-lg border border-gray-200 dark:border-[#2F2F2F] bg-white dark:bg-[#262626] flex-shrink-0 flex items-center justify-center overflow-hidden p-1"></div>
                        </div>
                    </div>
                    <button id="btn-update-team-logo" class="px-3 py-2 bg-gray-100 dark:bg-[#2C2C2C] text-gray-600 dark:text-[#D4D4D4] text-xs rounded hover:bg-gray-200 dark:hover:bg-[#3F3F3F] h-[42px]">Upload & Save</button>
                </div>
            </div>
            
            <div class="flex gap-2 mb-6">
                <input id="team-invite-email" type="email" placeholder="Invite member by email..." class="flex-1 p-2.5 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4]">
                <button id="btn-team-invite" class="px-4 py-2 bg-notion-blue text-white text-sm font-medium rounded-lg hover:bg-blue-600 shadow-sm">Invite</button>
            </div>

            <div>
                <div class="text-[11px] font-bold text-gray-400 dark:text-[#9B9A97] uppercase tracking-wide mb-3">Members</div>
                <div id="team-members-list" class="flex flex-col gap-2 max-h-[150px] overflow-y-auto no-scrollbar bg-gray-50 dark:bg-[#262626] rounded-lg p-2 min-h-[80px]"></div>
            </div>

            <!-- Danger Zone for Team Actions -->
            <div id="team-danger-zone" class="mt-6 pt-4 border-t border-gray-100 dark:border-[#2F2F2F]"></div>
        </div>
    </div>

    <!-- PROFILE MODAL UPDATED DESIGN -->
    <div id="profile-modal" class="fixed inset-0 bg-black/40 z-[95] hidden flex items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-200">
        <div class="bg-white dark:bg-[#202020] rounded-xl shadow-modal w-[420px] p-6 scale-95 transition-transform duration-200 transform overflow-hidden">
            <div class="border-b border-gray-100 dark:border-[#2F2F2F] pb-4 mb-5">
                <h3 class="text-xl font-bold text-notion-text dark:text-[#D4D4D4]">Settings</h3>
            </div>
            
            <div class="space-y-6">
                <!-- My Profile Section -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-[#6B6B6B] uppercase tracking-wider mb-4">My Profile</h4>
                    <div class="flex items-center gap-4">
                        <img id="edit-profile-preview" src="" class="w-14 h-14 rounded-full border-2 border-gray-100 dark:border-[#2F2F2F] object-cover shadow-sm bg-gray-50 dark:bg-[#262626]">
                        <div class="flex-1">
                            <label class="block text-[11px] font-semibold text-gray-500 dark:text-[#9B9A97] uppercase mb-1">Display Name</label>
                            <input id="edit-display-name" type="text" class="w-full bg-transparent border-b border-gray-200 dark:border-[#2F2F2F] py-1.5 text-sm outline-none focus:border-notion-blue transition-colors text-notion-text dark:text-[#D4D4D4] placeholder-gray-300" placeholder="Your Name">
                        </div>
                    </div>
                </div>

                <!-- Workspace & Appearance Section -->
                <div>
                    <h4 class="text-xs font-bold text-gray-400 dark:text-[#6B6B6B] uppercase tracking-wider mb-4 mt-2">Workspace & Appearance</h4>
                    
                    <!-- Dark Mode Toggle -->
                    <div class="flex items-center justify-between py-2 mb-3">
                        <div class="flex items-center gap-2.5">
                            <div class="p-1.5 bg-gray-100 dark:bg-[#2C2C2C] rounded-md text-gray-500 dark:text-[#9B9A97]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
                            </div>
                            <span class="text-sm font-medium text-notion-text dark:text-[#D4D4D4]">Dark Mode</span>
                        </div>
                        <div id="dark-mode-toggle" class="toggle-switch" onclick="window.toggleDarkMode()">
                            <div class="toggle-dot"></div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-[11px] font-semibold text-gray-500 dark:text-[#9B9A97] uppercase mb-1.5">Workspace Name</label>
                            <input id="edit-app-title" type="text" class="w-full p-2.5 bg-gray-50 dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] rounded-lg text-sm outline-none focus:border-notion-blue focus:bg-white dark:focus:bg-[#191919] transition-all text-notion-text dark:text-[#D4D4D4]" placeholder="EduLink Workspace">
                        </div>
                        <div>
                            <label class="block text-[11px] font-semibold text-gray-500 dark:text-[#9B9A97] uppercase mb-1.5">Favicon</label>
                            <div class="flex gap-2">
                                <input id="edit-app-favicon-file" type="file" accept="image/*" class="flex-1 p-2 text-sm border border-gray-200 dark:border-[#2F2F2F] rounded-lg outline-none focus:border-notion-blue bg-white dark:bg-[#262626] dark:text-[#D4D4D4] file:mr-4 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                                <div id="favicon-preview" class="w-10 h-10 rounded-lg border border-gray-200 dark:border-[#2F2F2F] bg-white dark:bg-[#262626] flex-shrink-0 flex items-center justify-center overflow-hidden p-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-gray-100 dark:border-[#2F2F2F]">
                <button id="btn-cancel-profile" class="px-4 py-2 text-sm text-gray-500 dark:text-[#9B9A97] hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded-lg font-medium transition-colors">Cancel</button>
                <button id="btn-save-profile" class="px-4 py-2 text-sm bg-notion-text dark:bg-white text-white dark:text-black rounded-lg hover:bg-black dark:hover:bg-gray-200 shadow-sm font-medium transition-colors">Save Changes</button>
            </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, updateProfile, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, orderBy, serverTimestamp, getDoc, setDoc, deleteDoc, getDocs, or } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
        authDomain: "edulinki.firebaseapp.com",
        projectId: "edulinki",
        storageBucket: "edulinki.firebasestorage.app",
        messagingSenderId: "248886466474",
        appId: "1:248886466474:web:160043201a6b28bafbbdd3",
        measurementId: "G-MQBH12VL7N"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentProjectId = null;
    let currentRole = 'editor'; 
    let unsubscribeDoc, unsubscribeChat, unsubscribeReminders, unsubscribeComments, unsubscribeNotifs, unsubscribePresence, unsubscribeFolders, unsubscribeProjects;
    
    // Define Random Color for Presence
    const myColor = '#' + Math.floor(Math.random()*16777215).toString(16);

    // Global State & Caches
    let initialLoad = true;
    let debounceTimer;
    let activeReminders = [];
    let notifiedReminders = new Set();
    let userAvatarCache = {}; // Cache email -> photoURL
    let mentionableUsers = new Set();
    let currentSelectionRange = null;
    let pendingFavicon = null;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    let lastRenderedAccess = null;
    let myFolders = [];
    let myTeams = [];

    // --- GLOBAL HELPERS ---
    window.showModal = (id) => { const m = document.getElementById(id); m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95'); }, 10); }
    window.hideModal = (id) => { const m = document.getElementById(id); m.classList.add('opacity-0'); m.children[0].classList.add('scale-95'); setTimeout(() => m.classList.add('hidden'), 200); }
    window.toggleBcList = (show) => { document.getElementById('bc-user-list').style.display = show ? 'block' : 'none'; }
    window.playSound = () => { const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); audio.volume = 0.5; audio.play().catch(e=>{}); }
    
    // Initialize Dark Mode Toggle UI
    if(isDarkMode) document.getElementById('dark-mode-toggle')?.classList.add('active');

    window.toggleDarkMode = () => {
        isDarkMode = !isDarkMode;
        localStorage.setItem('darkMode', isDarkMode);
        applyDarkMode();
    }

    function applyDarkMode() {
        const html = document.documentElement;
        const toggle = document.getElementById('dark-mode-toggle');
        
        if(isDarkMode) {
            html.classList.add('dark');
            if(toggle) toggle.classList.add('active');
        } else {
            html.classList.remove('dark');
            if(toggle) toggle.classList.remove('active');
        }
    }

    // New Helper: Robust Image Upload to ImgHippo
    async function uploadImage(file) {
        const formData = new FormData();
        formData.append('api_key', 'd28bf3c492ad07b53dc4e3f9ce99b072');
        formData.append('file', file);

        try {
            const response = await fetch('https://api.imghippo.com/v1/upload', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                // Fallback or specific error handling
                console.error("Upload failed", response.status);
                throw new Error("API Upload Failed");
            }

            const data = await response.json();
            if(data.success) {
                return data.data.url;
            } else {
                throw new Error(data.message || "Upload failed");
            }
        } catch (error) {
            console.error("Upload Error:", error);
            notify("Image upload failed. Browser security may be blocking this API.", "error");
            return null;
        }
    }

    function linkify(text) {
        const urlRegex = /((https?:\/\/|www\.)[^\s]+)/g;
        return text.replace(urlRegex, (url) => {
            let href = url; if (!href.startsWith('http')) href = 'http://' + href;
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
    }

    function notify(msg, type='info') {
        const container = document.getElementById('notification-toast-container');
        const el = document.createElement('div');
        let icon = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
        if(type==='invite') icon = `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>`;
        if(type==='success') icon = `<svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
        if(type==='error') icon = `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`;
        
        el.className = "bg-white dark:bg-[#202020] border border-gray-200 dark:border-[#2F2F2F] text-notion-text dark:text-[#D4D4D4] text-sm p-4 rounded-xl shadow-xl animate-slideIn pointer-events-auto flex items-start gap-4 w-full";
        el.innerHTML = `<div class="mt-0.5 flex-shrink-0 text-notion-blue">${icon}</div><div class="flex-1"><div class="font-semibold text-gray-800 dark:text-[#D4D4D4]">${type === 'invite' ? 'New Invitation' : (type === 'success' ? 'Success' : (type === 'error' ? 'Error' : 'Notification'))}</div><div class="text-xs text-gray-500 dark:text-[#9B9A97] mt-1 leading-relaxed">${msg}</div></div>`;
        container.appendChild(el);
        setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateX(100%)'; setTimeout(() => el.remove(), 300); }, 6000);
    }

    // Improved Avatar Resolver with Caching
    async function resolveAvatar(email) {
        if (!email) return `https://api.dicebear.com/9.x/lorelei/svg?seed=unknown`;
        
        // 1. Check local cache
        if (userAvatarCache[email]) return userAvatarCache[email];
        
        // 2. Fetch from DB
        try {
            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);
            if (!snap.empty) {
                const uData = snap.docs[0].data();
                if (uData.photoURL && !uData.photoURL.includes('dicebear')) {
                    userAvatarCache[email] = uData.photoURL;
                    return uData.photoURL;
                }
            }
        } catch (e) {
            console.warn("Avatar fetch failed for", email);
        }

        // 3. Fallback
        const fallback = `https://api.dicebear.com/9.x/lorelei/svg?seed=${email}`;
        userAvatarCache[email] = fallback; // Cache fallback to avoid repeated fetches
        return fallback;
    }

    function saveCursor(el) {
        const sel = window.getSelection();
        if(!sel.rangeCount) return null;
        const range = sel.getRangeAt(0);
        if(!el.contains(range.startContainer)) return null;
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(el);
        preCaretRange.setEnd(range.startContainer, range.startOffset);
        return preCaretRange.toString().length;
    }

    function restoreCursor(el, pos) {
        if(pos === null) return;
        const range = document.createRange();
        range.setStart(el, 0); range.collapse(true);
        let stack = [el], node, foundStart = false, stop = false, charIndex = 0;
        while (!stop && (node = stack.pop())) {
            if (node.nodeType === 3) {
                const nextCharIndex = charIndex + node.length;
                if (!foundStart && pos >= charIndex && pos <= nextCharIndex) {
                    range.setStart(node, pos - charIndex); range.collapse(true); foundStart = true; stop = true;
                }
                charIndex = nextCharIndex;
            } else { let i = node.childNodes.length; while (i--) stack.push(node.childNodes[i]); }
        }
        const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    }

    // --- AUTHENTICATION LOGIC ---
    document.getElementById('btn-login').addEventListener('click', async () => {
        try {
            const provider = new GoogleAuthProvider();
            await signInWithPopup(auth, provider);
        } catch (error) {
            console.error("Login failed", error);
            alert("Login failed: " + error.message);
        }
    });

    onAuthStateChanged(auth, async (user) => {
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');

        if (!user) { 
            // Show Login, Hide App
            loginScreen.classList.remove('hidden');
            appContainer.classList.add('hidden');
        } else {
            // Hide Login, Show App
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');

            try {
                currentUser = user; 
                
                const uDoc = await getDoc(doc(db, "users", user.uid));
                let uData = {};
                if(uDoc.exists()) {
                    uData = uDoc.data();
                    if(uData.appTitle) document.title = uData.appTitle;
                    if(uData.appFavicon) document.getElementById('dynamic-favicon').href = uData.appFavicon;
                    // If user has specific dark mode setting in DB, prefer that, else use local storage or default
                    if(uData.darkMode !== undefined) {
                        isDarkMode = uData.darkMode;
                        localStorage.setItem('darkMode', isDarkMode);
                        applyDarkMode();
                    }
                }

                updateUserUI(uData);
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, email: user.email, displayName: user.displayName||"", photoURL: user.photoURL||"", lastLogin: serverTimestamp() }, { merge: true });
                
                if (Notification.permission !== 'granted') { Notification.requestPermission(); }

                const urlParams = new URLSearchParams(window.location.search); 
                const pid = urlParams.get('project');
                
                loadFolders();
                loadTeams(); 
                loadUserNotifications(); 
                
                if(pid) selectProject(pid); 
                
                setInterval(checkReminders, 10000);
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('user-name').textContent = "Error Loading";
            }
        }
    });

    function updateUserUI(data = {}) {
        document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
        const avatarUrl = currentUser.photoURL && !currentUser.photoURL.includes('dicebear') ? currentUser.photoURL : `https://api.dicebear.com/9.x/lorelei/svg?seed=${currentUser.email}`;
        document.getElementById('user-avatar').src = avatarUrl;
        document.getElementById('edit-profile-preview').src = avatarUrl;
        document.getElementById('edit-display-name').value = currentUser.displayName || "";
        document.getElementById('edit-app-title').value = data.appTitle || document.title;
        if(data.appFavicon) document.getElementById('favicon-preview').innerHTML = `<img src="${data.appFavicon}" class="w-full h-full object-cover">`;
        applyDarkMode(); 
    }
    document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

    // --- FOLDERS ---
    function loadFolders() {
        if(unsubscribeFolders) unsubscribeFolders();
        const q = query(
            collection(db, "folders"), 
            or(
                where("ownerId", "==", currentUser.uid),
                where("sharedWith", "array-contains", currentUser.email)
            )
        );
        unsubscribeFolders = onSnapshot(q, (snap) => {
            myFolders = [];
            const folderSelect = document.getElementById('new-proj-folder');
            folderSelect.innerHTML = '<option value="">No Folder</option>';
            snap.forEach(d => {
                const fData = d.data();
                myFolders.push({id: d.id, ...fData});
                folderSelect.innerHTML += `<option value="${d.id}">${fData.name} ${fData.ownerId !== currentUser.uid ? '(Shared)' : ''}</option>`;
            });
            loadProjects(); 
        });
    }

    document.getElementById('trigger-create-folder').addEventListener('click', () => window.showModal('create-folder-modal'));
    document.getElementById('btn-confirm-folder').addEventListener('click', async() => {
        const name = document.getElementById('new-folder-name').value.trim();
        if(!name) return;
        await addDoc(collection(db, "folders"), { name, ownerId: currentUser.uid, sharedWith: [], createdAt: serverTimestamp() });
        window.hideModal('create-folder-modal');
        document.getElementById('new-folder-name').value = '';
    });

    // --- TEAMS LOGIC ---
    function loadTeams() {
        const q = query(collection(db, "teams"), where("members", "array-contains", currentUser.email));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('team-list'); list.innerHTML = '';
            const shareSelect = document.getElementById('share-team-select');
            shareSelect.innerHTML = '<option value="">Select a team...</option>';
            myTeams = [];

            snap.forEach(d => {
                const t = d.data();
                myTeams.push({id: d.id, ...t});
                t.members.forEach(m => mentionableUsers.add(m)); 
                
                const div = document.createElement('div');
                div.className = "group flex items-center justify-between px-3 py-2 rounded-md hover:bg-[#EFEFEF] dark:hover:bg-[#2C2C2C] transition-colors relative cursor-pointer text-notion-textLight dark:text-[#9B9A97]";

                const img = t.logo ? `<img src="${t.logo}" class="w-4 h-4 rounded-full object-cover">` : `<span class="text-base">ðŸ›¡ï¸</span>`;
                
                div.innerHTML = `
                    <div class="flex items-center gap-2.5 flex-1 min-w-0" onclick="window.openManageTeam('${d.id}')">
                        ${img} <span class="font-medium truncate text-[14px]">${t.name}</span>
                    </div>
                    <button class="opacity-0 group-hover:opacity-100 p-1 hover:bg-gray-300 dark:hover:bg-[#3F3F3F] rounded text-gray-500 dark:text-[#9B9A97] transition-opacity" onclick="window.openManageTeam('${d.id}')">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    </button>
                `;
                list.appendChild(div);

                const opt = document.createElement('option');
                opt.value = d.id; opt.textContent = t.name;
                shareSelect.appendChild(opt);
            });
        });
    }

    document.getElementById('trigger-create-team').addEventListener('click', () => window.showModal('create-team-modal'));
    document.getElementById('btn-confirm-team').addEventListener('click', async () => {
        const name = document.getElementById('new-team-name').value.trim();
        if(!name) return;
        await addDoc(collection(db, "teams"), {
            name, ownerId: currentUser.uid, members: [currentUser.email], pending: [], logo: ""
        });
        window.hideModal('create-team-modal'); notify("Team created!", "success");
    });

    let managingTeamId = null;
    window.openManageTeam = async (tid) => {
        managingTeamId = tid;
        const snap = await getDoc(doc(db, "teams", tid));
        if(!snap.exists()) return;
        const data = snap.data();

        document.getElementById('manage-team-title').textContent = `Manage ${data.name}`;
        document.getElementById('edit-team-name').value = data.name;
        document.getElementById('edit-team-logo-file').value = ""; 
        const preview = document.getElementById('team-logo-preview');
        if(data.logo) {
            preview.innerHTML = `<img src="${data.logo}" class="w-full h-full object-cover">`;
        } else {
            preview.innerHTML = '';
        }
        
        const list = document.getElementById('team-members-list'); list.innerHTML = '';
        data.members.forEach(m => {
            list.innerHTML += `<div class="flex justify-between p-2 text-sm text-gray-700 dark:text-[#D4D4D4] bg-white dark:bg-[#262626] rounded border border-gray-100 dark:border-[#2F2F2F] mb-1"><span>${m}</span>${m===currentUser.email?'<span class="text-xs text-gray-400 dark:text-[#9B9A97]">(You)</span>':''}</div>`;
        });
        if(data.pending) {
            data.pending.forEach(p => {
                 list.innerHTML += `<div class="flex justify-between p-2 text-sm text-gray-400 dark:text-[#9B9A97] bg-white dark:bg-[#262626] rounded border border-gray-100 dark:border-[#2F2F2F] border-dashed mb-1"><span>${p} (Pending)</span></div>`;
            });
        }

        const dangerZone = document.getElementById('team-danger-zone');
        dangerZone.innerHTML = '';

        if (data.ownerId === currentUser.uid) {
            dangerZone.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <span class="text-xs text-red-500 font-medium">Danger Zone</span>
                    <div class="flex gap-2">
                        <button onclick="window.leaveTeam('${tid}')" class="px-3 py-1.5 bg-gray-100 dark:bg-[#3F3F3F] text-gray-600 dark:text-gray-300 text-xs font-medium rounded hover:bg-gray-200 dark:hover:bg-[#4F4F4F] transition-colors">Leave</button>
                        <button onclick="window.deleteTeam('${tid}')" class="px-3 py-1.5 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-medium rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors border border-red-200 dark:border-red-900/30">Delete Team</button>
                    </div>
                </div>
            `;
        } else {
            dangerZone.innerHTML = `
                <div class="flex justify-between items-center w-full">
                    <span class="text-xs text-gray-400">Membership</span>
                    <button onclick="window.leaveTeam('${tid}')" class="px-3 py-1.5 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-medium rounded hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors">Leave Team</button>
                </div>
            `;
        }

        window.showModal('manage-team-modal');
    }

    window.deleteTeam = async (tid) => {
        if(confirm("Are you sure you want to delete this team? This action cannot be undone.")) {
            try {
                await deleteDoc(doc(db, "teams", tid));
                window.hideModal('manage-team-modal');
                notify("Team deleted successfully", "success");
            } catch (e) {
                console.error(e);
                notify("Error deleting team", "error");
            }
        }
    }

    window.leaveTeam = async (tid) => {
        const msg = "Are you sure you want to leave this team?";
        if(confirm(msg)) {
            try {
                await updateDoc(doc(db, "teams", tid), {
                    members: arrayRemove(currentUser.email)
                });
                window.hideModal('manage-team-modal');
                notify("You have left the team", "success");
            } catch (e) {
                console.error(e);
                notify("Error leaving team", "error");
            }
        }
    }

    document.getElementById('btn-update-team-name').addEventListener('click', async () => {
        const newName = document.getElementById('edit-team-name').value.trim();
        if(managingTeamId && newName) { await updateDoc(doc(db, "teams", managingTeamId), { name: newName }); notify("Team name updated"); }
    });
    
    document.getElementById('btn-update-team-logo').addEventListener('click', async () => {
        const fileInput = document.getElementById('edit-team-logo-file');
        const file = fileInput.files[0];
        
        if (file && managingTeamId) {
            const btn = document.getElementById('btn-update-team-logo');
            btn.textContent = "Uploading...";
            btn.disabled = true;
            
            const uploadedUrl = await uploadImage(file);
            
            if (uploadedUrl) {
                await updateDoc(doc(db, "teams", managingTeamId), { logo: uploadedUrl });
                notify("Team logo updated successfully", "success");
                fileInput.value = ""; 
                document.getElementById('team-logo-preview').innerHTML = `<img src="${uploadedUrl}" class="w-full h-full object-cover">`;
            }
            
            btn.textContent = "Upload & Save";
            btn.disabled = false;
        } else if (!file) {
            notify("Please select an image first", "error");
        }
    });

    document.getElementById('btn-team-invite').addEventListener('click', async () => {
        const email = document.getElementById('team-invite-email').value.trim();
        if(!email || !managingTeamId) return;
        const ref = doc(db, "teams", managingTeamId);
        const snap = await getDoc(ref);
        if(snap.exists() && !snap.data().members.includes(email) && (!snap.data().pending || !snap.data().pending.includes(email))) {
            await updateDoc(ref, { pending: arrayUnion(email) });
            notify(`Invite sent to ${email}`, 'success');
            const uq = query(collection(db, "users"), where("email", "==", email));
            const usnap = await getDocs(uq);
            usnap.forEach(async u => {
                 await addDoc(collection(db, `users/${u.id}/notifications`), {
                     type: 'team_invite', teamId: managingTeamId, teamName: snap.data().name, title: "Team Invitation", text: `You invited to team <strong>${snap.data().name}</strong>.`, timestamp: serverTimestamp(), read: false
                 });
            });
            document.getElementById('team-invite-email').value = '';
            window.hideModal('manage-team-modal');
        }
    });

    document.getElementById('btn-share-team').addEventListener('click', async () => {
        const teamId = document.getElementById('share-team-select').value;
        if(!teamId || !currentProjectId) return;
        const team = myTeams.find(t => t.id === teamId);
        if(team) {
            const ref = doc(db, "projects", currentProjectId);
            const pSnap = await getDoc(ref);
            let access = pSnap.data().access;
            let emails = pSnap.data().memberEmails;
            team.members.forEach(m => {
                if(!emails.includes(m)) { emails.push(m); access.push({email: m, role: 'editor'}); }
            });
            await updateDoc(ref, { memberEmails: emails, access: access });
            notify(`Shared with team ${team.name}`, 'success');
        }
    });

    // --- PROJECTS ---
    function loadProjects() {
        if(unsubscribeProjects) unsubscribeProjects(); 
        const q = query(collection(db, "projects"), where("memberEmails", "array-contains", currentUser.email));
        unsubscribeProjects = onSnapshot(q, (snap) => {
            const list = document.getElementById('project-list'); list.innerHTML = '';
            const organized = {};
            const unorganized = [];

            myFolders.forEach(f => organized[f.id] = { id: f.id, name: f.name, owner: f.ownerId, projects: [] });

            snap.forEach((doc) => {
                const p = { id: doc.id, ...doc.data() };
                p.memberEmails.forEach(e => mentionableUsers.add(e)); 
                if (p.folderId && organized[p.folderId]) {
                    organized[p.folderId].projects.push(p);
                } else {
                    unorganized.push(p);
                }
            });

            Object.values(organized).forEach(f => {
                const folderDiv = document.createElement('div');
                folderDiv.className = "mb-1";
                const isShared = f.owner !== currentUser.uid;
                folderDiv.innerHTML = `
                    <div class="px-3 py-2 text-xs font-semibold text-gray-500 dark:text-[#9B9A97] cursor-pointer hover:bg-gray-100 dark:hover:bg-[#2C2C2C] flex items-center justify-between group sidebar-item">
                        <div class="flex items-center gap-2 flex-1" onclick="this.parentElement.parentElement.classList.toggle('folder-open')">
                            <svg class="w-3 h-3 text-gray-400 folder-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            <span class="truncate">${f.name} ${isShared ? 'ðŸ‘¥' : ''}</span>
                        </div>
                        <button class="item-actions hover:bg-gray-200 dark:hover:bg-[#3F3F3F] rounded h-6 w-6 flex items-center justify-center text-gray-400" onclick="window.showFolderMenu(event, '${f.id}', ${!isShared}, '${f.name}')">â€¢â€¢â€¢</button>
                    </div>
                    <div class="folder-content pl-2 border-l border-gray-100 dark:border-[#2F2F2F] ml-4 mb-2"></div>
                `;
                const contentDiv = folderDiv.querySelector('.folder-content');
                f.projects.forEach(p => contentDiv.appendChild(createProjectEl(p)));
                list.appendChild(folderDiv);
            });

            unorganized.forEach(p => list.appendChild(createProjectEl(p)));
            
            if (currentProjectId) document.getElementById(`proj-${currentProjectId}`)?.classList.add('bg-[#EFEFEF]', 'dark:bg-[#2C2C2C]', 'text-notion-text', 'dark:text-[#D4D4D4]');
            initialLoad = false;
        });
    }

    function createProjectEl(data) {
        const div = document.createElement('div');
        div.id = `proj-${data.id}`;
        div.className = `px-3 py-2 rounded-md cursor-pointer text-[14px] flex items-center justify-between transition-colors text-notion-textLight dark:text-[#9B9A97] hover:bg-[#EFEFEF] dark:hover:bg-[#2C2C2C] hover:text-notion-text dark:hover:text-[#D4D4D4] sidebar-item group`;
        div.innerHTML = `
            <div class="flex items-center gap-2.5 truncate" onclick="window.selectProject('${data.id}')">
                <span class="opacity-80 text-base">${data.icon || "ðŸ“„"}</span> 
                <span class="truncate font-medium">${data.title}</span>
            </div>
            <button class="item-actions hover:bg-gray-300 dark:hover:bg-[#3F3F3F] rounded h-6 w-6 flex items-center justify-center text-gray-500 dark:text-[#9B9A97]" onclick="window.showProjectMenu(event, '${data.id}', ${data.ownerId === currentUser.uid}, '${data.folderId || ''}')">â€¢â€¢â€¢</button>
        `;
        return div;
    }

    // Sidebar Menu Logic
    window.showProjectMenu = (e, pid, isOwner, fid) => {
        e.stopPropagation();
        const menu = document.getElementById('sidebar-context-menu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.remove('hidden');
        
        let folderOptions = '';
        myFolders.forEach(f => {
            if(f.id !== fid && f.owner === currentUser.uid) {
                folderOptions += `<button onclick="window.moveProject('${pid}', '${f.id}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-[#2C2C2C]">Move to ${f.name}</button>`;
            }
        });
        if(fid) folderOptions += `<button onclick="window.moveProject('${pid}', null)" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] text-orange-600 dark:text-orange-400">Remove from Folder</button>`;

        let html = folderOptions;
        if(html) html += `<div class="border-t border-gray-100 dark:border-[#2F2F2F] my-1"></div>`;
        
        if(isOwner) {
            html += `<button onclick="window.deleteProject('${pid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400">Delete Project</button>`;
        } else {
            html += `<button onclick="window.leaveProject('${pid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400">Leave Project</button>`;
        }
        menu.innerHTML = html;
    };

    window.showFolderMenu = (e, fid, isOwner, name) => {
        e.stopPropagation();
        const menu = document.getElementById('sidebar-context-menu');
        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.remove('hidden');
        
        let html = '';
        if(isOwner) {
            html += `
            <button onclick="window.renameFolder('${fid}', '${name}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-[#2C2C2C]">Rename</button>
            <button onclick="window.shareFolder('${fid}')" class="w-full text-left px-3 py-2 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] text-notion-blue font-medium">Share Folder</button>
            <div class="border-t border-gray-100 dark:border-[#2F2F2F] my-1"></div>
            <button onclick="window.deleteFolder('${fid}')" class="w-full text-left px-3 py-2 hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400">Delete Folder</button>`;
        } else {
            html += `<div class="px-3 py-2 text-xs text-gray-400 dark:text-[#9B9A97] italic">Shared with you</div>`;
        }
        menu.innerHTML = html;
    };

    let sharingFolderId = null;
    window.shareFolder = async (fid) => {
        sharingFolderId = fid;
        const snap = await getDoc(doc(db, "folders", fid));
        if(!snap.exists()) return;
        const data = snap.data();
        
        const list = document.getElementById('folder-members-list');
        list.innerHTML = '';
        
        if (data.sharedWith) {
            for (const email of data.sharedWith) {
                // Async resolve avatar
                const avatarSrc = await resolveAvatar(email);
                
                // We don't have display name readily available unless we query, but we can do a quick check
                // For simplicity, using email as display name if name not cached
                let displayName = email;

                const removeBtn = data.ownerId === currentUser.uid ? 
                    `<button onclick="window.removeFolderMember('${email}')" class="text-xs text-red-400 hover:text-red-600 font-medium px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">Remove</button>` : '';

                const item = document.createElement('div');
                item.className = "flex justify-between items-center p-2.5 hover:bg-gray-50 dark:hover:bg-[#2C2C2C] rounded-lg border border-transparent hover:border-gray-100 dark:hover:border-[#2F2F2F] transition-all group";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${avatarSrc}" class="w-8 h-8 rounded-full bg-white border border-gray-200 dark:border-[#2F2F2F] object-cover">
                        <div class="flex flex-col">
                            <span class="text-sm font-semibold text-notion-text dark:text-[#D4D4D4]">${displayName}</span>
                            <span class="text-[10px] text-gray-400 dark:text-[#6B6B6B]">${email}</span>
                        </div>
                    </div>
                    ${removeBtn}
                `;
                list.appendChild(item);
            }
        }
        
        if (data.sharedWith && data.sharedWith.length === 0) {
             list.innerHTML = `<div class="text-center text-xs text-gray-400 py-2">No one else has access yet.</div>`;
        }

        const teamSelect = document.getElementById('folder-share-team-select');
        teamSelect.innerHTML = '<option value="">Select a team...</option>';
        myTeams.forEach(t => {
             teamSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });

        document.getElementById('folder-share-email').value = '';
        window.showModal('share-folder-modal');
    };

    window.removeFolderMember = async (email) => {
        if(!sharingFolderId || !confirm(`Remove ${email} from this folder?`)) return;
        await updateDoc(doc(db, "folders", sharingFolderId), {
            sharedWith: arrayRemove(email)
        });
        window.shareFolder(sharingFolderId); 
        notify(`Removed ${email} from folder`);
    };

    document.getElementById('btn-confirm-folder-share').addEventListener('click', async () => {
        const email = document.getElementById('folder-share-email').value.trim();
        if(!email || !sharingFolderId) return;

        await updateDoc(doc(db, "folders", sharingFolderId), {
            sharedWith: arrayUnion(email)
        });

        const q = query(collection(db, "projects"), where("folderId", "==", sharingFolderId));
        const snap = await getDocs(q);
        
        const updates = [];
        let count = 0;
        snap.forEach(d => {
            const data = d.data();
            if(!data.memberEmails.includes(email)) {
                updates.push(updateDoc(doc(db, "projects", d.id), {
                    memberEmails: arrayUnion(email),
                    access: arrayUnion({ email, role: 'editor' })
                }));
                count++;
            }
        });
        await Promise.all(updates);
        
        notify(`Shared folder & ${count} projects with ${email}`, 'success');
        window.shareFolder(sharingFolderId); 
    });

    document.getElementById('btn-folder-share-team').addEventListener('click', async () => {
        const teamId = document.getElementById('folder-share-team-select').value;
        if(!teamId || !sharingFolderId) return;
        
        const team = myTeams.find(t => t.id === teamId);
        if(!team) return;

        await updateDoc(doc(db, "folders", sharingFolderId), {
            sharedWith: arrayUnion(...team.members)
        });

        const q = query(collection(db, "projects"), where("folderId", "==", sharingFolderId));
        const snap = await getDocs(q);
        const updates = [];
        let projCount = 0;

        snap.forEach(d => {
            const data = d.data();
            let pAccess = data.access;
            let pEmails = data.memberEmails;
            let changed = false;

            team.members.forEach(m => {
                if(!pEmails.includes(m)) {
                    pEmails.push(m);
                    pAccess.push({ email: m, role: 'editor' });
                    changed = true;
                }
            });

            if(changed) {
                updates.push(updateDoc(doc(db, "projects", d.id), {
                    memberEmails: pEmails,
                    access: pAccess
                }));
                projCount++;
            }
        });

        await Promise.all(updates);
        notify(`Shared folder with team ${team.name}`, 'success');
        window.shareFolder(sharingFolderId); 
    });

    let renamingFolderId = null;
    window.renameFolder = (fid, currentName) => {
        renamingFolderId = fid;
        document.getElementById('rename-folder-input').value = currentName;
        window.showModal('rename-folder-modal');
    };

    document.getElementById('btn-confirm-rename-folder').addEventListener('click', async () => {
        const newName = document.getElementById('rename-folder-input').value.trim();
        if(renamingFolderId && newName) {
            await updateDoc(doc(db, "folders", renamingFolderId), { name: newName });
            notify("Folder renamed successfully");
            window.hideModal('rename-folder-modal');
        }
    });

    document.addEventListener('click', () => document.getElementById('sidebar-context-menu').classList.add('hidden'));

    window.moveProject = async (pid, fid) => { await updateDoc(doc(db, "projects", pid), { folderId: fid }); notify("Project moved"); };
    window.deleteProject = async (pid) => { if(confirm("Delete project permanently?")) { await deleteDoc(doc(db, "projects", pid)); if(currentProjectId === pid) window.location.href = "home.html"; notify("Project deleted"); } };
    window.leaveProject = async (pid) => { if(confirm("Leave this project?")) { await window.removeMember(currentUser.email, pid); notify("Left project"); } }; 
    window.deleteFolder = async (fid) => {
        if(confirm("Delete folder? Projects inside will be moved to main workspace.")) {
            const q = query(collection(db, "projects"), where("folderId", "==", fid));
            const snap = await getDocs(q);
            snap.forEach(async d => await updateDoc(doc(db, "projects", d.id), { folderId: null }));
            await deleteDoc(doc(db, "folders", fid));
            notify("Folder deleted");
        }
    };
    
    // --- MAIN NAVIGATION: PROJECTS ---

    window.selectProject = async (id) => {
        if(currentProjectId === id) return;
        document.querySelectorAll('[id^="proj-"]').forEach(d => d.classList.remove('bg-[#EFEFEF]', 'dark:bg-[#2C2C2C]', 'text-notion-text', 'dark:text-[#D4D4D4]'));
        document.getElementById(`proj-${id}`)?.classList.add('bg-[#EFEFEF]', 'dark:bg-[#2C2C2C]', 'text-notion-text', 'dark:text-[#D4D4D4]');
        
        currentProjectId = id;
        currentTeamId = null;
        lastRenderedAccess = null;

        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('workspace-container').classList.remove('hidden');
        
        const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?project=' + id;
        window.history.pushState({path:newUrl},'',newUrl);

        if(unsubscribeDoc) unsubscribeDoc();
        if(unsubscribeChat) unsubscribeChat();
        if(unsubscribeReminders) unsubscribeReminders();
        if(unsubscribeComments) unsubscribeComments();
        if(unsubscribePresence) unsubscribePresence();

        unsubscribeDoc = onSnapshot(doc(db, "projects", id), async (snap) => {
            if(!snap.exists()) return;
            const data = snap.data();
            const myAccess = data.access.find(a => a.email === currentUser.email);
            currentRole = myAccess ? myAccess.role : 'viewer';

            document.getElementById('doc-title').value = data.title;
            document.getElementById('doc-icon').textContent = data.icon || "ðŸ“„";
            const editor = document.getElementById('doc-content');
            const incomingContent = data.content || "";
            if (editor.innerHTML !== incomingContent) {
                 if(document.activeElement === editor) {
                     const cursorPos = saveCursor(editor);
                     editor.innerHTML = incomingContent;
                     restoreCursor(editor, cursorPos);
                 } else { editor.innerHTML = incomingContent; }
            }
            if(currentRole === 'viewer') { editor.setAttribute('contenteditable', 'false'); document.getElementById('read-only-banner').classList.remove('hidden'); } 
            else { editor.setAttribute('contenteditable', 'true'); document.getElementById('read-only-banner').classList.add('hidden'); }

            if (JSON.stringify(data.access) !== JSON.stringify(lastRenderedAccess)) {
                lastRenderedAccess = data.access;
                
                const recipientSelect = document.getElementById('chat-recipient');
                recipientSelect.innerHTML = '<option value="all">Everyone</option>';
                const bcList = document.getElementById('bc-user-list'); bcList.innerHTML = '';
                
                data.access.forEach(m => {
                    mentionableUsers.add(m.email);
                    if(m.email !== currentUser.email) {
                        const opt = document.createElement('option');
                        opt.value = m.email; opt.textContent = m.email.split('@')[0];
                        recipientSelect.appendChild(opt);
                        bcList.innerHTML += `<label class="flex items-center gap-2 p-1 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] rounded text-xs"><input type="checkbox" value="${m.email}" class="bc-target-user"> ${m.email}</label>`;
                    }
                });

                await renderHeaderAvatars(data.access);
                renderMembersList(data.access, data.ownerId === currentUser.uid);
                
                if(data.ownerId === currentUser.uid) {
                    document.getElementById('btn-broadcast-create').classList.remove('hidden');
                    document.getElementById('btn-announce-create').classList.add('hidden');
                } else {
                    document.getElementById('btn-broadcast-create').classList.add('hidden');
                    document.getElementById('btn-announce-create').classList.remove('hidden');
                }
            }
        });

        loadChat(id); loadComments(id); loadReminders(id); setupPresence(id);
    }

    async function renderHeaderAvatars(access) {
        const ac = document.getElementById('member-avatars'); ac.innerHTML = '';
        const membersToShow = access.slice(0, 5);
        
        for (const m of membersToShow) {
            const img = document.createElement('img');
            img.className = "w-8 h-8 rounded-full border-2 border-white dark:border-[#191919] bg-gray-100 -ml-2.5 first:ml-0 hover:z-10 relative transition-transform hover:scale-110 object-cover";
            img.title = `${m.email} (${m.role})`;
            
            // Start with resolved or placeholder
            img.src = await resolveAvatar(m.email);
            ac.appendChild(img);
        }
        
        if(access.length > 5) {
             const more = document.createElement('div');
             more.className = "w-8 h-8 rounded-full border-2 border-white dark:border-[#191919] bg-gray-100 -ml-2.5 flex items-center justify-center text-[10px] font-bold text-gray-500 relative z-0";
             more.textContent = `+${access.length - 5}`;
             ac.appendChild(more);
        }
    }

    // --- EDITOR ---
    window.formatDoc = (cmd) => { document.execCommand(cmd, false, null); document.getElementById('doc-content').focus(); };
    window.openLinkModal = () => { const sel = window.getSelection().toString(); document.getElementById('link-text-input').value = sel || "Link"; document.getElementById('link-url-input').value = ""; window.showModal('link-modal'); };
    document.getElementById('btn-confirm-link').addEventListener('click', () => {
        const text = document.getElementById('link-text-input').value; const url = document.getElementById('link-url-input').value;
        if(text && url) { document.getElementById('doc-content').focus(); document.execCommand('insertHTML', false, `<a href="${url}" target="_blank">${text}</a>`); }
        window.hideModal('link-modal');
    });

    // --- SLASH COMMANDS LOGIC ---
    const contentInput = document.getElementById('doc-content');
    const slashMenu = document.getElementById('slash-menu');
    
    contentInput.addEventListener('keyup', (e) => {
        if(e.key === '/') {
            const sel = window.getSelection();
            if(sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                
                document.getElementById('slash-main-content').classList.remove('hidden');
                document.getElementById('slash-ai-input-container').classList.add('hidden');

                slashMenu.style.left = `${rect.left}px`;
                slashMenu.style.top = `${rect.bottom + 10}px`;
                slashMenu.classList.remove('hidden');
            }
        } else {
            if(e.key === 'Escape') {
                slashMenu.classList.add('hidden');
            }
        }
    });

    window.showSlashAIInput = () => {
        document.getElementById('slash-main-content').classList.add('hidden');
        document.getElementById('slash-ai-input-container').classList.remove('hidden');
        const input = document.getElementById('slash-ai-custom-input');
        input.value = "";
        setTimeout(() => input.focus(), 50);
    }

    document.getElementById('slash-ai-custom-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = e.target.value.trim();
            if (val) executeAICommand(val);
        }
    });

    window.executeAICommand = async (command) => {
        slashMenu.classList.add('hidden');
        contentInput.focus();
        const sel = window.getSelection();
        if (sel.rangeCount) {
             document.execCommand('delete', false, null); 
        }

        document.getElementById('ai-indicator').classList.remove('hidden');
        
        const context = contentInput.innerText;
        let activeSelection = "";
        if (sel.rangeCount && !sel.isCollapsed) activeSelection = sel.toString();

        const prompt = `Act as a professional writing assistant. ${command}. ${activeSelection ? 'Focus on this text: "' + activeSelection + '"' : 'Context: ' + context.substring(0, 500)}`;
        
        try {
            const result = await fetchAI(prompt, "");
            document.execCommand('insertHTML', false, ` ${result} `);
        } catch(e) { notify("AI failed to respond", "error"); }
        document.getElementById('ai-indicator').classList.add('hidden');
    };
    
    document.addEventListener('click', (e) => {
        if(!slashMenu.contains(e.target) && e.target !== contentInput) slashMenu.classList.add('hidden');
    });

    const titleInput = document.getElementById('doc-title');
    function save() {
        if(!currentProjectId || currentRole === 'viewer') return;
        document.getElementById('save-indicator').classList.remove('hidden');
        updateDoc(doc(db, "projects", currentProjectId), { title: titleInput.value, content: contentInput.innerHTML, lastModified: serverTimestamp() }).then(() => setTimeout(() => document.getElementById('save-indicator').classList.add('hidden'), 500));
    }
    contentInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(save, 500); updateMyPresence(); });
    titleInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(save, 800); });
    
    // --- PRESENCE ---
    function setupPresence(pid) {
        const container = document.getElementById('editor-container');
        container.addEventListener('mousemove', throttle((e) => {}, 200));
        contentInput.addEventListener('keyup', updateMyPresence);
        contentInput.addEventListener('click', updateMyPresence);
        const presenceRef = collection(db, `projects/${pid}/presence`);
        unsubscribePresence = onSnapshot(presenceRef, (snap) => {
            const layer = document.getElementById('remote-cursors-layer'); layer.innerHTML = '';
            snap.forEach(d => {
                if(d.id === currentUser.uid) return;
                const p = d.data();
                if(Date.now() - p.timestamp > 30000) return; 
                const cursor = document.createElement('div'); cursor.className = 'remote-cursor'; cursor.style.left = p.x + 'px'; cursor.style.top = p.y + 'px'; cursor.style.setProperty('--cursor-color', p.color);
                const label = document.createElement('div'); label.className = 'remote-cursor-label'; label.innerText = p.name; cursor.appendChild(label);
                layer.appendChild(cursor);
            });
        });
    }
    function updateMyPresence() {
        if(!currentProjectId) return;
        const sel = window.getSelection();
        if(sel.rangeCount > 0) {
            const range = sel.getRangeAt(0); const rect = range.getBoundingClientRect(); const containerRect = document.getElementById('editor-container').getBoundingClientRect();
            const x = rect.left - containerRect.left + document.getElementById('editor-container').scrollLeft;
            const y = rect.top - containerRect.top + document.getElementById('editor-container').scrollTop;
            setDoc(doc(db, `projects/${currentProjectId}/presence`, currentUser.uid), { name: currentUser.displayName || "User", color: myColor, x: x, y: y, timestamp: Date.now() });
        }
    }
    function throttle(func, limit) { let inThrottle; return function() { const args = arguments; const context = this; if (!inThrottle) { func.apply(context, args); inThrottle = true; setTimeout(() => inThrottle = false, limit); }}}

    // --- BROADCAST & ANNOUNCE ---
    const openBroadcast = (title) => {
        document.getElementById('bc-modal-title').textContent = title;
        document.getElementById('broadcast-input').value = ""; 
        window.showModal('broadcast-compose-modal');
    }
    document.getElementById('btn-broadcast-create').addEventListener('click', () => openBroadcast('Broadcast'));
    document.getElementById('btn-announce-create').addEventListener('click', () => openBroadcast('Announcement'));

    document.getElementById('btn-send-broadcast').addEventListener('click', async () => {
        const text = document.getElementById('broadcast-input').value.trim();
        const type = document.querySelector('input[name="bc-recipient"]:checked').value;
        let recipients = [];
        
        if(type === 'specific') {
            const els = document.querySelectorAll('.bc-target-user:checked');
            recipients = Array.from(els).map(el => el.value);
        } else {
            const pDoc = await getDoc(doc(db, "projects", currentProjectId));
            if (pDoc.exists()) {
                recipients = pDoc.data().memberEmails;
            }
        }

        if(!text || recipients.length === 0) return;

        const batchPromises = recipients.map(async (email) => {
            const uq = query(collection(db, "users"), where("email", "==", email));
            const usnap = await getDocs(uq);
            usnap.forEach(async u => {
                await addDoc(collection(db, `users/${u.id}/notifications`), {
                    type: 'broadcast', 
                    text: text, 
                    senderId: currentUser.uid, 
                    timestamp: serverTimestamp(), 
                    read: false 
                });
            });
        });

        await Promise.all(batchPromises);
        window.hideModal('broadcast-compose-modal'); notify("Broadcast sent!", "success");
    });
    
    // --- TABS & SIDEBAR ---
    const tabs = document.querySelectorAll('[data-tab]'); const tabContents = { 'chat': document.getElementById('tab-chat'), 'comments': document.getElementById('tab-comments'), 'calendar': document.getElementById('tab-calendar'), 'ai': document.getElementById('tab-ai') };
    tabs.forEach(t => t.addEventListener('click', () => { tabs.forEach(x => { x.classList.remove('tab-active'); x.classList.add('tab-inactive'); }); t.classList.add('tab-active'); t.classList.remove('tab-inactive'); Object.values(tabContents).forEach(c => c.classList.add('hidden')); tabContents[t.dataset.tab].classList.remove('hidden'); }));
    document.getElementById('btn-toggle-sidebar').addEventListener('click', () => { const p = document.getElementById('right-panel'); p.style.width = p.style.width === '0px' ? '360px' : '0px'; });
    window.focusEditor = (e) => { if(currentRole!=='viewer' && e.target.id === 'editor-container') { document.getElementById('doc-content').focus(); } }

    // --- CHAT: MENTIONS & ACTIONS ---
    const chatInput = document.getElementById('chat-input');
    const mentionBox = document.getElementById('mention-suggestions');
    
    chatInput.addEventListener('input', (e) => {
        const val = e.target.value;
        const lastWord = val.split(' ').pop();
        if(lastWord.startsWith('@') && lastWord.length > 1) {
            const query = lastWord.substring(1).toLowerCase();
            const matches = Array.from(mentionableUsers).filter(m => m.toLowerCase().includes(query));
            if(matches.length > 0) {
                mentionBox.innerHTML = matches.map(m => `<div class="p-2 hover:bg-gray-100 dark:hover:bg-[#2C2C2C] cursor-pointer text-xs" onclick="window.insertMention('${m}')">${m}</div>`).join('');
                mentionBox.classList.remove('hidden');
            } else {
                mentionBox.classList.add('hidden');
            }
        } else {
            mentionBox.classList.add('hidden');
        }
    });

    window.insertMention = (email) => {
        const val = chatInput.value;
        const words = val.split(' ');
        words.pop(); 
        chatInput.value = words.join(' ') + ` @${email} `;
        mentionBox.classList.add('hidden');
        chatInput.focus();
    };

    let selectedMsgId = null;
    window.openMsgMenu = (e, mid, isSender) => {
        e.stopPropagation();
        selectedMsgId = mid;
        
        document.querySelectorAll('.chat-row').forEach(row => row.classList.remove('actions-open'));
        e.target.closest('.chat-row').classList.add('actions-open');

        const menu = document.getElementById('msg-context-menu');
        menu.style.left = (e.clientX - 140) + 'px'; 
        menu.style.top = (e.clientY + 5) + 'px';
        menu.classList.remove('hidden');
        document.getElementById('btn-delete-all').classList.toggle('hidden', !isSender);
    };
    
    document.getElementById('btn-delete-me').addEventListener('click', async () => {
        if(!selectedMsgId) return;
        await updateDoc(doc(db, `projects/${currentProjectId}/messages`, selectedMsgId), { hiddenBy: arrayUnion(currentUser.uid) });
        document.getElementById('msg-context-menu').classList.add('hidden');
    });
    document.getElementById('btn-delete-all').addEventListener('click', async () => {
        if(!selectedMsgId) return;
        await deleteDoc(doc(db, `projects/${currentProjectId}/messages`, selectedMsgId));
        document.getElementById('msg-context-menu').classList.add('hidden');
    });
    document.addEventListener('click', (e) => { 
        const menu = document.getElementById('msg-context-menu');
        if (!menu.contains(e.target) && !e.target.classList.contains('chat-actions')) {
            menu.classList.add('hidden');
            document.querySelectorAll('.chat-row').forEach(row => row.classList.remove('actions-open'));
        }
    });

    function loadChat(pid) { 
        if(unsubscribeChat) unsubscribeChat();
        unsubscribeChat = onSnapshot(query(collection(db, `projects/${pid}/messages`), orderBy("timestamp", "asc")), (snap) => { 
            const div = document.getElementById('chat-messages'); div.innerHTML = ''; 
            
            const updates = [];
            snap.forEach(d => {
                const m = d.data();
                if(m.senderId !== currentUser.uid && (!m.readBy || !m.readBy.includes(currentUser.uid))) {
                    updates.push(updateDoc(doc(db, `projects/${pid}/messages`, d.id), {
                        readBy: arrayUnion(currentUser.uid)
                    }));
                }
            });
            if(updates.length > 0) Promise.all(updates).catch(console.error);

            snap.forEach(async (d) => { 
                const m = d.data();
                if(m.hiddenBy && m.hiddenBy.includes(currentUser.uid)) return;
                
                if(m.to && m.to !== 'all') { if(m.to !== currentUser.email && m.senderId !== currentUser.uid) return; }

                const isMe = m.senderId === currentUser.uid;
                const wrap = document.createElement('div'); 
                wrap.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} group relative chat-row mb-3 px-2`; 
                
                let bubbleClass = isMe ? 'bg-[#EBF5FE] dark:bg-blue-900/40 text-notion-text dark:text-[#D4D4D4]' : 'bg-white dark:bg-[#262626] border border-gray-200 dark:border-[#2F2F2F] text-notion-text dark:text-[#D4D4D4]';
                let extraLabel = '';
                if(m.to && m.to !== 'all') { bubbleClass = 'bg-purple-50 dark:bg-purple-900/30 text-purple-900 dark:text-purple-200 border border-purple-100 dark:border-purple-900/30'; extraLabel = `<span class="text-[9px] bg-purple-200 dark:bg-purple-800 text-purple-800 dark:text-purple-100 px-1 rounded ml-1">Private</span>`; }

                let content = linkify(m.text);
                const mentionRegex = new RegExp(`@${currentUser.displayName}|@${currentUser.email}`, 'gi');
                if(!isMe && m.text.match(mentionRegex)) {
                    content = content.replace(mentionRegex, (match) => `<span class="mention-highlight">${match}</span>`);
                    const msgTime = m.timestamp ? m.timestamp.toDate() : new Date();
                    if(new Date() - msgTime < 10000) { 
                        window.playSound(); 
                        notify(`You were mentioned by ${m.senderName}`, 'info');
                    }
                }

                const menuTrigger = `<button onclick="window.openMsgMenu(event, '${d.id}', ${isMe})" class="absolute top-1/2 -translate-y-1/2 ${isMe ? 'left-0' : '-right-8'} chat-actions text-gray-300 hover:text-gray-500 p-1 text-lg leading-none rounded-full hover:bg-gray-100 dark:hover:bg-[#2C2C2C] transition-colors z-10">â‹®</button>`;

                let checkIcon = '';
                if(isMe) {
                    const readByOthers = m.readBy ? m.readBy.filter(id => id !== currentUser.uid).length > 0 : false;
                    if(readByOthers) {
                        checkIcon = `<span class="ml-1 text-blue-500 flex items-center" title="Read"><svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L7 17l-5-5"></path><path d="M22 10l-7.5 7.5L13 16"></path></svg></span>`;
                    } else {
                        checkIcon = `<span class="ml-1 text-gray-400" title="Sent"><svg class="w-3 h-3 inline-block" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></span>`;
                    }
                }

                // Async Avatar Resolution for Chat
                // We use a temporary placeholder and update it immediately
                let avatarHTML = '';
                if (!isMe) {
                    // Try immediate cache first
                    const cached = userAvatarCache[m.senderName]; // Optimistic check by name if email not available in message
                    const src = cached || `https://api.dicebear.com/9.x/lorelei/svg?seed=${m.senderName}`;
                    avatarHTML = `<img src="${src}" class="w-8 h-8 rounded-full border border-gray-100 dark:border-[#2F2F2F] bg-white self-end mb-1 mr-2 flex-shrink-0 object-cover shadow-sm avatar-chat-${d.id}">`;
                    
                    // Trigger async update if we have the user's email or can look it up
                    // Message object in previous versions only stored senderName. To get real avatar we need email/uid. 
                    // Assuming 'senderName' might be display name, we might not find it easily without senderId.
                    // IMPORTANT: We stored 'senderId' in message. We can look up User by senderId!
                    if(m.senderId) {
                        // Background fetch
                        getDoc(doc(db, "users", m.senderId)).then(snap => {
                            if(snap.exists()) {
                                const u = snap.data();
                                if(u.photoURL && !u.photoURL.includes('dicebear')) {
                                    const img = document.querySelector(`.avatar-chat-${d.id}`);
                                    if(img) img.src = u.photoURL;
                                }
                            }
                        });
                    }
                }

                wrap.innerHTML = `
                    <div class="flex items-end max-w-[85%] relative">
                        ${!isMe ? avatarHTML : ''}
                        <div class="relative group">
                            ${menuTrigger}
                            ${!isMe ? `<div class="text-[10px] text-gray-400 dark:text-[#6B6B6B] ml-1 mb-0.5">${m.senderName} ${extraLabel}</div>` : ''}
                            <div class="px-3.5 py-2.5 rounded-2xl text-[14px] ${bubbleClass} shadow-sm leading-relaxed chat-content flex items-end flex-wrap gap-1 ${isMe ? 'rounded-br-sm' : 'rounded-bl-sm'}">
                                ${content} 
                                ${checkIcon}
                            </div>
                        </div>
                    </div>
                `; 
                div.appendChild(wrap); 
            }); 
            div.scrollTop = div.scrollHeight; 
        }); 
    }
    document.getElementById('chat-form').addEventListener('submit', async(e) => { 
        e.preventDefault(); 
        const inp = document.getElementById('chat-input'); 
        const recipient = document.getElementById('chat-recipient').value;
        if(!inp.value.trim()) return; 
        addDoc(collection(db, `projects/${currentProjectId}/messages`), { 
            text: inp.value.trim(), 
            senderId: currentUser.uid, 
            senderName: currentUser.displayName||"User", 
            to: recipient,
            timestamp: serverTimestamp(),
            hiddenBy: [],
            readBy: [currentUser.uid]
        }); 
        inp.value = ''; 
    });

    function loadComments(pid) { 
        if(unsubscribeComments) unsubscribeComments();
        unsubscribeComments = onSnapshot(query(collection(db, `projects/${pid}/comments`), orderBy("timestamp", "asc")), (snap) => { const div = document.getElementById('comments-list'); div.innerHTML = ''; snap.forEach(d => { const c = d.data(); const item = document.createElement('div'); item.className = "flex gap-3 items-start p-3 bg-gray-50/80 dark:bg-[#262626] rounded-lg border border-gray-100 dark:border-[#2F2F2F] hover:bg-gray-50 dark:hover:bg-[#2C2C2C] transition-colors"; item.innerHTML = `<img src="https://api.dicebear.com/9.x/lorelei/svg?seed=${c.senderEmail}" class="w-6 h-6 rounded-full mt-1 border border-black/5 dark:border-white/10"><div class="flex-1 min-w-0"><div class="flex justify-between items-center"><span class="text-[12px] font-bold text-gray-800 dark:text-[#D4D4D4]">${c.senderName}</span><span class="text-[10px] text-gray-400 dark:text-[#6B6B6B]">${c.timestamp?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ''}</span></div><div class="text-[14px] text-notion-text dark:text-[#D4D4D4] mt-1 chat-content break-words">${linkify(c.text)}</div></div>`; div.appendChild(item); }); div.scrollTop = div.scrollHeight; }); 
    }
    document.getElementById('comments-form').addEventListener('submit', async (e) => { e.preventDefault(); const inp = document.getElementById('comment-input'); if(!inp.value.trim()) return; addDoc(collection(db, `projects/${currentProjectId}/comments`), { text: inp.value.trim(), senderId: currentUser.uid, senderEmail: currentUser.email, senderName: currentUser.displayName||"User", timestamp: serverTimestamp() }); inp.value = ''; });
    
    // --- REMINDERS WITH OVERLAY & SYSTEM NOTIFICATION ---
    function loadReminders(pid) { 
        if(unsubscribeReminders) unsubscribeReminders();
        unsubscribeReminders = onSnapshot(query(collection(db, `projects/${pid}/reminders`), orderBy("due", "asc")), (snap) => { 
            const div = document.getElementById('reminder-list'); div.innerHTML = ''; activeReminders = []; 
            if(snap.empty) div.innerHTML = '<div class="text-center text-xs text-gray-400 dark:text-[#6B6B6B] py-6">No upcoming events</div>'; 
            snap.forEach(d => { 
                const r = d.data(); const dateObj = r.due ? r.due.toDate() : new Date(); activeReminders.push({ id: d.id, title: r.title, date: dateObj }); 
                const item = document.createElement('div'); 
                item.className = "flex items-center p-3 bg-blue-50/30 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-900/30 rounded-lg hover:bg-blue-50/60 dark:hover:bg-blue-900/30 transition relative group reminder-item"; 
                // reminder-actions for hover logic
                const del = document.createElement('button'); del.className="absolute top-1.5 right-1.5 text-gray-300 hover:text-red-500 reminder-actions p-1"; del.innerHTML = "&times;"; del.onclick = (e) => { e.stopPropagation(); deleteDoc(doc(db, `projects/${pid}/reminders`, d.id)); }; 
                item.innerHTML = `<div class="w-12 text-center leading-tight mr-4 border-r border-blue-100 dark:border-blue-900/30 pr-4"><div class="text-[10px] text-blue-600 dark:text-blue-400 uppercase font-bold tracking-wide">${dateObj.toLocaleString('default', {month:'short'})}</div><div class="text-xl font-bold text-gray-800 dark:text-[#D4D4D4]">${dateObj.getDate()}</div></div><div class="flex-1"><div class="text-[14px] font-semibold text-notion-text dark:text-[#D4D4D4]">${r.title}</div><div class="text-[12px] text-gray-500 dark:text-[#9B9A97] mt-0.5">${dateObj.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€¢ ${r.addedBy}</div></div>`; item.appendChild(del); div.appendChild(item); 
            }); 
        }); 
    }
    function checkReminders() {
        const now = new Date();
        activeReminders.forEach(r => {
            if(r.date <= now && !notifiedReminders.has(r.id)) {
                const diff = now - r.date;
                if(diff < 5 * 60 * 1000) { 
                    // In-App Overlay
                    document.getElementById('reminder-overlay-text').textContent = r.title;
                    document.getElementById('reminder-overlay').classList.remove('hidden');
                    window.playSound();
                    
                    if (Notification.permission === "granted") {
                        new Notification("EduLink Reminder", { body: r.title, icon: "https://i.imghippo.com/files/vgr8207c.png" });
                    }

                    notifiedReminders.add(r.id);
                }
            }
        });
    }
    document.getElementById('reminder-form').addEventListener('submit', async (e) => { e.preventDefault(); const title = document.getElementById('rem-title').value; const date = document.getElementById('rem-date').value; const time = document.getElementById('rem-time').value; if(!title || !date || !time) return; const due = new Date(`${date}T${time}`); await addDoc(collection(db, `projects/${currentProjectId}/reminders`), { title, due, addedBy: currentUser.displayName || "User", timestamp: serverTimestamp() }); document.getElementById('reminder-form').reset(); });

    // --- AI ---
    async function fetchAI(prompt, context) { try { const clean = encodeURIComponent(`Context: ${context.substring(0,500)}...\nQ: ${prompt}`); const res = await fetch(`https://text.pollinations.ai/${clean}`); if(!res.ok) throw new Error(); return await res.text(); } catch(e) { return "AI Unavailable"; } }
    document.getElementById('ai-form').addEventListener('submit', async(e)=>{ e.preventDefault(); const inp = document.getElementById('ai-input'); const txt = inp.value.trim(); if(!txt) return; const div = document.getElementById('ai-messages'); div.innerHTML += `<div class="flex flex-col items-end"><div class="bg-gray-100 dark:bg-[#262626] text-[14px] px-3.5 py-2.5 rounded-xl max-w-[90%] mb-3 text-notion-text dark:text-[#D4D4D4] shadow-sm">${txt}</div></div>`; inp.value = ''; div.scrollTop = div.scrollHeight; const resp = await fetchAI(txt, document.getElementById('doc-content').innerText); div.innerHTML += `<div class="flex flex-col items-start"><div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-900/30 text-[14px] px-3.5 py-2.5 rounded-xl max-w-[90%] mb-3 text-notion-text dark:text-[#D4D4D4] leading-relaxed shadow-sm">${resp}</div></div>`; div.scrollTop = div.scrollHeight; });

    // --- PROFILE ---
    const btnSettings = document.getElementById('btn-settings'); 
    btnSettings.addEventListener('click', (e) => { 
        e.stopPropagation(); 
        document.getElementById('edit-display-name').value = currentUser.displayName || ""; 
        window.showModal('profile-modal'); 
    });
    
    // Favicon Upload & Preview Logic
    document.getElementById('edit-app-favicon-file').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            // Instant Preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('favicon-preview').innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);

            // Upload Immediately
            const uploadedUrl = await uploadImage(file);
            if(uploadedUrl) {
                pendingFavicon = uploadedUrl;
                document.getElementById('favicon-preview').innerHTML = `<img src="${pendingFavicon}" class="w-full h-full object-cover">`;
                notify("Icon uploaded successfully", "success");
            }
        }
    });

    document.getElementById('btn-cancel-profile').addEventListener('click', () => {
        window.hideModal('profile-modal');
        pendingFavicon = null;
        document.getElementById('edit-app-favicon-file').value = "";
    });

    document.getElementById('btn-save-profile').addEventListener('click', async () => { 
        const newName = document.getElementById('edit-display-name').value.trim(); 
        if(!newName) return; 
        
        try { 
            await updateProfile(currentUser, { displayName: newName }); 
            const updates = { displayName: newName, darkMode: isDarkMode };
            
            const appTitle = document.getElementById('edit-app-title').value.trim();
            if(appTitle) {
                updates.appTitle = appTitle;
                document.title = appTitle;
            }
            
            if(pendingFavicon) {
                updates.appFavicon = pendingFavicon;
                document.getElementById('dynamic-favicon').href = pendingFavicon;
            }

            await updateDoc(doc(db, "users", currentUser.uid), updates); 
            
            updateUserUI({appTitle, appFavicon: pendingFavicon}); 
            notify("Settings saved successfully", "success"); 
            window.hideModal('profile-modal'); 
            pendingFavicon = null;
            document.getElementById('edit-app-favicon-file').value = "";
        } catch(e) { 
            console.error(e);
            notify("Failed to save settings", "error"); 
        } 
    });
    
    // --- NOTIFICATIONS & INVITES & GLOBAL BROADCASTS ---
    document.getElementById('btn-notifications').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('notification-popover').classList.toggle('hidden'); document.getElementById('notif-badge').classList.add('hidden'); });
    document.addEventListener('click', (e) => { if(!document.getElementById('btn-notifications').contains(e.target) && !document.getElementById('notification-popover').contains(e.target)) { document.getElementById('notification-popover').classList.add('hidden'); } });
    function loadUserNotifications() {
        const q = query(collection(db, `users/${currentUser.uid}/notifications`), orderBy('timestamp', 'desc'));
        unsubscribeNotifs = onSnapshot(q, (snap) => {
            const list = document.getElementById('notification-list');
            if(snap.empty) { list.innerHTML = '<div class="p-8 text-center text-gray-400 dark:text-[#6B6B6B] text-sm italic">No new notifications</div>'; return; }
            list.innerHTML = '';
            let hasUnread = false;
            snap.docChanges().forEach(change => {
                if(change.type === 'added') {
                    const n = change.doc.data();
                    if (n.type === 'broadcast' && !n.read) {
                        window.playSound();
                        document.getElementById('broadcast-message-text').textContent = n.text;
                        document.getElementById('broadcast-receive-overlay').classList.remove('hidden');
                        
                        if (Notification.permission === "granted") {
                            new Notification("Announcement", { body: n.text, icon: "https://i.imghippo.com/files/vgr8207c.png" });
                        }

                        updateDoc(doc(db, `users/${currentUser.uid}/notifications`, change.doc.id), { read: true });
                    }
                }
            });

            snap.forEach(d => {
                const n = d.data();
                const item = document.createElement('div');
                item.className = "p-4 border-b border-gray-50 hover:bg-gray-50 dark:hover:bg-[#2C2C2C] text-sm flex gap-3 relative group transition-colors dark:border-[#2F2F2F]";
                const delBtn = document.createElement('button'); delBtn.className = "absolute top-2 right-2 text-gray-300 dark:text-[#6B6B6B] hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"; delBtn.innerHTML = "&times;";
                delBtn.onclick = (e) => { e.stopPropagation(); deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, d.id)); };
                
                let icon = n.read ? '<div class="w-2.5 h-2.5 rounded-full bg-transparent mt-1.5 flex-shrink-0"></div>' : '<div class="w-2.5 h-2.5 rounded-full bg-blue-500 mt-1.5 flex-shrink-0 shadow-sm border border-white dark:border-[#191919]"></div>';
                if(!n.read) hasUnread = true;
                
                let actions = '';
                if(n.type === 'team_invite') {
                    actions = `<div class="mt-2 flex gap-2"><button onclick="window.acceptTeam('${n.teamId}', '${d.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Accept</button><button onclick="window.declineTeam('${d.id}')" class="px-3 py-1 bg-gray-200 dark:bg-[#3F3F3F] text-gray-700 dark:text-[#D4D4D4] rounded text-xs">Decline</button></div>`;
                }

                item.innerHTML = `${icon}<div class="flex-1 pr-4"><div class="font-semibold text-notion-text dark:text-[#D4D4D4] leading-tight text-[14px]">${n.title || (n.type === 'broadcast' ? 'Announcement' : 'Notification')}</div><div class="text-gray-500 dark:text-[#9B9A97] mt-1 leading-relaxed text-[13px]">${n.text}</div>${actions}<div class="text-[11px] text-gray-400 dark:text-[#6B6B6B] mt-2 font-medium">${n.timestamp?.toDate().toLocaleDateString() || ""}</div></div>`;
                item.appendChild(delBtn); list.appendChild(item);
                if(!n.read && n.type !== 'broadcast') { updateDoc(doc(db, `users/${currentUser.uid}/notifications`, d.id), { read: true }); }
            });
            if(hasUnread) document.getElementById('notif-badge').classList.remove('hidden');
        });
    }

    window.acceptTeam = async (tid, nid) => {
        const ref = doc(db, "teams", tid);
        await updateDoc(ref, { pending: arrayRemove(currentUser.email), members: arrayUnion(currentUser.email) });
        await deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, nid));
        notify("Joined team!", "success");
    };
    window.declineTeam = async (nid) => { await deleteDoc(doc(db, `users/${currentUser.uid}/notifications`, nid)); notify("Invite declined"); };

    // --- CREATE & SHARE ---
    [document.getElementById('trigger-create-project'), document.getElementById('btn-create-empty')].forEach(b => b.addEventListener('click', ()=>window.showModal('create-modal')));
    document.getElementById('btn-cancel-create').addEventListener('click', ()=>window.hideModal('create-modal'));
    document.getElementById('btn-confirm-create').addEventListener('click', async()=>{
        const title = document.getElementById('new-proj-title').value || "Untitled"; 
        const isPrivate = document.getElementById('new-proj-private').checked;
        const folderId = document.getElementById('new-proj-folder').value || null;
        
        const docRef = await addDoc(collection(db, "projects"), { 
            title, icon: "ðŸ“„", content: "", 
            ownerId: currentUser.uid, 
            folderId: folderId,
            memberEmails: [currentUser.email], 
            access: [{email:currentUser.email, role:'owner'}], 
            createdAt: serverTimestamp(), 
            isPrivate 
        });
        window.hideModal('create-modal'); selectProject(docRef.id);
    });
    document.getElementById('btn-open-share').addEventListener('click', ()=>window.showModal('share-modal'));
    document.getElementById('btn-copy-link').addEventListener('click', () => { if(!currentProjectId) return; const url = window.location.protocol + "//" + window.location.host + window.location.pathname + '?project=' + currentProjectId; navigator.clipboard.writeText(url).then(() => notify("Link copied to clipboard!", "success")).catch(err => notify("Failed to copy link", "error")); });
    
    // Updated renderMembersList to fetch avatars async
    async function renderMembersList(access, isOwner) {
        const d = document.getElementById('members-list'); d.innerHTML = '';
        
        for (const m of access) {
             let roleDisplay = `<span class="text-[11px] text-gray-400 dark:text-[#9B9A97] capitalize font-medium">${m.role}</span>`;
            let actions = '';
            if(isOwner && m.email !== currentUser.email) {
                roleDisplay = `<select onchange="window.updateMemberRole('${m.email}', this.value)" class="text-[11px] bg-transparent border-none outline-none text-gray-500 font-medium cursor-pointer hover:text-gray-800 dark:text-[#9B9A97] dark:hover:text-[#D4D4D4]"><option value="editor" ${m.role==='editor'?'selected':''}>Editor</option><option value="commenter" ${m.role==='commenter'?'selected':''}>Commenter</option><option value="viewer" ${m.role==='viewer'?'selected':''}>Viewer</option></select>`;
                actions = `<button class="text-xs text-red-400 hover:text-red-600 font-medium px-2 py-1 rounded hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" onclick="window.removeMember('${m.email}', '${currentProjectId}')">Remove</button>`;
            } else if(m.role === 'owner') roleDisplay = `<span class="text-[11px] text-notion-blue font-bold uppercase tracking-wider">Owner</span>`;
            
            const avatarSrc = await resolveAvatar(m.email);

            d.innerHTML += `<div class="flex justify-between items-center p-2.5 hover:bg-gray-50 dark:hover:bg-[#2C2C2C] rounded-lg border border-transparent hover:border-gray-100 dark:hover:border-[#2F2F2F] transition-all group"><div class="flex items-center gap-3"><img src="${avatarSrc}" class="w-8 h-8 rounded-full bg-white border border-gray-200 dark:border-[#2F2F2F] object-cover"><div class="flex flex-col"><span class="text-sm font-semibold text-notion-text dark:text-[#D4D4D4]">${m.email}</span>${roleDisplay}</div></div>${actions}</div>`; 
        }
    }

    document.getElementById('btn-send-invite').addEventListener('click', async()=>{
        const email = document.getElementById('invite-email').value; const role = document.getElementById('invite-role').value; if(!email) return;
        const ref = doc(db, "projects", currentProjectId); const snap = await getDoc(ref);
        if(snap.exists() && !snap.data().access.find(a=>a.email===email)) {
            await updateDoc(ref, { memberEmails: arrayUnion(email), access: arrayUnion({email, role}) });
            notify(`Invited ${email}`, 'success'); 
            const usersQ = query(collection(db, "users"), where("email", "==", email)); const userSnap = await getDocs(usersQ);
            if(!userSnap.empty) { userSnap.forEach(async (u) => { await addDoc(collection(db, `users/${u.id}/notifications`), { title: "Project Invitation", text: `You were invited to join <strong>${snap.data().title || "a project"}</strong> as ${role}.`, timestamp: serverTimestamp(), read: false }); }); }
            document.getElementById('invite-email').value = '';
        } else { notify("User already exists or error", "error"); }
    });
    window.updateMemberRole = async (email, newRole) => {
        const ref = doc(db, "projects", currentProjectId); const snap = await getDoc(ref); if(!snap.exists()) return;
        let access = snap.data().access; access = access.map(m => m.email === email ? { ...m, role: newRole } : m);
        await updateDoc(ref, { access }); notify(`Updated ${email} to ${newRole}`, 'success');
    };
    window.removeMember = async (email, pid) => {
        if(!pid) pid = currentProjectId;
        if(!confirm(`Remove/Leave ${email}?`)) return;
        const ref = doc(db, "projects", pid); const snap = await getDoc(ref);
        const access = snap.data().access.filter(a=>a.email!==email); const emails = snap.data().memberEmails.filter(e=>e!==email);
        await updateDoc(ref, {access, memberEmails: emails}); 
        if(email === currentUser.email) { window.location.href = "home.html"; } 
        else { notify("Member removed"); }
    }

</script>
</body>
</html>
